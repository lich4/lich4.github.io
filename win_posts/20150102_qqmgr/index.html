<!DOCTYPE html>
<html lang="zh-CN"
  dir="ltr">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://lich4.github.io//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://lich4.github.io//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://lich4.github.io//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://lich4.github.io//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://lich4.github.io//apple-touch-icon.png">

<meta name="description" content=""/>

<title>
    
    QQ管家驱动分析 | 超哥的博客
    
</title>

<link rel="canonical" href="https://lich4.github.io/win_posts/20150102_qqmgr/"/>












<link rel="stylesheet" href="/assets/combined.min.cbcb816aefdb3b7380c5921cbb3b89d12f07742cb3f869754adb56da84f0d729.css" media="all">









  </head>

  

  
  
  

  <body class="light">

    <div class="content">
      <header>
        

<div class="header">

    

</div>

      </header>

      <main class="main">
        





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a href="/win_posts/">Win_posts</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a class="breadcrumbs-current" href="/win_posts/20150102_qqmgr/">QQ管家驱动分析</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">QQ管家驱动分析</h1>
    
    <p class="single-summary">QQ管家驱动分析</p>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2015-01-02T00:00:00&#43;00:00">January 2, 2015</time>
      

      
    </p>

  </div>

  

  
  
  

  

  
  <aside class="toc">
    <p><strong>Table of contents</strong></p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#tsdefensebtsys分析">TsDefenseBt.sys分析</a>
      <ul>
        <li><a href="#驱动入口driverentry">驱动入口DriverEntry</a></li>
      </ul>
    </li>
    <li><a href="#tskspsys分析">TsKsp.sys分析</a>
      <ul>
        <li><a href="#驱动入口driverentry-1">驱动入口DriverEntry</a></li>
        <li><a href="#控制信息">控制信息</a></li>
        <li><a href="#接口和控制码">接口和控制码</a></li>
        <li><a href="#基础库">基础库</a></li>
      </ul>
    </li>
    <li><a href="#tsfltmgrsys分析">TsFltMgr.sys分析</a>
      <ul>
        <li><a href="#驱动入口driverentry-2">驱动入口DriverEntry</a></li>
        <li><a href="#驱动接口interface">驱动接口Interface</a></li>
        <li><a href="#基础库-1">基础库</a></li>
        <li><a href="#inlinehook-kifastcallentry">InlineHook KiFastCallEntry</a></li>
      </ul>
    </li>
    <li><a href="#tssyskitsys分析">TsSysKit.sys分析</a>
      <ul>
        <li><a href="#驱动入口driverentry-3">驱动入口DriverEntry</a></li>
        <li><a href="#驱动接口interface-1">驱动接口Interface</a></li>
        <li><a href="#控制码-1">控制码</a></li>
        <li><a href="#默认派遣例程">默认派遣例程</a></li>
        <li><a href="#获取objectinitializer">获取ObjectInitializer</a></li>
      </ul>
    </li>
    <li><a href="#qqpchwsys分析">QQPCHW.sys分析</a>
      <ul>
        <li><a href="#控制码-2">控制码</a></li>
      </ul>
    </li>
    <li><a href="#tssksys分析">Tssk.sys分析</a>
      <ul>
        <li><a href="#基础库-2">基础库</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </aside>
  

  

  <div class="single-content">
    <h2 id="tsdefensebtsys分析">TsDefenseBt.sys分析</h2>
<p>  该驱动主要用于和各类竞品做对抗用，本文为2015.7.23版本的Tsdefensebt.sys的分析。该驱动使用TsFltMgr和TsSysKit提供的接口，和另外几个驱动一样存在验签名机制。</p>
<h3 id="驱动入口driverentry">驱动入口DriverEntry</h3>
<p>1.设置ZwQueryValueKey的PrevFilter为ZwQueryValueKeyHooker</p>
<ul>
<li>ZwQueryValueKeyHooker中拦截Service.exe对qqpcrtp服务的查询</li>
</ul>
<p>2.检查HookPort, 360SelfProtection若存在则设置360存在标志位，baidu标志位默认设置为存在</p>
<ul>
<li>若baidu存在，则解除baidu驱动进程创建、映像加载、线程创建回调</li>
<li>若360存在，则对TsDefensebt本身做ObOpenObjectByName的IAT hook，并记录iat信息(防止360 hook)，初始化360tray.exe, zhudongfangyu.exe, 360se.exe, 360chrome.exe, wscript.exe到进程id监视表</li>
</ul>
<p>3.获取系统api真实地址</p>
<p>4.获取关机回调队列头</p>
<p>5.获取TsSyskit接口</p>
<p>6.设置UnloadDispatch,CreateDispatch,CloseDispatch,IoCtlDispatch,ShutdownDispatch</p>
<p>7.挂钩进程创建为NtCreateProcessNotifyHooker1</p>
<ul>
<li>若360存在则挂钩NtSetValueKey为NtSetValueKeyHooker，挂钩ZwRequestWaitReplyPort为ZwRequestWaitReplyPortHooker，挂钩ZwAlpcSendWaitReceivePort为ZwAlpcSendWaitReceivePortHooker，挂钩ZwWriteVirtualMemory为ZwWriteVirtualMemoryHooker，挂钩ZwCreateThread为ZwCreateThreadHooker，挂钩ObReferenceObjectByHandle为FakeObReferenceObjectByHandle</li>
</ul>
<p>8.注册注册表回调CmCallback</p>
<p>9.创建TSDFStategy设备，作为穿透驱动第二通道</p>
<p>10.保存TsDefenseBt映像起始地址处4096字节</p>
<ul>
<li>若ShutdownTime被修改，若360存在则从SysOpt.ini删除指定的启动项，若baidu存在则删除服务项BDMWrench,BDArKit,BDSGRTP,BDMiniDlUpdate,bd0001,bd0002,bd0003,bd0004,BDDefense,BDEnhanceBoost,BDFileDefend,BDMNetMon,BDSafeBrower,BDSandBox,Bprotect,Bhbase,Bfmon,Bfilter</li>
</ul>
<p>11.加密TsDefenseBt-&gt;DriverObject-&gt;DriverSection中存储的驱动路径</p>
<h4 id="ntfs创建回调ntfsfsdcreatehooker">Ntfs创建回调NtfsFsdCreateHooker</h4>
<ul>
<li>若当前进程为360Tray.exe, Zhudongfangyu.exe, 360se.exe, 360chrome.exe, rundll32.exe, 360tray.exe，目标目录为</li>
</ul>
<pre tabindex="0"><code>appdata\roaming\microsoft\windows\start menu\programs\startup
\「开始」菜单\程序\启动
\local settings\defend
\local\defend
</code></pre><p>且目标文件为.lnk后缀则拒绝</p>
<ul>
<li>
<p>若当前进程为svchost.exe，目标目录为\360safe\则拒绝</p>
</li>
<li>
<p>若当前进程为explorer.exe或runonce.exe，目标路径为\360safe\且目标文件为.lnk .slnk .flnk .plnk .zlnk .xlnk .qlnk .qqlnk则拒绝</p>
</li>
<li>
<p>若当前进程为360tray.exe或zhudongfangyu.exe，目标路径为\360safe\且目标文件为.lnk .slnk .flnk .plnk .zlnk .xlnk .qlnk .qqlnk则拒绝；目标匹配</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\WINDOWS\TEMP\<span style="color:#ec0000">*</span>.EXE, 
</span></span><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\LOCAL SETTINGS\TEMP\<span style="color:#ec0000">*</span>.EXE,
</span></span><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\LOCAL\TEMP\<span style="color:#ec0000">*</span>.EXE, 
</span></span><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\LOCAL<span style="color:#ec0000">*</span>\F9\<span style="color:#ec0000">*</span>.EXE,
</span></span><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\APPDATA\SAFERUN\<span style="color:#ec0000">*</span>.EXE\<span style="color:#ec0000">*</span>\APPDATA\<span style="color:#ec0000">*</span>\<span style="color:#ec0000">*</span>.EXE<span style="color:#ec0000">*</span>\PROGRAMDATA\<span style="color:#ec0000">*</span>\<span style="color:#ec0000">*</span>.EXE
</span></span></code></pre></div><p>则拒绝</p>
<ul>
<li>若当前进程为cmd.exe 360se.exe wscript.exe 360chrome.exe，且目标文件为360tray.exe zhudongfangyu.exe则拒绝</li>
</ul>
<h4 id="registershutdown">RegisterShutdown</h4>
<ul>
<li>重置TsDefenseBt关机回调</li>
<li>若发现ShutdownTime被修改则执行ClearThread</li>
<li>将\Driver\WMIxWDM,\Driver\mountmgr,\FileSystem\RAW,\Driver\volmgr,\Driver\ksecdd,\Driver\BDArKit关机回调置无效</li>
<li>设置注册表<code>\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Windows</code>键回调为RegisterShutdown</li>
</ul>
<h4 id="clearthread">ClearThread</h4>
<ul>
<li>若360存在则清除SysOpt.ini指定的启动项</li>
<li>删除baidu注册表项</li>
</ul>
<h4 id="shutdowndispatch">ShutdownDispatch</h4>
<ul>
<li>打开360文件并并存储句柄</li>
</ul>
<pre tabindex="0"><code>\safemon\safeloader.exe, 
\safemon\BAK_safeloader.exe, 
\safemon\ok_safeloader.exe, 
\safemon\zz_safeloader.exe, 
\safemon\agesafe.exe, 
\safemon\sssafefix.exe,
\safemon\safe505.exe
</code></pre><ul>
<li>创建ClearThread线程</li>
<li>删除360注册表项</li>
<li>删除360快捷方式(文件和注册表)</li>
<li>删除360服务项</li>
<li>删除baidu注册表项</li>
</ul>
<h4 id="unloaddispatch">UnloadDispatch</h4>
<ul>
<li>删除ZwQueryValueKey的PrevFilter</li>
</ul>
<h4 id="createdispatch">CreateDispatch</h4>
<ul>
<li>检查进程是否处于监视列表</li>
<li>检查进程是否为Ts文件，并加入监视列表</li>
</ul>
<h4 id="closedispatch">CloseDispatch</h4>
<p>无</p>
<h4 id="ioctldispatch">IoCtlDispatch</h4>
<pre tabindex="0"><code>IoCtlCode= 0x222044 TSDFStategy 记录文件注册表(加密)数据用于增删查改
IoCtlCode= 0x222048 文件、注册表穿透操作新通道
IoCtlCode= 0x222054\|0x222058 穿透加载驱动新通道
IoCtlCode= 0x222014 设置开自保
IoCtlCode= 0x222004 用于同步
IoCtlCode= 0x222028\| 0x22202C 设置注册表服务项标识位
IoCtlCode= 0x222030 设置关自保
</code></pre><h4 id="删除360注册表项">删除360注册表项</h4>
<p>删除</p>
<pre tabindex="0"><code>\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
\Registry\Machine\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run
\Registry\Machine\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\RunOnce
</code></pre><p>和<code>\Registry\User</code>下每个用户的</p>
<pre tabindex="0"><code>\Software\Microsoft\Windows\CurrentVersion\Run
\Software\Microsoft\Windows\CurrentVersion\RunOnce
\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run
\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\RunOnce
</code></pre><p>下的键：</p>
<pre tabindex="0"><code>Fix360Safe
&#34;{7B03EE23-306B-47a7-B9A5-4B4783FBB2A6}&#34;
&#34;{7A03EE23-306B-47a7-B9A5-4B4783FBB2A6}&#34;
Repair360Safe
360安全卫士应急修复
360Safe安全卫士应急修复
360应急修复程序
360SafeEmergencyRepair
Safe安全卫士应急修复
360卫士自我修复程序
应急修复360卫士程序
360卫士用户应急自修复程序
360卫士应急自修复程序
360卫士应急自修复程序7896
360安全卫士应急修复工具
360安全卫士异常修复工具
360卫士异常修复工具
360卫士异常应急修复工具
360卫士异常应急修复程序
360卫士异常应急修复服务程序
360卫士应急修复服务程序
360卫士应急修复服务工具
360安全卫士应急修复服务工具
360安全卫士异常应急修复服务工具
360安全卫士异常应急修复服务程序
360安全卫士修复服务工具
360安全卫士修复服务工具7787
3-6-0安全卫士-异常应急修复-Fix2
3-6-0-F-i-x-3
360卫士异常应急修复服务程序7xi
360卫士异常应急修复服务程序Ok
360卫士-异常应急修复服务程序
卫士-修复程序
360-卫士-修复程序
卫士-360-修复
360-Tray-修复
tray-360-修复
修复-tray-360
卫士安全修复应急
卫士修复安全应急
修复安全卫士应急
异常安全卫士应急修复
360安全卫士应急修复异常组件程序
&#34;My360Helper&#34;
&#34;MyDefend360&#34;
&#34;36ORepair&#34;
&#34;Safe360Tray&#34;
&#34;360Safe360TrayFix&#34;
&#34;360SafeTrayFix&#34;
&#34;360SafeTrayFix123&#34;
&#34;360SafeTrayFix1&#34;
&#34;360SafeTrayFix2&#34;
&#34;Rep36O&#34;
&#34;Rep36Osafes&#34;
&#34;Rep36OFixsafe&#34;
&#34;360SafeTrayFix3&#34;
&#34;Defend360TrayFix&#34;
&#34;360Safe_TrayFix&#34;
&#34;36OFix_360safe&#34;
&#34;36OFix_360safe1&#34;
&#34;36OFix_safe&#34;
&#34;3 6 0 F i x&#34;
&#34;3 6 O F i x&#34;
&#34;3-6-O-F-i-x&#34;
&#34;3-6-0 F-i-x&#34;
&#34;36 0 Fi x&#34;
&#34;36 0 F i-x&#34;
&#34;360-Fi-x&#34;
&#34;-360Fix-&#34;
&#34;-3 6-0 F-i x-&#34;
&#34;-3-6-0 F-i x-&#34;
&#34;-3-6-0F-i x-&#34;
&#34;3-6-0-Fix-0&#34;
&#34;360fiix_69&#34;
&#34;360fiix_419&#34;
&#34;fixfixfixfix&#34;
&#34;QFiPCTray&#34;
&#34;QFiPCTray_1&#34;
&#34;PCTray360&#34;
&#34;PCFTray360&#34;
&#34;OKJPCTray&#34;
&#34;sdCFTrayJHSDSDF&#34;
&#34;TrayFixSVC&#34;
&#34;Traydsfsdffs&#34;
&#34;FTrayPCsss&#34;
&#34;120FTray&#34;
&#34;361FTray&#34;
&#34;361FTrayFix&#34;
&#34;GFFsFTray&#34;
&#34;s1aGFFsFTray&#34;
&#34;31aGFFsFTray&#34;
&#34;31FixQFTray&#34;
&#34;FwwwixQFTray&#34;
&#34;DdFFdOTA&#34;
&#34;AlchemistFAA&#34;
&#34;BearFixAW&#34;
&#34;DestroyerUHSFSS&#34;
&#34;AxeWUDIZHAN&#34;
&#34;spiderManSAD&#34;
&#34;BaneZhiYuan&#34;
&#34;ursaXiongZi&#34;
&#34;BMShouWangZ&#34;
&#34;gondarSanJin&#34;
&#34;KunkkaChuanZhang&#34;
&#34;Azwraithnver&#34;
</code></pre><p>和项：</p>
<pre tabindex="0"><code>&#34;360_FIX*&#34;
&#34;360FIX*&#34;
&#34;3-60FIX*&#34;
&#34;360FIIX*&#34;
&#34;QFIPCTRAY*&#34;
</code></pre><ul>
<li>删除<code>\REGISTRY\MACHINE\SOFTWARE\Classes\CLSID\{FC6354A7-BACD-47C3-A989-312F7FADA3E2}\LocalServer32</code></li>
<li>删除TSDFStategy指定的键值</li>
</ul>
<h4 id="解除baidu驱动回调">解除baidu驱动回调</h4>
<ul>
<li>分别对\Driver\BDMWrench,\Driver\BDArKit,\Driver\bd0001,\Driver\bd0002,\FileSystem\bd0003,\Driver\bd0004,\Driver\BdSandBox,\Driver\BDMNetMon几个驱动，从映像起始地址处4096字节范围内，以1为步长的4096个地址，做摘除进程回调、映像加载回调、线程回调操作</li>
</ul>
<h4 id="删除360快捷方式">删除360快捷方式</h4>
<ul>
<li>删除<code>\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</code>, Common Startup键，以及<code>\Registry\User</code>下每个用户<code>\Software\Microsoft\Windows\CurrentVersion\Explorer\ShellFolders</code>, Startup键 (lnk文件及注册表)：</li>
</ul>
<pre tabindex="0"><code>\safe505.lnk
\safeFY.lnk
\FYFY.lnk
\OKFOU.lnk
\OKFix.lnk
\OKZFix.lnk
\OKAgeFix.lnk
\sssafeFix.lnk
\SafeFix360.lnk
\ss360safeFix.lnk
\yy360safeFix.lnk
\Fixs360safeFix.lnk
\FixMy360safe.lnk
\MyFix360safe.lnk
\ProFixSafe.lnk
\DoFix360Safe.lnk
\RunHelper60safe.lnk
\360
\360safe.lnk
\360trayfix.lnk
\360
\360safe505Fixs.lnk
\360safe110Fixs.lnk
\safe505110Fixs.lnk
</code></pre><h4 id="删除360服务项">删除360服务项</h4>
<pre tabindex="0"><code>360FixSvc
3600FixSvc
360SFixSvc
Fix360SafeService
SafeFix
360XFixSvc
Fix360Service
360FixService
360FixSafe
FixSafeService
RepairSafezage
360csvcsFix
360Fixcsvcs
360ServiceFixs
360SafeFixService
360SafeFixOk
360Fix360Safe
360Fix360tray
Fix360trayService
360Fix360trayService
360Fix360trayServices
360Fix360trayServicess
360Fix360trayFix
360trayFixService
360trayFixsSvc
360trayFixsSvcx
360trayRunFix
360trayRunFixs
360traysRunFix
360sRunFix
360ssxxaRunFix
360stxaFix
FixSafe360
FixsvcSafe360
FixsvcServiceSafe360
FixServiceSafe360tary
FixSafe360taryServices
505Fix360Safe
505360Safe
repair505
505repair
saferepair
repairtray
repair360
startrep
SoS360Safe
S0S360Safe
360Sos
36OSosSafe
36OOKS0SSafe
360OKS0SSafe
3600KSOSSafe
36O0OKSOSafe
36000KSOSSafe
36000OKSOSSafe
36O00OKSOSSafe
36O00OsKSOSSafe
36O0OOKSOSSafe
36O00OsKSOSSafe
3605050Safe
36OSOSFixSafe
</code></pre><h4 id="删除baidu注册表项">删除baidu注册表项</h4>
<pre tabindex="0"><code>&#34;BDMWrench&#34;
&#34;BDArKit&#34;
&#34;BDSGRTP&#34;
&#34;BDMiniDlUpdate&#34;
&#34;bd0001&#34;
&#34;bd0002&#34;
&#34;bd0003&#34;
&#34;bd0004&#34;
&#34;BDDefense&#34;
&#34;BDEnhanceBoost&#34;
&#34;BDFileDefend&#34;
&#34;BDMNetMon&#34;
&#34;BDSafeBrower&#34;
&#34;BDSandBox&#34;
&#34;Bprotect&#34;
&#34;Bhbase&#34;
&#34;Bfmon&#34;
&#34;Bfilter&#34;
</code></pre><h4 id="ntcreateprocessnotifyhooker1">NtCreateProcessNotifyHooker1</h4>
<ul>
<li>若当前进程为360tray.exe, zhudongfangyu.exe, 360se.exe, 360chrome.exe, wscript.exe则添加到进程id监视表safemonfilehandle</li>
<li>若360存在，且目标进程为\SystemRoot\system32\sc.exe或\SystemRoot\system32\rundll32.exe则添加到监视列表</li>
<li>若目标进程为explorer.exe且当前进程为Userinit.exe或Taskmgr.exe则删除进程id监视表safemonfilehandle</li>
<li>若目标文件为Userinit.exe，则打开360文件\safemon\safeloader.exe,\safemon\BAK_safeloader.exe, \safemon\ok_safeloader.exe,\safemon\zz_safeloader.exe, \safemon\agesafe.exe,\safemon\sssafefix.exe, \safemon\safe505.exe并存储句柄</li>
<li>若目标进程为baiduprotect.exe</li>
</ul>
<pre tabindex="0"><code>若当前进程为explorer.exe或svchost.exe且目标进程为safe505.exe\
若当前进程为runonce.exe且目标进程为360tray.exe
若当前进程为360se.exe或360chrome.exe且目标进程为360tray.exe,zhudongfangyu.exe, safe505.exe, liveupdate360.exe：
若目标进程为safe505.exe, safefix.exe, safeloader.exe, 360xfix505.exe：
若目标进程为
\360safe\softmgr\softmanager.exe
\360safe\safemon\360realpro.exe	
\360safe\uninst.exe
\360safe\utils\filesmasher.exe
\360safe\utils\360fileunlock.exe
\360safe\360shellpro.exe
\360safe\360safe.exe
\360safe\mobilemgr\360mobilemgr.exe
\360safe\360apploader.exe
\360safe\deepscan\dsmain.exe
\360safe\safemon\360tray.exe
</code></pre><p>则强制结束进程</p>
<ul>
<li>若创建目标进程为explorer.exe或winlogon.exe，则</li>
<li>若baidu存在则解除baidu驱动回调</li>
<li>若360存在则删除360启动项和快捷方式</li>
<li>若结束目标进程为explorer.exe或winlogon.exe，则</li>
<li>若baidu存在则解除baidu驱动回调</li>
<li>若360存在则：执行FuckCompeete1，删除360启动项和快捷方式；清除SysOpt.ini指定的启动项；删除\Registry\User下每个用户\Software\Microsoft\Windows\CurrentVersion\Run和\Software\Microsoft\Windows\CurrentVersion\RunOnce的360safetray和360sd项；删除360服务项；删除baidu服务项^_^</li>
</ul>
<p>FuckCompete1：将\\FileSystem\\360boost的关机回调设置为无效；挂钩Ntfs创建例程；重置自身关机回调；创建随机名驱动及设备执行并设置其关机回调为ShutdownDispatch</p>
<h4 id="ntsetvaluekeyhooker">NtSetValueKeyHooker</h4>
<p>若系统关机/注销，且ValueName存在360或当前进程为zhudongfangyu.exe，且目标注册表路径为：</p>
<pre tabindex="0"><code>\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost
\REGISTRY\*\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN*
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\360
\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\CONTROL\SESSION MANAGER
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\*
\REGISTRY\*\SOFTWARE\CLASSES\CLSID\*\LOCALSERVER32*
</code></pre><p>则拒绝</p>
<h4 id="zwrequestwaitreplyporthookerzwalpcsendwaitreceiveporthooker">ZwRequestWaitReplyPortHooker/ZwAlpcSendWaitReceivePortHooker</h4>
<ul>
<li>若当前进程为360se.exe或360chrome.exe，目标进程为360tray.exe或zhudongfangyu.exe则拒绝</li>
<li>若当前进程为zhudongfangyu.exe或wmiprvse.exe系统正在关机，或当前进程为360tray.exe，且目标操作存在关键字Win32_Service, Create, :\\WINDOWS\\system32\\svchost.exe &ndash;k, Win32_Process,
Defend360, Fix360, FixRundll, \SoftMgr\, 360Safe, .dll, .dat, .exe,
.cp, DllGetClassObject, 360csvcs, RERDVGYBHNJ, REPA, REPAIR则拒绝</li>
</ul>
<h4 id="ntwritevirtualmemoryhookerntcreatethreadhooker">NtWriteVirtualMemoryHooker/NtCreateThreadHooker</h4>
<ul>
<li>若当前进程为360se.exe或360chrome.exe且目标进程为explorer.exe，则拒绝(explorer.exe被注入)</li>
</ul>
<h4 id="fakeobreferenceobjectbyhandle">FakeObReferenceObjectByHandle</h4>
<ul>
<li>若当前进程为zhudongfangyu.exe且目标对象路径为</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\WINDOWS\CURRENTVERSION\RUN
</span></span><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\WINDOWS\CURRENTVERSION\RUN\<span style="color:#ec0000">*</span>
</span></span><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\WINDOWS\CURRENTVERSION\RUNONCE
</span></span><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\WINDOWS\CURRENTVERSION\RUNONCE\<span style="color:#ec0000">*</span>
</span></span><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\CURRENTVERSION\SVCHOST
</span></span><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\SYSTEM\CONTROLSET<span style="color:#ec0000">*</span>\SERVICES\QQ<span style="color:#ec0000">*</span>
</span></span><span style="display:flex;"><span>\<span style="color:#ec0000">*</span>\SYSTEM\CONTROLSET<span style="color:#ec0000">*</span>\SERVICES\TS<span style="color:#ec0000">*</span>
</span></span></code></pre></div><p>则拒绝</p>
<ul>
<li>若当前进程为zhudongfangyu.exe, 360tray.exe, svchost.exe，且目标对象位于监视链表中则拒绝</li>
<li>若系统正在关机或注销：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>若当前进程为services.exe, svchost.exe且目标路径为
</span></span><span style="display:flex;"><span>\\REGISTRY\\MACHINE\\SYSTEM\\<span style="color:#ec0000">*</span>CONTROLSET<span style="color:#ec0000">*</span>\\SERVICES\\<span style="color:#ec0000">*</span>FIX<span style="color:#ec0000">*</span>SERV<span style="color:#ec0000">*</span>
</span></span><span style="display:flex;"><span>\\REGISTRY\\MACHINE\\SYSTEM\\<span style="color:#ec0000">*</span>CONTROLSET<span style="color:#ec0000">*</span>\\SERVICES\\<span style="color:#ec0000">*</span>FIX<span style="color:#ec0000">*</span>SAFE<span style="color:#ec0000">*</span>
</span></span><span style="display:flex;"><span>\\REGISTRY\\<span style="color:#ec0000">*</span>\\SOFTWARE\\CLASSES\\CLSID\\<span style="color:#ec0000">*</span>\\LOCALSERVER32<span style="color:#ec0000">*</span>
</span></span></code></pre></div><p>则拒绝</p>
<p>若当前进程为zhudongfangyu.exe, 360tray.exe，且目标对象路径为</p>
<pre tabindex="0"><code>\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost
\REGISTRY\*\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN*
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\360
\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\CONTROL\SESSION MANAGER
\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\*
\REGISTRY\*\SOFTWARE\CLASSES\CLSID\*\LOCALSERVER32*
</code></pre><p>则拒绝</p>
<h4 id="cmcallback">CmCallback</h4>
<ul>
<li>若存在修改ShutdownTime的行为，则执行FuckCompete1：</li>
<li>
<ul>
<li>将\FileSystem\360boost关机回调置无效</li>
</ul>
</li>
<li>
<ul>
<li>挂钩NtfsFsdCreate或NtfsCreateDispatch为NtfsFsdCreateHooker</li>
</ul>
</li>
<li>
<ul>
<li>设置监视\Registry\Machine\System\CurrentControlSet\Control\Windows，回调设置为RegisterShutdown</li>
</ul>
</li>
<li>
<ul>
<li>创建随机名驱动及设备执行并设置其关机回调为ShutdownDispatch</li>
</ul>
</li>
</ul>
<p> </p>
<blockquote>
</blockquote>
<p> </p>
<blockquote>
</blockquote>
<p> </p>
<blockquote>
</blockquote>
<p> </p>
<blockquote>
</blockquote>
<p> </p>
<blockquote>
</blockquote>
<p> </p>
<blockquote>
</blockquote>
<p> </p>
<blockquote>
</blockquote>
<p> </p>
<h2 id="tskspsys分析">TsKsp.sys分析</h2>
<p>  该驱动为qq管家函数过滤驱动，跟TsFltMgr.sys搭配，TsFltMgr主要完成KiFastCallEntry的挂钩和提供设置过滤函数的接口，而该驱动主要用于配置拦截规则，用前者提供的接口设置真正的过滤函数，并在过滤函数中进行规则匹配以决定拦截行为。并提供一系列接口函数和控制码用于控制规则和内部数据。设备名<code>\Device\TSKSP</code>，符号链接名<code>\DosDevices\TSKSP</code>，加密手段：Rabbit算法、MD5算法。通过InlineHook KifastCallEntry实现挂钩。</p>
<h3 id="驱动入口driverentry-1">驱动入口DriverEntry</h3>
<ul>
<li>获取TsFltMgr接口，初始化注册表信息、规则、操作系统版本等信息</li>
<li>创建<code>\Device\TSKSP</code>设备和<code>\DosDevices\TSSysKit</code>符号链接</li>
<li>初始化接口</li>
<li>注册IRP_MJ_CREATE、IRP_MJ_CLOSE、IRP_MJ_DEVICE_CONTROL、IRP_MJ_SHUTDOWN派遣例程</li>
<li>保存Ntfs和Fastfat派遣函数</li>
<li>设置保护关键目录和注册表项</li>
<li>挂钩各个过滤函数</li>
<li>挂钩KeUserModeCallback和重要回调</li>
<li>开自保</li>
</ul>
<p>










<figure class="">

    <div>
        <img loading="lazy" alt="" src=" /img/monitor_model.png">
    </div>

    
</figure></p>
<h4 id="派遣例程">派遣例程</h4>
<p>IRP_MJ_CREATE</p>
<ul>
<li>检查驱动加载者是否有Ts签名</li>
</ul>
<p>IRP_MJ_SHUTDOWN</p>
<ul>
<li>设置<code>\REGISTRY\MACHINE\SYSTEM\CurrentControlSet\Services\TSCPM\</code>目录的LastShutdownFlag和LastShutdownTime</li>
<li>清空<code>\REGISTRY\MACHINE\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN\QQDisabled</code>下的值</li>
</ul>
<h4 id="监控函数">监控函数</h4>
<p>  Ts进程：位于Q管目录或签名为Q管文件签名的进程，按规则判断：上抛给主防主防进程判断；默认情况下若发起者为Ts进程的都放过</p>
<p>使用AddPrevFilter接口设置的过滤函数有：</p>
<pre tabindex="0"><code>NtAllocateVirtualMemory
	若发起者为非TS进程而目标为TS进程，则设置PostFilter
	若发起者为非TS进程而目标为非TS进程，则放行
	若发起者为非TS进程而目标为未知进程，则查询虚拟内存监视链表，对比进程路径，按是否Ts进程分别处理
在PostFilter中记录得到的地址信息

NtAlpcCreatePort
	若发起者为非Ts进程，且不是csrss, services, smss, svchost, lsass, lsm，且操作为修改DNS解析器，则上抛主防根据规则判断

NtAlpcSendWaitReceivePort
	若发起者为非lsass非csrss非Ts进程，修改SAM信息，则上抛主防根据规则判断
	若发起者为非Ts进程，触发csrss进程结束/winlogon关机，则上抛主防根据规则判断
	若发起者为非Ts进程，操作驱动服务端口ntsvcs，则按服务号处理：
RcloseServiceHandle	执行功能，并将服务从监视列表中移除
RdeleteService, RsetServiceObjectSecurity, RchangeServiceConfigW,RchangeServiceConfigA,RChangeServiceConfig2A,
RChangeServiceConfig2W, RcontrolService,RcontrolServiceExA,RcontrolServiceExW	如果目标服务为QQPCRTP, TSKSP, TsFltMgr, QQSysMon, TSSysKit, TSSysFix则拒绝，否则执行功能
RopenServiceW,RopenServiceA	执行功能并上报主防
RcreateServiceW,RCreateServiceA 查注册表匹配树并根据结果选择执行功能且加入监控列表或上抛主防根据规则判断
RstartServiceW,RStartServiceA 	查注册表匹配树，上抛主防加载驱动事件，并根据结果放行或不执行，从监控列表中删除

NtAssignProcessToJobObject
	若发起者为非TS进程而目标为TS进程，则拒绝

NtCreateFile
	穿透实现NtCreateFile

NtCreateMutant
	添加PostFilter，在PostFilter中，若发起这为非Ts进程且目标Object处于g_StorageList[14]中则上抛主防判断

NtCreateKey
	若发起者为非主防进程，则在注册表键值匹配ACL树(RegMonTree)中查找，并根据结果上抛主防根据规则判断

NtCreateProcessEx
	添加PostFilter，在PostFilter中，将进程添加到进程监控链表并上报给主防

NtCreatePort
若发起者为非Ts进程，且不是csrss, services, smss, svchost, lsass, lsm，且操作为修改DNS解析器，则上抛主防根据规则判断

NtCreateSection
	满足DesiredAccess=SECTION_ALL_ACCESS,SectionPageProtection=PAGE_EXECUTE,AllocationAttributes=SEC_IMAGE时：
		设置PostFilter；若目标文件为Ts文件，则检查应用层回溯栈，如果存在CreateProcessInternalW，则在启动参数增加CREATE_PRESERVE_CODE_AUTHZ_LEVEL位


NtCreateThread 
	若发起者为非主防进程，且该线程不是进程第一个线程，且目标进程为Ts进程，则拒绝
若发起者为非主防进程，且该线程不是进程第一个线程，且目标进程为非Ts进程，则上抛主防根据规则判断

NtCreateThreadEx
	若发起者为非主防进程，且该线程不是进程第一个线程，且目标进程为Ts进程，则拒绝
若发起者为非主防进程，且该线程不是进程第一个线程，且目标进程为非Ts进程，则上抛主防根据规则判断

NtCreateSymbolicLinkObject
	若目标对象为\Device\PhysicalMemory则拒绝
	否则查询ACL表，若不符合则记录最近创建的4个符号名，若符合则上抛主防根据规则判断

NtCreateUserProcess
	若目标文件为Ts文件，则检查应用层回溯栈，如果存在CreateProcessInternalW，则在启动参数增加CREATE_PRESERVE_CODE_AUTHZ_LEVEL位

NtDeleteKey
	若目标在g_StorageList[9]中则拒绝
	若目标在注册表监控树中，若符合则上抛主防根据规则判断

NtDeleteValueKey
	若目标在g_StorageList[9]中则拒绝
	若目标在注册表监控树中，若符合则上抛主防根据规则判断

NtDeviceIoControlFile
	IoControlCode=0x8FFF23C8或0x8FFF23CC，目标驱动为\Driver\NDProxy，则上抛主防根据规则判断	IoControlCode=0x2A0000(IOCTL_SWENUM_INSTALL_INTERFACE)则将该服务项添加到监视
	IoControlCode=0x980C8(FSCTL_SET_ZERO_DATA)
	IoControlCode=0x2D1400(IOCTL_STORAGE_QUERY_PROPERTY), 0x700A0(IOCTL_DISK_GET_DRIVE_GEOMETRY_EX), 0x170002(IOCTL_NDIS_QUERY_GLOBAL_STATS), 0x4D008(IOCTL_SCSI_MINIPORT), 0x900c0(FSCTL_CREATE_OR_GET_OBJECT_ID), 0x90073(FSCTL_GET_RETRIEVAL_POINTERS), 0x7c088(SMART_RCV_DRIVE_DATA), 0x74080(SMART_GET_VERSION) 则上抛主防根据规则判断
	IoControlCode=0xA8730154, 0xA8730010 则采用不同解密密钥解密出PEPROCESS地址，若对应进程路径文件在内存操作监视链表中则拒绝

NtDuplicateObject (发起者，源进程，目标进程互不相同)
	若源进程和目标进程为本进程，且Options=DUPLICATE_SAME_ACCESS则放行
	若发起者为TS, csrss, services, smss, svchost, lsass, lsm进程则放行
	源进程为Ts进程，且”发起进程-源进程”对处于监视列表中则拦截，否则放行
	源进程为非Ts进程，目标进程为Ts进程，且非QQPCSoftGame, QQPCSoftMgr, QQPCClinic, QQPCExternal，则检查”发起进程-目标进程”对是否处于监视列表中，若存在则拦截，否则放行
	源进程为非Ts进程，目标进程为普通进程或QQPCSoftGame, QQPCSoftMgr, QQPCClinic, QQPCExternal：
		源进程和目标进程不同，或Options=DUPLICATE_SAME_ACCESS：
			源进程为发起进程，且源句柄类型为Process/Thread则拦截
			源进程不同于发起进程，则用本进程作为目标进程执行函数得到目标句柄：
				若执行成功且目标句柄类型为Process/Thread则拦截
				若执行返回STATUS_INSUFFICIENT_RESOURCES且获取进程句柄数无效则拦截
	其余情况放行

NtEnumerateValueKey
	执行函数，若KeyValueInformationClass=KeyValueFullInformation且发起进程为explorer：
		则只能枚举出子项\REGISTRY\MACHINE\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN\QQDISABLED

NtFreeVirtualMemory
	若发起进程为非Ts进程且目标进程为Ts进程则设置PostFilter，在PostFilter中吧释放的内存从监视数据中去除

NtFsControlFile
	若发起进程为非Ts进程，非lsass, csrss，则监视FsControlCode=0x11C017决定是否上抛主防

NtGetNextThread
	若发起进程为非主防进程且目标进程为Ts进程则拒绝执行
	若发起进程为非主防进程且目标进程为非Ts进程则将访问权限限制为SYNCHRONIZE|THREAD_QUERY_INFORMATION|THREAD_GET_CONTEXT

NtGetNextProcess
	设置PostFilter

NtLoadDriver
	若发起进程为非Ts进程，则将驱动文件信息上抛主防判断

NtMakeTemporaryObject
	若目标对象为Section类型，且对象名路径在\knowndlls\下则拒绝，否则放行

NtOpenFile
	穿透实现NtOpenFile

NtOpenProcess
	若全局开关“监视打开进程”开启，则设置PostFilter，重置AccessMask参数并执行函数，在PostFilter中将发起线程加入监控链表中
	若全局开关“监视打开进程”关闭：
若发起进程为非Ts进程：
			若目标进程为QQPCFileSafe.exe, QQPCSoftGame.exe, QQPCSoftMgr.exe, QQPCExternal.exe, QQPCClinic.exe则上抛主防判断
			若发起进程为svchost且目标进程为QQPCRtp.exe则上抛主防判断，若不符合条件则修改AccessMask标志位
			若发起进程为lsass且目标进程为QQPCTray.exe则上抛主防判断，若不符合条件则修改AccessMask标志位
			若发起进程为service且目标进程为Ts进程则上抛主防判断，若不符合条件则修改AccessMask标志位
			若不满足上述条件，且不在g_StorageList[15]中，则上抛主防判断，否则修改AccessMask
		若发起进程为Ts进程，或发起进程与目标进程相同，则修改AccessMask

NtOpenThread
	若全局开关“监控打开线程”开启，则设置PostFilter，重置AccessMask参数并执行函数，在PostFilter中将发起线程加入监控链表中
	若全局开关“监视打开进程”关闭：
		若发起进程为非Ts进程，且目标进程为Ts进程，则根据发起进程权限判断是否修改AccessMask

NtOpenSection
	若发起进程为非主防进程，且DesiredAccess有写权限，且目标对象为\device\physicalmemory则上抛主防根据规则判断

NtProtectVirtualMemory
	若发起者为非TS进程而目标为TS进程，则上抛主防根据规则进行判断

NtQueueApcThread
	若发起者为非TS进程而目标为TS进程，则拒绝
	若发起者为非TS进程而目标为非TS进程，则查询ACL表上抛主防根据规则判断

NtQueueApcThreadEx
	若发起者为非TS进程而目标为TS进程，则拒绝
	若发起者为非TS进程而目标为非TS进程，则查询ACL表上抛主防根据规则判断

NtReplaceKey
	若发起者为非Ts进程：
目标注册表键路径匹配g_StorageList[9]，则拒绝
		目标注册表键路径匹配SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN，则拒绝
		其他情况由注册表监控树获取权限并上抛主防根据规则判断

NtRequestWaitReplyPort
	若发起者为非lsass非csrss非Ts进程，修改SAM信息，则上抛主防根据规则判断
	若发起者为非Ts进程，触发csrss进程结束/winlogon关机，则上抛主防根据规则判断
	若发起者为非Ts进程，操作驱动服务端口ntsvcs，则按服务号处理：
RcloseServiceHandle	执行功能，并将服务从监视列表中移除
RdeleteService, RsetServiceObjectSecurity, RchangeServiceConfigW,RchangeServiceConfigA,RChangeServiceConfig2A,
RChangeServiceConfig2W, RcontrolService,RcontrolServiceExA,RcontrolServiceExW	如果目标服务为QQPCRTP, TSKSP, TsFltMgr, QQSysMon, TSSysKit, TSSysFix则拒绝，否则执行功能
RopenServiceW,RopenServiceA	执行功能并上报主防
RcreateServiceW,RCreateServiceA 查注册表匹配树并根据结果选择执行功能且加入监控列表或上抛主防根据规则判断
RstartServiceW,RStartServiceA 	查注册表匹配树，上抛主防加载驱动事件，并根据结果放行或不执行，从监控列表中删除

NtRestoreKey
	若发起者为非Ts进程：
目标注册表键路径匹配g_StorageList[9]，则拒绝
		目标注册表键路径匹配SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN，则拒绝
		其他情况由注册表监控树获取权限并上抛主防根据规则判断

NtSetContextThread
	若发起者为非TS进程而目标为TS进程，则查询ACL表并上抛主防根据规则进行判断

NtSetInformationFile
	若发起者为主防进程则放过
	若FileInformationClass=FileDispositionInformation：
		检查目标文件权限并上抛主防根据规则判断
	若FileInformationClass= FileRenameInformation：
		检查源文件和目标文件权限并上抛主防根据规则判断
	若FileInformationClass= FileLinkInformation：
		检查目标文件权限并上抛主防根据规则判断
若FileInformationClass= FileEndOfFileInformation：
		检查目标文件权限并上抛主防根据规则判断
若FileInformationClass= FileAllocationInformation：
		检查目标文件权限并上抛主防根据规则判断
	其他FileInformationClass放行

NtSetSecurityObject
	若发起者为非Ts进程，目标对象为以下之一则拒绝，否则放过：
		\REGISTRY\MACHINE\SYSTEM\ControlSet001\services\TSSysKit
		\REGISTRY\MACHINE\SYSTEM\ControlSet002\services\TSSysKit
		\REGISTRY\MACHINE\SYSTEM\CurrentControlSet\services\TSSysKit
		\REGISTRY\MACHINE\SYSTEM\ControlSet001\services\TSKSP
		\REGISTRY\MACHINE\SYSTEM\ControlSet002\services\TSKSP
		\REGISTRY\MACHINE\SYSTEM\CurrentControlSet\services\TSKSP
		\REGISTRY\MACHINE\SYSTEM\ControlSet001\services\QQPCRTP
		\REGISTRY\MACHINE\SYSTEM\ControlSet002\services\QQPCRTP
		\REGISTRY\MACHINE\SYSTEM\CurrentControlSet\services\QQPCRTP

NtSetSystemInformation
	若SystemInformationClass=SystemExtendServiceTableInformation：
		若发起者为非Ts进程且驱动文件存在则上抛主防根据规则进行判断
	若SystemInformationClass= SystemRegistryAppendStringInformation：
		若发起者为非Ts进程且目标注册表路径匹配g_StorageList[9]，若键值路径匹配\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\CONTROL\SESSION MANAGER下的PendingFileRenameOperations,或PendingFileRenameOperations2，则根据文件监控树中的重命名前文件和重命名后文件的访问权限上抛主防判断，否则根据注册表监控树上抛主防判断

NtSetValueKey
	若发起者为非Ts进程，且目标对象路径匹配\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\TSKSP*或\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\QQPCRTP，且目标注册表键名为Start(服务启动类型)，则上抛主防根据规则进行判断，根据结果选择是否执行
	若发起者为非Ts进程，且目标进程不是service，若匹配g_StorageList[9]则根据注册表监控树的访问权限上抛主防判断
	若键值路径匹配\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\CONTROL\SESSION MANAGER下的PendingFileRenameOperations,或PendingFileRenameOperations2，则根据文件监控树中的重命名前文件和重命名后文件的访问权限上抛主防判断，否则根据注册表监控树上抛主防判断

	上抛判断前，会做清理以下键值以反调试：
	\Registry\Machine\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\QQPCTray.exe
\Registry\Machine\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\QQPCRTP.EXE
\Registry\Machine\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\QQPCUPDATE.EXE
\Registry\Machine\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\QQPCAddWidget.exe
\Registry\Machine\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\QQPCMgr_tz_Setup.exe
\Registry\Machine\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\QQPCMgr.exe
\Registry\Machine\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\QQPConfig.exe

NtSuspendThread
	若发起者为非Ts进程且目标进程为Ts进程则上抛主防根据规则判断
	若发起者为非Ts进程且目标进程为非Ts进程则放过

NtSystemDebugControl
	若Command=SysDbgWriteVirtual或SysDbgWritePhysical则上抛主防根据规则判断

NtTerminateProcess
	若发起者为非Ts进程且目标进程为Ts进程：
		若目标进程权限不足则放过
		若发起进程在g_StorageList[11]中则上抛主防根据规则判断
	若发起者为非Ts进程且目标进程为非Ts进程：
		若目标进程id在g_StorageList[1]中或权限不足则上抛主防根据规则判断
		若目标进程不是taskmgr则放过，否则上抛主防根据规则判断

NtTerminateThread
	若发起者为非TS进程而目标为TS进程，则拒绝
	若发起者为非TS进程而目标为非TS进程，则查询ACL表上抛主防根据规则判断

NtUnmapViewOfSection
	若发起者为非主防进程，且目标进程为Ts进程，则拒绝
	若发起者为非主防进程，且目标进程为非Ts进程，则上抛主防根据规则判断

NtUserClipCursor
	若发起者为非主防进程，且激活窗口属于Ts进程，则匹配预设进程名，若匹配则跳过执行，否则放行

NtUserGetAsyncKeyState
	若发起者为普通进程，执行功能，若键’0’-‘9’,’A’-‘Z’, 数字键盘’0’~’9’被按下，则上抛主防根据规则重置结果

NtUserGetKeyboardState
	若发起者为普通进程，执行功能，若键’0’-‘9’,’A’-‘Z’, 数字键盘’0’~’9’被按下，则上抛主防根据规则重置结果

NtUserGetKeyState
	若发起者为普通进程，执行功能，若键’0’-‘9’,’A’-‘Z’, 数字键盘’0’~’9’被按下，则上抛主防根据规则重置结果

NtUserGetRawInputBuffer
	若发起者为普通进程，执行功能，若键’0’-‘9’,’A’-‘Z’, 数字键盘’0’~’9’被按下，则上抛主防根据规则重置结果

NtUserGetRawInputData
	若发起者为普通进程，执行功能，若键’0’-‘9’,’A’-‘Z’, 数字键盘’0’~’9’被按下，则上抛主防根据规则重置结果

NtUserMessageCall
	若dwType=FNID_SENDMESSAGECALLPROC, FNID_SENDMESSAGE, FNID_SENDNOTIFYMESSAGE, FNID_SENDMESSAGECALLBACK则跳过执行
	若发起进程为普通进程，且uMsg=WM_GETTEXT或WM_SETTEXT则执行函数，若获取的字符串在列表中则上报主防

NtUserPostMessage
	若发起进程不属于smss, lsass, lsm则上报主防进程
	捕获uMsg= WM_KEYFIRST, WM_KEYUP, WM_SYSKEYDOWN, WM_SYSKEYUP, WM_LBUTTONDBLCLK, WM_LBUTTONDOWN, WM_LBUTTONUP, WM_MBUTTONDBLCLK, WM_MBUTTONDOWN, WM_MBUTTONUP, WM_RBUTTONDBLCLK, WM_RBUTTONDOWN, WM_RBUTTONUP, BM_CLICK, WM_COMMAND, WM_NOTIFY 
	若uMsg=WM_COMMAND，则监视指定控件通知码
	若发起进程不同于目标窗口所属进程则决定是否上报主防
	若发起进程为非主防进程，且目标线程不同于发起线程，则关注uMsg=WM_KEYDOWN, WM_LBUTTONDOWN, BM_CLICK, WM_CLOSE, WM_SYSCOMMAND, SC_CLOSE, WM_SETREDRAW, WM_SHOWWINDOW, WM_NCDESTROY, WM_DESTROY, WM_SETTEXT, IE_DOCOMMAND, IE_GETCOMMAND, IE_GETCOUNT, WM_COMMAND
	若uMsg=WM_SYSCOMMAND或SC_CLOSE且发起者为explorer则放行，否则跳过执行

NtUserPostThreadMessage
	若发起进程不属于smss, lsass, lsm则上报主防进程
	捕获uMsg= WM_KEYFIRST, WM_KEYUP, WM_SYSKEYDOWN, WM_SYSKEYUP, WM_LBUTTONDBLCLK, WM_LBUTTONDOWN, WM_LBUTTONUP, WM_MBUTTONDBLCLK, WM_MBUTTONDOWN, WM_MBUTTONUP, WM_RBUTTONDBLCLK, WM_RBUTTONDOWN, WM_RBUTTONUP, BM_CLICK, WM_COMMAND, WM_NOTIFY 
	若uMsg=WM_COMMAND，则监视指定控件通知码
	若发起进程不同于目标窗口所属进程则决定是否上报主防
	若发起进程为非主防进程，且目标线程不同于发起线程，则关注uMsg=WM_KEYDOWN, WM_LBUTTONDOWN, BM_CLICK, WM_CLOSE, WM_SYSCOMMAND, SC_CLOSE, WM_SETREDRAW, WM_SHOWWINDOW, WM_NCDESTROY, WM_DESTROY, WM_SETTEXT, IE_DOCOMMAND, IE_GETCOMMAND, IE_GETCOUNT, WM_COMMAND，若匹配则根据情况跳过执行

NtUserSendInput
	若发起进程不属于smss, lsass, lsm则上报主防进程
	若发起进程为非主防进程则跳过执行

NtUserSetImeInfoEx
	先执行函数以获取文件名
	若输入法序号不存在于\Registry\Machine\SYSTEM\CurrentControlSet\Control\Keyboard Layouts\或子项为空，且发起进程为非Ts进程，则根据注册表监控树上抛主防根据规则决定是否放行
	若输入法文件不为msctfime.ime/ msctf.dll，则根据注册表监控树上抛主防根据规则决定是否放行，否则放行
执行KeUserModeCallback前对该函数做还原inline hook处理

NtUserSetWindowsHookEx
	若发起者为非Ts进程，ThreadId不为NULL，且目标进程为Ts进程，则拒绝
	若发起者为非Ts进程，ThreadId不为NULL，且目标进程为System进程，若ModuleName为shell32.dll, msctf.dll, ieframe.dll, mshtml.dll, dinput8.dll, browseui.dll则放过，否则上抛主防根据规则判断
	若发起者为非Ts进程，ThreadId为NULL，且目标进程为Ts进程，则按全局键盘钩子上抛主防根据规则判断
放行WH_KEYBOARD_LL类hook

NtUserSetWindowLong
	若nCmdShow为SW_SHOWMINNOACTIVE或SW_FORCEMINIMIZE且目标窗口属于QQ.exe则上报给主防
	若发起进程为主防进程则放过
若目标窗口属于Ts进程则跳过执行

NtUserSetWindowPos
	若nCmdShow为SW_SHOWMINNOACTIVE或SW_FORCEMINIMIZE且目标窗口属于QQ.exe则上报给主防
	若发起进程为主防进程则放过
若目标窗口属于Ts进程则跳过执行

NtUserSetWinEventHook
	若发起进程为Ts进程则放过
	若dwflags不包含WINEVENT_INCONTEXT则放过
	若发起进程等同目标进程则放过
	若目标进程为Ts进程，则上抛主防根据规则判断

NtUserShowWindow
	若nCmdShow为SW_SHOWMINNOACTIVE或SW_FORCEMINIMIZE且目标窗口属于QQ.exe则上报给主防
	若发起进程为主防进程则放过
	若nCmdShow不为SW_HIDE, SW_SHOWMINIMIZED, SW_MINIMIZE, SW_SHOWMINNOACTIVE, SW_FORCEMINIMIZE则放过
若目标窗口属于Ts进程则跳过执行

NtUserShowWindowAsync
	若发起进程为主防进程则放过
	若nCmdShow不为SW_HIDE, SW_SHOWMINIMIZED, SW_MINIMIZE, SW_SHOWMINNOACTIVE, SW_FORCEMINIMIZE则放过
若目标窗口属于Ts进程则跳过执行

NtWriteVirtualMemory
	若发起者为普通进程，若目标进程为Ts进程，则拒绝；若目标进程为普通进程，则在用户态回溯栈中判定是否由CreateProcess发起 ，并根据ACL表上抛主防根据规则决定是否放行
	
KeUserModeCallback
	若ApiNumber=__ClientLoadLibrary：
若发起者为主防进程，跳过执行
若目标文件和事先传入(IoCtlCode=0x22E0E8)的Ts dll文件匹配则跳过执行
若目标文件在g_StorageList[13]中则跳过执行
若开启白名单且目标文件不在g_StorageList[16]中则跳过执行
若目标文件在g_StorageList[5]中且发起进程为Ts进程则跳过执行，否则放过
	若ApiNumber== __fnHkINLPKBDLLHOOKSTRUCT：
若发起者为普通进程，执行功能，若键’0’-‘9’,’A’-‘Z’, 数字键盘’0’~’9’被按下，则上抛主防根据规则重置结果
	若ApiNumber== __ClientImmLoadLayout
		先执行函数以获取文件名
		若输入法序号不存在于\Registry\Machine\SYSTEM\CurrentControlSet\Control\Keyboard Layouts\或子项为空，且发起进程为非Ts进程，则根据注册表监控树上抛主防根据规则决定是否放行
		若输入法文件不为msctfime.ime/ msctf.dll，则根据注册表监控树上抛主防根据规则决定是否放行，否则放行
执行KeUserModeCallback前对该函数做还原inline hook处理
</code></pre><p>1.4重要回调的挂钩</p>
<pre tabindex="0"><code>PsSetCreateProcessNotifyRoutine
	将新增加的进程信息加入(ProcInfoList)链表
	若为创建进程：
        清除关键Ts文件映像劫持，即\Registry\Machine\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options下的QQPCTray.exe, QQPCRTP.EXE, QQPCUPDATE.EXE, QQPCAddWidget.exe, QQPCMgr_tz_Setup.exe, QQPCMgr.exe, QQPConfig.exe
    若为删除进程：
        清除进程相关信息
        若进程为主防进程，则清除和关闭消息通信，进行清理工作
        上报进程退出
PsSetCreateProcessNotifyRoutineEx
	若CreateInfo为空则获取父进程id后交给CreateProcessNotify处理
	将新增加的进程信息加入(ProcExInfoList)链表
PsSetLoadImageNotifyRoutine
	若为系统模块，若为TesSafe.sys则记录该模块信息
	若为普通模块，加载进程为若为Ts进程，且和目标模块exe相同，则清空PEB结构中的ShimData数据
</code></pre><h4 id="一些用到的数据">一些用到的数据</h4>
<pre tabindex="0"><code>BuildNumber[21] =&gt; UNKNOWN, 2195, 2600, 3790, 6000, 6001, 6002, 7000|7600, 7601, 8102, 8250, 8400, 8432|8441, 8520, 9200, 9600, 9841, 9860, 9926, 10041, 10049
ApiName[15] =&gt; NtUserFindWindowEx, NtUserBuildHwndList, NtUserQueryWindow, NtUserGetForegroundWindow, NtUserSetParent, NtUserSetWindowLong, NtUserMoveWindow, NtUserSetWindowPos, NtUserSetWindowPlaceMent, NtUserShowWindow, NtUserShowWindowAsync, NtUserSendInput, NtUserMessageCall, NtUserPostMessage, NtUserPostThreadMessage
Index[BuildNumber][ApiName]=
0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,0x000,
0x170,0x12e,0x1d2,0x189,0x1fe,0x20d,0x1c1,0x20f,0x20e,0x218,0x219,0x1e1,0x1bc,0x1cb,0x1cc,
0x17a,0x138,0x1e3,0x194,0x211,0x220,0x1d1,0x222,0x221,0x22b,0x22c,0x1f6,0x1cc,0x1db,0x1dc,
0x179,0x137,0x1e1,0x193,0x20e,0x21c,0x1d0,0x21e,0x21d,0x227,0x228,0x1f4,0x1cb,0x1da,0x1db,
0x187,0x142,0x1f8,0x1a2,0x226,0x236,0x1e4,0x238,0x237,0x243,0x244,0x20d,0x1df,0x1f1,0x1f2,
0x187,0x142,0x1f8,0x1a2,0x226,0x236,0x1e4,0x238,0x237,0x243,0x244,0x20d,0x1df,0x1f1,0x1f2,
0x187,0x142,0x1f8,0x1a2,0x226,0x236,0x1e4,0x238,0x237,0x243,0x244,0x20d,0x1df,0x1f1,0x1f2,
0x18c,0x143,0x203,0x1a7,0x230,0x242,0x1ef,0x244,0x243,0x24f,0x250,0x218,0x1ea,0x1fc,0x1fd,
0x18c,0x143,0x203,0x1a7,0x230,0x242,0x1ef,0x244,0x243,0x24f,0x250,0x218,0x1ea,0x1fc,0x1fd,
0x1c7,0x166,0x1de,0x1aa,0x246,0x230,0x1f3,0x22e,0x22f,0x223,0x222,0x25e,0x1f8,0x1e6,0x1e5,
0x1c9,0x167,0x1e0,0x1ac,0x249,0x232,0x1f5,0x230,0x231,0x225,0x224,0x261,0x1fa,0x1e8,0x1e7,
0x1ca,0x168,0x1e1,0x1ad,0x24b,0x234,0x1f6,0x232,0x233,0x227,0x226,0x263,0x1fb,0x1e9,0x1e8,
0x1cb,0x168,0x1e2,0x1ae,0x24d,0x236,0x1f7,0x234,0x235,0x229,0x228,0x265,0x1fc,0x1ea,0x1e9,
0x1cc,0x168,0x1e3,0x1ae,0x24f,0x237,0x1f8,0x235,0x236,0x22a,0x229,0x267,0x1fd,0x1eb,0x1ea,
0x1cb,0x168,0x1e2,0x1ad,0x24e,0x236,0x1f7,0x234,0x235,0x229,0x228,0x266,0x1fc,0x1ea,0x1e9,
0x1cc,0x16a,0x1e3,0x1ae,0x251,0x239,0x1f9,0x237,0x238,0x22c,0x22b,0x269,0x1fe,0x1ec,0x1eb,
0x1ce,0x16b,0x1e5,0x1af,0x253,0x23b,0x1fb,0x239,0x23a,0x22e,0x22d,0x26b,0x200,0x1ee,0x1ed,
0x1d2,0x16f,0x1e9,0x1b3,0x259,0x23f,0x1ff,0x23d,0x23e,0x232,0x231,0x271,0x204,0x1f2,0x1f1,
0x1d2,0x16f,0x1e9,0x1b3,0x25a,0x240,0x1ff,0x23e,0x23f,0x233,0x232,0x272,0x204,0x1f2,0x1f1,
0x1d2,0x16f,0x1e9,0x1b3,0x25b,0x240,0x1ff,0x23e,0x23f,0x233,0x232,0x273,0x204,0x1f2,0x1f1,
0x1d3,0x16f,0x1ea,0x1b3,0x25c,0x241,0x200,0x23f,0x240,0x234,0x233,0x274,0x205,0x1f3,0x1f2,
	__ClientLoadLibrary在KeUserModeCallBack中的ApiNumber	ImmLoadLayoutIndex[BuildNumber] =
-1, -1, 84, -1, -1, -1, -1, 82, 82, -1, -1, -1, -1, -1, 84, 88, -1, -1, -1, -1, -1
	KeyboardLL在KeUserModeCallBack中的ApiNumber  HookKeyboardLLIndex[BuildNumber] =
-1, -1, 45, -1, -1, -1, -1, 45, 45, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1
对象例程相对于对象类型结构偏移 ObjectProcedureOffset [BuildNumber] =
-1, -1, 140, 140, 88, 88, 88, 88, 88, -1, -1, -1, -1, -1, 88, 88, 88, 88, 88, 88, -1
	ShimData成员相对PEB结构偏移	
-1, -1, 488, -1, -1, -1, -1, 488, 488, -1, 488, 488, -1, -1, 488, 488, -1, -1, 0, 0, 0
	KeUserModeCallBack的ImmLoadLayout功能号中模块路径相对InputBuffer偏移 ClientLoadLibraryNameOffset[BuildNumber] =0, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 48, 28, 0
</code></pre><h4 id="object_type_initializer-挂钩">OBJECT_TYPE_INITIALIZER 挂钩</h4>
<p>  和TsSyskit中类似，只不过Tsksp中，采用的是Proxy~Hooker的方式，将Proxy替换OpenProcedure，为每种Procedure预留5个函数槽用于存放过滤函数，只要有一个失败则返回失败。Proxy结构数组我在IDA中标记为ObjectProceduresProxy，依次为Event,
File, Process, Thread, Mutant, Section的Proxy结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ec0000">struct</span> ObjectProcedureStruct
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG ObType;//标识对象类型
</span></span><span style="display:flex;"><span>/*
</span></span><span style="display:flex;"><span>0 ExEventObjectType
</span></span><span style="display:flex;"><span>1 PsProcessType
</span></span><span style="display:flex;"><span>2 PsThreadType
</span></span><span style="display:flex;"><span>3 IoFileObjectType
</span></span><span style="display:flex;"><span>4 ExMutantObjectType
</span></span><span style="display:flex;"><span>5 MmSectionObjectType
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>	ULONG ProcIndex;//标识函数类型
</span></span><span style="display:flex;"><span>/*
</span></span><span style="display:flex;"><span>0 DumpProcedure
</span></span><span style="display:flex;"><span>1 OpenProcedure
</span></span><span style="display:flex;"><span>2 CloseProcedure
</span></span><span style="display:flex;"><span>3 DeleteProcedure
</span></span><span style="display:flex;"><span>4 ParseProcedure
</span></span><span style="display:flex;"><span>5 SecurityProcedure
</span></span><span style="display:flex;"><span>6 QueryNameProcedure
</span></span><span style="display:flex;"><span>7 OkayToCloseProcedure
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>	ULONG Proxy[<span style="color:#008900">21</span>];//存放代理函数地址，分21个操作系统版本
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  再用一个数组存储对应的过滤函数：ULONG ObjectProceduresD(ynamic)Filter[6][8][5]，6对应ObType，8对应ProcIndex，5为函数槽个数，数组中的数据，是从静态结构模板中导入的，该静态模板结构沿用了ObjectProcedureStruct结构。TsKsp中最终只对6种对象类型的OpenProcedure做了挂钩。</p>
<p>代理函数逻辑：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">ProcedureProxy</span>(OB_OPEN_REASON OpenReason, PEPROCESS Process, PVOID Object, ACCESS_MASK GrantedAccess, ULONG HandleCount)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">5</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(ObjectProceduresDFilter[ObType][ProcType][i])
</span></span><span style="display:flex;"><span>			Status <span style="color:#ec0000">=</span> ObjectProceduresDFilter[ObType][ProcType][i](OpenReason,Process,Object,GrantedAccess,HandleCount);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="procinfo结构">PROCINFO结构</h4>
<p>用于存储当前系统进程信息</p>
<pre tabindex="0"><code>struct PROCINFO
{
	HANDLE ProcessId;
	ULONG ProcDir;//标志目录属性
	ULONG ProcType;//标志进程类型
	ULONG Access;//标志访问权限
	WCHAR Path[260];
	ULONG IsSignMatch;
	ULONG Index;
}

ProcDir域：
“System”, “Idle”		4
Ts进程				2
普通进程			1

ProcType域：
“System”				-3
“Idle”				-2
普通进程			-1
“csrss”				0
“services”			1
“smss”				2
“explorer”			3
“winlogon”			4
“svchost”				5
“lsass”				6
“lsm”				7
“taskmgr”			8

Access域：(访问权限)
0x1	通信
0x2	进程线程创建打开，驱动加载，内存操作
0x4	结束进程
0x8	注册表创建打开设置
0x10	设置文件属性
0x100	窗口交互类

“System”,”Idle”,Ts进程		0x1FF
“svchost”,”csrss”,“lsm”,”lsass”	0x107
“smss”						0x10
“services”					0x8
普通进程					0x0
</code></pre><p>对重要进程访问控制权限的设定：<br>
PROCINFO信息是在进程创建时构造的，对于重要系统进程会单独进行初始化(InitCriticalProcessList)</p>
<pre tabindex="0"><code>name=csrss.exe,access=0x107,index=0
name=services.exe,access=0x8,index=1
name=smss.exe,access=0x10,index=2
name=Explorer.exe,access=0x0,index=3
name=winlogon.exe,access=0x0,index=4
name=svchost.exe,access=0x107,index=5
name=lsass.exe,access=0x107,index=6
name=lsm.exe,access=0x107,index=7
name=taskmgr.exe,access=0x2,index=8
</code></pre><p>具体如TsKsp Log.txt进程结构信息所示</p>
<h3 id="控制信息">控制信息</h3>
<h4 id="acl访问控制列表">ACL访问控制列表</h4>
<pre tabindex="0"><code>struct ACLTable		进程相关ProcessAclTable
+00h    BYTE* arr   BYTE AclTable [dimen3][dimen2][dimen1]
+04h    int dimen1  源进程类型相关    PROCINFO-&gt;ProcDir
    普通        1
    同目录      2
    &#34;Idle&#34;      4
    &#34;System&#34;    4
+08h    int dimen2  目标进程类型相关    PROCINFO-&gt;ProcDir
    普通        1
    同目录      2
    &#34;Idle&#34;      4
    &#34;System&#34;    4
+0Ch    int dimen3  
进程相关：
    ZwTerminateProcess		3
    ZwCreateThread			6
    ZwCreateThreadEx			6
    ZwTerminateThread		7
    ZwQueueApcThread		9
    ZwQueueApcThreadEx		9
    ZwSetContextThread		10
    ZwAllocateVirtualMemory	11
    ZwFreeVirtualMemory		11  
ZwWriteVirtualMemory		11
+10h	bool inited
</code></pre><p>文件也有类似的访问控制表</p>
<h4 id="匹配树">匹配树</h4>
<p>TsKsp中存在注册表权限匹配树，和文件权限匹配树，结构为树+链表：</p>
<pre tabindex="0"><code>struct TreeData
{
	PWCHAR MatchString;
	BOOLEAN HasVal;
	ULONG* Val1;
	ULONG Val2;
	TreeData* Next;
};

struct MatchTree
{
	PWCHAR MatchString;
	MatchTree* Left;
	MatchTree* Right;
	TreeData* Data;
	BOOLEAN HasVal;
};

void TranverseData(TreeData* data,int depth)
{
	while(data)
	{
		for(int i=0;i&lt;depth;i++)
			DbgPrint(&#34;\t&#34;);
		DbgPrint(&#34;access=%x %x\n&#34;,*(ULONG*)data-&gt;Val1,data-&gt;Val2);	
		if(data-&gt;MatchString)
		{
			for(int i=0;i&lt;depth;i++)
				DbgPrint(&#34;\t&#34;);
			DbgPrint(&#34;-%ws&#34;,data-&gt;MatchString);
		}
		data=data-&gt;Next;
	}
}

void TranverseTree(MatchTree* node,int depth)
{
	if(node)
	{
		if(node-&gt;MatchString)
		{
			for(int i=0;i&lt;depth;i++)
				DbgPrint(&#34;\t&#34;);
			DbgPrint(&#34;+%ws\n&#34;,node-&gt;MatchString);
		}
		TranverseData(node-&gt;Data,depth+1);
		TranverseTree(node-&gt;Left,depth+1);
		TranverseTree(node-&gt;Right,depth);
	}
}
main()
{
    MatchTree* node=*(MatchTree**)(Base+0x2C908);
    TranverseTree(node,0);
}
</code></pre><p>得到结果见TsKspLog.txt 匹配树结构&mdash;&mdash;注册表 和 匹配树结构&mdash;&mdash;文件</p>
<h4 id="全局开关driverswitch">全局开关DriverSwitch</h4>
<pre tabindex="0"><code>DriverSwitch[0] &amp; 1			监视消息和Section
DriverSwitch[0] &amp; 2			监视窗口控件消息
DriverSwitch[0] &amp; 4			监视硬件IOCTL
DriverSwitch[0] &amp; 8			是否在创建/打开文件时将读权限设置为读|删除
DriverSwitch[0] &amp; 0x100		拦截LPC某消息
DriverSwitch[0] &amp; 0x200		在进程操作中通过文件号打开NTFS分区文件
DriverSwitch[1] &amp; 4			是否允许任务管理器结束进程
DriverSwitch[1] &amp; 8			监视键盘状态
DriverSwitch[1] &amp; 0x40		监视加载输入法文件
DriverSwitch[1] &amp; 0x80		监视访问系统文件保护 sfc 
DriverSwitch[2] &amp; 0x100		监视Ole LPC
DriverSwitch[1] &amp; 0x200		打开进程和注册表时是否允许发起者为普通进程
DriverSwitch[1] &amp; 0x400		监视csrss process shutdown
DriverSwitch[1] &amp; 0x1000	监视服务操作的进程是否为敏感进程
DriverSwitch[2] &amp; 0x2000	监视操作虚拟内存目标进程为系统线程
DriverSwitch[1] &amp; 0x4000	是否使用回调式进程虚拟内存记录监视虚拟内存;是否监视创建非系统线程
DriverSwitch[1] &amp; 0x8000	监视对象操作的总开关，已包括Process, Thread, Mutant, Section, File, Event对象
DriverSwitch[1] &amp; 0x20000	是否启用创建进程监视链表MonCreateProcessList
DriverSwitch[1] &amp; 0x80000	监视内存映射
DriverSwitch[1] &amp; 0x100000	监视窗口消息
DriverSwitch[1] &amp; 0x200000	监视打开文件对象
DriverSwitch[1] &amp; 0x800000	监视打开进程
DriverSwitch[1] &amp; 0x1000000	监视NDIS 0Day Attack
DriverSwitch[1] &amp; 0x2000000	是否打开监视注册表、进程、线程、文件等函数的总开关，包括
ZwCreateKey,ZwDeleteKey,ZwDeleteValueKey,ZwCreateThread,
ZwDeviceIoControlFile,ZwQueueApcThread,ZwSetInformationFile,ZwSetSecurityObject,ZwSetSystemInformation,
ZwCreateFile,ZwOpenFile,ZwSetValueKey,ZwSuspendThread,ZwSystemDebugControl,ZwTerminateProcess,
ZwTerminateThread,ZwDuplicateObject,ZwEnumerateValueKey,ZwOpenProcess,ZwOpenSection,ZwQueueApcThreadEx
DriverSwitch[1] &amp; 0x8000000	设置打开进程的PostFilter
DriverSwitch[1] &amp; 0x10000000	监视打开线程对象
DriverSwitch[1] &amp; 0x20000000	允许从存储的进程链表获取签名信息

DriverSwitch[2] &amp; 0x10		监视打开Event, Mutant对象
DriverSwitch[2] &amp; 0x80		是否检查权限时使用PROCESSINFO的签名位IsSignMatch
DriverSwitch[2] &amp; 0x100		检测Ole LPC通信
DriverSwitch[2] &amp; 0x200		检测父进程创建时间逻辑
DriverSwitch[2] &amp; 0x400    	监视虚拟内存的创建、写入和释放
DriverSwitch[2] &amp; 0x800 		监视winlogon shutdown
DriverSwitch[2] &amp; 0x1000		监视打开Mutant对象
DriverSwitch[2] &amp; 0x2000		是否允许操作System进程虚拟内存
DriverSwitch[2] &amp; 0x80000		监视操作SAM
DriverSwitch[2] &amp; 0x8000000	监视操作栈区虚拟内存
DriverSwitch[2] &amp; 0x40000000	监视用户态模块加载
</code></pre><p>MaskForDriverSwitch[14] 用于生成特定组合的DriverSwitch，见IoCtlCode ==
0x22E410，数据：</p>
<pre tabindex="0"><code>0,0x22b8
1,0x21fc
2,0x2199
3,0x26b8
4,0x22b7
5,0x22b5
6,0x22b6
7,0x26b9
8,0x219a
9,0x22b3
10,0x26ba
11,0x26bd
12,0x26bb
13,0x26be
</code></pre><p>0x22E410控制码接收4字节数据mask，根据mask生成对应DriverSwitch











<figure class="">

    <div>
        <img loading="lazy" alt="" src=" /img/0x22E410.png">
    </div>

    
</figure></p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>BOOL <span style="color:#5f5fff">SwitchControl</span>(ULONG mask)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> bit;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> val;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> index;
</span></span><span style="display:flex;"><span>	BOOL set <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">switch</span>((mask <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">28</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">7</span>)// 28~30 bit
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(bit<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;bit<span style="color:#ec0000">&lt;</span><span style="color:#008900">14</span>;bit<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(MaskForDriverSwitch[bit] <span style="color:#ec0000">==</span> mask <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0xFFFFFFF</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(bit<span style="color:#ec0000">&lt;</span><span style="color:#008900">14</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			set <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>((mask <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x80000000</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>				DriverSwitch[<span style="color:#008900">0</span>] <span style="color:#ec0000">&amp;=</span> <span style="color:#ec0000">~</span>(<span style="color:#008900">1</span><span style="color:#ec0000">&lt;&lt;</span>bit);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>				DriverSwitch[<span style="color:#008900">0</span>] <span style="color:#ec0000">|=</span> <span style="color:#008900">1</span><span style="color:#ec0000">&lt;&lt;</span>bit;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">2</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		val <span style="color:#ec0000">=</span> mask <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0xFFFFFFF</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(val <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">0x65</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			set <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>			index <span style="color:#ec0000">=</span> val <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">5</span>;
</span></span><span style="display:flex;"><span>			bit <span style="color:#ec0000">=</span> val <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x1F</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>((mask <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x80000000</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>				DriverSwitch[index] <span style="color:#ec0000">&amp;=</span> <span style="color:#ec0000">~</span>(<span style="color:#008900">1</span><span style="color:#ec0000">&lt;&lt;</span>bit);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>				DriverSwitch[index] <span style="color:#ec0000">|=</span> <span style="color:#008900">1</span><span style="color:#ec0000">&lt;&lt;</span>bit;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="自保开关影响的函数和功能">自保开关影响的函数和功能</h4>
<p>  在DriverEntry中，将<code>\REGISTRY\MACHINE\SYSTEM\CurrentControlSet\Services\QQSysMon\spvalue</code>的值若为0或1，则开启自保。另外可以在Q管界面常规设置选择自保护以手动方式开关自保，对应的程序QQPConfig.exe每次启动时会从TsKsp读取自保位(控制码0x22E0A0)，设置完毕时发送给TsKsp(控制码0x22E070)</p>
<pre tabindex="0"><code>NtSetInformationFile	
影响Class=FileDispositionInformation, FileRenameInformation, FileLinkInformation, FileEndOfFileInformation, FileAllocationInformation的判断
NtCreateSymbolicLinkObject
NtDeviceIoControlFile
	影响IoCtlCode=FSCTL_SET_ZERO_DATA的判断
NtSetSystemInformation	
	影响Class=SystemRegistryAppendStringInformation重启替换/删除注册表键的判断
	影响Class=SystemExtendServiceTableInformation 加载可执行映像的判断
NtSetValueKey	
影响重启替换/删除注册表键的判断
NtRestoreKey
NtOpenProcess
NtOpenThread
NtUser*
NtRequestWaitReplyPort/NtAlpcSendWaitReceivePort
	影响RChangeServiceConfig, RDeleteService, RSetServiceObjectSecurity, 
NtAssignProcessToJobObject
NtCreateMutant
NtCreateThread\NtCreateThreadEx
NtDeleteKey
NtDeleteValueKey
NtSetValueKey
NtDuplicateObject
NtGetNextProcess
NtOpenProcess
NtOpenThread
NtProtectVirtualMemory
NtQueueApcThread\NtQueueApcThreadEx
NtSetContextThread
NtSetSecurityObject
NtSuspendThread
NtTerminateProcess
NtUnmapViewOfSection
NtWriteVirtualMemory
KeUserModeCallback
	影响ApiNumber=ClientLoadLibrary，若加载Ts文件的判断
CreateProcessNofity/ CreateProcessNotifyEx
	影响每次创建进程是否清除注册表调试键
	影响每次创建进程是否清除注册表调试键
LoadImageNotify
	影响加载用户态映像的判断
Object-OpenProcedure
影响Event, File, Mutant, Process, Thread 对象的过滤
LPC通信中访问\RPC Control\IcaApi
</code></pre><h4 id="规则判断">规则判断</h4>
<ul>
<li>获取规则组号</li>
</ul>
<pre tabindex="0"><code>int __stdcall GetRuleGroup(int mIndex, int nIndex, wchar_t *chname, wchar_t *enname)  根据传递的中英文字符串(说明，路径等)参数匹配出组号
mIndex 一级序号
 0 进程线程
 1 文件
 3 其他
nIndex 二级序号  通过FuncTypeToNum转换
  mIndex=0时，为进程/线程操作
3  TerminateProcess
4  CreateProcess
5  QueryProcess
6  CreateThread
7  TerminateThread
8  SuspendThread
9  QueueApcThread
10 SetContextThread
  mIndex=2时，为注册表操作
0  NtCreateKey	
2  NtSetValueKey	
3  NtDeleteValueKey	
4  NtDeleteKey	
	5  NtRestoreKey	
	6  默认	
mIndex=3时，为文件操作
	0  FileEndOfFileInformation/FileAllocationInformation 
	1  FileDispositionInformation
2  FileLinkInformation 
	3  FileRenameInformation 
	5  重启删除/重命名文件	
	6  默认	
  mIndex=4  
取消进程钩子
  mIndex=5
1  QueueApcThread 
2  RChangeServiceConfig
3  RDeleteService
7  NtUserSendInput
8  HardwareIoctl
10 Ole LPC
chname 中文类型说明
enname 英文类型说明
</code></pre><ul>
<li>
<p>将规则id, 源进程id, 目标进程id, 源进程路径,
目标进程路径等信息序列化(SerialData)到上抛消息结构中</p>
</li>
<li>
<p>设置事件等待主防读取并取得判断结果</p>
</li>
</ul>
<p>实例：</p>
<pre tabindex="0"><code>kd&gt; dd tsksp+29960
b2cbd960 00000012 8149b648 00000140 8149c000
b2cbd970 00000000 00000000 0000001d 81487508
</code></pre><p>见TsKsp Log.txt 规则判断</p>
<h4 id="黑白名单g_storagelist">黑白名单g_StorageList</h4>
<p>  共有17个，<code>!list -t _LIST_ENTRY.Flink -x &quot;dd @$extret+8 &quot; tsksp+252A8+index*0x30</code>，每种类型的链表对应不同Index，都用同样的数据结构存储</p>
<pre tabindex="0"><code>Struct MonitorDataHead
{
	ULONG Index;//功能序号
	SPIN_LOCK Lock;//用于同步
	PVOID PData;//存储下面17种继承于LIST_ENTRY的数据结构
	ULONG OffsetToHead;//每种结构List成员相对于PData的偏移
	ULONG DataSize;//每种结构数据大小
	ULONG InsertRoutine;//插入元素例程
	ULONG DeleteRoutine;//删除元素例程
	ULONG FindRoutine;//查找元素例程
	ULONG FindWrapperRoutine;//互斥查找元素例程
	ULONG DeleteAllRoutine;//清空数据例程
	ULONG CompareRoutine;//比较元素例程
}

Index=0  sizeof=528		结束进程名黑名单	关自保或进程文件为普通文件生效
	+00	LIST_ENTRY List
	+08	WCHAR ProcessName[260]

Index=1  sizeof=12		结束进程ID黑名单	关自保或进程文件为普通文件生效
	+00	LIST_ENTRY List
	+08	HANDLE ProcessId			进程Id

Index=2	sizeof=528		未知
	+00	LIST_ENTRY List
	+08	WCHAR ProcessName[260]	进程名

Index=3	sizeof=12		未知
	+00	LIST_ENTRY List
	+08	HANDLE ProcessId			进程Id

Index=4  sizeof=536		未知
	+00	LIST_ENTRY List
	+08 	WCHAR ProcessName[260]		进程名
	+210 IsWild//是否为通配符

Index=5	sizeof=528  	ClientLoadLibrary加载模块白名单			SelfProcInjectAllow
	+00	LIST_ENTRY List
	+08	WCHAR ImagePath[260]		映像路径

C:\Program Files\Tencent\QQPCMgr\11.1.16892.209\QMForbiddenWinKey.dll
C:\WINDOWS\system32\mshtml.dll
C:\WINDOWS\system32\IEUI.dll
C:\WINDOWS\system32\ieframe.dll
C:\WINDOWS\system32\uxtheme.dll
C:\WINDOWS\system32\browseui.dll

Index=6	sizeof=528			未知
	+00	LIST_ENTRY List
	+08	WCHAR [260]

Index=7	sizeof=1048				未知
	+00	LIST_ENTRY List
	+08	WCHAR [260]
	+210 WCHAR [260]

Index=8	sizeof=528			操作虚拟内存，创建进程，创建内存映射文件 目标黑名单 
	+00	LIST_ENTRY List
	+08	WCHAR  FileName[260]	文件名

Index=9	sizeof=12			注册表操作黑名单	
LIST_ENTRY
WCHAR[260]	KeyPathPattern		键路径模式
WCHAR[260]	ValueNamePattern		键值模式

\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\TSKSP*, *
\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\QQPCRTP*, *
\REGISTRY\MACHINE\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN, QQPCTRAY
\REGISTRY\MACHINE\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN\QQDISABLED, *
\REGISTRY\USER\S-*\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN\QQDISABLED, *
	\REGISTRY\MACHINE\SOFTWARE\TENCENT\QQPCMGR\SYSTEMOPTIMIZE\DISABLED, *
	\REGISTRY\MACHINE\SOFTWARE\TENCENT\QQPCMGR\SYSTEMOPTIMIZE\DISABLEDSVC, *
	\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\TSDEFENSEBT*, *
	\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\QQSYSMON*, *
	\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\TFSFLT*, *
	\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\TSSYSKIT*, *
	\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\TSFLTMGR*, *
	\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\TSSK*, *
	\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\TSNETMON*, *
	\REGISTRY\USER\QMCONFIG*, *
	\REGISTRY\MACHINE\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\UNINSTALL\QQPCMGR*, *
	\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\TSSYSFIX*, *
	\REGISTRY\MACHINE\SYSTEM\*CONTROLSET*\SERVICES\ANTIRK*, *

Index=10	sizeof=536				文件
	+00	LIST_ENTRY List
	+08	WCHAR  FileName[260]	文件/路径名
	+210 BOOL IsDir
	+214
	
Index=11	sizeof=528	结束进程查询名单		CTSKspWrap::AddSelfProcTeminateQuery
	+00	LIST_ENTRY List
	+08	WCHAR FilePath [260]	文件名

	C:\Program Files\Tencent\QQPCMgr\11.1.16892.209

Index=12	sizeof=528		未知
	+00	LIST_ENTRY List
	+08	WCHAR [260]

Index=13	sizeof=528		__ClientLoadLibrary   __ClientLoadLibrary发起进程黑名单
	+00	LIST_ENTRY List
	+08	FileName [260]		文件名

TASLogin.exe
Client.exe
SoapUI_4_6_4.exe
QQPCLeakScan.exe
navicat.exe
NativeWeb.exe
phpstorm.exe
ugraf.exe
League of Legends.exe
dnf.exe
tgp_daemon.exe
my.exe
pycharm.exe
bugreport.exe
QQPetBear.exe
TXPlatform.exe
xmind.exe
tencentdl.exe
_INS5576._MP

Index=14	sizeof=536			打开对象目标黑名单				SyncObjProtect
LIST_ENTRY	List
POBJECT_NAME_INFORMATION ObjInfo		对象路径
 WCHAR ObjectPath[260]

04CE0CB6-CDF3-4a4b-8B9D-292A455FAF5B
04CE0CB6-CDF3-4a4b-8B9D-292A455F
AF5B
QDOCTOR_2
QDOCTOR_1
QDOCTOR_0
qpcmgr\10002_0_80
ENCENT_QMTAV_TSCAN_HANG

Index=15	sizeof=1072			打开进程/复制句柄发起进程白名单			SelfProcAllow
LIST_ENTRY	List
ULONG 	Enable??
ULONG		SourceFilePathLen			
WCHAR[261] SourceProcessFilePath		源进程路径
ULONG	Target FilePathLen
WCHAR[261]	TargetProcessFilePath	目标进程路径
 ACCESS_MASK GrantedAccess

Index=16	528	ImageName	 __ClientLoadLibrary发起进程白名单
	+00	LIST_ENTRY List
	+08	FileName [260]		模块文件名

wuauclt.exe
MiniThunderPlatform.exe
RtxLite.exe
DriveTheLife.exe
115chrome.exe
adownloader.exe
2345Explorer.exe
MyIE9.exe
krbrowser.exe
Ruiying.exe
csbrowser.exe
114Web.exe
114IE.exe
WebGamegt.exe
Coral.exe
TangoWeb.exe
tango3.exe
TaoBrowser.exe
YY.exe
Android PC Suite.exe
wandoujia2.exe
DriverGenius.exe
DTLSoftManage.exe
sdDown.exe
VDisk.exe
klive.exe
Kanbox.exe
sedown.exe
Alibrowser.exe
BaiduHi.exe
LiveUpdate360.exe
flashgetmini.exe
flashget3.exe
idman.exe
Explorer.exe
QQBrowserExtHost.exe
QBDownloader.exe
FoxMail.exe
ieuser.exe
TTraveler.exe
rtx.exe
tm.exe
fetion.exe
msnmsgr.exe
outlook.exe
UDownSrv.exe
UDown.exe
WebThunder.exe
MiniThunder.exe
Thunder5.exe
ThunderMini.exe
DUTool.exe
RaySource.exe
peer.exe
Thunder.exe
ThunderService.exe
thunderplatform.exe
minimule.exe
emule.exe
QQDownload.exe
baidubrowser.exe
liebao.exe
QQBrowser.exe
360chrome.exe
360se.exe
webkit2webprocess.exe
safari.exe
huaer.exe
saayaa.exe
twchrome.exe
firefox.exe
thooe.exe
theworld.exe
myiq.exe
greenbrowser.exe
ybrowser.exe
115br.exe
opera.exe
chrome.exe
maxthon.exe
sogouexplorer.exe
</code></pre><h4 id="上抛消息结构">上抛消息结构</h4>
<p>分析出来的上抛数据类型如下：</p>
<pre tabindex="0"><code>Type			Id
ProcessId		0		进程Id
ChildProcessId	1		子进程Id
SrcFilePath		4		源文件路径
ChildFilePath	5		子进程路径
RegPathName	6		注册表路径
RegKeyName	7		注册表键
RegData		8		注册表数据
ObjFilePath	9		目标文件路径
RuleId		10		规则id
ChName		11		中文描述
EnName		12		英文描述
??			13
ProcessData	14
ChildData		15
ProcessIndex	17		进程序号
RegKeyType	18		注册表数据类型
RegDataSize	19		注册表数据大小
</code></pre><p>  过滤函数中，根据条件进行筛选以后，遇到符合条件的消息，先根据特征获取消息序号，然后在GroupAccessList中查找进程对应该消息号的权限，之后根据捕获类型构造消息结构，SerialData函数将必要的数据按上述类型序列化到缓冲区，之后将消息添加进消息队列中，并设置写信号，等待主防进程读取，上抛过程可以是同步或者异步方式。</p>
<pre tabindex="0"><code>SENDMSG		sizeof=0x1000
+000		ULONG Size//0x1000
+004		SENDMSG* self
+008		struct	REPLYMSG*	sizeof=0x1000
		+000		
		+004		SENDMSG* notifymsg;
		+00C		UCHAR[6] MsgTypeString;//”REPLY”
		+018		PKEVENT Event
		+01C		HANDLE ThreadId
+00C		UCHAR[7]	MsgTypeString;//”NOTIFY”
+01C		ULONG nIndex//事件类型标识
+020		ULONG pIndex//事件类型标识
+024		PKEVENT Event
+028		HANDLE ThreadId//待检测线程id
+02C		ULONG 请求结果类型//=0 不请求
+030		BOOL 主防是否需要给出结果
+034		ULONG MsgSize//串行化后总长度
+038		PBYTE data[0xFC8] 串行化数据  格式“类型-大小-数据[]”
</code></pre><h4 id="其他">其他</h4>
<p>读取ini文件</p>
<ul>
<li>标记为和应用层api的名字相同(GetPrivateProfile*)的函数，函数调用类型基本相同</li>
<li>GetPrivateProfileInt, 从Ini文件中获取整型值</li>
<li>GetPrivateProfileIntEncrypt从Ini文件中解密并获取整型值</li>
<li>GetPrivateProfileString从Ini文件中获取字符串</li>
<li>GetPrivateProfileStringEncrypt 从Ini文件中解密并获取字符串</li>
</ul>
<p>主防QMHIPSService通信日志</p>
<ul>
<li>可以打印出QMHIPSService与Tsksp.sys进行DeviceIoControl通信日志</li>
<li>在<code>HKEY_LOCAL_MACHINE\Software\Tencent\QQPCMgr</code>下新建EnableLogToView的Dword键，设置为0xFFFFFFFF，即可打开Magic debuge，xp下主防的日志在<code>\Documents and Settings\All Users\Application Data\Tencent\QQPCMgr\TrojanLog\qqpcrtp_qmhipsservice.log</code></li>
</ul>
<h4 id="对q管签名的破解">对Q管签名的破解</h4>
<p>  Q管签名验证，存在于除TsFltMgr之外的所有驱动中(boot start)，代码已经在TsSysKit分析文中给出，过程如下：</p>
<ol>
<li>读取PE，以IMAGE_DOS_HEADER-&gt;e_res2[0-1]
的DWORD值作为文件偏移，取该处128字节，通常在文件尾</li>
<li>用这128字节密文解密出24字节信息：</li>
</ol>
<pre tabindex="0"><code>+00 被加密数据的文件偏移，通常是代码段起始
+04 被加密数据的信息长度，通常到加密前的文件结束位置
+08 BYTE\[16\] 文件内容经过MD5变种算法加密出的16字节密钥
</code></pre><ol start="3">
<li>对被加密数据重新MD5校验，将结果和16字节密钥对比</li>
</ol>
<p>  由于算法可逆性未知，128字节密文不易从自己构造的24字节原始信息恢复，因此我的破解方法是取最小的具有Ts签名的文件尾项数据，插在PE开头，原先PE段相应移位，这样便可以通过Ts签名校验。代码为SignAsTsFile.cpp<br>
  影响到PROCINFO的IsSignMatch成员，该标志为Ts文件签名通过标志，由DriverSwitch开关控制，访问权限没有&quot;Q管目录文件&quot;级别高，影响到的函数有：</p>
<ul>
<li>NtDuplicateObject 放行执行者</li>
<li>虚拟内存操作 保护目标</li>
<li>允许输入法注入</li>
<li>NtCreateThreadEx放行执行者</li>
<li>NtSuspendThread放行执行者</li>
<li>NtGetNextThread放行执行者</li>
<li>NtTerminateProcess 放行执行者</li>
<li>NtTerminateThread 放行执行者</li>
<li>NtQueueApcThread放行执行者</li>
<li>NtQueueApcThreadEx放行执行者</li>
<li>NtUserSetWinEventHook放行执行者</li>
<li>NtUserSetWinEventHookEx放行执行者 保护目标</li>
<li>SetSystemInformation 放行执行者</li>
<li>NtSetContextThread放行执行者</li>
<li>NRestoreKey放行执行者</li>
<li>NtSetValueKey 放行执行者</li>
<li>NtCreateThread保护目标</li>
<li>NtUnmapViewOfSection放行执行者</li>
<li>NtCreateSymbolicLinkObject放行执行者</li>
<li>OpenObject放行执行者</li>
<li>NtSetSecurityObject放行执行者</li>
<li>NtAlpcCreatePort 放行执行者</li>
<li>NtCreatePort 放行执行者</li>
<li>NtAssignProcessToJobObject放行执行者</li>
<li>NtLoadDriver放行执行者</li>
</ul>
<h3 id="接口和控制码">接口和控制码</h3>
<h4 id="导出接口">导出接口</h4>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ULONG_PTR <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">Interface</span>(<span style="color:#5f5fff">int</span> Index)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">Swtich</span>(index)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Case <span style="color:#008900">1</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> GetProcInfoById;// 函数指针，用于通过进程Id拷贝PROCINFO结构，如前所述
</span></span><span style="display:flex;"><span>		Case <span style="color:#008900">2</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#ec0000">&amp;</span>EnableUpThrow;//用于控制是否将驱动事件上抛给主防消息并按规则处理，影响大部分过滤函数
</span></span><span style="display:flex;"><span>		Case <span style="color:#008900">3</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> <span style="color:#ec0000">&amp;</span>SelfProtectSwitch;//自保开关，影响的过滤函数见“自保开关影响的函数和功能”一节
</span></span><span style="display:flex;"><span>		Case <span style="color:#008900">4</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#ec0000">&amp;</span>MonitorSwitch;
</span></span><span style="display:flex;"><span>	/*
</span></span><span style="display:flex;"><span>	ULONG[0]:进程,线程,钩子操作开关，影响的过滤函数有：NtTerminateProcess, NtCreateThread, NtTerminateThread, NtSetContextThread, NtCreateThreadEx, NtQueueApcThread, NtQueueApcThreadEx, NtUserSetWinEventHook, NtUserSetWindowsHookEx
</span></span><span style="display:flex;"><span>	ULONG[1]: 注册表操作开关，影响的过滤函数有：NtRestoreKey, NtSetValueKey, NtCreateKey, NtDeleteKey, NtDeleteValueKey, NtLoadDriver, NtSystemDebugControl, NtSetSystemInformation
</span></span><span style="display:flex;"><span>	ULONG[2]: 文件,设备操作，影响的过滤函数有：NtSetInformationFile, NtCreateSymbolinkObject, NtDeviceIoControlFile
</span></span><span style="display:flex;"><span>	*/
</span></span><span style="display:flex;"><span>		Case <span style="color:#008900">5</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#ec0000">&amp;</span>SetFileSwitch;//文件操作开关，若关闭则用Tsksp内置规则，否则交给文件过滤驱动分析逻辑
</span></span><span style="display:flex;"><span>		Case <span style="color:#008900">6</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> GetProcDir;//函数指针，用于通过进程Id获取ProcDir属性，如前所述
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">Default</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="控制码">控制码</h4>
<pre tabindex="0"><code>0x22E004		挂钩KeUserModeCallBack并返回结果
	Buffer=		sizeof=4
	+00	BOOL ret

0x22E008		未实现

0x22E010		增加结束进程名黑名单元素 g_StorageList[0]
	Buffer=		sizeof=0x208
	+00	WCHAR ProcessName[260]

0x22E014		删除结束进程名黑名单元素 g_StorageList[0]
	Buffer=		sizeof=0x208
	+00	WCHAR ProcessName[260]

0x22E01C		设置进程线程钩子操作开关MonitorSwitch		如前所述
	Buffer=		sizeof=0xC
	+00	ULONG Data[3]

0x22E020		未知

0x22E028		添加结束进程ID黑名单元素
	Buffer=		sizeof=4
	+00	HANDLE ProcessId

0x22E02C		删除结束进程ID黑名单元素
	Buffer=		sizeof=4
	+00	HANDLE ProcessId

0x22E030		添加g_StorageList[2]元素

0x22E034		删除g_StorageList[2]元素

0x22E038		增加允许自注入名单g_StorageList[5]		CTSKspWrap::AddSelfProcInjectAllow
	Buffer=		sizeof=0x208
	+00	WCHAR ImagePath[260]

0x22E03C		删除ClientLoadLibrary加载模块白名单元素	
	Buffer=		sizeof=0x208
	+00	WCHAR  FilePath[260]	

0x22E040		挂钩KeUserModeCallback

0x22E044		添加g_StorageList[4]元素

0x22E048		删除g_StorageList[4]元素

0x22E04C 	添加g_StorageList[6]元素

0x22E064		DriverEntry中若KeUserModeCallback挂钩失败，则IRP_MJ_ DEVICE_CONTROL派遣例程只接受该控制码，用于获取挂钩信息
	Buffer=		sizeof=4
	+00	ULONG //0挂钩成功		2挂钩失败

0x22E050		删除g_StorageList[6]元素

0x22E054		添加g_StorageList[7]元素

0x22E058		删除g_StorageList[7]元素

0x22E05C		重置关闭自保状态
	Buffer=		sizeof=4
	+00	ULONG  1重置  2关闭	

0x22E060		设置检测发送消息开关SendInputSwitch	CTSKspWrap::SetSendInputSwitch
	Buffer=		sizeof=4
	+00	ULONG =&gt; SendInputSwitch		
	该标志位影响的过滤函数有：NtUserSendInput, NtUserMessageCall, NtUserPostmessage, NtUserPostThreadMessage

0x22E064
	Buffer=		sizeof=4
	+00	ULONG status;//	KeUserModeCallback挂钩结果

0x22E06C		添加g_StorageList[12]元素

0x22E070		设置自保开关SelfProtectSwitch	CTSKspWrap::SetSelfProtectState
	Buffer=		sizeof=4
	+00	ULONG =&gt; SelfProtectSwitch	

0x22E074		传入%SystemRoot%\system32\advapi32.dll		CreateServiceA地址		CTSKspWrap::AddApiAddress
	Buffer=		sizeof=4
	+00	ULONG	Addr

0x22E078		传入%SystemRoot%\system32\advapi32.dll		CreateServiceW地址		CTSKspWrap::AddApiAddress
	Buffer=		sizeof=4
	+00	ULONG	Addr

0x22E07C		传入%SystemRoot%\system32\rpcrt4.dll		NdrClientCall2地址		CTSKspWrap::AddApiAddress
	Buffer=		sizeof=4
	+00	ULONG	Addr

0x22E080		增加自结束进程查询名单		CTSKspWrap::AddSelfProcTeminateQuery
	Buffer=		sizeof=0x208
	+00	WCHAR  FilePath[260]	

0x22E084		增加注册表监控项	CTSKspWrap::AddRegMonitor		
	Buffer=		sizeof=0x418
+000h   WCHAR		RegPath[260]
+208h   WCHAR		KeyName[260]         
+410h   HANDLE	ProcessHandle
+414h   DWORD	Access

0x22E08C		根据id设置PROCINFO的ProcDir域
	Buffer=		sizeof=8
	+0	HANDLE ProcessId
	+4	ULONG ProcDir

0x22E090			CTSKspWrap::AddFileGroup
	Buffer=		sizeof=0x212
	+00	ULONG Access
	+08	WCHAR [260]	匹配路径

0x22E094				CTSKspWrap::AddProcPrivilege
	
0x22E09C		初始化驱动同步		CTSKspWrap::InitDriverSync
	Buffer=		sizeof=4
	+00	ULONG =&gt;  InitDriverSync

0x22E0A0		获取自保开关状态			CTSKspWrap::GetSelfProtectState
	Buffer=		sizeof=4
	+00	ULONG Data &lt;= SelfProtectSwitch

0x22E0C4		和驱动建立连接的过程中，发给驱动的用于通知主防驱动已经写完消息等待读取的同步信号
	Buffer=		sizeof=4
	+00	PKSEMAPHORE	MsgWriteLock

0x22E0C8		主防向驱动索取消息结构		CTSKspWrap::DriverGetMessage
	Buffer=		sizeof=0x1000

0x22E0CC		驱动返回消息	CTSKspWrap::DriverReplyMessage

0x22E0D0		通知驱动主防进程退出，做清理工作		CTSKspWrap::CloseDriverEvent
	
0x22E0D8		   穿透创建服务加载驱动
    buffer=     sizeof=0x91C
    +000    WCHAR ImagePath[260] 驱动文件路径
    +208    DWORD Type  驱动注册表Type项
    +20C    DWORD Start 驱动注册表项Start类型
    +210    DWORD flag  (决定是否设置注册表Tag和Group信息)
    +214    ？？？
    +468    DWORD Tag 驱动注册表Tag项
    +46C    WCHAR DisplayName[300] 驱动注册表项DisplayName
    +6C4    WCHAR ServiceName[300] 驱动服务名

0x22E0DC		下发要监控的线程Id给驱动，存储于ThreadIdSlot，该结构在创建/打开文件操作中生效
	Buffer=		sizeof=4
	+00	HANDLE ThreadId	

0x22E0E0		取消要监控的线程Id，修改ThreadIdSlot
	Buffer=		sizeof=4
	+00	HANDLE ThreadId

0x22E0E4 	重置全局访问控制表ACL =&gt;AclTable  三维数组，详述见全局访问控制表章节
	Buffer=		sizeof=0x10
	+00	ULONG dimen1//第一维大小
	+04	ULONG dimen2//第二维大小
	+08	ULONG dimen3//第三维大小
	+0C	PBYTE data//数据基址

0x22E0E8		添加__ClientLoadLibrary发起进程黑名单元素 g_StorageList[13]		CTSKspWrap::SetIoControl
	Buffer=		sizeof=0x208
+00	FileName [260]		模块文件名

0x22E0EC		删除__ClientLoadLibrary发起进程黑名单元素 g_StorageList[13]
	Buffer=		sizeof=0x208
+00	FileName [260]		模块文件名

0x22E0F0		设置要监控的模块路径		CTSKspWrap::SetIoControl
	Buffer=		sizeof=0x208
+00	DllPath [260]		模块文件名

0x22E100		设置进程信息
	Buffer=		sizeof=0xC
	+00	HANDLE ProcessId	in
	+04	ULONG ProcDir		out
	+08	ULONG 			out

0x22E104		是否开启验证父进程和子进程创建时间逻辑
	Buffer=		sizeof=4
	+00	BOOLEAN VerifyTime//0不开启 	1开启

0x22E108		添加__ClientLoadLibrary发起进程白名单项g_StorageList[16]		CTSKspWrap::SetIoControl
	Buffer=		sizeof=0x208
+00	FileName [260]		模块文件名

0x22E10C		开启__ClientLoadLibrary发起进程白名单项g_StorageList[16]的验证

0x22E110		删除__ClientLoadLibrary发起进程白名单项g_StorageList[16]		CTSKspWrap::SetIoControl
	Buffer=		sizeof=0x208
+00	FileName [260]		模块文件名

0x22E114		关闭__ClientLoadLibrary发起进程白名单项g_StorageList[16]的验证

0x22E400		增加监控条目		信息添加到数组，做第一次规则匹配		CTSKspWrap::AddMonitorItem
	Buffer=		sizeof&gt;0x10
	+00	USHORT  cbSize
	+02	USHORT	0/1
	+04	USHORT	2	
	+06	USHORT	GroupInfoSize//组信息结构大小
	+08	USHORT	Type	//组类型 	0进程线程	1文件	2??		3其他
	+10	UBYTE[]	组信息

0x22E404	增加”规则组进程访问权限”信息	信息添加到二级链表，做第二次规则匹配
	Buffer=		sizeof&gt;0x10
	+00	USHORT  cbSize
	+02	USHORT	0/1
	+04	USHORT	2	
	+06	USHORT	GroupInfoSize//进程相关的权限信息结构大小
	+10	UBYTE[]	组信息

	内部存储结构：
	+00  LIST_ENTRY ListEntry
	+08  LIST_ENTRY ChildListEntry
		+00	LIST_ENTRY ListEntry
			+08 	ULONG	uMinRuleNum
			+0C	ULONG	uMaxruleNum
			+10	ULONG	Access;//0放过   非0拦截
	+10  HANDLE ProcessId
	
	保存在内存中的结构为RuleGroupInfo[4]  每个结构由成员个数(=n)和基地址2个ULONG组成，每个基地址存放着n个下列子结构：
00	ULONG ruleid          
04	ULONG mid            
08	ULONG subid          
0C	ULONG val4           
10	WCHAR* matchfirst      
14	WCHAR* matchsecond  
	详细情况后面有详述

0x22E410		设置全局开关DriverSwitch		DriverSwitch见全局开关章节		CTSKspWrap::SetDriverSwitch
	Buffer=		sizeof=4
	+00	ULONG mask
	
0x22E414		监视操作窗口标题，将新标题字符串加入监视列表白名单
Buffer=		sizeof&gt;0
+00	WCHAR[??]	窗口标题
	
0x22E418		获取在NtRequestWaitReplyPort和NtAlpcSendWaitReceivePort通信中使用IWbemInterface通信的进程
	Bufer=		sizeof=8
	+00	HANDLE ProcessId
	+04	0

0x22E41C		增加打开对象目标黑名单项g_StorageList[14]，见“黑白名单”一节		CTSKspWrap::AddSyncObjProtect
	Buffer=		sizeof=0x208
	+00	WCHAR ObjectPath[260]

0x22E420		增加打开进程/复制句柄发起进程白名单项	g_StorageList[15] ，见“黑白名单”一节		CTSKspWrap::AddSelfProcAllow
	Buffer=		sizeof=0x430
	+000	LIST_ENTRY	List
	+008	ULONG	Enable??
	+00C	ULONG	SourceFilePathLen			
	+010	WCHAR	SourceProcessFilePath[261]
	+21C	ULONG	TargetFilePathLen
	+220	WCHAR	TargetProcessFilePat[261]
	+42C	ACCESS_MASK	GrantedAccess

0x22E420		由进程Id获取进程加载序号，PROCESSINFO的Index域
	Buffer=		sizeof=8
	+0	HANDLE ProcessId  &lt;=&gt;	ULONG Index

0x22E424		由进程Id获取进程文件全路径
	Buffer=		sizeof= in 4 	out 0x104
	+0	HANDLE ProcessId	&lt;=&gt;	
</code></pre><h3 id="基础库">基础库</h3>
<p>由进程Id获取文件对象</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">GetSectionObjectOffset</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	UCHAR Inst1[]<span style="color:#ec0000">=</span>{<span style="color:#008900">0x8B</span>, <span style="color:#008900">0xFF</span>, <span style="color:#008900">0x55</span>, <span style="color:#008900">0x8B</span>, <span style="color:#008900">0xEC</span>, <span style="color:#008900">0x8B</span>, <span style="color:#008900">0x45</span>, <span style="color:#008900">0x08</span>, <span style="color:#008900">0x8B</span>, <span style="color:#008900">0x80</span>};
</span></span><span style="display:flex;"><span>	UCHAR Inst2[]<span style="color:#ec0000">=</span>{<span style="color:#008900">0x8B</span>, <span style="color:#008900">0x44</span>, <span style="color:#008900">0x24</span>, <span style="color:#008900">0x04</span>, <span style="color:#008900">0x8B</span>, <span style="color:#008900">0x80</span>};
</span></span><span style="display:flex;"><span>	BOOLEAN result <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	ULONG_PTR SectionBaseOffset <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	PsGetProcessSectionBaseAddress <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MmGetSystemRoutineAddress</span>(<span style="color:#ec0000">&amp;</span>uName);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(PsGetProcessSectionBaseAddress <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(PsGetProcessSectionBaseAddress))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">MmIsAddressValid</span>((PVOID)((<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)PsGetProcessSectionBaseAddress <span style="color:#ec0000">+</span> <span style="color:#008900">14</span>)) <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">RtlCompareMemory</span>((PVOID)Inst1, PsGetProcessSectionBaseAddress, <span style="color:#ec0000">sizeof</span>(Inst1)) <span style="color:#ec0000">==</span> <span style="color:#ec0000">sizeof</span>(Inst1))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			/*
</span></span><span style="display:flex;"><span>				nt!PsGetProcessSectionBaseAddress:
</span></span><span style="display:flex;"><span>				805287da 8bff            mov     edi,edi
</span></span><span style="display:flex;"><span>				805287dc 55              push    ebp
</span></span><span style="display:flex;"><span>				805287dd 8bec            mov     ebp,esp
</span></span><span style="display:flex;"><span>				805287df 8b4508          mov     eax,dword ptr [ebp+8]
</span></span><span style="display:flex;"><span>				805287e2 8b803c010000    mov     eax,dword ptr [eax+13Ch]
</span></span><span style="display:flex;"><span>				805287e8 5d              pop     ebp
</span></span><span style="display:flex;"><span>			*/
</span></span><span style="display:flex;"><span>			SectionBaseOffset <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)((<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)PsGetProcessSectionBaseAddress <span style="color:#ec0000">+</span> <span style="color:#008900">10</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(<span style="color:#5f5fff">MmIsAddressValid</span>((PVOID)((<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)PsGetProcessSectionBaseAddress <span style="color:#ec0000">+</span> <span style="color:#008900">10</span>)) <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">RtlCompareMemory</span>((PVOID)Inst2, PsGetProcessSectionBaseAddress, <span style="color:#ec0000">sizeof</span>(Inst2)) <span style="color:#ec0000">==</span> <span style="color:#ec0000">sizeof</span>(Inst2))
</span></span><span style="display:flex;"><span>			//and BuildNumber==2600
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			SectionObjectOffset <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)((<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)PsGetProcessSectionBaseAddress <span style="color:#ec0000">+</span> <span style="color:#008900">6</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(SectionBaseOffset <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">276</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			SectionObjectOffset <span style="color:#ec0000">=</span> SectionBaseOffset <span style="color:#ec0000">-</span> <span style="color:#008900">4</span>;
</span></span><span style="display:flex;"><span>			result <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">GetFileObjectByProcessId</span>(HANDLE ProcessId, PFILE_OBJECT<span style="color:#ec0000">*</span> pFileObject)
</span></span><span style="display:flex;"><span>{//法一 借助PEPROCESS结构
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	PEPROCESS Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>pFileObject)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">PsLookupProcessByProcessId</span>(ProcessId,<span style="color:#ec0000">&amp;</span>Process)))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(MajorVersion <span style="color:#ec0000">==</span> <span style="color:#008900">1</span> <span style="color:#ec0000">||</span> MajorVersion <span style="color:#ec0000">==</span> <span style="color:#008900">2</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			PSECTION Section <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(PSECTION<span style="color:#ec0000">*</span>)((<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)Process <span style="color:#ec0000">+</span> SectionObjectOffset);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(Section <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(Section) <span style="color:#ec0000">&amp;&amp;</span> Section<span style="color:#ec0000">-&gt;</span>Segment <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(Section<span style="color:#ec0000">-&gt;</span>Segment) <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>				Section<span style="color:#ec0000">-&gt;</span>Segment<span style="color:#ec0000">-&gt;</span>ControlArea <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(Section<span style="color:#ec0000">-&gt;</span>Segment<span style="color:#ec0000">-&gt;</span>ControlArea))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">*</span>pFileObject <span style="color:#ec0000">=</span> Section<span style="color:#ec0000">-&gt;</span>Segment<span style="color:#ec0000">-&gt;</span>ControlArea<span style="color:#ec0000">-&gt;</span>FilePointer;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(<span style="color:#ec0000">*</span>pFileObject)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">ObReferenceObject</span>(<span style="color:#ec0000">*</span>pFileObject);
</span></span><span style="display:flex;"><span>					status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(MajorVersion <span style="color:#ec0000">==</span> <span style="color:#008900">5</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>PsReferenceProcessFilePointer)
</span></span><span style="display:flex;"><span>				PsReferenceProcessFilePointer <span style="color:#ec0000">=</span> (ULONG)<span style="color:#5f5fff">MmGetSystemRoutineAddress</span>(<span style="color:#ec0000">&amp;</span>uName);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(PsReferenceProcessFilePointer)
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> ((<span style="color:#5f5fff">NTSTATUS</span> (<span style="color:#ec0000">__stdcall</span><span style="color:#ec0000">*</span>)(PEPROCESS,PFILE_OBJECT<span style="color:#ec0000">*</span>))PsReferenceProcessFilePointer)(Process,pFileObject);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Process)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(Process);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">GetPebBaseByProcessObject</span>(PEPROCESS Process, PVOID <span style="color:#ec0000">*</span>PebBaseAddr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	HANDLE ProcessHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PROCESS_BASIC_INFORMATION ProcessInformation;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">ObOpenObjectByPointer</span>(Process, OBJ_KERNEL_HANDLE, <span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, KernelMode, <span style="color:#ec0000">&amp;</span>ProcessHandle)) <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwQueryInformationProcess</span>(ProcessHandle, ProcessBasicInformation, <span style="color:#ec0000">&amp;</span>ProcessInformation, <span style="color:#ec0000">sizeof</span>(ProcessInformation), <span style="color:#ec0000">NULL</span>) <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		ProcessInformation.PebBaseAddress)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>PebBaseAddr <span style="color:#ec0000">=</span> ProcessInformation.PebBaseAddress;
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ProcessHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(ProcessHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PFILE_OBJECT <span style="color:#5f5fff">GetFileObjectByProcessId</span>(HANDLE ProcessId)
</span></span><span style="display:flex;"><span>{//法二 借助PEB命令行
</span></span><span style="display:flex;"><span>	PEPROCESS Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PPEB PebBaseAddr <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	BOOLEAN Attached <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	HANDLE FileHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PVOID Buffer <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT FileObject <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	UNICODE_STRING ImagePathName;
</span></span><span style="display:flex;"><span>	UNICODE_STRING FullPath;
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>	UNICODE_STRING Prefix <span style="color:#ec0000">=</span> <span style="color:#5f5fff">RTL_CONST_STRING</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;\??</span><span style="color:#008900">\&#34;</span><span style="color:#008900">);</span>
</span></span><span style="display:flex;"><span>	IO_STATUS_BLOCK IoStatus;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">KeGetCurrentIrql</span>() <span style="color:#ec0000">==</span> PASSIVE_LEVEL <span style="color:#ec0000">&amp;&amp;</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">PsLookupProcessByProcessId</span>(ProcessId, <span style="color:#ec0000">&amp;</span>Process)) <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">GetPebBaseByProcessObject</span>(Process, (PVOID<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>PebBaseAddr)))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeAttachProcess</span>(Process);
</span></span><span style="display:flex;"><span>		Attached <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">__try</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ProbeForRead</span>(PebBaseAddr,<span style="color:#008900">0x1D8</span>,<span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ProbeForRead</span>(PebBaseAddr<span style="color:#ec0000">-&gt;</span>ProcessParameters,<span style="color:#008900">0x90</span>,<span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>			ImagePathName <span style="color:#ec0000">=</span> PebBaseAddr<span style="color:#ec0000">-&gt;</span>ProcessParameters<span style="color:#ec0000">-&gt;</span>ImagePathName;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(ImagePathName.Length <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> ImagePathName.Length <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0xFFF8</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>((<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)ImagePathName.Buffer <span style="color:#ec0000">&lt;</span> (<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)PebBaseAddr<span style="color:#ec0000">-&gt;</span>ProcessParameters)// 如果该成员是偏移而不是指针
</span></span><span style="display:flex;"><span>					ImagePathName.Buffer <span style="color:#ec0000">=</span> (PWSTR)((ULONG)ImagePathName.Buffer <span style="color:#ec0000">+</span> PebBaseAddr<span style="color:#ec0000">-&gt;</span>ProcessParameters);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ProbeForRead</span>(ImagePathName.Buffer,ImagePathName.Length,<span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>				ULONG FullLen <span style="color:#ec0000">=</span> ImagePathName.Length;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">RtlPrefixUnicodeString</span>(<span style="color:#ec0000">&amp;</span>Prefix, <span style="color:#ec0000">&amp;</span>ImagePathName, TRUE))
</span></span><span style="display:flex;"><span>					FullLen <span style="color:#ec0000">+=</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>				Buffer <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool, FullLen);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(Buffer)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">RtlZeroMemory</span>(Buffer,FullLen);
</span></span><span style="display:flex;"><span>					FullPath.Buffer <span style="color:#ec0000">=</span> (PWCH)Buffer;
</span></span><span style="display:flex;"><span>					FullPath.MaximumLength <span style="color:#ec0000">=</span> FullLen;
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(FullLen <span style="color:#ec0000">!=</span> ImagePathName.Length)
</span></span><span style="display:flex;"><span>						<span style="color:#5f5fff">RtlAppendUnicodeStringToString</span>(<span style="color:#ec0000">&amp;</span>FullPath,<span style="color:#ec0000">&amp;</span>Prefix);
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">RtlAppendUnicodeStringToString</span>(<span style="color:#ec0000">&amp;</span>FullPath,<span style="color:#ec0000">&amp;</span>ImagePathName);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">__except</span>(<span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Attached <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#ec0000">&amp;</span>FullPath,OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">ZwOpenFile</span>(<span style="color:#ec0000">&amp;</span>FileHandle, SYNCHRONIZE <span style="color:#ec0000">|</span> FILE_READ_ATTRIBUTES, <span style="color:#ec0000">&amp;</span>Oa, <span style="color:#ec0000">&amp;</span>Ios,
</span></span><span style="display:flex;"><span>			FILE_SHARE_READ <span style="color:#ec0000">|</span> FILE_SHARE_WRITE <span style="color:#ec0000">|</span> FILE_SHARE_DELETE, FILE_SYNCHRONOUS_IO_NONALERT <span style="color:#ec0000">|</span> FILE_NON_DIRECTORY_FILE)))
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ObReferenceObjectByHandle</span>(FileHandle, <span style="color:#008900">0</span>, <span style="color:#ec0000">*</span>IoFileObjectType, KernelMode, (PVOID<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>FileObject, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Attached)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeDetachProcess</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(FileHandle)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(FileHandle);
</span></span><span style="display:flex;"><span>		FileHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Process)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(Process);
</span></span><span style="display:flex;"><span>		Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Buffer)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> FileObject;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>由线程句柄获取进程对象</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>PEPROCESS <span style="color:#5f5fff">GetProcessObjectFromThreadHandle</span>(HANDLE ThreadHandle)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PETHREAD Thread <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PEPROCESS Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ThreadHandle)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">ObReferenceObjectByHandle</span>(ThreadHandle, <span style="color:#008900">0</span>, <span style="color:#ec0000">*</span>PsThreadType, 
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">IsKernelHandle</span>(ThreadHandle)<span style="color:#ec0000">?</span><span style="color:#ec0000">KernelMode</span>:UserMode, (PVOID<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>Thread, <span style="color:#ec0000">NULL</span>)))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Process <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoThreadToProcess</span>(Thread);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ObDereferenceObject</span>(Thread);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> Process;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>由线程对象获取进程Id</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">GetProcIdFromProcessObject</span>(PEPROCESS Process,PHANDLE pProcessId)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	HANDLE ProcessHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PROCESS_BASIC_INFORMATION ProcessInformation;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">ObOpenObjectByPointer</span>(Process, OBJ_KERNEL_HANDLE, <span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, KernelMode, <span style="color:#ec0000">&amp;</span>ProcessHandle)) <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwQueryInformationProcess</span>(ProcessHandle, ProcessBasicInformation, <span style="color:#ec0000">&amp;</span>ProcessInformation, <span style="color:#ec0000">sizeof</span>(ProcessInformation), <span style="color:#ec0000">NULL</span>))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>pProcessId <span style="color:#ec0000">=</span> ProcessInformation.UniqueProcessId;
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ProcessHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(ProcessHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">GetThreadProcessId</span>(PETHREAD Thread,PHANDLE pProcessId)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	PVOID PsGetThreadProcessId <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG OffsetEprocessToThreadObject <span style="color:#ec0000">=</span> <span style="color:#008900">0x22C</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">MmIsAddressValid</span>(Thread))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		PsGetThreadProcessId <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MmGetSystemRoutineAddress</span>(<span style="color:#ec0000">&amp;</span>uName);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(PsGetThreadProcessId)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">*</span>pProcessId <span style="color:#ec0000">=</span> ((<span style="color:#5f5fff">HANDLE</span> (<span style="color:#ec0000">__stdcall</span><span style="color:#ec0000">*</span>)(PETHREAD))PsGetThreadProcessId)(Thread);
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			ULONG Addr <span style="color:#ec0000">=</span> (ULONG)Thread <span style="color:#ec0000">+</span> OffsetEprocessToThreadObject;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(Addr <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>((PVOID)Addr))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				PEPROCESS Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(PEPROCESS<span style="color:#ec0000">*</span>)Addr;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(Process <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(Process))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">GetProcIdFromProcessObject</span>(Process, pProcessId)))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="44-由ntfs文件索引号获取文件对象">4.4 由Ntfs文件索引号获取文件对象</h4>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>PFILE_OBJECT <span style="color:#5f5fff">GetRealFileObject</span>(HANDLE ProcessId,PFILE_OBJECT FileObject)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	UNICODE_STRING uNtfs <span style="color:#ec0000">=</span> <span style="color:#5f5fff">RTL_CONSTANT_STRING</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Ntfs&#34;</span>);
</span></span><span style="display:flex;"><span>	PDRIVER_OBJECT NtfsDrvObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PDEVICE_OBJECT NtfsDevObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>,fsDevObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT NtfsFileObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>,ObjFileObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>,RealFileObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT Ntfs;
</span></span><span style="display:flex;"><span>	BOOLEAN Real<span style="color:#ec0000">=</span>FALSE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	//检查是否文件属于NTFS文件系统
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoGetDeviceObjectPointer</span>(<span style="color:#ec0000">&amp;</span>uNtfs,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>NtfsFileObj,<span style="color:#ec0000">&amp;</span>NtfsDevObj);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> NtfsFileObj <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(NtfsFileObj) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(NtfsFileObj<span style="color:#ec0000">-&gt;</span>DeviceObject))
</span></span><span style="display:flex;"><span>		NtfsDrvObj <span style="color:#ec0000">=</span> NtfsFileObj<span style="color:#ec0000">-&gt;</span>DeviceObject<span style="color:#ec0000">-&gt;</span>DriverObject;
</span></span><span style="display:flex;"><span>	fsDevObj <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoGetBaseFileSystemDeviceObject</span>(FileObject);//FileSystem\Ntfs
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(fsDevObj <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(fsDevObj) <span style="color:#ec0000">&amp;&amp;</span> fsDevObj<span style="color:#ec0000">-&gt;</span>DriverObject <span style="color:#ec0000">==</span> NtfsDevObj)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		FILE_STANDARD_INFORMATION StandardInfo;
</span></span><span style="display:flex;"><span>		ULONG RetLen;
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoQueryFileInformation</span>(FileObject,FileStandardInformation,<span style="color:#ec0000">sizeof</span>(StandardInfo),<span style="color:#ec0000">&amp;</span>StandardInfo,<span style="color:#ec0000">&amp;</span>RetLen);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(StandardInfo.NumberOfLinks <span style="color:#ec0000">&gt;</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				ObjFileObj <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetFileObjectByProcessId</span>(ProcessId);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(ObjFileObj <span style="color:#ec0000">&amp;&amp;</span> ObjFileObj<span style="color:#ec0000">-&gt;</span>FsContext <span style="color:#ec0000">!=</span> FileObj<span style="color:#ec0000">-&gt;</span>FsContext)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					//2种方式的FsContext不同，说明可能被拦截，下面采用Ntfs文件号获取
</span></span><span style="display:flex;"><span>					Real <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">ObDereferenceObject</span>(ObjFileObj);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Real)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		//获取该文件Ntfs文件号
</span></span><span style="display:flex;"><span>		FILE_INTERNAL_INFORMATION InternalInfo;
</span></span><span style="display:flex;"><span>		ULONG RetLen;
</span></span><span style="display:flex;"><span>		PVOID Buf <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(PagedPool,<span style="color:#008900">1024</span>);
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoQueryFileInformation</span>(FileObj,FileInternalInformation,<span style="color:#ec0000">sizeof</span>(InternalInfo),<span style="color:#ec0000">&amp;</span>InternalInfo,<span style="color:#ec0000">&amp;</span>RetLen);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> Buf)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			//获取父目录信息
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">RtlZeroMemory</span>(Buf,<span style="color:#008900">1024</span>);
</span></span><span style="display:flex;"><span>			POBJECT_NAME_INFORMATION DeviceName <span style="color:#ec0000">=</span> (POBJECT_NAME_INFORMATION)Buf;
</span></span><span style="display:flex;"><span>			OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>			IO_STATUS_BLOCK IoStatus;
</span></span><span style="display:flex;"><span>			HANDLE DeviceHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>			HANDLE FileHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObQueryNameString</span>(FileObj<span style="color:#ec0000">-&gt;</span>DeviceObject,Buf,<span style="color:#008900">1024</span>,RetLen);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> DeviceName<span style="color:#ec0000">-&gt;</span>Name.Buffer)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#ec0000">&amp;</span>DeviceName<span style="color:#ec0000">-&gt;</span>Name,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span> OBJ_KERNEL_HANDLE, <span style="color:#ec0000">NULL</span>, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwOpenFile</span>(<span style="color:#ec0000">&amp;</span>DeviceHandle , <span style="color:#008900">0</span>, <span style="color:#ec0000">&amp;</span>Oa, <span style="color:#ec0000">&amp;</span>IoStatus, <span style="color:#008900">0</span>, FILE_NON_DIRECTORY_FILE);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					UNICODE_STRING InnerFileName <span style="color:#ec0000">=</span> {<span style="color:#ec0000">sizeof</span>(InternalInfo), <span style="color:#ec0000">sizeof</span>(InternalInfo), <span style="color:#ec0000">&amp;</span>InternalInfo};
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa, <span style="color:#ec0000">&amp;</span>InnerFileName, OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span> OBJ_KERNEL_HANDLE, DeviceHandle, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>					status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwOpenFile</span>(FileHandle, SYNCHRONIZE <span style="color:#ec0000">|</span> FILE_READ_ATTRIBUTES, <span style="color:#ec0000">&amp;</span>Oa, <span style="color:#ec0000">&amp;</span>IoStatus, 
</span></span><span style="display:flex;"><span>						FILE_SHARE_READ <span style="color:#ec0000">|</span> FILE_SHARE_WRITE <span style="color:#ec0000">|</span> FILE_SHARE_DELETE, FILE_OPEN_BY_FILE_ID <span style="color:#ec0000">|</span> FILE_NON_DIRECTORY_FILE <span style="color:#ec0000">|</span> FILE_SYNCHRONOUS_IO_NONALERT);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						//用文件索引号打开文件成功
</span></span><span style="display:flex;"><span>						<span style="color:#5f5fff">ObReferenceObjectByHandle</span>(FileHandle, <span style="color:#008900">0</span>, <span style="color:#ec0000">*</span>IoFileObjectType, KernelMode, <span style="color:#ec0000">&amp;</span>RealFileObj);
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(FileHandle)
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ZwClose</span>(FileHandle);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(DeviceHandle)
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ZwClose</span>(DeviceHandle);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(Buf)
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ExFreePool</span>(Buf);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> RealFileObj;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>长度反汇编引擎，用于获取指令长度</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">DisasmLen</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> bytecode)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> decode1[<span style="color:#008900">256</span>][<span style="color:#008900">7</span>]<span style="color:#ec0000">=</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x00</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x01</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x03</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x04</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x05</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x06</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x07</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x08</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x09</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0a</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0c</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0d</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0e</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0f</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x10</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x11</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x12</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x13</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x14</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x15</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x16</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x17</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x18</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x19</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1a</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1b</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1c</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1d</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1e</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1f</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x20</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x21</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x22</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x23</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x24</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x25</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x26</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x27</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x28</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x29</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2d</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2e</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2f</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x30</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x31</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x32</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x33</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x34</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x35</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x36</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x37</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x38</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x39</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3a</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3b</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3c</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3d</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3e</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3f</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x40</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x41</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x42</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x43</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x44</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x45</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x46</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x47</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x48</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x49</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4d</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4e</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4f</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x50</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x51</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x52</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x53</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x54</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x55</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x56</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x57</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x58</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x59</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5d</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5e</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5f</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x60</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x61</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x62</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x63</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x64</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x65</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x66</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x67</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x68</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x69</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6d</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6e</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6f</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x70</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x71</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x72</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x73</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x74</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x75</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x76</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x77</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x78</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x79</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7a</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7b</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7c</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7d</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7e</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7f</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x80</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x81</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x82</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x83</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x84</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x85</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x86</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x87</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x88</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x89</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8a</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8b</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8c</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8d</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8e</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8f</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x90</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x91</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x92</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x93</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x94</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x95</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x96</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x97</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x98</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x99</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9d</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9e</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9f</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa0</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa1</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa3</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa5</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa6</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa7</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa8</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xaa</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xab</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xac</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xad</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xae</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xaf</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb0</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb1</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb2</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb3</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb4</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb5</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb6</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb7</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb8</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb9</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xba</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xbb</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xbc</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xbd</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xbe</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xbf</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc0</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc1</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc2</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc3</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc4</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc5</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc6</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc7</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc8</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc9</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xca</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xcb</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xcc</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xcd</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xce</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xcf</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd0</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd1</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd2</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd3</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd4</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd5</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd6</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd7</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd8</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd9</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xda</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xdb</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xdc</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xdd</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xde</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xdf</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe0</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe1</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe2</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe3</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe4</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe5</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe6</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe7</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe8</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe9</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xea</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xeb</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xec</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xed</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xee</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xef</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf0</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf1</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf2</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf3</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf4</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf5</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf6</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf7</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf8</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf9</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xfa</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xfb</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xfc</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xfd</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xfe</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xff</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> decode2[<span style="color:#008900">256</span>][<span style="color:#008900">7</span>]<span style="color:#ec0000">=</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x00</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x01</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x03</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x04</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x05</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x06</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x07</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x08</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x09</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0d</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0e</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x0f</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x10</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x11</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x12</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x13</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x14</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x15</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x16</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x17</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x18</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x19</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1d</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1e</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x1f</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x20</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x21</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x22</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x23</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x24</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x25</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x26</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x27</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x28</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x29</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2d</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2e</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x2f</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x30</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x31</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x32</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x33</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x34</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x35</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x36</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x37</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x38</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x39</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3d</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3e</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x3f</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x40</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x41</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x42</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x43</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x44</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x45</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x46</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x47</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x48</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x49</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4a</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4b</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4c</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4d</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4e</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x4f</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x50</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x51</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x52</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x53</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x54</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x55</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x56</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x57</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x58</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x59</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5a</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5b</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5c</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5d</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5e</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x5f</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x60</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x61</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x62</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x63</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x64</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x65</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x66</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x67</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x68</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x69</span>,<span style="color:#008900">0x06</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6b</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6c</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6d</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6e</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x6f</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x70</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x71</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x72</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x73</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x74</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x75</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x76</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x77</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x78</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x79</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7d</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7e</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x7f</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x80</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x81</span>,<span style="color:#008900">0x06</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x82</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x83</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x84</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x85</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x86</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x87</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x88</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x89</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8a</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8b</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8c</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8d</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8e</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x8f</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x90</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x91</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x92</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x93</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x94</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x95</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x96</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x97</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x98</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x99</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9a</span>,<span style="color:#008900">0x07</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9b</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9c</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9d</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9e</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0x9f</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa0</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x02</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa1</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x02</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x02</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa3</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x02</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa5</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa6</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa7</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa8</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xaa</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xab</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xac</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xad</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xae</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xaf</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb0</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb1</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb2</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb3</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb4</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb5</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb6</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb7</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb8</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x08</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xb9</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xba</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xbb</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xbc</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xbd</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xbe</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xbf</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc0</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc1</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc2</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc3</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc4</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc5</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc6</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc7</span>,<span style="color:#008900">0x06</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc8</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xc9</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xca</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xcb</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xcc</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xcd</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xce</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xcf</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd0</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd1</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd2</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd3</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd4</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd5</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd6</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd7</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd8</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xd9</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xda</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xdb</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xdc</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xdd</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xde</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xdf</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe0</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x04</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe1</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x04</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe2</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x04</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe3</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe4</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe5</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe6</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe7</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe8</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xe9</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xea</span>,<span style="color:#008900">0x07</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xeb</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xec</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xed</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xee</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xef</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf0</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf1</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf2</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf3</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf4</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf5</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf6</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf7</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf8</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xf9</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xfa</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xfb</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xfc</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xfd</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xfe</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0xff</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,},
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span> decode3[<span style="color:#008900">256</span>]<span style="color:#ec0000">=</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x11</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x11</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x11</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x11</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x11</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x11</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x11</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x11</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x02</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x01</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x04</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> ptr <span style="color:#ec0000">=</span> bytecode;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span> len <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>,var2 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>,var3 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>, decodel[<span style="color:#008900">7</span>]<span style="color:#ec0000">=</span>{<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">long</span><span style="color:#ec0000">*</span> pdecode <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">switch</span>(<span style="color:#ec0000">*</span>ptr)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0xF</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		ptr<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>		len <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>		pdecode <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>decode1[<span style="color:#ec0000">*</span>ptr][<span style="color:#008900">0</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0x26</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0x2E</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0x36</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0x3E</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0x64</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0x65</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		len <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>		ptr<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0x66</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		len <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>		var3 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>		ptr<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0x67</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		len <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>		var2 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>		ptr<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0xF0</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0xF2</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0xF3</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		len <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>		ptr<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0xF6</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		decodel[<span style="color:#008900">0</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">0xF6</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">*</span>(ptr<span style="color:#ec0000">+</span><span style="color:#008900">1</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x38</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">5</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">3</span>;
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">3</span>;
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">5</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		pdecode <span style="color:#ec0000">=</span> decodel;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#008900">0xF7</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		decodel[<span style="color:#008900">0</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">0xF6</span>;
</span></span><span style="display:flex;"><span>		decodel[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">*</span>(ptr<span style="color:#ec0000">+</span><span style="color:#008900">1</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x38</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">6</span>;
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">4</span>;
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">5</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">4</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>			decodel[<span style="color:#008900">5</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		pdecode <span style="color:#ec0000">=</span> decodel;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>pdecode)
</span></span><span style="display:flex;"><span>		pdecode <span style="color:#ec0000">=</span> decode2[<span style="color:#ec0000">*</span>ptr];
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(pdecode[<span style="color:#008900">6</span>] <span style="color:#ec0000">&amp;</span> <span style="color:#008900">2</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(var2 <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>			len <span style="color:#ec0000">+=</span> pdecode[<span style="color:#008900">1</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>			len <span style="color:#ec0000">+=</span> pdecode[<span style="color:#008900">2</span>];
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(var3 <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>			len <span style="color:#ec0000">+=</span> pdecode[<span style="color:#008900">1</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>			len <span style="color:#ec0000">+=</span> pdecode[<span style="color:#008900">2</span>];
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(pdecode[<span style="color:#008900">3</span>])
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span> var4 <span style="color:#ec0000">=</span> ptr[pdecode[<span style="color:#008900">3</span>]];
</span></span><span style="display:flex;"><span>		len <span style="color:#ec0000">+=</span> decode3[var4] <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0xF</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>((decode3[var4] <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x10</span>) <span style="color:#ec0000">&amp;&amp;</span> (ptr[pdecode[<span style="color:#008900">3</span>] <span style="color:#ec0000">+</span> <span style="color:#008900">1</span>] <span style="color:#ec0000">&amp;</span> <span style="color:#008900">7</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">5</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">switch</span>(var4 <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0xC0</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#008900">0x40</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>				len<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#008900">0x00</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#008900">0x80</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>				len <span style="color:#ec0000">+=</span> <span style="color:#008900">4</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> len;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="tsfltmgrsys分析">TsFltMgr.sys分析</h2>
<p>  该驱动为qq管家函数过滤驱动，提供SSDT、SSSDT、进程和线程回调等过滤操作，导出接口给TsKsp.sys使用，2者共同做函数过滤操作，TsFltMgr提供设置函数过滤的框架，而实际拦截过程在TsKsp中。设备名<code>\\Device\\TsFltMgr</code>，符号名<code>\\DosDevices\\TsFltMgr</code>。加密手段：Rabbit算法、MD5算法。通过InlineHook KifastCallEntry实现挂钩。</p>
<h3 id="驱动入口driverentry-2">驱动入口DriverEntry</h3>
<ul>
<li>创建<code>\\Device\\TSSysKit</code>设备和<code>\\DosDevices\\TSSysKit</code>符号链接</li>
<li>设置DeviceExtension为通信接口（Interface函数指针）</li>
<li>分别注册IRP_MJ_CREATE、IRP_MJ_CLOSE、IRP_MJ_DEVICE_CONTROL、IRP_MJ_SHUTDOWN(关机回调)派遣例程为，CreateCloseDispatch、DeviceIoControlDispatch、ShutdownDispatch</li>
<li>注册”Boot驱动加载结束”回调DriverReinitializationRoutine</li>
<li>为注册表日志记录分配资源RegLogSpace</li>
<li>检查当前系统是否为注册表version键指定的系统，如果在列表中则在挂钩KiFastCallEntry时需要做额外工作</li>
<li>设置注册表键IsBsod为1，用于检测该驱动是否引起蓝屏(正常关机置0)</li>
<li>获取系统BuildNumber</li>
<li>分配和设置”内核Api代理”结构</li>
<li>挂钩KiFastCallEntry</li>
<li>挂钩重要回调</li>
<li>启动注册表日志记录</li>
<li>挂钩KeUserModeCallback</li>
<li>记录当前配置</li>
</ul>
<p>过滤模型











<figure class="">

    <div>
        <img loading="lazy" alt="" src=" /img/filter_model.png">
    </div>

    
</figure></p>
<ul>
<li>Ntdll.NtCreateFile通过Sysenter调用进入nt.KiFastCallEntry</li>
<li>在nt.KiFastCallEntry 执行call ebx(原始为nt.NtCreateFile)前跳到TsFltMgr. InlineKiFastCallEntry</li>
<li>执行进入TsFltMgr.HookFilter，在这里通过ServiceMapTable表映射到对应Dproxy元素，将Dproxy-&gt;ProxyNtCreateFile设置到ebx，将其设置为ebx</li>
<li>Nt.KiFastCallEntry执行call ebx，进入ProxyNtCreateFile</li>
<li>构造FilterPacket结构（用于承载参数、原始api和PostFilterFunc执行的所有过滤函数都用到），依次执行Dproxy-&gt;PrevFilterSlot的16个过滤函数（PrevFilter是Tsksp事先设置好的）</li>
<li>依次执行单个Tsksp.PrevFilter，进行真正的过滤或对packet. PostFilterSlot进行设置</li>
<li>返回TsFltMgr.ProxyNtCreateFile，执行nt.NtCreateFile</li>
<li>执行packet. PostFilterSlot的16个过滤函数(Tsksp)</li>
<li>返回nt.KiFastCallEntry</li>
</ul>
<p>检查当前系统是否为默认挂钩系统</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">IsUnSupportedSystem</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	/*注：\\Registry\\Machine\\SYSTEM\\CurrentControlSet\\Services\\TSKS	version
</span></span><span style="display:flex;"><span>		存放没有预存 函数调用号ServiceIndex 的系统版本列表 格式：
</span></span><span style="display:flex;"><span>	BuildNumber1;BuildNumber2;...
</span></span><span style="display:flex;"><span>		对于这些版本在进行SSDT Hook时，会临时取得服务号
</span></span><span style="display:flex;"><span>	*/
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	ULONG BuildNumber <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>,MajorVersion,MinorVersion;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">const</span> <span style="color:#5f5fff">int</span> BufSize <span style="color:#ec0000">=</span> <span style="color:#008900">1024</span>;
</span></span><span style="display:flex;"><span>	ULONG Size,Type;
</span></span><span style="display:flex;"><span>	WCHAR BuildNumberStr[<span style="color:#008900">10</span>] <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	BOOLEAN Match <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	UNICODE_STRING UBuildNumber;
</span></span><span style="display:flex;"><span>	WCHAR<span style="color:#ec0000">*</span> Buffer <span style="color:#ec0000">=</span> (WCHAR<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,BufSize);
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetRegDataWithSizeAndType</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Registry</span><span style="color:#008900">\\</span><span style="color:#008900">Machine</span><span style="color:#008900">\\</span><span style="color:#008900">SYSTEM</span><span style="color:#008900">\\</span><span style="color:#008900">CurrentControlSet</span><span style="color:#008900">\\</span><span style="color:#008900">Services</span><span style="color:#008900">\\</span><span style="color:#008900">TSKSP&#34;</span>,<span style="color:#008900">L</span><span style="color:#008900">&#34;version&#34;</span>,
</span></span><span style="display:flex;"><span>		Buffer,BufSize,<span style="color:#ec0000">&amp;</span>Size,<span style="color:#ec0000">&amp;</span>Type);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> Type <span style="color:#ec0000">==</span> REG_SZ <span style="color:#ec0000">&amp;&amp;</span> Size)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Buffer[<span style="color:#008900">510</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UBuildNumber,BuildNumberStr);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">PsGetVersion</span>(<span style="color:#ec0000">&amp;</span>MajorVersion,<span style="color:#ec0000">&amp;</span>MinorVersion,<span style="color:#ec0000">&amp;</span>BuildNumber,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlIntegerToUnicodeString</span>(BuildNumber,<span style="color:#008900">10</span>,<span style="color:#ec0000">&amp;</span>UBuildNumber);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">wcsstr</span>((<span style="color:#5f5fff">wchar_t</span><span style="color:#ec0000">*</span>)Buffer,UBuildNumber.Buffer))
</span></span><span style="display:flex;"><span>			Match <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> Match;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>打开TsFltMgr日志记录</p>
<ul>
<li>在无保护情况下为<code>\\REGISTRY\\MACHINE\\SYSTEM\\CurrentControlSet\\Services\\TsFltMgr</code>添加TsDbgLog键，内容设置为目标文件路径（例如??\C:\TsDbgLog.txt），如果不存在会自动创建文件，重启生效。内容示例：</li>
</ul>
<pre tabindex="0"><code>[0x00000000] 2015.09.27 20:05:24.109	TS TsFltMgr DbgHelper
[0x00000001] 2015.09.27 20:06:13.750	[Sysnap DbgLog] Block--&gt; TableIndex 0, Process spoolsv.exe[1800] 
[0x00000002] 2015.09.27 20:10:35.156	[Sysnap DbgLog] Block--&gt; TableIndex 4, Process regedit.exe[2296] 
[0x00000003] 2015.09.27 20:13:46.500	[Sysnap DbgLog] Block--&gt; TableIndex 4, Process regedit.exe[2296]
</code></pre><ul>
<li>DriverReinitializationRoutine中做初始化，此时最后一个boot驱动初始化完毕</li>
<li>在执行KiFastCallEntry hook时再次尝试启动打印日志线程</li>
<li>ExecPrevSlotFunc中，如果存在过滤函数进行了放行和拦截，都会打印日志</li>
</ul>
<h4 id="控制信息-1">控制信息</h4>
<ul>
<li>禁止hook</li>
</ul>
<pre tabindex="0"><code>\\REGISTRY\\MACHINE\\SYSTEM\\CurrentControlSet\\Services\\TsFltMgr dws=1
\\REGISTRY\\MACHINE\\SYSTEM\\CurrentControlSet\\services\\QQSysMon\\DWS dws!=0
</code></pre><ul>
<li>强制SSDT hook</li>
</ul>
<pre tabindex="0"><code>\\REGISTRY\\MACHINE\\SYSTEM\\CurrentControlSet\\Services\\TsFltMgr thm=1
</code></pre><ul>
<li>关机回调<br>
设置<code>\\REGISTRY\\MACHINE\\SYSTEM\\CurrentControlSet\\Services\\TsFltMgr IsBsod=0</code>，以便下次启动检测是否TsFltMgr引起蓝屏</li>
</ul>
<h4 id="全局表">全局表</h4>
<pre tabindex="0"><code>系统Build号与全局表索引对应关系
BuildNumber:
Win2000
    2195    1
WinXp
    2600    2
WinServer2003
    3790    3
WinVista
    6000    4
    6001    5
    6002    6
Win7
    7600    7
    7601    8
Win8
    8102    9
    8250    10
    8400    11
    8432    12
    8441    12
    8520    13
Win8.1
    9200    14
    9600    15
Win10
    9841    16
    9860    17
    9926    18
    10041   19
    10049   20
未知  0
</code></pre><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ec0000">enum</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	WIN2000<span style="color:#ec0000">=</span><span style="color:#008900">1</span>,
</span></span><span style="display:flex;"><span>	WINXP,
</span></span><span style="display:flex;"><span>	WINXPSP3,
</span></span><span style="display:flex;"><span>	WINVISTA,
</span></span><span style="display:flex;"><span>	WINVISTASP1,
</span></span><span style="display:flex;"><span>	WINVISTASP2,
</span></span><span style="display:flex;"><span>	WIN7,
</span></span><span style="display:flex;"><span>	WIN7SP1,
</span></span><span style="display:flex;"><span>	WIN8_8102,
</span></span><span style="display:flex;"><span>	WIN8_8250,
</span></span><span style="display:flex;"><span>	WIN8_8400,
</span></span><span style="display:flex;"><span>	WIN8_8432,
</span></span><span style="display:flex;"><span>	WIN8_8441<span style="color:#ec0000">=</span>WIN8_8432,
</span></span><span style="display:flex;"><span>	WIN8_8520,
</span></span><span style="display:flex;"><span>	WIN81_9200,
</span></span><span style="display:flex;"><span>	WIN81_9600,
</span></span><span style="display:flex;"><span>	WIN10_9841,
</span></span><span style="display:flex;"><span>	WIN10_9860,
</span></span><span style="display:flex;"><span>	WIN10_9926,
</span></span><span style="display:flex;"><span>	WIN10_10041,
</span></span><span style="display:flex;"><span>	WIN10_10049,
</span></span><span style="display:flex;"><span>	BUILDMAX,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#ec0000">enum</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	SSDT<span style="color:#ec0000">=</span><span style="color:#008900">0</span>,
</span></span><span style="display:flex;"><span>	SSSDT<span style="color:#ec0000">=</span><span style="color:#008900">1</span>,
</span></span><span style="display:flex;"><span>	END<span style="color:#ec0000">=</span><span style="color:#008900">2</span>,
</span></span><span style="display:flex;"><span>	CALLBACK<span style="color:#ec0000">=</span><span style="color:#008900">3</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#define APINUMBER 105
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> SProxy
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG ServiceTableType;//0:SSDT 1:Shadow SSDT 2:结束符
</span></span><span style="display:flex;"><span>	PWCHAR ApiName;//函数名
</span></span><span style="display:flex;"><span>	ULONG  ProxyFunc;//代理函数地址
</span></span><span style="display:flex;"><span>	ULONG ServiceIndex[BUILDMAX];
</span></span><span style="display:flex;"><span>	ULONG IndexInTable;//在全局表中的索引
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> DProxy
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG ServiceTableType;//0:SSDT 1:Shadow SSDT 2:结束符 3:回调函数
</span></span><span style="display:flex;"><span>	ULONG ServiceIndex;//服务号
</span></span><span style="display:flex;"><span>	PWCHAR ApiName;//函数名
</span></span><span style="display:flex;"><span>	ULONG TableIndex;//自定义序号
</span></span><span style="display:flex;"><span>	BOOLEAN IsInitialized;
</span></span><span style="display:flex;"><span>	ULONG PrevFilterRefCount;//引用计数
</span></span><span style="display:flex;"><span>	ULONG PostFilterRefCount;//引用计数
</span></span><span style="display:flex;"><span>	ULONG OriginFuncAddr;//原始函数地址
</span></span><span style="display:flex;"><span>	ULONG ProxyFuncAddr;//代理函数地址
</span></span><span style="display:flex;"><span>	PVOID Log;//用于记录日志
</span></span><span style="display:flex;"><span>	KEVENT Lock;
</span></span><span style="display:flex;"><span>	BOOLEAN DisablePrevFilter;//关闭Filter
</span></span><span style="display:flex;"><span>	ULONG UsedSlotCount;// 当前使用的Slot个数
</span></span><span style="display:flex;"><span>	FILTER_SLOT PrevFilterSlot[<span style="color:#008900">16</span>];//过滤函数结构
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> FILTER_SLOT
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG Tag;
</span></span><span style="display:flex;"><span>	ULONG CallCount;
</span></span><span style="display:flex;"><span>	ULONG DeleteCount;
</span></span><span style="display:flex;"><span>	KTIMER Timer;
</span></span><span style="display:flex;"><span>	ULONG Filter;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> FilterPacket
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG CurrentSlot;//当前Filter序号
</span></span><span style="display:flex;"><span>	ULONG ParamNumber;//参数个数
</span></span><span style="display:flex;"><span>	ULONG Params[<span style="color:#008900">12</span>];//参数
</span></span><span style="display:flex;"><span>	ULONG TagSlot[<span style="color:#008900">16</span>];//标志过滤函数用，也可用于传递修改参数
</span></span><span style="display:flex;"><span>	NTSTATUS Status;//执行结果
</span></span><span style="display:flex;"><span>	ULONG OriginFuncAddr;//原始函数
</span></span><span style="display:flex;"><span>	ULONG IndexInTable;//在DProxyTable中的索引
</span></span><span style="display:flex;"><span>	ULONG Access;//访问权限
</span></span><span style="display:flex;"><span>	ULONG PostFilterSlot[<span style="color:#008900">16</span>];//过滤函数
</span></span><span style="display:flex;"><span>	ULONG UsedSlotCount;//当前使用的Slot个数
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>TsFltMgr有3张表与函数过滤相关:</p>
<ul>
<li>静态Api代理表<code>SProxy	SProxyTable[APINUMBER+1]</code> 用于初始化后面2个表</li>
<li>动态Api代理表<code>DProxy*	DProxyTable[APINUMBER+1]</code> 用于Proxy*函数中进行实际过滤操作，方便用SProxy指定的序号配置</li>
<li><code>DProxy* ServiceMapTable[2][1024]</code> 用于InlineHook KiFastCallEntry改变ebx，映射ServiceIndex到Proxy*函数。函数前1024个用于存储SSDT函数，后1024用于存储SSSDT函数</li>
</ul>
<p>可以用简单的python命令自动获取到g_ProxyApiTable内容:</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>addr<span style="color:#ec0000">=</span><span style="color:#008900">0x25200</span>
</span></span><span style="display:flex;"><span>index<span style="color:#ec0000">=</span><span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">while</span> index <span style="color:#ec0000">&lt;</span> <span style="color:#008900">106</span>:
</span></span><span style="display:flex;"><span><span style="color:#ec0000">if</span> Dword(addr) <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>:
</span></span><span style="display:flex;"><span><span style="color:#ec0000">type</span><span style="color:#ec0000">=</span><span style="color:#008900">&#34;SSDT&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">elif</span> Dword(addr) <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>:
</span></span><span style="display:flex;"><span><span style="color:#ec0000">type</span><span style="color:#ec0000">=</span><span style="color:#008900">&#34;SSSDT&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">else</span>:
</span></span><span style="display:flex;"><span><span style="color:#ec0000">type</span><span style="color:#ec0000">=</span><span style="color:#008900">&#34;END&#34;</span>
</span></span><span style="display:flex;"><span>ApiName<span style="color:#ec0000">=</span>GetString(Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">4</span>),<span style="color:#ec0000">-</span><span style="color:#008900">1</span>,ASCSTR_UNICODE)
</span></span><span style="display:flex;"><span>ProxyFunc<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Proxy&#34;</span><span style="color:#ec0000">+</span>ApiName
</span></span><span style="display:flex;"><span><span style="color:#ec0000">print</span> <span style="color:#008900">&#34;{</span><span style="color:#008900">\n\t</span><span style="color:#008900">%s</span><span style="color:#008900">,L</span><span style="color:#008900">\&#34;</span><span style="color:#008900">%s</span><span style="color:#008900">\&#34;</span><span style="color:#008900">,</span><span style="color:#008900">%s</span><span style="color:#008900">,</span><span style="color:#008900">\n\t</span><span style="color:#008900">{&#34;</span> <span style="color:#ec0000">%</span>(<span style="color:#ec0000">type</span>,ApiName,ProxyFunc)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">print</span> <span style="color:#008900">&#34;</span><span style="color:#008900">\t\t</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">,</span><span style="color:#008900">%d</span><span style="color:#008900">&#34;</span> <span style="color:#ec0000">%</span>(Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">12</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">16</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">20</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">24</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">28</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">32</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">36</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">40</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">44</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">48</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">52</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">56</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">60</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">64</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">68</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">72</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">76</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">80</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">84</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">88</span>),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">92</span>))
</span></span><span style="display:flex;"><span><span style="color:#ec0000">print</span> <span style="color:#008900">&#34;</span><span style="color:#008900">\t</span><span style="color:#008900">},</span><span style="color:#008900">%d</span><span style="color:#008900">\n</span><span style="color:#008900">},&#34;</span> <span style="color:#ec0000">%</span>(Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">96</span>))
</span></span><span style="display:flex;"><span>addr<span style="color:#ec0000">=</span>addr<span style="color:#ec0000">+</span><span style="color:#008900">100</span>
</span></span><span style="display:flex;"><span>index<span style="color:#ec0000">=</span>index<span style="color:#ec0000">+</span><span style="color:#008900">1</span>
</span></span></code></pre></div><pre tabindex="0"><code>struct SProxy	SProxyTable[APINUMBER+1] = 
{
	{
		SSDT,L&#34;ZwCreateKey&#34;,ProxyZwCreateKey,
		{
			1023,35,41,43,64,64,64,70,70,347,351,351,350,350,350,354,355,355,356,359,359
		},0
	},
	{
		SSDT,L&#34;ZwTerminateProcess&#34;,ProxyZwTerminateProcess,
		{
			1023,224,257,266,338,334,334,370,370,35,35,35,35,35,35,35,36,36,36,36,36
		},1
	},
	{
		SSDT,L&#34;ZwSetInformationFile&#34;,ProxyZwSetInformationFile,
		{
			1023,194,224,233,305,301,301,329,329,78,79,79,78,78,78,81,82,82,82,82,82
		},2
	},
	{
		SSDT,L&#34;ZwWriteFile&#34;,ProxyZwWriteFile,
		{
			1023,237,274,284,359,355,355,396,396,4,5,5,5,5,5,6,7,7,7,7,7
		},3
	},
	{
		SSDT,L&#34;ZwSetValueKey&#34;,ProxyZwSetValueKey,
		{
			1023,215,247,256,328,324,324,358,358,48,48,48,48,48,48,49,50,50,50,50,50
		},4
	},
	{
		SSDT,L&#34;ZwWriteVirtualMemory&#34;,ProxyZwWriteVirtualMemory,
		{
			1023,240,277,287,362,358,358,399,399,1,2,2,2,2,2,3,4,4,4,4,4
		},5
	},
	{
		SSDT,L&#34;ZwCreateFile&#34;,ProxyZwCreateFile,
		{
			1023,32,37,39,60,60,60,66,66,351,356,356,355,355,355,360,361,361,362,365,365
		},6
	},
	{
		SSDT,L&#34;ZwOpenProcess&#34;,ProxyZwOpenProcess,
		{
			1023,106,122,128,194,194,194,190,190,220,222,222,221,221,221,224,225,225,226,227,227
		},7
	},
	{
		SSDT,L&#34;ZwDeleteKey&#34;,ProxyZwDeleteKey,
		{
			1023,53,63,66,123,123,123,103,103,310,314,314,313,313,313,317,318,318,319,321,321
		},8
	},
	{
		SSDT,L&#34;ZwDeleteValueKey&#34;,ProxyZwDeleteValueKey,
		{
			1023,55,65,68,126,126,126,106,106,307,311,311,310,310,310,314,315,315,316,318,318
		},9
	},
	{
		SSDT,L&#34;ZwRequestWaitReplyPort&#34;,ProxyZwRequestWaitReplyPort,
		{
			1023,176,200,208,275,276,276,299,299,108,110,110,109,109,109,112,113,113,114,114,114
		},10
	},
	{
		SSDT,L&#34;ZwQueryValueKey&#34;,ProxyZwQueryValueKey,
		{
			1023,155,177,185,252,252,252,266,266,143,145,145,144,144,144,147,148,148,149,149,149
		},11
	},
	{
		SSDT,L&#34;ZwEnumerateValueKey&#34;,ProxyZwEnumerateValueKey,
		{
			1023,61,73,77,136,136,136,119,119,292,296,296,295,295,295,299,300,300,301,303,303
		},12
	},
	{
		SSDT,L&#34;ZwCreateThread&#34;,ProxyZwCreateThread,
		{
			1023,46,53,55,78,78,78,87,87,330,334,334,333,333,333,337,338,338,339,342,342
		},13
	},
	{
		SSDT,L&#34;ZwDuplicateObject&#34;,ProxyZwDuplicateObject,
		{
			1023,58,68,71,129,129,129,111,111,300,304,304,303,303,303,307,308,308,309,311,311
		},14
	},
	{
		SSDT,L&#34;ZwLoadDriver&#34;,ProxyZwLoadDriver,
		{
			1023,85,97,101,165,165,165,155,155,255,257,257,256,256,256,259,260,260,261,263,263
		},15
	},
	{
		SSDT,L&#34;ZwDeviceIoControlFile&#34;,ProxyZwDeviceIoControlFile,
		{
			1023,56,66,69,127,127,127,107,107,304,308,308,307,307,307,311,312,312,313,315,315
		},16
	},
	{
		SSDT,L&#34;ZwAlpcSendWaitReceivePort&#34;,ProxyZwAlpcSendWaitReceivePort,
		{
			1023,1023,1023,1023,38,38,38,39,39,381,386,386,385,385,385,390,391,391,393,396,396
		},17
	},
	{
		SSDT,L&#34;ZwSetSystemInformation&#34;,ProxyZwSetSystemInformation,
		{
			1023,208,240,249,321,317,317,350,350,56,56,56,56,56,56,57,58,58,58,58,58
		},18
	},
	{
		SSDT,L&#34;ZwDeleteFile&#34;,ProxyZwDeleteFile,
		{
			1023,52,62,65,122,122,122,102,102,311,315,315,314,314,314,318,319,319,320,322,322
		},19
	},
	{
		SSDT,L&#34;ZwOpenSection&#34;,ProxyZwOpenSection,
		{
			1023,108,125,131,197,197,197,194,194,216,218,218,217,217,217,220,221,221,222,222,222
		},20
	},
	{
		SSDT,L&#34;ZwCreateSection&#34;,ProxyZwCreateSection,
		{
			1023,43,50,52,75,75,75,84,84,333,337,337,336,336,336,340,341,341,342,345,345
		},21
	},
	{
		SSDT,L&#34;ZwSuspendThread&#34;,ProxyZwSuspendThread,
		{
			1023,221,254,263,335,331,331,367,367,38,38,38,38,38,38,38,39,39,39,39,39
		},22
	},
	{
		SSDT,L&#34;ZwTerminateThread&#34;,ProxyZwTerminateThread,
		{
			1023,225,258,267,339,335,335,371,371,34,34,34,34,34,34,34,35,35,35,35,35
		},23
	},
	{
		SSDT,L&#34;ZwSystemDebugControl&#34;,ProxyZwSystemDebugControl,
		{
			1023,222,255,264,336,332,332,368,368,37,37,37,37,37,37,37,38,38,38,38,38
		},24
	},
	{
		SSDT,L&#34;ZwProtectVirtualMemory&#34;,ProxyZwProtectVirtualMemory,
		{
			1023,1023,137,143,210,210,210,215,215,194,196,196,195,195,195,198,199,199,200,200,200
		},38
	},
	{
		SSDT,L&#34;ZwCreateSymbolicLinkObject&#34;,ProxyZwCreateSymbolicLinkObject,
		{
			1023,45,52,54,77,77,77,86,86,331,335,335,334,334,334,338,339,339,340,343,343
		},39
	},
	{
		SSDT,L&#34;ZwSetContextThread&#34;,ProxyZwSetContextThread,
		{
			1023,1023,213,221,293,289,289,316,316,91,92,92,91,91,91,94,95,95,95,95,95
		},40
	},
	{
		SSDT,L&#34;ZwRenameKey&#34;,ProxyZwRenameKey,
		{
			1023,1023,192,200,267,267,267,290,290,117,119,119,118,118,118,121,122,122,123,123,123
		},41
	},
	{
		SSDT,L&#34;ZwOpenThread&#34;,ProxyZwOpenThread,
		{
			1023,111,128,134,201,201,201,198,198,214,214,214,213,213,213,216,217,217,218,218,218
		},42
	},
	{
		SSDT,L&#34;ZwGetNextThread&#34;,ProxyZwGetNextThread,
		{
			1023,1023,1023,1023,372,368,368,140,140,271,271,271,270,270,270,273,274,274,275,277,277
		},43
	},
	{
		SSDT,L&#34;ZwCreateThreadEx&#34;,ProxyZwCreateThreadEx,
		{
			1023,1023,1023,1023,388,382,382,88,88,333,333,333,332,332,332,336,337,337,338,341,341
		},44
	},
	{
		SSDT,L&#34;ZwRestoreKey&#34;,ProxyZwRestoreKey,
		{
			1023,1023,204,212,279,280,280,302,302,105,107,107,106,106,106,109,110,110,111,111,111
		},55
	},
	{
		SSDT,L&#34;ZwReplaceKey&#34;,ProxyZwReplaceKey,
		{
			1023,1023,193,201,268,268,268,292,292,115,117,117,116,116,116,119,120,120,121,121,121
		},56
	},
	{
		SSDT,L&#34;ZwGetNextProcess&#34;,ProxyZwGetNextProcess,
		{
			1023,1023,1023,1023,371,367,367,139,139,270,272,272,271,271,271,274,275,275,276,278,278
		},45
	},
	{
		SSDT,L&#34;ZwUnmapViewOfSection&#34;,ProxyZwUnmapViewOfSection,
		{
			1023,231,267,277,352,348,348,385,385,19,19,19,19,19,19,19,20,20,20,20,20
		},46
	},
	{
		SSDT,L&#34;ZwAssignProcessToJobObject&#34;,ProxyZwAssignProcessToJobObject,
		{
			1023,18,19,21,42,42,42,43,43,377,382,382,381,381,381,386,387,387,389,392,392
		},47
	},
	{
		SSDT,L&#34;ZwAllocateVirtualMemory&#34;,ProxyZwAllocateVirtualMemory,
		{
			1023,16,17,18,18,18,18,19,19,403,407,407,406,406,406,411,412,412,415,418,418
		},57
	},
	{
		SSDT,L&#34;ZwFreeVirtualMemory&#34;,ProxyZwFreeVirtualMemory,
		{
			1023,71,83,87,147,147,147,131,131,278,281,281,280,280,280,284,285,285,286,288,288
		},58
	},
	{
		SSSDT,L&#34;NtUserFindWindowEx&#34;,ProxyNtUserFindWindowEx,
		{
			1023,368,378,377,391,391,391,396,396,455,457,458,459,460,459,460,462,466,466,466,467
		},25
	},
	{
		SSSDT,L&#34;NtUserBuildHwndList&#34;,ProxyNtUserBuildHwndList,
		{
			1023,302,312,311,322,322,322,323,323,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},26
	},
	{
		SSSDT,L&#34;NtUserQueryWindow&#34;,ProxyNtUserQueryWindow,
		{
			1023,466,483,481,504,504,504,515,515,478,480,481,482,483,482,483,485,489,489,489,490
		},27
	},
	{
		SSSDT,L&#34;NtUserGetForegroundWindow&#34;,ProxyNtUserGetForegroundWindow,
		{
			1023,393,404,403,418,418,418,423,423,426,428,429,430,430,429,430,431,435,435,435,435
		},28
	},
	{
		SSSDT,L&#34;NtUserWindowFromPoint&#34;,ProxyNtUserWindowFromPoint,
		{
			1023,568,592,588,617,617,617,629,629,640,643,646,648,650,649,652,658,664,665,666,667
		},29
	},
	{
		SSSDT,L&#34;NtUserSetParent&#34;,ProxyNtUserSetParent,
		{
			1023,510,529,526,550,550,550,560,560,582,585,587,589,591,590,593,595,601,602,603,604
		},30
	},
	{
		SSSDT,L&#34;NtUserSetWindowLong&#34;,ProxyNtUserSetWindowLong,
		{
			1023,525,544,540,566,566,566,578,578,560,562,564,566,567,566,569,571,575,576,576,577
		},31
	},
	{
		SSSDT,L&#34;NtUserMoveWindow&#34;,ProxyNtUserMoveWindow,
		{
			1023,449,465,464,484,484,484,495,495,499,501,502,503,504,503,505,507,511,511,511,512
		},32
	},
	{
		SSSDT,L&#34;NtUserSetWindowPos&#34;,ProxyNtUserSetWindowPos,
		{
			1023,527,546,542,568,568,568,580,580,558,560,562,564,565,564,567,569,573,574,574,575
		},33
	},
	{
		SSSDT,L&#34;NtUserSetWindowPlacement&#34;,ProxyNtUserSetWindowPlacement,
		{
			1023,526,545,541,567,567,567,579,579,559,561,563,565,566,565,568,570,574,575,575,576
		},34
	},
	{
		SSSDT,L&#34;NtUserShowWindow&#34;,ProxyNtUserShowWindow,
		{
			1023,536,555,551,579,579,579,591,591,547,549,551,553,554,553,556,558,562,563,563,564
		},35
	},
	{
		SSSDT,L&#34;NtUserShowWindowAsync&#34;,ProxyNtUserShowWindowAsync,
		{
			1023,537,556,552,580,580,580,592,592,546,548,550,552,553,552,555,557,561,562,562,563
		},36
	},
	{
		SSSDT,L&#34;NtUserSendInput&#34;,ProxyNtUserSendInput,
		{
			1023,481,502,500,525,525,525,536,536,606,609,611,613,615,614,617,619,625,626,627,628
		},37
	},
	{
		SSSDT,L&#34;NtUserSetWinEventHook&#34;,ProxyNtUserSetWinEventHook,
		{
			1023,533,552,548,576,576,576,588,588,550,552,554,556,557,556,559,561,565,566,566,567
		},49
	},
	{
		SSSDT,L&#34;NtUserClipCursor&#34;,ProxyNtUserClipCursor,
		{
			1023,0,330,329,343,343,343,348,348,333,334,335,335,335,335,337,338,342,342,342,342
		},48
	},
	{
		SSSDT,L&#34;NtUserSetWindowsHookEx&#34;,ProxyNtUserSetWindowsHookEx,
		{
			1023,530,549,545,573,573,573,585,585,553,555,557,559,560,559,562,564,568,569,569,570
		},50
	},
	{
		SSDT,L&#34;ZwMakeTemporaryObject&#34;,ProxyZwMakeTemporaryObject,
		{
			1023,1023,105,110,174,174,174,164,164,246,248,248,247,247,247,250,251,251,252,254,254
		},59
	},
	{
		SSDT,L&#34;ZwCreateUserProcess&#34;,ProxyZwCreateUserProcess,
		{
			1023,1023,1023,1023,1023,383,383,93,93,322,326,326,325,325,325,329,330,330,331,334,334
		},60
	},
	{
		SSSDT,L&#34;NtUserMessageCall&#34;,ProxyNtUserMessageCall,
		{
			1023,444,460,459,479,479,479,490,490,504,506,507,508,509,508,510,512,516,516,516,517
		},61
	},
	{
		SSSDT,L&#34;NtUserPostMessage&#34;,ProxyNtUserPostMessage,
		{
			1023,459,475,474,497,497,497,508,508,486,488,489,490,491,490,492,494,498,498,498,499
		},62
	},
	{
		SSSDT,L&#34;NtUserPostThreadMessage&#34;,ProxyNtUserPostThreadMessage,
		{
			1023,460,476,475,498,498,498,509,509,485,487,488,489,490,489,491,493,497,497,497,498
		},63
	},
	{
		SSSDT,L&#34;NtUserBuildHwndList_WIN8&#34;,ProxyNtUserBuildHwndList_WIN8,
		{
			1023,1023,1023,1023,1023,1023,1023,1023,1023,358,359,360,360,360,360,362,363,367,367,367,367
		},64
	},
	{
		SSDT,L&#34;ZwFsControlFile&#34;,ProxyZwFsControlFile,
		{
			1023,1023,84,1023,150,150,150,134,134,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},65
	},
	{
		SSSDT,L&#34;NtUserSetImeInfoEx&#34;,ProxyNtUserSetImeInfoEx,
		{
			1023,1023,517,1023,1023,1023,1023,550,550,1023,1023,1023,1023,1023,600,603,605,611,612,613,1023
		},66
	},
	{
		SSDT,L&#34;ZwCreateProcessEx&#34;,ProxyZwCreateProcessEx,
		{
			1023,1023,48,50,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},72
	},
	{
		SSSDT,L&#34;NtUserGetRawInputData&#34;,ProxyNtUserGetRawInputData,
		{
			1023,1023,428,1023,1023,1023,1023,448,448,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},67
	},
	{
		SSSDT,L&#34;NtUserGetRawInputBuffer&#34;,ProxyNtUserGetRawInputBuffer,
		{
			1023,1023,427,1023,1023,1023,1023,447,447,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},68
	},
	{
		SSSDT,L&#34;NtUserGetAsyncKeyState&#34;,ProxyNtUserGetAsyncKeyState,
		{
			1023,1023,383,1023,1023,1023,1023,402,402,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},69
	},
	{
		SSSDT,L&#34;NtUserGetKeyState&#34;,ProxyNtUserGetKeyState,
		{
			1023,1023,416,1023,1023,1023,1023,436,436,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},70
	},
	{
		SSSDT,L&#34;NtUserGetKeyboardState&#34;,ProxyNtUserGetKeyboardState,
		{
			1023,1023,414,1023,1023,1023,1023,434,434,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},71
	},
	{
		SSDT,L&#34;ZwQueueApcThread&#34;,ProxyZwQueueApcThread,
		{
			1023,1023,180,1023,1023,1023,1023,269,269,1023,1023,1023,1023,1023,139,142,143,143,144,144,144
		},74
	},
	{
		SSDT,L&#34;ZwSetSecurityObject&#34;,ProxyZwSetSecurityObject,
		{
			1023,1023,237,1023,1023,1023,1023,347,347,1023,1023,1023,1023,1023,59,60,61,61,61,61,61
		},75
	},
	{
		SSDT,L&#34;ZwOpenFile&#34;,ProxyZwOpenFile,
		{
			1023,1023,116,1023,1023,1023,1023,179,179,1023,1023,1023,1023,1023,232,235,236,236,237,238,238
		},76
	},
	{
		SSDT,L&#34;ZwQueueApcThreadEx&#34;,ProxyZwQueueApcThreadEx,
		{
			1023,1023,1023,1023,1023,1023,1023,270,270,1023,1023,1023,1023,1023,138,141,142,142,143,143,143
		},77
	},
	{
		SSDT,L&#34;ZwCreateMutant&#34;,ProxyZwCreateMutant,
		{
			1023,1023,43,45,67,67,67,74,74,1023,1023,1023,1023,1023,346,350,351,351,352,355,355
		},78
	},
	{
		SSDT,L&#34;ZwQuerySystemInformation&#34;,ProxyZwQuerySystemInformation,
		{
			1023,1023,173,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},79
	},
	{
		SSDT,L&#34;ZwQueryIntervalProfile&#34;,ProxyZwQueryIntervalProfile,
		{
			1023,1023,158,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},80
	},
	{
		SSDT,L&#34;ZwSetInformationProcess&#34;,ProxyZwSetInformationProcess,
		{
			1023,1023,228,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},81
	},
	{
		SSSDT,L&#34;NtGdiAddFontMemResourceEx&#34;,ProxyNtGdiAddFontMemResourceEx,
		{
			1023,1023,4,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},82
	},
	{
		SSDT,L&#34;ZwReplyWaitReceivePortEx&#34;,ProxyZwReplyWaitReceivePortEx,
		{
			1023,1023,196,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},83
	},
	{
		END,L&#34;KeUserModeCallback&#34;,ProxyKeUserModeCallback,
		{
			1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},51
	},
	{
		SSDT,L&#34;ZwOpenKey&#34;,ProxyZwOpenKey,
		{
			1023,1023,119,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},84
	},
	{
		SSDT,L&#34;ZwMapViewOfSection&#34;,ProxyZwMapViewOfSection,
		{
			1023,1023,108,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},85
	},
	{
		SSDT,L&#34;ZwSetIntervalProfile&#34;,ProxyZwSetIntervalProfile,
		{
			1023,1023,231,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},86
	},
	{
		SSSDT,L&#34;NtGdiAddFontResourceW&#34;,ProxyNtGdiAddFontResourceW,
		{
			1023,1023,2,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},87
	},
	{
		SSSDT,L&#34;NtGdiAddRemoteFontToDC&#34;,ProxyNtGdiAddRemoteFontToDC,
		{
			1023,1023,3,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},88
	},
	{
		SSDT,L&#34;ZwQueryInformationProcess&#34;,ProxyZwQueryInformationProcess,
		{
			1023,1023,154,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},89
	},
	{
		SSDT,L&#34;ZwQueryInformationThread&#34;,ProxyZwQueryInformationThread,
		{
			1023,1023,155,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},90
	},
	{
		SSDT,L&#34;ZwCreateProfile&#34;,ProxyZwCreateProfile,
		{
			1023,1023,49,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},91
	},
	{
		SSDT,L&#34;ZwVdmControl&#34;,ProxyZwVdmControl,
		{
			1023,1023,268,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},92
	},
	{
		SSDT,L&#34;ZwCreateProcess&#34;,ProxyZwCreateProcess,
		{
			1023,1023,47,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},93
	},
	{
		SSSDT,L&#34;NtGdiAddEmbFontToDC&#34;,ProxyNtGdiAddEmbFontToDC,
		{
			1023,1023,214,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},94
	},
	{
		SSDT,L&#34;NtDebugActiveProcess&#34;,ProxyNtDebugActiveProcess,
		{
			1023,1023,57,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},95
	},
	{
		SSDT,L&#34;NtAlpcCreatePort&#34;,ProxyNtAlpcCreatePort,
		{
			1023,1023,1023,1023,1023,1023,1023,23,23,1023,1023,1023,1023,1023,401,406,407,407,410,413,413
		},96
	},
	{
		SSDT,L&#34;NtCreatePort&#34;,ProxyNtCreatePort,
		{
			1023,1023,46,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},97
	},
	{
		SSDT,L&#34;ZwAdjustPrivilegesToken&#34;,ProxyZwAdjustPrivilegesToken,
		{
			1023,1023,11,1023,1023,1023,1023,12,12,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},98
	},
	{
		SSDT,L&#34;ZwConnectPort&#34;,ProxyZwConnectPort,
		{
			1023,1023,31,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},99
	},
	{
		SSDT,L&#34;ZwSecureConnectPort&#34;,ProxyZwSecureConnectPort,
		{
			1023,1023,210,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},100
	},
	{
		SSDT,L&#34;ZwQueryKey&#34;,ProxyZwQueryKey,
		{
			1023,1023,160,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},101
	},
	{
		SSDT,L&#34;ZwEnumerateKey&#34;,ProxyZwEnumerateKey,
		{
			1023,1023,71,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},102
	},
	{
		SSDT,L&#34;ZwClose&#34;,ProxyZwClose,
		{
			1023,1023,25,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},103
	},
	{
		SSSDT,L&#34;NtUserSystemParametersInfo&#34;,ProxyNtUserSystemParametersInfo,
		{
			1023,1023,559,1023,1023,1023,1023,559,595,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023,1023
		},104
	},
	{
		END,NULL,NULL,
		{
			-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		},105
	}
};
</code></pre><h4 id="proxy函数模型">Proxy*函数模型</h4>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NPAGED_LOOKASIDE_LIST FilterLookAside;
</span></span><span style="display:flex;"><span>BOOLEAN g_EvaluateTime;
</span></span><span style="display:flex;"><span>//Proxy*函数模型  3参数函数为例
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">ProxyNtFunc</span>(<span style="color:#5f5fff">int</span> param1,<span style="color:#5f5fff">int</span> param2,<span style="color:#5f5fff">int</span> param3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_ACCESS_DENIED;
</span></span><span style="display:flex;"><span>	ULONG Result;//自定义结果
</span></span><span style="display:flex;"><span>	ULONGLONG Time <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	DProxy<span style="color:#ec0000">*</span> proxydata <span style="color:#ec0000">=</span> DProxyTable[ENtFunc];
</span></span><span style="display:flex;"><span>	FilterPacket<span style="color:#ec0000">*</span> packet <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocateFromNPagedLookasideList</span>(<span style="color:#ec0000">&amp;</span>FilterLookAside);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(g_EvaluateTime)
</span></span><span style="display:flex;"><span>		Time <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeQueryInterruptTime</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>packet)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>proxydata<span style="color:#ec0000">-&gt;</span>OriginFuncAddr)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> proxydata<span style="color:#ec0000">-&gt;</span><span style="color:#5f5fff">OriginFuncAddr</span>(param1,param2,param3);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	packet<span style="color:#ec0000">-&gt;</span>Params[<span style="color:#008900">0</span>] <span style="color:#ec0000">=</span> param1;
</span></span><span style="display:flex;"><span>	packet<span style="color:#ec0000">-&gt;</span>Params[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> param2;
</span></span><span style="display:flex;"><span>	packet<span style="color:#ec0000">-&gt;</span>Params[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> param3;
</span></span><span style="display:flex;"><span>	packet<span style="color:#ec0000">-&gt;</span>ParamNumber <span style="color:#ec0000">=</span> <span style="color:#008900">3</span>;
</span></span><span style="display:flex;"><span>	packet<span style="color:#ec0000">-&gt;</span>OriginFuncAddr <span style="color:#ec0000">=</span> proxydata<span style="color:#ec0000">-&gt;</span>OriginFuncAddr;
</span></span><span style="display:flex;"><span>	packet<span style="color:#ec0000">-&gt;</span>IndexInTable <span style="color:#ec0000">=</span> ENtFunc;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InterlockedIncrement</span>(<span style="color:#ec0000">&amp;</span>proxydata<span style="color:#ec0000">-&gt;</span>PrevFilterRefCount);
</span></span><span style="display:flex;"><span>	Result <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExecPrevFilter</span>(packet,proxydata);//Prev过滤
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InterlockedDecrement</span>(<span style="color:#ec0000">&amp;</span>proxydata<span style="color:#ec0000">-&gt;</span>PrevFilterRefCount);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Result <span style="color:#ec0000">==</span> SYSMON_UNHANDLED)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(packet<span style="color:#ec0000">-&gt;</span>OriginFuncAddr)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> packet<span style="color:#ec0000">-&gt;</span><span style="color:#5f5fff">OriginFuncAddr</span>(param1,param2,param3);
</span></span><span style="display:flex;"><span>			packet<span style="color:#ec0000">-&gt;</span>Status <span style="color:#ec0000">=</span> status;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedIncrement</span>(<span style="color:#ec0000">&amp;</span>proxydata<span style="color:#ec0000">-&gt;</span>PostFilterRefCount);
</span></span><span style="display:flex;"><span>			Result <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExecPostFilter</span>(packet);//Post过滤
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedDecrement</span>(<span style="color:#ec0000">&amp;</span>proxydata<span style="color:#ec0000">-&gt;</span>PostFilterRefCount);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Result <span style="color:#ec0000">==</span> SYSMON_HANDLED)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> packet<span style="color:#ec0000">-&gt;</span>Status;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(g_EvaluateTime)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">EvaluateTime</span>(proxydata,Time);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ExDeleteNPagedLookasideList</span>(packet);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">ExecPrevFilter</span>(FilterPacket<span style="color:#ec0000">*</span> packet,DProxy<span style="color:#ec0000">*</span> proxydata)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG Result;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>proxydata <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>packet <span style="color:#ec0000">||</span> packet<span style="color:#ec0000">-&gt;</span>DisablePrevFilter)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> SYSMON_UNHANDLED;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">16</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>proxydata<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].DeleteCount <span style="color:#ec0000">&amp;&amp;</span> proxydata<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].Filter <span style="color:#ec0000">&amp;&amp;</span> proxydata<span style="color:#ec0000">-&gt;</span>SlotNum <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedIncrement</span>(<span style="color:#ec0000">&amp;</span>proxydata<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].CallCount);
</span></span><span style="display:flex;"><span>			packet<span style="color:#ec0000">-&gt;</span>CurrentSlot <span style="color:#ec0000">=</span> i;
</span></span><span style="display:flex;"><span>			Result <span style="color:#ec0000">=</span> proxydata<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].<span style="color:#5f5fff">Filter</span>(packet);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedDecrement</span>(<span style="color:#ec0000">&amp;</span>proxydata<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].CallCount);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(packet<span style="color:#ec0000">-&gt;</span>Access <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x10</span>)//如果权限被设置为放行
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">TsLogSprintfOutput</span>(SysMonLogPt,<span style="color:#008900">&#34;[Sysnap DbgLog] Modify--&gt; TableIndex %d, Process %s[%d] &#34;</span>,
</span></span><span style="display:flex;"><span>					proxydata<span style="color:#ec0000">-&gt;</span>TableIndex,<span style="color:#5f5fff">PsGetProcessImageFileName</span>(<span style="color:#5f5fff">IoGetCurrentProcess</span>()),<span style="color:#5f5fff">PsGetCurrentProcessId</span>());
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">switch</span>(Result)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">SYSMON_FORBID</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">TsLogSprintfOutput</span>(SysMonLogPt,<span style="color:#008900">&#34;[Sysnap DbgLog] Block--&gt; TableIndex %d, Process %s[%d] &#34;</span>,
</span></span><span style="display:flex;"><span>					proxydata<span style="color:#ec0000">-&gt;</span>TableIndex,<span style="color:#5f5fff">PsGetProcessImageFileName</span>(<span style="color:#5f5fff">IoGetCurrentProcess</span>()),<span style="color:#5f5fff">PsGetCurrentProcessId</span>());
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> SYSMON_FORBID;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">SYSMON_HANDLED</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> SYSMON_HANDLED;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">SYSMON_PASS</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">SYSMON_PASS1</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> SYSMON_UNHANDLED;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">ExecPostFilter</span>(FilterPacket<span style="color:#ec0000">*</span> packet)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG Result;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>packet)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> SYSMON_UNHANDLED;
</span></span><span style="display:flex;"><span>	FILTER_SLOT<span style="color:#ec0000">*</span> CurrentSlot <span style="color:#ec0000">=</span> DProxyTable[packet<span style="color:#ec0000">-&gt;</span>IndexInTable]<span style="color:#ec0000">-&gt;</span>PrevFilterSlot;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">16</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>CurrentSlot [i].DeleteCount)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedIncrement</span>(<span style="color:#ec0000">&amp;</span>CurrentSlot [i].CallCount);
</span></span><span style="display:flex;"><span>			packet<span style="color:#ec0000">-&gt;</span>CurrentSlot <span style="color:#ec0000">=</span> i;
</span></span><span style="display:flex;"><span>			Result <span style="color:#ec0000">=</span> packet<span style="color:#ec0000">-&gt;</span><span style="color:#5f5fff">PostFilterSlot</span>(packet);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedDecrement</span>(<span style="color:#ec0000">&amp;</span>CurrentSlot [i].CallCount);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">switch</span>(Result)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">SYSMON_HANDLED</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> SYSMON_HANDLED;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">SYSMON_PASS</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">SYSMON_PASS1</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">SYSMON_FORBID</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> SYSMON_UNHANDLED;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="驱动接口interface">驱动接口Interface</h3>
<h4 id="deviceextension接口">DeviceExtension接口</h4>
<p>DeviceObject-&gt;DeviceExtension结构：</p>
<pre tabindex="0"><code>+00h	TAG=’TSFL’
+14h	FARPROC Interface
FARPROC Interface(intindex)
</code></pre><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">Interface</span>(<span style="color:#5f5fff">int</span> index,FARPROC<span style="color:#ec0000">*</span> outfunc)
</span></span><span style="display:flex;"><span>{//注意下面的函数都是自己实现的穿透函数
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>outfunc)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">switch</span>(index)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">0</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>outfunc <span style="color:#ec0000">=</span> SetEvaluateTime;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">1</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>outfunc <span style="color:#ec0000">=</span> DisablePrevFilter;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">2</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>outfunc <span style="color:#ec0000">=</span> SetPostFilter;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">3</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>outfunc <span style="color:#ec0000">=</span> ExecOriginFromPacket;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">4</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>outfunc <span style="color:#ec0000">=</span> AddPrevFilter;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">5</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>outfunc <span style="color:#ec0000">=</span> RemovePrevFilter;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">6</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>outfunc <span style="color:#ec0000">=</span> GetCurrentHookInfo;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">7</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>outfunc <span style="color:#ec0000">=</span> GetDProxyTable;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>outfunc <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> STATUS_SUCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>SetEvaluateTime</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">SetEvaluateTime</span>(<span style="color:#5f5fff">bool</span> EvaluateTime)
</span></span><span style="display:flex;"><span>{//设置计算过滤函数执行耗时
</span></span><span style="display:flex;"><span>	g_EvaluateTime <span style="color:#ec0000">=</span> EvaluateTime;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>SetDisablePrevFilter</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">SetDisablePrevFilter</span>(ULONG Index,BOOLEAN Disable)
</span></span><span style="display:flex;"><span>{//设置是否执行PrevFilter(同时也是PostFilter)
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">If</span>(Index <span style="color:#ec0000">&lt;</span> APINUMBER)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">If</span>(DProxyTable[Index])
</span></span><span style="display:flex;"><span>			DProxyTable[Index]<span style="color:#ec0000">-&gt;</span> DisablePrevFilter <span style="color:#ec0000">=</span> Disable;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>setPostFilter</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">SetPostFilter</span>(FilterPacket<span style="color:#ec0000">*</span> Packet,FARPROC Filter,ULONG Tag)
</span></span><span style="display:flex;"><span>{//设置PostFilter函数
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">If</span>(Packet)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Packet<span style="color:#ec0000">-&gt;</span>TagSlot[Packet<span style="color:#ec0000">-&gt;</span>CurrentSlot] <span style="color:#ec0000">=</span> Tag;//用于修改参数或区分Filter
</span></span><span style="display:flex;"><span>		Packet<span style="color:#ec0000">-&gt;</span>PostFilterSlot[Packet<span style="color:#ec0000">-&gt;</span>CurrentSlot] <span style="color:#ec0000">=</span> Filter;
</span></span><span style="display:flex;"><span>		Packet<span style="color:#ec0000">-&gt;</span>SlotCount<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ExecOriginFromPacket</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">ExecOriginFromPacket</span>(FilterPacket<span style="color:#ec0000">*</span> Packet) 
</span></span><span style="display:flex;"><span>{//执行Nt*原始函数
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">If</span>(<span style="color:#ec0000">!</span>Packet <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>Packet<span style="color:#ec0000">-&gt;</span>OriginFuncAddr)
</span></span><span style="display:flex;"><span>		Return STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	_asm
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Mov eax, Packet<span style="color:#ec0000">-&gt;</span>ParamNumber
</span></span><span style="display:flex;"><span>		Test eax,eax
</span></span><span style="display:flex;"><span>		Jbe tag1
</span></span><span style="display:flex;"><span>		Lea ecx,[eax<span style="color:#ec0000">-</span><span style="color:#008900">1</span>]
</span></span><span style="display:flex;"><span>		Test ecx,ecx
</span></span><span style="display:flex;"><span>		Jl tag1
</span></span><span style="display:flex;"><span>		Lea edx,Packet<span style="color:#ec0000">-&gt;</span>Params[ecx]//参数逐个压栈
</span></span><span style="display:flex;"><span><span style="color:#ec0000">Tag1</span>:
</span></span><span style="display:flex;"><span>		Mov eax,[edx]
</span></span><span style="display:flex;"><span>		Push eax
</span></span><span style="display:flex;"><span>		Sub ecx,<span style="color:#008900">1</span>
</span></span><span style="display:flex;"><span>		Sub edx,<span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>		Test ecx,ecx
</span></span><span style="display:flex;"><span>		Jge tag2
</span></span><span style="display:flex;"><span><span style="color:#ec0000">Tag2</span>:
</span></span><span style="display:flex;"><span>		Call Packet<span style="color:#ec0000">-&gt;</span>OriginFuncAddr
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>AddPrevFilter</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">AddPrevFilter</span>(ULONG Index,FARPROC Filter,ULONG Tag,ULONG PreferSlot,PULONG OutSlot)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	/*
</span></span><span style="display:flex;"><span>		Index :Nt函数在全局表DProxyTable中的索引
</span></span><span style="display:flex;"><span>		Filter:要设置的过滤函数
</span></span><span style="display:flex;"><span>		Tag:标志过滤函数（可用于保存参数）
</span></span><span style="display:flex;"><span>		PreferSlot:优先选用的函数槽
</span></span><span style="display:flex;"><span>		OutSlot:实际选用的函数槽
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Filter <span style="color:#ec0000">||</span> Index <span style="color:#ec0000">&gt;=</span> APINUMBER <span style="color:#ec0000">||</span> PreferSlot <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">16</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DProxyTable[Index] <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>IsInitialized)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[PreferSlot].Filter)
</span></span><span style="display:flex;"><span>	{//若函数槽已被占用
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">16</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].Filter)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].Tag <span style="color:#ec0000">=</span> Tag;
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">InterlockedExchange</span>(<span style="color:#ec0000">&amp;</span>DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].Filter,Filter);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">InterlockedIncrement</span>(<span style="color:#ec0000">&amp;</span>DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>UsedSlotCount);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(OutSlot)
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">*</span>OutSlot <span style="color:#ec0000">=</span> i;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].Tag <span style="color:#ec0000">=</span> Tag;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">InterlockedExchange</span>(<span style="color:#ec0000">&amp;</span>DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].Filter,Filter);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">InterlockedIncrement</span>(<span style="color:#ec0000">&amp;</span>DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>UsedSlotCount);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(OutSlot)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">*</span>OutSlot <span style="color:#ec0000">=</span> i;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>RemovePrevFilter</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">WaitStop</span>(FILTER_SLOT<span style="color:#ec0000">*</span> CurrentSlot)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">KeInitializeTimer</span>(<span style="color:#ec0000">&amp;</span>CurrentSlot<span style="color:#ec0000">-&gt;</span>Timer);
</span></span><span style="display:flex;"><span>	Li.QuadPart <span style="color:#ec0000">=</span> <span style="color:#008900">1000000</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">while</span>(CurrentSlot<span style="color:#ec0000">-&gt;</span>CallCount)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeSetTimer</span>(<span style="color:#ec0000">&amp;</span>CurrentSlot<span style="color:#ec0000">-&gt;</span>Timer,<span style="color:#ec0000">&amp;</span>Li,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeWaitForSingleObject</span>(<span style="color:#ec0000">&amp;</span>CurrentSlot<span style="color:#ec0000">-&gt;</span>Timer,Executive,KernelMode,FALSE,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">KeCancelTimer</span>(<span style="color:#ec0000">&amp;</span>CurrentSlot<span style="color:#ec0000">-&gt;</span>Timer);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__fastcall</span> <span style="color:#5f5fff">RemovePrevFilter</span>(ULONG Index,FARPROC Filter)
</span></span><span style="display:flex;"><span>{//从Index对应的函数过滤中查找删除Filter
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Filter <span style="color:#ec0000">||</span> Index <span style="color:#ec0000">&gt;=</span> APINUMBER)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DProxyTable[Index] <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>IsInitialized)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">16</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i].Filter <span style="color:#ec0000">==</span> Filter)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			LARGE_INTEGER Li;
</span></span><span style="display:flex;"><span>			FILTER_SLOT<span style="color:#ec0000">*</span> CurrentSlot <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>PrevFilterSlot[i];
</span></span><span style="display:flex;"><span>			CurrentSlot<span style="color:#ec0000">-&gt;</span>DeleteCount <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedIncrement</span>(<span style="color:#ec0000">&amp;</span>CurrentSlot<span style="color:#ec0000">-&gt;</span>DeleteCount);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">WaitStop</span>(CurrentSlot);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedExchange</span>(<span style="color:#ec0000">&amp;</span>CurrentSlot<span style="color:#ec0000">-&gt;</span>Filter,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedDecrement</span>(<span style="color:#ec0000">&amp;</span>DProxyTable[Index]<span style="color:#ec0000">-&gt;</span>UsedSlotCount);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">WaitStop</span>(CurrentSlot);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedDecrement</span>(<span style="color:#ec0000">&amp;</span>CurrentSlot<span style="color:#ec0000">-&gt;</span>DeleteCount);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>GetCurrentHookInfo</p>
<pre tabindex="0"><code>NTSTATUS __stdcall GetCurrentHookInfo(PULONG pLastErrorCode,PULONG pserHookType,PULONG pOsVer,PULONG pHookErrorIndex)
{
	if(OsVer &amp;&amp; !LastErrorCode &amp;&amp; HookErrorIndex == -1)
	{
		if(pLastErrorCode)
			*pLastErrorCode = 0;//获取系统buildnumber
		if(pserHookType)
			*pserHookType = serHookType;
		if(pOsVer)
			*pOsVer = OsVer;
		if(pHookErrorIndex)
			*pHookErrorIndex = HookErrorIndex;
	}
	return STATUS_UNSUCCESSFUL;
}
</code></pre><pre tabindex="0"><code>LastErrorCode
0x01	ZwQuerySystemInformation获取失败
0x02	KeServiceDescriptorTable获取失败
0x04	KeAddSystemServiceTable获取失败
0x08	ShadowSSDT获取失败
0x10	MmUserProbeAddress获取失败
0x20	Int2E校验失败

InitState
0x01	ZwQuerySystemInformation获取成功
0x02	KeServiceDescriptorTable获取成功
0x04	ShadowSSDT获取成功
0x08	获取Inline Hook点成功

serHookType 对KiFastCallEntry做inline hook的类型
0.Nonhook			HOOKTYPE_NONE
1.Inlinehook			HOOKTYPE_INLINE
2.SSDTHook			HOOKTYPE_SSDT
3.金山共存Inlinehook	HOOKTYPE_KSINLINE

OsVer
BuildNumber:
Win2000
2195		1
WinXp
2600		2
WinServer2003
3790		3
WinVista
6000		4
6001		5
6002		6
Win7
7600		7
7601		8
Win8
8102		9
8250		10
8400		11
8432		12
8441		12
8520		13
Win8.1
9200		14
9600		15
Win10
9841		16
9860		17
9926		18
10041	19
10049	20
?? 0

HookErrorIndex
	-1

IsBsod
	记录蓝屏
</code></pre><p>GetDProxyTable</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>Dproxy<span style="color:#ec0000">**</span> <span style="color:#5f5fff">GetDProxyTable</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	Return DProxyTable;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="基础库-1">基础库</h3>
<p>获取注册表键值</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">GetRegDataWithType</span>(PWCHAR RegPath,PWCHAR KeyName,PVOID OutData,ULONG BufSize,PULONG OutType)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	HANDLE KeyHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG ResultLength <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>	UNICODE_STRING URegPath,UKeyName;
</span></span><span style="display:flex;"><span>	PVOID ValueInfo;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">const</span> <span style="color:#5f5fff">int</span> BufSize <span style="color:#ec0000">=</span> <span style="color:#ec0000">sizeof</span>(PKEY_VALUE_PARTIAL_INFORMATION) <span style="color:#ec0000">+</span> <span style="color:#ec0000">sizeof</span>(WCHAR[<span style="color:#008900">260</span>]);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>RegPath <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>KeyName)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_INVALID_PARAMETER;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#ec0000">&amp;</span>URegPath,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span> OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwOpenKey</span>(<span style="color:#ec0000">&amp;</span>KeyHandle,KEY_EXECUTE,<span style="color:#ec0000">&amp;</span>Oa);
</span></span><span style="display:flex;"><span>	ValueInfo <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,BufSize);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> ValueInfo)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlZeroMemory</span>(ValueInfo,BufSize);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UKeyName,KeyName);
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQueryValueKey</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UKeyName,KeyValuePartialInformation,ValueInfo,BufSize,<span style="color:#ec0000">&amp;</span>ResultLength);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			PKEY_VALUE_PARTIAL_INFORMATION Info <span style="color:#ec0000">=</span> (PKEY_VALUE_PARTIAL_INFORMATION)ValueInfo;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(OutType)
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">*</span>OutType <span style="color:#ec0000">=</span> Info<span style="color:#ec0000">-&gt;</span>Type;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(OutData)
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">RtlCopyMemory</span>(OutData,Info<span style="color:#ec0000">-&gt;</span>Data,BufSize<span style="color:#ec0000">&lt;</span>Info<span style="color:#ec0000">-&gt;</span>DataLength<span style="color:#ec0000">?</span><span style="color:#ec0000">BufSize</span>:Info<span style="color:#ec0000">-&gt;</span>DataLength);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(KeyHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(KeyHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ValueInfo)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(ValueInfo);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">GetRegDataWithSize</span>(PWCHAR RegPath,PWCHAR KeyName,PVOID OutData,ULONG BufSize,PULONG OutSize)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	HANDLE KeyHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG ResultLength <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>	UNICODE_STRING URegPath,UKeyName;
</span></span><span style="display:flex;"><span>	PVOID ValueInfo;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">const</span> <span style="color:#5f5fff">int</span> BufSize <span style="color:#ec0000">=</span> <span style="color:#ec0000">sizeof</span>(PKEY_VALUE_PARTIAL_INFORMATION) <span style="color:#ec0000">+</span> <span style="color:#ec0000">sizeof</span>(WCHAR[<span style="color:#008900">260</span>]);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>RegPath <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>KeyName)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_INVALID_PARAMETER;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#ec0000">&amp;</span>URegPath,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span> OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwOpenKey</span>(<span style="color:#ec0000">&amp;</span>KeyHandle,KEY_EXECUTE,<span style="color:#ec0000">&amp;</span>Oa);
</span></span><span style="display:flex;"><span>	ValueInfo <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,BufSize);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> ValueInfo)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlZeroMemory</span>(ValueInfo,BufSize);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UKeyName,KeyName);
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQueryValueKey</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UKeyName,KeyValuePartialInformation,ValueInfo,BufSize,<span style="color:#ec0000">&amp;</span>ResultLength);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			PKEY_VALUE_PARTIAL_INFORMATION Info <span style="color:#ec0000">=</span> (PKEY_VALUE_PARTIAL_INFORMATION)ValueInfo;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(OutSize)
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">*</span>OutSize <span style="color:#ec0000">=</span> Info<span style="color:#ec0000">-&gt;</span>DataLength;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(OutData)
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">RtlCopyMemory</span>(OutData,Info<span style="color:#ec0000">-&gt;</span>Data,BufSize<span style="color:#ec0000">&lt;</span>Info<span style="color:#ec0000">-&gt;</span>DataLength<span style="color:#ec0000">?</span><span style="color:#ec0000">BufSize</span>:Info<span style="color:#ec0000">-&gt;</span>DataLength);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(KeyHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(KeyHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ValueInfo)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(ValueInfo);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">GetRegDataWithSizeAndType</span>(PWCHAR RegPath,PWCHAR KeyName,PVOID OutData,ULONG BufSize,PULONG OutSize,PULONG OutType)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	HANDLE KeyHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG ResultLength <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>	UNICODE_STRING URegPath,UKeyName;
</span></span><span style="display:flex;"><span>	PVOID ValueInfo;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">const</span> <span style="color:#5f5fff">int</span> BufSize <span style="color:#ec0000">=</span> <span style="color:#ec0000">sizeof</span>(PKEY_VALUE_PARTIAL_INFORMATION) <span style="color:#ec0000">+</span> <span style="color:#ec0000">sizeof</span>(WCHAR[<span style="color:#008900">260</span>]);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>RegPath <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>KeyName)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_INVALID_PARAMETER;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#ec0000">&amp;</span>URegPath,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span> OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwOpenKey</span>(<span style="color:#ec0000">&amp;</span>KeyHandle,KEY_EXECUTE,<span style="color:#ec0000">&amp;</span>Oa);
</span></span><span style="display:flex;"><span>	ValueInfo <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,BufSize);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> ValueInfo)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlZeroMemory</span>(ValueInfo,BufSize);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UKeyName,KeyName);
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQueryValueKey</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UKeyName,KeyValuePartialInformation,ValueInfo,BufSize,<span style="color:#ec0000">&amp;</span>ResultLength);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			PKEY_VALUE_PARTIAL_INFORMATION Info <span style="color:#ec0000">=</span> (PKEY_VALUE_PARTIAL_INFORMATION)ValueInfo;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(OutSize)
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">*</span>OutSize <span style="color:#ec0000">=</span> Info<span style="color:#ec0000">-&gt;</span>DataLength;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(OutType)
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">*</span>OutType <span style="color:#ec0000">=</span> Info<span style="color:#ec0000">-&gt;</span>Type;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(OutData)
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">RtlCopyMemory</span>(OutData,Info<span style="color:#ec0000">-&gt;</span>Data,BufSize<span style="color:#ec0000">&lt;</span>Info<span style="color:#ec0000">-&gt;</span>DataLength<span style="color:#ec0000">?</span><span style="color:#ec0000">BufSize</span>:Info<span style="color:#ec0000">-&gt;</span>DataLength);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(KeyHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(KeyHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ValueInfo)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(ValueInfo);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>通过进程名获取进程ID</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>HANDLE <span style="color:#5f5fff">GetProcessIdByName</span>(PWCHAR ProcessName)
</span></span><span style="display:flex;"><span>{//根据进程名获取进程ID
</span></span><span style="display:flex;"><span>	HANDLE ProcessId <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	SIZE_T size <span style="color:#ec0000">=</span> <span style="color:#008900">512</span>;
</span></span><span style="display:flex;"><span>	UNICODE_STRING UProcessName;
</span></span><span style="display:flex;"><span>	LPVOID Buffer;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UProcessName,ProcessName);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">while</span>(<span style="color:#ec0000">true</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Buffer <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(PagedPool,size);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Buffer)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQuerySystemInformation</span>(SystemProcessesAndThreadsInformation,Buffer,size,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(status <span style="color:#ec0000">!=</span> STATUS_INFO_LENGTH_MISMATCH)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>		size <span style="color:#ec0000">*=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">NT_SUCCESS</span>(Buffer))
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>	PSYSTEM_PROCESS_INFORMATION ProcessInfo <span style="color:#ec0000">=</span> (PSYSTEM_PROCESS_INFORMATION)Buffer;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">while</span>(ProcessInfo<span style="color:#ec0000">-&gt;</span>NextEntryOffset)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ProcessInfo <span style="color:#ec0000">=</span> (PSYSTEM_PROCESS_INFORMATION)((UCHAR<span style="color:#ec0000">*</span>)ProcessInfo <span style="color:#ec0000">+</span> ProcessInfo<span style="color:#ec0000">-&gt;</span>NextEntryOffset);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">RtlEqualUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UProcessName,<span style="color:#ec0000">&amp;</span>ProcessInfo<span style="color:#ec0000">-&gt;</span>ImageName,TRUE)
</span></span><span style="display:flex;"><span>			ProcessId <span style="color:#ec0000">=</span> ProcessInfo<span style="color:#ec0000">-&gt;</span>UniqueProcessId;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> ProcessId;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="rabbit加密算法">Rabbit加密算法</h4>
<p>  Q管很多驱动中存在的用于传输时加密的可逆算法使用了Rabbit分组加密算法，可以分段加解密，加密过程和解密过程一致。根据驱动中加解密过程可以得到如下代码逻辑</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>#define ld(x) ((x&gt;&gt;32)&amp;0xFFFFFFFF)
</span></span><span style="display:flex;"><span>#define hw(x) ((x&gt;&gt;16)&amp;0xFFFF)
</span></span><span style="display:flex;"><span>#define lw(x) (x&amp;0xFFFF)
</span></span><span style="display:flex;"><span>#define rotl(x,y) ((x&lt;&lt;y)|(x&gt;&gt;(32-y)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> Rabbit
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> X[<span style="color:#008900">8</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> C[<span style="color:#008900">8</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> b;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">Rabbit_nextState</span>(Rabbit<span style="color:#ec0000">*</span> rabbit);
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">Rabbit_Init</span>(Rabbit<span style="color:#ec0000">*</span> rabbit);
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> <span style="color:#5f5fff">Rabbit_toInt</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> key,<span style="color:#5f5fff">int</span> index);
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">Rabbit_SetKey</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> key,Rabbit<span style="color:#ec0000">*</span> rabbit);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">Rabbit_Init</span>(Rabbit<span style="color:#ec0000">*</span> rabbit)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>rabbit)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">8</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		rabbit<span style="color:#ec0000">-&gt;</span>C[i] <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		rabbit<span style="color:#ec0000">-&gt;</span>X[i] <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		rabbit<span style="color:#ec0000">-&gt;</span>b <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> <span style="color:#5f5fff">Rabbit_toInt</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> key,<span style="color:#5f5fff">int</span> index)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>key)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> key[index<span style="color:#ec0000">+</span><span style="color:#008900">3</span>]<span style="color:#ec0000">|</span>(key[index<span style="color:#ec0000">+</span><span style="color:#008900">2</span>]<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">8</span>)<span style="color:#ec0000">|</span>(key[index<span style="color:#ec0000">+</span><span style="color:#008900">1</span>]<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">|</span>(key[index<span style="color:#ec0000">+</span><span style="color:#008900">0</span>]<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">24</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">Rabbit_SetKey</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> key,Rabbit<span style="color:#ec0000">*</span> rabbit)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>key <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>rabbit)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> K0 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">Rabbit_toInt</span>(key,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> K1 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">Rabbit_toInt</span>(key,<span style="color:#008900">4</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> K2 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">Rabbit_toInt</span>(key,<span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> K3 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">Rabbit_toInt</span>(key,<span style="color:#008900">12</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">0</span>] <span style="color:#ec0000">=</span> K3;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> (K0<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">|</span>(K1<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> K2;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> (K3<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">|</span>(K0<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">4</span>] <span style="color:#ec0000">=</span> K1;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">5</span>] <span style="color:#ec0000">=</span> (K2<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">|</span>(K3<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">6</span>] <span style="color:#ec0000">=</span> K0;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">7</span>] <span style="color:#ec0000">=</span> (K1<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">|</span>(K2<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">0</span>] <span style="color:#ec0000">=</span> (K1<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">|</span>(K1<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> ((K3<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xFFFF0000</span>)<span style="color:#ec0000">|</span>(K2<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xFFFF</span>));
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> (K0<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">|</span>(K0<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> ((K2<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xFFFF0000</span>)<span style="color:#ec0000">|</span>(K1<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xFFFF</span>));
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">4</span>] <span style="color:#ec0000">=</span> (K3<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">|</span>(K3<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">5</span>] <span style="color:#ec0000">=</span> ((K1<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xFFFF0000</span>)<span style="color:#ec0000">|</span>(K0<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xFFFF</span>));
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">6</span>] <span style="color:#ec0000">=</span> (K2<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">|</span>(K2<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">7</span>] <span style="color:#ec0000">=</span> ((K0<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xFFFF0000</span>)<span style="color:#ec0000">|</span>(K3<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xFFFF</span>));
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>b <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">4</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">Rabbit_nextState</span>(rabbit);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">8</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		rabbit<span style="color:#ec0000">-&gt;</span>C[i] <span style="color:#ec0000">^=</span> rabbit<span style="color:#ec0000">-&gt;</span>X[(i<span style="color:#ec0000">+</span><span style="color:#008900">4</span>)<span style="color:#ec0000">&amp;</span><span style="color:#008900">7</span>];
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> <span style="color:#5f5fff">Rabbit_u1</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> n)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> r0 <span style="color:#ec0000">=</span> ((<span style="color:#5f5fff">lw</span>(n) <span style="color:#ec0000">*</span> <span style="color:#5f5fff">lw</span>(n)) <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">17</span>) <span style="color:#ec0000">+</span> <span style="color:#5f5fff">lw</span>(n) <span style="color:#ec0000">*</span> <span style="color:#5f5fff">hw</span>(n);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> r1 <span style="color:#ec0000">=</span> (r0 <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">15</span>) <span style="color:#ec0000">+</span> <span style="color:#5f5fff">hw</span>(n) <span style="color:#ec0000">*</span> <span style="color:#5f5fff">hw</span>(n);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> r2 <span style="color:#ec0000">=</span> n <span style="color:#ec0000">*</span> n;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> r1 <span style="color:#ec0000">^</span> r2;
</span></span><span style="display:flex;"><span>// 	_asm
</span></span><span style="display:flex;"><span>// 	{
</span></span><span style="display:flex;"><span>// 		mov esi,n
</span></span><span style="display:flex;"><span>// 		movzx edx,si
</span></span><span style="display:flex;"><span>// 		mov ecx,esi
</span></span><span style="display:flex;"><span>// 		shr ecx,0x10
</span></span><span style="display:flex;"><span>// 		push edi
</span></span><span style="display:flex;"><span>// 		mov eax, edx
</span></span><span style="display:flex;"><span>// 		imul eax, edx
</span></span><span style="display:flex;"><span>// 		mov edi, ecx
</span></span><span style="display:flex;"><span>// 		imul edi, edx
</span></span><span style="display:flex;"><span>// 		mov edx, ecx
</span></span><span style="display:flex;"><span>// 		imul edx, ecx
</span></span><span style="display:flex;"><span>// 		mov ecx, esi
</span></span><span style="display:flex;"><span>// 		imul ecx, esi
</span></span><span style="display:flex;"><span>// 		shr eax, 11h
</span></span><span style="display:flex;"><span>// 		add eax, edi
</span></span><span style="display:flex;"><span>// 		shr eax, 0Fh
</span></span><span style="display:flex;"><span>// 		add eax, edx
</span></span><span style="display:flex;"><span>// 		pop edi
</span></span><span style="display:flex;"><span>// 		xor eax, ecx
</span></span><span style="display:flex;"><span>// 	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">Rabbit_nextState</span>(Rabbit<span style="color:#ec0000">*</span> rabbit)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> G[<span style="color:#008900">8</span>]<span style="color:#ec0000">=</span>{<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> c_old[<span style="color:#008900">8</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>rabbit)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">memcpy</span>(c_old,rabbit<span style="color:#ec0000">-&gt;</span>C,<span style="color:#ec0000">sizeof</span>(c_old));
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">0</span>] <span style="color:#ec0000">+=</span> rabbit<span style="color:#ec0000">-&gt;</span>b <span style="color:#ec0000">+</span> <span style="color:#008900">1295307597</span>;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">1</span>] <span style="color:#ec0000">+=</span> (rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">0</span>] <span style="color:#ec0000">&lt;</span> c_old[<span style="color:#008900">0</span>]) <span style="color:#ec0000">-</span> <span style="color:#008900">749914925</span>;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">2</span>] <span style="color:#ec0000">+=</span> (rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">1</span>] <span style="color:#ec0000">&lt;</span> c_old[<span style="color:#008900">1</span>]) <span style="color:#ec0000">+</span> <span style="color:#008900">886263092</span>;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">3</span>] <span style="color:#ec0000">+=</span> (rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">2</span>] <span style="color:#ec0000">&lt;</span> c_old[<span style="color:#008900">2</span>]) <span style="color:#ec0000">+</span> <span style="color:#008900">1295307597</span>;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">4</span>] <span style="color:#ec0000">+=</span> (rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">3</span>] <span style="color:#ec0000">&lt;</span> c_old[<span style="color:#008900">3</span>]) <span style="color:#ec0000">-</span> <span style="color:#008900">749914925</span>;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">5</span>] <span style="color:#ec0000">+=</span> (rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">4</span>] <span style="color:#ec0000">&lt;</span> c_old[<span style="color:#008900">4</span>]) <span style="color:#ec0000">+</span> <span style="color:#008900">886263092</span>;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">6</span>] <span style="color:#ec0000">+=</span> (rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">5</span>] <span style="color:#ec0000">&lt;</span> c_old[<span style="color:#008900">5</span>]) <span style="color:#ec0000">+</span> <span style="color:#008900">1295307597</span>;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">7</span>] <span style="color:#ec0000">+=</span> (rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">6</span>] <span style="color:#ec0000">&lt;</span> c_old[<span style="color:#008900">6</span>]) <span style="color:#ec0000">-</span> <span style="color:#008900">749914925</span>;
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>b <span style="color:#ec0000">=</span> rabbit<span style="color:#ec0000">-&gt;</span>C[<span style="color:#008900">7</span>] <span style="color:#ec0000">&lt;</span> c_old[<span style="color:#008900">7</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">8</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		G[i] <span style="color:#ec0000">=</span> <span style="color:#5f5fff">Rabbit_u1</span>(rabbit<span style="color:#ec0000">-&gt;</span>X[i]<span style="color:#ec0000">+</span>rabbit<span style="color:#ec0000">-&gt;</span>C[i]);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">0</span>] <span style="color:#ec0000">=</span> G[<span style="color:#008900">0</span>] <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">7</span>],<span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">6</span>],<span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> G[<span style="color:#008900">1</span>] <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">0</span>],<span style="color:#008900">8</span>) <span style="color:#ec0000">+</span> G[<span style="color:#008900">7</span>];
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> G[<span style="color:#008900">2</span>] <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">1</span>],<span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">0</span>],<span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> G[<span style="color:#008900">3</span>] <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">2</span>],<span style="color:#008900">8</span>) <span style="color:#ec0000">+</span> G[<span style="color:#008900">1</span>];
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">4</span>] <span style="color:#ec0000">=</span> G[<span style="color:#008900">4</span>] <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">3</span>],<span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">2</span>],<span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">5</span>] <span style="color:#ec0000">=</span> G[<span style="color:#008900">5</span>] <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">4</span>],<span style="color:#008900">8</span>) <span style="color:#ec0000">+</span> G[<span style="color:#008900">3</span>];
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">6</span>] <span style="color:#ec0000">=</span> G[<span style="color:#008900">6</span>] <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">5</span>],<span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">4</span>],<span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">7</span>] <span style="color:#ec0000">=</span> G[<span style="color:#008900">7</span>] <span style="color:#ec0000">+</span> <span style="color:#5f5fff">rotl</span>(G[<span style="color:#008900">6</span>],<span style="color:#008900">8</span>) <span style="color:#ec0000">+</span> G[<span style="color:#008900">5</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">Rabbit_toByte</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> s,<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> d)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>d)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>	d[<span style="color:#008900">0</span>] <span style="color:#ec0000">=</span> (s<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">24</span>)<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xff</span>;
</span></span><span style="display:flex;"><span>	d[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> (s<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xff</span>;
</span></span><span style="display:flex;"><span>	d[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> (s<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">8</span>)<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xff</span>;
</span></span><span style="display:flex;"><span>	d[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> (s)<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xff</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">Rabbit_EncryptBuf</span>(Rabbit<span style="color:#ec0000">*</span> rabbit,<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> src,<span style="color:#5f5fff">int</span> srclen,<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> dst,<span style="color:#5f5fff">int</span> dstlen)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> K[<span style="color:#008900">4</span>] <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span> v[<span style="color:#008900">4</span>] <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>rabbit <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>src <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>dst <span style="color:#ec0000">||</span> srclen<span style="color:#ec0000">&gt;</span>dstlen <span style="color:#ec0000">||</span> srclen<span style="color:#ec0000">&lt;=</span><span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>srclen;i<span style="color:#ec0000">+=</span><span style="color:#008900">16</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">Rabbit_nextState</span>(rabbit);
</span></span><span style="display:flex;"><span>		K[<span style="color:#008900">0</span>] <span style="color:#ec0000">=</span> rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">0</span>]<span style="color:#ec0000">^</span>(rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">5</span>]<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">^</span>(rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">3</span>]<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">^</span><span style="color:#5f5fff">Rabbit_toInt</span>(src,i);
</span></span><span style="display:flex;"><span>		K[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">2</span>]<span style="color:#ec0000">^</span>(rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">5</span>]<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">^</span>(rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">7</span>]<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">^</span><span style="color:#5f5fff">Rabbit_toInt</span>(src,i<span style="color:#ec0000">+</span><span style="color:#008900">4</span>);
</span></span><span style="display:flex;"><span>		K[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">4</span>]<span style="color:#ec0000">^</span>(rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">7</span>]<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">^</span>(rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">1</span>]<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">^</span><span style="color:#5f5fff">Rabbit_toInt</span>(src,i<span style="color:#ec0000">+</span><span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>		K[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">6</span>]<span style="color:#ec0000">^</span>(rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">3</span>]<span style="color:#ec0000">&gt;&gt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">^</span>(rabbit<span style="color:#ec0000">-&gt;</span>X[<span style="color:#008900">1</span>]<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">16</span>)<span style="color:#ec0000">^</span><span style="color:#5f5fff">Rabbit_toInt</span>(src,i<span style="color:#ec0000">+</span><span style="color:#008900">12</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> j<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;j<span style="color:#ec0000">&lt;</span><span style="color:#008900">4</span>;j<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">Rabbit_toByte</span>(K[j],v);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span><span style="color:#ec0000">*</span>)(dst<span style="color:#ec0000">+</span>i<span style="color:#ec0000">+</span><span style="color:#008900">4</span><span style="color:#ec0000">*</span>j) <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span><span style="color:#ec0000">*</span>)v;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">下面是一个实例：</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span> encrypt[<span style="color:#008900">448</span>] <span style="color:#ec0000">=</span>
</span></span><span style="display:flex;"><span>	{//加密过的进程id
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x30</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xdb</span>,<span style="color:#008900">0x6c</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x4d</span>,<span style="color:#008900">0xdd</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xd1</span>,<span style="color:#008900">0x8e</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x1c</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xf3</span>,<span style="color:#008900">0x6c</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x65</span>,<span style="color:#008900">0xdd</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xc9</span>,<span style="color:#008900">0x8e</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x08</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x0b</span>,<span style="color:#008900">0x6c</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xb5</span>,<span style="color:#008900">0xdd</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x09</span>,<span style="color:#008900">0x8e</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xc8</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x43</span>,<span style="color:#008900">0x6c</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xd5</span>,<span style="color:#008900">0xdd</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x81</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x4c</span>,<span style="color:#008900">0xa5</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xbf</span>,<span style="color:#008900">0x6b</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x51</span>,<span style="color:#008900">0xda</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xf5</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xc8</span>,<span style="color:#008900">0xa5</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x43</span>,<span style="color:#008900">0x6b</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xc5</span>,<span style="color:#008900">0xda</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x6d</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x7c</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x17</span>,<span style="color:#008900">0x6a</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0xdb</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x1d</span>,<span style="color:#008900">0x88</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xc4</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x5f</span>,<span style="color:#008900">0x6a</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xf1</span>,<span style="color:#008900">0xdb</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x55</span>,<span style="color:#008900">0x88</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x14</span>,<span style="color:#008900">0xa7</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xe7</span>,<span style="color:#008900">0x69</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x79</span>,<span style="color:#008900">0xd8</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xdd</span>,<span style="color:#008900">0x8b</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x04</span>,<span style="color:#008900">0xa7</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xf7</span>,<span style="color:#008900">0x69</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x69</span>,<span style="color:#008900">0xd8</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xcd</span>,<span style="color:#008900">0x8b</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xf8</span>,<span style="color:#008900">0xa7</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x13</span>,<span style="color:#008900">0x69</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0xd8</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x29</span>,<span style="color:#008900">0x8b</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xe8</span>,<span style="color:#008900">0xa7</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x2b</span>,<span style="color:#008900">0x69</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xbd</span>,<span style="color:#008900">0xd8</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x8b</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x64</span>,<span style="color:#008900">0xa6</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x97</span>,<span style="color:#008900">0x68</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x39</span>,<span style="color:#008900">0xd9</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0x8a</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xfc</span>,<span style="color:#008900">0xa6</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x2b</span>,<span style="color:#008900">0x68</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xbd</span>,<span style="color:#008900">0xd9</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x09</span>,<span style="color:#008900">0x8a</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xc8</span>,<span style="color:#008900">0xa6</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x43</span>,<span style="color:#008900">0x68</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xd5</span>,<span style="color:#008900">0xd9</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x5d</span>,<span style="color:#008900">0x8a</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x80</span>,<span style="color:#008900">0xa6</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x17</span>,<span style="color:#008900">0x6e</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xd1</span>,<span style="color:#008900">0xdf</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x19</span>,<span style="color:#008900">0x8c</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x90</span>,<span style="color:#008900">0xa0</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x5f</span>,<span style="color:#008900">0x6e</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x61</span>,<span style="color:#008900">0xdf</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x81</span>,<span style="color:#008900">0x8e</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xe0</span>,<span style="color:#008900">0xa5</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x33</span>,<span style="color:#008900">0x6b</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xa5</span>,<span style="color:#008900">0xda</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xe1</span>,<span style="color:#008900">0x88</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x80</span>,<span style="color:#008900">0xa5</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xe7</span>,<span style="color:#008900">0x6a</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x6d</span>,<span style="color:#008900">0xdb</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x15</span>,<span style="color:#008900">0x88</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xdc</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x3f</span>,<span style="color:#008900">0x6a</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x95</span>,<span style="color:#008900">0xd8</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x7d</span>,<span style="color:#008900">0x8b</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xa0</span>,<span style="color:#008900">0xa7</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x77</span>,<span style="color:#008900">0x69</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xed</span>,<span style="color:#008900">0xd8</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0x8b</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x40</span>,<span style="color:#008900">0xa7</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x8b</span>,<span style="color:#008900">0x69</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xc9</span>,<span style="color:#008900">0xdb</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x65</span>,<span style="color:#008900">0x88</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x03</span>,<span style="color:#008900">0x68</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x69</span>,<span style="color:#008900">0xd9</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xd5</span>,<span style="color:#008900">0x8a</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x78</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x93</span>,<span style="color:#008900">0x67</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0xd6</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x91</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x50</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xab</span>,<span style="color:#008900">0x67</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xdd</span>,<span style="color:#008900">0xd6</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0x05</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x0c</span>,<span style="color:#008900">0xab</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x6b</span>,<span style="color:#008900">0x62</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xfd</span>,<span style="color:#008900">0xd0</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0x83</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0xa8</span>,<span style="color:#008900">0xaf</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0xb7</span>,<span style="color:#008900">0x63</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0xad</span>,<span style="color:#008900">0xce</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xa1</span>,<span style="color:#008900">0x9c</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x44</span>,<span style="color:#008900">0xb2</span>,<span style="color:#008900">0xf6</span>,<span style="color:#008900">0xa4</span>,<span style="color:#008900">0x7f</span>,<span style="color:#008900">0x7c</span>,<span style="color:#008900">0xe9</span>,<span style="color:#008900">0xa2</span>,<span style="color:#008900">0x15</span>,<span style="color:#008900">0xca</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x18</span>,<span style="color:#008900">0xb1</span>,<span style="color:#008900">0x8d</span>,<span style="color:#008900">0xa9</span>,<span style="color:#008900">0x8a</span>,
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span> decrypt[<span style="color:#008900">448</span>]<span style="color:#ec0000">=</span>{<span style="color:#008900">0</span>};//解密到目标内存
</span></span><span style="display:flex;"><span>	Rabbit rabbit;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">Rabbit_Init</span>(<span style="color:#ec0000">&amp;</span>rabbit);//初始化
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">Rabbit_SetKey</span>((<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)<span style="color:#008900">&#34;0123456789ABCDEF&#34;</span>,<span style="color:#ec0000">&amp;</span>rabbit);//加载密钥
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">Rabbit_EncryptBuf</span>(<span style="color:#ec0000">&amp;</span>rabbit,encrypt,<span style="color:#008900">448</span>,decrypt,<span style="color:#008900">448</span>);//加密/解密
</span></span><span style="display:flex;"><span>	/*解密后的进程id
</span></span><span style="display:flex;"><span>	00000344 00000358 0000035c 00000360
</span></span><span style="display:flex;"><span>	00000368 00000370 00000374 00000378
</span></span><span style="display:flex;"><span>	0000037c 00000388 000003a4 000003b8
</span></span><span style="display:flex;"><span>	000003bc 000003c0 000003c4 00000430
</span></span><span style="display:flex;"><span>	00000438 0000043c 00000440 00000444
</span></span><span style="display:flex;"><span>	000004bc 000004c0 000004d4 000004dc
</span></span><span style="display:flex;"><span>	00000508 00000594 00000598 000005ac
</span></span><span style="display:flex;"><span>	000005b0 000005dc 000005e0 000005e4
</span></span><span style="display:flex;"><span>	00000660 00000664 00000668 0000066c
</span></span><span style="display:flex;"><span>	00000670 00000674 00000678 0000067c
</span></span><span style="display:flex;"><span>	0000068c 00000690 00000694 00000698
</span></span><span style="display:flex;"><span>	0000069c 000006a8 000006ac 000006b0
</span></span><span style="display:flex;"><span>	00000710 00000714 00000728 00000734
</span></span><span style="display:flex;"><span>	00000788 000007a8 000007ac 000007b8
</span></span><span style="display:flex;"><span>	000007bc 000007c0 000007c4 000007ec
</span></span><span style="display:flex;"><span>	000007f4 00000194 000001c0 000001a8
</span></span><span style="display:flex;"><span>	000001e4 000001dc 00000170 00000330
</span></span><span style="display:flex;"><span>	00000494 000004b0 000004b4 00000550
</span></span><span style="display:flex;"><span>	000004f4 00000564 0000057c 000005a4
</span></span><span style="display:flex;"><span>	000005a8 000005bc 00000684 000006cc
</span></span><span style="display:flex;"><span>	000006d4 000006f4 000006fc 00000658
</span></span><span style="display:flex;"><span>	00000634 00000608 000005d8 000005d4
</span></span><span style="display:flex;"><span>	000005d0 00000780 00000778 00000764
</span></span><span style="display:flex;"><span>	0000080c 00000810 00000814 00000820
</span></span><span style="display:flex;"><span>	00000824 00000828 000008cc 000009b4
</span></span><span style="display:flex;"><span>	00000a78 00000de8 00000eec 00000e58
</span></span><span style="display:flex;"><span>	00000edc 00000c34 000010bc 00001110
</span></span><span style="display:flex;"><span>	00001330 000013fc 00001404 00000000
</span></span><span style="display:flex;"><span>*/
</span></span></code></pre></div><h3 id="inlinehook-kifastcallentry">InlineHook KiFastCallEntry</h3>
<ul>
<li>重置蓝屏死机计数  用于检测hook造成的蓝屏</li>
<li>获取SSDT/SSSDT/ hook点</li>
<li>分配跳转表ServiceMapTable</li>
<li>改写KiFastCallEntry使跳转表生效</li>
<li>Hook重要回调</li>
<li>开启日志记录</li>
<li>Hook KeUserModeCallback</li>
</ul>
<p>获取SSDT/SSSDT/Hook点</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ULONG InitState <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>ULONG LastErrorCode <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>UCHAR int2Ecode1[<span style="color:#008900">10</span>] <span style="color:#ec0000">=</span> {<span style="color:#008900">0x8B</span>, <span style="color:#008900">0xFC</span>, <span style="color:#008900">0x3B</span>, <span style="color:#008900">0x35</span>, <span style="color:#008900">0x00</span>, <span style="color:#008900">0x00</span>, <span style="color:#008900">0x00</span>, <span style="color:#008900">0x00</span>, <span style="color:#008900">0x0F</span>, <span style="color:#008900">0x83</span>};
</span></span><span style="display:flex;"><span>UCHAR int2Ecode2[<span style="color:#008900">22</span>] <span style="color:#ec0000">=</span> {<span style="color:#008900">0x8B</span>, <span style="color:#008900">0xFC</span>, <span style="color:#008900">0xF6</span>, <span style="color:#008900">0x45</span>, <span style="color:#008900">0x72</span>, <span style="color:#008900">0x02</span>, <span style="color:#008900">0x75</span>, <span style="color:#008900">0x06</span>, <span style="color:#008900">0xF6</span>, <span style="color:#008900">0x45</span>, <span style="color:#008900">0x6C</span>,
</span></span><span style="display:flex;"><span>						<span style="color:#008900">0x01</span>, <span style="color:#008900">0x74</span>, <span style="color:#008900">0x0C</span>, <span style="color:#008900">0x3B</span>, <span style="color:#008900">0x35</span>, <span style="color:#008900">0x00</span>, <span style="color:#008900">0x00</span>, <span style="color:#008900">0x00</span>, <span style="color:#008900">0x00</span>, <span style="color:#008900">0x0F</span>, <span style="color:#008900">0x83</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">GetHookPoint1</span>()
</span></span><span style="display:flex;"><span>{//检测系统原始KiFastCallEntry
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)(int2Ecode2 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> MmUserProbeAddress;//构造cmp esi,dword ptr ds:[MmUserProbeAddress]
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>MmUserProbeAddress)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	ULONG ptr <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetKiSystemServiceAddr</span>();//KiFastCallEntry总在KiSystemService之后
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ptr <span style="color:#ec0000">&lt;</span> NtosBase <span style="color:#ec0000">||</span> ptr <span style="color:#ec0000">&gt;</span> NtosBase<span style="color:#ec0000">+</span>NtosSize)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> offset <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;offset <span style="color:#ec0000">&lt;</span> <span style="color:#008900">1024</span>;offset<span style="color:#ec0000">++</span>,ptr<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		/*
</span></span><span style="display:flex;"><span>			mov edi,esp
</span></span><span style="display:flex;"><span>			cmp esi,dword ptr ds:[MmUserProbeAddress]
</span></span><span style="display:flex;"><span>			jae ??
</span></span><span style="display:flex;"><span>		*/
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">RtlCompareMemory</span>(ptr,int2Ecode1,<span style="color:#ec0000">sizeof</span>(int2Ecode1)) <span style="color:#ec0000">==</span> <span style="color:#ec0000">sizeof</span>(int2Ecode1))
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> ptr;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">GetHookPoint2</span>()
</span></span><span style="display:flex;"><span>{//检测是否被金山inline hook过得KiFastCallEntry
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)(int2Ecode2 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">=</span> MmUserProbeAddress;//构造cmp esi,dword ptr ds:[MmUserProbeAddress]
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>MmUserProbeAddress)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	ULONG ptr <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetKiSystemServiceAddr</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ptr <span style="color:#ec0000">&lt;</span> NtosBase <span style="color:#ec0000">||</span> ptr <span style="color:#ec0000">&gt;</span> NtosBase<span style="color:#ec0000">+</span>NtosSize)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> offset <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;offset <span style="color:#ec0000">&lt;</span> <span style="color:#008900">1024</span>;offset<span style="color:#ec0000">++</span>,ptr<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		/*
</span></span><span style="display:flex;"><span>			mov edi,esp
</span></span><span style="display:flex;"><span>			test byte ptr[ebp+72h],2
</span></span><span style="display:flex;"><span>			jne $1
</span></span><span style="display:flex;"><span>			test byte ptr[ebp+6Ch],1
</span></span><span style="display:flex;"><span>			je ??
</span></span><span style="display:flex;"><span>			$1:
</span></span><span style="display:flex;"><span>			cmp esi,dword ptr ds:[MmUserProbeAddress]
</span></span><span style="display:flex;"><span>			jae ??
</span></span><span style="display:flex;"><span>		*/
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">RtlCompareMemory</span>(ptr,int2Ecode2,<span style="color:#ec0000">sizeof</span>(int2Ecode2)) <span style="color:#ec0000">==</span> <span style="color:#ec0000">sizeof</span>(int2Ecode2))
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> ptr;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG InitState <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>,LastErrorCode <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>,serHookType <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>ULONG NtosBase,NtosSize,SSDTBase,SSDTLimit,ShadowSSDTBase,ShadowSSDTLimit,Win32kBase,Win32kSize;
</span></span><span style="display:flex;"><span>ULONG dwcsrssId;
</span></span><span style="display:flex;"><span>ULONG BuildIndex;
</span></span><span style="display:flex;"><span>PKSERVICE_TABLE_DESCRIPTOR KeServiceDescriptorTable;
</span></span><span style="display:flex;"><span>ULONG MmUserProbeAddress;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> HOOKINFO
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG InlinePoint;
</span></span><span style="display:flex;"><span>	ULONG JmpBackPoint;
</span></span><span style="display:flex;"><span>	UCHAR OriginCode[<span style="color:#008900">8</span>];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HOOKINFO HookInfo1<span style="color:#ec0000">=</span>{<span style="color:#008900">0</span>},HookInfo2<span style="color:#ec0000">=</span>{<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>/*
</span></span><span style="display:flex;"><span>KiFastCallEntry+0xde:
</span></span><span style="display:flex;"><span>	mov     ebx,dword ptr [edi+eax*4]
</span></span><span style="display:flex;"><span>	jmp     81f9e3e0
</span></span><span style="display:flex;"><span>	nop												=&gt;	InlinePoint
</span></span><span style="display:flex;"><span>	nop
</span></span><span style="display:flex;"><span>	nop
</span></span><span style="display:flex;"><span>	jmp     TsFltMgr+0x2300 (f8517300)
</span></span><span style="display:flex;"><span>	jae     nt!KiSystemCallExit2+0x9f (8053e7ec)	=&gt;	JmpBackPoint
</span></span><span style="display:flex;"><span>	rep movs dword ptr es:[edi],dword ptr [esi]
</span></span><span style="display:flex;"><span>	call    ebx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	OriginCode[8];
</span></span><span style="display:flex;"><span>	8bfc            mov     edi,esp
</span></span><span style="display:flex;"><span>	3b35549a5580    cmp     esi,dword ptr [nt!MmUserProbeAddress]
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">PrepareHook</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	RTL_PROCESS_MODULE_INFORMATION Win32kInfo,NtosInfo;
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	ULONG ReturnLength <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	ULONG OutData;
</span></span><span style="display:flex;"><span>	LPVOID Buffer <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlZeroMemory</span>(<span style="color:#ec0000">&amp;</span>Win32kInfo,<span style="color:#ec0000">sizeof</span>(Win32kInfo));
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlZeroMemory</span>(<span style="color:#ec0000">&amp;</span>NtosInfo,<span style="color:#ec0000">sizeof</span>(NtosInfo));
</span></span><span style="display:flex;"><span>	InitState <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	LastErrorCode <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetRegDataWithType</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">REGISTRY</span><span style="color:#008900">\\</span><span style="color:#008900">MACHINE</span><span style="color:#008900">\\</span><span style="color:#008900">SYSTEM</span><span style="color:#008900">\\</span><span style="color:#008900">CurrentControlSet</span><span style="color:#008900">\\</span><span style="color:#008900">Services</span><span style="color:#008900">\\</span><span style="color:#008900">TsFltMgr&#34;</span>, 
</span></span><span style="display:flex;"><span>		<span style="color:#008900">L</span><span style="color:#008900">&#34;thm&#34;</span>, <span style="color:#ec0000">&amp;</span>OutData, <span style="color:#008900">4</span>, <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> OutData <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>		serHookType <span style="color:#ec0000">=</span> HOOKTYPE_SSDT;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ZwQuerySystemInformation</span>(SystemModuleInformation,<span style="color:#ec0000">&amp;</span>ReturnLength,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>ReturnLength);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ReturnLength)
</span></span><span style="display:flex;"><span>		Buffer <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(PagedPool,ReturnLength);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Buffer)
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQuerySystemInformation</span>(SystemModuleInformation,Buffer,ReturnLength,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>		Buffer <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Buffer)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlCopyMemory</span>(<span style="color:#ec0000">&amp;</span>NtosInfo,((PRTL_PROCESS_MODULES)Buffer)<span style="color:#ec0000">-&gt;</span>Modules,<span style="color:#ec0000">sizeof</span>(NtosInfo));
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>		NtosBase <span style="color:#ec0000">=</span> NtosInfo.ImageBase;
</span></span><span style="display:flex;"><span>		NtosSize <span style="color:#ec0000">=</span> NtosInfo.ImageSize;
</span></span><span style="display:flex;"><span>		ULONG FuncAddr <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MiLocateExportName</span>(NtosBase,<span style="color:#008900">&#34;KeServiceDescriptorTable&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(FuncAddr <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(FuncAddr))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			PKSERVICE_TABLE_DESCRIPTOR KeServiceDescriptorTable <span style="color:#ec0000">=</span> (PKSERVICE_TABLE_DESCRIPTOR)FuncAddr;
</span></span><span style="display:flex;"><span>			SSDTBase <span style="color:#ec0000">=</span> KeServiceDescriptorTable[<span style="color:#008900">0</span>].Base;
</span></span><span style="display:flex;"><span>			SSDTLimit <span style="color:#ec0000">=</span> KeServiceDescriptorTable[<span style="color:#008900">0</span>].Limit;
</span></span><span style="display:flex;"><span>			InitState <span style="color:#ec0000">|=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>			dwcsrssId <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetProcessIdByName</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;csrss.exe&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">GetProcessInfoByFileName</span>(<span style="color:#008900">&#34;WIN32K.SYS&#34;</span>,<span style="color:#ec0000">&amp;</span>Win32kInfo))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				Win32kBase <span style="color:#ec0000">=</span> Win32kInfo.ImageBase;
</span></span><span style="display:flex;"><span>				Win32kSize <span style="color:#ec0000">=</span> Win32kInfo.ImageSize;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">GetShadowSSDTInfo</span>()))
</span></span><span style="display:flex;"><span>					InitState <span style="color:#ec0000">|=</span> <span style="color:#008900">4</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>			UNICODE_STRING UMmUserProbeAddress;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UMmUserProbeAddress,<span style="color:#008900">L</span><span style="color:#008900">&#34;MmUserProbeAddress&#34;</span>);
</span></span><span style="display:flex;"><span>			ULONG MmUserProbeAddress <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MmGetSystemRoutineAddress</span>(<span style="color:#ec0000">&amp;</span>UMmUserProbeAddress);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(MmUserProbeAddress <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(MmUserProbeAddress))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				HookInfo1.InlinePoint <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetHookPoint1</span>();
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(HookInfo1.InlinePoint)
</span></span><span style="display:flex;"><span>					HookInfo1.JmpBackPoint <span style="color:#ec0000">=</span> HookInfo1.InlinePoint <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					HookInfo2.InlinePoint <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetHookPoint2</span>();
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(HookInfo2.InlinePoint)
</span></span><span style="display:flex;"><span>						HookInfo2.JmpBackPoint <span style="color:#ec0000">=</span> HookInfo2.InlinePoint <span style="color:#ec0000">+</span> <span style="color:#008900">6</span>;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(HookInfo1.InlinePoint <span style="color:#ec0000">==</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> HookInfo2.InlinePoint <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					LastErrorCode <span style="color:#ec0000">|=</span> <span style="color:#008900">0x20</span>;
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				InitState <span style="color:#ec0000">|=</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>				MmUserProbeAddress <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)MmUserProbeAddress;
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				LastErrorCode <span style="color:#ec0000">|=</span> <span style="color:#008900">0x10</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			LastErrorCode <span style="color:#ec0000">|=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		LastErrorCode <span style="color:#ec0000">|=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>从KiSystemService获取KiFastCallEntry</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ec0000">struct</span> IDTR
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	USHORT IDTLimit;
</span></span><span style="display:flex;"><span>	PKIDTENTRY IDTBase;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">GetKiSystemServiceAddr</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	IDTR idt <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	RTL_PROCESS_MODULE_INFORMATION NtosInfo,Win32kInfo;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlZeroMemory</span>(<span style="color:#ec0000">&amp;</span>NtosInfo,<span style="color:#ec0000">sizeof</span>(NtosInfo));
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">__sidt</span>(<span style="color:#ec0000">&amp;</span>idt);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(idt.IDTBase)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		KIDTENTRY int2e <span style="color:#ec0000">=</span> idt.IDTBase[<span style="color:#008900">0x2E</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">MmIsAddressValid</span>(int2e))
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#5f5fff">MAKEULONG</span>(int2e.ExtendedOffset,int2e.Offset);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>获取SSSDT信息</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">GetShadowSSDTInfo</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	PVOID pt <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MiLocateExportName</span>(NtosBase, <span style="color:#008900">&#34;KeAddSystemServiceTable&#34;</span>);
</span></span><span style="display:flex;"><span>	PMDL mdl <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(pt <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span><span style="color:#5f5fff">MmIsAddressValid</span>(pt))
</span></span><span style="display:flex;"><span>	{//页换出
</span></span><span style="display:flex;"><span>		mdl <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MmCreateMdl</span>(<span style="color:#ec0000">NULL</span>,pt,<span style="color:#008900">0x1000</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(mdl)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">MmProbeAndLockPages</span>(mdl,KernelMode,IoReadAccess);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>pt <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span><span style="color:#5f5fff">MmIsAddressValid</span>(pt))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		LastErrorCode <span style="color:#ec0000">|=</span> <span style="color:#008900">4</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">goto</span> END;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">switch</span>(BuildIndex)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN2000</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXP</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXPSP3</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINVISTA</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINVISTASP1</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINVISTASP2</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7SP1</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">256</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">MmIsAddressValid</span>(pt) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(USHORT<span style="color:#ec0000">*</span>)pt <span style="color:#ec0000">==</span> <span style="color:#008900">0x888D</span>)
</span></span><span style="display:flex;"><span>			{//8d88603f5580    lea     ecx,nt!KeServiceDescriptorTableShadow 
</span></span><span style="display:flex;"><span>				PKSERVICE_TABLE_DESCRIPTOR Table <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)(pt<span style="color:#ec0000">+</span><span style="color:#008900">2</span>);
</span></span><span style="display:flex;"><span>				ShadowSSDTBase <span style="color:#ec0000">=</span> Table[<span style="color:#008900">1</span>].Base;
</span></span><span style="display:flex;"><span>				ShadowSSDTLimit <span style="color:#ec0000">=</span> Table[<span style="color:#008900">1</span>].Limit;
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8_8102</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8_8250</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN81_9200</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN81_9600</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">256</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">MmIsAddressValid</span>(pt) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(USHORT<span style="color:#ec0000">*</span>)pt <span style="color:#ec0000">==</span> <span style="color:#008900">0xB983</span>)
</span></span><span style="display:flex;"><span>			{//83b9603f558083  cmp     dword ptr nt!KeServiceDescriptorTableShadow
</span></span><span style="display:flex;"><span>				PKSERVICE_TABLE_DESCRIPTOR Table <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)(pt<span style="color:#ec0000">+</span><span style="color:#008900">2</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(KeServiceDescriptorTable <span style="color:#ec0000">==</span> Table)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					ShadowSSDTBase <span style="color:#ec0000">=</span> Table[<span style="color:#008900">1</span>].Base;
</span></span><span style="display:flex;"><span>					ShadowSSDTLimit <span style="color:#ec0000">=</span> Table[<span style="color:#008900">1</span>].Limit;
</span></span><span style="display:flex;"><span>					status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN10_9841</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN10_9860</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN10_9926</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN10_10041</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN10_10049</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">256</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">MmIsAddressValid</span>(pt) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(USHORT<span style="color:#ec0000">*</span>)pt <span style="color:#ec0000">==</span> <span style="color:#008900">0x3D83</span>)
</span></span><span style="display:flex;"><span>			{//833d90d28d8100  cmp     dword ptr [nt!KeServiceDescriptorTableShadow+0x10],0
</span></span><span style="display:flex;"><span>				PKSERVICE_TABLE_DESCRIPTOR Table <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)(pt<span style="color:#ec0000">+</span><span style="color:#008900">2</span>) <span style="color:#ec0000">-</span> <span style="color:#008900">16</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(KeServiceDescriptorTable <span style="color:#ec0000">==</span> Table)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					ShadowSSDTBase <span style="color:#ec0000">=</span> Table[<span style="color:#008900">1</span>].Base;
</span></span><span style="display:flex;"><span>					ShadowSSDTLimit <span style="color:#ec0000">=</span> Table[<span style="color:#008900">1</span>].Limit;
</span></span><span style="display:flex;"><span>					status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>ShadowSSDTBase)
</span></span><span style="display:flex;"><span>		LastErrorCode <span style="color:#ec0000">|=</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">END</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(mdl)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">MmUnlockPages</span>(mdl);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">IoFreeMdl</span>(mdl);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>初始化InlineHook KiFastCallEntry跳转表</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">InitProxyTable</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG BuildIndex <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetBuildNumberAsIndex</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;i <span style="color:#ec0000">&lt;</span> APINUMBER;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> j <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;j <span style="color:#ec0000">&lt;</span> BUILDMAX;j<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(SProxyTable[i].ServiceIndex[j] <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>				SProxyTable[i].ServiceIndex[j] <span style="color:#ec0000">=</span> <span style="color:#008900">1023</span>;//置为无效
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">GetServiceIndex</span>(<span style="color:#008900">&#34;ZwCreateKey&#34;</span>) <span style="color:#ec0000">==</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>	{//不能获取到服务号
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(NtosBase)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;i <span style="color:#ec0000">&lt;</span> APINUMBER;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(SProxyTable[i].ServiceTableType <span style="color:#ec0000">==</span> END)
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(SProxyTable[i].ServiceTableType <span style="color:#ec0000">==</span> SSDT)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(SProxyTable[i].ApiName)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						UNICODE_STRING UApiName;
</span></span><span style="display:flex;"><span>						ANSI_STRING AApiName;
</span></span><span style="display:flex;"><span>						<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UApiName,SProxyTable[i].ApiName);
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">RtlUnicodeStringToAnsiString</span>(<span style="color:#ec0000">&amp;</span>AApiName,<span style="color:#ec0000">&amp;</span>UApiName,TRUE)))
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							<span style="color:#5f5fff">GetServiceIndexFromNtos</span>(AApiName.Buffer);
</span></span><span style="display:flex;"><span>							<span style="color:#5f5fff">RtlFreeAnsiString</span>(AApiName);
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}				
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{//能获取到服务号   由于SProxyTable已存服务号，所以下面代码本身无效
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;i <span style="color:#ec0000">&lt;</span> APINUMBER;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(SProxyTable[i].ServiceTableType <span style="color:#ec0000">==</span> END)
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(SProxyTable[i].ServiceTableType <span style="color:#ec0000">==</span> SSDT)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(SProxyTable[i].ApiName)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					UNICODE_STRING UApiName;
</span></span><span style="display:flex;"><span>					ANSI_STRING AApiName;
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UApiName,SProxyTable[i].ApiName);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">RtlUnicodeStringToAnsiString</span>(<span style="color:#ec0000">&amp;</span>AApiName,<span style="color:#ec0000">&amp;</span>UApiName,TRUE)))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						ULONG Index <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetServiceIndexFromNtdll</span>(AApiName.Buffer);
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(Index <span style="color:#ec0000">!=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>							SProxyTable[i].ServiceIndex[BuildIndex] <span style="color:#ec0000">=</span> Index;
</span></span><span style="display:flex;"><span>						<span style="color:#5f5fff">RtlFreeAnsiString</span>(AApiName);
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">AllocHookTable</span>()
</span></span><span style="display:flex;"><span>{//已知系统情况下初始化代理表，直接使用ServiceIndex
</span></span><span style="display:flex;"><span>	ULONG BuildIndex <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetBuildNumberAsIndex</span>();
</span></span><span style="display:flex;"><span>	DProxy<span style="color:#ec0000">*</span> Proxydata <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG Count <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;//未成功布置的代理函数个数
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(BuildIndex <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> BuildIndex <span style="color:#ec0000">&lt;</span> BUILDMAX)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">InitProxyTable</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>APINUMBER;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(SProxyTable[i].ServiceTableType <span style="color:#ec0000">==</span> END)
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(SProxyTable[i].ServiceIndex[BuildIndex] <span style="color:#ec0000">!=</span> <span style="color:#008900">1023</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(SProxyTable[i].ApiName <span style="color:#ec0000">&amp;&amp;</span> SProxyTable[i].ProxyFunc <span style="color:#ec0000">&amp;&amp;</span> SProxyTable[i].IndexInTable <span style="color:#ec0000">&lt;</span> APINUMBER)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					Proxydata <span style="color:#ec0000">=</span> (DProxy<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#ec0000">sizeof</span>(DProxy));
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(Proxydata)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						Proxydata<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>						Proxydata<span style="color:#ec0000">-&gt;</span>ApiName <span style="color:#ec0000">=</span> SProxyTable[i].ApiName;
</span></span><span style="display:flex;"><span>						Proxydata<span style="color:#ec0000">-&gt;</span>TableIndex <span style="color:#ec0000">=</span> SProxyTable[i].IndexInTable;
</span></span><span style="display:flex;"><span>						Proxydata<span style="color:#ec0000">-&gt;</span>ProxyFuncAddr <span style="color:#ec0000">=</span> SProxyTable[i].ProxyFunc;
</span></span><span style="display:flex;"><span>						Proxydata<span style="color:#ec0000">-&gt;</span>ServiceIndex <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>						<span style="color:#5f5fff">KeInitializeEvent</span>(Proxydata<span style="color:#ec0000">-&gt;</span>Lock,SynchronizationEvent,FALSE);
</span></span><span style="display:flex;"><span>						DProxyTable[SProxyTable[i].IndexInTable] <span style="color:#ec0000">=</span> Proxydata;
</span></span><span style="display:flex;"><span>						ULONG ServiceType <span style="color:#ec0000">=</span> SProxyTable[i].ServiceTableType;
</span></span><span style="display:flex;"><span>						ULONG ServiceIndex <span style="color:#ec0000">=</span> SProxyTable[i].ServiceIndex[BuildIndex];
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(ServiceType <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">2</span> <span style="color:#ec0000">||</span>  ServiceIndex<span style="color:#ec0000">==</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span> <span style="color:#ec0000">||</span> ServiceIndex <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">1024</span>)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							Count<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							ServiceMapTable[ServiceType][ServiceIndex] <span style="color:#ec0000">=</span> Proxydata;
</span></span><span style="display:flex;"><span>							Proxydata<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">=</span> ServiceType;
</span></span><span style="display:flex;"><span>							Proxydata<span style="color:#ec0000">-&gt;</span>ServiceIndex <span style="color:#ec0000">=</span> ServiceIndex;
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> Count;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> APINUMBER;//返回未成功代理的个数
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">AllocHookTableU</span>()
</span></span><span style="display:flex;"><span>{//未知系统情况下初始化代理表，临时从Ntos模块获取ServiceIndex
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>NtosBase)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;//返回成功布置代理的个数
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>APINUMBER;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(SProxyTable[i].ServiceTableType <span style="color:#ec0000">==</span> END)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(SProxyTable[i].ServiceTableType <span style="color:#ec0000">==</span> SSDT)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(SProxyTable[i].ApiName)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				PUNICODE_STRING UApiName;
</span></span><span style="display:flex;"><span>				ANSI_STRING AApiName;
</span></span><span style="display:flex;"><span>				ULONG Index <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UApiName,SProxyTable[i].ApiName);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">RtlUnicodeStringToAnsiString</span>(<span style="color:#ec0000">&amp;</span>AApiName,<span style="color:#ec0000">&amp;</span>UApiName,TRUE)))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					Index <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetServiceIndexFromNtos</span>(AApiName.Buffer);
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">RtlFreeAnsiString</span>(<span style="color:#ec0000">&amp;</span>AApiName);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(Index <span style="color:#ec0000">!=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(SProxyTable[i].ApiName <span style="color:#ec0000">&amp;&amp;</span> SProxyTable[i].ProxyFunc <span style="color:#ec0000">&amp;&amp;</span> SProxyTable[i].IndexInTable <span style="color:#ec0000">&lt;</span> APINUMBER)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						Proxydata <span style="color:#ec0000">=</span> (DProxy<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#ec0000">sizeof</span>(DProxy));
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(Proxydata)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							Proxydata<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>							Proxydata<span style="color:#ec0000">-&gt;</span>ApiName <span style="color:#ec0000">=</span> SProxyTable[i].ApiName;
</span></span><span style="display:flex;"><span>							Proxydata<span style="color:#ec0000">-&gt;</span>TableIndex <span style="color:#ec0000">=</span> SProxyTable[i].IndexInTable;
</span></span><span style="display:flex;"><span>							Proxydata<span style="color:#ec0000">-&gt;</span>ProxyFuncAddr <span style="color:#ec0000">=</span> SProxyTable[i].ProxyFunc;
</span></span><span style="display:flex;"><span>							Proxydata<span style="color:#ec0000">-&gt;</span>ServiceIndex <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>							<span style="color:#5f5fff">KeInitializeEvent</span>(Proxydata<span style="color:#ec0000">-&gt;</span>Lock,SynchronizationEvent,FALSE);
</span></span><span style="display:flex;"><span>							DProxyTable[SProxyTable[i].IndexInTable] <span style="color:#ec0000">=</span> Proxydata;
</span></span><span style="display:flex;"><span>							ULONG ServiceType <span style="color:#ec0000">=</span> SProxyTable[i].ServiceTableType;
</span></span><span style="display:flex;"><span>							ULONG ServiceIndex <span style="color:#ec0000">=</span> SProxyTable[i].ServiceIndex[BuildIndex];
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span>(ServiceType <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">2</span> <span style="color:#ec0000">||</span>  ServiceIndex<span style="color:#ec0000">==</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span> <span style="color:#ec0000">||</span> ServiceIndex <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">1024</span>)
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								Count<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>								ServiceMapTable[ServiceType][ServiceIndex] <span style="color:#ec0000">=</span> Proxydata;
</span></span><span style="display:flex;"><span>								Proxydata<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">=</span> ServiceType;
</span></span><span style="display:flex;"><span>								Proxydata<span style="color:#ec0000">-&gt;</span>ServiceIndex <span style="color:#ec0000">=</span> ServiceIndex;
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> Count;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>获取系统服务号的2种方式</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">GetServiceIndexFromNtdll</span>(PCHAR ApiName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG result <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>	RTL_PROCESS_MODULE_INFORMATION ProcessInfo;
</span></span><span style="display:flex;"><span>	ULONG Index;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlZeroMemory</span>(<span style="color:#ec0000">&amp;</span>ProcessInfo,<span style="color:#ec0000">sizeof</span>(ProcessInfo));
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">GetProcessInfoByFileName</span>(<span style="color:#008900">&#34;ntdll.dll&#34;</span>,<span style="color:#ec0000">&amp;</span>ProcessInfo) <span style="color:#ec0000">&amp;&amp;</span> ProcessInfo.ImageBase <span style="color:#ec0000">&amp;&amp;</span> ApiName)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Index <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MiLocateExportName</span>(ProcessInfo.ImageBase,ApiName);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(Index)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			result <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)(Index<span style="color:#ec0000">+</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">GetServiceIndexFromNtos</span>(PCHAR ApiName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG result <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>	ULONG Index <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MiLocateExportName</span>(ProcessInfo.ImageBase,ApiName);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Index)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		result <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)(Index<span style="color:#ec0000">+</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Index <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0xFFFFC000</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		result <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="inlinehook过程">InlineHook过程</h4>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">DoInlineHook</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	ULONG MajorVersion <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>,MinorVersion <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>,BuildNumber <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">PsGetVersion</span>(<span style="color:#ec0000">&amp;</span>MajorVersion,<span style="color:#ec0000">&amp;</span>MinorVersion,<span style="color:#ec0000">&amp;</span>BuildNumber,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(serHookType <span style="color:#ec0000">==</span> HOOKTYPE_SSDT <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>(InitState <span style="color:#ec0000">&amp;</span> <span style="color:#008900">8</span>))//外部hook或没找到hook挂载点
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(HookInfo1.InlinePoint)
</span></span><span style="display:flex;"><span>	{//如果为默认方式hook
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">GetBuildNumberAsIndex</span>() <span style="color:#ec0000">&gt;=</span> WINVISTA)
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ModifyAndHook</span>(HookInfo1.InlinePoint,InlineKiFastCallEntry1);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ModifyAndHook</span>(HookInfo1.InlinePoint,InlineKiFastCallEntry2);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			serHookType <span style="color:#ec0000">=</span> HOOKTYPE_INLINE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(HookInfo2.InlinePoint)
</span></span><span style="display:flex;"><span>	{//如果为金山共存方式hook
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">GetBuildNumberAsIndex</span>() <span style="color:#ec0000">&gt;=</span> WINVISTA)
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ModifyAndHookK</span>(HookInfo2.InlinePoint,InlineKiFastCallEntry3);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ModifyAndHookK</span>(HookInfo2.InlinePoint,InlineKiFastCallEntry4);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			serHookType <span style="color:#ec0000">=</span> HOOKTYPE_KSINLINE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>APINUMBER;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(DProxyTable[i] <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> (DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">==</span> SSDT <span style="color:#ec0000">||</span> DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">==</span> SSSDT))
</span></span><span style="display:flex;"><span>				DProxyTable[i]<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">DoInlineHookU</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	ULONG MajorVersion <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>,MinorVersion <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>,BuildNumber <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">PsGetVersion</span>(<span style="color:#ec0000">&amp;</span>MajorVersion,<span style="color:#ec0000">&amp;</span>MinorVersion,<span style="color:#ec0000">&amp;</span>BuildNumber,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(serHookType <span style="color:#ec0000">==</span> HOOKTYPE_SSDT <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>(InitState <span style="color:#ec0000">&amp;</span> <span style="color:#008900">8</span>))//采用外部hook或没找到hook挂载点
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(HookInfo1.InlinePoint)
</span></span><span style="display:flex;"><span>	{//如果为默认方式hook
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">GetBuildNumberAsIndex</span>() <span style="color:#ec0000">&gt;=</span> WINVISTA)
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ModifyAndHook</span>(HookInfo1.InlinePoint,InlineKiFastCallEntry1);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ModifyAndHook</span>(HookInfo1.InlinePoint,InlineKiFastCallEntry2);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			serHookType <span style="color:#ec0000">=</span> HOOKTYPE_INLINE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(HookInfo2.InlinePoint)
</span></span><span style="display:flex;"><span>	{//如果为金山共存方式hook
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">GetBuildNumberAsIndex</span>() <span style="color:#ec0000">&gt;=</span> WINVISTA)
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ModifyAndHookK</span>(HookInfo2.InlinePoint,InlineKiFastCallEntry3);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ModifyAndHookK</span>(HookInfo2.InlinePoint,InlineKiFastCallEntry4);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			serHookType <span style="color:#ec0000">=</span> HOOKTYPE_KSINLINE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>APINUMBER;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(DProxyTable[i] <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> (DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">==</span> SSDT <span style="color:#ec0000">||</span> DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">==</span> SSSDT))
</span></span><span style="display:flex;"><span>				DProxyTable[i]<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">ModifyAndHook</span>(ULONG InlinePoint,FARPROC JmpToFunc)
</span></span><span style="display:flex;"><span>{//HOOKTYPE_INLINE 更改KiFastCallEntry
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	PVOID MappedAddress <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>InlinePoint <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>InlineHookFunc)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	PMDL mdl <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetWritablePage</span>(InlinePoint,<span style="color:#008900">16</span>,<span style="color:#ec0000">&amp;</span>MappedAddress);
</span></span><span style="display:flex;"><span>	/*
</span></span><span style="display:flex;"><span>		改写						为
</span></span><span style="display:flex;"><span>		mov edi,esp						nop
</span></span><span style="display:flex;"><span>		cmp esp,dword ptr ds:[?]		nop
</span></span><span style="display:flex;"><span>										nop
</span></span><span style="display:flex;"><span>										jmp ?
</span></span><span style="display:flex;"><span>	*/
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>mdl)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	ULONG data[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> {InlinePoint,JmpToFunc,MappedAddress};
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MakeJmp</span>(data,DoHook);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">MmUnlockPages</span>(mdl);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">IoFreeMdl</span>(mdl);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">ModifyAndHookK</span>(ULONG InlinePoint,FARPROC JmpToFunc)
</span></span><span style="display:flex;"><span>{//HOOKTYPE_KSINLINE 更改KiFastCallEntry
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	PVOID MappedAddress <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>InlinePoint <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>InlineHookFunc)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	PMDL mdl <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetWritablePage</span>(InlinePoint,<span style="color:#008900">16</span>,<span style="color:#ec0000">&amp;</span>MappedAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>mdl)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	ULONG data[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> {InlinePoint,JmpToFunc,MappedAddress};
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MakeJmp</span>(data,DoHookK);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">MmUnlockPages</span>(mdl);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">IoFreeMdl</span>(mdl);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">DoHook</span>(ULONG<span style="color:#ec0000">*</span> data)
</span></span><span style="display:flex;"><span>{//HOOKTYPE_INLINE
</span></span><span style="display:flex;"><span>	ULONGLONG shellcode;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>data)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">*</span>(ULONGLONG<span style="color:#ec0000">*</span>)(HookInfo1.OriginCode) <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONGLONG<span style="color:#ec0000">*</span>)data[<span style="color:#008900">0</span>];//保存原始8字节
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)((UCHAR<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>shellcode<span style="color:#ec0000">+</span><span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> data[<span style="color:#008900">1</span>] <span style="color:#ec0000">-</span> data[<span style="color:#008900">0</span>] <span style="color:#ec0000">-</span> <span style="color:#008900">8</span>;//填写偏移 jmp offset
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)((UCHAR<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>shellcode) <span style="color:#ec0000">=</span> <span style="color:#008900">0xE9909090</span>;//写入新8字节
</span></span><span style="display:flex;"><span>	/*
</span></span><span style="display:flex;"><span>		构造
</span></span><span style="display:flex;"><span>		nop
</span></span><span style="display:flex;"><span>		nop
</span></span><span style="display:flex;"><span>		nop
</span></span><span style="display:flex;"><span>		jmp ????
</span></span><span style="display:flex;"><span>	*/
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InterlockedCompareExchange64</span>((LONGLONG<span style="color:#ec0000">*</span>)data[<span style="color:#008900">2</span>],shellcode,<span style="color:#ec0000">*</span>(LONGLONG<span style="color:#ec0000">*</span>)data[<span style="color:#008900">2</span>]);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">DoHookK</span>(ULONG<span style="color:#ec0000">*</span> data)
</span></span><span style="display:flex;"><span>{//HOOKTYPE_KSINLINE
</span></span><span style="display:flex;"><span>	ULONGLONG shellcode;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>data)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">*</span>(ULONGLONG<span style="color:#ec0000">*</span>)(HookInfo1.OriginCode) <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONGLONG<span style="color:#ec0000">*</span>)data[<span style="color:#008900">0</span>];//保存原始8字节
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">*</span>(USHORT<span style="color:#ec0000">*</span>)((UCHAR<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>shellcode<span style="color:#ec0000">+</span><span style="color:#008900">6</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0x0675</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)((UCHAR<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>shellcode<span style="color:#ec0000">+</span><span style="color:#008900">2</span>) <span style="color:#ec0000">=</span> data[<span style="color:#008900">1</span>] <span style="color:#ec0000">-</span> data[<span style="color:#008900">0</span>] <span style="color:#ec0000">-</span> <span style="color:#008900">8</span>;//填写偏移 jmp offset
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)((UCHAR<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>shellcode) <span style="color:#ec0000">=</span> <span style="color:#008900">0xE990</span>;//写入新8字节
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InterlockedCompareExchange64</span>((LONGLONG<span style="color:#ec0000">*</span>)data[<span style="color:#008900">2</span>],shellcode,<span style="color:#ec0000">*</span>(LONGLONG<span style="color:#ec0000">*</span>)data[<span style="color:#008900">2</span>]);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PMDL <span style="color:#5f5fff">GetWritablePage</span>(PVOID VirtualAddress,ULONG Length,PVOID<span style="color:#ec0000">*</span> pMappedAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PMDL mdl <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoAllocateMdl</span>(VirtualAddress,Length,FALSE,TRUE,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(mdl)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">MmProbeAndLockPages</span>(mdl,KernelMode,IoWriteAccess);
</span></span><span style="display:flex;"><span>		PVOID NewAddr <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MmGetSystemAddressForMdlSafe</span> (Mdl, NormalPagePriority);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>NewAddr)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">MmUnlockPages</span>(mdl);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">IoFreeMdl</span>(mdl);
</span></span><span style="display:flex;"><span>			mdl <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(NewAddr)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">*</span>pMappedAddress <span style="color:#ec0000">=</span> NewAddr;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> mdl;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>构造InlineHook跳转后的执行语句</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">Filter</span>(ULONG ServiceIndex,ULONG OriginFunc,ULONG Base)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ServiceIndex <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">1024</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> OriginFunc;
</span></span><span style="display:flex;"><span>	ULONG TableType;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Base <span style="color:#ec0000">==</span> SSDTBase <span style="color:#ec0000">&amp;&amp;</span> ServiceIndex <span style="color:#ec0000">&lt;=</span> SSDTLimit)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		TableType <span style="color:#ec0000">=</span> SSDT;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(KeServiceDescriptorTable <span style="color:#ec0000">&amp;&amp;</span> KeServiceDescriptorTable<span style="color:#ec0000">-&gt;</span>Base <span style="color:#ec0000">==</span> Base <span style="color:#ec0000">&amp;&amp;</span> ServiceIndex <span style="color:#ec0000">&lt;=</span> SSDTLimit)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		TableType <span style="color:#ec0000">=</span> SSDT;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(Base <span style="color:#ec0000">==</span> ShadowSSDTBase <span style="color:#ec0000">&amp;&amp;</span> ServiceIndex <span style="color:#ec0000">&lt;=</span> ShadowSSDTLimit)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		TableType <span style="color:#ec0000">=</span> SSSDT;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> OriginFunc;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ServiceMapTable[TableType][ServiceIndex])
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ULONG NewAddr <span style="color:#ec0000">=</span> ServiceMapTable[TableType][ServiceIndex]<span style="color:#ec0000">-&gt;</span>ProxyFuncAddr;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(NewAddr)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			ServiceMapTable[TableType][ServiceIndex]<span style="color:#ec0000">-&gt;</span>OriginFuncAddr <span style="color:#ec0000">=</span> OriginFunc;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> NewAddr;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> OriginFunc;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">__declspec</span>(<span style="color:#ec0000">naked</span>) <span style="color:#5f5fff">InlineKiFastCallEntry1</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	/*  HOOKTYPE_INLINE   &gt;=VISTA
</span></span><span style="display:flex;"><span>		输入
</span></span><span style="display:flex;"><span>		eax=ServiceIndex
</span></span><span style="display:flex;"><span>		edx=OriginFunc
</span></span><span style="display:flex;"><span>		edi=SSDTBase
</span></span><span style="display:flex;"><span>		输出
</span></span><span style="display:flex;"><span>		edx=FuncAddr  最终函数调用地址
</span></span><span style="display:flex;"><span>	*/
</span></span><span style="display:flex;"><span>	_asm
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pushf;
</span></span><span style="display:flex;"><span>		pusha;
</span></span><span style="display:flex;"><span>		push edi;
</span></span><span style="display:flex;"><span>		push edx;
</span></span><span style="display:flex;"><span>		push eax;
</span></span><span style="display:flex;"><span>		call Filter;
</span></span><span style="display:flex;"><span>		mov [esp<span style="color:#ec0000">+</span><span style="color:#008900">0x14</span>],eax;//改栈中的edx
</span></span><span style="display:flex;"><span>		popa;
</span></span><span style="display:flex;"><span>		popf;
</span></span><span style="display:flex;"><span>		mov edi,esp;
</span></span><span style="display:flex;"><span>		cmp esi,MmUserProbeAddress;
</span></span><span style="display:flex;"><span>		push dword ptr HookInfo1.JmpBackPoint;
</span></span><span style="display:flex;"><span>		retn;//跳回JmpBackPoint
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">__declspec</span>(<span style="color:#ec0000">naked</span>) <span style="color:#5f5fff">InlineKiFastCallEntry2</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	/*  HOOKTYPE_INLINE   &lt;VISTA
</span></span><span style="display:flex;"><span>		输入
</span></span><span style="display:flex;"><span>		eax=ServiceIndex
</span></span><span style="display:flex;"><span>		edx=OriginFunc
</span></span><span style="display:flex;"><span>		edi=SSDTBase
</span></span><span style="display:flex;"><span>		输出
</span></span><span style="display:flex;"><span>		ebx=FuncAddr  最终函数调用地址
</span></span><span style="display:flex;"><span>	*/
</span></span><span style="display:flex;"><span>	_asm
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pushf;
</span></span><span style="display:flex;"><span>		pusha;
</span></span><span style="display:flex;"><span>		push edi;
</span></span><span style="display:flex;"><span>		push edx;
</span></span><span style="display:flex;"><span>		push eax;
</span></span><span style="display:flex;"><span>		call Filter;
</span></span><span style="display:flex;"><span>		mov [esp<span style="color:#ec0000">+</span><span style="color:#008900">0x10</span>],eax;//改栈中的ebx
</span></span><span style="display:flex;"><span>		popa;
</span></span><span style="display:flex;"><span>		popf;
</span></span><span style="display:flex;"><span>		mov edi,esp;
</span></span><span style="display:flex;"><span>		cmp esi,MmUserProbeAddress;
</span></span><span style="display:flex;"><span>		push dword ptr HookInfo1.JmpBackPoint;
</span></span><span style="display:flex;"><span>		retn;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">__declspec</span>(<span style="color:#ec0000">naked</span>) <span style="color:#5f5fff">InlineKiFastCallEntry3</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	/*  HOOKTYPE_KSINLINE   &lt;VISTA
</span></span><span style="display:flex;"><span>		输入
</span></span><span style="display:flex;"><span>		eax=ServiceIndex
</span></span><span style="display:flex;"><span>		edx=OriginFunc
</span></span><span style="display:flex;"><span>		edi=SSDTBase
</span></span><span style="display:flex;"><span>		输出
</span></span><span style="display:flex;"><span>		edx=FuncAddr  最终函数调用地址    (KiFastCallEntry后面mov ebx,edx)
</span></span><span style="display:flex;"><span>	*/
</span></span><span style="display:flex;"><span>	_asm
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pushf;
</span></span><span style="display:flex;"><span>		pusha;
</span></span><span style="display:flex;"><span>		push edi;
</span></span><span style="display:flex;"><span>		push edx;
</span></span><span style="display:flex;"><span>		push eax;
</span></span><span style="display:flex;"><span>		call Filter;
</span></span><span style="display:flex;"><span>		mov [esp<span style="color:#ec0000">+</span><span style="color:#008900">0x14</span>],eax;//改栈中的edx
</span></span><span style="display:flex;"><span>		popa;
</span></span><span style="display:flex;"><span>		popf;
</span></span><span style="display:flex;"><span>		mov edi,esp;
</span></span><span style="display:flex;"><span>		test byte ptr [ebp<span style="color:#ec0000">+</span><span style="color:#008900">0x72</span>],<span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>		push dword ptr HookInfo2.JmpBackPoint;
</span></span><span style="display:flex;"><span>		retn;//跳回JmpBackPoint
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">__declspec</span>(<span style="color:#ec0000">naked</span>) <span style="color:#5f5fff">InlineKiFastCallEntry4</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	/*  HOOKTYPE_KSINLINE   &lt;VISTA
</span></span><span style="display:flex;"><span>		输入
</span></span><span style="display:flex;"><span>		eax=ServiceIndex
</span></span><span style="display:flex;"><span>		edx=OriginFunc
</span></span><span style="display:flex;"><span>		edi=SSDTBase
</span></span><span style="display:flex;"><span>		输出
</span></span><span style="display:flex;"><span>		ebx=FuncAddr  最终函数调用地址
</span></span><span style="display:flex;"><span>	*/
</span></span><span style="display:flex;"><span>	_asm
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pushf;
</span></span><span style="display:flex;"><span>		pusha;
</span></span><span style="display:flex;"><span>		push edi;
</span></span><span style="display:flex;"><span>		push edx;
</span></span><span style="display:flex;"><span>		push eax;
</span></span><span style="display:flex;"><span>		call Filter;
</span></span><span style="display:flex;"><span>		mov [esp<span style="color:#ec0000">+</span><span style="color:#008900">0x14</span>],eax;//改栈中的edx
</span></span><span style="display:flex;"><span>		popa;
</span></span><span style="display:flex;"><span>		popf;
</span></span><span style="display:flex;"><span>		mov edi,esp;
</span></span><span style="display:flex;"><span>		test byte ptr [ebp<span style="color:#ec0000">+</span><span style="color:#008900">0x72</span>],<span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>		push dword ptr HookInfo2.JmpBackPoint;
</span></span><span style="display:flex;"><span>		retn;//跳回JmpBackPoint
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="强制单核互斥执行指定procedure">强制单核互斥执行指定Procedure</h4>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>truct SpinData
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	KSPIN_LOCK SpinLock;
</span></span><span style="display:flex;"><span>	ULONG SpinRefCount;
</span></span><span style="display:flex;"><span>}g_Spin <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>KDPC Dpc[<span style="color:#008900">32</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">DpcRoutine</span>(PKDPC Dpc,PVOID DeferredContext,PVOID SystemArgument1,PVOID SystemArgument2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	KIRQL OldIrql;
</span></span><span style="display:flex;"><span>	SpinData<span style="color:#ec0000">*</span> spin <span style="color:#ec0000">=</span> (SpinData<span style="color:#ec0000">*</span>)DeferredContext;zh
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">_disable</span>();
</span></span><span style="display:flex;"><span>	OldIrql <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeRaiseIrqlToDpcLevel</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InterlockedIncrement</span>(spin<span style="color:#ec0000">-&gt;</span>SpinRefCount);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">KeAcquireSpinLockAtDpcLevel</span>(spin<span style="color:#ec0000">-&gt;</span>SpinLock);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">KeReleaseSpinLockFromDpcLevel</span>(spin<span style="color:#ec0000">-&gt;</span>SpinLock);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">KeLowerIrql</span>(OldIrql);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">_enable</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">MakeJmp</span>(ULONG<span style="color:#ec0000">*</span> data,FARPROC addr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	ULONG ulCurrentCpu <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	KIRQL OldIrql,NewIrql;
</span></span><span style="display:flex;"><span>	KAFFINITY CpuAffinity;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>addr)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>	CpuAffinity <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeQueryActiveProcessors</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;i <span style="color:#ec0000">&lt;</span> <span style="color:#008900">32</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>((CpuAffinity <span style="color:#ec0000">&gt;&gt;</span> i) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>			ulCurrentCpu<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ulCurrentCpu <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>)//单核
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">_disable</span>();
</span></span><span style="display:flex;"><span>		OldIrql <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeRaiseIrqlToDpcLevel</span>();
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">addr</span>(data);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeLowerIrql</span>(OldIrql);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">_enable</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>//多核  将除当前cpu以外的cpu用自旋锁锁住
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		SpinData<span style="color:#ec0000">*</span> pSpinData <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>g_Spin;
</span></span><span style="display:flex;"><span>		ULONG ulNumberOfActiveCpu <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeInitializeSpinLock</span>(<span style="color:#ec0000">&amp;</span>g_Spin.SpinLock);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;i <span style="color:#ec0000">&lt;</span> <span style="color:#008900">32</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeInitializeDpc</span>(<span style="color:#ec0000">&amp;</span>Dpc[i],DpcRoutine,<span style="color:#ec0000">&amp;</span>pSpinData);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		pSpinData<span style="color:#ec0000">-&gt;</span>SpinRefCount <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">_disable</span>();
</span></span><span style="display:flex;"><span>		NewIrql <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeAcquireSpinLock</span>(<span style="color:#ec0000">&amp;</span>g_Spin.SpinLock);
</span></span><span style="display:flex;"><span>		ulCurrentCpu <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeGetCurrentProcessorNumber</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;i <span style="color:#ec0000">&lt;</span> <span style="color:#008900">32</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>((CpuAffinity <span style="color:#ec0000">&gt;&gt;</span> i) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>				ulNumberOfActiveCpu<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(i <span style="color:#ec0000">!=</span> ulCurrentCpu)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">KeSetTargetProcessorDpc</span>(Dpc[i],i);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">KeSetImportanceDpc</span>(Dpc[i],HighImportance);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">KeInsertQueueDpc</span>(Dpc[i],<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeInitializeDpc</span>(<span style="color:#ec0000">&amp;</span>Dpc[i],DpcRoutine,<span style="color:#ec0000">&amp;</span>pSpinData);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		//此时只有一个核在工作
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;i <span style="color:#ec0000">&lt;</span> <span style="color:#008900">16</span>;i<span style="color:#ec0000">++</span>)//尝试16次
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> count <span style="color:#ec0000">=</span> <span style="color:#008900">1000000</span>;count <span style="color:#ec0000">&gt;</span> <span style="color:#008900">0</span>;count<span style="color:#ec0000">--</span>);//延时
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(g_Spin.SpinRefCount <span style="color:#ec0000">==</span> ulNumberOfActiveCpu <span style="color:#ec0000">-</span> <span style="color:#008900">1</span>)//等待DpcRoutine全部执行到死锁
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">addr</span>(data);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeReleaseSpinLock</span>(<span style="color:#ec0000">&amp;</span>g_Spin.SpinLock,NewIrql);//恢复多核运行
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">_enable</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="进行ssdt-hook">进行SSDT hook</h4>
<p>  在注册表<code>Services\\TsFltMgr thm=1</code>的情况下，或者Inline hook KiFastCallEntry失败的情况下，会进行SSDT表 hook</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">BeginSSDTHook</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> result <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>	PVOID MappedAddress <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PMDL mdl <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(serHookType <span style="color:#ec0000">==</span> HOOKTYPE_INLINE <span style="color:#ec0000">||</span> serHookType <span style="color:#ec0000">==</span> HOOKTYPE_KSINLINE)//已成功inline hook
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	serHookType <span style="color:#ec0000">=</span> HOOKTYPE_SSDT;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;i <span style="color:#ec0000">&lt;=</span> APINUMBER;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(DProxyTable[i] <span style="color:#ec0000">&amp;&amp;</span> DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ServiceIndex <span style="color:#ec0000">!=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span> <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>DProxyTable[i]<span style="color:#ec0000">-&gt;</span>IsInitialized)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">==</span> SSDT)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">int</span> index <span style="color:#ec0000">=</span> DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ServiceIndex;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(index <span style="color:#ec0000">!=</span> <span style="color:#008900">1023</span> <span style="color:#ec0000">&amp;&amp;</span> DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ProxyFunc <span style="color:#ec0000">&amp;&amp;</span> SSDTBase)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					PVOID MappedAddress <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>					PMDL mdl <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetWritablePage</span>(SSDTBase,<span style="color:#008900">4</span><span style="color:#ec0000">*</span>SSDTLimit,<span style="color:#ec0000">&amp;</span>MappedAddress);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(mdl)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						DProxyTable[i]<span style="color:#ec0000">-&gt;</span>OriginFuncAddr <span style="color:#ec0000">=</span> ((ULONG<span style="color:#ec0000">*</span>)SSDTBase)[index];
</span></span><span style="display:flex;"><span>						((ULONG<span style="color:#ec0000">*</span>)MappedAddress)[index] <span style="color:#ec0000">=</span> DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ProxyFunc;
</span></span><span style="display:flex;"><span>						<span style="color:#5f5fff">MmUnlockPages</span>(mdl);
</span></span><span style="display:flex;"><span>						<span style="color:#5f5fff">IoFreeMdl</span>(mdl);
</span></span><span style="display:flex;"><span>						result <span style="color:#ec0000">=</span> index;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">==</span> SSSDT)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">int</span> index <span style="color:#ec0000">=</span> DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ServiceIndex;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(index <span style="color:#ec0000">!=</span> <span style="color:#008900">1023</span> <span style="color:#ec0000">&amp;&amp;</span> DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ProxyFunc <span style="color:#ec0000">&amp;&amp;</span> ShadowSSDTBase)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					HANDLE CurProcessId <span style="color:#ec0000">=</span> <span style="color:#5f5fff">PsGetCurrentProcessId</span>();
</span></span><span style="display:flex;"><span>					HANDLE SmssProcessId <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetProcessIdByName</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;smss.exe&#34;</span>);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>dwcsrssId)//如果没有获取到csrss.exe的id
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(CurProcessId <span style="color:#ec0000">==</span> SmssProcessId)//使用smss.exe的SSSDT
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							mdl <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetWritablePage</span>(ShadowSSDTBase,<span style="color:#008900">4</span><span style="color:#ec0000">*</span>ShadowSSDTLimit,<span style="color:#ec0000">&amp;</span>MappedAddress);
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span>(mdl)
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								DProxyTable[i]<span style="color:#ec0000">-&gt;</span>OriginFuncAddr <span style="color:#ec0000">=</span> ((ULONG<span style="color:#ec0000">*</span>)ShadowSSDTBase)[index];
</span></span><span style="display:flex;"><span>								((ULONG<span style="color:#ec0000">*</span>)MappedAddress)[index] <span style="color:#ec0000">=</span> DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ProxyFunc;
</span></span><span style="display:flex;"><span>								<span style="color:#5f5fff">MmUnlockPages</span>(mdl);
</span></span><span style="display:flex;"><span>								<span style="color:#5f5fff">IoFreeMdl</span>(mdl);
</span></span><span style="display:flex;"><span>								result <span style="color:#ec0000">=</span> index;
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>					{//附加到csrss.exe
</span></span><span style="display:flex;"><span>						PVOID attachobj <span style="color:#ec0000">=</span> <span style="color:#5f5fff">AttachDriverToProcess</span>(dwcsrssId);
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(attachobj)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							mdl <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetWritablePage</span>(ShadowSSDTBase,<span style="color:#008900">4</span><span style="color:#ec0000">*</span>ShadowSSDTLimit,<span style="color:#ec0000">&amp;</span>MappedAddress);
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span>(mdl)
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								DProxyTable[i]<span style="color:#ec0000">-&gt;</span>OriginFuncAddr <span style="color:#ec0000">=</span> ((ULONG<span style="color:#ec0000">*</span>)ShadowSSDTBase)[index];
</span></span><span style="display:flex;"><span>								((ULONG<span style="color:#ec0000">*</span>)MappedAddress)[index] <span style="color:#ec0000">=</span> DProxyTable[i]<span style="color:#ec0000">-&gt;</span>ProxyFunc;
</span></span><span style="display:flex;"><span>								<span style="color:#5f5fff">MmUnlockPages</span>(mdl);
</span></span><span style="display:flex;"><span>								<span style="color:#5f5fff">IoFreeMdl</span>(mdl);
</span></span><span style="display:flex;"><span>								result <span style="color:#ec0000">=</span> index;
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>							<span style="color:#5f5fff">DetachDriverFromProcess</span>(attachobj);
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}	
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(result <span style="color:#ec0000">!=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>				DProxyTable[i]<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> AttachData
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	KAPC_STATE ApcState;
</span></span><span style="display:flex;"><span>	PVOID Process;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PVOID <span style="color:#5f5fff">AttachDriverToProcess</span>(HANDLE ProcessId)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PVOID Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	AttachData<span style="color:#ec0000">*</span> Buffer <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ProcessId <span style="color:#ec0000">==</span> <span style="color:#5f5fff">PsGetCurrentProcessId</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#008900">0xEEEEDDDD</span>;//自身标识
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ProcessId <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">PsLookupProcessByProcessId</span>(ProcessId,<span style="color:#ec0000">&amp;</span>Process)))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Buffer <span style="color:#ec0000">=</span> (AttachData<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(PagedPool,<span style="color:#ec0000">sizeof</span>(AttachData));
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Buffer)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ObDereferenceObject</span>(Process);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		Buffer<span style="color:#ec0000">-&gt;</span>Process <span style="color:#ec0000">=</span> Process;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeStackAttachProcess</span>(Process,<span style="color:#ec0000">&amp;</span>Buffer<span style="color:#ec0000">-&gt;</span>ApcState)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">DetachDriverFromProcess</span>(PVOID Buffer)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Buffer <span style="color:#ec0000">&amp;&amp;</span> (ULONG)Buffer <span style="color:#ec0000">!=</span> <span style="color:#008900">0xEEEEDDDD</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		AttachData<span style="color:#ec0000">*</span> data <span style="color:#ec0000">=</span> (AttachData<span style="color:#ec0000">*</span>)Buffer;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeUnstackDetachProcess</span>(<span style="color:#ec0000">&amp;</span>data<span style="color:#ec0000">-&gt;</span>ApcState);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(data<span style="color:#ec0000">-&gt;</span>Process);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="对重要回调进程回调线程回调映像加载回调的挂钩">对重要回调(进程回调、线程回调、映像加载回调)的挂钩</h4>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>/*
</span></span><span style="display:flex;"><span>	Sproxy Index：
</span></span><span style="display:flex;"><span>	普通api使用index 0-0x33 0x37-0x48 0x4A-0x69
</span></span><span style="display:flex;"><span>	52    CreateNotifyRoutine
</span></span><span style="display:flex;"><span>	53    ThreadNofify
</span></span><span style="display:flex;"><span>	54    ImageNotify
</span></span><span style="display:flex;"><span>	73    CreateNotifyRoutine2
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span><span style="color:#ec0000">enum</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	INDEX_KECALLBACK <span style="color:#ec0000">=</span> <span style="color:#008900">51</span>,
</span></span><span style="display:flex;"><span>	INDEX_PROCESS <span style="color:#ec0000">=</span> <span style="color:#008900">52</span>,
</span></span><span style="display:flex;"><span>	INDEX_THREAD <span style="color:#ec0000">=</span> <span style="color:#008900">53</span>,
</span></span><span style="display:flex;"><span>	INDEX_IMAGE <span style="color:#ec0000">=</span> <span style="color:#008900">54</span>,
</span></span><span style="display:flex;"><span>	INDEX_PROCESSEX <span style="color:#ec0000">=</span> <span style="color:#008900">73</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">HookImportantNotify</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DProxyTable[INDEX_PROCESS])
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DProxy<span style="color:#ec0000">*</span> Proxydata <span style="color:#ec0000">=</span> (DProxy<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#ec0000">sizeof</span>(DProxy));
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(Proxydata)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ApiName <span style="color:#ec0000">=</span> <span style="color:#008900">&#34;ProcessNotify&#34;</span>;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>TableIndex <span style="color:#ec0000">=</span> INDEX_PROCESS;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ProxyFuncAddr <span style="color:#ec0000">=</span> CreateNotifyRoutine1;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ServiceIndex <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeInitializeEvent</span>(<span style="color:#ec0000">&amp;</span>Proxydata<span style="color:#ec0000">-&gt;</span>Lock,SynchronizationEvent,FALSE);
</span></span><span style="display:flex;"><span>			DProxyTable[INDEX_PROCESS] <span style="color:#ec0000">=</span> Proxydata;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(DProxyTable[INDEX_PROCESS] <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>DProxyTable[INDEX_PROCESS]<span style="color:#ec0000">-&gt;</span>IsInitialized)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DProxyTable[INDEX_PROCESS]<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">=</span> CALLBACK;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">PsSetCreateProcessNotifyRoutine</span>(CreateProcessNotify,FALSE)))
</span></span><span style="display:flex;"><span>			DProxyTable[INDEX_PROCESS]<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DProxyTable[INDEX_PROCESSEX])
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DProxy<span style="color:#ec0000">*</span> Proxydata <span style="color:#ec0000">=</span> (DProxy<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#ec0000">sizeof</span>(DProxy));
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(Proxydata)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ApiName <span style="color:#ec0000">=</span> <span style="color:#008900">&#34;ProcessNotifyEx&#34;</span>;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>TableIndex <span style="color:#ec0000">=</span> INDEX_PROCESSEX;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ProxyFuncAddr <span style="color:#ec0000">=</span> CreateNotifyRoutine1Ex;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ServiceIndex <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeInitializeEvent</span>(<span style="color:#ec0000">&amp;</span>Proxydata<span style="color:#ec0000">-&gt;</span>Lock,SynchronizationEvent,FALSE);
</span></span><span style="display:flex;"><span>			DProxyTable[INDEX_PROCESSEX] <span style="color:#ec0000">=</span> Proxydata;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(DProxyTable[INDEX_PROCESSEX] <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>DProxyTable[INDEX_PROCESSEX]<span style="color:#ec0000">-&gt;</span>IsInitialized)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DProxyTable[INDEX_PROCESSEX]<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">=</span> CALLBACK;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">PsSetCreateProcessNotifyRoutineEx</span>(CreateProcessNotifyEx,FALSE)))
</span></span><span style="display:flex;"><span>			DProxyTable[INDEX_PROCESSEX]<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DProxyTable[INDEX_THREAD])
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DProxy<span style="color:#ec0000">*</span> Proxydata <span style="color:#ec0000">=</span> (DProxy<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#ec0000">sizeof</span>(DProxy));
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(Proxydata)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ApiName <span style="color:#ec0000">=</span> <span style="color:#008900">&#34;ThreadNotify&#34;</span>;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>TableIndex <span style="color:#ec0000">=</span> INDEX_THREAD;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ProxyFuncAddr <span style="color:#ec0000">=</span> CreateThreadNotify;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ServiceIndex <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeInitializeEvent</span>(<span style="color:#ec0000">&amp;</span>Proxydata<span style="color:#ec0000">-&gt;</span>Lock,SynchronizationEvent,FALSE);
</span></span><span style="display:flex;"><span>			DProxyTable[INDEX_THREAD] <span style="color:#ec0000">=</span> Proxydata;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(DProxyTable[INDEX_THREAD] <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>DProxyTable[INDEX_THREAD]<span style="color:#ec0000">-&gt;</span>IsInitialized)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DProxyTable[INDEX_THREAD]<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">=</span> CALLBACK;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">PsSetCreateThreadNotifyRoutine</span>(CreateThreadNotify,FALSE)))
</span></span><span style="display:flex;"><span>			DProxyTable[INDEX_THREAD]<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DProxyTable[INDEX_IMAGE])
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DProxy<span style="color:#ec0000">*</span> Proxydata <span style="color:#ec0000">=</span> (DProxy<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#ec0000">sizeof</span>(DProxy));
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(Proxydata)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ApiName <span style="color:#ec0000">=</span> <span style="color:#008900">&#34;ImageNotify&#34;</span>;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>TableIndex <span style="color:#ec0000">=</span> INDEX_IMAGE;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ProxyFuncAddr <span style="color:#ec0000">=</span> LoadImageNotify;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ServiceIndex <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeInitializeEvent</span>(<span style="color:#ec0000">&amp;</span>Proxydata<span style="color:#ec0000">-&gt;</span>Lock,SynchronizationEvent,FALSE);
</span></span><span style="display:flex;"><span>			DProxyTable[INDEX_IMAGE] <span style="color:#ec0000">=</span> Proxydata;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(DProxyTable[INDEX_IMAGE] <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>DProxyTable[INDEX_IMAGE]<span style="color:#ec0000">-&gt;</span>IsInitialized)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DProxyTable[INDEX_IMAGE]<span style="color:#ec0000">-&gt;</span>ServiceTableType <span style="color:#ec0000">=</span> CALLBACK;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">PsSetLoadImageNotifyRoutine</span>(LoadImageNotify,FALSE)))
</span></span><span style="display:flex;"><span>			DProxyTable[INDEX_IMAGE]<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Hook KeUserModeCallback</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">HookKeUserModeCallback</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Win32kBase)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>	IO_STATUS_BLOCK IoStatusBlock;
</span></span><span style="display:flex;"><span>	HANDLE SectionHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG ViewSize <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	HANDLE FileHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PVOID BaseAddress <span style="color:#ec0000">=</span> <span style="color:#008900">0x5000000</span>;
</span></span><span style="display:flex;"><span>	UNICODE_STRING UKeUserModeCallback;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DProxyTable[INDEX_KECALLBACK])
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DProxy<span style="color:#ec0000">*</span> Proxydata <span style="color:#ec0000">=</span> (DProxy<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#ec0000">sizeof</span>(DProxy));
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(Proxydata)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>IsInitialized <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ApiName <span style="color:#ec0000">=</span> <span style="color:#008900">&#34;ImageNotify&#34;</span>;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>TableIndex <span style="color:#ec0000">=</span> INDEX_KECALLBACK;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ProxyFuncAddr <span style="color:#ec0000">=</span> ProxyKeUserModeCallback;
</span></span><span style="display:flex;"><span>			Proxydata<span style="color:#ec0000">-&gt;</span>ServiceIndex <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeInitializeEvent</span>(<span style="color:#ec0000">&amp;</span>Proxydata<span style="color:#ec0000">-&gt;</span>Lock,SynchronizationEvent,FALSE);
</span></span><span style="display:flex;"><span>			DProxyTable[INDEX_KECALLBACK] <span style="color:#ec0000">=</span> Proxydata;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UKeUserModeCallback,<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">SystemRoot</span><span style="color:#008900">\\</span><span style="color:#008900">System32</span><span style="color:#008900">\\</span><span style="color:#008900">Win32k.sys&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#008900">L</span><span style="color:#008900">&#34;KeUserModeCallback&#34;</span>,OBJ_CASE_INSENSITIVE<span style="color:#ec0000">|</span>OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwOpenFile</span>(<span style="color:#ec0000">&amp;</span>FileHandle,GENERIC_READ,<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#ec0000">&amp;</span>IoStatusBlock,FILE_SHARE_READ,FILE_SYNCHRONOUS_IO_NONALERT);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Oa.ObjectName <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwCreateSection</span>(<span style="color:#ec0000">&amp;</span>SectionHandle,SECTION_MAP_EXECUTE,<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#ec0000">NULL</span>,PAGE_WRITECOPY,SEC_IMAGE);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwMapViewOfSection</span>(<span style="color:#ec0000">&amp;</span>SectionHandle,<span style="color:#5f5fff">NtCurrentProcess</span>(),<span style="color:#ec0000">&amp;</span>BaseAddress,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">&amp;</span>ViewSize,ViewUnmap,<span style="color:#008900">0</span>,PAGE_EXECUTE);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				BaseAddress <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ZwMapViewOfSection</span>(<span style="color:#ec0000">&amp;</span>SectionHandle,<span style="color:#5f5fff">NtCurrentProcess</span>(),<span style="color:#ec0000">&amp;</span>BaseAddress,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">&amp;</span>ViewSize,ViewUnmap,<span style="color:#008900">0</span>,PAGE_EXECUTE);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(BaseAddress)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DProxyTable[INDEX_KECALLBACK]<span style="color:#ec0000">-&gt;</span>IsInitialized)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			ULONG IatOffset <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetProcOffsetFromIat</span>(BaseAddress);
</span></span><span style="display:flex;"><span>			DProxyTable[INDEX_KECALLBACK]<span style="color:#ec0000">-&gt;</span>OriginFuncAddr <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExchangeMem</span>(IatOffset,Win32kBase,ProxyKeUserModeCallback);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(DProxyTable[INDEX_KECALLBACK]<span style="color:#ec0000">-&gt;</span>OriginFuncAddr)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				DProxyTable[INDEX_KECALLBACK]<span style="color:#ec0000">-&gt;</span>IsInitialized;
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwUnmapViewOfSection</span>(<span style="color:#5f5fff">NtCurrentProcess</span>(),BaseAddress);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>交换内存</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">ExchangeMem</span>(ULONG Offset,ULONG BaseAddress,ULONG NewValue)
</span></span><span style="display:flex;"><span>{//替换基址BaseAddress 偏移Offset 处的ULONG数据，返回原始数据
</span></span><span style="display:flex;"><span>	HANDLE CurProcessId <span style="color:#ec0000">=</span> <span style="color:#5f5fff">PsGetCurrentProcessId</span>();
</span></span><span style="display:flex;"><span>	HANDLE SmssProcessId <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetProcessIdByName</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;smss.exe&#34;</span>);
</span></span><span style="display:flex;"><span>	ULONG OriginValue <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	PMDL mdl <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>dwcsrssId)//如果没有获取到csrss.exe的id
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(CurProcessId <span style="color:#ec0000">==</span> SmssProcessId)//使用smss.exe的SSSDT
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			mdl <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetWritablePage</span>(BaseAddress<span style="color:#ec0000">+</span>Offset,<span style="color:#008900">16</span>,<span style="color:#ec0000">&amp;</span>MappedAddress);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(mdl)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				OriginValue <span style="color:#ec0000">=</span> <span style="color:#5f5fff">InterlockedExchange</span>(MappedAddress,NewValue);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">MmUnlockPages</span>(mdl);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">IoFreeMdl</span>(mdl);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{//附加到csrss.exe
</span></span><span style="display:flex;"><span>		PVOID attachobj <span style="color:#ec0000">=</span> <span style="color:#5f5fff">AttachDriverToProcess</span>(dwcsrssId);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(attachobj)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			mdl <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetWritablePage</span>(BaseAddress<span style="color:#ec0000">+</span>Offset,<span style="color:#008900">4</span>,<span style="color:#ec0000">&amp;</span>MappedAddress);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(mdl)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				OriginValue <span style="color:#ec0000">=</span> <span style="color:#5f5fff">InterlockedExchange</span>(MappedAddress,NewValue);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">MmUnlockPages</span>(mdl);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">IoFreeMdl</span>(mdl);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">DetachDriverFromProcess</span>(attachobj);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> OriginValue;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>获取函数Iat偏移</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">GetProcOffsetFromIat</span>(PVOID ImageBase,PCHAR ModuleName,PCHAR ApiName)
</span></span><span style="display:flex;"><span>{//ImageBase当前进程映像基址  ModuleName导入模块映像基址  ApiName导入函数名
</span></span><span style="display:flex;"><span>	ANSI_STRING AApiName;
</span></span><span style="display:flex;"><span>	UNICODE_STRING UApiname;
</span></span><span style="display:flex;"><span>	PIMAGE_IMPORT_DESCRIPTOR ImportModuleDirectory;
</span></span><span style="display:flex;"><span>	ULONG ObjProcAddr;
</span></span><span style="display:flex;"><span>	ULONG Offset <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	PCHAR ImportedName;
</span></span><span style="display:flex;"><span>	PIMAGE_THUNK_DATA FunctionNameList;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitAnsiString</span>(<span style="color:#ec0000">&amp;</span>AApiName,ApiName);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">RtlAnsiStringToUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UApiname,<span style="color:#ec0000">&amp;</span>AApiName,TRUE)))
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	ObjProcAddr <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MmGetSystemRoutineAddress</span>(<span style="color:#ec0000">&amp;</span>UApiname);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlFreeUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UApiname);
</span></span><span style="display:flex;"><span>	ImportModuleDirectory <span style="color:#ec0000">=</span> (PIMAGE_IMPORT_DESCRIPTOR)<span style="color:#5f5fff">RtlImageDirectoryEntryToData</span>(ImageBase,TRUE,IMAGE_DIRECTORY_ENTRY_IMPORT);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>ImportModuleDirectory)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span> (;(ImportModuleDirectory<span style="color:#ec0000">-&gt;</span>Name <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span>) <span style="color:#ec0000">&amp;&amp;</span> (ImportModuleDirectory<span style="color:#ec0000">-&gt;</span>FirstThunk <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span>);ImportModuleDirectory<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ImportedName <span style="color:#ec0000">=</span> (PCHAR)ImageBase <span style="color:#ec0000">+</span> ImportModuleDirectory<span style="color:#ec0000">-&gt;</span>Name;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">stricmp</span>(ModuleName,ImportedName))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			FunctionNameList <span style="color:#ec0000">=</span> (PIMAGE_THUNK_DATA)((UCHAR<span style="color:#ec0000">*</span>)ImageBase<span style="color:#ec0000">+</span>ImportModuleDirectory<span style="color:#ec0000">-&gt;</span>FirstThunk);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">while</span>(<span style="color:#ec0000">*</span>FunctionNameList <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>((<span style="color:#ec0000">*</span>FunctionNameList) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x80000000</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(FunctionNameList<span style="color:#ec0000">-&gt;</span>u1.Function <span style="color:#ec0000">==</span> ObjProcAddr)
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">return</span> (UCHAR<span style="color:#ec0000">*</span>)FunctionNameList <span style="color:#ec0000">-</span> (UCHAR<span style="color:#ec0000">*</span>)ImageBase;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					IMAGE_IMPORT_BY_NAME <span style="color:#ec0000">*</span>pe_name <span style="color:#ec0000">=</span> (IMAGE_IMPORT_BY_NAME<span style="color:#ec0000">*</span>)((PCHAR)ImageBase <span style="color:#ec0000">+</span> <span style="color:#ec0000">*</span>FunctionNameList);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(pe_name<span style="color:#ec0000">-&gt;</span>Name[<span style="color:#008900">0</span>] <span style="color:#ec0000">==</span> <span style="color:#008900">&#39;K&#39;</span> <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span><span style="color:#5f5fff">stricmp</span>(pe_name<span style="color:#ec0000">-&gt;</span>Name,<span style="color:#008900">&#34;KeUserModeCallback&#34;</span>))
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">return</span> (UCHAR<span style="color:#ec0000">*</span>)FunctionNameList <span style="color:#ec0000">-</span> (UCHAR<span style="color:#ec0000">*</span>)ImageBase;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				FunctionNameList<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="另一种方式获取shadowssdt信息">另一种方式获取ShadowSSDT信息</h4>
<p>  当常规方式获取SSSDT失败时，会临时设置ZwSetSystemInformation的过滤函数捕获系统设置服务表(<code>SYSTEM_INFORMATION_CLASS =SystemExtendServiceTableInformation</code>)，</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">TryAnotherWayToGetShadowSSDT</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">AddPrevFilter</span>(EZwSetSystemInformation,ZwSetSystemInformationFilter1,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG OldKeAddSystemServiceTable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">ZwSetSystemInformationFilter1</span>(FilterPacket<span style="color:#ec0000">*</span> Packet)
</span></span><span style="display:flex;"><span>{//改EAT以获取SSSDT
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>ShadowSSDTBase <span style="color:#ec0000">&amp;&amp;</span> Packet<span style="color:#ec0000">-&gt;</span>Params[<span style="color:#008900">0</span>] <span style="color:#ec0000">==</span> SystemExtendServiceTableInformation <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>OldKeAddSystemServiceTable)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		OldKeAddSystemServiceTable <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExchangeEat</span>(NtosBase,NewKeAddSystemServiceTable);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(OldKeAddSystemServiceTable)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Packet<span style="color:#ec0000">-&gt;</span>TagSlot[Packet<span style="color:#ec0000">-&gt;</span>CurrentSlot] <span style="color:#ec0000">=</span> <span style="color:#008900">0xABCDEEEE</span>;//用于标记
</span></span><span style="display:flex;"><span>			Packet<span style="color:#ec0000">-&gt;</span>PostFilterSlot[Packet<span style="color:#ec0000">-&gt;</span>CurrentSlot] <span style="color:#ec0000">=</span> ZwSetSystemInformationFilter2;
</span></span><span style="display:flex;"><span>			Packet<span style="color:#ec0000">-&gt;</span>UsedSlotCount<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> SYSMON_PASSTONEXT;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">ZwSetSystemInformationFilter2</span>(FilterPacket<span style="color:#ec0000">*</span> Packet)
</span></span><span style="display:flex;"><span>{//获取之后恢复EAT
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Packet<span style="color:#ec0000">-&gt;</span>TagSlot[Packet<span style="color:#ec0000">-&gt;</span>CurrentSlot] <span style="color:#ec0000">==</span> <span style="color:#008900">0xABCDEEEE</span>)//检查标记
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(serHookType <span style="color:#ec0000">!=</span> <span style="color:#008900">1</span> <span style="color:#ec0000">&amp;&amp;</span> serHookType <span style="color:#ec0000">!=</span> <span style="color:#008900">3</span>)//是否SSDT型Hook
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">BeginSSDTHook</span>();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> SYSMON_PASSTONEXT;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">KeAddSystemServiceTable</span>(PULONG_PTR Base,PULONG Count,ULONG Limit,PUCHAR Number,ULONG Index)
</span></span><span style="display:flex;"><span>{//获取SSSDT
</span></span><span style="display:flex;"><span>	RTL_PROCESS_MODULE_INFORMATION ProcessInfo;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlZeroMemory</span>(<span style="color:#ec0000">&amp;</span>ProcessInfo,<span style="color:#ec0000">sizeof</span>(ProcessInfo));
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>ShadowSSDTBase <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">GetProcessInfoByFileName</span>(<span style="color:#008900">&#34;win32k.sys&#34;</span>,<span style="color:#ec0000">&amp;</span>ProcessInfo) <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		Base <span style="color:#ec0000">&gt;=</span> ProcessInfo.ImageBase <span style="color:#ec0000">&amp;&amp;</span> Base <span style="color:#ec0000">&lt;=</span> ProcessInfo.ImageBase<span style="color:#ec0000">+</span>ProcessInfo.ImageSize)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Win32kBase <span style="color:#ec0000">=</span> ProcessInfo.ImageBase;
</span></span><span style="display:flex;"><span>		Win32kSize <span style="color:#ec0000">=</span> ProcessInfo.ImageSize;
</span></span><span style="display:flex;"><span>		ShadowSSDTBase <span style="color:#ec0000">=</span> Base;
</span></span><span style="display:flex;"><span>		ShadowSSDTLimit <span style="color:#ec0000">=</span> Limit;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExchangeEat</span>(NtosBase,OldKeAddSystemServiceTable);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span>  <span style="color:#5f5fff">OldKeAddSystemServiceTable</span>(Base,Count,Limit,Number,Index);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ULONG <span style="color:#5f5fff">ExchangeEat</span>(ULONG ImageBase,ULONG NewFunc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PVOID Address <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MiLocateExportName</span>(ImageBase,<span style="color:#008900">&#34;KeAddSystemServiceTable&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Address)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#5f5fff">ExchangeMem</span>(<span style="color:#008900">0</span>,Address,NewFunc);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="tssyskitsys分析">TsSysKit.sys分析</h2>
<p>  该驱动为qq管家穿透驱动，提供文件、注册表穿透，和解锁文件、驱动加载、句柄、进程等操作，导出接口给其他驱动使用，设备名<code>\\Device\\TSSysKit</code>，符号名<code>\\DosDevices\\TSSysKit</code>。加密手段：Rabbit算法、MD5算法。</p>
<h3 id="驱动入口driverentry-3">驱动入口DriverEntry</h3>
<ul>
<li>获取系统版本_1</li>
<li>获取EPROCESS的ObjectTypeIndex  (win7以前 0x1C  win8 0x1F  Win8.1 0x1E)</li>
<li>创建\Device\TSSysKit设备和\DosDevices\TSSysKit符号链接</li>
<li>设置DeviceExtension为通信接口（Interface函数指针）</li>
<li>注册IRP_MJ_CREATE、IRP_MJ_CLOSE、IRP_MJ_DEVICE_CONTROL派遣例程为DefaultDispatch</li>
<li>获取CmpKeyObject、DeviceObject的OBJECT_TYPE_INITIALIZER GetCmpKeyObjectInitializerFunc	GetDeviceObjectInitializerFunc</li>
<li>获取ZwQueryVirtualMemory、IoVolumeDeviceToDosName、PsGetProcessSectionBaseAddress地址和NtQueryVirtualMemory的index</li>
<li>检测加载者是否为Ntos (CheckIopLoadDriver)</li>
<li>执行开机删除操作(DoDeleteJob)  删除ShutdownRecord.ini指定的文件</li>
</ul>
<p>检测加载者是否为Ntos，顺带保存IopLoadDriver</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">CheckIopLoadDriver</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> IopLoadDriverNext; // esi@2
</span></span><span style="display:flex;"><span>	PRTL_PROCESS_MODULES modules; // ebx@5
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> IopLoadDriver; // esi@8
</span></span><span style="display:flex;"><span>	PVOID Base; // eax@9
</span></span><span style="display:flex;"><span>	PVOID Callers[<span style="color:#008900">4</span>]; // [sp+8h] [bp-18h]@1
</span></span><span style="display:flex;"><span>	BOOL ret; // [sp+18h] [bp-8h]@1
</span></span><span style="display:flex;"><span>	ULONG SystemInformationLength; // [sp+1Ch] [bp-4h]@1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Callers[<span style="color:#008900">0</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	Callers[<span style="color:#008900">1</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	Callers[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	Callers[<span style="color:#008900">3</span>] <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	ret <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	SystemInformationLength <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">::</span>IopLoadDriver <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> ( <span style="color:#5f5fff">RtlWalkFrameChain</span>(Callers, <span style="color:#008900">4u</span>, <span style="color:#008900">0</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">4</span> ) 
</span></span><span style="display:flex;"><span>		// [0]=RtlWalkFrameChain next
</span></span><span style="display:flex;"><span>		// [1]=DriverEntry
</span></span><span style="display:flex;"><span>		// [2]=IopLoadDriver
</span></span><span style="display:flex;"><span>		// [3]=IopInitializeSystemDrivers
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		IopLoadDriverNext <span style="color:#ec0000">=</span> Callers[<span style="color:#008900">3</span>];
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> ( <span style="color:#5f5fff">MmIsAddressValid</span>(Callers[<span style="color:#008900">3</span>]) )
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span> ( IopLoadDriverNext <span style="color:#ec0000">&gt;=</span> MmUserProbeAddress <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(IopLoadDriverNext <span style="color:#ec0000">-</span> <span style="color:#008900">5</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">0xE8u</span> )// call ***
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				SystemInformationLength <span style="color:#ec0000">=</span> <span style="color:#ec0000">sizeof</span>(SYSTEM_MODULE_INFORMATION) <span style="color:#ec0000">+</span> <span style="color:#008900">3</span> <span style="color:#ec0000">*</span> <span style="color:#ec0000">sizeof</span>(RTL_PROCESS_MODULE_INFORMATION);
</span></span><span style="display:flex;"><span>				modules <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePoolWithTag</span>(<span style="color:#008900">0</span>, SystemInformationLength, <span style="color:#ec0000">&#39;</span><span style="color:#ec0000">!</span>KIT<span style="color:#ec0000">&#39;</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span> ( modules )
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">memset</span>(modules, <span style="color:#008900">0</span>, SystemInformationLength);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span> ( <span style="color:#5f5fff">ZwQuerySystemInformation</span>(SystemModuleInformation,modules,SystemInformationLength,<span style="color:#ec0000">&amp;</span>SystemInformationLength) <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">0</span> )
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span> ( modules<span style="color:#ec0000">-&gt;</span>NumberOfModules )
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							IopLoadDriver <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(IopLoadDriverNext <span style="color:#ec0000">-</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">+</span> IopLoadDriverNext;
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span> ( <span style="color:#5f5fff">MmIsAddressValid</span>(IopLoadDriver) )
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								Base <span style="color:#ec0000">=</span> modules<span style="color:#ec0000">-&gt;</span>Modules[<span style="color:#008900">0</span>].ImageBase;
</span></span><span style="display:flex;"><span>								<span style="color:#ec0000">if</span> ( IopLoadDriver <span style="color:#ec0000">&gt;=</span> Base <span style="color:#ec0000">&amp;&amp;</span> IopLoadDriver <span style="color:#ec0000">&lt;=</span> (Base <span style="color:#ec0000">+</span> modules<span style="color:#ec0000">-&gt;</span>Modules[<span style="color:#008900">0</span>].ImageSize) )
</span></span><span style="display:flex;"><span>								{                               // 检测IopLoadDriver是否在ntos中
</span></span><span style="display:flex;"><span>									<span style="color:#ec0000">::</span>IopLoadDriver <span style="color:#ec0000">=</span> IopLoadDriver;
</span></span><span style="display:flex;"><span>									ret <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>								}
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">ExFreePool</span>(modules);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>执行删除任务 DoDeleteJob，如果腾讯安装目录存在ShutdownRecord.ini文件则删除该文件，解析文件列表中指定的文件并逐个删除，其中解析ini的api、文件操作都是自己实现的。删除方式采用NtSetInformationFile 置FileDispositionInformation。ShutdownRecord.ini格式：</p>
<pre tabindex="0"><code>[DELETEFILECOUNT]
Count=3
[DELETEFILELIST]
0=0.txt
1=1.txt
2=2.txt

enum
{
	WIN2000=1,
	WINXP=2,
	WINXPSP3=3,
	WINVISTA=4,
	WIN7=5,
	WIN8=7,
	WIN8_1=8,
	WIN10=9,
	UNKNOWN=10,
};
</code></pre><h3 id="驱动接口interface-1">驱动接口Interface</h3>
<h4 id="deviceextension接口-1">DeviceExtension接口</h4>
<p>DeviceObject-&gt;DeviceExtension(=Interface)  通过制定序号返回对应函数指针，穿透函数内部在ObOpenObjectByName前后会保存和恢复注册表Objectinitializer：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>FARPROC <span style="color:#5f5fff">Interface</span>(intindex)
</span></span><span style="display:flex;"><span>{//注意下面的函数都是自己实现的穿透函数
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">switch</span>(index)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">1</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> NtOpenKey;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">2</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> NtQueryValueKey;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">3</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> NtSetValueKeyEx;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">4</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> NtDeleteValueKey;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">5</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> NtDeleteKey;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">20</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> IopCreateFile;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">21</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> NtReadFile;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">22</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> NtWriteFile;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">23</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> NtSetInformationFile;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">24</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> NtQueryInformationFile;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">25</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> NtQueryDirectoryFile;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>函数原型：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#008900">0</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtCreateKey</span>(PHANDLE KeyHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, ULONG TitleIndex, PUNICODE_STRING Class, ULONG CreateOptions, PULONG Disposition)
</span></span><span style="display:flex;"><span><span style="color:#008900">1</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtOpenKey</span>(PHANDLE KeyHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes)
</span></span><span style="display:flex;"><span><span style="color:#008900">2</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtQueryValueKey</span>(HANDLE KeyHandle, PUNICODE_STRING ValueName, KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, PVOID KeyValueInformation, ULONG Length, PULONG ResultLength)
</span></span><span style="display:flex;"><span><span style="color:#008900">3</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtSetValueKeyEx</span>(HANDLE Handle, PUNICODE_STRING ValueName, ULONG Type, PVOID Data, ULONG DataSize)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">和</span>NtSetValueKey的用法类似<span style="color:#ec0000">，只是没有</span>TitleIndex这个参数
</span></span><span style="display:flex;"><span><span style="color:#008900">4</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtDeleteValueKey</span>(HANDLE KeyHandle, PUNICODE_STRING ValueName)
</span></span><span style="display:flex;"><span><span style="color:#008900">5</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtDeleteKey</span>(HANDLE KeyHandle)
</span></span><span style="display:flex;"><span><span style="color:#008900">20</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">IopCreateFile</span>(PHANDLE FileHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PIO_STATUS_BLOCK IoStatusBlock, PLARGE_INTEGER AllocationSize, ULONG FileAttributes, ULONG ShareAccess, ULONG Disposition, ULONG CreateOptions, PVOID EaBuffer, ULONG EaLength, CREATE_FILE_TYPE CreateFileType, PVOID ExtraCreateParameters, ULONG Options, ULONG InternalFlags, PVOID DeviceObject)
</span></span><span style="display:flex;"><span><span style="color:#008900">21</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtReadFile</span>(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, PVOID Buffer, ULONG Length, PLARGE_INTEGER ByteOffset, PULONG Key)
</span></span><span style="display:flex;"><span><span style="color:#008900">22</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtWriteFile</span>(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, PVOID Buffer, ULONG Length, PLARGE_INTEGER ByteOffset, PULONG Key)
</span></span><span style="display:flex;"><span><span style="color:#008900">23</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtSetInformationFile</span>(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PVOID FileInformation, ULONG Length, FILE_INFORMATION_CLASS FileInformationClass, BOOL DelCurrentFile)
</span></span><span style="display:flex;"><span><span style="color:#008900">24</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtQueryInformationFile</span>(HANDLE FileHandle, PIO_STATUS_BLOCK IoStatusBlock, PVOID FileInformation, ULONG Length, FILE_INFORMATION_CLASS FileInformationClass, BOOL DelCurrentFile)
</span></span><span style="display:flex;"><span><span style="color:#008900">25</span><span style="color:#ec0000">：</span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtQueryDirectoryFile</span>(HANDLE FileHandle, HANDLE Event, PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext, PIO_STATUS_BLOCK IoStatusBlock, PVOID FileInformation, ULONG Length, FILE_INFORMATION_CLASS FileInformationClass, BOOLEAN ReturnSingleEntry, PUNICODE_STRING FileName, BOOLEAN RestartScan)
</span></span></code></pre></div><p>与WRK代码异同点:<br>
  注册表穿透操作是使用Cm<em>函数实现Nt</em>函数，而文件穿透操作则基本和WRK代码一致，Iop*函数最大程度的实现内联。
这些实现中和WRK主要区别在于：去掉了AccessMode=UserMode分支、和ObReferenceObjectByName调用前后重置ObjectInitializer
NtReadFile实现额外处理了IoCallDriver返回文件锁定（STATUS_FILE_LOCK_CONFLICT）的处理，此时通过创建文件映射实现读取</p>
<p>重置/保存注册表对象ObjectInitialzer例程</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ec0000">enum</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	EClose,
</span></span><span style="display:flex;"><span>	EDelete,
</span></span><span style="display:flex;"><span>	EParse,
</span></span><span style="display:flex;"><span>	ESecurtiy,
</span></span><span style="display:flex;"><span>	EQueryName,
</span></span><span style="display:flex;"><span>	EOpen,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">ReplaceObjectinitializer</span>(<span style="color:#5f5fff">int</span> Type,FARPROC<span style="color:#ec0000">*</span> OutFunc,BOOLEAN ResetOrRestore)
</span></span><span style="display:flex;"><span>{//重置/保存注册表对象ObjectInitialzer例程，用于ObOpenObjectByName执行前后
</span></span><span style="display:flex;"><span>	FARPROC<span style="color:#ec0000">*</span> Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Type <span style="color:#ec0000">&lt;</span><span style="color:#008900">0</span> <span style="color:#ec0000">||</span> Type <span style="color:#ec0000">&gt;=</span> ECmMax)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>RegObjectInitialzer[Type] <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>CmpKeyObjectType <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>OutFunc)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(VersionIndex <span style="color:#ec0000">&gt;=</span> WIN2000 <span style="color:#ec0000">&amp;&amp;</span> VersionIndex <span style="color:#ec0000">&lt;=</span> WINXPSP3)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">switch</span>(Type)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">EClose</span>:
</span></span><span style="display:flex;"><span>				Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_XP)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.CloseProcedure;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">EDelete</span>:
</span></span><span style="display:flex;"><span>				Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_XP)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.DeleteProcedure;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">EParse</span>:
</span></span><span style="display:flex;"><span>				Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_XP)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.ParseProcedure;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">ESecurity</span>:
</span></span><span style="display:flex;"><span>				Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_XP)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.SecurityProcedure;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">EQueryName</span>:
</span></span><span style="display:flex;"><span>				Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_XP)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.QueryNameProcedure;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">EOpen</span>:
</span></span><span style="display:flex;"><span>				Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_XP)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.OpenProcedure;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(VersionIndex <span style="color:#ec0000">&gt;=</span> WINVISTA <span style="color:#ec0000">&amp;&amp;</span> VersionIndex <span style="color:#ec0000">&lt;=</span> WIN10)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">switch</span>(Type)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">EClose</span>:
</span></span><span style="display:flex;"><span>			Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_WIN7)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.CloseProcedure;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">EDelete</span>:
</span></span><span style="display:flex;"><span>			Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_WIN7)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.DeleteProcedure;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">EParse</span>:
</span></span><span style="display:flex;"><span>			Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_WIN7)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.ParseProcedure;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">ESecurity</span>:
</span></span><span style="display:flex;"><span>			Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_WIN7)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.SecurityProcedure;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">EQueryName</span>:
</span></span><span style="display:flex;"><span>			Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_WIN7)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.QueryNameProcedure;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">EOpen</span>:
</span></span><span style="display:flex;"><span>			Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>((POBJECT_TYPE_WIN7)CmpKeyObjectType)<span style="color:#ec0000">-&gt;</span>TypeInfo.OpenProcedure;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ResetOrRestore)
</span></span><span style="display:flex;"><span>	{//Get
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">*</span>Initailier <span style="color:#ec0000">!=</span> RegObjectInitialzer[Type])
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">*</span>OutFunc <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>Initailier;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">*</span>Initailier <span style="color:#ec0000">=</span> RegObjectInitialzer[Type];
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{//Set
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">*</span>OutFunc <span style="color:#ec0000">!=</span> <span style="color:#ec0000">*</span>Initailier)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">*</span>Initailier <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>OutFunc;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>NtCreateKey</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>TSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtCreateKey</span>(PHANDLE KeyHandle,ACCESS_MASK DesiredAccess,POBJECT_ATTRIBUTES ObjectAttributes,ULONG TitleIndex,PUNICODE_STRING Class,ULONG CreateOptions,PULONG Disposition)
</span></span><span style="display:flex;"><span>{//
</span></span><span style="display:flex;"><span>	NTSTATUS            status;
</span></span><span style="display:flex;"><span>	KPROCESSOR_MODE     mode;
</span></span><span style="display:flex;"><span>	CM_PARSE_CONTEXT    ParseContext;
</span></span><span style="display:flex;"><span>	PCM_KEY_BODY        KeyBody <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	HANDLE              Handle <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	UNICODE_STRING      CapturedObjectName <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	FARPROC				SavedInitializer <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	BOOL				NeedRestore <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlZeroMemory</span>(<span style="color:#ec0000">&amp;</span>ParseContext,<span style="color:#ec0000">sizeof</span>(ParseContext));
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">ARGUMENT_PRESENT</span>(Class)) 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ParseContext.Class <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>Class;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> ((CreateOptions <span style="color:#ec0000">&amp;</span> (REG_LEGAL_OPTION <span style="color:#ec0000">|</span> REG_OPTION_PREDEF_HANDLE)) <span style="color:#ec0000">!=</span> CreateOptions) 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_INVALID_PARAMETER;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	ParseContext.TitleIndex <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>	ParseContext.CreateOptions <span style="color:#ec0000">=</span> CreateOptions;
</span></span><span style="display:flex;"><span>	ParseContext.Disposition <span style="color:#ec0000">=</span> <span style="color:#008900">0L</span>;
</span></span><span style="display:flex;"><span>	ParseContext.CreateLink <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	ParseContext.PredefinedHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	ParseContext.CreateOperation <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>	ParseContext.OriginatingPoint <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">ReplaceObjectinitializer</span>(EParse,<span style="color:#ec0000">&amp;</span>SavedInitializer,<span style="color:#008900">1</span>))//还原为系统默认值
</span></span><span style="display:flex;"><span>		NeedRestore <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObOpenObjectByName</span>(ObjectAttributes,CmpKeyObjectType,mode,<span style="color:#ec0000">NULL</span>,DesiredAccess,(PVOID)<span style="color:#ec0000">&amp;</span>ParseContext,<span style="color:#ec0000">&amp;</span>Handle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(NeedRestore)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ReplaceObjectinitializer</span>(EParse,<span style="color:#ec0000">&amp;</span>SavedInitializer,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (status<span style="color:#ec0000">==</span>STATUS_PREDEFINED_HANDLE) 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(VersionIndex <span style="color:#ec0000">&lt;</span> WINVISTA)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(Handle,<span style="color:#008900">0</span>,CmpKeyObjectType,KernelMode,(PVOID <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">&amp;</span>KeyBody),<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">NT_SUCCESS</span>(status)) 
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				HANDLE TempHandle;
</span></span><span style="display:flex;"><span>				TempHandle <span style="color:#ec0000">=</span> (HANDLE)<span style="color:#5f5fff">LongToHandle</span>(KeyBody<span style="color:#ec0000">-&gt;</span>Type);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ObDereferenceObject</span>(KeyBody);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ZwClose</span>(Handle);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">*</span>KeyHandle <span style="color:#ec0000">=</span> TempHandle;
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			TempHandle <span style="color:#ec0000">=</span> (HANDLE)<span style="color:#5f5fff">LongToHandle</span>(KeyBody<span style="color:#ec0000">-&gt;</span>Type);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ObDereferenceObject</span>((PVOID)KeyBody);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">NtClose</span>(Handle);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">*</span>KeyHandle <span style="color:#ec0000">=</span> ParseContext.OriginatingPoint;
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">ARGUMENT_PRESENT</span>(Disposition)) 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>Disposition <span style="color:#ec0000">=</span> ParseContext.Disposition;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtOpenKey</span>(PHANDLE KeyHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	CM_PARSE_CONTEXT	ParseContext;
</span></span><span style="display:flex;"><span>	PVOID				Context;
</span></span><span style="display:flex;"><span>	HANDLE				Handle <span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	NTSTATUS			status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	PCM_KEY_BODY		KeyBody;
</span></span><span style="display:flex;"><span>	FARPROC				SavedInitializer <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	BOOL				NeedRestore <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlZeroMemory</span>(<span style="color:#ec0000">&amp;</span>ParseContext,<span style="color:#ec0000">sizeof</span>(CM_PARSE_CONTEXT));
</span></span><span style="display:flex;"><span>	Context <span style="color:#ec0000">=</span> VersionIndex<span style="color:#ec0000">!=</span>WIN2000<span style="color:#ec0000">?&amp;</span><span style="color:#ec0000">ParseContext</span>:<span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	ParseContext.CreateOperation <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">ReplaceObjectinitializer</span>(EParse,<span style="color:#ec0000">&amp;</span>SavedInitializer,<span style="color:#008900">1</span>))//还原为系统默认值
</span></span><span style="display:flex;"><span>		NeedRestore <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObOpenObjectByName</span>(ObjectAttributes,CmpKeyObjectType,KernelMode,<span style="color:#ec0000">NULL</span>,DesiredAccess,(PVOID)<span style="color:#ec0000">&amp;</span>Context,<span style="color:#ec0000">&amp;</span>Handle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(NeedRestore)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ReplaceObjectinitializer</span>(EParse,<span style="color:#ec0000">&amp;</span>SavedInitializer,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (status<span style="color:#ec0000">==</span>STATUS_PREDEFINED_HANDLE) 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(Handle,<span style="color:#008900">0</span>,CmpKeyObjectType,KernelMode,(PVOID <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">&amp;</span>KeyBody),<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">NT_SUCCESS</span>(status)) 
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">*</span>KeyHandle <span style="color:#ec0000">=</span> (HANDLE)<span style="color:#5f5fff">LongToHandle</span>(KeyBody<span style="color:#ec0000">-&gt;</span>Type);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ObDereferenceObject</span>((PVOID)KeyBody);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#ec0000">*</span>KeyHandle) 
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>			} 
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">else</span> 
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> STATUS_OBJECT_NAME_NOT_FOUND;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(Handle);
</span></span><span style="display:flex;"><span>	} 
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span> (<span style="color:#5f5fff">NT_SUCCESS</span>(status)) 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">*</span>KeyHandle <span style="color:#ec0000">=</span> Handle;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>NtQueryValueKey</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtQueryValueKey</span>(HANDLE KeyHandle,PUNICODE_STRING ValueName,KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass,
</span></span><span style="display:flex;"><span>    PVOID KeyValueInformation,ULONG Length,PULONG ResultLength)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    NTSTATUS    status;
</span></span><span style="display:flex;"><span>    PCM_KEY_BODY   KeyBody <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>    KPROCESSOR_MODE mode;
</span></span><span style="display:flex;"><span>	UNICODE_STRING LocalValueName <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>ValueName <span style="color:#ec0000">||</span> (KeyValueInformationClass <span style="color:#ec0000">!=</span> KeyValueBasicInformation <span style="color:#ec0000">&amp;&amp;</span> KeyValueInformationClass <span style="color:#ec0000">!=</span> KeyValueFullInformation
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">&amp;&amp;</span> KeyValueInformationClass <span style="color:#ec0000">!=</span> KeyValuePartialInformation <span style="color:#ec0000">&amp;&amp;</span> KeyValueInformationClass <span style="color:#ec0000">!=</span> KeyValueFullInformationAlign64 <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		KeyValueInformationClass <span style="color:#ec0000">!=</span> KeyValuePartialInformationAlign64))
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_INVALID_PARAMETER;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(CmMatchData[VersionIndex][ECmQueryValueKey].InitFlag <span style="color:#ec0000">&amp;&amp;</span> CmMatchData[VersionIndex][ECmQueryValueKey].FuncAddr)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		mode <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeGetPreviousMode</span>();
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(KeyHandle,KEY_QUERY_VALUE,CmpKeyObjectType,mode,(PVOID <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">&amp;</span>KeyBody),<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		LocalValueName <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>ValueName;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">NT_SUCCESS</span>(status)) 
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">switch</span>(VersionIndex)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN2000</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXP</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXPSP3</span>:
</span></span><span style="display:flex;"><span>				CmMatchData[VersionIndex][ECmQueryValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody<span style="color:#ec0000">-&gt;</span>KeyControlBlock,LocalValueName,
</span></span><span style="display:flex;"><span>					KeyValueInformationClass,KeyValueInformation,Length,ResultLength);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINVISTA</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7_1</span>:
</span></span><span style="display:flex;"><span>				CmMatchData[VersionIndex][ECmQueryValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody,KeyValueInformationClass,KeyValueInformation
</span></span><span style="display:flex;"><span>					Length,ResultLength,LocalValueName);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8</span>:
</span></span><span style="display:flex;"><span>				CmMatchData[VersionIndex][ECmQueryValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody,LocalValueName,KeyValueInformationClass,
</span></span><span style="display:flex;"><span>					KeyValueInformation,Length,ResultLength);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8_1</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN10</span>:
</span></span><span style="display:flex;"><span>				CmMatchData[VersionIndex][ECmQueryValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody,KeyValueInformationClass,KeyValueInformation,
</span></span><span style="display:flex;"><span>					Length,ResultLength,LocalValueName);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> STATUS_NOT_SUPPORTED;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> STATUS_NOT_SUPPORTED;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(KeyBody)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(KeyBody);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>NtSetValueKeyEx</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtSetValueKeyEx</span>(HANDLE KeyHandle,PUNICODE_STRING ValueName,ULONG Type,PVOID Data,ULONG DataSize)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS    status;
</span></span><span style="display:flex;"><span>	PCM_KEY_BODY   KeyBody <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	KPROCESSOR_MODE mode;
</span></span><span style="display:flex;"><span>	UNICODE_STRING LocalValueName <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	PWSTR CapturedName<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	OBJECT_HANDLE_INFORMATION HandleInformation <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(CmMatchData[VersionIndex][ECmQueryValueKey].InitFlag <span style="color:#ec0000">&amp;&amp;</span> CmMatchData[VersionIndex][ECmQueryValueKey].FuncAddr)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		mode <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeGetPreviousMode</span>();
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(KeyHandle,KEY_SET_VALUE,CmpKeyObjectType,mode,(PVOID <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">&amp;</span>KeyBody),<span style="color:#ec0000">&amp;</span>HandleInformation);
</span></span><span style="display:flex;"><span>		LocalValueName <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>ValueName;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">NT_SUCCESS</span>(status)) 
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">switch</span>(VersionIndex)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">switch</span>(VersionIndex)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN2000</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXP</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXPSP3</span>:
</span></span><span style="display:flex;"><span>					CmMatchData[VersionIndex][ECmSetValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody<span style="color:#ec0000">-&gt;</span>KeyControlBlock,<span style="color:#ec0000">&amp;</span>LocalValueName,Type,Data,DataSize);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINVISTA</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7_1</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8_1</span>:
</span></span><span style="display:flex;"><span>					CmMatchData[VersionIndex][ECmSetValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody,<span style="color:#ec0000">&amp;</span>LocalValueName,Type,Data,DataSize,<span style="color:#008900">0</span>,
</span></span><span style="display:flex;"><span>						HandleInformation.HandleAttributes <span style="color:#ec0000">&amp;</span> <span style="color:#008900">4</span>);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN10</span>:
</span></span><span style="display:flex;"><span>					CmMatchData[VersionIndex][ECmSetValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody,<span style="color:#ec0000">&amp;</span>LocalValueName,Type,Data,DataSize,<span style="color:#008900">0</span>,
</span></span><span style="display:flex;"><span>						HandleInformation.HandleAttributes <span style="color:#ec0000">&amp;</span> <span style="color:#008900">4</span>);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>					status <span style="color:#ec0000">=</span> STATUS_NOT_SUPPORTED;
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> STATUS_NOT_SUPPORTED;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(KeyBody)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(KeyBody);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>NtDeleteValueKey</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtDeleteValueKey</span>(HANDLE KeyHandle,PUNICODE_STRING ValueName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS    status;
</span></span><span style="display:flex;"><span>	PCM_KEY_BODY   KeyBody <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	KPROCESSOR_MODE mode;
</span></span><span style="display:flex;"><span>	UNICODE_STRING LocalValueName <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	PWSTR CapturedName<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	OBJECT_HANDLE_INFORMATION HandleInformation <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(CmMatchData[VersionIndex][ECmDeleteValueKey].InitFlag <span style="color:#ec0000">&amp;&amp;</span> CmMatchData[VersionIndex][ECmDeleteValueKey].FuncAddr)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		mode <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeGetPreviousMode</span>();
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(KeyHandle,KEY_SET_VALUE,CmpKeyObjectType,mode,(PVOID <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">&amp;</span>KeyBody),<span style="color:#ec0000">&amp;</span>HandleInformation);
</span></span><span style="display:flex;"><span>		LocalValueName <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>ValueName;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">NT_SUCCESS</span>(status)) 
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">switch</span>(VersionIndex)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN2000</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXP</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXPSP3</span>:
</span></span><span style="display:flex;"><span>					CmMatchData[VersionIndex][ECmDeleteValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody<span style="color:#ec0000">-&gt;</span>KeyControlBlock,LocalValueName);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINVISTA</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7_1</span>:
</span></span><span style="display:flex;"><span>					CmMatchData[VersionIndex][ECmDeleteValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody,KeyHandle,HandleInformation.HandleAttributes <span style="color:#ec0000">&amp;</span> <span style="color:#008900">4</span>,LocalValueName);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8</span>:
</span></span><span style="display:flex;"><span>					CmMatchData[VersionIndex][ECmDeleteValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody,LocalValueName,KeyHandle,HandleInformation.HandleAttributes <span style="color:#ec0000">&amp;</span> <span style="color:#008900">4</span>);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8_1</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN10</span>:
</span></span><span style="display:flex;"><span>					CmMatchData[VersionIndex][ECmDeleteValueKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody,<span style="color:#ec0000">&amp;</span>LocalValueName,Type,Data,DataSize,<span style="color:#008900">0</span>,
</span></span><span style="display:flex;"><span>						HandleInformation.HandleAttributes <span style="color:#ec0000">&amp;</span> <span style="color:#008900">4</span>);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>					status <span style="color:#ec0000">=</span> STATUS_NOT_SUPPORTED;
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> STATUS_NOT_SUPPORTED;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(KeyBody)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(KeyBody);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>NtDeleteKey</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NtDeleteKey</span>(HANDLE KeyHandle)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS    status;
</span></span><span style="display:flex;"><span>	PCM_KEY_BODY   KeyBody <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	KPROCESSOR_MODE mode;
</span></span><span style="display:flex;"><span>	UNICODE_STRING LocalValueName <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	PWSTR CapturedName<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	OBJECT_HANDLE_INFORMATION HandleInformation <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(CmMatchData[VersionIndex][ECmDeleteKey].InitFlag <span style="color:#ec0000">&amp;&amp;</span> CmMatchData[VersionIndex][ECmDeleteKey].FuncAddr)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		mode <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeGetPreviousMode</span>();
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(KeyHandle,KEY_SET_VALUE,CmpKeyObjectType,mode,(PVOID <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">&amp;</span>KeyBody),<span style="color:#ec0000">&amp;</span>HandleInformation);
</span></span><span style="display:flex;"><span>		LocalValueName <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>ValueName;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> (<span style="color:#5f5fff">NT_SUCCESS</span>(status)) 
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">switch</span>(VersionIndex)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN2000</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXP</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXPSP3</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WINVISTA</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7_1</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8_1</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN10</span>:
</span></span><span style="display:flex;"><span>				CmMatchData[VersionIndex][ECmDeleteKey].<span style="color:#5f5fff">FuncAddr</span>(KeyBody);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> STATUS_NOT_SUPPORTED;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> STATUS_NOT_SUPPORTED;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(KeyBody)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(KeyBody);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>IopCreateFile代码基本和WRK一致，区别在于2点：</p>
<ul>
<li>OPEN_PACKET结构不同</li>
<li>ObOpenObjectByName调用之前会将IoFileObjectType的ObjectInitailier重置为系统初始值</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>// WIN2000
</span></span><span style="display:flex;"><span>// WINXP
</span></span><span style="display:flex;"><span>// WINXPSP3
</span></span><span style="display:flex;"><span>#pragma pack(push)
</span></span><span style="display:flex;"><span>#pragma pack(8)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> _OPEN_PACKET_XP
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	CSHORT Type;
</span></span><span style="display:flex;"><span>	CSHORT Size;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT FileObject;
</span></span><span style="display:flex;"><span>	NTSTATUS FinalStatus;
</span></span><span style="display:flex;"><span>	ULONG_PTR Information;
</span></span><span style="display:flex;"><span>	ULONG ParseCheck;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT RelatedFileObject;
</span></span><span style="display:flex;"><span>	LARGE_INTEGER AllocationSize;
</span></span><span style="display:flex;"><span>	ULONG CreateOptions;
</span></span><span style="display:flex;"><span>	USHORT FileAttributes;
</span></span><span style="display:flex;"><span>	USHORT ShareAccess;
</span></span><span style="display:flex;"><span>	PVOID EaBuffer;
</span></span><span style="display:flex;"><span>	ULONG EaLength;
</span></span><span style="display:flex;"><span>	ULONG Options;
</span></span><span style="display:flex;"><span>	ULONG Disposition;
</span></span><span style="display:flex;"><span>	PFILE_BASIC_INFORMATION BasicInformation;
</span></span><span style="display:flex;"><span>	PFILE_NETWORK_OPEN_INFORMATION NetworkInformation;
</span></span><span style="display:flex;"><span>	CREATE_FILE_TYPE CreateFileType;
</span></span><span style="display:flex;"><span>	PVOID ExtraCreateParameters;
</span></span><span style="display:flex;"><span>	BOOLEAN Override;
</span></span><span style="display:flex;"><span>	BOOLEAN QueryOnly;
</span></span><span style="display:flex;"><span>	BOOLEAN DeleteOnly;
</span></span><span style="display:flex;"><span>	BOOLEAN FullAttributes;
</span></span><span style="display:flex;"><span>	PDUMMY_FILE_OBJECT LocalFileObject;
</span></span><span style="display:flex;"><span>	BOOLEAN TraversedMountPoint;
</span></span><span style="display:flex;"><span>	ULONG           InternalFlags;
</span></span><span style="display:flex;"><span>	PDEVICE_OBJECT  TopDeviceObjectHint;
</span></span><span style="display:flex;"><span>} OPEN_PACKET_XP, <span style="color:#ec0000">*</span>POPEN_PACKET_XP;
</span></span><span style="display:flex;"><span>#pragma pack(pop)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// WINVISTA
</span></span><span style="display:flex;"><span>// WIN7
</span></span><span style="display:flex;"><span>// WIN7_1
</span></span><span style="display:flex;"><span>#pragma pack(push)
</span></span><span style="display:flex;"><span>#pragma pack(8)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> _OPEN_PACKET_WIN7
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	CSHORT Type;
</span></span><span style="display:flex;"><span>	CSHORT Size;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT FileObject;
</span></span><span style="display:flex;"><span>	NTSTATUS FinalStatus;
</span></span><span style="display:flex;"><span>	ULONG_PTR Information;
</span></span><span style="display:flex;"><span>	ULONG ParseCheck;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT RelatedFileObject;
</span></span><span style="display:flex;"><span>	POBJECT_ATTRIBUTES OriginalAttributes;
</span></span><span style="display:flex;"><span>	LARGE_INTEGER AllocationSize;
</span></span><span style="display:flex;"><span>	ULONG CreateOptions;
</span></span><span style="display:flex;"><span>	USHORT FileAttributes;
</span></span><span style="display:flex;"><span>	USHORT ShareAccess;
</span></span><span style="display:flex;"><span>	PVOID EaBuffer;
</span></span><span style="display:flex;"><span>	ULONG EaLength;
</span></span><span style="display:flex;"><span>	ULONG Options;
</span></span><span style="display:flex;"><span>	ULONG Disposition;
</span></span><span style="display:flex;"><span>	PFILE_BASIC_INFORMATION BasicInformation;
</span></span><span style="display:flex;"><span>	PFILE_NETWORK_OPEN_INFORMATION NetworkInformation;
</span></span><span style="display:flex;"><span>	CREATE_FILE_TYPE CreateFileType;
</span></span><span style="display:flex;"><span>	PVOID MailslotOrPipeParameters;
</span></span><span style="display:flex;"><span>	BOOLEAN Override;
</span></span><span style="display:flex;"><span>	BOOLEAN QueryOnly;
</span></span><span style="display:flex;"><span>	BOOLEAN DeleteOnly;
</span></span><span style="display:flex;"><span>	BOOLEAN FullAttributes;
</span></span><span style="display:flex;"><span>	PDUMMY_FILE_OBJECT LocalFileObject;
</span></span><span style="display:flex;"><span>	ULONG           InternalFlags;
</span></span><span style="display:flex;"><span>	IO_DRIVER_CREATE_CONTEXT  DriverCreateContext;
</span></span><span style="display:flex;"><span>} OPEN_PACKET_WIN7, <span style="color:#ec0000">*</span>POPEN_PACKET_WIN7;
</span></span><span style="display:flex;"><span>#pragma pack(pop)
</span></span><span style="display:flex;"><span>// WIN8
</span></span><span style="display:flex;"><span>// WIN8_1
</span></span><span style="display:flex;"><span>// WIN10
</span></span><span style="display:flex;"><span>#pragma pack(push)
</span></span><span style="display:flex;"><span>#pragma pack(8)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> _OPEN_PACKET_WIN8
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	CSHORT Type;
</span></span><span style="display:flex;"><span>	CSHORT Size;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT FileObject;
</span></span><span style="display:flex;"><span>	NTSTATUS FinalStatus;
</span></span><span style="display:flex;"><span>	ULONG_PTR Information;
</span></span><span style="display:flex;"><span>	ULONG ParseCheck;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">union</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		PFILE_OBJECT RelatedFileObject;
</span></span><span style="display:flex;"><span>		PDEVICE_OBJECT ReferencedDeviceObject;
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>	POBJECT_ATTRIBUTES OriginalAttributes;
</span></span><span style="display:flex;"><span>	LARGE_INTEGER AllocationSize;
</span></span><span style="display:flex;"><span>	ULONG CreateOptions;
</span></span><span style="display:flex;"><span>	USHORT FileAttributes;
</span></span><span style="display:flex;"><span>	USHORT ShareAccess;
</span></span><span style="display:flex;"><span>	PVOID EaBuffer;
</span></span><span style="display:flex;"><span>	ULONG EaLength;
</span></span><span style="display:flex;"><span>	ULONG Options;
</span></span><span style="display:flex;"><span>	ULONG Disposition;
</span></span><span style="display:flex;"><span>	PFILE_BASIC_INFORMATION BasicInformation;
</span></span><span style="display:flex;"><span>	PFILE_NETWORK_OPEN_INFORMATION NetworkInformation;
</span></span><span style="display:flex;"><span>	CREATE_FILE_TYPE CreateFileType;
</span></span><span style="display:flex;"><span>	PVOID MailslotOrPipeParameters;
</span></span><span style="display:flex;"><span>	BOOLEAN Override;
</span></span><span style="display:flex;"><span>	BOOLEAN QueryOnly;
</span></span><span style="display:flex;"><span>	BOOLEAN DeleteOnly;
</span></span><span style="display:flex;"><span>	BOOLEAN FullAttributes;
</span></span><span style="display:flex;"><span>	PDUMMY_FILE_OBJECT LocalFileObject;
</span></span><span style="display:flex;"><span>	ULONG           InternalFlags;
</span></span><span style="display:flex;"><span>	KPROCESSOR_MODE AccessMode;
</span></span><span style="display:flex;"><span>	IO_DRIVER_CREATE_CONTEXT  DriverCreateContext;
</span></span><span style="display:flex;"><span>} OPEN_PACKET_WIN8, <span style="color:#ec0000">*</span>POPEN_PACKET_WIN8;
</span></span><span style="display:flex;"><span>#pragma pack(pop)
</span></span></code></pre></div><h3 id="控制码-1">控制码</h3>
<p>能力：</p>
<ul>
<li>解锁文件</li>
<li>驱动加载</li>
<li>句柄操作</li>
<li>进程打开、结束</li>
<li>注册表穿透操作</li>
</ul>
<blockquote>
<p>IRP_MJ_DEVICE_CONTROL	=&gt;	调用DeviceIoControl派遣(DeviceIoControlDispatch)</p>
</blockquote>
<h4 id="tssyskit-x86-iocontrolcode对应表">TSSysKit x86 IoControlCode对应表</h4>
<pre tabindex="0"><code>0x221C00
    解锁文件
    buffer=     sizeof=0x804
    +00 NTSTATUS status     out
    +04 WCHAR FileName[1024]    in
0x221C04
0x221C08
0x221C0C
0x221C10
0x221C14
    尚未实现
0x222004
    普通结束进程
    buffer=     sizeof=4
    +00 DWORD ProcessId
0x222008
    穿透NtDeleteKey
    buffer=     sizeof=8
    +00 NTSTATUS status     out
    +04 HANDLE  KeyHandle   in
0x22200C
    穿透NtDeleteValueKey        成员含义见NtDeleteValueKey
    buffer=     sizeof=0xC
    +00 NTSTATUS status     out
    +04 HANDLE  KeyHandle   in
    +08 PUNICODE_STRING ValueName   in
0x222010
    通过进程id或进程对象名(只能选一)穿透打开进程NtOpenProcess   成员含义见NtOpenProcess
    buffer=     sizeof=0x18
    +00 NTSTATUS status     out
    +04 HANDLE ProcessHandle    out
    +08 ACCESS_MASK DesiredAccess in
    +0C POBJECT_ATTRIBUTES ObjectAttributes in
    +10 PCLIENT_ID ClientId
0x222404
    普通关闭句柄NtClose
    buffer=     sizeof=8
    +00 NTSTATUS status     out
    +04 HANDLE Handle   in
0x222408
    穿透创建注册表项NtCreateKey         成员含义见NtCreateKey
    buffer=     sizeof=0x20
    +00 HANDLE  KeyHandle   out
    +04 NTSTATUS status     out     注意status不是第一成员了！！
    +08 ULONG Disposition   out
    +0C ACCESS_MASK DesiredAccess   in
    +10 POBJECT_ATTRIBUTES ObjectAttributes in
    +14 ULONG TitleIndex    in
    +18 PUNICODE_STRING Class   in
    +1C ULONG CreateOptions in
0x22240C
    穿透打开注册表项NtOpenKey           成员含义见NtOpenKey
    buffer=     sizeof=0x10
    +00 HANDLE  KeyHandle   out
    +04 NTSTATUS status     out     注意status不是第一成员了！！
    +08 ACCESS_MASK DesiredAccess   in
    +0C POBJECT_ATTRIBUTES ObjectAttributes in
0x222410
    同0x222008  NtDeleteKey
	buffer=		sizeof=8
	+00	NTSTATUS status
	+04	HANDLE KeyHandle
0x222414
    穿透删除注册表项NtDeleteValueKey	成员含义见NtDeleteValueKey
	buffer=		sizeof=0xC
	+00	NTSTATUS status     out 
	+04	HANDLE  KeyHandle   in
	+08	PUNICODE_STRING ValueName	in
0x222418
    穿透设置注册表项NtSetValueKeyEx     成员含义见NtSetValueKey
    buffer=     sizeof=0x1C
    +00 NTSTATUS status     out 
    +04 HANDLE  KeyHandle   in
    +08 PUNICODE_STRING ValueName	in
    +0C ULONG TitleIndex	未使用
    +10 ULONG   Type	in
    +14 PVOID   Data	in
    +18 ULONG   DataSize	in
0x22241C
    穿透设置注册表项NtQueryValueKey     成员含义见NtQueryValueKey
    buffer=     sizeof=0x1C
    +00 DWORD ResultLength  out
    +04 NTSTATUS status     out     注意status不是第一成员了！！
    +08 HANDLE  KeyHandle   in
    +0C PUNICODE_STRING ValueName
    +10 ULONG Type          out     KeyValueInformation-&gt;DataLength
    +14 PVOID Data          out     KeyValueInformation-&gt;Data
    +18 ULONG DataLength    out     KeyValueInformation-&gt;DataLength
0x222420
    穿透枚举注册表项NtEnumerateKey      成员含义见NtEnumerateKey
    buffer=     sizeof=0x1C
    +00 NTSTATUS status     out
    +04 DWORD ResultLength  out
    +08 HANDLE KeyHandle        in
    +0C ULONG Index             in
    +10 KEY_INFORMATION_CLASS KeyInformationClass   in
    +14 PVOID KeyInformation    in
    +18 ULONG Length
0x222424
    NtEnumerateValueKey     成员含义见NtEnumerateValueKey
    buffer=		sizeof=0x1C
    +00 NTSTATUS status     out
    +04 ULONG ResultLength  out
    +08 HANDLE KeyHandle    in
    +0C ULONG Index     in
    +10 KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass    in
    +14 PVOID KeyValueInformation   out
    +18 ULONG Length    in
0x222428
    TsSysKit驱动是否初始化
    *(DWORD*)buffer =&gt; SomeFlag
    *(DWORD*)buffer &lt;= IsTsSysKitInit 
0x22242C
    穿透创建服务加载驱动
    buffer=     sizeof=0x91C
    +000    WCHAR ImagePath[260] 驱动文件路径
    +208    DWORD Type  驱动注册表Type项
    +20C    DWORD Start 驱动注册表项Start类型
    +210    DWORD flag  (决定是否设置注册表Tag和Group信息)
    +214    ？？？
    +468    DWORD Tag 驱动注册表Tag项
    +46C    WCHAR DisplayName[300] 驱动注册表项DisplayName
    +6C4    WCHAR ServiceName[300] 驱动服务名
0x222430
    获取操作系统版本
    buffer=RTL_OSVERSIONINFOEXW     sizeof=0x11C
0x222800
0x222804
    2个初始化TSSysKit的通道
0x224008
	+00	DWORD Tag=0x20120502
	+04	DWORD =0
0x22400C
	穿透创建文件
	Buffer=	sizeof=0x30	具体参数含义见NtCreateFile
	+00	NTSTATUS status     out
	+04	PHANDLE FileHandle 
	+08	ACCESS_MASK DesiredAccess 
	+0C	POBJECT_ATTRIBUTES ObjectAttributes 
	+10	PIO_STATUS_BLOCK IoStatusBloc
	+14	PLARGE_INTEGER AllocationSize 
	+18	ULONG FileAttributes
	+1C	ULONG ShareAccess
	+20	ULONG CreateDisposition
	+24	ULONG CreateOptions
	+28	PVOID EaBuffer 
	+2C	ULONG EaLength 
0x224010
	穿透打开文件
	Buffer=	sizeof=0x1C 	具体参数含义见NtOpenFile
	+00	NTSTATUS status     out
	+04	PHANDLE FileHandle
	+08	PHANDLE FileHandle
	+0C	POBJECT_ATTRIBUTES ObjectAttributes
	+10	PIO_STATUS_BLOCK IoStatusBlock
	+14	ULONG ShareAccess
	+18	ULONG OpenOptions
0x224014
	穿透读取文件
	Buffer=	sizeof=0x28		具体参数含义见NtReadFile
	+00	NTSTATUS status     out
	+04	HANDLE FileHandle	in
	+08	HANDLE Event		in
	+0C	PIO_APC_ROUTINE ApcRoutine	in
	+10	PVOID ApcContext			in
	+14	PIO_STATUS_BLOCK IoStatusBlock	in
	+18	PVOID Buffer		out
	+1C	ULONG Length		in
	+20	PLARGE_INTEGER ByteOffset	
	+24	PULONG Key
0x224018
	穿透写入文件
	Buffer=	sizeof=0x28		具体参数含义见NtWriteFile
	+00	NTSTATUS status     out
	+04	HANDLE FileHandle	in
	+08	HANDLE Event		in
	+0C	PIO_APC_ROUTINE ApcRoutine	in
	+10	PVOID ApcContext			in
	+14	PIO_STATUS_BLOCK IoStatusBlock	in
	+18	PVOID Buffer		out
	+1C	ULONG Length		in
	+20	PLARGE_INTEGER ByteOffset	
	+24	PULONG Key
0x22401C
    普通关闭句柄NtClose
    buffer=     sizeof=8
    +00 NTSTATUS status     out
    +04 HANDLE Handle   in
0x224020
	穿透设置文件
	Buffer=	sizeof=0x1C       具体参数含义见NtSetInformationFile
	+00	NTSTATUS status;
	+04	HANDLE FileHandle			in
	+08	PIO_STATUS_BLOCK IoStatus		out	
	+0C	PVOID FileInformation		in
	+10	ULONG Length			in
	+14	FILE_INFORMATION_CLASS FileInformationClass	in
	+18	BOOL DelCurrentFile		in
0x224024
	穿透查询文件
	Buffer=	sizeof=0x1C       具体参数含义见NtQueryInformationFile
	+00	NTSTATUS status				out
	+04	HANDLE FileHandle			in
	+08	PIO_STATUS_BLOCK IoStatus		out	
	+0C	PVOID FileInformation		in
	+10	ULONG Length			in
	+14	FILE_INFORMATION_CLASS FileInformationClass	in
	+18	BOOL DelCurrentFile		in
0x224028
	尚未实现
0x22402C
	穿透查询目录
	Buffer=	sizeof=0x30	具体参数含义见NtQueryDirectoryFile
	+00	NTSTATUS status		out
	+04	HANDLE FileHandle	in
	+08	HANDLE Event		in
	+0C 	PIO_APC_ROUTINE ApcRoutine	未使用
	+10	PVOID ApcContext	未使用
	+14 	PIO_STATUS_BLOCK IoStatus		out
	+18	PVOID FileInformation	in
	+1C	ULONG Length		in
	+20	FILE_INFORMATION_CLASS FileInformationClass	in
	+24	BOOLEAN ReturnSingleEntry		in
	+28	PUNICODE_STRING FileName	in
	+2C	BOOLEAN RestartScan	in
0x228404
	穿透查询文件属性
	Buffer=	sizeof=0xC		具体参数含义见NtQueryAttributesFile
	+0	NTSTATUS status		out
	+4	POBJECT_ATTRIBUTES ObjectAttributes		in			路径前缀匹配\??\c:
	+8	FILE_NETWORK_OPEN_INFORMATION networkInformation	out
0x221C00解锁文件
	见3.13 解锁文件
0x222004
	普通结束进程
0x22242C
	穿透创建服务加载驱动
</code></pre><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">TerminateProcessById</span>(HANDLE ProcessId)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	BOOLEAN Result <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	PEPROCESS Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	HANDLE ProcessHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">PsLookupProcessByProcessId</span>(ProcessId,<span style="color:#ec0000">&amp;</span>Process)) <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">ObOpenObjectByPointer</span>(Process,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>,PROCESS_ALL_ACCESS,<span style="color:#ec0000">NULL</span>,KernelMode,<span style="color:#ec0000">&amp;</span>ProcessHandle)) <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">ZwTerminateProcess</span>(ProcessHandle,<span style="color:#008900">0</span>)))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Result <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Process)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(Process);
</span></span><span style="display:flex;"><span>		Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ProcessHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(ProcessHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> Result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ec0000">struct</span> LOADDRIVERSTRUCT
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	WCHAR ImagePath[<span style="color:#008900">260</span>]; //驱动文件路径
</span></span><span style="display:flex;"><span>	DWORD Type;  //驱动注册表Type项
</span></span><span style="display:flex;"><span>	DWORD Start; //驱动注册表项Start类型
</span></span><span style="display:flex;"><span>	WCHAR Group[<span style="color:#008900">300</span>];//驱动注册表Group名
</span></span><span style="display:flex;"><span>	DWORD Tag; //驱动注册表Tag项
</span></span><span style="display:flex;"><span>	WCHAR DisplayName[<span style="color:#008900">300</span>]; //驱动注册表项DisplayName
</span></span><span style="display:flex;"><span>	WCHAR ServiceName[<span style="color:#008900">300</span>]; //驱动服务名
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#define MakeUnicodeString(X) {sizeof(X),sizeof(X)+2,X}
</span></span><span style="display:flex;"><span>UNICODE_STRING UImagePath<span style="color:#ec0000">=</span><span style="color:#5f5fff">MakeUnicodeString</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;ImagePath&#34;</span>);
</span></span><span style="display:flex;"><span>UNICODE_STRING UType<span style="color:#ec0000">=</span><span style="color:#5f5fff">MakeUnicodeString</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;Type&#34;</span>);
</span></span><span style="display:flex;"><span>UNICODE_STRING UStart<span style="color:#ec0000">=</span><span style="color:#5f5fff">MakeUnicodeString</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;Start&#34;</span>);
</span></span><span style="display:flex;"><span>UNICODE_STRING UGroup<span style="color:#ec0000">=</span><span style="color:#5f5fff">MakeUnicodeString</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;Group&#34;</span>);
</span></span><span style="display:flex;"><span>UNICODE_STRING UDisplayName<span style="color:#ec0000">=</span><span style="color:#5f5fff">MakeUnicodeString</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;DisplayName&#34;</span>);
</span></span><span style="display:flex;"><span>UNICODE_STRING UErrorControl<span style="color:#ec0000">=</span><span style="color:#5f5fff">MakeUnicodeString</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;ErrorControl&#34;</span>);
</span></span><span style="display:flex;"><span>UNICODE_STRING UTag<span style="color:#ec0000">=</span><span style="color:#5f5fff">MakeUnicodeString</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;Tag&#34;</span>);
</span></span><span style="display:flex;"><span>UNICODE_STRING UZwLoadDriver<span style="color:#ec0000">=</span><span style="color:#5f5fff">MakeUnicodeString</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;ZwLoadDriver&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> LOADDRIVERPARAM
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	WORK_QUEUE_ITEM WorkItem;
</span></span><span style="display:flex;"><span>	KEVENT Event;
</span></span><span style="display:flex;"><span>	ULONG mem1;
</span></span><span style="display:flex;"><span>	PUNICODE_STRING DriverServiceName;
</span></span><span style="display:flex;"><span>	NTSTATUS Status;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">LoadDriverWorker</span>(LOADDRIVERPARAM<span style="color:#ec0000">*</span> WorkItem)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL,outstatus;
</span></span><span style="display:flex;"><span>	HANDLE KeyHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(WorkItem)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,WorkItem<span style="color:#ec0000">-&gt;</span>DriverServiceName,OBJ_CASE_INSENSITIVE<span style="color:#ec0000">|</span>OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">NtOpenKey</span>(<span style="color:#ec0000">&amp;</span>KeyHandle,KEY_READ,<span style="color:#ec0000">&amp;</span>Oa);//穿透
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{//xp win7的IopLoadDriver 为不同的调用方式
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(VersionInfo <span style="color:#ec0000">&lt;</span> WINVISTA)
</span></span><span style="display:flex;"><span>			{//NTSTATUS __stdcall IopLoadDriver(HANDLE KeyHandle, BOOLEAN CheckForSafeBoot, BOOLEAN IsFilter, NTSTATUS *DriverEntryStatus)
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">IopLoadDriver</span>(KeyHandle,HANDLE_FLAG_INHERIT,FALSE,<span style="color:#ec0000">&amp;</span>outstatus);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(status <span style="color:#ec0000">==</span> STATUS_FAILED_DRIVER_ENTRY)
</span></span><span style="display:flex;"><span>					status <span style="color:#ec0000">=</span> outstatus;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(status <span style="color:#ec0000">==</span> STATUS_DRIVER_FAILED_PRIOR_UNLOAD)
</span></span><span style="display:flex;"><span>					status <span style="color:#ec0000">=</span> STATUS_OBJECT_NAME_NOT_FOUND;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>			{//NTSTATUS __userpurge IopLoadDriver&lt;eax&gt;(HANDLE KeyHandle&lt;ecx&gt;, BOOLEAN CheckForSafeBoot, BOOLEAN IsFilter, NTSTATUS *DriverEntryStatus)  第一参用ecx传值
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IopLoadDriver</span>(KeyHandle,HANDLE_FLAG_INHERIT,FALSE,<span style="color:#ec0000">&amp;</span>outstatus);////事先获取的函数指针，见1.1
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	WorkItem<span style="color:#ec0000">-&gt;</span>Status <span style="color:#ec0000">=</span> status;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">KeSetEvent</span>(WorkItem<span style="color:#ec0000">-&gt;</span>Event,<span style="color:#008900">0</span>,FALSE);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">LoadDriverEx</span>(PUNICODE_STRING DriverServiceName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	LOADDRIVERPARAM LoadDriver;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(IopLoadDriver)//事先获取的函数指针，见1.1
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		LoadDriver.DriverServiceName <span style="color:#ec0000">=</span> DriverServiceName;
</span></span><span style="display:flex;"><span>		LoadDriver.mem1 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeInitializeEvent</span>(<span style="color:#ec0000">&amp;</span>LoadDriver.Event,NotificationEvent,FALSE);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExInitializeWorkItem</span>(<span style="color:#ec0000">&amp;</span>LoadDriver,LoadDriverWorker,<span style="color:#ec0000">&amp;</span>LoadDriver);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExQueueWorkItem</span>(<span style="color:#ec0000">&amp;</span>LoadDriver.WorkItem,DelayedWorkQueue);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeWaitForSingleObject</span>(<span style="color:#ec0000">&amp;</span>LoadDriver.Event,UserRequest,KernelMode,FALSE,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> LoadDriver.Status;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		FARPROC ZwLoadDriver <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MmGetSystemRoutineAddress</span>(<span style="color:#ec0000">&amp;</span>UZwLoadDriver);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(ZwLoadDriver)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#5f5fff">ZwLoadDriver</span>(DriverServiceName);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">CreateServiceAndLoadDriver</span>(DWORD InLen,LOADDRIVERSTRUCT<span style="color:#ec0000">*</span> Data)
</span></span><span style="display:flex;"><span>{//InLen = IrpSp-&gt;Parameters.DeviceIoControl.InputBufferLength
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	UNICODE_STRING DriverServicePath;
</span></span><span style="display:flex;"><span>	UNICODE_STRING ServiceName;
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>	WCHAR<span style="color:#ec0000">*</span> Buf <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	HANDLE KeyHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">const</span> <span style="color:#5f5fff">int</span> BufLen <span style="color:#ec0000">=</span> <span style="color:#008900">520</span>;
</span></span><span style="display:flex;"><span>	ULONG ErrorControl <span style="color:#ec0000">=</span> SERVICE_ERROR_NORMAL;
</span></span><span style="display:flex;"><span>	ULONG Disposition <span style="color:#ec0000">=</span> REG_OPENED_EXISTING_KEY;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">SeSinglePrivilegeCheck</span>(SE_LOAD_DRIVER_PRIVILEGE,UserMode))
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_PRIVILEGE_NOT_HELD;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(VersionInfo <span style="color:#ec0000">&lt;</span> WINXP)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_NOT_SUPPORTED;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>((Data<span style="color:#ec0000">-&gt;</span>Type <span style="color:#ec0000">&amp;</span> SERVICE_DRIVER) <span style="color:#ec0000">&amp;&amp;</span> Data<span style="color:#ec0000">-&gt;</span>ServiceName <span style="color:#ec0000">&amp;&amp;</span> Data<span style="color:#ec0000">-&gt;</span>ImagePath <span style="color:#ec0000">&amp;&amp;</span> Data<span style="color:#ec0000">-&gt;</span>DisplayName)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>ServiceName,Data<span style="color:#ec0000">-&gt;</span>ServiceName);
</span></span><span style="display:flex;"><span>		Buf <span style="color:#ec0000">=</span> (WCHAR<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,BufLen);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlZeroMemory</span>(Buf,BufLen);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">wcscpy</span>(Buf,<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Registry</span><span style="color:#008900">\\</span><span style="color:#008900">Machine</span><span style="color:#008900">\\</span><span style="color:#008900">System</span><span style="color:#008900">\\</span><span style="color:#008900">CurrentControlSet</span><span style="color:#008900">\\</span><span style="color:#008900">Services</span><span style="color:#008900">\\</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>		DriverServicePath.Length <span style="color:#ec0000">=</span> <span style="color:#008900">2</span><span style="color:#ec0000">*</span><span style="color:#5f5fff">wcslen</span>(Buf);
</span></span><span style="display:flex;"><span>		DriverServicePath.MaximumLength <span style="color:#ec0000">=</span> BufLen;
</span></span><span style="display:flex;"><span>		DriverServicePath.Buffer <span style="color:#ec0000">=</span> Buf;
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">RtlAppendUnicodeStringToString</span>(<span style="color:#ec0000">&amp;</span>DriverServicePath, <span style="color:#ec0000">&amp;</span>ServiceName);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#ec0000">&amp;</span>DriverServicePath,OBJ_CASE_INSENSITIVE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwCreateKey</span>(<span style="color:#ec0000">&amp;</span>KeyHandle,KEY_READ<span style="color:#ec0000">|</span>KEY_SET_VALUE, <span style="color:#ec0000">&amp;</span>Oa, <span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>, <span style="color:#008900">0</span>, <span style="color:#ec0000">&amp;</span>Disposition);//穿透
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwSetValueKeyEx</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UImagePath,REG_SZ,Data<span style="color:#ec0000">-&gt;</span>ImagePath,<span style="color:#008900">2</span><span style="color:#ec0000">*</span><span style="color:#5f5fff">wcslen</span>(Data<span style="color:#ec0000">-&gt;</span>ImagePath)<span style="color:#ec0000">+</span><span style="color:#008900">2</span>);//穿透
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwSetValueKeyEx</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UType,REG_DWORD,Data<span style="color:#ec0000">-&gt;</span>Type,<span style="color:#ec0000">sizeof</span>(DWORD));
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwSetValueKeyEx</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UStart,REG_DWORD,Data<span style="color:#ec0000">-&gt;</span>Start,<span style="color:#ec0000">sizeof</span>(DWORD));
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwSetValueKeyEx</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UDisplayName,REG_SZ,Data<span style="color:#ec0000">-&gt;</span>DisplayName,<span style="color:#008900">2</span><span style="color:#ec0000">*</span><span style="color:#5f5fff">wcslen</span>(Data<span style="color:#ec0000">-&gt;</span>DisplayName)<span style="color:#ec0000">+</span><span style="color:#008900">2</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{//此处q管源码有bug
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwSetValueKeyEx</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UGroup,REG_SZ,Data<span style="color:#ec0000">-&gt;</span>Group,<span style="color:#008900">2</span><span style="color:#ec0000">*</span><span style="color:#5f5fff">wcslen</span>(Data<span style="color:#ec0000">-&gt;</span>Group)<span style="color:#ec0000">+</span><span style="color:#008900">2</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwSetValueKeyEx</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UTag,REG_DWORD,Data<span style="color:#ec0000">-&gt;</span>Tag,<span style="color:#ec0000">sizeof</span>(DWORD));
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwSetValueKeyEx</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UErrorControl,REG_DWORD,ErrorControl,<span style="color:#ec0000">sizeof</span>(DWORD));
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ZwFlushKey</span>(KeyHandle);
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">LoadDriverEx</span>(<span style="color:#ec0000">&amp;</span>DriverServicePath);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(KeyHandle)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(KeyHandle);
</span></span><span style="display:flex;"><span>		KeyHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Buf)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(Buf);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="tssyskit-x64-iocontrolcode对应表">TSSysKit x64 IoControlCode对应表</h4>
<pre tabindex="0"><code>0x22200C
	穿透创建文件
	Buffer=	sizeof=0x50	具体参数含义见NtCreateFile
	+00	NTSTATUS status     out
	+08	PHANDLE FileHandle 
	+10	ACCESS_MASK DesiredAccess 
	+18	POBJECT_ATTRIBUTES ObjectAttributes 
	+20	PIO_STATUS_BLOCK IoStatusBloc
	+28	PLARGE_INTEGER AllocationSize 
	+30	ULONG FileAttributes
	+34	ULONG ShareAccess
	+38	ULONG CreateDisposition
	+3C	ULONG CreateOptions
	+40	PVOID EaBuffer 
	+48	ULONG EaLength 
0x222010
	穿透打开文件
	Buffer=	sizeof=0x30 	具体参数含义见NtOpenFile
	+00	NTSTATUS status     out
	+08	PHANDLE FileHandle
	+10	PHANDLE FileHandle
	+18	POBJECT_ATTRIBUTES ObjectAttributes
	+20	PIO_STATUS_BLOCK IoStatusBlock
	+28	ULONG ShareAccess
	+2C	ULONG OpenOptions
0x222014
	穿透读取文件
	Buffer=	sizeof=0x50		具体参数含义见NtReadFile
	+00	NTSTATUS status     out
	+08	HANDLE FileHandle	in
	+10	HANDLE Event		in
	+18	PIO_APC_ROUTINE ApcRoutine	in
	+20	PVOID ApcContext			in
	+28	PIO_STATUS_BLOCK IoStatusBlock	in
	+30	PVOID Buffer		out
	+38	ULONG Length		in
	+40	PLARGE_INTEGER ByteOffset	
	+48	PULONG Key
0x222018
	穿透写入文件
	Buffer=	sizeof=0x50		具体参数含义见NtWriteFile
	+00	NTSTATUS status     out
	+08	HANDLE FileHandle	in
	+10	HANDLE Event		in
	+18	PIO_APC_ROUTINE ApcRoutine	in
	+20	PVOID ApcContext			in
	+28	PIO_STATUS_BLOCK IoStatusBlock	in
	+30	PVOID Buffer		out
	+38	ULONG Length		in
	+40	PLARGE_INTEGER ByteOffset	
	+48	PULONG Key
0x22201C
    普通关闭句柄NtClose
    buffer=     sizeof=0x10
    +00 NTSTATUS status     out
    +04 HANDLE Handle   in
0x222020
	穿透设置文件
	Buffer=	sizeof=0x30       具体参数含义见NtSetInformationFile
	+00	NTSTATUS status;
	+08	HANDLE FileHandle			in
	+10	PIO_STATUS_BLOCK IoStatus		out	
	+18	PVOID FileInformation		in
	+20	ULONG Length			in
	+24	FILE_INFORMATION_CLASS FileInformationClass	in
	+28	BOOL DelCurrentFile		in
0x222024
	穿透查询文件
	Buffer=	sizeof=0x30       具体参数含义见NtQueryInformationFile
	+00	NTSTATUS status				out
	+08	HANDLE FileHandle			in
	+10	PIO_STATUS_BLOCK IoStatus		out	
	+18	PVOID FileInformation		in
	+20	ULONG Length			in
	+24	FILE_INFORMATION_CLASS FileInformationClass	in
	+28	BOOL DelCurrentFile		in
0x222028
	尚未实现
0x22202C	
	穿透查询目录
	Buffer=	sizeof=0x58	具体参数含义见NtQueryDirectoryFile
	+00	NTSTATUS status		out
	+08	HANDLE FileHandle	in
	+10	HANDLE Event		in
	+18 	PIO_APC_ROUTINE ApcRoutine	未使用
	+20	PVOID ApcContext	未使用
	+28 	PIO_STATUS_BLOCK IoStatus		out
	+30	PVOID FileInformation	in
	+38	ULONG Length		in
	+3C	FILE_INFORMATION_CLASS FileInformationClass	in
	+40	BOOLEAN ReturnSingleEntry		in
	+48	PUNICODE_STRING FileName	in
	+50	BOOLEAN RestartScan	in
0x222030
	获取内部版本号
	buffer=		sizeof=8
	+0	&lt;=	0x20110929i64
0x222034	
	穿透查询文件属性
	Buffer=	sizeof=0x18		具体参数含义见NtQueryAttributesFile
	+00	NTSTATUS status		out
	+08	POBJECT_ATTRIBUTES ObjectAttributes		in			路径前缀匹配\??\c:
	+10	FILE_NETWORK_OPEN_INFORMATION networkInformation	out
0x222038	
    解锁文件
    buffer=     sizeof=0x804
    +00 NTSTATUS status     out
    +04 WCHAR FileName[1024]    in
0x222144
	普通关闭句柄NtClose
    buffer=     sizeof=0x10
    +00 NTSTATUS	status out
    +08 HANDLE		Handle in
0x222148
    穿透创建注册表项NtCreateKey         成员含义见NtCreateKey
    buffer=     sizeof=0x20
    +00 HANDLE  KeyHandle   out
    +04 NTSTATUS status     out     注意status不是第一成员了！！
    +08 ULONG Disposition   out
    +0C ACCESS_MASK DesiredAccess   in
    +10 POBJECT_ATTRIBUTES ObjectAttributes in
    +14 ULONG TitleIndex    in
    +18 PUNICODE_STRING Class   in
    +1C ULONG CreateOptions in
0x22214C
    穿透打开注册表项NtOpenKey           成员含义见NtOpenKey
    buffer=     sizeof=0x20
    +00 HANDLE  KeyHandle   out
    +08 NTSTATUS status     out     注意status不是第一成员了！！
    +10 ACCESS_MASK DesiredAccess   in
    +18 POBJECT_ATTRIBUTES ObjectAttributes in
0x222150
	穿透删除注册表项NtDeleteKey			成员含义见NtDeleteKey
	buffer=		sizeof=0x10
	+00	NTSTATUS status
	+08	HANDLE KeyHandle
0x222154
    穿透删除注册表项NtDeleteValueKey	成员含义见NtDeleteValueKey
	buffer=		sizeof=0x18
	+00	NTSTATUS status     out 
	+08	HANDLE  KeyHandle   in
	+10	PUNICODE_STRING ValueName	in
0x222158
	穿透设置注册表项NtSetValueKeyEx     成员含义见NtSetValueKey
    buffer=     sizeof=0x30
    +00 NTSTATUS status     out 
    +08 HANDLE  KeyHandle   in
    +10 PUNICODE_STRING ValueName	in
    +18 ULONG TitleIndex	未使用
    +1C ULONG   Type	in
    +20 PVOID   Data	in
    +28 ULONG   DataSize	in
0x22215C
    穿透设置注册表项NtQueryValueKey     成员含义见NtQueryValueKey
    buffer=     sizeof=0x30
    +00 DWORD ResultLength  out
    +04 NTSTATUS status     out     注意status不是第一成员了！！
    +08 HANDLE  KeyHandle   in
    +10 PUNICODE_STRING ValueName
    +18 ULONG Type          out     KeyValueInformation-&gt;DataLength
    +20 PVOID Data          out     KeyValueInformation-&gt;Data
    +28 ULONG DataLength    out     KeyValueInformation-&gt;DataLength
0x222160
	穿透枚举注册表项NtEnumerateKey      成员含义见NtEnumerateKey
	buffer=		sizeof=0x28
    +00 NTSTATUS status     out
    +04 ULONG ResultLength  out
    +08 HANDLE KeyHandle    in
    +10 ULONG Index     in
    +14 KEY_INFORMATION_CLASS KeyValueInformationClass    in
    +18 PVOID KeyInformation   out
    +20 ULONG Length    in
0x222164
    穿透枚举注册表项NtEnumerateValueKey     成员含义见NtEnumerateValueKey
    buffer=		sizeof=0x28
    +00 NTSTATUS status     out
    +04 ULONG ResultLength  out
    +08 HANDLE KeyHandle    in
    +10 ULONG Index     in
    +14 KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass    in
    +18 PVOID KeyValueInformation   out
    +20 ULONG Length    in
0x222284
    通过进程id或进程对象名(只能选一)穿透打开进程NtOpenProcess   成员含义见NtOpenProcess
    buffer=     sizeof=0x30
    +00 NTSTATUS status     out
    +08 HANDLE ProcessHandle    out
    +10 ACCESS_MASK DesiredAccess in
    +18 POBJECT_ATTRIBUTES ObjectAttributes in
    +20 PCLIENT_ID ClientId
0x222288
	buffer=     sizeof=4
    +00 DWORD ProcessId
0x222430
    获取操作系统版本
    buffer=RTL_OSVERSIONINFOEXW     sizeof=0x11C
0x222800
0x222804
    2个初始化TSSysKit的通道
0x222808
	获取CPUID信息
	buffer=		sizeof=0x38
	+00	ULONG Fn0000_0000_EBX	EBX EDX ECX 组成&#34;GenuineIntel&#34;或&#34;AuthenticAMD&#34;
	+04	ULONG Fn0000_0000_EDX
	+08 ULONG Fn0000_0000_ECX
	+10	ULONG CpuType   0:未知    1:INTEL    2:AMD
	+14	BOOLEAN VMBit	是否支持vm   Intel Virutalization Technology / AMD Secure Virtual Machine
	+18	ULONGLONG MSR3A  Intel  IA32_FEATURE_CONTROL   MSR(0x3A)  / AMD Read NX support 
	+20	ULONGLONG  NXsupport        Intel CR4  / AMD Msr(0xC0000080)
	+28 ULONGLONG VMXONBit  Intel MSR(0x3A) activate VMXON outside of SMX mode  /  AMD Msr(0xC0010114)
	+30	ULONG NRIP    Fn8000_000A_EDX&amp;4
</code></pre><h3 id="默认派遣例程">默认派遣例程</h3>
<p>IRP_MJ_CREATE</p>
<ul>
<li>检查当前所属进程是否有腾讯标记  (CheckDriverLoaderValid)</li>
<li>重置驱动注册表项信息 (ResetRegServiceInfo)</li>
<li>随机化EPROCESS的ImageFileName(RandomImageNameToHide)</li>
</ul>
<p>根据进程id结束进程</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">TerminateProcessById</span>(HANDLE ProcessId)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PEPROCESS Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	HANDLE ProcessHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">PsLookupProcessByProcessId</span>(ProcessId,<span style="color:#ec0000">&amp;</span>Process);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObOpenObjectByPointer</span>(Process,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>,PROCESS_ALL_ACCESS,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">&amp;</span>ProcessHandle);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwTerminateProcess</span>(ProcessHandle,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Process)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(Process);
</span></span><span style="display:flex;"><span>		Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ProcessHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(ProcessHandle);
</span></span></code></pre></div><p>检测PE格式合法性</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">CheckNtImageValid</span>(LPVOID ImageAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ImageAddress <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(ImageAddress))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		PIMAGE_DOS_HEADER DosHeader <span style="color:#ec0000">=</span> (IMAGE_DOS_HEADER)ImageAddress;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">MmIsAddressValid</span>(<span style="color:#ec0000">&amp;</span>DosHeader<span style="color:#ec0000">-&gt;</span>e_lfanew) <span style="color:#ec0000">&amp;&amp;</span> DosHeader<span style="color:#ec0000">-&gt;</span>e_magic <span style="color:#ec0000">==</span> <span style="color:#ec0000">&#39;</span>ZM<span style="color:#ec0000">&#39;</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			PIMAGE_NT_HEADERS NtHeader <span style="color:#ec0000">=</span> (PIMAGE_NT_HEADERS)((BYTE<span style="color:#ec0000">*</span>)DosHeader <span style="color:#ec0000">+</span> DosHeader<span style="color:#ec0000">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(NtHeader <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(NtHeader) <span style="color:#ec0000">&amp;&amp;</span> NtHeader<span style="color:#ec0000">-&gt;</span>Signature <span style="color:#ec0000">==</span> <span style="color:#ec0000">&#39;</span>EP<span style="color:#ec0000">&#39;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>获取当前进程进程名</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> ULONG DWORD;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> _MEMORY_BASIC_INFORMATION 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PVOID BaseAddress;
</span></span><span style="display:flex;"><span>	PVOID AllocationBase;
</span></span><span style="display:flex;"><span>	DWORD AllocationProtect;
</span></span><span style="display:flex;"><span>	SIZE_T RegionSize;
</span></span><span style="display:flex;"><span>	DWORD State;
</span></span><span style="display:flex;"><span>	DWORD Protect;
</span></span><span style="display:flex;"><span>	DWORD Type;
</span></span><span style="display:flex;"><span>} MEMORY_BASIC_INFORMATION, <span style="color:#ec0000">*</span>PMEMORY_BASIC_INFORMATION;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> _MEMORY_SECTION_NAME
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	UNICODE_STRING SectionFileName;
</span></span><span style="display:flex;"><span>	WCHAR NameBuffer[<span style="color:#008900">0</span>];
</span></span><span style="display:flex;"><span>} MEMORY_SECTION_NAME, <span style="color:#ec0000">*</span>PMEMORY_SECTION_NAME;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">extern</span> <span style="color:#008900">&#34;C&#34;</span> PVOID <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">PsGetProcessSectionBaseAddress</span>(PEPROCESS Process);
</span></span><span style="display:flex;"><span><span style="color:#ec0000">extern</span> <span style="color:#008900">&#34;C&#34;</span> NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">ZwQueryVirtualMemory</span>(HANDLE ProcessHandle,PVOID BaseAddress,MEMORY_INFORMATION_CLASS MemoryInformationClass,
</span></span><span style="display:flex;"><span>	PVOID MemoryInformation,SIZE_T MemoryInformationLength,PSIZE_T ReturnLength);
</span></span><span style="display:flex;"><span>#define MEM_IMAGE 0x1000000 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">GetCurrentProcessName</span>(PVOID Buffer,SIZE_T Length)
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span>	 NTSTATUS status;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Buffer <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>Length)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>	UNICODE_STRING UIoVolumeDeviceToDosName;
</span></span><span style="display:flex;"><span>	PVOID ImageBase <span style="color:#ec0000">=</span> <span style="color:#5f5fff">PsGetProcessSectionBaseAddress</span>(<span style="color:#5f5fff">IoGetCurrentProcess</span>());
</span></span><span style="display:flex;"><span>	PVOID SectionName <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,Length <span style="color:#ec0000">+</span> <span style="color:#ec0000">sizeof</span>(MEMORY_SECTION_NAME));
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>SectionName)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ImageBase)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		MEMORY_BASIC_INFORMATION BasicInfo;
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQueryVirtualMemory</span>(<span style="color:#5f5fff">NtCurrentProcess</span>(),ImageBase,MemoryBasicInformation,<span style="color:#ec0000">&amp;</span>BasicInfo,<span style="color:#ec0000">sizeof</span>(BasicInfo),<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> BasicInfo.Type <span style="color:#ec0000">==</span> MEM_IMAGE)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQueryVirtualMemory</span>(<span style="color:#5f5fff">NtCurrentProcess</span>(),ImageBase,MemorySectionName,SectionName,Length <span style="color:#ec0000">+</span> <span style="color:#ec0000">sizeof</span>(MEMORY_SECTION_NAME),<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">wcsncpy</span>((WCHAR<span style="color:#ec0000">*</span>)Buffer,((PMEMORY_SECTION_NAME)SectionName)<span style="color:#ec0000">-&gt;</span>SectionFileName.Buffer,Length);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>由进程ID获取进程设备名</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">GetProcessNameById</span>(HANDLE ProcessId,PVOID Buffer,SIZE_T Length)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ProcessId <span style="color:#ec0000">==</span> (HANDLE)<span style="color:#008900">4</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">wcsncpy</span>((WCHAR<span style="color:#ec0000">*</span>)Buffer,<span style="color:#008900">L</span><span style="color:#008900">&#34;System&#34;</span>,Length);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(ProcessId <span style="color:#ec0000">==</span> <span style="color:#5f5fff">PsGetCurrentProcessId</span>())
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">GetCurrentProcessName</span>(Buffer,Length);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		PEPROCESS Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(<span style="color:#5f5fff">PsLookupProcessByProcessId</span>(ProcessId,<span style="color:#ec0000">&amp;</span>Process)))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			KAPC_STATE KApc;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeStackAttachProcess</span>(Process,<span style="color:#ec0000">&amp;</span>KApc);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">GetCurrentProcessName</span>(Buffer,Length);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeUnstackDetachProcess</span>(<span style="color:#ec0000">&amp;</span>KApc);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ObDereferenceObject</span>(<span style="color:#ec0000">&amp;</span>Process);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>设备名转DOS路径</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">GetDeviceDosName</span>(WCHAR<span style="color:#ec0000">*</span> DeviceName,WCHAR<span style="color:#ec0000">*</span> DosName,DWORD Len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	//检查设备路径
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DeviceName <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>DosName)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_INVALID_PARAMETER;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">wcsnicmp</span>(DeviceName, <span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Device</span><span style="color:#008900">\\</span><span style="color:#008900">&#34;</span>, <span style="color:#008900">8u</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_INVALID_PARAMETER_1;
</span></span><span style="display:flex;"><span>	WCHAR<span style="color:#ec0000">*</span> ptr <span style="color:#ec0000">=</span> <span style="color:#5f5fff">wcsstr</span>(DeviceName <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>,<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>ptr)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> len <span style="color:#ec0000">=</span> ptr <span style="color:#ec0000">-</span> DeviceName;
</span></span><span style="display:flex;"><span>	PVOID Buffer <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#008900">2</span><span style="color:#ec0000">*</span>len<span style="color:#ec0000">+</span><span style="color:#008900">2</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Buffer)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">wcsncpy</span>((WCHAR<span style="color:#ec0000">*</span>)Buffer,DeviceName,len);
</span></span><span style="display:flex;"><span>	//根据设备名获取设备对象
</span></span><span style="display:flex;"><span>	PDEVICE_OBJECT DeviceObject;
</span></span><span style="display:flex;"><span>	UNICODE_STRING UDeviceName;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT FileObject;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UDeviceName,(WCHAR<span style="color:#ec0000">*</span>)Buffer);
</span></span><span style="display:flex;"><span>	//GetDeviceObjectByName
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoGetDeviceObjectPointer</span>(<span style="color:#ec0000">&amp;</span>UDeviceName,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>FileObject,<span style="color:#ec0000">&amp;</span>DeviceObject);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(DeviceObject<span style="color:#ec0000">-&gt;</span>Type <span style="color:#ec0000">==</span> FILE_DEVICE_DISK)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			UNICODE_STRING RootDeviceDosName;
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoVolumeDeviceToDosName</span>(DeviceObject,<span style="color:#ec0000">&amp;</span>RootDeviceDosName);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">wcsncpy</span>(DosName,RootDeviceDosName.Buffer,RootDeviceDosName.Length);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ExFreePool</span>(RootDeviceDosName.Buffer);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">int</span> len2 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">wcslen</span>((WCHAR<span style="color:#ec0000">*</span>)Buffer);//拼接全路径
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">wcsncat</span>(DosName,DeviceName<span style="color:#ec0000">+</span>len2,Len);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(DeviceObject<span style="color:#ec0000">-&gt;</span>Type <span style="color:#ec0000">==</span> FILE_DEVICE_NETWORK_FILE_SYSTEM)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">wcsncpy</span>(DosName,<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">&#34;</span>,Len);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">int</span> len2 <span style="color:#ec0000">=</span> <span style="color:#5f5fff">wcslen</span>((WCHAR<span style="color:#ec0000">*</span>)Buffer);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">wcsncat</span>(DosName,DeviceName<span style="color:#ec0000">+</span>len2,Len);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> STATUS_DEVICE_DATA_ERROR;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObReferenceObject</span>(FileObject);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObReferenceObject</span>(DeviceObject);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>得到EPROCESS对应ImageDosPath</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">GetProcessDosPathByObject</span>(PEPROCESS Process,LPVOID Buffer,ULONG Len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_UNSUCCESSFUL;
</span></span><span style="display:flex;"><span>	HANDLE ProcessHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	HANDLE FileHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">const</span> <span style="color:#5f5fff">int</span> FileBufSize <span style="color:#ec0000">=</span> <span style="color:#008900">4096</span>;
</span></span><span style="display:flex;"><span>	PUNICODE_STRING pFilePath <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePoolWithTag</span>(NonPagedPool,FileBufSize);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>pFilePath)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObOpenObjectByPointer</span>(Process,OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>,KernelMode,<span style="color:#ec0000">&amp;</span>ProcessHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">NtQueryInformationProcess</span>(ProcessHandle,ProcessImageFileName,pFilePath,FileBufSize,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(pFilePath<span style="color:#ec0000">-&gt;</span>Buffer))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			OBJECT_ATTRIBUTES oa;
</span></span><span style="display:flex;"><span>			IO_STATUS_BLOCK IoStatusBlock;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>oa,pFilePath,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span>OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoCreateFile</span>(<span style="color:#ec0000">&amp;</span>FileHandle,GENERIC_READ <span style="color:#ec0000">|</span> SYNCHRONIZE,<span style="color:#ec0000">&amp;</span>oa,<span style="color:#ec0000">&amp;</span>IoStatusBlock,<span style="color:#ec0000">NULL</span>,FILE_ATTRIBUTE_NORMAL,
</span></span><span style="display:flex;"><span>				FILE_SHARE_READ,FILE_OPEN,FILE_NON_DIRECTORY_FILE <span style="color:#ec0000">|</span> FILE_SYNCHRONOUS_IO_NONALERT,<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,CreateFileTypeNone,
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">NULL</span>,IO_NO_PARAMETER_CHECKING);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			{// GetProcessDosPathByHandle
</span></span><span style="display:flex;"><span>				OBJECT_HANDLE_INFORMATION HandleInformation;
</span></span><span style="display:flex;"><span>				PFILE_OBJECT FileObject <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>				UNICODE_STRING DriveDosName <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(FileHandle,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>,KernelMode,(PVOID<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>FileObject,<span style="color:#ec0000">&amp;</span>HandleInformation);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> FileObject <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span> <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(FileObject) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(FileObject<span style="color:#ec0000">-&gt;</span>FileName.Buffer))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">IoGetRelatedDeviceObject</span>(FileObject))
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">RtlVolumeDeviceToDosName</span>(FileObject<span style="color:#ec0000">-&gt;</span>DeviceObject,<span style="color:#ec0000">&amp;</span>DriveDosName);//获取盘符
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> DriveDosName.Buffer <span style="color:#ec0000">&amp;&amp;</span> DriveDosName.Length <span style="color:#ec0000">+</span> FileObject<span style="color:#ec0000">-&gt;</span>FileName.Length <span style="color:#ec0000">&lt;</span> Len)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							<span style="color:#5f5fff">memcpy</span>(Buffer,DriveDosName.Buffer,DriveDosName.Length);
</span></span><span style="display:flex;"><span>							<span style="color:#5f5fff">memcpy</span>((<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)Buffer<span style="color:#ec0000">+</span>DriveDosName.Length,FileObject<span style="color:#ec0000">-&gt;</span>FileName.Buffer,FileObject<span style="color:#ec0000">-&gt;</span>FileName.Length);
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">ObDereferenceObject</span>(FileObject);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(DriveDosName.Buffer)
</span></span><span style="display:flex;"><span>						<span style="color:#5f5fff">ExFreePool</span>(DriveDosName.Buffer);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(FileHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">NtClose</span>(FileHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ProcessHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">NtClose</span>(ProcessHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ExFreePool</span>(pFilePath);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>随机化程序名机制</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>Void <span style="color:#5f5fff">RandomImageNameToHide</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>ANSI_STRING QQEXEA,IMAGENAMEA;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> ImageName;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitAnsiString</span>(<span style="color:#ec0000">&amp;</span>QQEXEA,<span style="color:#008900">&#34;QQPCRTP.EXE&#34;</span>);
</span></span><span style="display:flex;"><span>	ImageName <span style="color:#ec0000">=</span> <span style="color:#5f5fff">PsGetProcessImageFileName</span>(<span style="color:#5f5fff">IoGetCurrentProcess</span>());
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitAnsiString</span>(<span style="color:#ec0000">&amp;</span>IMAGENAMEA,ImageName);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">RtlCompareString</span>(<span style="color:#ec0000">&amp;</span>IMAGENAMEA,<span style="color:#ec0000">&amp;</span>QQEXEA,TRUE))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		LARGE_INTEGER Time,LocalTime;
</span></span><span style="display:flex;"><span>		TIME_FIELDS TimeFields;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeQuerySystemTime</span>(<span style="color:#ec0000">&amp;</span>Time);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExSystemTimeToLocalTime</span>(<span style="color:#ec0000">&amp;</span>Time,<span style="color:#ec0000">&amp;</span>LocalTime);
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlTimeToTimeFields</span>(<span style="color:#ec0000">&amp;</span>LocalTime,<span style="color:#ec0000">&amp;</span>TimeFields);
</span></span><span style="display:flex;"><span>		ImageName[TimeFields.Second <span style="color:#ec0000">%</span> <span style="color:#008900">5</span>] <span style="color:#ec0000">=</span> (TimeFields.Second <span style="color:#ec0000">%</span> <span style="color:#008900">26</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">&#39;A&#39;</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>根据进程文件名获取进程信息</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>Bool <span style="color:#5f5fff">GetProcessInfoByFileName</span>(<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> FileName, PVOID Buffer,<span style="color:#5f5fff">int</span> Size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG InfoLen;
</span></span><span style="display:flex;"><span>	PVOID Modules;
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	BOOL Find <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ZwQuerySystemInformation</span>(SystemModuleInformation,<span style="color:#ec0000">&amp;</span>InfoLen,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>InfoLen);
</span></span><span style="display:flex;"><span>	modules <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(PagedPool,InfoLen);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">If</span>(<span style="color:#ec0000">!</span>modules)
</span></span><span style="display:flex;"><span>		Return FALSE;
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQuerySystemInformation</span>(SystemModuleInformation, modules,InfoLen);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">If</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">For</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>modules<span style="color:#ec0000">-&gt;</span> NumberOfModules;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			Int offset <span style="color:#ec0000">=</span> modules<span style="color:#ec0000">-&gt;</span>Modules[i].OffsetToFileName;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">If</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">stricmp</span>(modules<span style="color:#ec0000">-&gt;</span>Modules[i].FullPathName[offset],FileName)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">Memcpy</span>(Buffer, <span style="color:#ec0000">&amp;</span>modules<span style="color:#ec0000">-&gt;</span>Modules[i],Size);
</span></span><span style="display:flex;"><span>				Find <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>				Break;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ExFreePool</span>(modules);
</span></span><span style="display:flex;"><span>	Return FALSE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>两种方式调用内核函数:</p>
<pre tabindex="0"><code>// 法一：以ZwQueryVirtualMemory为例
UNICODE_STRING FuncName;
FARPROC fZwQueryVirtualMemory;
RtiInitUnicodeString(&amp;FuncName, L”ZwQueryVirtualMemory”);
fZwQueryVirtualMemory = MmGetSystemRoutineAddress(&amp;FuncName);

// 法二：
RTL_PROCESS_MODULE_INFORMATION ImageInfo;
RtlZeroMemory(&amp;ImageInfo,sizeof(ImageInfo));
If(GetProcessInfoByFileName(“ntdll.dll”,&amp;ImageInfo,sizeof(ImageInfo)))
NtQueryVirtualMemorySSDTIndex = GetSSDTApiIndex(ImageInfo.ImageBase,&#34;NtQueryVirtualMemory&#34;);

// 用法:
ZwQueryVirtualMemoryEx(...)
{
	_asm
	{
		Push ebp
		Mov ebp,esp
		Mov eax, fZwQueryVirtualMemory
		Test eax,eax
		Jz $+3
		Pop ebp
		Jmp eax
		Cmp NtQueryVirtualMemorySSDTIndex,-1
		Jz $+6
		Pop ebp
		Jmp TAG
		Mov eax,C0000001h
		Pop ebp
		Retn 18h
TAG:
		Mov eax, NtQueryVirtualMemorySSDTIndex
		Lea edx,dword ptr [esp+4]
		Int 2Eh
		Retn 18h
	}
}
</code></pre><p>判断一段地址有效性</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">CheckAddressValid</span>(PVOID VirtualAddress, <span style="color:#5f5fff">int</span> Length)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> result;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> ( VirtualAddress )
</span></span><span style="display:flex;"><span>		result <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MmIsAddressValid</span>(VirtualAddress) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(VirtualAddress <span style="color:#ec0000">+</span> Length);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		result <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>获取对象类型</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>POBJECT_TYPE <span style="color:#5f5fff">GetTypeFromObject</span>(PVOID Object)
</span></span><span style="display:flex;"><span>{//从对象获取对象类型
</span></span><span style="display:flex;"><span>	UNICODE_STRING UObGetObjectType;
</span></span><span style="display:flex;"><span>	POBJECT_TYPE ObjectType;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UObGetObjectType,<span style="color:#008900">L</span><span style="color:#008900">&#34;ObGetObjectType&#34;</span>);
</span></span><span style="display:flex;"><span>	PVOID ObGetObjectType <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MmGetSystemRoutineAddress</span>(<span style="color:#ec0000">&amp;</span>UObGetObjectType);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(ObGetObjectType)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ObjectType <span style="color:#ec0000">=</span> ((<span style="color:#5f5fff">POBJECT_TYPE</span> (<span style="color:#ec0000">__stdcall</span><span style="color:#ec0000">*</span>)(PVOID ))ObGetObjectType)(Object);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>//Vista以前
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ObjectType <span style="color:#ec0000">=</span> ((OBJECT_HEADER<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">OBJECT_TO_OBJECT_HEADER</span>(Object))<span style="color:#ec0000">-&gt;</span>Type;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="检测腾讯程序合法性">检测腾讯程序合法性</h4>
<p>  对当加载驱动的进程进行md5校验，如果校验失败则拒绝加载；从<code>\\REGISTRY\\MACHINE\\SYSTEM\\CurrentControlSet\\Services\\TSKSP\\InstallDir</code>获取q管安装目录</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">CheckTsFileValid</span>(PEPROCESS Process)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">const</span> <span style="color:#5f5fff">int</span> BufSize <span style="color:#ec0000">=</span> <span style="color:#008900">522</span>;
</span></span><span style="display:flex;"><span>	WCHAR CurProcFileDosName[<span style="color:#008900">260</span>];
</span></span><span style="display:flex;"><span>	WCHAR<span style="color:#ec0000">*</span> FileDosName <span style="color:#ec0000">=</span> (WCHAR<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,BufSize);
</span></span><span style="display:flex;"><span>	WCHAR<span style="color:#ec0000">*</span> FileFullName <span style="color:#ec0000">=</span> (WCHAR<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#008900">520</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(FileDosName <span style="color:#ec0000">&amp;&amp;</span> FileFullName)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">memset</span>(FileDosName,<span style="color:#008900">0</span>,BufSize);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">GetProcessDosPathByObject</span>(Process,FileDosName,<span style="color:#008900">520</span>))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">GetProcessNameById</span>(<span style="color:#5f5fff">PsGetCurrentProcessId</span>(),CurProcFileDosName,<span style="color:#008900">520</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span><span style="color:#5f5fff">wcsicmp</span>(CurProcFileDosName,FileDosName))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				UNICODE_STRING UFileFullName;
</span></span><span style="display:flex;"><span>				OBJECT_ATTRIBUTES oa;
</span></span><span style="display:flex;"><span>				HANDLE FileHandle;
</span></span><span style="display:flex;"><span>				IO_STATUS_BLOCK IoStatusBlock;
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">RtlZeroMemory</span>(FileFullName,<span style="color:#008900">520</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">wnsprintfW</span>(FileFullName,<span style="color:#008900">259</span>,<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">??</span><span style="color:#008900">\\</span><span style="color:#008900">%ws&#34;</span>,FileDosName);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>oa,FileFullName,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span>OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoCreateFile</span>(<span style="color:#ec0000">&amp;</span>FileHandle,GENERIC_READ <span style="color:#ec0000">|</span> SYNCHRONIZE,<span style="color:#ec0000">&amp;</span>oa,<span style="color:#ec0000">&amp;</span>IoStatusBlock,<span style="color:#ec0000">NULL</span>,FILE_ATTRIBUTE_NORMAL,
</span></span><span style="display:flex;"><span>					FILE_SHARE_READ,FILE_OPEN,FILE_NON_DIRECTORY_FILE <span style="color:#ec0000">|</span> FILE_SYNCHRONOUS_IO_NONALERT,<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,CreateFileTypeNone,
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">NULL</span>,IO_NO_PARAMETER_CHECKING);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					FILE_STANDARD_INFORMATION FileInformation;
</span></span><span style="display:flex;"><span>					status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQueryInformationFile</span>(FileHandle,<span style="color:#ec0000">&amp;</span>IoStatusBlock,<span style="color:#ec0000">&amp;</span>FileInformation,<span style="color:#ec0000">sizeof</span>(FileInformation),FileStandardInformation);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> FileInformation.EndOfFile.LowPart <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0xA00000</span>)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						PVOID Buffer <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,FileInformation.EndOfFile.LowPart);
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(Buffer)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwReadFile</span>(FileHandle,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">&amp;</span>IoStatusBlock,Buffer,FileInformation.EndOfFile.LowPart,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">CheckNtImageValid</span>(Buffer))
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								ULONG SecretDataOffset <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(ULONG<span style="color:#ec0000">*</span>)((PIMAGE_DOS_HEADER)Buffer)<span style="color:#ec0000">-&gt;</span>e_res2;
</span></span><span style="display:flex;"><span>								/************************************************************************/
</span></span><span style="display:flex;"><span>								/* 下面将Buffer+SecretDataOffset处的128字节数据进行md5校验，原始数据如下*/
</span></span><span style="display:flex;"><span>								// b8 92 77 ac 41 ee 20 b1-0d 0c ce d7 a2 95 b3 96
</span></span><span style="display:flex;"><span>								// 46 3f 16 ba 72 4d b9 df-2c 2f a5 f9 d2 63 3c 35
</span></span><span style="display:flex;"><span>								// 06 45 a2 dc bf 5c a7 6f-89 d5 45 e2 2b db 30 75
</span></span><span style="display:flex;"><span>								// d3 76 93 84 9b fc e4 62-ed 21 d5 6a db 90 84 df
</span></span><span style="display:flex;"><span>								// fc 1f ba 07 8d fd 7f 6d-f8 67 41 34 cc f3 e2 4a
</span></span><span style="display:flex;"><span>								// 04 73 8b 8a f6 7c 2c d5-10 21 cf 25 80 18 fc be
</span></span><span style="display:flex;"><span>								// 9f 5f c8 ea 47 c8 95 5a-79 07 be 54 9c 0d 12 36
</span></span><span style="display:flex;"><span>								// 0c f6 9a e6 71 0d c1 27-29 c2 9d e8 7e f0 b7 05
</span></span><span style="display:flex;"><span>								/************************************************************************/
</span></span><span style="display:flex;"><span>								//.........................省略md5计算过程
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>							<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">ZwClose</span>(FileHandle);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(FileDosName)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(FileDosName);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(FileFullName)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ExFreePool</span>(FileFullName);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="解锁文件">解锁文件</h4>
<p>  设置文件属性为FILE_ATTRIBUTE_NORMAL；执行IopCloseFile  IRP_MJ_LOCK_CONTROL IRP_MN_UNLOCK_ALL；从句柄表中找到所有文件对象，如果路径匹配则关闭句柄CmCloseHandle</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> NTSTATUS <span style="color:#5f5fff">EndSetFileAttributes</span> ( IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp, IN PVOID Context )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	Irp<span style="color:#ec0000">-&gt;</span>UserIosb<span style="color:#ec0000">-&gt;</span>Status <span style="color:#ec0000">=</span> Irp<span style="color:#ec0000">-&gt;</span>IoStatus.Status;
</span></span><span style="display:flex;"><span>	Irp<span style="color:#ec0000">-&gt;</span>UserIosb<span style="color:#ec0000">-&gt;</span>Information <span style="color:#ec0000">=</span> Irp<span style="color:#ec0000">-&gt;</span>IoStatus.Information;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">KeSetEvent</span>(Irp<span style="color:#ec0000">-&gt;</span>UserEvent, <span style="color:#008900">0</span>, FALSE);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">IoFreeIrp</span>(Irp);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> STATUS_MORE_PROCESSING_REQUIRED;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">ResetFileAttributes</span>(HANDLE FileHandle)
</span></span><span style="display:flex;"><span>{//设置文件属性为NORMAL
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	PDEVICE_OBJECT pDevObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PIRP pIrp <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	KEVENT Event;
</span></span><span style="display:flex;"><span>	IO_STATUS_BLOCK ios <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	FILE_BASIC_INFORMATION BasicInfo;
</span></span><span style="display:flex;"><span>	PIO_STACK_LOCATION IrpSp;
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(FileHandle,<span style="color:#008900">0</span>,<span style="color:#ec0000">*</span>IoFileObjectType,KernelMode,<span style="color:#ec0000">&amp;</span>FileObject,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pDevObj <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoGetRelatedDeviceObject</span>(FileObject);//穿透
</span></span><span style="display:flex;"><span>		pIrp <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoAllocateIrp</span>(pDevObj<span style="color:#ec0000">-&gt;</span>StackSize,TRUE);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(pIrp)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeInitializeEvent</span>(<span style="color:#ec0000">&amp;</span>Event,SynchronizationEvent,FALSE);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">RtlZeroMemory</span>(<span style="color:#ec0000">&amp;</span>BasicInfo,<span style="color:#ec0000">sizeof</span>(BasicInfo));
</span></span><span style="display:flex;"><span>			BasicInfo.FileAttributes <span style="color:#ec0000">=</span> FILE_ATTRIBUTE_NORMAL;
</span></span><span style="display:flex;"><span>			pIrp<span style="color:#ec0000">-&gt;</span>AssociatedIrp.SystemBuffer <span style="color:#ec0000">=</span> (PVOID)<span style="color:#ec0000">&amp;</span>BasicInfo;
</span></span><span style="display:flex;"><span>			pIrp<span style="color:#ec0000">-&gt;</span>UserEvent <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>Event;
</span></span><span style="display:flex;"><span>			pIrp<span style="color:#ec0000">-&gt;</span>UserIosb <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>ios;
</span></span><span style="display:flex;"><span>			pIrp<span style="color:#ec0000">-&gt;</span>Tail.Overlay.OriginalFileObject <span style="color:#ec0000">=</span> FileObject;
</span></span><span style="display:flex;"><span>			pIrp<span style="color:#ec0000">-&gt;</span>Tail.Overlay.Thread <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeGetCurrentThread</span>();
</span></span><span style="display:flex;"><span>			pIrp<span style="color:#ec0000">-&gt;</span>RequestorMode <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>			IrpSp <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoGetNextIrpStackLocation</span>( pIrp );
</span></span><span style="display:flex;"><span>			IrpSp<span style="color:#ec0000">-&gt;</span>MajorFunction <span style="color:#ec0000">=</span> IRP_MJ_SET_INFORMATION;
</span></span><span style="display:flex;"><span>			IrpSp<span style="color:#ec0000">-&gt;</span>DeviceObject <span style="color:#ec0000">=</span> pDevObj;
</span></span><span style="display:flex;"><span>			IrpSp<span style="color:#ec0000">-&gt;</span>FileObject <span style="color:#ec0000">=</span> FileObject;
</span></span><span style="display:flex;"><span>			IrpSp<span style="color:#ec0000">-&gt;</span>Parameters.SetFile.Length <span style="color:#ec0000">=</span> <span style="color:#ec0000">sizeof</span>(BasicInfo);
</span></span><span style="display:flex;"><span>			IrpSp<span style="color:#ec0000">-&gt;</span>Parameters.SetFile.FileInformationClass <span style="color:#ec0000">=</span> FileBasicInformation;
</span></span><span style="display:flex;"><span>			IrpSp<span style="color:#ec0000">-&gt;</span>Parameters.SetFile.FileObject <span style="color:#ec0000">=</span> FileObject;
</span></span><span style="display:flex;"><span>			IrpSp<span style="color:#ec0000">-&gt;</span>CompletionRoutine <span style="color:#ec0000">=</span> EndSetFileAttributes;
</span></span><span style="display:flex;"><span>			IrpSp<span style="color:#ec0000">-&gt;</span>Context <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>			IrpSp<span style="color:#ec0000">-&gt;</span>Control <span style="color:#ec0000">=</span> SL_INVOKE_ON_CANCEL<span style="color:#ec0000">|</span>SL_INVOKE_ON_SUCCESS<span style="color:#ec0000">|</span>SL_INVOKE_ON_ERROR;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">IoCallDriver</span>(pDevObj,Irp);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">KeWaitForSingleObject</span>(<span style="color:#ec0000">&amp;</span>Event,<span style="color:#008900">0</span>,KernelMode,FALSE,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ObDereferenceObject</span>(FileObject);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> STATUS_INSUFFICIENT_RESOURCES;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> ( FileObject )
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(FileObject);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">UnlockFileThread</span>(PVOID StartContext)
</span></span><span style="display:flex;"><span>{//关闭系统对象句柄
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">CmpSetHandleProtection</span>(<span style="color:#ec0000">&amp;</span>Ohfi,FALSE);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(StartContext)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">NtClose</span>(StartContext);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">PsTerminateSystemThread</span>(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">TryUnlockFile</span>(PFILE_OBJECT FileObject)
</span></span><span style="display:flex;"><span>{//解锁文件
</span></span><span style="display:flex;"><span>	SYSTEM_HANDLE_INFORMATION HandleInformation1;
</span></span><span style="display:flex;"><span>	ULONG RetLen <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	PVOID Buffer;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ZwQuerySystemInformation</span>(SystemHandleInformation,<span style="color:#ec0000">&amp;</span>HandleInformation1,<span style="color:#ec0000">sizeof</span>(HandleInformation1),<span style="color:#ec0000">&amp;</span>RetLen);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(RetLen)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		POBJECT_NAME_INFORMATION ObjectNameInfo1 <span style="color:#ec0000">=</span> (POBJECT_NAME_INFORMATION)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#008900">2056</span>);
</span></span><span style="display:flex;"><span>		POBJECT_NAME_INFORMATION ObjectNameInfo2 <span style="color:#ec0000">=</span> (POBJECT_NAME_INFORMATION)<span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#008900">2056</span>);
</span></span><span style="display:flex;"><span>		ObjectNameInfo1<span style="color:#ec0000">-&gt;</span>Name.Length <span style="color:#ec0000">=</span> <span style="color:#008900">2048</span>;
</span></span><span style="display:flex;"><span>		ObjectNameInfo2<span style="color:#ec0000">-&gt;</span>Name.Length <span style="color:#ec0000">=</span> <span style="color:#008900">2048</span>;
</span></span><span style="display:flex;"><span>		Buffer <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(PagedPool,RetLen<span style="color:#ec0000">+</span><span style="color:#008900">4096</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObQueryNameString</span>(FileObject,ObjectNameInfo2,ObjectNameInfo2<span style="color:#ec0000">-&gt;</span>Name.Length,<span style="color:#ec0000">&amp;</span>RetLen);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> Buffer <span style="color:#ec0000">&amp;&amp;</span> ObjectNameInfo1)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQuerySystemInformation</span>(SystemHandleInformation,Buffer,RetLen<span style="color:#ec0000">+</span><span style="color:#008900">4096</span>,<span style="color:#ec0000">&amp;</span>RetLen);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				UCHAR ObjectTypeIndex <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>				PSYSTEM_HANDLE_INFORMATION HandleInformation2 <span style="color:#ec0000">=</span> (PSYSTEM_HANDLE_INFORMATION)Buffer;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>HandleInformation2<span style="color:#ec0000">-&gt;</span>NumberOfHandles;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(HandleInformation2<span style="color:#ec0000">-&gt;</span>Handles[i].Object <span style="color:#ec0000">==</span> FileObject)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						ObjectTypeIndex <span style="color:#ec0000">=</span> HandleInformation2<span style="color:#ec0000">-&gt;</span>Handles[i].ObjectTypeIndex;
</span></span><span style="display:flex;"><span>						Break;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(ObjectTypeIndex)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>HandleInformation2<span style="color:#ec0000">-&gt;</span>NumberOfHandles;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(HandleInformation2<span style="color:#ec0000">-&gt;</span>Handles[i].ObjectTypeIndex <span style="color:#ec0000">==</span> ObjectTypeIndex)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							CLIENT_ID ClientId;
</span></span><span style="display:flex;"><span>							HANDLE TargetProcessHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>							HANDLE CurrentProcessHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>							HANDLE TargetHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>							PVOID TargetFileObject <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>							OBJECT_ATTRIBUTES oa;
</span></span><span style="display:flex;"><span>							ULONG RetLen;
</span></span><span style="display:flex;"><span>							<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>oa,<span style="color:#ec0000">NULL</span>,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span>OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>							ClientId.UniqueProcess <span style="color:#ec0000">=</span> HandleInformation2<span style="color:#ec0000">-&gt;</span>Handles[i].UniqueProcessId;
</span></span><span style="display:flex;"><span>							ClientId.UniqueThread <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>							status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwOpenProcess</span>(<span style="color:#ec0000">&amp;</span>CurrentProcessHandle,PROCESS_ALL_ACCESS, <span style="color:#ec0000">&amp;</span>oa, <span style="color:#ec0000">&amp;</span>ClientId);
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>oa,<span style="color:#ec0000">NULL</span>,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span>OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>								ClientId.UniqueProcess <span style="color:#ec0000">=</span> <span style="color:#5f5fff">PsGetCurrentProcessId</span>();
</span></span><span style="display:flex;"><span>								ClientId.UniqueThread <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>								status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwOpenProcess</span>(<span style="color:#ec0000">&amp;</span>TargetProcessHandle,PROCESS_ALL_ACCESS, <span style="color:#ec0000">&amp;</span>oa, <span style="color:#ec0000">&amp;</span>ClientId);
</span></span><span style="display:flex;"><span>								<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>								{//从引用到该对象的进程复制一份句柄到当前进程
</span></span><span style="display:flex;"><span>									status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwDuplicateObject</span>(CurrentProcessHandle,HandleInformation2<span style="color:#ec0000">-&gt;</span>Handles[i].HandleValue,TargetProcessHandle,<span style="color:#ec0000">&amp;</span>TargetHandle,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,DUPLICATE_SAME_ACCESS);
</span></span><span style="display:flex;"><span>									<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> TargetHandle)
</span></span><span style="display:flex;"><span>									{
</span></span><span style="display:flex;"><span>										status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(TargetHandle,GENERIC_READ,IoFileObjectType,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>TargetFileObject,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>										<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">MmIsAddressValid</span>(TargetFileObject) <span style="color:#ec0000">&amp;&amp;</span> TargetFileObject<span style="color:#ec0000">-&gt;</span>DeviceObject<span style="color:#ec0000">-&gt;</span>DeviceType <span style="color:#ec0000">==</span> FILE_DEVICE_DISK)
</span></span><span style="display:flex;"><span>										{
</span></span><span style="display:flex;"><span>											status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObQueryNameString</span>(TargetFileObject,ObjectNameInfo1,ObjectNameInfo1<span style="color:#ec0000">-&gt;</span>Name.Length,<span style="color:#ec0000">&amp;</span>RetLen);
</span></span><span style="display:flex;"><span>											<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>											{
</span></span><span style="display:flex;"><span>												<span style="color:#ec0000">__try</span>
</span></span><span style="display:flex;"><span>												{
</span></span><span style="display:flex;"><span>													<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">RtlEqualUnicodeString</span>(ObjectNameInfo1,ObjectNameInfo2,TRUE))
</span></span><span style="display:flex;"><span>													{
</span></span><span style="display:flex;"><span>														PEPROCESS Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>														KAPC_STATE ApcState;
</span></span><span style="display:flex;"><span>														HANDLE ProcessId <span style="color:#ec0000">=</span> HandleInformation2<span style="color:#ec0000">-&gt;</span>Handles[i].UniqueProcessId;
</span></span><span style="display:flex;"><span>														HANDLE ObjectHandle <span style="color:#ec0000">=</span> HandleInformation2<span style="color:#ec0000">-&gt;</span>Handles[i].HandleValue;
</span></span><span style="display:flex;"><span>														OBJECT_HANDLE_FLAG_INFORMATION Ohfi;
</span></span><span style="display:flex;"><span>														<span style="color:#ec0000">if</span>(ProcessId <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> ProcessId <span style="color:#ec0000">!=</span> <span style="color:#008900">4</span> <span style="color:#ec0000">&amp;&amp;</span> ProcessId <span style="color:#ec0000">!=</span> <span style="color:#008900">8</span>)
</span></span><span style="display:flex;"><span>														{
</span></span><span style="display:flex;"><span>															status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">PsLookupProcessByProcessId</span>(ProcessId,<span style="color:#ec0000">&amp;</span>Process);
</span></span><span style="display:flex;"><span>															<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>															{
</span></span><span style="display:flex;"><span>																<span style="color:#5f5fff">KeStackAttachProcess</span>(Process,<span style="color:#ec0000">&amp;</span>ApcState);
</span></span><span style="display:flex;"><span>																<span style="color:#5f5fff">CmpSetHandleProtection</span>(<span style="color:#ec0000">&amp;</span>Ohfi,FALSE);
</span></span><span style="display:flex;"><span>																<span style="color:#5f5fff">ZwClose</span>(ObjectHandle);
</span></span><span style="display:flex;"><span>																<span style="color:#5f5fff">KeUnstackDetachProcess</span>(<span style="color:#ec0000">&amp;</span>ApcState);
</span></span><span style="display:flex;"><span>																<span style="color:#ec0000">if</span>(Process)
</span></span><span style="display:flex;"><span>																{
</span></span><span style="display:flex;"><span>																	<span style="color:#5f5fff">ObDereferenceObject</span>(Process);
</span></span><span style="display:flex;"><span>																	Process <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>																}
</span></span><span style="display:flex;"><span>															}
</span></span><span style="display:flex;"><span>														}
</span></span><span style="display:flex;"><span>													}
</span></span><span style="display:flex;"><span>													<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>													{
</span></span><span style="display:flex;"><span>														HANDLE ThreadHandle <span style="color:#ec0000">=</span> <span style="color:#5f5fff">DecodeKernelHandle</span>(HandleInformation2<span style="color:#ec0000">-&gt;</span>Handles[i].HandleValue);
</span></span><span style="display:flex;"><span>														<span style="color:#5f5fff">PsCreateSystemThread</span>(<span style="color:#ec0000">&amp;</span>ThreadHandle,THREAD_ALL_ACCESS,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>,UnlockFileThread,ThreadHandle);
</span></span><span style="display:flex;"><span>														<span style="color:#5f5fff">ZwWaitForSingleObject</span>(ThreadHandle,FALSE,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>														<span style="color:#5f5fff">ZwClose</span>(ThreadHandle);
</span></span><span style="display:flex;"><span>													}
</span></span><span style="display:flex;"><span>												}
</span></span><span style="display:flex;"><span>												<span style="color:#ec0000">__finally</span>
</span></span><span style="display:flex;"><span>												{
</span></span><span style="display:flex;"><span>												}
</span></span><span style="display:flex;"><span>											}
</span></span><span style="display:flex;"><span>										}
</span></span><span style="display:flex;"><span>									}
</span></span><span style="display:flex;"><span>								}
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span> (TargetProcessHandle)
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								<span style="color:#5f5fff">ZwClose</span>(TargetProcessHandle);
</span></span><span style="display:flex;"><span>								TargetProcessHandle <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span> ( CurrentProcessHandle )
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								<span style="color:#5f5fff">ZwClose</span>(CurrentProcessHandle);
</span></span><span style="display:flex;"><span>								CurrentProcessHandle <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span> ( TargetHandle )
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								<span style="color:#5f5fff">ZwClose</span>(TargetHandle);
</span></span><span style="display:flex;"><span>								TargetHandle <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span> ( TargetFileObject )
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								<span style="color:#5f5fff">ObfDereferenceObject</span>(TargetFileObject);
</span></span><span style="display:flex;"><span>								TargetFileObject <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(Buffer)
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ExFreePool</span>(Buffer);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(ObjectNameInfo1)
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ExFreePool</span>(ObjectNameInfo1);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(ObjectNameInfo2)
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ExFreePool</span>(ObjectNameInfo2);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">UnlockFile</span>(PUNICODE_STRING FileDosPath)
</span></span><span style="display:flex;"><span>{//关闭句柄、解除引用、解锁文件
</span></span><span style="display:flex;"><span>	IO_STATUS_BLOCK IoStatusBlock <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES oa;
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	HANDLE FileHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT FileObject <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>oa,FileDosPath,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span>OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	//穿透IopCreateFile得到FileHandle
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ResetFileAttributes</span>(FileHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) )
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(FileHandle,<span style="color:#008900">0</span>,<span style="color:#ec0000">*</span>IoFileObjectType,KernelMode,<span style="color:#ec0000">&amp;</span>FileObject,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">IopDeleteFile</span>(FileObject);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">TryUnlockFile</span>(FileObject);
</span></span><span style="display:flex;"><span>			FileHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ObDereferenceObject</span>(FileObject);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(status <span style="color:#ec0000">==</span> STATUS_DELETE_PENDING)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">TryUnlockFile</span>(FileObject);
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>		FileHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(FileHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(FileHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="获取objectinitializer">获取ObjectInitializer</h3>
<p>获取RegObjectInitializer：</p>
<ul>
<li>获取操作系统版本并转化为数组下标[0-9]</li>
<li>获取\Registry\Machine\SYSTEM对应KeyObject，得到其POBJECT_TYPE，判断是否为”Key”类型</li>
<li>获取Ntos地址，获取CmpKeyObjectType的ParseProcedure，检测是否在Ntos中</li>
<li>获取PCM_KEY_BODY-&gt;KeyControlBlock-&gt; KeyHive的偏移，为获取GetCellRoutine</li>
<li>Hook GetCellRoutine为NewGetCellRoutine</li>
<li>创建线程依次执行ZwSetValueKey ZwQueryValueKey ZwEnumerateValueKey ZwEnumerateKey ZwDeleteValueKey ZwDeleteKey，触发GetCellRoutine</li>
<li>NewGetCellRoutine中在回溯栈中查找对应Zw<em>匹配机器码，符合则取得相应Cm</em>地址</li>
<li>解除Hook</li>
</ul>
<p>获取DriverObjectInitializer和DeviceObjectInitializer：</p>
<ul>
<li>获取操作系统版本并转化为数组下标[0-9]</li>
<li>获取DriverObject，得到其POBJECT_TYPE，判断是否为”Device”类型</li>
<li>分别获取DriverObjectType和DeviceObjectType的ObjectInitializer</li>
</ul>
<p>VersionIndex对照表</p>
<pre tabindex="0"><code>major   minor   build   out
*       *               10
5       1               1
5       2               2/3
5       *               10
6       0               4
6       1               5
6       2       8102    7
6       2       9200    8
6       2       *       10      
6       3       9600    9
6       3       *       10  
</code></pre><p>获取注册表OBJECT_TYPE，匹配对象类型，使用<code>\\Registry\\Machine\\SYSTEM</code>注册表对象</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>POBJECT_TYPE <span style="color:#5f5fff">GetRegKeyType</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	UNICODE_STRING RegPath,FuncName;
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>	HANDLE KeyHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG Disposition;
</span></span><span style="display:flex;"><span>	PCM_KEY_BODY KeyBody;
</span></span><span style="display:flex;"><span>	POBJECT_TYPE ObjType <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	FARPROC ObGetObjectType;
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>RegPath,<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Registry</span><span style="color:#008900">\\</span><span style="color:#008900">Machine</span><span style="color:#008900">\\</span><span style="color:#008900">SYSTEM&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#ec0000">&amp;</span>RegPath,<span style="color:#5f5fff">ExGetPreviousMode</span>() <span style="color:#ec0000">!=</span> KernelMode<span style="color:#ec0000">?</span><span style="color:#ec0000">OBJ_CASE_INSENSITIVE</span> :
</span></span><span style="display:flex;"><span>		OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span> OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);		
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwCreateKey</span>(<span style="color:#ec0000">&amp;</span>KeyHandle,KEY_QUERY_VALUE,<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>,REG_OPTION_NON_VOLATILE,<span style="color:#ec0000">&amp;</span>Disposition);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(KeyHandle,GENERIC_READ,<span style="color:#ec0000">NULL</span>,KernelMode,<span style="color:#ec0000">&amp;</span>KeyBody,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>FuncName,<span style="color:#008900">L</span><span style="color:#008900">&#34;ObGetObjectType&#34;</span>);
</span></span><span style="display:flex;"><span>			ObGetObjectType <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MmGetSystemRoutineAddress</span>(<span style="color:#ec0000">&amp;</span>FuncName);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(ObGetObjectType)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				ObjType <span style="color:#ec0000">=</span> ((<span style="color:#5f5fff">POBJECT_TYPE</span> (<span style="color:#ec0000">__stdcall</span><span style="color:#ec0000">*</span>)(PVOID))ObGetObjectType)(KeyBody);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(VersionIndex <span style="color:#ec0000">&lt;</span> <span style="color:#008900">5</span>)//win7 之前
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				ObjType <span style="color:#ec0000">=</span> ((OBJECT_HEADER<span style="color:#ec0000">*</span>)<span style="color:#5f5fff">OBJECT_TO_OBJECT_HEADER</span>(Object))<span style="color:#ec0000">-&gt;</span>Type;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ObDereferenceObject</span>(KeyBody);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(KeyHandle);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> ObjType;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> _OBJECT_TYPE_XP
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ERESOURCE Mutex;
</span></span><span style="display:flex;"><span>	LIST_ENTRY TypeList;
</span></span><span style="display:flex;"><span>	UNICODE_STRING Name;  
</span></span><span style="display:flex;"><span>	PVOID DefaultObject;
</span></span><span style="display:flex;"><span>	ULONG Index;
</span></span><span style="display:flex;"><span>	ULONG TotalNumberOfObjects;
</span></span><span style="display:flex;"><span>	ULONG TotalNumberOfHandles;
</span></span><span style="display:flex;"><span>	ULONG HighWaterNumberOfObjects;
</span></span><span style="display:flex;"><span>	ULONG HighWaterNumberOfHandles;
</span></span><span style="display:flex;"><span>	OBJECT_TYPE_INITIALIZER TypeInfo;
</span></span><span style="display:flex;"><span>	ERESOURCE ObjectLocks[ OBJECT_LOCK_COUNT ];
</span></span><span style="display:flex;"><span>} OBJECT_TYPE_XP, <span style="color:#ec0000">*</span>POBJECT_TYPE_XP;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> _OBJECT_TYPE_WIN7
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	LIST_ENTRY TypeList;
</span></span><span style="display:flex;"><span>	UNICODE_STRING Name;
</span></span><span style="display:flex;"><span>	PVOID DefaultObject;
</span></span><span style="display:flex;"><span>	ULONG Index;
</span></span><span style="display:flex;"><span>	ULONG TotalNumberOfObjects;
</span></span><span style="display:flex;"><span>	ULONG TotalNumberOfHandles;
</span></span><span style="display:flex;"><span>	ULONG HighWaterNumberOfObjects;
</span></span><span style="display:flex;"><span>	ULONG HighWaterNumberOfHandles;
</span></span><span style="display:flex;"><span>	OBJECT_TYPE_INITIALIZER TypeInfo;
</span></span><span style="display:flex;"><span>	EX_PUSH_LOCK TypeLock;
</span></span><span style="display:flex;"><span>	ULONG Key;
</span></span><span style="display:flex;"><span>	LIST_ENTRY CallbackList;
</span></span><span style="display:flex;"><span>} OBJECT_TYPE_WIN7, <span style="color:#ec0000">*</span>POBJECT_TYPE_WIN7;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">CmpRegKeyType</span>(POBJECT_TYPE ObjType)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	UNICODE_STRING ObjTypeName;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>ObjTypeName,<span style="color:#008900">L</span><span style="color:#008900">&#34;Key&#34;</span>);
</span></span><span style="display:flex;"><span>	PUNICODE_STRING SrcTypeName;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(VersionIndex <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">1</span> <span style="color:#ec0000">&amp;&amp;</span> VersionIndex <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">3</span>)//xp 2000
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		POBJECT_TYPE_XP _ObjType <span style="color:#ec0000">=</span> (POBJECT_TYPE_XP)ObjType;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">IsAddressRegionValid</span>(<span style="color:#ec0000">&amp;</span>_ObjType<span style="color:#ec0000">-&gt;</span>Name,<span style="color:#ec0000">sizeof</span>(UNICODE_STRING)))
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>		SrcTypeName <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>ObjType<span style="color:#ec0000">-&gt;</span>Name;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(VersionIndex <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">4</span> <span style="color:#ec0000">&amp;&amp;</span> VersionIndex <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">9</span>)//vista及之后
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		POBJECT_TYPE_WIN7 _ObjType <span style="color:#ec0000">=</span> (POBJECT_TYPE_WIN7)ObjType;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">IsAddressRegionValid</span>(<span style="color:#ec0000">&amp;</span>_ObjType<span style="color:#ec0000">-&gt;</span>Name,<span style="color:#ec0000">sizeof</span>(UNICODE_STRING)))
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>		SrcTypeName <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>ObjType<span style="color:#ec0000">-&gt;</span>Name;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">IsAddressRegionValid</span>(SrcTypeName<span style="color:#ec0000">-&gt;</span>Buffer,SrcTypeName<span style="color:#ec0000">-&gt;</span>Length))
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#5f5fff">RtlCompareUnicodeString</span>(<span style="color:#ec0000">&amp;</span>ObjTypeName,SrcTypeName,TRUE) <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>获取ParseProcedure</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>FARPROC RegObjectInitialzer[<span style="color:#008900">6</span>];
</span></span><span style="display:flex;"><span>FARPROC FileObjectInitialzer[<span style="color:#008900">6</span>];
</span></span><span style="display:flex;"><span>// 0 CloseProcedure
</span></span><span style="display:flex;"><span>// 1 DeleteProcedure
</span></span><span style="display:flex;"><span>// 2 ParseProcedure
</span></span><span style="display:flex;"><span>// 3 SecurityProcedure
</span></span><span style="display:flex;"><span>// 4 QueryNameProcedure
</span></span><span style="display:flex;"><span>// 5 OpenProcedure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">GetParseProcedure</span>(POBJECT_TYPE ObjectType)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PVOID modules;
</span></span><span style="display:flex;"><span>	ULONG InfoLen <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	OB_PARSE_METHOD Proc <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	ULONG_PTR NtosBegin <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	ULONG_PTR NtosEnd <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlZeroMemory</span>(RegObjectInitialzer,<span style="color:#ec0000">sizeof</span>(RegObjectInitialzer));
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>ObjectType)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ZwQuerySystemInformation</span>(SystemModuleInformation,<span style="color:#ec0000">&amp;</span>InfoLen,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>InfoLen);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(InfoLen <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>	modules <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(PagedPool,InfoLen);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>modules)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwQuerySystemInformation</span>(SystemModuleInformation,modules,<span style="color:#ec0000">&amp;</span>InfoLen);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> modules<span style="color:#ec0000">-&gt;</span>NumberOfModules)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		NtosBegin <span style="color:#ec0000">=</span> modules<span style="color:#ec0000">-&gt;</span>Modules[<span style="color:#008900">0</span>].ImageBase;
</span></span><span style="display:flex;"><span>		NtosEnd <span style="color:#ec0000">=</span> NtosBegin <span style="color:#ec0000">+</span> modules<span style="color:#ec0000">-&gt;</span>Modules[<span style="color:#008900">0</span>].ImageSize;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(VersionIndex <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">1</span> <span style="color:#ec0000">&amp;&amp;</span> VersionIndex <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">3</span>)//xp 2000
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			POBJECT_TYPE_XP _ObjType <span style="color:#ec0000">=</span> (POBJECT_TYPE_XP)ObjType;
</span></span><span style="display:flex;"><span>			Proc <span style="color:#ec0000">=</span> _ObjType<span style="color:#ec0000">-&gt;</span>TypeInfo.ParseProcedure;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(VersionIndex <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">4</span> <span style="color:#ec0000">&amp;&amp;</span> VersionIndex <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">9</span>)//vista及之后
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			POBJECT_TYPE_WIN7 _ObjType <span style="color:#ec0000">=</span> (POBJECT_TYPE_WIN7)ObjType;
</span></span><span style="display:flex;"><span>			Proc <span style="color:#ec0000">=</span> _ObjType<span style="color:#ec0000">-&gt;</span>TypeInfo.ParseProcedure;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ExFreePool</span>(Modules);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Proc <span style="color:#ec0000">&amp;&amp;</span> Proc <span style="color:#ec0000">&gt;=</span> NtosBegin <span style="color:#ec0000">&amp;&amp;</span> Proc <span style="color:#ec0000">&lt;=</span> NtosEnd)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		RegObjectInitialzer[<span style="color:#008900">2</span>] <span style="color:#ec0000">=</span> Proc;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>获取GetCellRoutine偏移，Hook GetCellRoutine</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">GetCellRoutineOffset</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ULONG result <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">switch</span> ( VersionIndex )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN2000</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXP</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WINXPSP3</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WINVISTA</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">6</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>      CellRoutineOffset <span style="color:#ec0000">=</span> <span style="color:#008900">16</span>;
</span></span><span style="display:flex;"><span>      Return <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN7</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN8_1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WIN10</span>:
</span></span><span style="display:flex;"><span>      CellRoutineOffset <span style="color:#ec0000">=</span> <span style="color:#008900">20</span>;
</span></span><span style="display:flex;"><span>	Return <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">return</span> result;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Hook和UnHook GetCellRoutine</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ec0000">volatile</span> ULONG HookCellRoutineRefCount <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">volatile</span> ULONG EnterCellRoutineRefCount <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>ULONG_PTR OldGetCellRoutine <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>BOOLEAN IsGetCell <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>ULONG_PTR pGetCellRoutine <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">HookCellRoutine</span>(BOOLEAN Hook)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>	UNICODE_STRING RegPath;
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	HANDLE KeyHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PCM_KEY_BODY KeyBody <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	BOOLEAN success <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">while</span>(<span style="color:#5f5fff">InterlockedCompareExchange</span>(<span style="color:#ec0000">&amp;</span>HookCellRoutineRefCount,<span style="color:#008900">1</span>,<span style="color:#008900">0</span>))//同步
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		LARGE_INTEGER Interval;
</span></span><span style="display:flex;"><span>		Interval.QuadPart <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">10000</span>i64 <span style="color:#ec0000">*</span> <span style="color:#008900">100</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeDelayExecutionThread</span>(KernelMode,FALSE,<span style="color:#ec0000">&amp;</span>Interval);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(Hook)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>((CellRoutineBit <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x111111</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">0x111111</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>RegPath);
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#ec0000">&amp;</span>RegPath,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span> OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwOpenKey</span>(<span style="color:#ec0000">&amp;</span>KeyHandle,KEY_ALL_ACCESS,<span style="color:#ec0000">&amp;</span>Oa);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(KeyHandle,KEY_SET_VALUE,<span style="color:#ec0000">*</span>CmKeyObjectType,KernelMode,<span style="color:#ec0000">&amp;</span>KeyBody,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					ULONG_PTR pGetCellRoutine <span style="color:#ec0000">=</span> (ULONG_PTR)<span style="color:#ec0000">&amp;</span>((HHIVE<span style="color:#ec0000">*</span>)((BYTE<span style="color:#ec0000">*</span>)KeyBody<span style="color:#ec0000">-&gt;</span>KeyControlBlock <span style="color:#ec0000">+</span> CellRoutineOffset))<span style="color:#ec0000">-&gt;</span>GetCellRoutine;
</span></span><span style="display:flex;"><span>					OldGetCellRoutine <span style="color:#ec0000">=</span> <span style="color:#5f5fff">InterlockedExchange</span>(pGetCellRoutine,NewGetCellRoutine);
</span></span><span style="display:flex;"><span>					IsGetCell <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>					success <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(KeyBody)
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ObReferenceObjectByHandle</span>(KeyBody);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(KeyHandle)
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ZwClose</span>(KeyHandle);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>//UnHook
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(IsGetCell <span style="color:#ec0000">&amp;&amp;</span> OldGetCellRoutine <span style="color:#ec0000">&amp;&amp;</span> pGetCellRoutine)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">int</span> count <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">InterlockedExchange</span>(pGetCellRoutine,OldGetCellRoutine);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">do</span> 
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				LARGE_INTEGER Interval;
</span></span><span style="display:flex;"><span>				Interval.QuadPart <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">10000</span>i64 <span style="color:#ec0000">*</span> <span style="color:#008900">50</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">KeDelayExecutionThread</span>(KernelMode,FALSE,<span style="color:#ec0000">&amp;</span>Interval);
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">InterlockedExchange</span>(<span style="color:#ec0000">&amp;</span>count,EnterCellRoutineRefCount);
</span></span><span style="display:flex;"><span>			} <span style="color:#ec0000">while</span> (count);
</span></span><span style="display:flex;"><span>			OldGetCellRoutine <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>			pGetCellRoutine <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>			IsGetCell <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>			success <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InterlockedExchange</span>(<span style="color:#ec0000">&amp;</span>HookCellRoutineRefCount,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> success;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="创建系统线程获取cm函数">创建系统线程获取Cm*函数</h4>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#5f5fff">int</span> CmIndex;
</span></span><span style="display:flex;"><span>/*
</span></span><span style="display:flex;"><span>	CmQueryValueKey 0
</span></span><span style="display:flex;"><span>	CmSetValueKey 1
</span></span><span style="display:flex;"><span>	CmDeleteValueKey 2
</span></span><span style="display:flex;"><span>	CmDeleteKey 3
</span></span><span style="display:flex;"><span>	CmEnumerateKey 4
</span></span><span style="display:flex;"><span>	CmEnumerateValueKey 5
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">SetCmTrap</span>()
</span></span><span style="display:flex;"><span>{//通过注册表操作触发已经Hook的ObjectInitializer
</span></span><span style="display:flex;"><span>	WCHAR ValueName[] <span style="color:#ec0000">=</span> <span style="color:#008900">L</span><span style="color:#008900">&#34;100000&#34;</span>;
</span></span><span style="display:flex;"><span>	WCHAR KeyPath[] <span style="color:#ec0000">=</span> <span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Registry</span><span style="color:#008900">\\</span><span style="color:#008900">Machine</span><span style="color:#008900">\\</span><span style="color:#008900">SYSTEM</span><span style="color:#008900">\\</span><span style="color:#008900">00000&#34;</span>;
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES Oa;
</span></span><span style="display:flex;"><span>	UNICODE_STRING UKeyPath,UValueName;
</span></span><span style="display:flex;"><span>	LARGE_INTEGER CurrentTime,LocalTime;
</span></span><span style="display:flex;"><span>	HANDLE KeyHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;;
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	DWORD RetLen;
</span></span><span style="display:flex;"><span>	TIME_FIELDS TimeFields;
</span></span><span style="display:flex;"><span>	ULONG Disposition;
</span></span><span style="display:flex;"><span>	BOOLEAN result <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">KeQuerySystemTime</span>(<span style="color:#ec0000">&amp;</span>CurrentTime);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">ExSystemTimeToLocalTime</span>(<span style="color:#ec0000">&amp;</span>CurrentTime,LocalTime);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlTimeToTimeFields</span>(<span style="color:#ec0000">&amp;</span>LocalTime,<span style="color:#ec0000">&amp;</span>TimeFields);
</span></span><span style="display:flex;"><span>	ValueName[<span style="color:#008900">0</span>] <span style="color:#ec0000">+=</span> TimeFields.Milliseconds <span style="color:#ec0000">%</span> <span style="color:#008900">9</span>;
</span></span><span style="display:flex;"><span>	ValueName[<span style="color:#008900">1</span>] <span style="color:#ec0000">+=</span> TimeFields.Second <span style="color:#ec0000">%</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>	ValueName[<span style="color:#008900">3</span>] <span style="color:#ec0000">+=</span> TimeFields.Minute <span style="color:#ec0000">%</span> <span style="color:#008900">7</span>;
</span></span><span style="display:flex;"><span>	ValueName[<span style="color:#008900">4</span>] <span style="color:#ec0000">+=</span> TimeFields.Milliseconds <span style="color:#ec0000">%</span> <span style="color:#008900">9</span>;
</span></span><span style="display:flex;"><span>	ValueName[<span style="color:#008900">5</span>] <span style="color:#ec0000">+=</span> TimeFields.Second <span style="color:#ec0000">%</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>	KeyPath[<span style="color:#008900">25</span>] <span style="color:#ec0000">+=</span> TimeFields.Second <span style="color:#ec0000">%</span> <span style="color:#008900">9</span>;
</span></span><span style="display:flex;"><span>	KeyPath[<span style="color:#008900">26</span>] <span style="color:#ec0000">+=</span> TimeFields.Milliseconds <span style="color:#ec0000">%</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>	KeyPath[<span style="color:#008900">27</span>] <span style="color:#ec0000">+=</span> TimeFields.Second <span style="color:#ec0000">%</span> <span style="color:#008900">7</span>;
</span></span><span style="display:flex;"><span>	KeyPath[<span style="color:#008900">28</span>] <span style="color:#ec0000">+=</span> TimeFields.Milliseconds <span style="color:#ec0000">%</span> <span style="color:#008900">9</span>;
</span></span><span style="display:flex;"><span>	KeyPath[<span style="color:#008900">29</span>] <span style="color:#ec0000">+=</span> TimeFields.Minute <span style="color:#ec0000">%</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UKeyPath,KeyPath);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InitializeObjectAttributes</span>(<span style="color:#ec0000">&amp;</span>Oa,UKeyPath,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span>OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ZwCreateKey</span>(<span style="color:#ec0000">&amp;</span>KeyHandle,KEY_ALL_ACCESS,<span style="color:#ec0000">&amp;</span>Oa,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>,REG_OPTION_NON_VOLATILE,<span style="color:#ec0000">&amp;</span>Disposition);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UValueName,ValueName);
</span></span><span style="display:flex;"><span>//和NewGetCellRoutine配合使用
</span></span><span style="display:flex;"><span>		CmIndex <span style="color:#ec0000">=</span> ECmSetValueKey;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwSetValueKey</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UValueName,<span style="color:#008900">0</span>,REG_SZ,ValueName,<span style="color:#5f5fff">wcslen</span>(ValueName)<span style="color:#ec0000">+</span><span style="color:#008900">2</span>);
</span></span><span style="display:flex;"><span>		CmIndex <span style="color:#ec0000">=</span> ECmQueryValueKey;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwQueryValueKey</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UValueName,KeyValuePartialInformation,<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>RetLen);
</span></span><span style="display:flex;"><span>		CmIndex <span style="color:#ec0000">=</span> ECmEnumerateValueKey;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwEnumerateValueKey</span>(KeyHandle,<span style="color:#008900">0</span>,KeyValueBasicInformation,<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>RetLen);
</span></span><span style="display:flex;"><span>		CmIndex <span style="color:#ec0000">=</span> ECmEnumerateKey;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwEnumerateKey</span>(KeyHandle,<span style="color:#008900">0</span>,KeyValueBasicInformation,<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>RetLen);
</span></span><span style="display:flex;"><span>		CmIndex <span style="color:#ec0000">=</span> ECmDeleteValueKey;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwDeleteValueKey</span>(KeyHandle,<span style="color:#ec0000">&amp;</span>UValueName);
</span></span><span style="display:flex;"><span>		CmIndex <span style="color:#ec0000">=</span> ECmDeleteKey;
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwDeleteKey</span>(KeyHandle);
</span></span><span style="display:flex;"><span>		result <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	CmIndex <span style="color:#ec0000">=</span> ECmMax;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(KeyHandle)
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(KeyHandle);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">CheckAndGetCmInnerFunc</span>(ULONG Address,<span style="color:#5f5fff">int</span> CmIndex)							<span style="color:#ec0000">--</span>
</span></span><span style="display:flex;"><span>{//通过回溯查找cm*地址
</span></span><span style="display:flex;"><span>/*
</span></span><span style="display:flex;"><span>对比call   nt!CmSetValueKey之前偏移0x25的机器码:
</span></span><span style="display:flex;"><span>80619a1f 7c1f            jl      nt!NtSetValueKey+0x234 (80619a40)
</span></span><span style="display:flex;"><span>80619a21 53              push    ebx
</span></span><span style="display:flex;"><span>80619a22 ff7518          push    dword ptr [ebp+18h]
</span></span><span style="display:flex;"><span>80619a25 ff7514          push    dword ptr [ebp+14h]
</span></span><span style="display:flex;"><span>80619a28 8d45c4          lea     eax,[ebp-3Ch]
</span></span><span style="display:flex;"><span>80619a2b 50              push    eax
</span></span><span style="display:flex;"><span>80619a2c ff7704          push    dword ptr [edi+4]
</span></span><span style="display:flex;"><span>80619a2f e88e0b0100      call    nt!CmSetValueKey (8062a5c2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CmInnerFuncs
</span></span><span style="display:flex;"><span>b2e4c640  00 00 00 00 00 00 00 00-7c 00 53 ff 75 00 ff 75  ........|.S.u..u
</span></span><span style="display:flex;"><span>b2e4c650  00 8d 45 00 50 ff 77 00-01 00 00 00 02 00 00 00  ..
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>	UCHAR Code[<span style="color:#008900">32</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Address <span style="color:#ec0000">||</span> Address <span style="color:#ec0000">-</span> <span style="color:#008900">0x2F</span> <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">0x7FFFFFFF</span> <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span><span style="color:#5f5fff">IsAddressRegionValid</span>(Address<span style="color:#ec0000">-</span><span style="color:#008900">0x2F</span>,<span style="color:#008900">0x2F</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(CmMatchData[VersionIndex][CmIndex].CodeMask)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlCopyMemory</span>(Code,Address<span style="color:#ec0000">-</span><span style="color:#008900">0x25</span>,<span style="color:#ec0000">sizeof</span>(Code));
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">31</span>;i<span style="color:#ec0000">&gt;=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">--</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			ULONG bit <span style="color:#ec0000">=</span> CmMatchData[VersionIndex][CmIndex].CodeMask <span style="color:#ec0000">&gt;&gt;</span> (<span style="color:#008900">31</span><span style="color:#ec0000">-</span>i);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(bit <span style="color:#ec0000">&amp;</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(CmMatchData[VersionIndex][CmIndex].ByteCode[i] <span style="color:#ec0000">!=</span> Code[i])
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(bit <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				CmMatchData[VersionIndex][CmIndex].FuncAddr <span style="color:#ec0000">=</span> Address<span style="color:#ec0000">+*</span>(ULONG_PTR<span style="color:#ec0000">*</span>)(Address<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>				CellRoutineBit <span style="color:#ec0000">|=</span> CmMatchData[VersionIndex][CmIndex].CmFlag;
</span></span><span style="display:flex;"><span>				CmMatchData[VersionIndex][CmIndex].InitFlag <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">GetCmFuncsByIndex</span>(ULONG Esp,<span style="color:#5f5fff">int</span> CmIndex)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Esp)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">100</span>;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span><span style="color:#5f5fff">IsAddressRegionValid</span>(Esp,<span style="color:#008900">4</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(Esp <span style="color:#ec0000">&gt;=</span> NtosBegin <span style="color:#ec0000">&amp;&amp;</span> Esp <span style="color:#ec0000">&lt;=</span> NtosEnd <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#5f5fff">CheckAndGetCmInnerFunc</span>(Esp,CmIndex))
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>		Esp <span style="color:#ec0000">+=</span> <span style="color:#008900">4</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">--</span>x64 <span style="color:#ec0000">下的情况</span> 
</span></span><span style="display:flex;"><span>CM_MATCH_DATA Ano[]<span style="color:#ec0000">=</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	{<span style="color:#008900">7</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x90</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x60</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC7</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x54</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{<span style="color:#008900">9</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>	<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>,
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">CheckAndGetCmInnerFunc</span>(ULONG Address,<span style="color:#5f5fff">int</span> CmIndex)							
</span></span><span style="display:flex;"><span>{//通过回溯查找cm*地址
</span></span><span style="display:flex;"><span>	UCHAR Code[<span style="color:#008900">32</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Address <span style="color:#ec0000">||</span> Address <span style="color:#ec0000">-</span> <span style="color:#008900">0x2F</span> <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">0x7FFFFFFF</span> <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span><span style="color:#5f5fff">IsAddressRegionValid</span>(Address<span style="color:#ec0000">-</span><span style="color:#008900">0x2F</span>,<span style="color:#008900">0x2F</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(CmMatchData[VersionIndex][CmIndex].CodeMask)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">RtlCopyMemory</span>(Code,Address<span style="color:#ec0000">-</span><span style="color:#008900">0x25</span>,<span style="color:#ec0000">sizeof</span>(Code));
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">31</span>;i<span style="color:#ec0000">&gt;=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">--</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			ULONG bit <span style="color:#ec0000">=</span> CmMatchData[VersionIndex][CmIndex].CodeMask <span style="color:#ec0000">&gt;&gt;</span> (<span style="color:#008900">31</span><span style="color:#ec0000">-</span>i);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(bit <span style="color:#ec0000">&amp;</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(CmMatchData[VersionIndex][CmIndex].ByteCode[i] <span style="color:#ec0000">!=</span> Code[i])
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">goto</span> CompareAnother;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(bit <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				CmMatchData[VersionIndex][CmIndex].FuncAddr <span style="color:#ec0000">=</span> Address<span style="color:#ec0000">+*</span>(ULONG_PTR<span style="color:#ec0000">*</span>)(Address<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>				CellRoutineBit <span style="color:#ec0000">|=</span> CmMatchData[VersionIndex][CmIndex].CmFlag;
</span></span><span style="display:flex;"><span>				CmMatchData[VersionIndex][CmIndex].InitFlag <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">CompareAnother</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> j<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;Ano[j].Version[<span style="color:#008900">0</span>] <span style="color:#ec0000">!=</span> <span style="color:#008900">9</span>;j<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(Ano[j].Version[<span style="color:#008900">0</span>] <span style="color:#ec0000">==</span> VersionIndex <span style="color:#ec0000">&amp;&amp;</span> Ano[j].Version[<span style="color:#008900">1</span>] <span style="color:#ec0000">==</span> CmIndex)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">31</span>;i<span style="color:#ec0000">&gt;=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">--</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				ULONG bit <span style="color:#ec0000">=</span> Ano[j].CodeMask <span style="color:#ec0000">&gt;&gt;</span> (<span style="color:#008900">31</span><span style="color:#ec0000">-</span>i);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(bit <span style="color:#ec0000">&amp;</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(Ano[j].ByteCode[i] <span style="color:#ec0000">!=</span> Code[i])
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">goto</span> CompareAnother;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(bit <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					CmMatchData[VersionIndex][CmIndex].FuncAddr <span style="color:#ec0000">=</span> Address<span style="color:#ec0000">+*</span>(ULONG_PTR<span style="color:#ec0000">*</span>)(Address<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>					CellRoutineBit <span style="color:#ec0000">|=</span> CmMatchData[VersionIndex][CmIndex].CmFlag;
</span></span><span style="display:flex;"><span>					CmMatchData[VersionIndex][CmIndex].InitFlag <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">NewGetCellRoutine</span>(HHIVE Hive,HCELL Cell)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	ULONG_PTR _Esp <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	_asm
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		mov _Esp,esp;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InterlockedExchangeAdd</span>(<span style="color:#ec0000">&amp;</span>EnterCellRoutineRefCount,<span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">PsGetCurrentThreadId</span>() <span style="color:#ec0000">==</span> GetCmRegFuncsThreadId <span style="color:#ec0000">&amp;&amp;</span> CmIndex <span style="color:#ec0000">&lt;</span> <span style="color:#008900">6</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(CmMatchData[VersionIndex][CmIndex].InitFlag <span style="color:#ec0000">&amp;&amp;</span> CmMatchData[VersionIndex][CmIndex].FuncAddr)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>(CmMatchData[VersionIndex][CmIndex].CmFlag <span style="color:#ec0000">&amp;</span> CellRoutineBit))
</span></span><span style="display:flex;"><span>				CellRoutineBit <span style="color:#ec0000">|=</span> CmMatchData[VersionIndex][CmIndex].CmFlag;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">switch</span>(CmIndex)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">ECmQueryValueKey</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">GetCmFuncsByIndex</span>();
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">ECmSetValueKey</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">GetCmFuncsByIndex</span>();
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">ECmDeleteValueKey</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">GetCmFuncsByIndex</span>();
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">ECmDeleteKey</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">GetCmFuncsByIndex</span>();
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">ECmEnumerateKey</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">GetCmFuncsByIndex</span>();
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">ECmEnumerateValueKey</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">GetCmFuncsByIndex</span>();
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">OldGetCellRoutine</span>(Hive,Cell);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">InterlockedExchangeAdd</span>(<span style="color:#ec0000">&amp;</span>EnterCellRoutineRefCount,<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="匹配结构">匹配结构</h4>
<p>用于匹配cm*函数调用周围的机器码<br>
X86的情况：</p>
<pre tabindex="0"><code>#define MaxVersion 10
enum
{
	ECmQueryValueKey=0,
	ECmSetValueKey,
	ECmDeleteValueKey,
	ECmDeleteKey,
	ECmEnumerateKey,
	ECmEnumerateValueKey,
	ECmMax,
	NCmQueryValueKey=1,
	NCmSetValueKey=0x10,
	NCmDeleteValueKey=0x100,
	NCmDeleteKey=0x1000,
	NCmEnumerateKey=0x10000,
	NCmEnumerateValueKey=0x100000,
};

#pragma pack(4)
struct CM_MATCH_DATA
{
	ULONG Version[2];//版本
	ULONG InitFlag;//是否初始化
	ULONG FuncAddr;//获取到的cm函数地址
	ULONG CmFlag;//cm函数类型，1~0x100000 对应于各个cm函数
	ULONG CodeMask;//32bit对应于BYTE ByteCode[32]的掩码，决定是否比较
	UCHAR ByteCode[32];//用于比较cm函数的机器码
};

CM_MATCH_DATA CmMatchData[MaxVersion][ECmMax]=
{
{//NON
	{
		{0, 0},
		0, NULL, NCmQueryValueKey, 0x00000000,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},
	},
	{
		{0, 1},
		0, NULL, NCmSetValueKey, 0x00000000,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},
	},
	{
		{0, 2},
		0, NULL, NCmDeleteValueKey, 0x00000000,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},
	},
	{
		{0, 3},
		0, NULL, NCmDeleteKey, 0x00000000,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},
	},
	{
		{0, 4},
		0, NULL, NCmEnumerateKey, 0x00000000,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},
	},
	{
		{0, 5},
		0, NULL, NCmEnumerateValueKey, 0x00000000,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		},
	},
},
{//WIN2000
	{
		{1, 0},
		0, NULL, NCmQueryValueKey, 0x00176DB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0x57,0xFF,0x75,
			0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x76,0x00,
		},
	},
	{
		{1, 1},
		0, NULL, NCmSetValueKey, 0x0000BB6E,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x7C,0x00,0x53,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8D,0x45,0x00,0x50,0xFF,0x77,0x00,
		},
	},
	{
		{1, 2},
		0, NULL, NCmDeleteValueKey, 0x00003DB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x39,0x75,0xE4,0x7C,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x77,0x00,
		},
	},
	{
		{1, 3},
		0, NULL, NCmDeleteKey, 0x0006DB6D,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x8B,0x46,0x00,
			0xF6,0x40,0x00,0x80,0x75,0x00,0x8B,0x40,0x00,0xF6,0x40,0x00,0x80,0x75,0x00,0x56,
		},
	},
	{
		{1, 4},
		0, NULL, NCmEnumerateKey, 0x001AEDB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x39,0x5D,0x00,0x7C,0x00,
			0x56,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x77,0x00,
		},
	},
	{
		{1, 5},
		0, NULL, NCmEnumerateValueKey, 0x001AEDB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x39,0x5D,0x00,0x7C,0x00,
			0x56,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x77,0x00,
		},
	},
},
{//WINXPSP1
	{
		{2, 0},
		0, NULL, NCmQueryValueKey, 0x003B6DB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x57,0xFF,0x75,0x00,0xFF,0x75,
			0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8B,0x7D,0x00,0xFF,0x77,0x00,
		},
	},
	{
		{2, 1},
		0, NULL, NCmSetValueKey, 0x0000BB6E,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x7C,0x00,0x53,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8D,0x45,0x00,0x50,0xFF,0x76,0x00,
		},
	},
	{
		{2, 2},
		0, NULL, NCmDeleteValueKey, 0x00001DB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x85,0xF6,0x7C,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x77,0x00,
		},
	},
	{
		{2, 3},
		0, NULL, NCmDeleteKey, 0x0000DB6D,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0xF6,0x40,0x00,0x80,0x75,0x00,0x8B,0x40,0x00,0xF6,0x40,0x00,0x80,0x75,0x00,0x56,
		},
	},
	{
		{2, 4},
		0, NULL, NCmEnumerateKey, 0x000EEDB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x85,0xF6,0x7C,0x00,
			0x53,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x77,0x00,
		},
	},
	{
		{2, 5},
		0, NULL, NCmEnumerateValueKey, 0x000EEDB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x85,0xF6,0x7C,0x00,
			0x53,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x77,0x00,
		},
	},
},
{//WINXPSP3
	{
		{3, 0},
		0, NULL, NCmQueryValueKey, 0x00176DB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0x56,0xFF,0x75,
			0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x77,0x00,
		},
	},
	{
		{3, 1},
		0, NULL, NCmSetValueKey, 0x0000BB6E,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x7C,0x00,0x53,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8D,0x45,0x00,0x50,0xFF,0x76,0x00,
		},
	},
	{
		{3, 2},
		0, NULL, NCmDeleteValueKey, 0x00001DB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x85,0xF6,0x7C,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x77,0x00,
		},
	},
	{
		{3, 3},
		0, NULL, NCmDeleteKey, 0x0000DB6D,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0xF6,0x40,0x00,0x80,0x75,0x00,0x8B,0x40,0x00,0xF6,0x40,0x00,0x80,0x75,0x00,0x56,
		},
	},
	{
		{3, 4},
		0, NULL, NCmEnumerateKey, 0x000EEDB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x85,0xF6,0x7C,0x00,
			0x53,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x77,0x00,
		},
	},
	{
		{3, 5},
		0, NULL, NCmEnumerateValueKey, 0x000EEDB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x85,0xF6,0x7C,0x00,
			0x53,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x77,0x00,
		},
	},
},
{//WINVISTA
	{
		{4, 0},
		0, NULL, NCmQueryValueKey, 0x01DB6DB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3B,0xC7,0x7C,0x00,0xFF,0x75,0x00,0xFF,0x75,
			0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
	{
		{4, 1},
		0, NULL, NCmSetValueKey, 0x0003BB6E,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0xFF,
			0x75,0x00,0x56,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8D,0x45,0x00,0x50,0xFF,0x75,0x00,
		},
	},
	{
		{4, 2},
		0, NULL, NCmDeleteValueKey, 0x00037FF6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x8B,0x45,
			0x00,0xC1,0xE8,0x02,0x25,0x01,0xFF,0xFF,0xFF,0x50,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
	{
		{4, 3},
		0, NULL, NCmDeleteKey, 0x000003FD,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0xBB,0x22,0x00,0x00,0xC0,0x3B,0xDE,0x7C,0x00,0x57,
		},
	},
	{
		{4, 4},
		0, NULL, NCmEnumerateKey, 0x0016DBB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0xFF,0x75,0x00,
			0xFF,0x75,0x00,0xFF,0x75,0x00,0x57,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8B,0x4D,0x00,
		},
	},
	{
		{4, 5},
		0, NULL, NCmEnumerateValueKey, 0x0002DB76,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x75,0x00,
			0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0x57,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
},
{//WIN7
	{
		{5, 0},
		0, NULL, NCmQueryValueKey, 0x01DB6DB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3B,0xC7,0x7C,0x00,0xFF,0x75,0x00,0xFF,0x75,
			0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
	{
		{5, 1},
		0, NULL, NCmSetValueKey, 0x007FBB6E,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x24,0x01,0x0F,0xB6,0xC0,0x50,0xFF,
			0x75,0x00,0x56,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8D,0x45,0x00,0x50,0xFF,0x75,0x00,
		},
	},
	{
		{5, 2},
		0, NULL, NCmDeleteValueKey, 0x00007FF6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0xC1,0xE8,0x02,0x24,0x01,0x0F,0xB6,0xC0,0x50,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
	{
		{5, 3},
		0, NULL, NCmDeleteKey, 0x00067E61,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC7,0x44,0x00,
			0x00,0x22,0x00,0x00,0xC0,0x39,0x5C,0x00,0x00,0x0F,0x8C,0x00,0x00,0x00,0x00,0x57,
		},
	},
	{
		{5, 4},
		0, NULL, NCmEnumerateKey, 0x0016DBB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0xFF,0x75,0x00,
			0xFF,0x75,0x00,0xFF,0x75,0x00,0x57,0xFF,0x75,0x00,0x8B,0x4D,0x00,0x8B,0x55,0x00,
		},
	},
	{
		{5, 5},
		0, NULL, NCmEnumerateValueKey, 0x0002DB76,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x75,0x00,
			0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0x57,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
},
{//WIN7SP1
	{
		{6, 0},
		0, NULL, NCmQueryValueKey, 0x01DB6DB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3B,0xC7,0x7C,0x00,0xFF,0x75,0x00,0xFF,0x75,
			0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
	{
		{6, 1},
		0, NULL, NCmSetValueKey, 0x0003BB6E,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0xFF,
			0x75,0x00,0x56,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8D,0x45,0x00,0x50,0xFF,0x75,0x00,
		},
	},
	{
		{6, 2},
		0, NULL, NCmDeleteValueKey, 0x00037FF6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x8B,0x45,
			0x00,0xC1,0xE8,0x02,0x25,0x01,0xFF,0xFF,0xFF,0x50,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
	{
		{6, 3},
		0, NULL, NCmDeleteKey, 0x000003FD,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0xBB,0x22,0x00,0x00,0xC0,0x3B,0xDE,0x7C,0x00,0x57,
		},
	},
	{
		{6, 4},
		0, NULL, NCmEnumerateKey, 0x0016DBB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0xFF,0x75,0x00,
			0xFF,0x75,0x00,0xFF,0x75,0x00,0x57,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8B,0x4D,0x00,
		},
	},
	{
		{6, 5},
		0, NULL, NCmEnumerateValueKey, 0x0002DB76,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x75,0x00,
			0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0x57,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
},
{//WIN8
	{
		{7, 0},
		0, NULL, NCmQueryValueKey, 0x001DA7A6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x85,0xC0,0x78,0x00,0xFF,
			0x75,0x00,0xFF,0x75,0x00,0x56,0x57,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
	{
		{7, 1},
		0, NULL, NCmSetValueKey, 0x00FFFB6E,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC1,0xE8,0x02,0x24,0x01,0x0F,0xB6,0xC0,
			0x50,0x56,0x57,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8D,0x45,0x00,0x50,0xFF,0x75,0x00,
		},
	},
	{
		{7, 2},
		0, NULL, NCmDeleteValueKey, 0x001FFDB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC1,0xE8,0x02,0x24,0x01,
			0x0F,0xB6,0xC0,0x50,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
	{
		{7, 3},
		0, NULL, NCmDeleteKey, 0x000003FD,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0xBB,0x22,0x00,0x00,0xC0,0x85,0xDB,0x78,0x00,0x56,
		},
	},
	{
		{7, 4},
		0, NULL, NCmEnumerateKey, 0x07DB6DB6,
		{
			0x00,0x00,0x00,0x00,0x00,0x8B,0xF0,0x85,0xF6,0x78,0x00,0xFF,0x75,0x00,0xFF,0x75,
			0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8B,0x45,0x00,
		},
	},
	{
		{7, 5},
		0, NULL, NCmEnumerateValueKey, 0x0036DB76,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x83,0x7D,0x00,0x00,0x75,0x00,
			0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0x57,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
},
{//WIN8.1
	{
		{8, 0},
		0, NULL, NCmQueryValueKey, 0x00786DBE,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x85,0xC0,0x0F,0x85,0x00,0x00,0x00,
			0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0x56,0x57,0x53,0xFF,0x75,0x00,
		},
	},
	{
		{8, 1},
		0, NULL, NCmSetValueKey, 0x0E1F76DD,
		{
			0x00,0x00,0x00,0x00,0x04,0x0F,0x85,0x00,0x00,0x00,0x00,0x33,0xC0,0x50,0xFF,0x75,
			0x00,0x56,0xFF,0x75,0x00,0xFF,0x75,0x00,0x8D,0x45,0x00,0x50,0x8B,0x5D,0x00,0x53,
		},
	},
	{
		{8, 2},
		0, NULL, NCmDeleteValueKey, 0x1B87FB76,
		{
			0x00,0x00,0x00,0x88,0x5D,0x00,0x0F,0xB6,0x85,0x00,0x00,0x00,0x00,0xC1,0xE8,0x02,
			0x83,0xE0,0x01,0xFF,0x75,0x00,0xFF,0x75,0x00,0x50,0xFF,0x75,0x00,0xFF,0x75,0x00,
		},
	},
	{
		{8, 3},
		0, NULL, NCmDeleteKey, 0x0F0F879C,
		{
			0x00,0x00,0x00,0x00,0x40,0x66,0x89,0x81,0x00,0x00,0x00,0x00,0x66,0x85,0xC0,0x0F,
			0x84,0x00,0x00,0x00,0x00,0x33,0xDB,0x8B,0x74,0x00,0x00,0x56,0x88,0x5C,0x00,0x00,
		},
	},
	{
		{8, 4},
		0, NULL, NCmEnumerateKey, 0x37876DBB,
		{
			0x00,0x00,0x8B,0x75,0x00,0x85,0xDB,0x0F,0x88,0x00,0x00,0x00,0x00,0x57,0xFF,0x75,
			0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0xFF,0x75,0x00,0x56,0x8B,0x7D,0x00,0x8B,0xC7,
		},
	},
	{
		{8, 5},
		0, NULL, NCmEnumerateValueKey, 0x3F0EEDDD,
		{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x85,0xF6,0x0F,0x85,0x00,0x00,0x00,0x00,
			0x57,0xFF,0x75,0x00,0x53,0xFF,0x75,0x00,0x8B,0x5D,0x00,0x53,0x8B,0x7D,0x00,0x57,
		},
	},
},
{//WIN10
	{
		{9, 0},
		0, NULL, NCmQueryValueKey, 0xFFFFFFFF,
		{
			0x00,0x00,0x85,0xF6,0x0F,0x85,0x0A,0xD7,0x10,0x00,0x8B,0x7D,0xB8,0xFF,0x75,0xCC,
			0xFF,0x75,0xC8,0xFF,0x75,0xB4,0x53,0x57,0x8B,0x5D,0x10,0x8B,0xD3,0x8B,0x4D,0xBC,
		},
	},
	{
		{9, 1},
		0, NULL, NCmSetValueKey, 0xFFFFFFFF,
		{
			0x5D,0xCB,0x0F,0xB6,0x85,0x74,0xFF,0xFF,0xFF,0xC1,0xE8,0x02,0x83,0xE0,0x01,0x50,
			0xFF,0x75,0x88,0x57,0xFF,0x75,0xAC,0xFF,0x75,0x14,0x8D,0x55,0xB8,0x8B,0x4D,0xB4,
		},
	},
	{
		{9, 2},
		0, NULL, NCmDeleteValueKey, 0xFFFFFFFF,
		{
			0xC4,0x0D,0x00,0x88,0x5D,0xCB,0x0F,0xB6,0x85,0x7C,0xFF,0xFF,0xFF,0xC1,0xE8,0x02,
			0x83,0xE0,0x01,0xFF,0x75,0xBC,0xFF,0x75,0xB8,0x50,0x8B,0x55,0xA8,0x8B,0x4D,0xB4,
		},
	},
	{
		{9, 3},
		0, NULL, NCmDeleteKey, 0xFFFFFFFF,
		{
			0x01,0x00,0x00,0x40,0x66,0x89,0x81,0x3C,0x01,0x00,0x00,0x66,0x85,0xC0,0x0F,0x84,
			0x9E,0x00,0x00,0x00,0x33,0xDB,0x8B,0x74,0x24,0x10,0x8B,0xCE,0x88,0x5C,0x24,0x2C,
		},
	},
	{
		{9, 4},
		0, NULL, NCmEnumerateKey, 0xFFFFFFFF,
		{
			0xE8,0x5A,0xB1,0xFF,0xFF,0x8B,0xF0,0x85,0xF6,0x78,0x1C,0xFF,0x75,0xB8,0xFF,0x75,
			0x18,0xFF,0x75,0xBC,0xFF,0x75,0x10,0xFF,0x75,0x0C,0x8B,0x55,0xC4,0x8B,0x4D,0xC8,
		},
	},
	{
		{9, 5},
		0, NULL, NCmEnumerateValueKey, 0xFFFFFFFF,
		{
			0x8B,0xF0,0x85,0xF6,0x78,0x21,0x8B,0x4D,0xCC,0x83,0x7D,0xC8,0x00,0x0F,0x85,0x84,
			0xCA,0x0D,0x00,0xFF,0x75,0xC0,0xFF,0x75,0x18,0xFF,0x75,0xC4,0x57,0x8B,0x55,0x0C,
		},
	},
},
};
</code></pre><p>获取CmMatchData的python脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>addr<span style="color:#ec0000">=</span><span style="color:#008900">0x22498</span>
</span></span><span style="display:flex;"><span>index1<span style="color:#ec0000">=</span><span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>index2<span style="color:#ec0000">=</span><span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">while</span> index1 <span style="color:#ec0000">&lt;</span> <span style="color:#008900">10</span>:
</span></span><span style="display:flex;"><span>	index2<span style="color:#ec0000">=</span><span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> index1 <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>:
</span></span><span style="display:flex;"><span>		version<span style="color:#ec0000">=</span><span style="color:#008900">&#34;NON&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">elif</span> index1 <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>:
</span></span><span style="display:flex;"><span>		version<span style="color:#ec0000">=</span><span style="color:#008900">&#34;WIN2000&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">elif</span> index1 <span style="color:#ec0000">==</span> <span style="color:#008900">2</span>:
</span></span><span style="display:flex;"><span>		version<span style="color:#ec0000">=</span><span style="color:#008900">&#34;WINXPSP1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">elif</span> index1 <span style="color:#ec0000">==</span> <span style="color:#008900">3</span>:
</span></span><span style="display:flex;"><span>		version<span style="color:#ec0000">=</span><span style="color:#008900">&#34;WINXPSP3&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">elif</span> index1 <span style="color:#ec0000">==</span> <span style="color:#008900">4</span>:
</span></span><span style="display:flex;"><span>		version<span style="color:#ec0000">=</span><span style="color:#008900">&#34;WINVISTA&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">elif</span> index1 <span style="color:#ec0000">==</span> <span style="color:#008900">5</span>:
</span></span><span style="display:flex;"><span>		version<span style="color:#ec0000">=</span><span style="color:#008900">&#34;WIN7&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">elif</span> index1 <span style="color:#ec0000">==</span> <span style="color:#008900">6</span>:
</span></span><span style="display:flex;"><span>		version<span style="color:#ec0000">=</span><span style="color:#008900">&#34;WIN7SP1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">elif</span> index1 <span style="color:#ec0000">==</span> <span style="color:#008900">7</span>:
</span></span><span style="display:flex;"><span>		version<span style="color:#ec0000">=</span><span style="color:#008900">&#34;WIN8&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">elif</span> index1 <span style="color:#ec0000">==</span> <span style="color:#008900">8</span>:
</span></span><span style="display:flex;"><span>		version<span style="color:#ec0000">=</span><span style="color:#008900">&#34;WIN8.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">elif</span> index1 <span style="color:#ec0000">==</span> <span style="color:#008900">9</span>:
</span></span><span style="display:flex;"><span>		version<span style="color:#ec0000">=</span><span style="color:#008900">&#34;WIN10&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">print</span> <span style="color:#008900">&#34;{//</span><span style="color:#008900">%s</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span> <span style="color:#ec0000">%</span>(version)
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">while</span> index2 <span style="color:#ec0000">&lt;</span> <span style="color:#008900">6</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">print</span> <span style="color:#008900">&#34;</span><span style="color:#008900">\t</span><span style="color:#008900">{&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> index2 <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>:
</span></span><span style="display:flex;"><span>			cm<span style="color:#ec0000">=</span><span style="color:#008900">&#34;NCmQueryValueKey&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">elif</span> index2 <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>:
</span></span><span style="display:flex;"><span>			cm<span style="color:#ec0000">=</span><span style="color:#008900">&#34;NCmSetValueKey&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">elif</span> index2 <span style="color:#ec0000">==</span> <span style="color:#008900">2</span>:
</span></span><span style="display:flex;"><span>			cm<span style="color:#ec0000">=</span><span style="color:#008900">&#34;NCmDeleteValueKey&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">elif</span> index2 <span style="color:#ec0000">==</span> <span style="color:#008900">3</span>:
</span></span><span style="display:flex;"><span>			cm<span style="color:#ec0000">=</span><span style="color:#008900">&#34;NCmDeleteKey&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">elif</span> index2 <span style="color:#ec0000">==</span> <span style="color:#008900">4</span>:
</span></span><span style="display:flex;"><span>			cm<span style="color:#ec0000">=</span><span style="color:#008900">&#34;NCmEnumerateKey&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">elif</span> index2 <span style="color:#ec0000">==</span> <span style="color:#008900">5</span>:
</span></span><span style="display:flex;"><span>			cm<span style="color:#ec0000">=</span><span style="color:#008900">&#34;NCmEnumerateValueKey&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">print</span> <span style="color:#008900">&#34;</span><span style="color:#008900">\n\t\t</span><span style="color:#008900">{</span><span style="color:#008900">%d</span><span style="color:#008900">, </span><span style="color:#008900">%d</span><span style="color:#008900">},</span><span style="color:#008900">\n\t\t</span><span style="color:#008900">0, NULL, </span><span style="color:#008900">%s</span><span style="color:#008900">, 0x</span><span style="color:#008900">%08X</span><span style="color:#008900">,</span><span style="color:#008900">\n\t\t</span><span style="color:#008900">{</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span> <span style="color:#ec0000">%</span>(Dword(addr),Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">4</span>),cm,Dword(addr<span style="color:#ec0000">+</span><span style="color:#008900">20</span>))
</span></span><span style="display:flex;"><span>		ptr<span style="color:#ec0000">=</span>addr<span style="color:#ec0000">+</span><span style="color:#008900">24</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">print</span> <span style="color:#008900">&#34;</span><span style="color:#008900">\t\t\t</span><span style="color:#008900">0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span> <span style="color:#ec0000">%</span>(Byte(ptr),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">1</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">2</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">3</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">4</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">5</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">6</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">7</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">8</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">9</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">10</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">11</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">12</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">13</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">14</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">15</span>))
</span></span><span style="display:flex;"><span>		ptr<span style="color:#ec0000">=</span>ptr<span style="color:#ec0000">+</span><span style="color:#008900">16</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">print</span> <span style="color:#008900">&#34;</span><span style="color:#008900">\t\t\t</span><span style="color:#008900">0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,0x</span><span style="color:#008900">%02X</span><span style="color:#008900">,</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span> <span style="color:#ec0000">%</span>(Byte(ptr),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">1</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">2</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">3</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">4</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">5</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">6</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">7</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">8</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">9</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">10</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">11</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">12</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">13</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">14</span>),Byte(ptr<span style="color:#ec0000">+</span><span style="color:#008900">15</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">print</span> <span style="color:#008900">&#34;</span><span style="color:#008900">\t\t</span><span style="color:#008900">},</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">print</span> <span style="color:#008900">&#34;</span><span style="color:#008900">\t</span><span style="color:#008900">},&#34;</span>
</span></span><span style="display:flex;"><span>		addr<span style="color:#ec0000">=</span>addr<span style="color:#ec0000">+</span><span style="color:#008900">56</span>
</span></span><span style="display:flex;"><span>		index2 <span style="color:#ec0000">=</span> index2<span style="color:#ec0000">+</span><span style="color:#008900">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">print</span> <span style="color:#008900">&#34;},&#34;</span>
</span></span><span style="display:flex;"><span>	index1<span style="color:#ec0000">=</span>index1<span style="color:#ec0000">+</span><span style="color:#008900">1</span>
</span></span></code></pre></div><p>X64的情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>#pragma pack(8)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> CM_MATCH_DATA
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG Version[<span style="color:#008900">2</span>];//版本
</span></span><span style="display:flex;"><span>	ULONG InitFlag;//是否初始化
</span></span><span style="display:flex;"><span>	ULONG _gap;//8字节对齐
</span></span><span style="display:flex;"><span>	ULONGLONG FuncAddr;//获取到的cm函数地址
</span></span><span style="display:flex;"><span>	ULONG CmFlag;//cm函数类型，1~0x100000 对应于各个cm函数
</span></span><span style="display:flex;"><span>	ULONG CodeMask;//32bit对应于BYTE ByteCode[32]的掩码，决定是否比较
</span></span><span style="display:flex;"><span>	UCHAR ByteCode[<span style="color:#008900">32</span>];//用于比较cm函数的机器码
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CM_MATCH_DATA CmMatchData[MaxVersion][ECmMax]<span style="color:#ec0000">=</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>{//NON
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmQueryValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0</span>, <span style="color:#008900">2</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0</span>, <span style="color:#008900">3</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0</span>, <span style="color:#008900">4</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">0</span>, <span style="color:#008900">5</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>{//WIN2000
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">1</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmQueryValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">1</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">1</span>, <span style="color:#008900">2</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">1</span>, <span style="color:#008900">3</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">1</span>, <span style="color:#008900">4</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">1</span>, <span style="color:#008900">5</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>{//WINXPSP1
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">2</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmQueryValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">2</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">2</span>, <span style="color:#008900">2</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">2</span>, <span style="color:#008900">3</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">2</span>, <span style="color:#008900">4</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">2</span>, <span style="color:#008900">5</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>{//WINXPSP3
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">3</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmQueryValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC3</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x30</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x49</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">3</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCD</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x58</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x54</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">3</span>, <span style="color:#008900">2</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x7F</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xC0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x84</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x24</span>,<span style="color:#008900">0x10</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xC0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">3</span>, <span style="color:#008900">3</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x49</span>,<span style="color:#008900">0x3B</span>,<span style="color:#008900">0xCD</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x0A</span>,<span style="color:#008900">0xF6</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x80</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0xE2</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x0B</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x41</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x3A</span>,<span style="color:#008900">0xF5</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0x93</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x0B</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x3B</span>,<span style="color:#008900">0xFD</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCB</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">3</span>, <span style="color:#008900">4</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x58</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x49</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xD4</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">3</span>, <span style="color:#008900">5</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x8C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x38</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0xC6</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x49</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>{//WINVISTA
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">4</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmQueryValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x6C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC7</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x60</span>,<span style="color:#008900">0x49</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">4</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x6C</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC6</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x54</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCF</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">4</span>, <span style="color:#008900">2</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x7F</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xB0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x84</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x24</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xB0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCF</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">4</span>, <span style="color:#008900">3</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteKey, <span style="color:#008900">0xFFE7F3FF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x49</span>,<span style="color:#008900">0x3B</span>,<span style="color:#008900">0xCD</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x0A</span>,<span style="color:#008900">0xF6</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x80</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0x58</span>,<span style="color:#008900">0x38</span>,<span style="color:#008900">0x0E</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x41</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x3A</span>,<span style="color:#008900">0xF5</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0x06</span>,<span style="color:#008900">0x38</span>,<span style="color:#008900">0x0E</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x3B</span>,<span style="color:#008900">0xDD</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x1D</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCF</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">4</span>, <span style="color:#008900">4</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x30</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCD</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC7</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xD7</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">4</span>, <span style="color:#008900">5</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC7</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xAC</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x24</span>,<span style="color:#008900">0x68</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xD5</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>{//WIN7
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">5</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmQueryValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x6C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC7</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x60</span>,<span style="color:#008900">0x49</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">5</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x30</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x6C</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC6</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x54</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCF</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">5</span>, <span style="color:#008900">2</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x7F</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xB0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x84</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x24</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xB0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCF</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">5</span>, <span style="color:#008900">3</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteKey, <span style="color:#008900">0xFFE7F3FF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x49</span>,<span style="color:#008900">0x3B</span>,<span style="color:#008900">0xCD</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x0A</span>,<span style="color:#008900">0xF6</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x04</span>,<span style="color:#008900">0x80</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0x7A</span>,<span style="color:#008900">0x55</span>,<span style="color:#008900">0x0D</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x41</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x3A</span>,<span style="color:#008900">0xF5</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x55</span>,<span style="color:#008900">0x0D</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x3B</span>,<span style="color:#008900">0xDD</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x1D</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCF</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">5</span>, <span style="color:#008900">4</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC7</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xD7</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">5</span>, <span style="color:#008900">5</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC7</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xAC</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x24</span>,<span style="color:#008900">0x68</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xD5</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>{//WIN7SP1
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">6</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmQueryValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x30</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x64</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x49</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">6</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCD</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x58</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x54</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">6</span>, <span style="color:#008900">2</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x10</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xC0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">6</span>, <span style="color:#008900">3</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x41</span>,<span style="color:#008900">0x3A</span>,<span style="color:#008900">0xF5</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0x4B</span>,<span style="color:#008900">0x37</span>,<span style="color:#008900">0x0D</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x3B</span>,<span style="color:#008900">0xFD</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0xCB</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">6</span>, <span style="color:#008900">4</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">6</span>, <span style="color:#008900">5</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>{//WIN8
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">7</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmQueryValueKey, <span style="color:#008900">0xDFF7FFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC7</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x70</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x49</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">7</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x5C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x60</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC5</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x54</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCF</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">7</span>, <span style="color:#008900">2</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteValueKey, <span style="color:#008900">0xFFFF7FFE</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0xE1</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x7F</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xE0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC6</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xE0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">7</span>, <span style="color:#008900">3</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteKey, <span style="color:#008900">0x009887FF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0xE4</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0xFF</span>,<span style="color:#008900">0xC0</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x81</span>,<span style="color:#008900">0xE4</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0xC0</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0xB8</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x7D</span>,<span style="color:#008900">0xA7</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8A</span>,<span style="color:#008900">0xFD</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCF</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">7</span>, <span style="color:#008900">4</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x30</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC6</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xD7</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">7</span>, <span style="color:#008900">5</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x64</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC7</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xD6</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x58</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>{//WIN8.1
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">8</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmQueryValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x6C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x7C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCC</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x60</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x49</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">8</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0xB8</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x68</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC7</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x54</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x60</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">8</span>, <span style="color:#008900">2</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0xE1</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x40</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x7F</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xE0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC6</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8D</span>,<span style="color:#008900">0x94</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xE0</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x50</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">8</span>, <span style="color:#008900">3</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0xE4</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0xFF</span>,<span style="color:#008900">0xC0</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x81</span>,<span style="color:#008900">0xE4</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x66</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0xC0</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0xBC</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x7D</span>,<span style="color:#008900">0xB7</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8A</span>,<span style="color:#008900">0xFD</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCF</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">8</span>, <span style="color:#008900">4</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x84</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0xA0</span>,<span style="color:#008900">0x01</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x74</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCF</span>,<span style="color:#008900">0x45</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC5</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x54</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x58</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x48</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">8</span>, <span style="color:#008900">5</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateValueKey, <span style="color:#008900">0xFFFFFFFF</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x58</span>,<span style="color:#008900">0x48</span>,<span style="color:#008900">0x39</span>,<span style="color:#008900">0x5C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x60</span>,<span style="color:#008900">0x0F</span>,<span style="color:#008900">0x85</span>,<span style="color:#008900">0x7E</span>,<span style="color:#008900">0xC0</span>,<span style="color:#008900">0x19</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x4C</span>,<span style="color:#008900">0x89</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x6C</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x28</span>,<span style="color:#008900">0x89</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x24</span>,<span style="color:#008900">0x20</span>,<span style="color:#008900">0x4D</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xCE</span>,<span style="color:#008900">0x44</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xC6</span>,<span style="color:#008900">0x41</span>,<span style="color:#008900">0x8B</span>,<span style="color:#008900">0xD7</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>{//WIN10
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">9</span>, <span style="color:#008900">0</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmQueryValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">9</span>, <span style="color:#008900">1</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmSetValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">9</span>, <span style="color:#008900">2</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">9</span>, <span style="color:#008900">3</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmDeleteKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">9</span>, <span style="color:#008900">4</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		{<span style="color:#008900">9</span>, <span style="color:#008900">5</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, NCmEnumerateValueKey, <span style="color:#008900">0x00000000</span>,
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,<span style="color:#008900">0x00</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>},
</span></span></code></pre></div><p>获取DeviceObject对象类型</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>POBJECT_TYPE <span style="color:#5f5fff">GetDeviceObjectType</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	UNICODE_STRING UAcpi;
</span></span><span style="display:flex;"><span>	UNICODE_STRING UFilePath;
</span></span><span style="display:flex;"><span>	NTSTATUS status;
</span></span><span style="display:flex;"><span>	PDRIVER_OBJECT pDrvObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	PDEVICE_OBJECT pDevObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	HANDLE FileHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	POBJECT_TYPE ObjectType <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">RtlInitUnicodeString</span>(<span style="color:#ec0000">&amp;</span>UAcpi,<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Driver</span><span style="color:#008900">\\</span><span style="color:#008900">ACPI&#34;</span>);
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByName</span>(<span style="color:#ec0000">&amp;</span>UAcpi,OBJ_CASE_INSENSITIVE<span style="color:#ec0000">|</span>OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,<span style="color:#ec0000">*</span>IoDriverObjectType,KernelMode,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">&amp;</span>pDrvObj);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status) <span style="color:#ec0000">&amp;&amp;</span> pDrvObj <span style="color:#ec0000">&amp;&amp;</span> pDrvObj<span style="color:#ec0000">-&gt;</span>DeviceObject)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pDevObj <span style="color:#ec0000">=</span> pDrvObj<span style="color:#ec0000">-&gt;</span>DeviceObject;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(pDevObj)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ObjectType <span style="color:#ec0000">=</span> (POBJECT_TYPE)((PUCHAR)pDevObj<span style="color:#ec0000">-</span><span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(pDrvObj)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ObDereferenceObject</span>(pDrvObj);
</span></span><span style="display:flex;"><span>		pDrvObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(FileHandle)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">ZwClose</span>(FileHandle);
</span></span><span style="display:flex;"><span>		FileHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> ObjectType;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="qqpchwsys分析">QQPCHW.sys分析</h2>
<h3 id="控制码-2">控制码</h3>
<pre tabindex="0"><code>0x222024
	初始化线程id表
	buffer= 用Rabbit算法加密过得线程id表   sizeof=传入缓冲区大小
	
0x222004
	读取PCI数据                结构体成员含义参见HalGetBusDataByOffset参数
	buffer=                sizeof=0x18
	+00        ULONG BusNumber                &lt;==&gt;   ULONG ret
	+04        BYTE data1
	+08        BYTE data2   data2低3位和data1低5位组成SlotNumber
	+0C        PVOID Offset
	+10        ULONG Length
	+14        PVOID Buffer       

0x222008
	设置PCI数据   结构体成员含义参见HalSetBusDataByOffset参数
	buffer=                sizeof=0x18
	+00        ULONG BusNumber                &lt;==&gt;   ULONG ret
	+04        BYTE data1
	+08        BYTE data2   data2低3位和data1低5位组成SlotNumber
	+0C        PVOID Offset
	+10        ULONG Length
	+14        PVOID Buffer
	
0x22200C
	读取msr寄存器
	buffer=                sizeof=9
	+00        DWORD msrindex  存储读取序号 &lt;==&gt;  LONGLONG 读取到的数据
	
0x222010
	写入msr寄存器
	buffer=                sizeof=0xC
	+0        DWORD msrindex
	+4        LONGLONG value  要写入的值

0x222014
	读取端口
	buffer=         sizeof=9                        READ_PORT_UCHAR/USHORT/ULONG
	+0        BYTE readsize 0:UCHAR/1:USHORT/2:ULONG                &lt;==&gt;        DWORD ret
	+5        PVOID Port
	
	写入端口
	buffer=                sizeof=8                        WRITE_PORT_UCHAR
	+0        PVOID Port        端口号
	+4        UCHAR Value 数据                &lt;==&gt;         DWORD TAG=0x87654321  写入成功标志
	
0x222018
	读取端口
	buffer=                sizeof=8                        READ_PORT_UCHAR
	+0 PUCHAR* Port 端口号                &lt;==&gt;    UCHAR取出的数据
	+4 =&gt;DWORD TAG=0x87654321  写入成功标志
	
0x22201C
	写入端口
	buffer=                sizeof=8                        WRITE_PORT_UCHAR
	+0        PVOID Port        端口号
	+4        UCHAR Value 数据                &lt;==&gt;         DWORD TAG=0x87654321  写入成功标志

0x222020
	写入端口
	buffer=         sizeof=9                        READ_PORT_UCHAR/USHORT/ULONG
	+0        BYTE writesize 0:UCHAR/1:USHORT/2:ULONG                &lt;==&gt;        DWORD ret
	+5        PVOID Port
	
0x222028
	改写PCI conf1设备空间的一个数据？？实在找不到资料了！不知道在干啥
		WRITE_PORT_ULONG((PULONG)0xCF8, 0x8000F8F0);
v13 = READ_PORT_ULONG((PULONG)0xCFC);
Buffer = v13;
if ( v13 == -1
	|| (Buffer = (v13 &amp; 0xFFFFC000) + 0x3418,
		PhysicalAddress.LowPart = Buffer,
		(v14 = (ULONG *)MmMapIoSpace((PHYSICAL_ADDRESS)Buffer, 4u, 0)) == 0)
	|| (READ_REGISTER_BUFFER_ULONG(v14, &amp;Buffer, 1u),
		Buffer &amp;= 0xFFFFFFF7,
		MmUnmapIoSpace(v14, 4u),
		(v15 = (ULONG *)MmMapIoSpace((PHYSICAL_ADDRESS)*(unsigned int *)&amp;PhysicalAddress, 4u, 0)) == 0) )
{
	v2 = 0xC0000001;
	goto LABEL_4;
}
WRITE_REGISTER_BUFFER_ULONG(v15, &amp;Buffer, 1u);
MmUnmapIoSpace(v15, 4u);

0x222040
	创建物理地址内存映射 \\Device\\PhysicalMemory
	buffer=
	+00 HANDLE hSection
	+04
	+08        PVOID BaseAddress  内存映射地址

0x222044
	取消物理地址内存映射
	buffer=
	+00 HANDLE hSection
	+04        PHYSICAL_ADDRESS BusAddress 物理地址
	+0C        PVOID BaseAddress 对齐内存映射地址
</code></pre><h2 id="tssksys分析">Tssk.sys分析</h2>
<p>  该驱动主要用于防止各类已知rootkit驱动的攻击，有很多恢复系统函数的操作，具体过程不详细介绍，看idb即可。</p>
<h3 id="基础库-2">基础库</h3>
<p>由符号链接名获取设备名</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">GetDeviceNameBySymbolicName</span>(PUNICODE_STRING SymbolicName,PUNICODE_STRING DeviceName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    OBJECT_ATTRIBUTES ObjectAttributes;
</span></span><span style="display:flex;"><span>    UNICODE_STRING LinkTarget <span style="color:#ec0000">=</span> {<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>    HANDLE LinkHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>    NTSTATUS Status;
</span></span><span style="display:flex;"><span>    ULONG ReturnedLength <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    BOOLEAN Ret <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>SymbolicName <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>DeviceName)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>    InitializeObjectAttributes(<span style="color:#ec0000">&amp;</span>ObjectAttributes,SymbolicName,OBJ_CASE_INSENSITIVE <span style="color:#ec0000">|</span> OBJ_KERNEL_HANDLE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>    ZwOpenSymbolicLinkObject(<span style="color:#ec0000">&amp;</span>LinkHandle,GENERIC_READ,<span style="color:#ec0000">&amp;</span>ObjectAttributes);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(LinkHandle)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(ZwQuerySymbolicLinkObject(LinkHandle, <span style="color:#ec0000">&amp;</span>LinkTarget, <span style="color:#ec0000">&amp;</span>ReturnedLength) <span style="color:#ec0000">==</span> STATUS_BUFFER_TOO_SMALL)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(ReturnedLength)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                ReturnedLength <span style="color:#ec0000">+=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>                LinkTarget.Buffer <span style="color:#ec0000">=</span> (PWCH)ExAllocatePool(NonPagedPool,ReturnedLength);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(LinkTarget.Buffer)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    RtlZeroMemory(LinkTarget.Buffer,ReturnedLength);
</span></span><span style="display:flex;"><span>                    LinkTarget.Length <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                    LinkTarget.MaximumLength <span style="color:#ec0000">=</span> ReturnedLength;
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span>(ZwQuerySymbolicLinkObject(LinkHandle, <span style="color:#ec0000">&amp;</span>LinkTarget, <span style="color:#ec0000">&amp;</span>ReturnedLength) <span style="color:#ec0000">==</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>                        Ret <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(LinkHandle)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ZwClose(LinkHandle);
</span></span><span style="display:flex;"><span>            LinkHandle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(Ret)
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">*</span>DeviceName <span style="color:#ec0000">=</span> LinkTarget;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(LinkTarget.Buffer)
</span></span><span style="display:flex;"><span>        ExFreePool(LinkTarget.Buffer);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>遍历所有硬盘分区</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">GetHarddiskPartitioNumber</span>(PDEVICE_OBJECT DeviceObject, PULONG OutPartitionNum)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    KEVENT Event;
</span></span><span style="display:flex;"><span>    IO_STATUS_BLOCK Ios;
</span></span><span style="display:flex;"><span>    NTSTATUS Status;
</span></span><span style="display:flex;"><span>    BOOLEAN Ret <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DeviceObject <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>OutPartitionNum)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>    KeInitializeEvent(<span style="color:#ec0000">&amp;</span>Event);
</span></span><span style="display:flex;"><span>    PVOID Buf <span style="color:#ec0000">=</span> ExAllocatePool(NonPagedPool,<span style="color:#008900">0x2000</span>);
</span></span><span style="display:flex;"><span>    RtlZeroMemory(<span style="color:#ec0000">&amp;</span>Buf,<span style="color:#008900">0x2000</span>);
</span></span><span style="display:flex;"><span>    PIRP Irp <span style="color:#ec0000">=</span> IoBuildDeviceIoControlRequest(<span style="color:#008900">0x70050</span>,DeviceObject,<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,Buf,<span style="color:#008900">0x2000</span>,FALSE,<span style="color:#ec0000">&amp;</span>Event,<span style="color:#ec0000">&amp;</span>Ios);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(Irp)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Status <span style="color:#ec0000">=</span> IoCallDriver(DeviceObject,Irp);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(Status <span style="color:#ec0000">==</span> STATUS_PENDING)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            KeWaitForSingleObject(<span style="color:#ec0000">&amp;</span>Event,Suspended,KernelMode,FALSE,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>            Status <span style="color:#ec0000">=</span> Ios.Status;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(NT_SUCCESS(Status))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">*</span>OutPartitionNum <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((ULONG<span style="color:#ec0000">*</span>)Buf<span style="color:#ec0000">+</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>            Ret <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(Buf)
</span></span><span style="display:flex;"><span>        ExFreePool(Buf);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> Ret;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">EnumPartition</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(KeGetCurrentIrql() <span style="color:#ec0000">!=</span> PASSIVE_LEVEL)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>    PCONFIGURATION_INFORMATION config <span style="color:#ec0000">=</span> IoGetConfigurationInformation();
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> DiskIndex<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;DiskIndex <span style="color:#ec0000">&lt;</span> config<span style="color:#ec0000">-&gt;</span>DiskCount;DiskIndex<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        WCHAR Disk[<span style="color:#008900">260</span>];
</span></span><span style="display:flex;"><span>        UNICODE_STRING UDisk;
</span></span><span style="display:flex;"><span>        PFILE_OBJECT FileObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>        PDEVICE_OBJECT DevObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>        vsnwprintfW(Disk,<span style="color:#008900">260</span>,<span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Device</span><span style="color:#008900">\\</span><span style="color:#008900">Harddisk%d</span><span style="color:#008900">\\</span><span style="color:#008900">Partition0&#34;</span>,DiskIndex);
</span></span><span style="display:flex;"><span>        RtlInitUnicodeString(<span style="color:#ec0000">&amp;</span>UDisk,Disk);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(NT_SUCCESS(IoGetDeviceObjectPointer(<span style="color:#ec0000">&amp;</span>UDisk,FILE_READ_ATTRIBUTES,<span style="color:#ec0000">&amp;</span>FileObj,<span style="color:#ec0000">&amp;</span>DevObj))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(MmIsAddressValid(FileObj<span style="color:#ec0000">-&gt;</span>DeviceObject) <span style="color:#ec0000">&amp;&amp;</span> MmIsAddressValid(FileObj<span style="color:#ec0000">-&gt;</span>DeviceObject<span style="color:#ec0000">-&gt;</span>DriverObject))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                ULONG PartitionNumber;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(GetHarddiskPartitionNumber(DevObj,<span style="color:#ec0000">&amp;</span>PartitionNumber))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> PartitionIndex<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;PartitionIndex <span style="color:#ec0000">&lt;</span> PartitionNumber;PartitionIndex<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        WCHAR Partition[<span style="color:#008900">260</span>];
</span></span><span style="display:flex;"><span>                        UNICODE_STRING UPartition;
</span></span><span style="display:flex;"><span>                        PFILE_OBJECT FileObjx <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>                        PDEVICE_OBJECT DevObjx <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>                        vsnwprintfW(Partition,<span style="color:#008900">260</span>,<span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Device</span><span style="color:#008900">\\</span><span style="color:#008900">Harddisk%d</span><span style="color:#008900">\\</span><span style="color:#008900">Partition%d&#34;</span>,DiskIndex,PartitionIndex);
</span></span><span style="display:flex;"><span>                        RtlInitUnicodeString(<span style="color:#ec0000">&amp;</span>UPartition,Partition);
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">if</span>(NT_SUCCESS(IoGetDeviceObjectPointer(<span style="color:#ec0000">&amp;</span>UPartition,FILE_READ_ATTRIBUTES,<span style="color:#ec0000">&amp;</span>FileObjx,<span style="color:#ec0000">&amp;</span>DevObjx))
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                            <span style="color:#ec0000">if</span>(MmIsAddressValid(FileObjx<span style="color:#ec0000">-&gt;</span>DeviceObject) <span style="color:#ec0000">&amp;&amp;</span> MmIsAddressValid(FileObjx<span style="color:#ec0000">-&gt;</span>DeviceObject<span style="color:#ec0000">-&gt;</span>DriverObject))
</span></span><span style="display:flex;"><span>                            {
</span></span><span style="display:flex;"><span>                                
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>由进程对象获取文件对象</p>
<ul>
<li>Xp之前</li>
<li>
<ul>
<li>由PsGetProcessSectionBaseAddress得到SectionBaseAddress在EPROCESS中的偏移，前4字节为SectionObject偏移</li>
</ul>
</li>
<li>
<ul>
<li>由PEPROCESS得到_SECTION.ControlArea.FilePointer</li>
</ul>
</li>
<li>Xp之后
PsReferenceProcessFilePointer得到</li>
</ul>

    
  </div>

  


  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/win_posts/20150101_windbg_note/">
                        Windbg调试笔记
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
            <div class="single-pagination-container-next">
                <div class="single-pagination-text">
                    <a href="/win_posts/20150103_trojan_analysis/">
                        记一次木马分析
                    </a>
                </div>
                <div class="single-pagination-text">→</div>
            </div>
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


      </main>
    </div>

    <footer>
      

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    



    </footer>
    
  </body>

  <script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

</html>