<!DOCTYPE html>
<html lang="zh-CN"
  dir="ltr">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://lich4.github.io//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://lich4.github.io//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://lich4.github.io//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://lich4.github.io//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://lich4.github.io//apple-touch-icon.png">

<meta name="description" content=""/>

<title>
    
    OllyDbg插件开发及逆向分析 | 超哥的博客
    
</title>

<link rel="canonical" href="https://lich4.github.io/win_posts/20141230_ollydbg_plugin/"/>












<link rel="stylesheet" href="/assets/combined.min.cbcb816aefdb3b7380c5921cbb3b89d12f07742cb3f869754adb56da84f0d729.css" media="all">









  </head>

  

  
  
  

  <body class="light">

    <div class="content">
      <header>
        

<div class="header">

    

</div>

      </header>

      <main class="main">
        





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a href="/win_posts/">Win_posts</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a class="breadcrumbs-current" href="/win_posts/20141230_ollydbg_plugin/">OllyDbg插件开发及逆向分析</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">OllyDbg插件开发及逆向分析</h1>
    
    <p class="single-summary">OllyDbg插件开发及逆向分析</p>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2014-12-30T00:00:00&#43;00:00">December 30, 2014</time>
      

      
    </p>

  </div>

  

  
  
  

  

  
  <aside class="toc">
    <p><strong>Table of contents</strong></p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#第一章-初探ollydbg插件">第一章 初探OllyDbg插件</a>
      <ul>
        <li><a href="#一基本原理">一、基本原理</a></li>
        <li><a href="#二编译">二、编译</a></li>
        <li><a href="#三使用mfc开发ollydbg1插件">三、使用MFC开发OllyDbg1插件</a></li>
        <li><a href="#四插件生命周期">四、插件生命周期</a></li>
      </ul>
    </li>
    <li><a href="#第二章-ollydbg输出函数按功能分类">第二章 OllyDbg输出函数按功能分类</a>
      <ul>
        <li><a href="#熟悉插件函数">熟悉插件函数</a></li>
        <li><a href="#例子">例子</a></li>
      </ul>
    </li>
    <li><a href="#第三章-对于ollydbg加载插件过程的分析">第三章 对于OllyDbg加载插件过程的分析</a>
      <ul>
        <li><a href="#初探">初探</a></li>
        <li><a href="#深入">深入</a></li>
      </ul>
    </li>
    <li><a href="#第四章-ollydbg插件cheatutility逆向分析">第四章 OllyDbg插件CheatUtility逆向分析</a>
      <ul>
        <li><a href="#逆向">逆向</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
    <li><a href="#第五章-ollydbg去除花指令插件dejunk源码分析">第五章 OllyDbg去除花指令插件DeJunk源码分析</a>
      <ul>
        <li><a href="#逆向-1">逆向</a></li>
        <li><a href="#实例">实例</a></li>
      </ul>
    </li>
    <li><a href="#第六章-ollydbg导入ida符号插件loadmap分析">第六章 OllyDbg导入IDA符号插件LoadMap分析</a>
      <ul>
        <li><a href="#逆向-2">逆向</a></li>
      </ul>
    </li>
    <li><a href="#第七章-使用vs2010以上版本的mfc编写ollydbg插件">第七章 使用VS2010以上版本的MFC编写OllyDbg插件</a></li>
    <li><a href="#附录一-ollydbg导出函数">附录一 OllyDbg导出函数</a></li>
  </ul>
</nav>
  </aside>
  

  

  <div class="single-content">
    <h2 id="第一章-初探ollydbg插件">第一章 初探OllyDbg插件</h2>
<p>  官网<a href="http://www.ollydbg.de/">http://www.ollydbg.de/</a>给出了关于插件开发的信息。OllyDbg1.10的插件开发包在<a href="http://www.ollydbg.de/plug11.zip">http://www.ollydbg.de/plug11.zip</a>。该压缩包包含以下文件：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">File</th>
          <th style="text-align: left">Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Bookmark.c</td>
          <td style="text-align: left">OllyDbg书签插件源码，该插件支持调试程序时设置10个书签</td>
      </tr>
      <tr>
          <td style="text-align: left">Cmdexec.c</td>
          <td style="text-align: left">OllyDbg命令行插件，该插件支持输入命令进行调试</td>
      </tr>
      <tr>
          <td style="text-align: left">Cmdline.rtf</td>
          <td style="text-align: left">命令行插件的帮助文件</td>
      </tr>
      <tr>
          <td style="text-align: left">Command.c</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">Ollydbg.def</td>
          <td style="text-align: left">OllyDbg定义文件，某些编译器用之生成输入链接库ollydbg.li</td>
      </tr>
      <tr>
          <td style="text-align: left">Plugin.h</td>
          <td style="text-align: left">插件公共头文件</td>
      </tr>
      <tr>
          <td style="text-align: left">Plugins.hlp</td>
          <td style="text-align: left">插件编写说明</td>
      </tr>
  </tbody>
</table>
<p>  插件开发目录结构如下：</p>
<pre tabindex="0"><code class="language-Txt" data-lang="Txt">│
├─Bc55                   Borland C++系列编译器工程
│      BOOKMARK.MAK
│      CMDLINE.BPR
│      CMDLINE.CPP
│      CMDLINE.MAK
│      OLLYDBG.LIB
│      SAMPLE.BPR
│      SAMPLE.CPP
│
└─Vc50                  Visual C++系列编译器工程，这也是本文所使用的开发环境
        BOOKMARK.DSP
        BOOKMARK.DSW
        BOOKMARK.MAK
        CMDLINE.DSP
        CMDLINE.DSW
        CMDLINE.MAK
        OLLYDBG.LIB       
</code></pre><h3 id="一基本原理">一、基本原理</h3>
<p>  OllyDbgv1.10是OllyDbg1系列的最终版本，作者已停止开发，转而开发v2.0版本，新版本和1.xx版本是不兼容的，插件也是如此。对于1.xx版本，插件大体上通用，这几个版本的改动有：</p>
<ul>
<li>t_reg和t_bpoint结构体扩展</li>
<li>新选项“总在最前”需要插件窗口特殊支持</li>
<li>Browsefilename支持保存文件对话框<br>
  插件是提供附加功能的DLL文件，位于OllyDbg目录下。OllyDbg启动时会逐个加载所有可用的DLL文件，检查名为_ODBG_Plugindata和_ODBG_Plugininit的入口点（输出函数），如果存在并且插件版本号兼容，OllyDbg会注册插件并在插件子菜单增加相应项。插件可以在反汇编、转储、堆栈、内存、模块、线程、断点、监视、参考、界面窗口、运行跟踪窗口增加菜单项和监视全局/局部快捷键。插件可以是MDI窗口；可以在.udd文件中写入模块相关的自定义数据；可以访问和修改ollydbg.ini的数据结构以描述调试信息。插件使用多个回调函数和OllyDbg通信，可以调用170+个插件API函数。插件接口不是面向对象的。插件API函数不是线程安全的，没有实现临界区，插件创建的新线程不能调用这些函数，否则可能导致OllyDbg和程序崩溃。</li>
</ul>
<h3 id="二编译">二、编译</h3>
<p>  请将编译器按如下设置以便插件和OllyDbg通信，plugin.h会检查这些设置：</p>
<ul>
<li>如果使用C++编译器则需要禁用导出函数的名称修饰（使用extern “C”）</li>
<li>强制所有API函数和导出函数使用C格式调用_cdecl</li>
<li>强制所有结构体按字节对齐</li>
<li>默认字符类型为unsigned型</li>
</ul>
<p>  编译自定义插件会用到plugin.h ollydbg.lib，需要复制到工程目录中。现在以VS2010为例介绍如何编写无任何功能的插件。首先建立一个Windows动态链接库的空项目，在工程属性中，选C/C++ -&gt; 命令行，右侧“其它选项”加入“/J”。之后向工程添加helloworld.cpp，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>#include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span>#include &#34;lugin.h&#34;
</span></span><span style="display:flex;"><span>HINSTANCE hinst<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>BOOL <span style="color:#5f5fff">WINAPIDllEntryPoint</span>(HINSTANCE hi,DWORD reason,LPVOID reserved)
</span></span><span style="display:flex;"><span>{//DLL入口点
</span></span><span style="display:flex;"><span>       <span style="color:#ec0000">if</span> (reason<span style="color:#ec0000">==</span>DLL_PROCESS_ATTACH)
</span></span><span style="display:flex;"><span>                hinst<span style="color:#ec0000">=</span>hi; 
</span></span><span style="display:flex;"><span>       <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span> _export cdecl <span style="color:#5f5fff">ODBG_Plugininit</span>(<span style="color:#5f5fff">int</span> ollydbgversion,HWND hw,ulong <span style="color:#ec0000">*</span>features)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>       MessageBox(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">&#34;HelloWorld&#34;</span>,<span style="color:#008900">&#34;HelloWorld&#34;</span>,MB_OK);
</span></span><span style="display:flex;"><span>       <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span> _export cdecl <span style="color:#5f5fff">ODBG_Plugindata</span>(<span style="color:#5f5fff">char</span> shortname[<span style="color:#008900">32</span>]) 
</span></span><span style="display:flex;"><span>{//用于插件菜单中显示插件名
</span></span><span style="display:flex;"><span>       strcpy(shortname,<span style="color:#008900">&#34;HelloWorld&#34;</span>);   
</span></span><span style="display:flex;"><span>       <span style="color:#ec0000">return</span> PLUGIN_VERSION;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  编译得到的dll放到ollydbg根目录下，启动ollydbg就可以看到弹出对话框，同时插件菜单栏多了一项“Hello Wolrd”。使用dumpbin或depends工具查看ollydbg.exe输出表，可以看到700+个函数，这些就是插件API函数。ollydbg.exe导出了很多函数目的是提供插件插件，将如设置断点、反编译等一些相对独立的模块，抽取出来，可供第三方调用。调用OllyDbg-API：欲调用OllyDbg导出函数（例如FuncA），首先在源文件中包含Plugin.h，并在调用之前增加代码“#pragmacomment(lib,&ldquo;ollydbg.lib&rdquo;)”，同时将插件开发包Vc50目录下的ollydbg.lib拷贝到工程目录中。此外OllyDbg作者写的Plugin.h不适用于VS系列编译器，由于ollydbg.exe实际导出符号为下划线版本（_FuncA），而plugin.h声明的是无下划线形式，因此直接编译会出现链接问题，而作者仅对ODBG系列函数作出调整而未对OllyDbg-API声明作出相应调整，因此所有用到的OllyDbg-API都需要进行手工调整，先找到Plugin.h中这样的代码段：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>  #define ODBG_Plugindata      _ODBG_Plugindata
</span></span><span style="display:flex;"><span>  #define ODBG_Plugininit      _ODBG_Plugininit
</span></span><span style="display:flex;"><span>  #define ODBG_Pluginmainloop  _ODBG_Pluginmainloop
</span></span><span style="display:flex;"><span>  #define ODBG_Pluginsaveudd   _ODBG_Pluginsaveudd
</span></span><span style="display:flex;"><span>  #define ODBG_Pluginuddrecord_ODBG_Pluginuddrecord
</span></span><span style="display:flex;"><span>  #define ODBG_Pluginmenu      _ODBG_Pluginmenu
</span></span><span style="display:flex;"><span>  #define ODBG_Pluginaction    _ODBG_Pluginaction
</span></span><span style="display:flex;"><span>  #define ODBG_Pluginshortcut  _ODBG_Pluginshortcut
</span></span><span style="display:flex;"><span>  #define ODBG_Pluginreset     _ODBG_Pluginreset
</span></span><span style="display:flex;"><span>  #define ODBG_Pluginclose     _ODBG_Pluginclose
</span></span><span style="display:flex;"><span>  #define ODBG_Plugindestroy   _ODBG_Plugindestroy
</span></span><span style="display:flex;"><span>  #define ODBG_Paused          _ODBG_Paused
</span></span><span style="display:flex;"><span>  #define ODBG_Pausedex        _ODBG_Pausedex
</span></span><span style="display:flex;"><span>  #define ODBG_Plugincmd       _ODBG_Plugincmd
</span></span></code></pre></div><h4 id="头文件包含接口声明">头文件包含接口声明</h4>
<p>  在其后加入自己的声明这样方可正常编译链接，如：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>  #define Plugingetvalue                         _Plugingetvalue
</span></span><span style="display:flex;"><span>  #define Getstatus                              _Getstatus
</span></span></code></pre></div><h4 id="获取导入库">获取导入库</h4>
<p>  之后手动生成ollydbg.lib：ollydbg.lib可以由插件根目录存在ollydbg.def文件手动生成，这里会用到VS编译器自带工具lib.exe，命令如下：<code>lib/MACHINE:X86 /DEFllydbg.def</code></p>
<h4 id="编译调试">编译调试</h4>
<p>  调试：写插件本身具有难度，然而调试OllyDbg运行插件似乎就更难了。然而我却不以为然，将OllyDbg拷贝到生成dll的目录中（前提是该版本OllyDbg读取插件的目录为自身根目录），设置工程属性=&gt;调试=&gt;命令，将拷贝后的OllyDbg文件路径写入该处，调试即可在DLL源码中断下。</p>
<h3 id="三使用mfc开发ollydbg1插件">三、使用MFC开发OllyDbg1插件</h3>
<p>  上面介绍的是使用MSVC的Windows DLL工程的情况，而这里介绍如何结合MFC进行插件开发。经我测试，VS2010及之后的MFC，由于内部使用的ATL和/J编译指令冲突，因此无法编译，而VC6版本可以很好地编译。下面是开发步骤，以test为例：</p>
<ul>
<li>1.新建名为test的MFC DLL工程</li>
<li>2.在自动生成的StdAfx.h文件末尾加入 #inclue “Plugin.h” 同时将Plugin.h拷入工程目录</li>
<li>3.在test.cpp中添加ODBG_***导出函数</li>
<li>4.在调用OllyDbg导出函数之前，加入#pragma comment(lib,&ldquo;ollydbg.lib&rdquo;)</li>
</ul>
<h3 id="四插件生命周期">四、插件生命周期</h3>
<p>  OllyDbg所规定的插件输出函数，其实正好反映了插件的生命周期，类似于窗口的生命周期，它与消息机制相关。下面通过实例得到插件生命周期：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>#include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span>#include &#34;lugin.h&#34;
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span> _export cdecl <span style="color:#5f5fff">ODBG_Plugindata</span>(<span style="color:#5f5fff">char</span> shortname[<span style="color:#008900">32</span>]) 
</span></span><span style="display:flex;"><span>{//插件检测
</span></span><span style="display:flex;"><span>       strcpy(shortname,<span style="color:#008900">&#34;菜单显示项&#34;</span>);  
</span></span><span style="display:flex;"><span>       MessageBox(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">&#34;ODBG_Plugindata&#34;</span>,<span style="color:#008900">&#34;&#34;</span>,MB_OK);
</span></span><span style="display:flex;"><span>       <span style="color:#ec0000">return</span> PLUGIN_VERSION;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span> _export cdecl <span style="color:#5f5fff">ODBG_Plugininit</span>(<span style="color:#5f5fff">int</span> ollydbgversion,HWND hw,ulong <span style="color:#ec0000">*</span>features)
</span></span><span style="display:flex;"><span>{//插件初始化
</span></span><span style="display:flex;"><span>       MessageBox(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">&#34;ODBG_Plugininit&#34;</span>,<span style="color:#008900">&#34;&#34;</span>,MB_OK);
</span></span><span style="display:flex;"><span>       <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Pluginmenu</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">char</span> data[<span style="color:#008900">4096</span>],<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)
</span></span><span style="display:flex;"><span>{//初始化菜单项
</span></span><span style="display:flex;"><span>       MessageBox(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">&#34;ODBG_Pluginmenu&#34;</span>,<span style="color:#008900">&#34;&#34;</span>,MB_OK);
</span></span><span style="display:flex;"><span>       <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Pluginclose</span>(<span style="color:#5f5fff">void</span>)
</span></span><span style="display:flex;"><span>{//用户关闭OllyDbg时触发
</span></span><span style="display:flex;"><span>       MessageBox(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">&#34;ODBG_Pluginclose&#34;</span>,<span style="color:#008900">&#34;&#34;</span>,MB_OK);
</span></span><span style="display:flex;"><span>       <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">void</span> _export cdecl <span style="color:#5f5fff">ODBG_Plugindestroy</span>(<span style="color:#5f5fff">void</span>)
</span></span><span style="display:flex;"><span>{//OllyDbg退出时触发
</span></span><span style="display:flex;"><span>       MessageBox(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">&#34;ODBG_Plugindestroy&#34;</span>,<span style="color:#008900">&#34;&#34;</span>,MB_OK);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>// 输出 ODBG_Plugindata=&gt; ODBG_Plugininit =&gt; ODBG_Pluginmenu =&gt; ODBG_Pluginclose =&gt; ODBG_Plugindestroy
</span></span></code></pre></div><h2 id="第二章-ollydbg输出函数按功能分类">第二章 OllyDbg输出函数按功能分类</h2>
<h3 id="熟悉插件函数">熟悉插件函数</h3>
<p>  学习Windows编程需要熟悉WindowsAPI，同样地，熟悉OllyDbg插件编程也要熟悉OllyDbg API。</p>
<p>原型：<code>int Registerpluginclass(char *classname,char *iconname,HINSTANCE dllinst,WNDPROCclassproc)</code><br>
功能：生成唯一的类名并注册为插件窗口。如果iconname为NULL则使用标准插件图标（字母P）<br>
返回：成功时返回0并填充classname，失败时返回1<br>
参数：<br>
  classname 指向大小大于32字符的缓冲区用于接收类名<br>
  iconname 插件DLL中图标资源名<br>
  dllinst 插件实例句柄<br>
  classproc 新类的窗口过程地址<br>
注意：注册后窗口类有8个整数（32字节）的额外空间，插件可以自由使用第2到7个整数空间（偏移8到28用于GetWindowLong和SetWindowLong）。ODBG_Plugininit是执行该函数的最佳位置</p>
<p>原型：<code>void Unregisterpluginclass(char *classname)</code><br>
功能：注销之前通过Registerpluginclass注册的窗口类<br>
参数：<br>
  classname 函数Registerpluginclass返回的类名<br>
注意：在ODBG_Plugindestroy中对所有注册的窗口类调用该函数</p>
<p>原型：<code>int Pluginwriteinttoini(HINSTANCE dllinst,char *key,int value)</code><br>
功能：将整数值绑定的键值对存储在ollydbg.ini的插件自定义区段中<br>
返回：成功时返回1，失败时返回0<br>
参数：<br>
  dllinst 插件实例句柄<br>
  key 整数相关的键名<br>
  value 要存储在ollydbg.ini的整数</p>
<p>原型：<code>int Pluginwritestringtoini(HINSTANCE dllinst,char *key,char *s)</code><br>
功能：将ASCII字符串绑定的键值对存储在ollydbg.ini的插件自定义区段中<br>
返回：成功时返回1，失败时返回0<br>
参数：<br>
  dllinst 插件实例句柄<br>
  key 字符串相关的键名<br>
  s 要存储在ollydbg.ini的字符串</p>
<p>原型：<code>int Pluginreadintfromini(HINSTANCE dllinst,char *key,int def)</code><br>
功能：将整数值绑定的键值对从ollydbg.ini的插件自定义区段中读取出来<br>
返回：成功时返回目标整数，失败时返回默认值<br>
参数：<br>
  dllinst 插件实例句柄<br>
  key 整数相关的键名<br>
  def 默认值</p>
<p>原型：<code>int Pluginreadstringfromini(HINSTANCE dllinst,char *key,char *s,char *def)</code><br>
功能：将字符串绑定的键值对从ollydbg.ini的插件自定义区段中读取出来<br>
返回：成功时返回目标字符串，失败时返回默认值<br>
参数：<br>
  dllinst 插件实例句柄<br>
  key 字符串相关的键名<br>
  s 用于接收目标字符串<br>
  def 默认字符串，以零终止符结尾</p>
<p>原型：<code>int Pluginsaverecord(ulong tag,ulong size,void *data)</code><br>
功能：将一个记录写入.udd文件<br>
返回：成功时返回1，失败时返回0<br>
参数：<br>
  tag 插件唯一的标签<br>
  size 写入.udd文件的数据大小，最大USERLEN<br>
  data 写入.udd文件的数据缓冲区<br>
注意：只能从ODBG_Pluginsaveudd中调用，否则会崩溃</p>
<p>原型：<code>int Plugingetvalue(int type)</code><br>
功能：返回OllyDbg多个设置和变量信息<br>
参数：<br>
  type 要返回的设置或变量信息</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">type</th>
          <th style="text-align: left">实际类型</th>
          <th style="text-align: left">含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">VAL_HINST</td>
          <td style="text-align: left">HINST</td>
          <td style="text-align: left">当前OllDbg实例句柄</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_HWMAIN</td>
          <td style="text-align: left">HWND</td>
          <td style="text-align: left">OllyDbg主窗口句柄</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_HWCLIENT</td>
          <td style="text-align: left">HWND</td>
          <td style="text-align: left">MDI用户窗口句柄</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_NCOLORS</td>
          <td style="text-align: left">int</td>
          <td style="text-align: left">常见颜色数</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_COLORS</td>
          <td style="text-align: left">COLORREF*</td>
          <td style="text-align: left">常见颜色RGB值数组</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_BRUSHES</td>
          <td style="text-align: left">HBRUSH*</td>
          <td style="text-align: left">常见颜色画刷句柄数组</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_PENS</td>
          <td style="text-align: left">HPEN*</td>
          <td style="text-align: left">常见颜色画笔句柄数组</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_NFONTS</td>
          <td style="text-align: left">int</td>
          <td style="text-align: left">常见字体数</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_FONTS</td>
          <td style="text-align: left">HFONT*</td>
          <td style="text-align: left">常见字体句柄数组</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_FONTNAMES</td>
          <td style="text-align: left">Char**</td>
          <td style="text-align: left">内部字体名称</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_FONTWIDTHS</td>
          <td style="text-align: left">int*</td>
          <td style="text-align: left">常见字体平均宽度</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_FONTHEIGHTS</td>
          <td style="text-align: left">int*</td>
          <td style="text-align: left">常见字体平均高度</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_NFIXFONTS</td>
          <td style="text-align: left">int</td>
          <td style="text-align: left">固定字宽字体数</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_DEFFONT</td>
          <td style="text-align: left">int</td>
          <td style="text-align: left">默认字体序号</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_NSCHEMES</td>
          <td style="text-align: left">int</td>
          <td style="text-align: left">配色方案数</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_SCHEMES</td>
          <td style="text-align: left">t_scheme*</td>
          <td style="text-align: left">配色方案数组</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_DEFSCHEME</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">默认配色方案数组</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_DEFHSCROLL</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">默认水平滚动</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_RESTOREWINDOWPOS</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">从.ini文件恢复窗口位置</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_HPROCESS</td>
          <td style="text-align: left">HANDLE</td>
          <td style="text-align: left">被调试进程句柄</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_PROCESSID</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">被调试进程标志ID</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_HMAINTHREAD</td>
          <td style="text-align: left">HANDLE</td>
          <td style="text-align: left">被调试进程主线程句柄</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_MAINTHREADID</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">被调试进程主线程标志ID</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_MAINBASE</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">被调试进程主模块基址</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_PROCESSNAME</td>
          <td style="text-align: left">char*</td>
          <td style="text-align: left">被调试进程名</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_EXEFILENAME</td>
          <td style="text-align: left">char*</td>
          <td style="text-align: left">被调试程序文件名</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_CURRENTDIR</td>
          <td style="text-align: left">char*</td>
          <td style="text-align: left">被调试进程当前目录</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_SYSTEDIR</td>
          <td style="text-align: left">char*</td>
          <td style="text-align: left">系统目录</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_DECODEANYIP</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">不依赖EIP解码寄存器</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_PASCALSTRINGS</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">解码Pascal格式字符串</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_ONLYASCII</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">只解码可打印ASCII字符</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_DIACRITICALS</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">允许字符串有变音符号</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_GLOBALSEARCH</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">从块的开始处搜索</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_ALIGNEDSEARCH</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">逐项搜索</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_SEARCHMARGIN</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">浮点搜索允许误差</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_KEEPSELSIZE</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">保存16进制编辑中选择项数</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_MMXDISPLAY</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">对话框MMX显示模式(0:16进制 1:有符号 2:无符号)</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_WINDOWFONT</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">对话框中使用窗口字体</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_TABSTOPS</td>
          <td style="text-align: left">制表符大小</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_MODULES</td>
          <td style="text-align: left">t_table*</td>
          <td style="text-align: left">模块表(包括.EXE和.DLL)</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_MEMORY</td>
          <td style="text-align: left">t_table*</td>
          <td style="text-align: left">分配内存块表</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_THREADS</td>
          <td style="text-align: left">t_table*</td>
          <td style="text-align: left">活动线程表</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_BREAKPOINTS</td>
          <td style="text-align: left">t_table*</td>
          <td style="text-align: left">激活断点表</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_REFERENCES</td>
          <td style="text-align: left">t_table*</td>
          <td style="text-align: left">查找到的参考信息表</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_SOURCELIST</td>
          <td style="text-align: left">t_table*</td>
          <td style="text-align: left">源文件表</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_WATCHES</td>
          <td style="text-align: left">t_table*</td>
          <td style="text-align: left">监视情况表</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_CPUFEATURES</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">CPUID返回的CPU特征位</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_TRACEFILE</td>
          <td style="text-align: left">FILE*</td>
          <td style="text-align: left">运行跟踪记录文件句柄</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_ALIGNDIALOGS</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">对齐对话框</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_CPUDASM</td>
          <td style="text-align: left">t_dump*</td>
          <td style="text-align: left">获取CPU反汇编窗口描述符</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_CPUDDUMP</td>
          <td style="text-align: left">t_dump*</td>
          <td style="text-align: left">获取CPU内存窗口描述符</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_CPUDSTACK</td>
          <td style="text-align: left">t_dump*</td>
          <td style="text-align: left">获取CPU栈窗口描述符</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_APIHELP</td>
          <td style="text-align: left">char*</td>
          <td style="text-align: left">选择的API帮助文件名</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_HARDBP</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">硬件断点是否激活</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_PATCHES</td>
          <td style="text-align: left">t_table*</td>
          <td style="text-align: left">补丁表</td>
      </tr>
      <tr>
          <td style="text-align: left">VAL_HINTS</td>
          <td style="text-align: left">t_sorted*</td>
          <td style="text-align: left">带分析提示的排序数据</td>
      </tr>
  </tbody>
</table>
<p>  说明：带有VAL_N的type变量表示获取数量，需要先获取该数量才能知道对应的VAL数据数组有多大。例如FONT系列，首先要调用Plugingetvalue(VAL_NFONTS)获取字体个数，之后再调用VAL_FONTNAMES等获取数据数组，数组元素个数就是前一步获取的个数。t_table和t_dump也类似，t_table内含的重要数据是t_sorteddata，而t_sorted结构体自身包含了元素个数，因此读者可根据例1写出输出更完整信息的程序了。返回t_dump类型的函数大部分是窗口数据，从这个意义上插件可以做的和OllyDbg一模一样！</p>
<p>原型：<code>t_status Getstatus(void)</code><br>
功能：返回被调试进程的当前状态（STAT_XXX）<br>
返回：<br>
  STAT_NONE 未调试进程<br>
  STAT_STOPPED 进程挂起<br>
  STAT_EVENT 处理调试事件，进程暂停<br>
  STAT_RUNNING 进程运行<br>
  STAT_FINISHED 进程结束<br>
  STAT_CLOSING 调用TerminateProcess()等待结果</p>
<h3 id="例子">例子</h3>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>#include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>#include &#34;Plugin.h&#34;
</span></span><span style="display:flex;"><span>#pragma comment(lib,&#34;OllyDbg.lib&#34;)
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">char</span> classname[<span style="color:#008900">32</span>];
</span></span><span style="display:flex;"><span>HINSTANCE hinst<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">class</span> <span style="color:#5f5fff">log</span>//用于实现插件日志记录——单例模式
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#ec0000">private</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        log()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">try</span>
</span></span><span style="display:flex;"><span>                 {
</span></span><span style="display:flex;"><span>                         <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>AllocConsole())
</span></span><span style="display:flex;"><span>                         {
</span></span><span style="display:flex;"><span>                                  MessageBox(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">&#34;无法创建命令行窗口&#34;</span>,<span style="color:#008900">&#34;错误&#34;</span>,MB_OK);
</span></span><span style="display:flex;"><span>                                  <span style="color:#ec0000">throw</span> <span style="color:#008900">&#34;错误&#34;</span>;
</span></span><span style="display:flex;"><span>                         }
</span></span><span style="display:flex;"><span>                 }
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">catch</span>(...)
</span></span><span style="display:flex;"><span>                 {
</span></span><span style="display:flex;"><span>                         exit(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                 }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">~</span>log()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                 FreeConsole();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">static</span> <span style="color:#5f5fff">void</span> v(<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> tolog)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">static</span> log obj;
</span></span><span style="display:flex;"><span>                 HANDLEout<span style="color:#ec0000">=</span>GetStdHandle(STD_OUTPUT_HANDLE);
</span></span><span style="display:flex;"><span>                 DWORDWriteNum;
</span></span><span style="display:flex;"><span>                 WriteConsole(out,tolog,strlen(tolog),<span style="color:#ec0000">&amp;</span>WriteNum,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>BOOL WINAPI <span style="color:#5f5fff">DllMain</span>(HINSTANCE hi,DWORD reason,LPVOID reserved)
</span></span><span style="display:flex;"><span>{//DLL入口点
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (reason<span style="color:#ec0000">==</span>DLL_PROCESS_ATTACH)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                 hinst<span style="color:#ec0000">=</span>hi;//保存实例句柄供后面使用
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>LRESULT CALLBACK <span style="color:#5f5fff">WndProc</span>(HWND hw,UINT msg,WPARAM wp,LPARAM lp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> DefWindowProc(hw,msg,wp,lp);//暂时不用这里，因此只写个空架子
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span> _export cdecl <span style="color:#5f5fff">ODBG_Plugininit</span>(<span style="color:#5f5fff">int</span> ollydbgversion,HWND hw,ulong <span style="color:#ec0000">*</span>features)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        chartemp[<span style="color:#008900">256</span>];
</span></span><span style="display:flex;"><span>        sprintf(temp,<span style="color:#008900">&#34;版本号：%d</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,ollydbgversion);
</span></span><span style="display:flex;"><span>        log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#008900">0</span> <span style="color:#ec0000">==</span> Registerpluginclass(temp,<span style="color:#ec0000">NULL</span>,hinst,WndProc))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(<span style="color:#008900">&#34;插件注册成功：&#34;</span>);
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(<span style="color:#008900">&#34;</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(<span style="color:#008900">&#34;插件注册失败</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span> _export cdecl <span style="color:#5f5fff">ODBG_Plugindata</span>(<span style="color:#5f5fff">char</span> shortname[<span style="color:#008900">32</span>]) 
</span></span><span style="display:flex;"><span>{//用于插件菜单中显示插件名
</span></span><span style="display:flex;"><span>        strcpy(shortname,<span style="color:#008900">&#34;sample1&#34;</span>);   
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> PLUGIN_VERSION;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span> _export cdecl <span style="color:#5f5fff">ODBG_Pluginshortcut</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">int</span> ctrl,<span style="color:#5f5fff">int</span> alt,<span style="color:#5f5fff">int</span> shift,<span style="color:#5f5fff">int</span> key,<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)
</span></span><span style="display:flex;"><span>{//按下I键（代表Information）显示OLLYDBG和进程信息
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">if</span> (key<span style="color:#ec0000">!=</span><span style="color:#008900">&#39;I&#39;</span>)
</span></span><span style="display:flex;"><span>                         <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">switch</span>(Getstatus())
</span></span><span style="display:flex;"><span>                 {
</span></span><span style="display:flex;"><span>                         <span style="color:#ec0000">case</span> <span style="color:#ec0000">STAT_NONE</span>:
</span></span><span style="display:flex;"><span>                                  log<span style="color:#ec0000">::</span>v(<span style="color:#008900">&#34;——————————————未调试进程——————————————</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>                                  <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                         <span style="color:#ec0000">case</span> <span style="color:#ec0000">STAT_STOPPED</span>:
</span></span><span style="display:flex;"><span>                                  log<span style="color:#ec0000">::</span>v(<span style="color:#008900">&#34;——————————————进程挂起——————————————</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>                                  <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                         <span style="color:#ec0000">case</span> <span style="color:#ec0000">STAT_EVENT</span>:
</span></span><span style="display:flex;"><span>                                  log<span style="color:#ec0000">::</span>v(<span style="color:#008900">&#34;——————————————进程暂停，处理调试事件——————————————</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>                                  <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                         <span style="color:#ec0000">case</span> <span style="color:#ec0000">STAT_RUNNING</span>:
</span></span><span style="display:flex;"><span>                                  log<span style="color:#ec0000">::</span>v(<span style="color:#008900">&#34;——————————————进程运行——————————————</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>                                  <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                         <span style="color:#ec0000">case</span> <span style="color:#ec0000">STAT_FINISHED</span>:
</span></span><span style="display:flex;"><span>                                  log<span style="color:#ec0000">::</span>v(<span style="color:#008900">&#34;——————————————进程结束——————————————</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>                                  <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                         <span style="color:#ec0000">case</span> <span style="color:#ec0000">STAT_CLOSING</span>:
</span></span><span style="display:flex;"><span>                                  log<span style="color:#ec0000">::</span>v(<span style="color:#008900">&#34;——————————————进程等待关闭——————————————</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>                                  <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                 }
</span></span><span style="display:flex;"><span>                 chartemp[<span style="color:#008900">256</span>];
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;OllyDbg实例句柄：0x%0x</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_HINST));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;OllyDbg主窗口句柄：0x%0x</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_HWMAIN));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;被调试进程句柄：0x%0x</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_HPROCESS));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;被调试进程ID：%d</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_PROCESSID));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;被调试进程主线程句柄：0x%0x</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_HMAINTHREAD));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;被调试进程主线程ID：%d</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_MAINTHREADID));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;被调试进程主模块基址：0x%0x</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_MAINBASE));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;被调试进程名：%s</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_PROCESSNAME));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;被调试进程文件名：%s</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_EXEFILENAME));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;被调试进程当前目录：0x%0x</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_CURRENTDIR));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;系统目录：%s</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_SYSTEMDIR));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>                 sprintf(temp,<span style="color:#008900">&#34;被调试进程主模块基址：0x%0x</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,Plugingetvalue(VAL_MAINBASE));
</span></span><span style="display:flex;"><span>                 log<span style="color:#ec0000">::</span>v(temp);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>说明：如第一章所述，用到的OllyDbg-API有Registerpluginclass，Plugingetvalue，Getstatus都要在Plugin.h重新定义。该代码为Windows DLL项目主文件，插件启动后会出现控制台窗口，在加载了进程后，在OllyDbg窗口激活时按下“I”键，会输出类似下面的数据：</p>
<pre tabindex="0"><code>版本号：110
插件注册成功：OT_PLUGIN_0000
——————————————进程挂起——————————————
OllyDbg实例句柄：0x400000
OllyDbg主窗口句柄：0x3f1c14
被调试进程句柄：0x3c0
被调试进程ID：6932
被调试进程主线程句柄：0x758
被调试进程主线程ID：10444
被调试进程主模块基址：0x1000000
被调试进程名：RC
被调试进程文件名：D:\Program Files (x86)\Microsoft Visual Studio\Common\MSDev98\
Bin\RC.EXE
被调试进程当前目录：0x4d5c84
系统目录：C:\windows\system32\
被调试进程主模块基址：0x1000000
</code></pre><p>本例中提供的log类极为有用，因此需要单独提取出来作为一个文件，后面例子只包含log.h即可，不再赘述</p>
<h2 id="第三章-对于ollydbg加载插件过程的分析">第三章 对于OllyDbg加载插件过程的分析</h2>
<h3 id="初探">初探</h3>
<p>  这里对v1.10版本进行逆向，加载插件是在OllyDbg启动后，加载调试程序前完成的，因此需要用OllyDbg调试自身。文档中说OllyDbg先检查_ODBG_Plugindata，那么下断点bp GetProcAddress,[esp+8]==&quot;_ODBG_Plugindata&quot;会发现断在以地址0x00496658开始的函数中。查看其反汇编代码，先进行总体分析，发现有多处调用GetProcAddress，初步判断为加载插件的模块，命名为LoadPlugin，经过分析代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>#include &lt;windows.h&gt;  
</span></span><span style="display:flex;"><span>#include &lt;dos.h&gt;  
</span></span><span style="display:flex;"><span>#include &#34;plugin.h&#34;  
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> <span style="color:#5f5fff">PluginData</span>  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    HMODULE hPluginDll;  
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span>    DllName[<span style="color:#008900">260</span>];  
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> PluginName[<span style="color:#008900">32</span>];  
</span></span><span style="display:flex;"><span>//+296  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">???</span>  
</span></span><span style="display:flex;"><span>//+560  
</span></span><span style="display:flex;"><span>    ODBG_Pluginmainloop;  
</span></span><span style="display:flex;"><span>    ODBG_Pluginmenu;  
</span></span><span style="display:flex;"><span>    ODBG_Pluginaction;  
</span></span><span style="display:flex;"><span>    ODBG_Pluginshortcut;  
</span></span><span style="display:flex;"><span>    ODBG_Pluginsaveudd;  
</span></span><span style="display:flex;"><span>    ODBG_Pluginuddrecord;  
</span></span><span style="display:flex;"><span>    ODBG_Pluginreset;  
</span></span><span style="display:flex;"><span>    ODBG_Paused;  
</span></span><span style="display:flex;"><span>    ODBG_Pausedex;  
</span></span><span style="display:flex;"><span>    ODBG_Plugincmd;  
</span></span><span style="display:flex;"><span>};  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> pluginnum;  
</span></span><span style="display:flex;"><span>PluginData plugindata[<span style="color:#008900">32</span>];//最多32个插件  
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">char</span> data[<span style="color:#008900">0x1100</span>];  
</span></span><span style="display:flex;"><span>HANDLE hwmain;  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">LoadPlugins</span>()  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> pluginpath[<span style="color:#008900">260</span>],filename[<span style="color:#008900">256</span>],pluginname[<span style="color:#008900">32</span>];  
</span></span><span style="display:flex;"><span>    HANDLE hFindFile;  
</span></span><span style="display:flex;"><span>    WIN32_FIND_DATA FindFileData;  
</span></span><span style="display:flex;"><span>    HMENU pluginmenu,popupmenu;  
</span></span><span style="display:flex;"><span>    HMODULE hmod;  
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> ret;  
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> pluginmenuid;  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    memset(plugindata,<span style="color:#ec0000">sizeof</span>(plugindata));  
</span></span><span style="display:flex;"><span>    pluginnum<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;  
</span></span><span style="display:flex;"><span>    strcpy(pluginpath,<span style="color:#008900">&#34;*.dll&#34;</span>);  
</span></span><span style="display:flex;"><span>    hFindFile<span style="color:#ec0000">=</span>FindFirstFile(pluginpath,<span style="color:#ec0000">&amp;</span>FindFileData);  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(hFindFile <span style="color:#ec0000">==</span> INVALID_HANDLE_VALUE)  
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#ec0000">false</span>;  
</span></span><span style="display:flex;"><span>    pluginmenu<span style="color:#ec0000">=</span>CreateMenu();  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>pluginmenu)  
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#ec0000">false</span>;  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">do</span>  
</span></span><span style="display:flex;"><span>    {//搜索根目录下所有dll文件  
</span></span><span style="display:flex;"><span>        hmod<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;  
</span></span><span style="display:flex;"><span>        fnsplit(FindFileData.cFileName,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>,filename,<span style="color:#ec0000">NULL</span>);  
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(stricmp(filename,<span style="color:#008900">&#34;psapi&#34;</span>) <span style="color:#ec0000">&amp;&amp;</span> stricmp(filename,<span style="color:#008900">&#34;dbghelp&#34;</span>))  
</span></span><span style="display:flex;"><span>        {//如果不是psapi.dll和dbghelp.dll  
</span></span><span style="display:flex;"><span>            strcpy(pluginpath,FindFileData.cFileName);  
</span></span><span style="display:flex;"><span>            hmod<span style="color:#ec0000">=</span>LoadLibrary(pluginpath);  
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(hmod)  
</span></span><span style="display:flex;"><span>            {  
</span></span><span style="display:flex;"><span>                ODBG_Plugindata<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;_ODBG_Plugindata&#34;</span>);  
</span></span><span style="display:flex;"><span>                ODBG_Plugininit<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;_ODBG_Plugininit&#34;</span>);  
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(ODBG_Plugindata <span style="color:#ec0000">&amp;&amp;</span> ODBG_Plugininit)  
</span></span><span style="display:flex;"><span>                {  
</span></span><span style="display:flex;"><span>                    pluginname[<span style="color:#008900">0</span>]<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;  
</span></span><span style="display:flex;"><span>                    ret<span style="color:#ec0000">=</span>ODBG_Plugindata(pluginname);  
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span>(ret <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">106</span> <span style="color:#ec0000">&amp;&amp;</span> ret <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">110</span> <span style="color:#ec0000">&amp;&amp;</span> pluginname[<span style="color:#008900">0</span>] <span style="color:#ec0000">!=</span> <span style="color:#008900">&#39;\0&#39;</span>)//版本在1.06~1.10之间  
</span></span><span style="display:flex;"><span>                    {  
</span></span><span style="display:flex;"><span>                        PluginData<span style="color:#ec0000">&amp;</span> curplugin<span style="color:#ec0000">=</span>plugindata[pluginnum];  
</span></span><span style="display:flex;"><span>                        curplugin.hPluginDll<span style="color:#ec0000">=</span>hmod;  
</span></span><span style="display:flex;"><span>                        strcpy(curplugin.DllName,FindFileData.cFileName);  
</span></span><span style="display:flex;"><span>                        strncpy(curplugin.PluginName,pluginname,<span style="color:#008900">31</span>);  
</span></span><span style="display:flex;"><span>                        curplugin.PluginName[<span style="color:#008900">31</span>]<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;  
</span></span><span style="display:flex;"><span>                        curplugin.ODBG_Pluginaction<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginaction&#34;</span>);  
</span></span><span style="display:flex;"><span>                        curplugin.ODBG_Pluginmainloop<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginmainloop&#34;</span>);  
</span></span><span style="display:flex;"><span>                        curplugin.ODBG_Pluginmenu<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginmenu&#34;</span>);  
</span></span><span style="display:flex;"><span>                        curplugin.ODBG_Pluginshortcut<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginshortcut&#34;</span>);  
</span></span><span style="display:flex;"><span>                        curplugin.ODBG_Pluginsaveudd<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginsaveudd&#34;</span>);  
</span></span><span style="display:flex;"><span>                        curplugin.ODBG_Pluginuddrecord<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginuddrecord&#34;</span>);  
</span></span><span style="display:flex;"><span>                        curplugin.ODBG_Pluginreset<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginreset&#34;</span>);  
</span></span><span style="display:flex;"><span>                        curplugin.ODBG_Paused<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Paused&#34;</span>);  
</span></span><span style="display:flex;"><span>                        curplugin.ODBG_Pausedex<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pausedex&#34;</span>);  
</span></span><span style="display:flex;"><span>                        curplugin.ODBG_Plugincmd<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Plugincmd&#34;</span>);  
</span></span><span style="display:flex;"><span>                        ulong feature<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;  
</span></span><span style="display:flex;"><span>                        ret<span style="color:#ec0000">=</span>ODBG_Plugininit(<span style="color:#008900">110</span>,hwmain,<span style="color:#ec0000">&amp;</span>feature);  
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">if</span>(ret)  
</span></span><span style="display:flex;"><span>                        {  
</span></span><span style="display:flex;"><span>                            Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">&#34;Plugin &#39;%s&#39; failed to initialize (code %i)&#34;</span>,filename,ret);  
</span></span><span style="display:flex;"><span>                        }  
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">else</span> 
</span></span><span style="display:flex;"><span>                        {  
</span></span><span style="display:flex;"><span>                            pluginmenuid<span style="color:#ec0000">=</span>pluginnum<span style="color:#ec0000">*</span><span style="color:#008900">32</span><span style="color:#ec0000">+</span><span style="color:#008900">57344</span>;  
</span></span><span style="display:flex;"><span>                            pluginname[<span style="color:#008900">0</span>]<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;  
</span></span><span style="display:flex;"><span>                            <span style="color:#ec0000">if</span>(curplugin.ODBG_Pluginmenu) <span style="color:#ec0000">&amp;&amp;</span> curplugin.ODBG_Pluginmenu(PM_MAIN,data,<span style="color:#ec0000">NULL</span>))  
</span></span><span style="display:flex;"><span>                            {  
</span></span><span style="display:flex;"><span>                                <span style="color:#ec0000">if</span>(pluginname[<span style="color:#008900">0</span>] <span style="color:#ec0000">!=</span> <span style="color:#008900">&#39;\0&#39;</span> <span style="color:#ec0000">&amp;&amp;</span> (popupmenu<span style="color:#ec0000">=</span>CreateMenu()) <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>)  
</span></span><span style="display:flex;"><span>                                {  
</span></span><span style="display:flex;"><span>                                    CreateSubMenu(popupmenu,curplugin,pluginmenuid,<span style="color:#008900">1</span>);  
</span></span><span style="display:flex;"><span>                                }  
</span></span><span style="display:flex;"><span>                                <span style="color:#ec0000">if</span>(pluginnum <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">10</span>)  
</span></span><span style="display:flex;"><span>                                    sprintf(pluginname,<span style="color:#008900">&#34;%s&#34;</span>,curplugin.pluginname);  
</span></span><span style="display:flex;"><span>                                <span style="color:#ec0000">else</span> 
</span></span><span style="display:flex;"><span>                                    sprintf(pluginname,<span style="color:#008900">&#34;&amp;%i %s&#34;</span>,(pluginnum<span style="color:#ec0000">+</span><span style="color:#008900">1</span>)<span style="color:#ec0000">%</span><span style="color:#008900">10</span>,curplugin.pluginname);  
</span></span><span style="display:flex;"><span>                                <span style="color:#ec0000">if</span>(popupmenu)  
</span></span><span style="display:flex;"><span>                                    AppendMenu(pluginmenuid,MF_POPUP,popupmenu,pluginname);  
</span></span><span style="display:flex;"><span>                                <span style="color:#ec0000">else</span> 
</span></span><span style="display:flex;"><span>                                    AppendMenu(pluginmenuid,<span style="color:#008900">0</span>,pluginmenuid,pluginname);  
</span></span><span style="display:flex;"><span>                                pluginnum<span style="color:#ec0000">++</span>;  
</span></span><span style="display:flex;"><span>                                hmod<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;  
</span></span><span style="display:flex;"><span>                            }  
</span></span><span style="display:flex;"><span>                        }  
</span></span><span style="display:flex;"><span>                    }  
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">else</span> 
</span></span><span style="display:flex;"><span>                    {  
</span></span><span style="display:flex;"><span>                        Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">&#34;Plugin &#39;%s&#39; has invalid version (%i.%02i)&#34;</span>,filename,ret<span style="color:#ec0000">/</span><span style="color:#008900">100</span>,ret<span style="color:#ec0000">%</span><span style="color:#008900">100</span>);  
</span></span><span style="display:flex;"><span>                    }  
</span></span><span style="display:flex;"><span>                }  
</span></span><span style="display:flex;"><span>            }  
</span></span><span style="display:flex;"><span>        }  
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(hmod)  
</span></span><span style="display:flex;"><span>            FreeLibrary(hmod);  
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">while</span>(FindNextFile(hFindFile,<span style="color:#ec0000">&amp;</span>FindFileData));  
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p>可见加载过程是：ODBG_Plugindata =&gt; ODBG_Plugininit =&gt; ODBG_Pluginmenu</p>
<h3 id="深入">深入</h3>
<p>  看完了API级别基本用法，现在来看对应OllyDbg内部实现吧！这样可以和第二章作对照这里只进行简单分析即贴出C语言源码，如对逆向分析感兴趣，请关注我的书。以下部分每一节对应第二章的各个节，实为深入底层研究。加载插件是在OllyDbg启动后，加载调试程序前完成的，因此需要用OllyDbg调试自身。文档中说OllyDbg先检查_ODBG_Plugindata，那么下断点<code>bp Kernel32.GetProcAddress,[esp+8]==&quot;_ODBG_Plugindata&quot;</code>会发现断在以地址0x00496658开始的函数中。查看其反汇编代码，先进行总体分析，发现有多处调用GetProcAddress，初步判断为加载插件的模块，命名为LoadPlugin，逆向分析代码如下：</p>
<h4 id="loadplugin">LoadPlugin</h4>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#5f5fff">int</span> pluginnum;
</span></span><span style="display:flex;"><span>PluginData plugindata[<span style="color:#008900">32</span>];//最多32个插件
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">char</span> data[<span style="color:#008900">0x1100</span>];
</span></span><span style="display:flex;"><span>HANDLE hwmain;
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">LoadPlugins</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	charpluginpath[<span style="color:#008900">260</span>],filename[<span style="color:#008900">256</span>],pluginname[<span style="color:#008900">32</span>];
</span></span><span style="display:flex;"><span>	HANDLEhFindFile;
</span></span><span style="display:flex;"><span>	WIN32_FIND_DATAFindFileData;
</span></span><span style="display:flex;"><span>	HMENUpluginmenu,popupmenu;
</span></span><span style="display:flex;"><span>	HMODULE hmod;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> ret;
</span></span><span style="display:flex;"><span>	intpluginmenuid;
</span></span><span style="display:flex;"><span>	memset(plugindata,<span style="color:#ec0000">sizeof</span>(plugindata));
</span></span><span style="display:flex;"><span>	pluginnum<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	strcpy(pluginpath,<span style="color:#008900">&#34;*.dll&#34;</span>);
</span></span><span style="display:flex;"><span>	hFindFile<span style="color:#ec0000">=</span>FindFirstFile(pluginpath,<span style="color:#ec0000">&amp;</span>FindFileData);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(hFindFile<span style="color:#ec0000">==</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>	pluginmenu<span style="color:#ec0000">=</span>CreateMenu();
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>pluginmenu)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> <span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">do</span> 
</span></span><span style="display:flex;"><span>	{//搜索根目录下所有dll文件
</span></span><span style="display:flex;"><span>		hmod<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>		fnsplit(FindFileData.cFileName,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>,filename,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(stricmp(filename,<span style="color:#008900">&#34;psapi&#34;</span>)<span style="color:#ec0000">&amp;&amp;</span> stricmp(filename,<span style="color:#008900">&#34;dbghelp&#34;</span>))
</span></span><span style="display:flex;"><span>		{//如果不是psapi.dll和dbghelp.dll
</span></span><span style="display:flex;"><span>			strcpy(pluginpath,FindFileData.cFileName);
</span></span><span style="display:flex;"><span>			hmod<span style="color:#ec0000">=</span>LoadLibrary(pluginpath);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(hmod)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				ODBG_Plugindata<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;_ODBG_Plugindata&#34;</span>);
</span></span><span style="display:flex;"><span>				ODBG_Plugininit<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;_ODBG_Plugininit&#34;</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(ODBG_Plugindata<span style="color:#ec0000">&amp;&amp;</span> ODBG_Plugininit)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					pluginname[<span style="color:#008900">0</span>]<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>					ret<span style="color:#ec0000">=</span>ODBG_Plugindata(pluginname);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(ret<span style="color:#ec0000">&gt;=</span> <span style="color:#008900">106</span> <span style="color:#ec0000">&amp;&amp;</span> ret <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">110</span> <span style="color:#ec0000">&amp;&amp;</span> pluginname[<span style="color:#008900">0</span>] <span style="color:#ec0000">!=</span> <span style="color:#008900">&#39;\0&#39;</span>)//版本在1.06~1.10之间
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						PluginData<span style="color:#ec0000">&amp;</span>curplugin<span style="color:#ec0000">=</span>plugindata[pluginnum];
</span></span><span style="display:flex;"><span>						curplugin.hPluginDll<span style="color:#ec0000">=</span>hmod;
</span></span><span style="display:flex;"><span>						strcpy(curplugin.DllName,FindFileData.cFileName);
</span></span><span style="display:flex;"><span>						strncpy(curplugin.PluginName,pluginname,<span style="color:#008900">31</span>);
</span></span><span style="display:flex;"><span>						curplugin.PluginName[<span style="color:#008900">31</span>]<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>						curplugin.ODBG_Pluginaction<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginaction&#34;</span>);
</span></span><span style="display:flex;"><span>						curplugin.ODBG_Pluginmainloop<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginmainloop&#34;</span>);
</span></span><span style="display:flex;"><span>						curplugin.ODBG_Pluginmenu<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginmenu&#34;</span>);
</span></span><span style="display:flex;"><span>						curplugin.ODBG_Pluginshortcut<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginshortcut&#34;</span>);
</span></span><span style="display:flex;"><span>						curplugin.ODBG_Pluginsaveudd<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginsaveudd&#34;</span>);
</span></span><span style="display:flex;"><span>						curplugin.ODBG_Pluginuddrecord<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginuddrecord&#34;</span>);
</span></span><span style="display:flex;"><span>						curplugin.ODBG_Pluginreset<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pluginreset&#34;</span>);
</span></span><span style="display:flex;"><span>						curplugin.ODBG_Paused<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Paused&#34;</span>);
</span></span><span style="display:flex;"><span>						curplugin.ODBG_Pausedex<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Pausedex&#34;</span>);
</span></span><span style="display:flex;"><span>						curplugin.ODBG_Plugincmd<span style="color:#ec0000">=</span>GetProcAddress(hmod,<span style="color:#008900">&#34;ODBG_Plugincmd&#34;</span>);
</span></span><span style="display:flex;"><span>						ulongfeature<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>						ret<span style="color:#ec0000">=</span>ODBG_Plugininit(<span style="color:#008900">110</span>,hwmain,<span style="color:#ec0000">&amp;</span>feature);
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(ret)
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">&#34;Plugin&#39;%s&#39; failed to initialize (code %i)&#34;</span>,filename,ret);
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>						{
</span></span><span style="display:flex;"><span>							pluginmenuid<span style="color:#ec0000">=</span>pluginnum<span style="color:#ec0000">*</span><span style="color:#008900">64</span><span style="color:#ec0000">+</span><span style="color:#008900">57344</span>;
</span></span><span style="display:flex;"><span>							pluginname[<span style="color:#008900">0</span>]<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>							<span style="color:#ec0000">if</span>(curplugin.ODBG_Pluginmenu)<span style="color:#ec0000">&amp;&amp;</span> curplugin.ODBG_Pluginmenu(PM_MAIN,data,<span style="color:#ec0000">NULL</span>))
</span></span><span style="display:flex;"><span>							{
</span></span><span style="display:flex;"><span>								<span style="color:#ec0000">if</span>(pluginname[<span style="color:#008900">0</span>]<span style="color:#ec0000">!=</span> <span style="color:#008900">&#39;\0&#39;</span><span style="color:#ec0000">&amp;&amp;</span> (popupmenu<span style="color:#ec0000">=</span>CreateMenu()) <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>								{
</span></span><span style="display:flex;"><span>									CreateSubMenu(popupmenu,curplugin,pluginmenuid,<span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>								}
</span></span><span style="display:flex;"><span>								<span style="color:#ec0000">if</span>(pluginnum<span style="color:#ec0000">&gt;=</span> <span style="color:#008900">10</span>)
</span></span><span style="display:flex;"><span>									sprintf(pluginname,<span style="color:#008900">&#34;%s&#34;</span>,curplugin.pluginname);
</span></span><span style="display:flex;"><span>								<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>									sprintf(pluginname,<span style="color:#008900">&#34;&amp;%i%s&#34;</span>,(pluginnum<span style="color:#ec0000">+</span><span style="color:#008900">1</span>)<span style="color:#ec0000">%</span><span style="color:#008900">10</span>,curplugin.pluginname);
</span></span><span style="display:flex;"><span>								<span style="color:#ec0000">if</span>(popupmenu)
</span></span><span style="display:flex;"><span>									AppendMenu(pluginmenuid,MF_POPUP,popupmenu,pluginname);
</span></span><span style="display:flex;"><span>								<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>									AppendMenu(pluginmenuid,<span style="color:#008900">0</span>,pluginmenuid,pluginname);
</span></span><span style="display:flex;"><span>								pluginnum<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>								hmod<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>							}
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">&#34;Plugin&#39;%s&#39; has invalid version (%i.%02i)&#34;</span>,filename,ret<span style="color:#ec0000">/</span><span style="color:#008900">100</span>,ret<span style="color:#ec0000">%</span><span style="color:#008900">100</span>);
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(hmod)
</span></span><span style="display:flex;"><span>			FreeLibrary(hmod);
</span></span><span style="display:flex;"><span>	} 
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">while</span>(FindNextFile(hFindFile,<span style="color:#ec0000">&amp;</span>FindFileData));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  可见加载过程是：ODBG_Plugindata =&gt; ODBG_Plugininit =&gt; ODBG_Pluginmenu，同理可分析其它函数。</p>
<h4 id="odbg_pluginmainloop">ODBG_Pluginmainloop</h4>
<p>  继续来看ODBG_Pluginmainloop函数，如何断在插件中该函数入口呢，在这里我利用GetProcAddress返回值，先<code>bp Kernel32.GetProcAddress,[esp+8]==&quot;_ODBG_Pluginmainloop&quot;</code>，Ctrl+F9执行到返回，再单步一次即可跳出GetProcAddress函数到ollydbg函数中，此时eax为返回值为获取到的函数地址，因此bp eax可以断在ODBG_Pluginmainloop函数内，运行后程序果然断在其中：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>voidCallEverymainloop(DEBUG_EVENT <span style="color:#ec0000">*</span>debugevent)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>       <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>pluginnum;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>       {
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">if</span>(plugindata.ODBG_Pluginmainloop)
</span></span><span style="display:flex;"><span>              plugindata. ODBG_Pluginmainloop(debugevent);
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  继续跳出后发现即是主函数WinMain且处于消息循环代码中（如果使用IDA查看调用关系，会发现Suspendprocess和Injectcode函数中均调用了该函数。这里不做详解），分析后得到：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#ec0000">if</span>(procstatus <span style="color:#ec0000">!=</span> STAT_RUNNING)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>       CallEverymainloop(<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>       Sleep(<span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="odbg_pluginaction">ODBG_pluginaction</h4>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#5f5fff">CallEveryaction</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">int</span> resourceid,<span style="color:#5f5fff">void</span><span style="color:#ec0000">*</span>item)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        intpluginindex;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(resourceid<span style="color:#ec0000">&lt;</span> <span style="color:#008900">57344</span>)
</span></span><span style="display:flex;"><span>                 returnfalse;
</span></span><span style="display:flex;"><span>        pluginindex<span style="color:#ec0000">=</span>(resourceid<span style="color:#ec0000">-</span><span style="color:#008900">57344</span>)<span style="color:#ec0000">/</span><span style="color:#008900">64</span>;//由菜单资源id得到插件序号，和前面插件加载过程相对应
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(pluginindex<span style="color:#ec0000">&gt;=</span> pluginnum <span style="color:#ec0000">||</span> plugindata[pluginindex].ODBG_pluginaction<span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>                 returnfalse;
</span></span><span style="display:flex;"><span>        plugindata[pluginindex].ODBG_pluginaction(origin,resourceid<span style="color:#ec0000">-</span>pluginindex<span style="color:#ec0000">*</span><span style="color:#008900">64</span><span style="color:#ec0000">+</span><span style="color:#008900">57344</span>,item);
</span></span><span style="display:flex;"><span>       returntrue;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="odbg_pluginshortcut">ODBG_Pluginshortcut</h4>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>LRESULT <span style="color:#5f5fff">CALLBACKWndProc</span>(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        ......
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">switch</span>(message)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">……</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">caseWM_KEYDOWN</span>:
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">caseWM_SYSKEYDOWN</span>:
</span></span><span style="display:flex;"><span>                         <span style="color:#ec0000">return</span> CallEveryshortcut(PM_MAIN,GetKeyState(VK_CONTROL)<span style="color:#ec0000">&amp;</span><span style="color:#008900">0x8000</span>,
</span></span><span style="display:flex;"><span>message<span style="color:#ec0000">==</span>WM_SYSKEYDOWN,GetKeyState(VK_SHIFT)<span style="color:#ec0000">&amp;</span><span style="color:#008900">0x8000</span>,wParam,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>                         <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                 <span style="color:#ec0000">……</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ......
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">CallEveryshortcut</span>(<span style="color:#5f5fff">int</span> orgin,<span style="color:#5f5fff">bool</span> ctrl,<span style="color:#5f5fff">bool</span> alt,boolshift,<span style="color:#5f5fff">int</span> key,<span style="color:#5f5fff">void</span><span style="color:#ec0000">*</span> item)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(key <span style="color:#ec0000">==</span>VK_SHIFT <span style="color:#ec0000">||</span> key <span style="color:#ec0000">==</span> VK_CONTROL <span style="color:#ec0000">||</span> key <span style="color:#ec0000">==</span> VK_MENU)//单个键无效
</span></span><span style="display:flex;"><span>                 return0;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span>(intpluginindex<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;pluginindex<span style="color:#ec0000">&lt;</span>pluginnum;pluginindex<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>         <span style="color:#ec0000">if</span>(plugindata[pluginindex].ODBG_Pluginshortcut(origin,ctrl,alt,shift,key,item))
</span></span><span style="display:flex;"><span>                     return1;
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>       return0;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="第四章-ollydbg插件cheatutility逆向分析">第四章 OllyDbg插件CheatUtility逆向分析</h2>
<p>  该插件可以自由修改程序数据且在数据处下断点以捕获修改代码，活像OllyDbg的CheatEngine。含2个对话框，插件目录下可以看到作者特意做了个使用视频，确实是很有用的工具。文件大小11kb，用户代码部分3828b，译得500行c代码，关键反汇编代码如下：</p>
<h3 id="逆向">逆向</h3>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>#define IDC_BTFIRST 100//First Scan Button
</span></span><span style="display:flex;"><span>#define IDC_BTNEXT 101//Next Scan Button
</span></span><span style="display:flex;"><span>#define IDC_BTSTOP 102//Stop Button
</span></span><span style="display:flex;"><span>#define IDC_ETVAL 200//Value Edit
</span></span><span style="display:flex;"><span>#define IDM_CHANGE 500//Change Value
</span></span><span style="display:flex;"><span>#define IDM_FOLLOW 501//Follow in Dump
</span></span><span style="display:flex;"><span>#define IDM_HARDWARE 502//Hardware Breakpoint
</span></span><span style="display:flex;"><span>#define IDM_DELETE 503//Delete Button
</span></span><span style="display:flex;"><span>#define IDD_MAINDLG 1000//Main Dialog
</span></span><span style="display:flex;"><span>#define IDC_LVLIST 1001//Address ListView
</span></span><span style="display:flex;"><span>#define IDC_SBSTATU 1004//Bottom Statu Bar
</span></span><span style="display:flex;"><span>#define IDC_CBISHEX 1011//Is Hex Check Button
</span></span><span style="display:flex;"><span>#define IDC_RBDWORD 1014//DOUBLE WORD Radio
</span></span><span style="display:flex;"><span>#define IDC_RBWORD 1015//WORD Radio
</span></span><span style="display:flex;"><span>#define IDC_RBBYTE 1016//BYTE Radio
</span></span><span style="display:flex;"><span>#define IDD_SETDIALOG 1027//Set Dialog
</span></span><span style="display:flex;"><span>#define IDC_BTOK 1034//OK Button
</span></span><span style="display:flex;"><span>#define IDC_BTCANCEL 1035//Cancel Button
</span></span><span style="display:flex;"><span>#define IDC_ETNEWVALUE 1036//Change Value
</span></span><span style="display:flex;"><span>#define IDC_BTABOUT 1040//About Button
</span></span><span style="display:flex;"><span>#define IDC_BTAT4RE 1041//AT4RE Button
</span></span><span style="display:flex;"><span>#define IDC_BTEXIT 1042//Exit Button
</span></span><span style="display:flex;"><span>#define IDC_BTINC 1043//Inc Button
</span></span><span style="display:flex;"><span>#define IDC_BTDEC 1044//Dec Button
</span></span><span style="display:flex;"><span>#define IDC_BTRESET 1045//Reset Button
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>HWND hWnd;
</span></span><span style="display:flex;"><span>HANDLE hProcess;
</span></span><span style="display:flex;"><span>DWORD ThreadId;
</span></span><span style="display:flex;"><span>HINSTANCE hInstance;
</span></span><span style="display:flex;"><span>HMENU hMenu;
</span></span><span style="display:flex;"><span>HWND hListView;//查找内存地址结果列表
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> bpsize;//硬件断点大小
</span></span><span style="display:flex;"><span>PVOID<span style="color:#ec0000">*</span> BaseAddrArray;//内存区块基址数组，用于查找
</span></span><span style="display:flex;"><span>DWORD<span style="color:#ec0000">*</span> AddrSizeArray;//内存区块大小数组，用于查找
</span></span><span style="display:flex;"><span>BYTE<span style="color:#ec0000">**</span> ResultDataArray;//结果地址数组
</span></span><span style="display:flex;"><span>LPVOID ValueAddr;//要改写数据的地址
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">char</span> String[<span style="color:#008900">256</span>];//临时数组
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> IsHex,StopFind;//是否为16进制；是否停止搜索
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> ToSearch;//要搜索的数据
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#5f5fff">CreateMainDialog</span>(LPVOID lpParameter)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    InitCommonControls();
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> DialogBoxParam(hInstance,MAKEINTRESOURCE(IDD_MAINDLG),<span style="color:#ec0000">NULL</span>,MainDialogFunc,<span style="color:#008900">0</span>);//打开主窗口
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> WINAPI <span style="color:#5f5fff">ListViewAddItem</span>(DWORD addr,DWORD tosearch)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    LVITEM item;
</span></span><span style="display:flex;"><span>    item.mask<span style="color:#ec0000">=</span>LVIF_TEXT;
</span></span><span style="display:flex;"><span>    item.iItem<span style="color:#ec0000">=</span>SendMessage(hListView,LVM_GETITEMCOUNT,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);//获取当前项数目作为下次加入项的序号
</span></span><span style="display:flex;"><span>    item.iSubItem<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    RtlZeroMemory(String, <span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>    wsprintf(String,<span style="color:#008900">&#34;%.8X&#34;</span>,(DWORD)BaseAddrArray[i]<span style="color:#ec0000">+</span>j);
</span></span><span style="display:flex;"><span>    item.pszText<span style="color:#ec0000">=</span>String;
</span></span><span style="display:flex;"><span>    SendMessage(hListView,LVM_INSERTITEM,<span style="color:#008900">0</span>,(LPARAM)<span style="color:#ec0000">&amp;</span>item);//加入该项第一列地址
</span></span><span style="display:flex;"><span>    item.mask<span style="color:#ec0000">=</span>LVIF_TEXT;
</span></span><span style="display:flex;"><span>    item.iSubItem<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>    RtlZeroMemory(String, <span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>    wsprintf(String,<span style="color:#008900">&#34;%d&#34;</span>,ToSearch);
</span></span><span style="display:flex;"><span>    item.pszText<span style="color:#ec0000">=</span>String;
</span></span><span style="display:flex;"><span>    SendMessage(hListView,LVM_SETITEM,<span style="color:#008900">0</span>,(LPARAM)<span style="color:#ec0000">&amp;</span>item);//加入该项第二列数据
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#5f5fff">FindFirstThread</span>(LPVOID lpParameter)//首次查找所启动的线程
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    HWND hWnd<span style="color:#ec0000">=</span>(HWND)lpParameter;
</span></span><span style="display:flex;"><span>    RtlZeroMemory(String, <span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>    SendDlgItemMessage(hWnd,IDC_LVLIST,LVM_DELETEALLITEMS,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>    //获取输入框内目标整数
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(IsHex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        GetDlgItemText(hWnd,IDC_ETVAL,String,<span style="color:#008900">9</span>);
</span></span><span style="display:flex;"><span>        ToSearch<span style="color:#ec0000">=</span>GetAddressFromString(String);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        BOOL Translated;
</span></span><span style="display:flex;"><span>        ToSearch<span style="color:#ec0000">=</span>GetDlgItemInt(hWnd,IDC_ETVAL,<span style="color:#ec0000">&amp;</span>Translated,TRUE);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Translated)
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> MessageBox(hWnd,<span style="color:#008900">&#34;Error occurred &#34;</span>,<span style="color:#008900">&#34;Cheat Utility Plugin&#34;</span>,MB_TOPMOST<span style="color:#ec0000">|</span>MB_ICONHAND);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    //在各个内存区快中寻找目标数字
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;AddrSizeArray[i] <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>StopFind;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        RtlZeroMemory(ResultDataArray,<span style="color:#008900">0x1000000</span>);
</span></span><span style="display:flex;"><span>        RtlZeroMemory(String, <span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">int</span> itemcount<span style="color:#ec0000">=</span>SendDlgItemMessage(hWnd,IDC_LVLIST,LVM_GETITEMCOUNT,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>        wsprintf(String,<span style="color:#008900">&#34;Scanning : %.8X || %d item(s) found&#34;</span>,BaseAddrArray[i],itemcount);
</span></span><span style="display:flex;"><span>        SetDlgItemText(hWnd,IDC_SBSTATU,String);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">static</span> DWORD NumberOfBytesRead;
</span></span><span style="display:flex;"><span>        ReadProcessMemory(hProcess,BaseAddrArray[i],ResultDataArray,AddrSizeArray[i],<span style="color:#ec0000">&amp;</span>NumberOfBytesRead);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> j<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;j<span style="color:#ec0000">&lt;=</span>AddrSizeArray[i] <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>StopFind;j<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            DWORD data1<span style="color:#ec0000">=</span><span style="color:#008900">0</span>,data2<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(bpsize <span style="color:#ec0000">==</span> <span style="color:#008900">4</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                data1<span style="color:#ec0000">=</span>ToSearch;
</span></span><span style="display:flex;"><span>                data2<span style="color:#ec0000">=*</span>(DWORD<span style="color:#ec0000">*</span>)(ResultDataArray<span style="color:#ec0000">+</span>j);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(bpsize <span style="color:#ec0000">==</span> <span style="color:#008900">2</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                data1<span style="color:#ec0000">=</span>ToSearch;
</span></span><span style="display:flex;"><span>                data2<span style="color:#ec0000">=*</span>(WORD<span style="color:#ec0000">*</span>)(ResultDataArray<span style="color:#ec0000">+</span>j);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                data1<span style="color:#ec0000">=</span>ToSearch;
</span></span><span style="display:flex;"><span>                data2<span style="color:#ec0000">=*</span>(BYTE<span style="color:#ec0000">*</span>)(ResultDataArray<span style="color:#ec0000">+</span>j);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(data1 <span style="color:#ec0000">==</span> data2)
</span></span><span style="display:flex;"><span>                ListViewAddItem((DWORD)BaseAddrArray[i]<span style="color:#ec0000">+</span>j,ToSearch);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#5f5fff">FindNextThread</span>(LPVOID lpParameter)//再次搜索所启动的线程
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    RtlZeroMemory(ResultDataArray,<span style="color:#008900">0x1000000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(IsHex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        GetDlgItemText(hWnd,IDC_ETVAL,String,<span style="color:#008900">9</span>);
</span></span><span style="display:flex;"><span>        ToSearch<span style="color:#ec0000">=</span>GetAddressFromString(String);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        BOOL Translated;
</span></span><span style="display:flex;"><span>        ToSearch<span style="color:#ec0000">=</span>GetDlgItemInt(hWnd,IDC_ETVAL,<span style="color:#ec0000">&amp;</span>Translated,TRUE);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Translated)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            MessageBox(hWnd,<span style="color:#008900">&#34;Error occurred &#34;</span>,<span style="color:#008900">&#34;Cheat Utility Plugin&#34;</span>,MB_TOPMOST<span style="color:#ec0000">|</span>MB_ICONHAND);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> resultaddrcount<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> itemcount<span style="color:#ec0000">=</span>SendDlgItemMessage(hWnd,IDC_LVLIST,LVM_GETITEMCOUNT,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(itemcount <span style="color:#ec0000">&amp;&amp;</span> itemcount <span style="color:#ec0000">!=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">while</span>(<span style="color:#ec0000">!</span>StopFind <span style="color:#ec0000">&amp;&amp;</span> itemcount)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            itemcount<span style="color:#ec0000">--</span>;
</span></span><span style="display:flex;"><span>            ListViewGetItem(itemcount,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            ulong addr<span style="color:#ec0000">=</span>GetAddressFromString(String);
</span></span><span style="display:flex;"><span>            RtlZeroMemory(String, <span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>            wsprintf(String,<span style="color:#008900">&#34;Scanning : %.8X&#34;</span>,addr);
</span></span><span style="display:flex;"><span>            SetDlgItemText(hWnd,IDC_SBSTATU,String);
</span></span><span style="display:flex;"><span>            DWORD data;
</span></span><span style="display:flex;"><span>            ReadProcessMemory(hProcess,addr,<span style="color:#ec0000">&amp;</span>data,bpsize,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(data <span style="color:#ec0000">==</span> ToSearch)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                ResultDataArray[resultaddrcount]<span style="color:#ec0000">=</span>addr;
</span></span><span style="display:flex;"><span>                resultaddrcount<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(itemcount)
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        SetDlgItemText(hWnd,IDC_SBSTATU,<span style="color:#008900">&#34;Generating List ...&#34;</span>);
</span></span><span style="display:flex;"><span>        SendDlgItemMessage(hWnd,IDC_LVLIST,LVM_DELETEALLITEMS,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">while</span>(resultaddrcount<span style="color:#ec0000">--</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ListViewAddItem((DWORD)ResultDataArray[resultaddrcount],ToSearch);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    RtlZeroMemory(String, <span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>    itemcount<span style="color:#ec0000">=</span>SendDlgItemMessage(hWnd,IDC_LVLIST,LVM_GETITEMCOUNT,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>    wsprintf(String,<span style="color:#008900">&#34;%d item(s) found&#34;</span>,itemcount);
</span></span><span style="display:flex;"><span>    SetDlgItemText(hWnd,IDC_SBSTATU,String);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">void</span> cdecl <span style="color:#5f5fff">ODBG_Pluginaction</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">int</span> action,<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(origin <span style="color:#ec0000">!=</span> PM_MAIN)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(action <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        hProcess<span style="color:#ec0000">=</span>(HANDLE)Plugingetvalue(VAL_HPROCESS);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>hProcess)//未调试程序时不能打开窗口
</span></span><span style="display:flex;"><span>            MessageBox(hWnd,<span style="color:#008900">&#34;No Debugee loaded &#34;</span>,<span style="color:#008900">&#34;Cheat Utility Plugin&#34;</span>,MB_TOPMOST<span style="color:#ec0000">|</span>
</span></span><span style="display:flex;"><span>MB_ICONEXCLAMATION);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>            CreateThread(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,CreateMainDialog,<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>ThreadId);//这里其实也可以不用多线程
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(action <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>)//关于信息
</span></span><span style="display:flex;"><span>        MessageBox(hWnd,<span style="color:#008900">&#34;Cheat Utility Plugin v1.0</span><span style="color:#008900">\r\n</span><span style="color:#008900">Copyright (C) 2007 by GamingMasteR-AT4RE&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#008900">&#34;Cheat Utility Plugin&#34;</span>,MB_ICONASTERISK);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span> cdecl <span style="color:#5f5fff">ODBG_Plugindata</span>(<span style="color:#5f5fff">char</span> shortname[<span style="color:#008900">32</span>])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    lstrcpy(shortname,<span style="color:#008900">&#34;Cheat Utility&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">108</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span> cdecl <span style="color:#5f5fff">ODBG_Pluginmenu</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">char</span> data[<span style="color:#008900">4096</span>],<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(origin <span style="color:#ec0000">!=</span> PM_MAIN)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    lstrcpy(data,<span style="color:#008900">&#34;0 &amp;Start|1 &amp;About&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span> cdecl <span style="color:#5f5fff">ODBG_Plugininit</span>(<span style="color:#5f5fff">int</span> ollydbgversion,HWND hw,ulong <span style="color:#ec0000">*</span>features)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(ollydbgversion <span style="color:#ec0000">&lt;</span> <span style="color:#008900">108</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">&#34;Cheat Utility Plugin v1.0&#34;</span>);
</span></span><span style="display:flex;"><span>    hWnd<span style="color:#ec0000">=</span>hw;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> WINAPI <span style="color:#5f5fff">ListViewGetItem</span>(<span style="color:#5f5fff">int</span> iItem,<span style="color:#5f5fff">int</span> iSubItem)
</span></span><span style="display:flex;"><span>{//获取该项数据到String中
</span></span><span style="display:flex;"><span>    LVITEM itemdata;
</span></span><span style="display:flex;"><span>    itemdata.iItem<span style="color:#ec0000">=</span>iItem;
</span></span><span style="display:flex;"><span>    itemdata.iSubItem<span style="color:#ec0000">=</span>iSubItem;
</span></span><span style="display:flex;"><span>    itemdata.mask<span style="color:#ec0000">=</span>LVIF_TEXT;
</span></span><span style="display:flex;"><span>    itemdata.pszText<span style="color:#ec0000">=</span>String;
</span></span><span style="display:flex;"><span>    itemdata.cchTextMax<span style="color:#ec0000">=</span><span style="color:#008900">256</span>;
</span></span><span style="display:flex;"><span>    SendMessage(hListView,LVM_GETITEM,<span style="color:#008900">0</span>,(LPARAM)<span style="color:#ec0000">&amp;</span>itemdata);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>ulong <span style="color:#5f5fff">GetAddressFromString</span>(<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> str)
</span></span><span style="display:flex;"><span>{//作者秀了一下16进制字符串转整数的算法
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> len<span style="color:#ec0000">=</span>strlen(str);
</span></span><span style="display:flex;"><span>    ulong addr<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> x1,x2<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>len;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(str[i] <span style="color:#ec0000">&lt;</span> <span style="color:#008900">&#39;A&#39;</span>)//0-9
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            x1<span style="color:#ec0000">=</span>str[i]<span style="color:#ec0000">-</span><span style="color:#008900">&#39;0&#39;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>//A-F
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            x2<span style="color:#ec0000">=</span><span style="color:#008900">32</span><span style="color:#ec0000">*</span>((str[i]<span style="color:#ec0000">&lt;</span><span style="color:#008900">&#39;W&#39;</span>)<span style="color:#ec0000">+</span>x2);
</span></span><span style="display:flex;"><span>            x1<span style="color:#ec0000">=</span>x2<span style="color:#ec0000">+</span>str[i]<span style="color:#ec0000">-</span><span style="color:#008900">&#39;W&#39;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        addr <span style="color:#ec0000">+=</span> ((x1<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xF</span>)<span style="color:#ec0000">&lt;&lt;</span>(<span style="color:#008900">4</span><span style="color:#ec0000">*</span>i<span style="color:#ec0000">-</span><span style="color:#008900">1</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> addr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> WINAPI <span style="color:#5f5fff">SetDialogFunc</span>(HWND hwndDlg,UINT uMsg,WPARAM wParam,LPARAM lParam)
</span></span><span style="display:flex;"><span>{//更改数据窗口
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">switch</span> (uMsg)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_INITDIALOG</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_COMMAND</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(wParam <span style="color:#ec0000">==</span> IDC_BTOK)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ulong addr;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(IsHex)//如果为16进制数
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                GetDlgItemText(hwndDlg,IDC_ETNEWVALUE,String,<span style="color:#008900">9</span>);
</span></span><span style="display:flex;"><span>                addr<span style="color:#ec0000">=</span>GetAddressFromString(String);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                BOOL Translated;
</span></span><span style="display:flex;"><span>                addr<span style="color:#ec0000">=</span>GetDlgItemInt(hwndDlg,IDC_ETNEWVALUE,<span style="color:#ec0000">&amp;</span>Translated,TRUE);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Translated)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    MessageBox(hwndDlg,<span style="color:#008900">&#34;Error occurred &#34;</span>,<span style="color:#008900">&#34;Cheat Utility Plugin&#34;</span>,MB_TOPMOST<span style="color:#ec0000">|</span>MB_ICONHAND);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            WriteProcessMemory(hProcess,ValueAddr,<span style="color:#ec0000">&amp;</span>addr,bpsize,<span style="color:#ec0000">NULL</span>);//改写数据
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(wParam <span style="color:#ec0000">==</span> IDC_BTCANCEL)
</span></span><span style="display:flex;"><span>            EndDialog(hwndDlg,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_CLOSE</span>:
</span></span><span style="display:flex;"><span>        EndDialog(hwndDlg,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> WINAPI <span style="color:#5f5fff">SearchFreeMemoryBlock</span>(HANDLE hProcess)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    MEMORY_BASIC_INFORMATION meminfo;
</span></span><span style="display:flex;"><span>    RtlZeroMemory(String, <span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>    RtlZeroMemory(BaseAddrArray,<span style="color:#008900">0x1000000</span>);
</span></span><span style="display:flex;"><span>    RtlZeroMemory(AddrSizeArray,<span style="color:#008900">0x1000000</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">static</span> <span style="color:#5f5fff">int</span> blockindex<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0x00400000</span>;i<span style="color:#ec0000">&lt;</span><span style="color:#008900">0x70000000</span>;i<span style="color:#ec0000">+=</span>meminfo.RegionSize,blockindex<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {//exe基址一般是0x00400000，而0x80000000以上为系统领空
</span></span><span style="display:flex;"><span>        VirtualQueryEx(hProcess,i,<span style="color:#ec0000">&amp;</span>meminfo,<span style="color:#ec0000">sizeof</span>(MEMORY_BASIC_INFORMATION));
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(meminfo.Protect <span style="color:#ec0000">&amp;&amp;</span> meminfo.Protect <span style="color:#ec0000">!=</span> PAGE_NOACCESS <span style="color:#ec0000">&amp;&amp;</span> meminfo.Protect <span style="color:#ec0000">!=</span> PAGE_EXECUTE <span style="color:#ec0000">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            meminfo.Protect <span style="color:#ec0000">!=</span> PAGE_NOCACHE)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(meminfo.State <span style="color:#ec0000">!=</span> MEM_FREE <span style="color:#ec0000">&amp;&amp;</span> meminfo.Type <span style="color:#ec0000">!=</span> MEM_MAPPED)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                BaseAddrArray[blockindex]<span style="color:#ec0000">=</span>meminfo.BaseAddress;
</span></span><span style="display:flex;"><span>                AddrSizeArray[blockindex]<span style="color:#ec0000">=</span>meminfo.RegionSize;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span>  WINAPI <span style="color:#5f5fff">MainDialogFunc</span>(HWND hwndDlg,UINT uMsg,WPARAM wParam,LPARAM lParam)
</span></span><span style="display:flex;"><span>{//该回调将过程驱动编程转换为事件驱动编程
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">static</span> DWORD firstthreadid,nextthreadid;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">switch</span>(uMsg)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_INITDIALOG</span>:
</span></span><span style="display:flex;"><span>        hMenu<span style="color:#ec0000">=</span>CreatePopupMenu();
</span></span><span style="display:flex;"><span>        AppendMenu(hMenu,MF_ENABLED,IDM_FOLLOW,<span style="color:#008900">&#34;Follow in Dump&#34;</span>);
</span></span><span style="display:flex;"><span>        AppendMenu(hMenu,MF_ENABLED,IDM_HARDWARE,<span style="color:#008900">&#34;Hardware Breakpoint&#34;</span>);
</span></span><span style="display:flex;"><span>        AppendMenu(hMenu,MF_SEPARATOR,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>        AppendMenu(hMenu,MF_ENABLED,IDM_CHANGE,<span style="color:#008900">&#34;Change Value&#34;</span>);
</span></span><span style="display:flex;"><span>        AppendMenu(hMenu,MF_SEPARATOR,<span style="color:#008900">0</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>        AppendMenu(hMenu,MF_ENABLED,IDM_DELETE,<span style="color:#008900">&#34;Delete&#34;</span>);
</span></span><span style="display:flex;"><span>        //以下几行代码对列表框控件添加2列表头
</span></span><span style="display:flex;"><span>        hListView<span style="color:#ec0000">=</span>GetDlgItem(hwndDlg,<span style="color:#008900">1001</span>);
</span></span><span style="display:flex;"><span>        LVCOLUMN coldata;
</span></span><span style="display:flex;"><span>        coldata.mask<span style="color:#ec0000">=</span>LVCF_WIDTH<span style="color:#ec0000">|</span>LVCF_TEXT;
</span></span><span style="display:flex;"><span>        coldata.pszText<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Address&#34;</span>;
</span></span><span style="display:flex;"><span>        coldata.cx<span style="color:#ec0000">=</span><span style="color:#008900">100</span>;
</span></span><span style="display:flex;"><span>        SendMessage(hListView,LVM_INSERTCOLUMN,<span style="color:#008900">0</span>,(LPARAM)<span style="color:#ec0000">&amp;</span>coldata);
</span></span><span style="display:flex;"><span>        coldata.pszText<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Value&#34;</span>;
</span></span><span style="display:flex;"><span>        coldata.cx<span style="color:#ec0000">=</span><span style="color:#008900">100</span>;
</span></span><span style="display:flex;"><span>        SendMessage(hListView,LVM_INSERTCOLUMN,<span style="color:#008900">1</span>,(WPARAM)<span style="color:#ec0000">&amp;</span>coldata);
</span></span><span style="display:flex;"><span>        //默认数据（断点）为双字大小
</span></span><span style="display:flex;"><span>        CheckDlgButton(hwndDlg,IDC_RBDWORD,BST_CHECKED);
</span></span><span style="display:flex;"><span>        bpsize<span style="color:#ec0000">=</span><span style="color:#ec0000">sizeof</span>(DWORD);
</span></span><span style="display:flex;"><span>        BaseAddrArray<span style="color:#ec0000">=</span>(PVOID<span style="color:#ec0000">*</span>)VirtualAlloc(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0x1000000</span>,MEM_COMMIT,PAGE_READWRITE);
</span></span><span style="display:flex;"><span>        VirtualLock(BaseAddrArray,<span style="color:#008900">0x1000000</span>);
</span></span><span style="display:flex;"><span>        ResultDataArray<span style="color:#ec0000">=</span>(BYTE<span style="color:#ec0000">**</span>)VirtualAlloc(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0x1000000</span>,MEM_COMMIT,PAGE_READWRITE);
</span></span><span style="display:flex;"><span>        VirtualLock(ResultDataArray,<span style="color:#008900">0x1000000</span>);
</span></span><span style="display:flex;"><span>        AddrSizeArray<span style="color:#ec0000">=</span>(DWORD<span style="color:#ec0000">*</span>)VirtualAlloc(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0x1000000</span>,MEM_COMMIT,PAGE_READWRITE);
</span></span><span style="display:flex;"><span>        VirtualLock(AddrSizeArray,<span style="color:#008900">0x1000000</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_COMMAND</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(lParam <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)//选中菜单
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">switch</span>(LOWORD(wParam))
</span></span><span style="display:flex;"><span>            {//IDM_*
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDM_FOLLOW</span>://跟随该地址
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#5f5fff">int</span> index<span style="color:#ec0000">=</span>SendDlgItemMessage(hwndDlg,IDC_LVLIST,LVM_GETNEXTITEM,
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">-</span><span style="color:#008900">1</span>,LVNI_FOCUSED);//找到第一个选中项
</span></span><span style="display:flex;"><span>                    //这里处理的不好，居然是通过消息获取字符串再转换成地址，还不如事先存在数据结构中
</span></span><span style="display:flex;"><span>                    ListViewGetItem(index,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                    Setcpu(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,GetAddressFromString(String),<span style="color:#008900">0</span>,CPU_DUMPFIRST<span style="color:#ec0000">|</span>CPU_DUMPFOCUS);
</span></span><span style="display:flex;"><span>                    RtlZeroMemory(String,<span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDM_HARDWARE</span>://在该地址处下硬件断点
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#5f5fff">int</span> index<span style="color:#ec0000">=</span>SendDlgItemMessage(hwndDlg,IDC_LVLIST,LVM_GETNEXTITEM,
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">-</span><span style="color:#008900">1</span>,LVNI_FOCUSED);//找到第一个选中项
</span></span><span style="display:flex;"><span>                    ListViewGetItem(index,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                    Sethardwarebreakpoint(GetAddressFromString(String),bpsize,HB_ACCESS);
</span></span><span style="display:flex;"><span>                    RtlZeroMemory(String,<span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDM_CHANGE</span>://修改该地址数据
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#5f5fff">int</span> index<span style="color:#ec0000">=</span>SendDlgItemMessage(hwndDlg,IDC_LVLIST,LVM_GETNEXTITEM,
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">-</span><span style="color:#008900">1</span>,LVNI_FOCUSED);//找到第一个选中项
</span></span><span style="display:flex;"><span>                    ListViewGetItem(index,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                    ValueAddr<span style="color:#ec0000">=</span>(LPVOID)GetAddressFromString(String);
</span></span><span style="display:flex;"><span>                    RtlZeroMemory(String,<span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>                    DialogBoxParam(hInstance,MAKEINTRESOURCE(IDD_SETDIALOG),hwndDlg,
</span></span><span style="display:flex;"><span>SetDialogFunc,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDM_DELETE</span>://删除该结果项
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#5f5fff">int</span> index<span style="color:#ec0000">=</span>SendDlgItemMessage(hwndDlg,IDC_LVLIST,LVM_GETNEXTITEM,
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">-</span><span style="color:#008900">1</span>,LVNI_FOCUSED);//找到第一个选中项
</span></span><span style="display:flex;"><span>                    SendDlgItemMessage(hwndDlg,IDC_LVLIST,LVM_DELETEITEM,index,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">switch</span>(wParam)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTFIRST</span>://首次查找
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(IsDlgButtonChecked(hwndDlg,IDC_RBBYTE))
</span></span><span style="display:flex;"><span>                bpsize<span style="color:#ec0000">=</span><span style="color:#ec0000">sizeof</span>(BYTE);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(IsDlgButtonChecked(hwndDlg,IDC_RBWORD))
</span></span><span style="display:flex;"><span>                bpsize<span style="color:#ec0000">=</span><span style="color:#ec0000">sizeof</span>(WORD);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                bpsize<span style="color:#ec0000">=</span><span style="color:#ec0000">sizeof</span>(DWORD);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(IsDlgButtonChecked(hwndDlg,IDC_CBISHEX))
</span></span><span style="display:flex;"><span>                IsHex<span style="color:#ec0000">=</span><span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                IsHex<span style="color:#ec0000">=</span><span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>            StopFind<span style="color:#ec0000">=</span><span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>            SearchFreeMemoryBlock(hProcess);
</span></span><span style="display:flex;"><span>            CreateThread(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,FindFirstThread,hwndDlg,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>firstthreadid);//这里应该存储句柄以待后用
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTNEXT</span>://再次查找
</span></span><span style="display:flex;"><span>            StopFind<span style="color:#ec0000">=</span><span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>            CreateThread(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">0</span>,FindNextThread,hwndDlg,<span style="color:#008900">0</span>,<span style="color:#ec0000">&amp;</span>nextthreadid);//这里应该存储句柄以待后用
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTSTOP</span>://停止查找
</span></span><span style="display:flex;"><span>            StopFind<span style="color:#ec0000">=</span><span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTINC</span>://自增数据
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                ulong addr;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(IsHex)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    GetDlgItemText(hwndDlg,IDC_ETNEWVALUE,String,<span style="color:#008900">9</span>);//这句有误，控件ID作者搞错了
</span></span><span style="display:flex;"><span>                    addr<span style="color:#ec0000">=</span>GetAddressFromString(String);
</span></span><span style="display:flex;"><span>                    RtlZeroMemory(String, <span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>                    wsprintf(String,<span style="color:#008900">&#34;%.8X&#34;</span>,addr<span style="color:#ec0000">+</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>                    SetDlgItemText(hwndDlg,IDC_ETVAL,String);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    BOOL Translated;
</span></span><span style="display:flex;"><span>                    addr<span style="color:#ec0000">=</span>GetDlgItemInt(hwndDlg,IDC_ETVAL,<span style="color:#ec0000">&amp;</span>Translated,TRUE);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Translated)
</span></span><span style="display:flex;"><span>                        MessageBox(hwndDlg,<span style="color:#008900">&#34;Error occurred &#34;</span>,<span style="color:#008900">&#34;Cheat Utility Plugin&#34;</span>,MB_TOPMOST<span style="color:#ec0000">|</span>
</span></span><span style="display:flex;"><span>MB_ICONHAND);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                        SetDlgItemInt(hwndDlg,IDC_ETVAL,addr<span style="color:#ec0000">+</span><span style="color:#008900">1</span>,TRUE);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTDEC</span>://自减数据
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                ulong addr;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(IsHex)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    GetDlgItemText(hwndDlg,IDC_ETNEWVALUE,String,<span style="color:#008900">9</span>);//这句有误，该控件不在主窗口中
</span></span><span style="display:flex;"><span>                    addr<span style="color:#ec0000">=</span>GetAddressFromString(String);
</span></span><span style="display:flex;"><span>                    RtlZeroMemory(String, <span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>                    wsprintf(String,<span style="color:#008900">&#34;%.8X&#34;</span>,addr<span style="color:#ec0000">-</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>                    SetDlgItemText(hwndDlg,IDC_ETVAL,String);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    BOOL Translated;
</span></span><span style="display:flex;"><span>                    addr<span style="color:#ec0000">=</span>GetDlgItemInt(hwndDlg,IDC_ETVAL,<span style="color:#ec0000">&amp;</span>Translated,TRUE);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Translated)
</span></span><span style="display:flex;"><span>                        MessageBox(hwndDlg,<span style="color:#008900">&#34;Error occurred &#34;</span>,<span style="color:#008900">&#34;Cheat Utility Plugin&#34;</span>,MB_TOPMOST<span style="color:#ec0000">|</span>
</span></span><span style="display:flex;"><span>MB_ICONHAND);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                        SetDlgItemInt(hwndDlg,IDC_ETVAL,addr<span style="color:#ec0000">-</span><span style="color:#008900">1</span>,TRUE);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTRESET</span>://重新初始化数据
</span></span><span style="display:flex;"><span>            CheckDlgButton(hwndDlg,IDC_RBDWORD,BST_CHECKED);
</span></span><span style="display:flex;"><span>            CheckDlgButton(hwndDlg,IDC_CBISHEX,BST_UNCHECKED);
</span></span><span style="display:flex;"><span>            SetDlgItemInt(hwndDlg,IDC_ETVAL,<span style="color:#008900">0</span>,TRUE);
</span></span><span style="display:flex;"><span>            SendDlgItemMessage(hwndDlg,IDC_LVLIST,LVM_DELETEALLITEMS,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            bpsize<span style="color:#ec0000">=</span><span style="color:#ec0000">sizeof</span>(DWORD);
</span></span><span style="display:flex;"><span>            IsHex<span style="color:#ec0000">=</span><span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>            RtlZeroMemory(BaseAddrArray,<span style="color:#008900">0x1000000</span>);
</span></span><span style="display:flex;"><span>            RtlZeroMemory(ResultDataArray,<span style="color:#008900">0x1000000</span>);
</span></span><span style="display:flex;"><span>            RtlZeroMemory(String,<span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTABOUT</span>:
</span></span><span style="display:flex;"><span>            MessageBox(hWnd,<span style="color:#008900">&#34;Cheat Utility Plugin v1.0</span><span style="color:#008900">\r\n</span><span style="color:#008900">Copyright (C) 2007 by GamingMasteR-AT4RE&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#008900">&#34;Cheat Utility Plugin&#34;</span>,MB_ICONASTERISK);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTAT4RE</span>:
</span></span><span style="display:flex;"><span>            ShellExecute(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">&#34;Open&#34;</span>,<span style="color:#008900">&#34;http://www.at4re.com/&#34;</span>,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>,SW_MAXIMIZE);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTEXIT</span>:
</span></span><span style="display:flex;"><span>            SendMessage(hwndDlg,WM_CLOSE,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_NOTIFY</span>:
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            NMHDR<span style="color:#ec0000">*</span> nmhdr<span style="color:#ec0000">=</span>(NMHDR<span style="color:#ec0000">*</span>)lParam;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(nmhdr<span style="color:#ec0000">-&gt;</span>hwndFrom <span style="color:#ec0000">==</span> hListView)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(nmhdr<span style="color:#ec0000">-&gt;</span>code <span style="color:#ec0000">==</span> NM_DBLCLK)//双击项目则打开修改数据对话框
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#5f5fff">int</span> index<span style="color:#ec0000">=</span>SendDlgItemMessage(hwndDlg,IDC_LVLIST,LVM_GETNEXTITEM,
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">-</span><span style="color:#008900">1</span>,LVNI_FOCUSED);//找到第一个选中项
</span></span><span style="display:flex;"><span>                    ListViewGetItem(index,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                    ValueAddr<span style="color:#ec0000">=</span>(LPVOID)GetAddressFromString(String);
</span></span><span style="display:flex;"><span>                    RtlZeroMemory(String, <span style="color:#008900">256</span>);
</span></span><span style="display:flex;"><span>                    DialogBoxParam(hInstance,MAKEINTRESOURCE(IDD_SETDIALOG),hwndDlg,SetDialogFunc,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(nmhdr<span style="color:#ec0000">-&gt;</span>code <span style="color:#ec0000">==</span> NM_RCLICK)//右击项目
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">static</span> POINT Point;
</span></span><span style="display:flex;"><span>                    GetCursorPos(<span style="color:#ec0000">&amp;</span>Point);
</span></span><span style="display:flex;"><span>                    TrackPopupMenu(hMenu,TPM_LEFTALIGN<span style="color:#ec0000">|</span>TPM_TOPALIGN<span style="color:#ec0000">|</span>TPM_LEFTBUTTON,
</span></span><span style="display:flex;"><span>Point.x,Point.y,<span style="color:#008900">0</span>,hwndDlg,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_CLOSE</span>:
</span></span><span style="display:flex;"><span>        CloseHandle(firstthreadid);//错误用法
</span></span><span style="display:flex;"><span>        VirtualFree(ResultDataArray,<span style="color:#008900">0x1000000</span>,MEM_DECOMMIT);
</span></span><span style="display:flex;"><span>        VirtualFree(BaseAddrArray,<span style="color:#008900">0x1000000</span>,MEM_DECOMMIT);
</span></span><span style="display:flex;"><span>        VirtualFree(AddrSizeArray,<span style="color:#008900">0x1000000</span>,MEM_DECOMMIT);
</span></span><span style="display:flex;"><span>        EndDialog(hwndDlg,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="总结">总结</h3>
<p>  插件确实有用类似于CheatEngine修改数据，鉴于CheatEngine开源，有时间我会加以完善，同时在逆向过程中也发现了一些不足之处，如下：</p>
<ul>
<li>1.只支持整数</li>
<li>2.有些逻辑不够全面，例如IsHex选中的处理</li>
<li>3.我逆向的结果证明作者源码中存在一些小错误，例如Inc/Dec按钮消息和WM_CLOSE消息处理</li>
<li>4.16进制转换代码是有函数库可以完成，且更完善易用</li>
<li>5.某些数据应通过数据结构存储，而不是通过API函数发送消息再获得，这样效率低</li>
</ul>
<h2 id="第五章-ollydbg去除花指令插件dejunk源码分析">第五章 OllyDbg去除花指令插件DeJunk源码分析</h2>
<p>  该插件为花指令自动去除插件。经多人完善，最初作者为ljtt，本版为flyfancy根据hoto制作的dejunk插件修改而来。文件大小29kb，代码段占4.8kb，逆向代码大约500行。我也是通过逆向分析才第一次了解到花指令是什么以及如何去除花指令。先做个简要介绍：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#ec0000">+</span><span style="color:#008900">0</span> ;        jo        label
</span></span><span style="display:flex;"><span><span style="color:#ec0000">+</span><span style="color:#008900">2</span> ;        jno        label
</span></span><span style="display:flex;"><span><span style="color:#ec0000">+</span><span style="color:#008900">4</span> ;        db        _junkcode
</span></span><span style="display:flex;"><span><span style="color:#ec0000">+</span><span style="color:#008900">5</span> ;<span style="color:#ec0000">label</span>:        ....
</span></span><span style="display:flex;"><span>;                ....
</span></span></code></pre></div><p>  上面的汇编代码，左边序号暗示了指令所占字节数，jo和jno都调到+5处，因此，前5字节是无效的，相当于直接执行+5处代码，而这5字节就是为了迷惑反汇编器而构造的汇编指令，常见的修改方法是把前5字节都用nop指令代替即可。该例比较简单，然而如果作者精心构造的复杂花指令可以很复杂，很大程度提升反汇编分析时间。</p>
<h3 id="逆向-1">逆向</h3>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>#include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;commctrl.h&gt;
</span></span><span style="display:flex;"><span>#include &#34;Plugin.h&#34;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>#define IDC_BTClOSE 8//Close按钮
</span></span><span style="display:flex;"><span>#define IDD_MAINDLG 101//主对话框
</span></span><span style="display:flex;"><span>#define IDC_BTSTART 1000//Start按钮
</span></span><span style="display:flex;"><span>#define IDC_ETSTARTADDR 1001//Start Addr编辑框
</span></span><span style="display:flex;"><span>#define IDC_ETRANG 1002//Rang编辑框
</span></span><span style="display:flex;"><span>#define IDC_CBDIRECTION 1003 //Direction选择框
</span></span><span style="display:flex;"><span>#define IDC_SBSTATU 1004//状态栏
</span></span><span style="display:flex;"><span>#define IDC_CBJUNKTYPE 1005//Junk Type选择框
</span></span><span style="display:flex;"><span>#define IDC_BTE 1006//E按钮
</span></span><span style="display:flex;"><span>HINSTANCE hInstance;
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">char</span> JunkdbcfgPath[<span style="color:#008900">260</span>],DeJunkLogPath[<span style="color:#008900">260</span>],String2[<span style="color:#008900">260</span>];
</span></span><span style="display:flex;"><span>HWND hOllyWnd;//OllyDbg窗口句柄
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">char</span> classname[<span style="color:#008900">32</span>];//插件主窗口类名
</span></span><span style="display:flex;"><span>HWND hStartAddr,hRang,hDirection,hJunkType,hStart,hClose,hE;//和资源对应
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">char</span> String1[<span style="color:#008900">9</span>];//临时存储
</span></span><span style="display:flex;"><span>ulong JunkStartAddr,JunkRange;
</span></span><span style="display:flex;"><span>ulong JunkCodeNum;
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> IsDefaultType;
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> IsMallocSuccess;//是否成功分配了空间
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span><span style="color:#ec0000">*</span> JunkUndoData<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">*</span>JunkData<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>HANDLE hLogFile;
</span></span><span style="display:flex;"><span>BOOL WINAPI <span style="color:#5f5fff">DllMain</span>(HINSTANCE hinstDLL,DWORD fdwReason,LPVOID lpvvReserved)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(fdwReason <span style="color:#ec0000">==</span> DLL_PROCESS_ATTACH)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        hInstance<span style="color:#ec0000">=</span>hinstDLL;
</span></span><span style="display:flex;"><span>        GetModuleFileName(hinstDLL,,<span style="color:#008900">260</span>);
</span></span><span style="display:flex;"><span>        strrchr(JunkdbcfgPath,<span style="color:#008900">&#39;\\&#39;</span>)[<span style="color:#008900">1</span>]<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;//便于连接成文件路径
</span></span><span style="display:flex;"><span>        strcpy(DeJunkLogPath,JunkdbcfgPath);
</span></span><span style="display:flex;"><span>        strcat(JunkdbcfgPath,<span style="color:#008900">&#34;Junkdb.cfg&#34;</span>);
</span></span><span style="display:flex;"><span>        strcat(DeJunkLogPath,<span style="color:#008900">&#34;DeJunk.Log&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>LRESULT WINAPI <span style="color:#5f5fff">MainProc</span>(HWND hWnd,UINT uMsg,WPARAM wParam,LPARAM lParam)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">switch</span> (uMsg)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_DESTROY</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_SETFOCUS</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_PAINT</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> DefWindowProc(hWnd,uMsg,wParam,lParam);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>BOOL <span style="color:#5f5fff">IsInputValid</span>(HWND hDlg,<span style="color:#5f5fff">int</span> nID)
</span></span><span style="display:flex;"><span>{//检测输入值是否为合法16进制数
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> len<span style="color:#ec0000">=</span>SendDlgItemMessage(hDlg,nID,WM_GETTEXTLENGTH,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>    GetDlgItemText(hDlg,nID,String1,<span style="color:#008900">9</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>len;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>isxdigit(String1[i]))
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>ulong <span style="color:#5f5fff">GetNumberFromString</span>(<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> str)
</span></span><span style="display:flex;"><span>{//和上一个插件例子是同一个函数，将字符串转16进制数，可见是一个作者
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> len<span style="color:#ec0000">=</span>strlen(str);
</span></span><span style="display:flex;"><span>    ulong addr<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> x1,x2<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>len;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(str[i] <span style="color:#ec0000">&lt;</span> <span style="color:#008900">&#39;A&#39;</span>)//0-9
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            x1<span style="color:#ec0000">=</span>str[i]<span style="color:#ec0000">-</span><span style="color:#008900">&#39;0&#39;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>//A-F
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            x2<span style="color:#ec0000">=</span><span style="color:#008900">32</span><span style="color:#ec0000">*</span>((str[i]<span style="color:#ec0000">&lt;</span><span style="color:#008900">&#39;W&#39;</span>)<span style="color:#ec0000">+</span>x2);
</span></span><span style="display:flex;"><span>            x1<span style="color:#ec0000">=</span>x2<span style="color:#ec0000">+</span>str[i]<span style="color:#ec0000">-</span><span style="color:#008900">&#39;W&#39;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        addr <span style="color:#ec0000">+=</span> ((x1<span style="color:#ec0000">&amp;</span><span style="color:#008900">0xF</span>)<span style="color:#ec0000">&lt;&lt;</span>(<span style="color:#008900">4</span><span style="color:#ec0000">*</span>i<span style="color:#ec0000">-</span><span style="color:#008900">1</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> addr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>/*---------Junkdb.cfg-----------
</span></span><span style="display:flex;"><span>    ; default value
</span></span><span style="display:flex;"><span>    DefaultRang=01000
</span></span><span style="display:flex;"><span>    DefaultType=Custom
</span></span><span style="display:flex;"><span>    EnableLog=1
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    ;set JunkType combol list
</span></span><span style="display:flex;"><span>    JunkType=Common,TELock,UltraProtect,Custom
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">InitComboBox</span>(HWND hWnd)
</span></span><span style="display:flex;"><span>{//从配置文件读取类型，并添加到花指令类型列表框
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> JunkTypeStr[<span style="color:#008900">260</span>],content[<span style="color:#008900">260</span>];
</span></span><span style="display:flex;"><span>    memset(JunkTypeStr,<span style="color:#008900">0</span>,<span style="color:#008900">260</span>);
</span></span><span style="display:flex;"><span>    GetPrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;JunkType&#34;</span>,<span style="color:#ec0000">NULL</span>,JunkTypeStr,<span style="color:#008900">260</span>,JunkdbcfgPath);
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> ptr<span style="color:#ec0000">=</span>JunkTypeStr;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">while</span>(ptr[<span style="color:#008900">0</span>] <span style="color:#ec0000">!=</span> <span style="color:#008900">&#39;\0&#39;</span>)
</span></span><span style="display:flex;"><span>    {//拆分字符串 string1,string2,string3,...
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> pos1<span style="color:#ec0000">=</span>strchr(ptr,<span style="color:#008900">&#39;,&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(pos1)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">*</span>pos1<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>            strcpy(content,ptr);
</span></span><span style="display:flex;"><span>            ptr<span style="color:#ec0000">=</span>pos1<span style="color:#ec0000">+</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>            strcpy(content,ptr);
</span></span><span style="display:flex;"><span>        SendDlgItemMessage(hWnd,IDC_CBJUNKTYPE,CB_ADDSTRING,<span style="color:#008900">0</span>,(LPARAM)content);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>pos1)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            SendDlgItemMessage(hWnd,IDC_CBJUNKTYPE,CB_SETCURSEL,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>GetPrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;DefaultRang&#34;</span>,<span style="color:#ec0000">NULL</span>,String1,<span style="color:#008900">6</span>,JunkdbcfgPath))
</span></span><span style="display:flex;"><span>        wsprintf(String1,<span style="color:#008900">&#34;%05lX&#34;</span>,<span style="color:#008900">4096</span>);//默认搜索区块大小
</span></span><span style="display:flex;"><span>    SetDlgItemText(hWnd,IDC_ETRANG,String1);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>GetPrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;DefaultType&#34;</span>,<span style="color:#ec0000">NULL</span>,String2,<span style="color:#008900">260</span>,JunkdbcfgPath))
</span></span><span style="display:flex;"><span>        SendDlgItemMessage(hWnd,IDC_CBJUNKTYPE,CB_SETCURSEL,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>        SendDlgItemMessage(hWnd,IDC_CBJUNKTYPE,CB_SELECTSTRING,<span style="color:#008900">0</span>,(LPARAM)String2);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">Transform</span>(uchar<span style="color:#ec0000">*</span> Dest,<span style="color:#ec0000">const</span> <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> Source,<span style="color:#5f5fff">int</span> len)
</span></span><span style="display:flex;"><span>{//16进制字符串按2位转换成字节码数据
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> d[<span style="color:#008900">3</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> curnum;
</span></span><span style="display:flex;"><span>    memset(Dest,<span style="color:#008900">0</span>,<span style="color:#008900">260</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(len <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">do</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        strncpy(d,Source,<span style="color:#008900">2</span>);
</span></span><span style="display:flex;"><span>        d[<span style="color:#008900">2</span>]<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>        Source<span style="color:#ec0000">+=</span><span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>        curnum<span style="color:#ec0000">=</span>GetNumberFromString(d);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(d[<span style="color:#008900">0</span>] <span style="color:#ec0000">==</span> <span style="color:#008900">&#39;?&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">*</span>Dest<span style="color:#ec0000">=</span><span style="color:#008900">0x90</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">*</span>Dest<span style="color:#ec0000">=</span>curnum;
</span></span><span style="display:flex;"><span>        Dest<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">while</span> (<span style="color:#ec0000">--</span>len);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">FindMatch</span>(uchar<span style="color:#ec0000">*</span> data,BYTE<span style="color:#ec0000">*</span> S,BYTE<span style="color:#ec0000">*</span> R,<span style="color:#5f5fff">int</span> len,<span style="color:#5f5fff">int</span> Range)
</span></span><span style="display:flex;"><span>{//查找目的范围内匹配的花指令，本程序核心算法之所在
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> buf[<span style="color:#008900">260</span>];
</span></span><span style="display:flex;"><span>    DWORD writenum;
</span></span><span style="display:flex;"><span>    uchar<span style="color:#ec0000">*</span> ptr<span style="color:#ec0000">=</span>data;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> i,j;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">while</span>(<span style="color:#ec0000">true</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        i<span style="color:#ec0000">=</span>ptr<span style="color:#ec0000">-</span>data;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(S[<span style="color:#008900">0</span>] <span style="color:#ec0000">!=</span> <span style="color:#008900">0x90</span>)
</span></span><span style="display:flex;"><span>            ptr<span style="color:#ec0000">=</span>(uchar<span style="color:#ec0000">*</span>)memchr(ptr,S[<span style="color:#008900">0</span>],Range<span style="color:#ec0000">-</span>i);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>ptr <span style="color:#ec0000">||</span> Range<span style="color:#ec0000">-</span>i<span style="color:#ec0000">&lt;</span>len)//找不到花指令
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span>(j<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;j<span style="color:#ec0000">&lt;</span>len;j<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(S[j] <span style="color:#ec0000">!=</span> ptr[j] <span style="color:#ec0000">&amp;&amp;</span> S[j] <span style="color:#ec0000">!=</span> <span style="color:#008900">0x90</span>)
</span></span><span style="display:flex;"><span>            {//原S串的&#39;?&#39;代表任意1个16进制数，经过Transform函数处理成0x90，因此如果遇到S串为0x90，则为统配符，直接跳过，否则要进行对比
</span></span><span style="display:flex;"><span>                ptr<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(j <span style="color:#ec0000">==</span> len<span style="color:#ec0000">-</span><span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>        {//长度匹配因此找到一个花指令
</span></span><span style="display:flex;"><span>            memcpy(ptr,R,len);//写入对应的R串以去除花指令并能正常运行
</span></span><span style="display:flex;"><span>            wsprintf(buf,<span style="color:#008900">&#34;</span><span style="color:#008900">\t</span><span style="color:#008900">0x%08lX</span><span style="color:#008900">\r\n</span><span style="color:#008900">&#34;</span>,JunkStartAddr<span style="color:#ec0000">+</span>i);
</span></span><span style="display:flex;"><span>            WriteFile(hLogFile,buf,strlen(buf),<span style="color:#ec0000">&amp;</span>writenum,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>            ptr <span style="color:#ec0000">+=</span> len;
</span></span><span style="display:flex;"><span>            JunkCodeNum<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">FindJunk</span>(HWND hWnd,ulong StartAddr,ulong Range)
</span></span><span style="display:flex;"><span>{//查找花指令
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> buf[<span style="color:#008900">260</span>];
</span></span><span style="display:flex;"><span>    DWORD writenum;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">static</span> SYSTEMTIME SystemTime;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> PrePatStr[<span style="color:#008900">512</span>],JunkTypeStr[<span style="color:#008900">512</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> SearchType[<span style="color:#008900">260</span>],JunkTypeName[<span style="color:#008900">260</span>],SectionName[<span style="color:#008900">260</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> Slen,Rlen;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> Soriserial[<span style="color:#008900">512</span>],Roriserial[<span style="color:#008900">512</span>];
</span></span><span style="display:flex;"><span>    uchar Snewserial[<span style="color:#008900">260</span>],Rnewserial[<span style="color:#008900">260</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(Range <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        MessageBox(hWnd,<span style="color:#008900">&#34;Please give deJunk rang!&#34;</span>,<span style="color:#008900">&#34;Warning&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONEXCLAMATION);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    hLogFile<span style="color:#ec0000">=</span>CreateFile(DeJunkLogPath,GENERIC_READ<span style="color:#ec0000">|</span>GENERIC_WRITE,FILE_SHARE_READ<span style="color:#ec0000">|</span>FILE_SHARE_WRITE,
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">NULL</span>,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>    JunkData<span style="color:#ec0000">=</span>malloc(Range);
</span></span><span style="display:flex;"><span>    JunkCodeNum<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>JunkData)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        MessageBox(hWnd,<span style="color:#008900">&#34;Can&#39;t allocates memory blocks!&#34;</span>,<span style="color:#008900">&#34;Warning&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONEXCLAMATION);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Readmemory(JunkData,StartAddr,Range,MM_SILENT))//读取程序目标地址字节码
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        DWORD writenum;
</span></span><span style="display:flex;"><span>        MessageBox(hWnd,<span style="color:#008900">&#34;Can&#39;t read the memory space!&#34;</span>,<span style="color:#008900">&#34;Warning&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONEXCLAMATION);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">goto</span> RET;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(IsDefaultType)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        GetPrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;DefaultType&#34;</span>,<span style="color:#008900">0</span>,SearchType,<span style="color:#008900">260</span>,JunkdbcfgPath);
</span></span><span style="display:flex;"><span>        IsDefaultType<span style="color:#ec0000">=</span><span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">int</span> index<span style="color:#ec0000">=</span>SendDlgItemMessage(hWnd,IDC_CBJUNKTYPE,CB_GETCURSEL,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>        SendDlgItemMessage(hWnd,IDC_CBJUNKTYPE,CB_GETLBTEXT,index,(LPARAM)SearchType);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    strcpy(JunkTypeName,<span style="color:#008900">&#34;PatList_&#34;</span>);
</span></span><span style="display:flex;"><span>    strcat(JunkTypeName,SearchType);
</span></span><span style="display:flex;"><span>    GetLocalTime(<span style="color:#ec0000">&amp;</span>SystemTime);
</span></span><span style="display:flex;"><span>    wsprintf(buf,<span style="color:#008900">&#34;[-= DeJunk Last Log =-]</span><span style="color:#008900">\r\n\r\n</span><span style="color:#008900">Log Time: %04d-%02d-%02d  %02d:%02d:%02d</span><span style="color:#008900">\r\n\r\n</span><span style="color:#008900">Search Address:</span><span style="color:#008900">\r\n</span><span style="color:#008900">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#008900">&#34;</span><span style="color:#008900">\t</span><span style="color:#008900">0x%08lX ~ 0x%08lX</span><span style="color:#008900">\r\n\r\n</span><span style="color:#008900">Search Type:</span><span style="color:#008900">\r\n\t</span><span style="color:#008900">%s</span><span style="color:#008900">\r\n\r\n</span><span style="color:#008900">Find junk code in:</span><span style="color:#008900">\r\n</span><span style="color:#008900">&#34;</span>,SystemTime.wYear,SystemTime.wMonth,
</span></span><span style="display:flex;"><span>        SystemTime.wDay,SystemTime.wHour,SystemTime.wMinute,SystemTime.wSecond,JunkStartAddr,
</span></span><span style="display:flex;"><span>        JunkStartAddr<span style="color:#ec0000">+</span>JunkRange,SearchType);
</span></span><span style="display:flex;"><span>    WriteFile(hLogFile,buf,strlen(buf),<span style="color:#ec0000">&amp;</span>writenum,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>    GetPrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;PrePatName&#34;</span>,<span style="color:#ec0000">NULL</span>,PrePatStr,<span style="color:#008900">512</span>,JunkdbcfgPath);
</span></span><span style="display:flex;"><span>    GetPrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,JunkTypeName,<span style="color:#ec0000">NULL</span>,JunkTypeStr,<span style="color:#008900">512</span>,JunkdbcfgPath);
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> ptr<span style="color:#ec0000">=</span>JunkTypeStr,<span style="color:#ec0000">*</span>pos1<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">while</span>(pos1 <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>ptr)
</span></span><span style="display:flex;"><span>    {//对该模式下所有花指令类型，作如下操作
</span></span><span style="display:flex;"><span>/*      模式列表几对应花指令集合：
</span></span><span style="display:flex;"><span>    ---------Junkdb.cfg-----------
</span></span><span style="display:flex;"><span>    PatList_Common=_T1,_T2,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22
</span></span><span style="display:flex;"><span>    PatList_TELock=_jmp02,_jnz01,_jmp01,_telock_call02_1,_telock_call02_2,_slc_jb01,_slc_jb02,_clc_jnb01,_clc_jnb02
</span></span><span style="display:flex;"><span>    PatList_UltraProtect=1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,_jmp01,_jmp11,_jmp12,_jmp13,_jmp15,_call01,_call011,_call012
</span></span><span style="display:flex;"><span>    PatList_Custom=_jmp02,_jnz01,_jmp01
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>        pos1<span style="color:#ec0000">=</span>strchr(ptr,<span style="color:#008900">&#39;,&#39;</span>);
</span></span><span style="display:flex;"><span>        strcpy(SectionName,PrePatStr);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(pos1)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">*</span>pos1<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>            strcat(SectionName,ptr);
</span></span><span style="display:flex;"><span>            ptr<span style="color:#ec0000">=</span>pos1<span style="color:#ec0000">+</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>            strcat(SectionName,ptr);
</span></span><span style="display:flex;"><span>        Slen<span style="color:#ec0000">=</span>GetPrivateProfileString(SectionName,<span style="color:#008900">&#34;S&#34;</span>,<span style="color:#ec0000">NULL</span>,Soriserial,<span style="color:#008900">512</span>,JunkdbcfgPath);//S串为识别出的花指令序列模式
</span></span><span style="display:flex;"><span>        Rlen<span style="color:#ec0000">=</span>GetPrivateProfileString(SectionName,<span style="color:#008900">&#34;R&#34;</span>,<span style="color:#ec0000">NULL</span>,Roriserial,<span style="color:#008900">512</span>,JunkdbcfgPath);//R串为对应S串的正常指令序列模式
</span></span><span style="display:flex;"><span>/*    例如Custom模式：
</span></span><span style="display:flex;"><span>---------Junkdb.cfg-----------
</span></span><span style="display:flex;"><span>    [CODE_jnz01]
</span></span><span style="display:flex;"><span>    S = 7501??
</span></span><span style="display:flex;"><span>    R = 909090
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    [CODE_jmp01]
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    S = EB01??
</span></span><span style="display:flex;"><span>    R = 909090
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    [CODE_jmp02]
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    S = EB02????
</span></span><span style="display:flex;"><span>    R = 90909090
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(Slen <span style="color:#ec0000">!=</span>Rlen <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>Slen)//S串的长度应该和R匹配，否则无法正常替换
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            wsprintf(buf,<span style="color:#008900">&#34;Junkdb file [%s] section read error.&#34;</span>,SectionName);
</span></span><span style="display:flex;"><span>            MessageBox(hWnd,buf,<span style="color:#008900">&#34;DeJunk plugin v0.12&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONASTERISK);
</span></span><span style="display:flex;"><span>            free(JunkUndoData);
</span></span><span style="display:flex;"><span>            JunkUndoData<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Transform(Snewserial,Soriserial,Slen<span style="color:#ec0000">/</span><span style="color:#008900">2</span>);//字符串转换为字节码
</span></span><span style="display:flex;"><span>        Transform(Rnewserial,Roriserial,Rlen<span style="color:#ec0000">/</span><span style="color:#008900">2</span>);
</span></span><span style="display:flex;"><span>        FindMatch((uchar<span style="color:#ec0000">*</span>)JunkData,Snewserial,Rnewserial,Slen<span style="color:#ec0000">/</span><span style="color:#008900">2</span>,Range);//查找并替换花指令为正常代码
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(JunkCodeNum <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        wsprintf(buf,<span style="color:#008900">&#34;Cannot find Junk code.&#34;</span>);
</span></span><span style="display:flex;"><span>        MessageBox(hWnd,buf,<span style="color:#008900">&#34;DeJunk plugin v0.12&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONASTERISK);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>//如果找到则需要把原始字节码保存以便恢复
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(JunkUndoData)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            free(JunkUndoData);
</span></span><span style="display:flex;"><span>            JunkUndoData<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        JunkUndoData<span style="color:#ec0000">=</span>malloc(Range);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>JunkUndoData)
</span></span><span style="display:flex;"><span>            MessageBox(hWnd,<span style="color:#008900">&#34;Can&#39;t allocates Undo memory blocks!</span><span style="color:#008900">\n</span><span style="color:#008900">  Undo function invalid.&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#008900">&#34;Warning&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONEXCLAMATION);
</span></span><span style="display:flex;"><span>        IsMallocSuccess<span style="color:#ec0000">=</span><span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Readmemory(JunkUndoData,StartAddr,Range,MM_SILENT))//将原始字节码保存在JunkUndoData中
</span></span><span style="display:flex;"><span>            MessageBox(hWnd,<span style="color:#008900">&#34;Can&#39;t read the Undo data!&#34;</span>,<span style="color:#008900">&#34;Warning&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONEXCLAMATION);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Writememory(JunkData,StartAddr,Range,MM_SILENT))//将修改后的字节码覆盖内存中原始代码段
</span></span><span style="display:flex;"><span>            MessageBox(hWnd,<span style="color:#008900">&#34;Can&#39;t Write the memory space!&#34;</span>,<span style="color:#008900">&#34;Warning&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONEXCLAMATION);
</span></span><span style="display:flex;"><span>        wsprintf(buf,<span style="color:#008900">&#34;%d junk code were replace.&#34;</span>,JunkCodeNum);
</span></span><span style="display:flex;"><span>        MessageBox(hWnd,buf,<span style="color:#008900">&#34;DeJunk plugin v0.12&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONASTERISK);
</span></span><span style="display:flex;"><span>        Setdisasm(JunkStartAddr,JunkRange,CPU_ASMFOCUS);//将修改的结果在反汇编窗口显示
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#ec0000">RET</span>:
</span></span><span style="display:flex;"><span>    WriteFile(hLogFile,<span style="color:#008900">&#34;</span><span style="color:#008900">\r\n</span><span style="color:#008900">&#34;</span>,<span style="color:#008900">2</span>,<span style="color:#ec0000">&amp;</span>writenum,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>    WriteFile(hLogFile,buf,<span style="color:#008900">260</span>,<span style="color:#ec0000">&amp;</span>writenum,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>    CloseHandle(hLogFile);
</span></span><span style="display:flex;"><span>    free(JunkData);
</span></span><span style="display:flex;"><span>    JunkData<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> WINAPI <span style="color:#5f5fff">DeJunkFunc</span>(HWND hWnd,UINT uMsg,WPARAM wParam,LPARAM lParam)
</span></span><span style="display:flex;"><span>{//去除花指令窗口界面
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">switch</span> (uMsg)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_CLOSE</span>:
</span></span><span style="display:flex;"><span>            EndDialog(hWnd,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_SETCURSOR</span>:
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> str;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>( (HWND)wParam <span style="color:#ec0000">==</span> hStartAddr)
</span></span><span style="display:flex;"><span>                    str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;DeJunk start address.(hex)&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hRang)
</span></span><span style="display:flex;"><span>                    str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;DeJunk rang.(hex)&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hDirection)
</span></span><span style="display:flex;"><span>                    str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Select Direction.&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hJunkType)
</span></span><span style="display:flex;"><span>                    str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Select Dejunk Type.&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hStart)
</span></span><span style="display:flex;"><span>                        str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Start DeJunk.&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hE)
</span></span><span style="display:flex;"><span>                        str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Edit Dejunk profile.&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hClose)
</span></span><span style="display:flex;"><span>                        str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;End Dialog.&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                        str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Ready.&#34;</span>;
</span></span><span style="display:flex;"><span>                SendDlgItemMessage(hWnd,IDC_SBSTATU,WM_SETTEXT,<span style="color:#008900">0</span>,(LPARAM)str);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_INITDIALOG</span>://初始化
</span></span><span style="display:flex;"><span>            SetWindowText(hWnd,<span style="color:#008900">&#34;DeJunk plugin v0.12&#34;</span>);
</span></span><span style="display:flex;"><span>            hStartAddr<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_ETSTARTADDR);
</span></span><span style="display:flex;"><span>            hRang<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_ETRANG);
</span></span><span style="display:flex;"><span>            hDirection<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_CBDIRECTION);
</span></span><span style="display:flex;"><span>            hJunkType<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_CBJUNKTYPE);
</span></span><span style="display:flex;"><span>            hStart<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_BTSTART);
</span></span><span style="display:flex;"><span>            hClose<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_BTClOSE);
</span></span><span style="display:flex;"><span>            hE<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_BTE);
</span></span><span style="display:flex;"><span>            PostMessage(hStartAddr,EM_SETLIMITTEXT,<span style="color:#008900">8</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            PostMessage(hRang,EM_SETLIMITTEXT,<span style="color:#008900">5</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            ulong curthreadid<span style="color:#ec0000">=</span>Getcputhreadid();
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(curthreadid)
</span></span><span style="display:flex;"><span>                wsprintf(String1,<span style="color:#008900">&#34;%08lX&#34;</span>,Findthread(curthreadid)<span style="color:#ec0000">-&gt;</span>reg.ip);//EIP
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                wsprintf(String1,<span style="color:#008900">&#34;%08lX&#34;</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            SetDlgItemText(hWnd,IDC_ETSTARTADDR,String1);//起始地址设置为当前EIP
</span></span><span style="display:flex;"><span>            SendDlgItemMessage(hWnd,IDC_CBDIRECTION,CB_ADDSTRING,<span style="color:#008900">0</span>,(LPARAM)<span style="color:#008900">&#34;Down&#34;</span>);
</span></span><span style="display:flex;"><span>            SendDlgItemMessage(hWnd,IDC_CBDIRECTION,CB_ADDSTRING,<span style="color:#008900">0</span>,(LPARAM)<span style="color:#008900">&#34;Up&#34;</span>);
</span></span><span style="display:flex;"><span>            SendDlgItemMessage(hWnd,IDC_CBDIRECTION,CB_SETCURSEL,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            SendDlgItemMessage(hWnd,IDC_SBSTATU,WM_SETTEXT,<span style="color:#008900">0</span>,(LPARAM)<span style="color:#008900">&#34;Ready.&#34;</span>);
</span></span><span style="display:flex;"><span>            InitComboBox(hWnd);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_COMMAND</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">switch</span>(wParam)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTClOSE</span>:
</span></span><span style="display:flex;"><span>                    SendMessage(hWnd,WM_CLOSE,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTSTART</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>IsInputValid(hWnd,IDC_ETSTARTADDR) <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>IsInputValid(hWnd,IDC_ETRANG))//检查输入合法性
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        MessageBox(hWnd,<span style="color:#008900">&#34;Please input HEXadecimal.&#34;</span>,<span style="color:#008900">&#34;DeJunk plugin v0.12&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONEXCLAMATION);
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    //从输入获取数据
</span></span><span style="display:flex;"><span>                    GetDlgItemText(hWnd,IDC_ETSTARTADDR,String1,<span style="color:#008900">9</span>);
</span></span><span style="display:flex;"><span>                    JunkStartAddr<span style="color:#ec0000">=</span>GetNumberFromString(String1);
</span></span><span style="display:flex;"><span>                    GetDlgItemText(hWnd,IDC_ETRANG,String1,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                    JunkRange<span style="color:#ec0000">=</span>GetNumberFromString(String1);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span>(SendDlgItemMessage(hWnd,IDC_CBDIRECTION,CB_GETCURSEL,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>)//&#34;Up&#34;  如果向上查找则调整起始地址
</span></span><span style="display:flex;"><span>                        JunkStartAddr <span style="color:#ec0000">-=</span> JunkRange;
</span></span><span style="display:flex;"><span>                    FindJunk(hWnd,JunkStartAddr,JunkRange);//找到并修改花指令
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span>(JunkCodeNum)
</span></span><span style="display:flex;"><span>                        SendMessage(hWnd,WM_CLOSE,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">case</span> <span style="color:#ec0000">IDC_BTE</span>://打开cfg配置文件进行编辑
</span></span><span style="display:flex;"><span>                    GetPrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;Editor&#34;</span>,<span style="color:#ec0000">NULL</span>,String2,<span style="color:#008900">260</span>,JunkdbcfgPath);
</span></span><span style="display:flex;"><span>                    ShellExecute(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">&#34;Open&#34;</span>,String2,JunkdbcfgPath,<span style="color:#ec0000">NULL</span>,SW_SHOWDEFAULT);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> WINAPI <span style="color:#5f5fff">OptionFunc</span>(HWND hWnd,UINT uMsg,WPARAM wParam,LPARAM lParam)
</span></span><span style="display:flex;"><span>{//选项对话框窗口回调函数
</span></span><span style="display:flex;"><span>    BOOL IsAccepted;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">switch</span>(uMsg)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_CLOSE</span>:
</span></span><span style="display:flex;"><span>            EndDialog(hWnd,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_SETCURSOR</span>:
</span></span><span style="display:flex;"><span>            {//鼠标移动
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> str;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hRang)
</span></span><span style="display:flex;"><span>                    str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;DeJunk rang.(hex)&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hJunkType)
</span></span><span style="display:flex;"><span>                    str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Select Dejunk Type.&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hE)
</span></span><span style="display:flex;"><span>                    str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Select default editor.&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hStart)
</span></span><span style="display:flex;"><span>                    str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Save option&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>((HWND)wParam <span style="color:#ec0000">==</span> hClose)
</span></span><span style="display:flex;"><span>                    str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;End Dialog.&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                    str<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Ready.&#34;</span>;
</span></span><span style="display:flex;"><span>                SendDlgItemMessage(hWnd,IDC_SBSTATU,WM_SETTEXT,<span style="color:#008900">0</span>,(LPARAM)str);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_INITDIALOG</span>://初始化
</span></span><span style="display:flex;"><span>            hRang<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_ETRANG);
</span></span><span style="display:flex;"><span>            hJunkType<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_CBJUNKTYPE);
</span></span><span style="display:flex;"><span>            hStart<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_BTSTART);
</span></span><span style="display:flex;"><span>            hClose<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_BTClOSE);
</span></span><span style="display:flex;"><span>            hE<span style="color:#ec0000">=</span>GetDlgItem(hWnd,IDC_BTE);
</span></span><span style="display:flex;"><span>            EnableWindow(GetDlgItem(hWnd,IDC_ETSTARTADDR),FALSE);
</span></span><span style="display:flex;"><span>            EnableWindow(GetDlgItem(hWnd,IDC_CBDIRECTION),FALSE);
</span></span><span style="display:flex;"><span>            SetWindowText(GetDlgItem(hWnd,IDC_BTSTART),<span style="color:#008900">&#34;&amp;Save&#34;</span>);
</span></span><span style="display:flex;"><span>            SetWindowText(hWnd,<span style="color:#008900">&#34;Option&#34;</span>);
</span></span><span style="display:flex;"><span>            InitComboBox(hWnd);
</span></span><span style="display:flex;"><span>            //读取配置文件
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>GetPrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;DefaultRang&#34;</span>,<span style="color:#ec0000">NULL</span>,String1,<span style="color:#008900">6</span>,JunkdbcfgPath))
</span></span><span style="display:flex;"><span>                wsprintf(String1,<span style="color:#008900">&#34;%05lX&#34;</span>,<span style="color:#008900">4096</span>);
</span></span><span style="display:flex;"><span>            SetDlgItemText(hWnd,IDC_ETRANG,String1);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>GetPrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;DefaultType&#34;</span>,<span style="color:#ec0000">NULL</span>,String2,<span style="color:#008900">260</span>,JunkdbcfgPath))
</span></span><span style="display:flex;"><span>                SendDlgItemMessage(hWnd,IDC_CBJUNKTYPE,CB_SETCURSEL,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                SendDlgItemMessage(hWnd,IDC_CBJUNKTYPE,CB_SELECTSTRING,<span style="color:#008900">0</span>,(LPARAM)String2);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_COMMAND</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(wParam <span style="color:#ec0000">==</span> IDC_BTClOSE)
</span></span><span style="display:flex;"><span>                SendMessage(hWnd,WM_CLOSE,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(wParam <span style="color:#ec0000">==</span> IDC_BTSTART)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(IsAccepted)
</span></span><span style="display:flex;"><span>                    WritePrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;Editor&#34;</span>,String2,JunkdbcfgPath);//设置cfg文件默认打开软件
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">int</span> index<span style="color:#ec0000">=</span>SendDlgItemMessage(hWnd,IDC_CBJUNKTYPE,CB_GETCURSEL,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                SendDlgItemMessage(hWnd,IDC_CBJUNKTYPE,CB_GETLBTEXT,index,(LPARAM)String2);
</span></span><span style="display:flex;"><span>                WritePrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;DefaultType&#34;</span>,String2,JunkdbcfgPath);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(IsInputValid(hWnd,IDC_ETRANG))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    GetDlgItemText(hWnd,IDC_ETRANG,String1,<span style="color:#008900">6</span>);
</span></span><span style="display:flex;"><span>                    WritePrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;DefaultRang&#34;</span>,String1,JunkdbcfgPath);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                SendMessage(hWnd,WM_CLOSE,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(wParam <span style="color:#ec0000">==</span> IDC_BTE)
</span></span><span style="display:flex;"><span>            {//选择cfg文件默认打开软件
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">static</span> OPENFILENAME filestruct;
</span></span><span style="display:flex;"><span>                memset(String2,<span style="color:#008900">0</span>,<span style="color:#ec0000">sizeof</span>(String2));
</span></span><span style="display:flex;"><span>                filestruct.hInstance<span style="color:#ec0000">=</span>hInstance;
</span></span><span style="display:flex;"><span>                filestruct.lStructSize<span style="color:#ec0000">=</span><span style="color:#ec0000">sizeof</span>(OPENFILENAME);
</span></span><span style="display:flex;"><span>                filestruct.nMaxFile<span style="color:#ec0000">=</span><span style="color:#008900">260</span>;
</span></span><span style="display:flex;"><span>                filestruct.lpstrFile<span style="color:#ec0000">=</span>String2;
</span></span><span style="display:flex;"><span>                filestruct.Flags<span style="color:#ec0000">=</span>OFN_LONGNAMES<span style="color:#ec0000">|</span>OFN_EXPLORER<span style="color:#ec0000">|</span>OFN_FILEMUSTEXIST<span style="color:#ec0000">|</span>OFN_PATHMUSTEXIST<span style="color:#ec0000">|</span>OFN_HIDEREADONLY;
</span></span><span style="display:flex;"><span>                filestruct.lpstrFilter<span style="color:#ec0000">=</span><span style="color:#008900">&#34;Exe File&#34;</span>;
</span></span><span style="display:flex;"><span>                IsAccepted<span style="color:#ec0000">=</span>GetOpenFileName(<span style="color:#ec0000">&amp;</span>filestruct);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Plugininit</span>(<span style="color:#5f5fff">int</span> ollydbgversion,HWND hw,ulong <span style="color:#ec0000">*</span>features)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    hOllyWnd<span style="color:#ec0000">=</span>hw;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(Registerpluginclass(classname,<span style="color:#ec0000">NULL</span>,hInstance,MainProc) <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> str[<span style="color:#008900">260</span>];
</span></span><span style="display:flex;"><span>    strcpy(str,<span style="color:#008900">&#34;DeJunk plugin v0.12&#34;</span>);
</span></span><span style="display:flex;"><span>    strcat(str,<span style="color:#008900">&#34; by flyfancy&#34;</span>);
</span></span><span style="display:flex;"><span>    Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,str);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Plugindata</span>(<span style="color:#5f5fff">char</span> shortname[<span style="color:#008900">32</span>])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    strcpy(shortname,<span style="color:#008900">&#34;DeJunk&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">108</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">void</span> _export cdecl <span style="color:#5f5fff">ODBG_Plugindestroy</span>(<span style="color:#5f5fff">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(IsMallocSuccess)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        free(JunkUndoData);
</span></span><span style="display:flex;"><span>        JunkUndoData<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> Unregisterpluginclass(classname);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">void</span> _export cdecl <span style="color:#5f5fff">ODBG_Pluginaction</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">int</span> action,<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">switch</span>(action)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#008900">0</span><span style="color:#ec0000">:</span>//About
</span></span><span style="display:flex;"><span>            MessageBox(hOllyWnd,<span style="color:#008900">&#34;DeJunk plugin</span><span style="color:#008900">\n</span><span style="color:#008900">  Written by flyfancy</span><span style="color:#008900">\n</span><span style="color:#008900">  Thx: ljtt&#34;</span>,<span style="color:#008900">&#34;DeJunk plugin v0.12&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONASTERISK);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#008900">1</span><span style="color:#ec0000">:</span>//DeJunk
</span></span><span style="display:flex;"><span>            DialogBoxParam(hInstance,MAKEINTRESOURCE(IDD_MAINDLG),hOllyWnd,DeJunkFunc,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#008900">2</span><span style="color:#ec0000">:</span>//Undo
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>IsMallocSuccess)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox(hOllyWnd,<span style="color:#008900">&#34;Undo data is NULL.&#34;</span>,<span style="color:#008900">&#34;DeJunk plugin v0.12&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONASTERISK);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Writememory(JunkUndoData,JunkStartAddr,JunkRange,MM_SILENT))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                MessageBox(hOllyWnd,<span style="color:#008900">&#34;Can&#39;t execute undo operation!&#34;</span>,<span style="color:#008900">&#34;Warning&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONEXCLAMATION);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            IsMallocSuccess<span style="color:#ec0000">=</span><span style="color:#ec0000">false</span>;
</span></span><span style="display:flex;"><span>            free(JunkUndoData);
</span></span><span style="display:flex;"><span>            JunkUndoData<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>            Setdisasm(JunkStartAddr,JunkRange,CPU_ASMFOCUS);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#008900">3</span><span style="color:#ec0000">:</span>//Option
</span></span><span style="display:flex;"><span>            DialogBoxParam(hInstance,MAKEINTRESOURCE(IDD_MAINDLG),hOllyWnd,OptionFunc,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#008900">4</span><span style="color:#ec0000">:</span>//Dejunk selection
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(origin <span style="color:#ec0000">==</span> PM_DISASM <span style="color:#ec0000">&amp;&amp;</span> item <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                t_dump<span style="color:#ec0000">*</span> dump<span style="color:#ec0000">=</span>(t_dump<span style="color:#ec0000">*</span>)item;
</span></span><span style="display:flex;"><span>                IsDefaultType<span style="color:#ec0000">=</span><span style="color:#ec0000">true</span>;//设置当前JunkType为默认JunkType
</span></span><span style="display:flex;"><span>                JunkStartAddr<span style="color:#ec0000">=</span>dump<span style="color:#ec0000">-&gt;</span>sel0;//根据反汇编窗口选择范围设置花指令范围
</span></span><span style="display:flex;"><span>                JunkRange<span style="color:#ec0000">=</span>dump<span style="color:#ec0000">-&gt;</span>sel1 <span style="color:#ec0000">-</span> JunkStartAddr;
</span></span><span style="display:flex;"><span>                FindJunk(hOllyWnd,JunkStartAddr,JunkRange);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#008900">5</span><span style="color:#ec0000">:</span>//View last log
</span></span><span style="display:flex;"><span>            GetPrivateProfileString(<span style="color:#008900">&#34;OPTION&#34;</span>,<span style="color:#008900">&#34;Editor&#34;</span>,<span style="color:#ec0000">NULL</span>,String2,<span style="color:#008900">260</span>,JunkdbcfgPath);
</span></span><span style="display:flex;"><span>            ShellExecute(<span style="color:#ec0000">NULL</span>,<span style="color:#008900">&#34;Open&#34;</span>,String2,JunkdbcfgPath,<span style="color:#ec0000">NULL</span>,SW_SHOWDEFAULT);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Pluginmenu</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">char</span> data[<span style="color:#008900">4096</span>],<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(origin <span style="color:#ec0000">!=</span> PM_MAIN)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    strcpy(data,<span style="color:#008900">&#34;1 &amp;DeJunk</span><span style="color:#008900">\t</span><span style="color:#008900">Alt+Shift+S, 2 &amp;Undo</span><span style="color:#008900">\t</span><span style="color:#008900">Alt+Shift+Z, 4 D&amp;ejunk selection</span><span style="color:#008900">\t</span><span style="color:#008900">Alt+Shift+Q|3 &#34;</span>\
</span></span><span style="display:flex;"><span>        <span style="color:#008900">&#34;&amp;Option, 5 &amp;View last log</span><span style="color:#008900">\t</span><span style="color:#008900">Alt+Shift+G|0 &amp;About&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Pluginshortcut</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">int</span> ctrl,<span style="color:#5f5fff">int</span> alt,<span style="color:#5f5fff">int</span> shift,<span style="color:#5f5fff">int</span> key,<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(ctrl <span style="color:#ec0000">==</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> alt <span style="color:#ec0000">==</span> <span style="color:#008900">1</span> <span style="color:#ec0000">&amp;&amp;</span> shift <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">switch</span>(key)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">case</span> <span style="color:#008900">&#39;S&#39;</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>                ODBG_Pluginaction(PM_MAIN,<span style="color:#008900">1</span>,<span style="color:#ec0000">NULL</span>);//DeJunk
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">case</span> <span style="color:#008900">&#39;Q&#39;</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(origin <span style="color:#ec0000">==</span> PM_DISASM <span style="color:#ec0000">&amp;&amp;</span> item <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    ODBG_Pluginaction(PM_DISASM,<span style="color:#008900">4</span>,item);//Dejunk selection
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">case</span> <span style="color:#008900">&#39;G&#39;</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>                ODBG_Pluginaction(PM_MAIN,<span style="color:#008900">5</span>,<span style="color:#ec0000">NULL</span>);//View last log
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">case</span> <span style="color:#008900">&#39;Z&#39;</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>                ODBG_Pluginaction(PM_MAIN,<span style="color:#008900">2</span>,<span style="color:#ec0000">NULL</span>);//Undo
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="实例">实例</h3>
<p>弄懂了代码来进行实例分析，目标源码如下：TestDejunk.asm</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span><span style="color:#5f5fff">.386</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">.model</span> <span style="color:#008900">flat</span>,<span style="color:#008900">stdcall</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">option</span> <span style="color:#008900">casemap</span>:<span style="color:#008900">none</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">include</span> <span style="color:#008900">windows.inc</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">include</span> <span style="color:#008900">Masm32.inc</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">include</span> <span style="color:#008900">kernel32.inc</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">include</span> <span style="color:#008900">user32.inc</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">includelib</span> <span style="color:#008900">kernel32.lib</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">includelib</span> <span style="color:#008900">user32.lib</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">.data</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">szCap</span>       <span style="color:#008900">db</span> <span style="color:#ec0000">&#34;</span><span style="color:#008900">Test</span><span style="color:#ec0000">&#34;</span>,<span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">szFind</span>      <span style="color:#008900">db</span> <span style="color:#ec0000">&#34;</span><span style="color:#008900">Debugger</span> <span style="color:#008900">present</span><span style="color:#ec0000">&#34;</span>,<span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">szNoFind</span>    <span style="color:#008900">db</span> <span style="color:#ec0000">&#34;</span><span style="color:#008900">Debugger</span> <span style="color:#008900">NOT</span> <span style="color:#008900">present</span><span style="color:#ec0000">&#34;</span>,<span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">szNote</span>      <span style="color:#008900">db</span> <span style="color:#ec0000">&#34;</span><span style="color:#008900">Test</span> <span style="color:#008900">Last</span> <span style="color:#008900">Error</span> <span style="color:#008900">Message</span><span style="color:#ec0000">&#34;</span>,<span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">.code</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">start:</span>
</span></span><span style="display:flex;"><span>    ;test dejunk
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">jmp</span> <span style="color:#ec0000">@</span><span style="color:#008900">junk1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">db</span> <span style="color:#008900">075</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">db</span> <span style="color:#008900">001</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">@</span><span style="color:#ec0000">junk1:</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    ;test GetLastError
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">invoke</span>  <span style="color:#008900">MessageBox</span>, <span style="color:#008900">NULL</span>, <span style="color:#008900">addr</span> <span style="color:#008900">szNote</span>, <span style="color:#008900">addr</span> <span style="color:#008900">szCap</span>, <span style="color:#008900">MB_OK</span>
</span></span><span style="display:flex;"><span>    ;error usage function.
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">invoke</span> <span style="color:#008900">LoadIcon</span>, <span style="color:#008900">NULL</span>, <span style="color:#008900">NULL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">invoke</span> <span style="color:#008900">SetWindowText</span>, <span style="color:#008900">NULL</span>, <span style="color:#008900">NULL</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    ;test IsDebuggerPresent
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">invoke</span>  <span style="color:#008900">IsDebuggerPresent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">or</span> <span style="color:#008900">eax</span>, <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">jne</span> <span style="color:#ec0000">@</span><span style="color:#008900">Find</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">invoke</span>  <span style="color:#008900">MessageBox</span>, <span style="color:#008900">NULL</span>, <span style="color:#008900">addr</span> <span style="color:#008900">szNoFind</span>, <span style="color:#008900">addr</span> <span style="color:#008900">szCap</span>, <span style="color:#008900">MB_OK</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">@</span><span style="color:#ec0000">exit:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">invoke</span>  <span style="color:#008900">ExitProcess</span>, <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">@</span><span style="color:#ec0000">Find:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">invoke</span>  <span style="color:#008900">MessageBox</span>, <span style="color:#008900">NULL</span>, <span style="color:#008900">addr</span> <span style="color:#008900">szFind</span>, <span style="color:#008900">addr</span> <span style="color:#008900">szCap</span>, <span style="color:#008900">MB_OK</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">jmp</span> <span style="color:#ec0000">@</span><span style="color:#008900">exit</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">end</span> <span style="color:#008900">start</span>
</span></span></code></pre></div><p>编译成exe放入OllyDbg调试，得到：</p>
<pre tabindex="0"><code class="language-Txt" data-lang="Txt">00401000 &gt;/$ EB 02          JMP SHORT TestDeju.00401004
00401002  |  75             DB 75                                    ;  CHAR &#39;u&#39;
00401003  |  01             DB 01
00401004  |&gt; 6A 00          PUSH 0                                   ; /Style = MB_OK|MB_APPLMODAL
</code></pre><p>对照Junkdb.cfg，可见对应于：</p>
<pre tabindex="0"><code class="language-Txt" data-lang="Txt">[CODE_jmp02]
S = EB02????
R = 90909090
</code></pre><p>运行插件，果然将前4个字节改成了nop，跳过了。。。</p>
<h2 id="第六章-ollydbg导入ida符号插件loadmap分析">第六章 OllyDbg导入IDA符号插件LoadMap分析</h2>
<p>  LoadMap插件可以在OllyDbg中调试程序时显示IDA符号，大大降低代码分析难度。先用IDA制作map文件，先用IDA载入exe文件，手动分析修改成容易理解的符号后，File-&gt;Produce file-&gt;Create map file创建map文件，使用OllyDbg载入exe文件，在插件界面选择map文件路径，就可以看到OllyDgb带符号了。
经我分析，该插件代码并不复杂，本质上还是解析map文件，而该文件格式并不复杂，下面是我截取的一段：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Start</th>
          <th style="text-align: left">Length</th>
          <th style="text-align: left">Name</th>
          <th style="text-align: left">Class</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">0002:00000000</td>
          <td style="text-align: left">0000AF000H</td>
          <td style="text-align: left">.text</td>
          <td style="text-align: left">CODE</td>
      </tr>
      <tr>
          <td style="text-align: left">0003:00000000</td>
          <td style="text-align: left">00005B000H</td>
          <td style="text-align: left">.data</td>
          <td style="text-align: left">DATA</td>
      </tr>
      <tr>
          <td style="text-align: left">0004:00000000</td>
          <td style="text-align: left">000001000H</td>
          <td style="text-align: left">.tls</td>
          <td style="text-align: left">DATA</td>
      </tr>
      <tr>
          <td style="text-align: left">0005:00000000</td>
          <td style="text-align: left">000001000H</td>
          <td style="text-align: left">.rdata</td>
          <td style="text-align: left">DATA</td>
      </tr>
      <tr>
          <td style="text-align: left">0006:00000000</td>
          <td style="text-align: left">000002000H</td>
          <td style="text-align: left">.idata</td>
          <td style="text-align: left">DATA</td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Address</th>
          <th style="text-align: left">ics by Value</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">0001:00000000</td>
          <td style="text-align: left">start</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:00000012</td>
          <td style="text-align: left">loc_6051012</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:00000059</td>
          <td style="text-align: left">__GetExceptDLLinfo</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:00000140</td>
          <td style="text-align: left">sub_6051140</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:00000150</td>
          <td style="text-align: left">loc_6051150</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:0000018D</td>
          <td style="text-align: left">loc_605118D</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:0000018F</td>
          <td style="text-align: left">loc_605118F</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:000001B1</td>
          <td style="text-align: left">loc_60511B1</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:000001BE</td>
          <td style="text-align: left">loc_60511BE</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:000001F1</td>
          <td style="text-align: left">loc_60511F1</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:000044AC</td>
          <td style="text-align: left">_Assemble</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:000044D3</td>
          <td style="text-align: left">loc_60554D3</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:000044D8</td>
          <td style="text-align: left">loc_60554D8</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:000044E6</td>
          <td style="text-align: left">loc_60554E6</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:000044F8</td>
          <td style="text-align: left">loc_60554F8</td>
      </tr>
      <tr>
          <td style="text-align: left">0001:00004514</td>
          <td style="text-align: left">loc_6055514</td>
      </tr>
  </tbody>
</table>
<h3 id="逆向-2">逆向</h3>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>view sourceprint<span style="color:#ec0000">?</span>
</span></span><span style="display:flex;"><span>#include &lt;Windows.h&gt;
</span></span><span style="display:flex;"><span>#include &#34;Plugin.h&#34;
</span></span><span style="display:flex;"><span>#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>HINSTANCE hInst;
</span></span><span style="display:flex;"><span>HWND hOllyWnd;
</span></span><span style="display:flex;"><span>t_module<span style="color:#ec0000">*</span> MainModule;
</span></span><span style="display:flex;"><span>BOOL WINAPI <span style="color:#5f5fff">DllMain</span>(HINSTANCE hinstDLL,DWORD fdwReason,LPVOID lpvReserved)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(fdwReason <span style="color:#ec0000">==</span> DLL_PROCESS_ATTACH)
</span></span><span style="display:flex;"><span>        hInst<span style="color:#ec0000">=</span>hinstDLL;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Pluginmenu</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">char</span> data[<span style="color:#008900">4096</span>],<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(origin <span style="color:#ec0000">!=</span> PM_MAIN)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    memcpy(data,<span style="color:#008900">&#34;0 载入 Map 文件|1 关于&#34;</span>,<span style="color:#008900">25</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Plugininit</span>(<span style="color:#5f5fff">int</span> ollydbgversion,HWND hw, ulong <span style="color:#ec0000">*</span>features)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(ollydbgversion <span style="color:#ec0000">&lt;</span> <span style="color:#008900">108</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    hOllyWnd<span style="color:#ec0000">=</span>hw;
</span></span><span style="display:flex;"><span>    Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">&#34;LoadMap version 0.1 by lgx/iPB loaded&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Plugindata</span>(<span style="color:#5f5fff">char</span> shortname[<span style="color:#008900">32</span>])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    strcpy(shortname,<span style="color:#008900">&#34;LoadMap&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">108</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">LoadMap</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ulong mainbase<span style="color:#ec0000">=</span>Plugingetvalue(VAL_MAINBASE);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>mainbase)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">1</span>,<span style="color:#008900">&#34;MapConv 错误: 无进程用于添加 map 信息&#34;</span>);
</span></span><span style="display:flex;"><span>        MessageBox(hOllyWnd,<span style="color:#008900">&#34;是这样 - 如果你没有调试任何程序 - 你不需要 .map 文件 ;-)&#34;</span>,<span style="color:#008900">&#34;LoadMap v0.1&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONASTERISK);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    MainModule<span style="color:#ec0000">=</span>Findmodule(mainbase);
</span></span><span style="display:flex;"><span>    Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">&#34;MainBase: %X, CodeBase: %X, %s&#34;</span>,mainbase,MainModule<span style="color:#ec0000">-&gt;</span>codebase,MainModule<span style="color:#ec0000">-&gt;</span>path);
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> MapFileName[<span style="color:#008900">256</span>];
</span></span><span style="display:flex;"><span>    FILE<span style="color:#ec0000">*</span> file;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span> str[<span style="color:#008900">256</span>];
</span></span><span style="display:flex;"><span>    MapFileName[<span style="color:#008900">0</span>]<span style="color:#ec0000">=</span> <span style="color:#008900">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Browsefilename(<span style="color:#008900">&#34;选择 map 文件&#34;</span>,MapFileName,<span style="color:#008900">&#34;.map&#34;</span>,<span style="color:#008900">0</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>     file<span style="color:#ec0000">=</span>fopen(MapFileName,<span style="color:#008900">&#34;rt&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>file)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">1</span>,<span style="color:#008900">&#34;LoadMap 错误: 无法打开 %s&#34;</span>,MapFileName);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>/*  map文件格式
</span></span><span style="display:flex;"><span>     0001:00000000       start
</span></span><span style="display:flex;"><span>     0001:00000012       loc_6051012
</span></span><span style="display:flex;"><span>     0001:00000059       __GetExceptDLLinfo
</span></span><span style="display:flex;"><span>     0001:00000140       sub_6051140
</span></span><span style="display:flex;"><span>     0001:00000150       loc_6051150
</span></span><span style="display:flex;"><span>     0001:0000018D       loc_605118D
</span></span><span style="display:flex;"><span>     0001:0000018F       loc_605118F
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">while</span>(<span style="color:#ec0000">!</span>feof(file))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        fgets(str,<span style="color:#008900">256</span>,file);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>strncmp(str,<span style="color:#008900">&#34; 0001:&#34;</span>,<span style="color:#008900">6</span>))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> endptr;
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">long</span> offset<span style="color:#ec0000">=</span>strtol(str<span style="color:#ec0000">+</span><span style="color:#008900">6</span>,<span style="color:#ec0000">&amp;</span>endptr,<span style="color:#008900">16</span>);//每行偏移6处为相对地址
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(offset)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> ptr<span style="color:#ec0000">=</span>str<span style="color:#ec0000">+</span><span style="color:#008900">21</span>;//每行偏移21处为IDA符号名
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">while</span>(<span style="color:#ec0000">*</span>ptr)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">*</span>ptr <span style="color:#ec0000">==</span> <span style="color:#008900">&#39;\r&#39;</span> <span style="color:#ec0000">||</span> <span style="color:#ec0000">*</span>ptr <span style="color:#ec0000">==</span> <span style="color:#008900">&#39;\n&#39;</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">*</span>ptr<span style="color:#ec0000">=</span><span style="color:#008900">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>                    ptr<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                Quickinsertname(MainModule<span style="color:#ec0000">-&gt;</span>codebase<span style="color:#ec0000">+</span>offset,NM_LABEL,str<span style="color:#ec0000">+</span><span style="color:#008900">21</span>);
</span></span><span style="display:flex;"><span>                Quickinsertname(MainModule<span style="color:#ec0000">-&gt;</span>codebase<span style="color:#ec0000">+</span>offset,NM_COMMENT,str<span style="color:#ec0000">+</span><span style="color:#008900">21</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    fclose(file);
</span></span><span style="display:flex;"><span>    Mergequicknames();
</span></span><span style="display:flex;"><span>    Addtolist(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">&#34;LoadMap: 成功: Map 文件成功导入&#34;</span>);
</span></span><span style="display:flex;"><span>    MessageBox(hOllyWnd,<span style="color:#008900">&#34;Map 文件成功导入&#34;</span>,<span style="color:#008900">&#34;LoadMap v0.1&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONASTERISK);
</span></span><span style="display:flex;"><span>    Setcpu(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,CPU_ASMFOCUS);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">void</span> _export cdecl <span style="color:#5f5fff">ODBG_Pluginaction</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">int</span> action,<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(origin <span style="color:#ec0000">!=</span> PM_MAIN)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(action <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>        LoadMap();
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(action <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>        MessageBox(hOllyWnd,<span style="color:#008900">&#34;LoadMap version 0.1 by lgx/iPB&#34;</span>,<span style="color:#008900">&#34;LoadMap v0.1&#34;</span>,MB_OK<span style="color:#ec0000">|</span>MB_ICONASTERISK);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="第七章-使用vs2010以上版本的mfc编写ollydbg插件">第七章 使用VS2010以上版本的MFC编写OllyDbg插件</h2>
<p>  前面已经说过，MFC早期版本的CString实现没有使用ATL，而plugin.h要求编译时加入/J命令，或定义_CHAR_UNSIGNED宏，而ATL要求则相反。因此这个问题在VC6中不存在，而在VS2010及以上版本存在，目前我就测试了这几个版本。如何解决这个矛盾呢？今天我研究出一种方法。<br>
  #if宏在这里起了决定性作用，如果命令行定义/J则所有工程文件都默认定义_CHAR_UNSIGNED，那么我们退而求其次，只在必要处添加该定义，使用结束后取消定义，这样就不和ATL冲突了！！！下面是该宏用法：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>#if !defined _CHAR_UNSIGNED
</span></span><span style="display:flex;"><span>#define _CHAR_UNSIGNED
</span></span><span style="display:flex;"><span>#define _ISCHARTYPEUNSIGNED  1
</span></span><span style="display:flex;"><span>#else
</span></span><span style="display:flex;"><span>#define  _ISCHARTYPEUNSIGNED 0
</span></span><span style="display:flex;"><span>#endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#if _ISCHARTYPEUNSIGNED == 1
</span></span><span style="display:flex;"><span>#undef _CHAR_UNSIGNED
</span></span><span style="display:flex;"><span>#endif
</span></span></code></pre></div><p>  我使用_ISCHARTYPEUNSIGNED 判断是否修改了_CHAR_UNSIGNED，如果原来未定义_CHAR_UNSIGNED，那么就在当前代码块定义该标志，块结束再改回去。如果原来定义过，则不用做任何操作。该代码要和MFC相关宏分开，下面来测试，新建一个MFC的常规DLL，主文件中修改为如下形式：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>// MFCLibrary1.cpp : 定义 DLL 的初始化例程。  
</span></span><span style="display:flex;"><span>#include &#34;stdafx.h&#34;  
</span></span><span style="display:flex;"><span>#include &#34;MFCLibrary1.h&#34;  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>#ifdef _DEBUG  
</span></span><span style="display:flex;"><span>#define new DEBUG_NEW  
</span></span><span style="display:flex;"><span>#endif  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>// CMFCLibrary1App  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>BEGIN_MESSAGE_MAP(CMFCLibrary1App, CWinApp)  
</span></span><span style="display:flex;"><span>END_MESSAGE_MAP()  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>// CMFCLibrary1App 构造  
</span></span><span style="display:flex;"><span>CMFCLibrary1App<span style="color:#ec0000">::</span>CMFCLibrary1App()  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    // TODO: 在此处添加构造代码，  
</span></span><span style="display:flex;"><span>    // 将所有重要的初始化放置在 InitInstance 中  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>// 唯一的一个 CMFCLibrary1App 对象  
</span></span><span style="display:flex;"><span>CMFCLibrary1App theApp;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// CMFCLibrary1App 初始化  
</span></span><span style="display:flex;"><span>BOOL CMFCLibrary1App<span style="color:#ec0000">::</span>InitInstance()  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    CWinApp<span style="color:#ec0000">::</span>InitInstance();  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> TRUE;  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>#if !defined _CHAR_UNSIGNED  
</span></span><span style="display:flex;"><span>#define _CHAR_UNSIGNED  
</span></span><span style="display:flex;"><span>#define _ISCHARTYPEUNSIGNED  1  
</span></span><span style="display:flex;"><span>#else  
</span></span><span style="display:flex;"><span>#define  _ISCHARTYPEUNSIGNED 0  
</span></span><span style="display:flex;"><span>#endif  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>#include &lt;Windows.h&gt;  
</span></span><span style="display:flex;"><span>#include &#34;Plugin.h&#34;  
</span></span><span style="display:flex;"><span>#include &lt;stdio.h&gt;  
</span></span><span style="display:flex;"><span>#pragma comment(lib,&#34;ollydbg.lib&#34;)  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>HINSTANCE hInst;  
</span></span><span style="display:flex;"><span>HWND hOllyWnd;  
</span></span><span style="display:flex;"><span>t_module<span style="color:#ec0000">*</span> MainModule;  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Pluginmenu</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">char</span> data[<span style="color:#008900">4096</span>],<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Plugininit</span>(<span style="color:#5f5fff">int</span> ollydbgversion,HWND hw, ulong <span style="color:#ec0000">*</span>features)  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Plugindata</span>(<span style="color:#5f5fff">char</span> shortname[<span style="color:#008900">32</span>])  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    strcat(shortname,<span style="color:#008900">&#34;testMFC&#34;</span>);  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">108</span>;  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>#if _ISCHARTYPEUNSIGNED == 1  
</span></span><span style="display:flex;"><span>#undef _CHAR_UNSIGNED  
</span></span><span style="display:flex;"><span>#endif 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// dllmain.cpp : 定义 DLL 的初始化例程。  
</span></span><span style="display:flex;"><span>#include &#34;stdafx.h&#34;  
</span></span><span style="display:flex;"><span>#include &lt;afxwin.h&gt;  
</span></span><span style="display:flex;"><span>#include &lt;afxdllx.h&gt;  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>#ifdef _DEBUG  
</span></span><span style="display:flex;"><span>#define new DEBUG_NEW  
</span></span><span style="display:flex;"><span>#endif  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span><span style="color:#ec0000">static</span> AFX_EXTENSION_MODULE MFCLibrary2DLL <span style="color:#ec0000">=</span> { <span style="color:#ec0000">NULL</span>, <span style="color:#ec0000">NULL</span> };  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span><span style="color:#ec0000">extern</span> <span style="color:#008900">&#34;C&#34;</span> <span style="color:#5f5fff">int</span> APIENTRY  
</span></span><span style="display:flex;"><span>DllMain(HINSTANCE hInstance, DWORD dwReason, LPVOID lpReserved)  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    // 如果使用 lpReserved，请将此移除  
</span></span><span style="display:flex;"><span>    UNREFERENCED_PARAMETER(lpReserved);  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (dwReason <span style="color:#ec0000">==</span> DLL_PROCESS_ATTACH)  
</span></span><span style="display:flex;"><span>    {  
</span></span><span style="display:flex;"><span>        TRACE0(<span style="color:#008900">&#34;MFCLibrary2.DLL 正在初始化!</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);   
</span></span><span style="display:flex;"><span>        // 扩展 DLL 一次性初始化  
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>AfxInitExtensionModule(MFCLibrary2DLL, hInstance))  
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;  
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">new</span> <span style="color:#5f5fff">CDynLinkLibrary</span>(MFCLibrary2DLL);  
</span></span><span style="display:flex;"><span>    }  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span> <span style="color:#5f5fff">if</span> (dwReason <span style="color:#ec0000">==</span> DLL_PROCESS_DETACH)  
</span></span><span style="display:flex;"><span>    {  
</span></span><span style="display:flex;"><span>        TRACE0(<span style="color:#008900">&#34;MFCLibrary2.DLL 正在终止!</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>        // 在调用析构函数之前终止该库  
</span></span><span style="display:flex;"><span>        AfxTermExtensionModule(MFCLibrary2DLL);  
</span></span><span style="display:flex;"><span>    }  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;   // 确定  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>#if !defined _CHAR_UNSIGNED  
</span></span><span style="display:flex;"><span>#define _CHAR_UNSIGNED  
</span></span><span style="display:flex;"><span>#define _ISCHARTYPEUNSIGNED  1  
</span></span><span style="display:flex;"><span>#else  
</span></span><span style="display:flex;"><span>#define  _ISCHARTYPEUNSIGNED 0  
</span></span><span style="display:flex;"><span>#endif  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>#include &lt;Windows.h&gt;  
</span></span><span style="display:flex;"><span>#include &#34;Plugin.h&#34;  
</span></span><span style="display:flex;"><span>#include &lt;stdio.h&gt;  
</span></span><span style="display:flex;"><span>#pragma comment(lib,&#34;ollydbg.lib&#34;)  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>HINSTANCE hInst;  
</span></span><span style="display:flex;"><span>HWND hOllyWnd;  
</span></span><span style="display:flex;"><span>t_module<span style="color:#ec0000">*</span> MainModule;  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Pluginmenu</span>(<span style="color:#5f5fff">int</span> origin,<span style="color:#5f5fff">char</span> data[<span style="color:#008900">4096</span>],<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>item)  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">1</span>;  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Plugininit</span>(<span style="color:#5f5fff">int</span> ollydbgversion,HWND hw, ulong <span style="color:#ec0000">*</span>features)  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>extc <span style="color:#5f5fff">int</span>  _export cdecl <span style="color:#5f5fff">ODBG_Plugindata</span>(<span style="color:#5f5fff">char</span> shortname[<span style="color:#008900">32</span>])  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    strcat(shortname,<span style="color:#008900">&#34;testMFC&#34;</span>);  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">108</span>;  
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>#if _ISCHARTYPEUNSIGNED == 1  
</span></span><span style="display:flex;"><span>#undef _CHAR_UNSIGNED  
</span></span><span style="display:flex;"><span>#endif
</span></span></code></pre></div><h2 id="附录一-ollydbg导出函数">附录一 OllyDbg导出函数</h2>
<pre tabindex="0"><code>   1    000054EFC _Addsorteddata
   2    10005A60C _Addtolist
   3    20007F284 _Analysecode
164    300031AD8 _Animate
   4    4000054AC _Assemble
180    500077D8C _Attachtoactiveprocess
   5    60005A474 _Broadcast
   6    700076224 _Browsefilename
   7    800054B20 _Calculatecrc
   8    900015E60 _Checkcondition
   9    A00008208 _Compress
  10    B00053154 _Createdumpwindow
  11    C0005B1F0 _Createlistwindow
181    D0009F260 _Createpatchwindow
126    E0008E720 _Createprofilewindow
165    F0008DD10 _Creatertracewindow
  12   1000054D98 _Createsorteddata
166   11000795C8 _Createthreadwindow
167   120007A2D8 _Createwatchwindow
168   1300098E28 _Createwinwindow
  13   140007D6B0 _Decodeaddress
127   150000BE78 _Decodeascii
  14   1600015C4C _Decodecharacter
  15   1700092E04 _Decodefullvarname
  16   180000C2C8 _Decodeknownargument
  17   1900064C38 _Decodename
  18   1A0005DFE0 _Decoderange
  19   1B0007E2A8 _Decoderelativeoffset
  20   1C000789E0 _Decodethreadname
128   1D0000C0A4 _Decodeunicode
  21   1E00008480 _Decompress
  22   1F000558D0 _Defaultbar
  23   2000019518 _Deletebreakpoints
169   2100008C08 _Deletehardwarebreakbyaddr
  24   22000089EC _Deletehardwarebreakpoint
  25   2300064FC8 _Deletenamerange
  26   2400055414 _Deletenonconfirmedsorteddata
129   250008AD78 _Deleteruntrace
  27   2600055224 _Deletesorteddata
  28   2700055308 _Deletesorteddatarange
130   2800079844 _Deletewatch
  29   290006395C _Demanglename
  30   2A 00054CD8 _Destroysorteddata
  31   2B00015F48 _Disasm
  32   2C0007E940 _Disassembleback
  33   2D0007EB0C _Disassembleforward
  34   2E0006498C _Discardquicknames
170   2F0004CF54 _Dumpbackup
  35   300005401C _Error
  36   3100097724 _Expression
  37   320007099C _Findallcommands
175   3300070BE8 _Findalldllcalls
131   34000710E4 _Findallsequences
  38   350005DF00 _Finddecode
  39   360005DF58 _Findfileoffset
  40   370005DE80 _Findfixup
118   380001ABCC _Findhittrace
  41   390006512C _Findimportbyname
  42   3A00064F04 _Findlabel
  43   3B00065074 _Findlabelbyname
  44   3C00061A48 _Findmemory
  45   3D0005DE18 _Findmodule
  46   3E000649C0 _Findname
  47   3F00064E5C _Findnextname
132   400001E510 _Findnextproc
119   410008BAB4 _Findnextruntraceip
133   420001E4AC _Findprevproc
120   430008BA24 _Findprevruntraceip
134   440001E3DC _Findprocbegin
135   450001E454 _Findprocend
  48   460006FE04 _Findreferences
  49   4700055510 _Findsorteddata
  50   48000555C8 _Findsorteddataindex
  51   4900055568 _Findsorteddatarange
  52   4A0007053C _Findstrings
136   4B0000B0A8 _Findsymbolicname
  53   4C00078978 _Findthread
137   4D00097700 _Findunknownfunction
  54   4E0003192C _Flash
176   4F0007D568 _Followcall
  55   500009763C _Get3dnow
138   5100041210 _Get3dnowxy
  56   5200091A44 _Getaddressfromline
  57   530009765C _Getasmfindmodel
139   540003E674 _Getasmfindmodelxy
  58   550009307C _Getbprelname
  59   5600019D78 _Getbreakpointtype
184   5700019D9C _Getbreakpointtypecount
  60   580002D564 _Getcputhreadid
  61   590001E5E0 _Getdisassemblerrange
  62   5A000975F4 _Getfloat
  63   5B000975CC _Getfloat10
140   5C0003D684 _Getfloat10xy
141   5D0003D7A8 _Getfloatxy
  64   5E000976CC _Gethexstring
142   5F000403D8 _Gethexstringxy
  65   60000975B0 _Getline
  66   61000918F0 _Getlinefromaddress
143   620003D234 _Getlinexy
  67   6300097588 _Getlong
144   640003D090 _Getlongxy
  68   650009761C _Getmmx
145   6600040FF4 _Getmmxxy
  69   6700019E20 _Getnextbreakpoint
146   6800008458 _Getoriginaldatasize
147   690001E558 _Getproclimits
177   6A0003D198 _Getregxy
  70   6B0007393C _Getresourcestring
121   6C0008BF8C _Getruntraceprofile
122   6D0008BB3C _Getruntraceregisters
  71   6E000557DC _Getsortedbyselection
  72   6F00091D00 _Getsourcefilelimits
  73   70000972A4 _Getstatus
148   7100055DB0 _Gettableselectionxy
  74   720009767C _Gettext
149   730003EAFC _Gettextxy
150   74000799A0 _Getwatch
  75   7500034A14 _Go
  76   760006207C _Guardmemory
171   7700008F54 _Hardbreakpoints
  77   78000612E4 _Havecopyofmemory
  78   7900031768 _Infoline
151   7A00034494 _Injectcode
  79   7B00063EFC _Insertname
152   7C000798D0 _Insertwatch
153   7D0007F02C _Isfilling
178   7E0007EFE4 _Isprefix
  80   7F00047224 _Isretaddr
154   800007ECD8 _Issuspicious
  81   8100054800 _IstextA
  82   8200054840 _IstextW
186   8300060914 _Listmemory
  83   84000976A4 _Manualbreakpoint
  84   85000976F4 _Mergequicknames
  85   8600031630 _Message
123   870001AC34 _Modifyhittrace
  86   88000541CC _Newtablewindow
155   890007731C _OpenEXEfile
  87   8A00055ECC _Painttable
  88   8B000972AC _Plugingetvalue
  89   8C00097154 _Pluginreadintfromini
  90   8D000971E0 _Pluginreadstringfromini
  91   8E00096D4C _Pluginsaverecord
  92   8F00097004 _Pluginwriteinttoini
  93   90000970B4 _Pluginwritestringtoini
  94   910007E820 _Print3dnow
  95   920007E5CC _Printfloat10
  96   930007E450 _Printfloat4
  97   940007E510 _Printfloat8
156   950007E88C _Printsse
  98   9600031820 _Progress
  99   9700064304 _Quickinsertname
100   980005470C _Quicktablewindow
157   9900061684 _Readcommand
101   9A0006130C _Readmemory
102   9B0001E5CC _Redrawdisassembler
103   9C0005413C _Registerotclass
104   9D00096F2C _Registerpluginclass
158   9E00078854 _Restoreallthreads
159   9F00078788 _Runsinglethread
124   A00008B9F8 _Runtracesize
125   A10008C188 _Scrollruntracewindow
105   A20005A2D0 _Selectandscroll
172   A30002DF84 _Sendshortcut
106   A400097754 _Setbreakpoint
185   A500019560 _Setbreakpointext
107   A60002D618 _Setcpu
160   A70002DEA4 _Setdisasm
173   A800046E58 _Setdumptype
108   A900008690 _Sethardwarebreakpoint
109   AA000192D8 _Setmembreakpoint
174   AB0008C040 _Settracecondition
182   AC0008C110 _Settracecount
183   AD0008C13C _Settracepauseoncommands
110   AE00095554 _Showsourcefromaddress
111   AF00055630 _Sortsorteddata
161   B00008B86C _Startruntrace
162   B100054884 _Stringtotext
112   B200034290 _Suspendprocess
113   B30005835C _Tablefunction
179   B400019F1C _Tempbreakpoint
114   B500096FE4 _Unregisterpluginclass
115   B60005A5EC _Updatelist
116   B700071594 _Walkreference
163   B80007160C _Walkreferenceex
117   B900061728 _Writememory
187   BA00001059 __GetExceptDLLinfo
188   BB000B0128 ___CPPdebugHook
</code></pre>
    
  </div>

  


  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/win_posts/20140418_win7_disk/">
                        Win7磁盘读写操作
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
            <div class="single-pagination-container-next">
                <div class="single-pagination-text">
                    <a href="/win_posts/20150101_windbg_note/">
                        Windbg调试笔记
                    </a>
                </div>
                <div class="single-pagination-text">→</div>
            </div>
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


      </main>
    </div>

    <footer>
      

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    



    </footer>
    
  </body>

  <script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

</html>