<!DOCTYPE html>
<html lang="zh-CN"
  dir="ltr">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://lich4.github.io//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://lich4.github.io//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://lich4.github.io//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://lich4.github.io//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://lich4.github.io//apple-touch-icon.png">

<meta name="description" content=""/>

<title>
    
    Windbg K命令分析 | 超哥的博客
    
</title>

<link rel="canonical" href="https://lich4.github.io/win_posts/20150809_windbg_k/"/>












<link rel="stylesheet" href="/assets/combined.min.cbcb816aefdb3b7380c5921cbb3b89d12f07742cb3f869754adb56da84f0d729.css" media="all">









  </head>

  

  
  
  

  <body class="light">

    <div class="content">
      <header>
        

<div class="header">

    

</div>

      </header>

      <main class="main">
        





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a href="/win_posts/">Win_posts</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a class="breadcrumbs-current" href="/win_posts/20150809_windbg_k/">Windbg K命令分析</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">Windbg K命令分析</h1>
    
    <p class="single-summary">Windbg K命令分析</p>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2015-08-09T00:00:00&#43;00:00">August 9, 2015</time>
      

      
    </p>

  </div>

  

  
  
  

  

  
  <aside class="toc">
    <p><strong>Table of contents</strong></p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#rtlpwalkframechain">RtlpWalkFrameChain</a></li>
    <li><a href="#x86栈分析">X86栈分析</a></li>
    <li><a href="#k命令分析">K命令分析</a></li>
  </ul>
</nav>
  </aside>
  

  

  <div class="single-content">
    <h2 id="rtlpwalkframechain">RtlpWalkFrameChain</h2>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>ULONG
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">RtlpWalkFrameChain</span> (
</span></span><span style="display:flex;"><span>    OUT PVOID <span style="color:#ec0000">*</span>Callers,
</span></span><span style="display:flex;"><span>    IN ULONG Count,
</span></span><span style="display:flex;"><span>    IN ULONG Flags,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>ULONG LowLimit;//[ebp-20h]
</span></span><span style="display:flex;"><span>ULONG HightLimit;//[ebp-24h]
</span></span><span style="display:flex;"><span>ULONG<span style="color:#ec0000">*</span> ebp;//[ebp-28h]
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> i;//[ebp-2Ch]
</span></span><span style="display:flex;"><span>PETHREAD <span style="color:#ec0000">thread</span>;//[ebp-30h][ebp-3Ch]
</span></span><span style="display:flex;"><span>PKTRAP_FRAME frame;//[ebp-34h]
</span></span><span style="display:flex;"><span>PTEB teb;//[ebp-38h]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>Flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        ebp<span style="color:#ec0000">=</span>EBP
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>RtlpCaptureStackLimits(<span style="color:#ec0000">&amp;</span>LowLimit,<span style="color:#ec0000">&amp;</span>HighLimit))
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ec0000">if</span>(Flags <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">thread</span><span style="color:#ec0000">=</span>PsGetCurrentThread();
</span></span><span style="display:flex;"><span>        frame<span style="color:#ec0000">=</span><span style="color:#ec0000">thread</span><span style="color:#ec0000">-&gt;</span>TrapFrame
</span></span><span style="display:flex;"><span>        teb<span style="color:#ec0000">=</span><span style="color:#ec0000">thread</span><span style="color:#ec0000">-&gt;</span>Teb;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>teb <span style="color:#ec0000">||</span> frame <span style="color:#ec0000">&lt;</span> MmSystemRangeStart <span style="color:#ec0000">||</span> frame <span style="color:#ec0000">&lt;=</span> <span style="color:#ec0000">thread</span>.StackLimit <span style="color:#ec0000">||</span> <span style="color:#ec0000">thread</span><span style="color:#ec0000">-&gt;</span>ApcStateIndex <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(KeGetCurrentIrql()<span style="color:#ec0000">?=</span><span style="color:#008900">2</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        LowLimit <span style="color:#ec0000">=</span> teb<span style="color:#ec0000">-&gt;</span>NtTib.StackLimit;
</span></span><span style="display:flex;"><span>        HightLimit <span style="color:#ec0000">=</span> teb<span style="color:#ec0000">-&gt;</span>NtTib.StackBase;
</span></span><span style="display:flex;"><span>        ebp<span style="color:#ec0000">=</span>teb<span style="color:#ec0000">-&gt;</span>ebp;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(LowLimit<span style="color:#ec0000">&gt;=</span>HightLimit)
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(HightLimit<span style="color:#ec0000">&lt;=</span>MmUserProbeAddress (<span style="color:#008900">805599</span>d4))
</span></span><span style="display:flex;"><span>                ....
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ec0000">for</span>(i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>Count;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(ebp<span style="color:#ec0000">&gt;=</span>HightLimit)
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        ............
</span></span><span style="display:flex;"><span>        ULONG nextebp<span style="color:#ec0000">=</span>[ebp];
</span></span><span style="display:flex;"><span>        Callers[i]<span style="color:#ec0000">=</span>[ebp<span style="color:#ec0000">+</span><span style="color:#008900">4</span>];
</span></span><span style="display:flex;"><span>        ebp<span style="color:#ec0000">=</span>nextebp;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="x86栈分析">X86栈分析</h2>
<p>  栈回溯，一是用于调试，便于分析程序流程，另一是用于开发中，可以观察调用者是否自身进程，之前用过也简要分析过RtlpWalkFrameChain的原理，然而无论是用该函数，还是用dbghelp的stackwalk函数，都是利用微软的x86栈桢结构。如果自己简单做用ebp链完全可以，然而这样做了你会发现得到的结果，比Windbg k命令得到的回溯栈少好多，这是为什么呢，这篇帖子及该系列就来探究这个问题。<br>
  dbghelp.dll是用c++写的因此分析流程比较麻烦，请做好心理准备，本文先从简单ebp链入来思考这一问题。众所周知，微软函数(vs系)编译器会自动生成栈桢结构，而api本身也是这种结构，下面以2层调用为例：</p>
<pre tabindex="0"><code>funcA:
xor edi,edi  //对齐字节
push ebp    //开始创建当前层栈桢
mov ebp,esp
sub esp,X
......
    push param1
    push param2
    ..........
    push paramN
    call funcB
        funcB:
        xor edi,edi  //对齐字节
        push ebp
        mov ebp,esp            -------------假设执行到这里
        sub esp,Y
        .......
        mov esp,ebp
        pop ebp
        ret ?
......
mov esp,ebp   //开始销毁栈桢
pop ebp
ret ?
</code></pre><p>这样一来，栈中的布局：</p>
<pre tabindex="0"><code>..........
———————
Y


———————
funcB.ebp                          -&gt;     当前ebp指向
———————
funcB.nexteip
———————
funcB.paramN
———————
.........
———————
funcB.param1
———————
X


———————
funcA.ebp
———————
funcA.paramN
———————
.........
———————
funcA.param1
———————
nexteip
———————
.........
</code></pre><p>这种布局是重复的，因此当前ebp位置处可以看做链表(而标准函数中ebp一般是一成不变的，用于保存栈桢)：</p>
<pre tabindex="0"><code>ebp:
+00  上层ebp
+04  返回地址
+08  paramN
.......
+??  分配的栈变量空间
+??  上上层ebp
+??  上上层返回地址
..............
</code></pre><p>再来看非标准栈桢（不使用ebp）</p>
<pre tabindex="0"><code>..........
———————
Y


———————
funcB.nexteip
———————
funcB.paramN
———————
.........
———————
funcB.param1
———————
X


———————
funcA.paramN
———————
.........
———————
funcA.param1
———————
nexteip
———————
.........
</code></pre><p>  所以根据该链表很容易得到调用栈，然而我们的程序中并不能遇到“理想”的情况，因为以上布局是假设函数存在创建和销毁栈桢的过程，假设该函数没用ebp做栈桢，或者压根没使用栈桢，那么这种方法肯定是行不通了。然而windbg却仍能正确找到，这是为什么呢？最直观的想法是解析了上述栈桢，计算出X,Y param1-N，然后把他们所占的从2个相邻ebp节点中除去，剩下的部分，探测是否返回地址，然后根据解析的返回地址位置重构每一层函数栈，当然返回地址处前一条指令必须是函数调用指令，而且调用地址应该是下一层函数起始位置。</p>
<h2 id="k命令分析">K命令分析</h2>
<p>  为了验证这个问题，需要研究windbg执行原理，而这就需要用windbg动态调试windbg。由于知道windbg必从栈桢得到返回地址，因此可以对ReadProcessMemory下断：</p>
<pre tabindex="0"><code>0:000&gt; g
(a34.17b8): Break instruction exception - code 80000003 (first chance)
eax=cccccccc ebx=7f1e9000 ecx=00000000 edx=00000001 esi=00d11069 edi=002dfe38
eip=00d11360 esp=002dfd68 ebp=002dfe38 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000206
*** WARNING: Unable to verify checksum for teststack.exe
teststack!func3:
00d11360 cc              int     3
</code></pre><p>观察到ebp以后，在另一个windbg中对齐下断：</p>
<pre tabindex="0"><code>bp kernelbase!ReadProcessMemory &#34;.if poi(esp+8)!=0x2dfe38 {gc}&#34;
</code></pre><p>再在之前的windbg运行k命令，即可断下，此时查看调用栈：</p>
<pre tabindex="0"><code>078dc44c 67ad1432 KERNELBASE!ReadProcessMemory
078dc470 678f4fb0 dbgeng!LiveUserDebugServices::ReadVirtual+0x22
078dc4b0 678f4e6c dbgeng!LiveUserTargetInfo::ReadVirtualUncached+0xa0
078dc4d4 67a29116 dbgeng!LiveUserTargetInfo::ReadVirtual+0x3c
078dc500 676c94fe dbgeng!SwReadMemory+0xe6
078dc528 67702d02 dbghelp!DbhStackServices::ReadMemory+0x2e
078dc548 67736cd7 dbghelp!DbsX86WalkFrame::readMemory+0x32
078dc568 677501c8 dbghelp!CDiaStackWalkHelper::readMemory+0x27
078dc5d0 6775058c dbghelp!StackWalkVM::Operator+0x1b8
078dc600 677506ea dbghelp!StackWalkVM::Statement+0x4c
078dc624 677247ce dbghelp!StackWalkVM::next+0x4a
078dc7f4 67749d07 dbghelp!CStackFrameTrav::next+0x6e
078dc80c 6774b294 dbghelp!CFrameDataFrameTrav::next+0x67
078dc850 6774b6ff dbghelp!CStackTrav::next+0x524
078dc864 6773af4a dbghelp!CStackTrav::execute+0x4f
078dcb6c 67708695 dbghelp!CDiaFrameData::execute+0xda
078dcc08 67703787 dbghelp!DbsX86StackUnwinder::ApplyUnwindInfo+0x2f5
078dcc30 67701dde dbghelp!DbsX86StackUnwinder::Unwind+0x187
078dcc40 676e761e dbghelp!DbsStackUnwinder:bhUnwind+0x19e
078dcd40 676e7a24 dbghelp!PickX86Walk+0x17e
078dda10 67a29ee4 dbghelp!StackWalk64+0x154
078de6a4 67a2a52c dbgeng!TargetInfo::GetTargetStackFrames+0x6a4
078de738 679b4ce2 dbgeng!DoStackTrace+0x1cc
078de7bc 679b6369 dbgeng!WrapParseStackCmd+0x162
078de8a0 679b71a9 dbgeng!ProcessCommands+0xad9
078de8e4 678e76c9 dbgeng!ProcessCommandsAndCatch+0x49
078ded7c 678e794a dbgeng!Execute+0x2b9
078dedac 00c090f6 dbgeng!DebugClient::ExecuteWide+0x6a
078dee58 00c09612 windbg!ProcessCommand+0x156
078dfe78 00c0b8f6 windbg!ProcessEngineCommands+0xb2
</code></pre><p>其中dbghelp中使我们最感兴趣的，如果对dbgeng中的函数下断，会发现做了N层循环，每执行一次StackWalk64就会得到一层调用栈。</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// TargetInfo::GetTargetStackFrames：
</span></span><span style="display:flex;"><span><span style="color:#ec0000">for</span> ( i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>; i <span style="color:#ec0000">&lt;</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">24</span>); <span style="color:#ec0000">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v36 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    v35 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    v33 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( g_DebugClrStack )
</span></span><span style="display:flex;"><span>      dprintf(<span style="color:#008900">L</span><span style="color:#008900">&#34;Frame %d</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, i);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      FrameInfo<span style="color:#ec0000">::</span>SetToDefault((FrameInfo <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">152</span> <span style="color:#ec0000">*</span> i));
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">152</span> <span style="color:#ec0000">*</span> i <span style="color:#ec0000">+</span> <span style="color:#008900">132</span>) <span style="color:#ec0000">=</span> i <span style="color:#ec0000">+</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">44</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">20</span>) )
</span></span><span style="display:flex;"><span>      qmemcpy((<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">20</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">0xA70</span> <span style="color:#ec0000">*</span> i), <span style="color:#ec0000">&amp;</span>v104, <span style="color:#008900">0xA70u</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( v39 <span style="color:#ec0000">&amp;&amp;</span> v40 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( v38 <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>ProcessInfo<span style="color:#ec0000">::</span>IsClrMethod(<span style="color:#ec0000">**</span>(ProcessInfo <span style="color:#ec0000">***</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>), v53) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>StackWalk64(
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">**</span>(_DWORD <span style="color:#ec0000">**</span>)(v105 <span style="color:#ec0000">+</span> <span style="color:#008900">44</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">*</span>(HANDLE <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">**</span>(_DWORD <span style="color:#ec0000">**</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">88</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">*</span>(HANDLE <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">40</span>),
</span></span><span style="display:flex;"><span>                (LPSTACKFRAME64)<span style="color:#ec0000">&amp;</span>v49,
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">&amp;</span>v104,
</span></span><span style="display:flex;"><span>                SwReadMemory,
</span></span><span style="display:flex;"><span>                SwFunctionTableAccess,
</span></span><span style="display:flex;"><span>                SwGetModuleBase,
</span></span><span style="display:flex;"><span>                SwTranslateAddress) )
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        v35 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) )
</span></span><span style="display:flex;"><span>        v20 <span style="color:#ec0000">=</span> ProcessClrFrame(
</span></span><span style="display:flex;"><span>                v39,
</span></span><span style="display:flex;"><span>                i,
</span></span><span style="display:flex;"><span>                (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_CROSS_PLATFORM_CONTEXT</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v104,
</span></span><span style="display:flex;"><span>                v40,
</span></span><span style="display:flex;"><span>                (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">FrameInfo</span> <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">152</span> <span style="color:#ec0000">*</span> i),
</span></span><span style="display:flex;"><span>                (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_tagSTACKFRAME64</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v49);
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>        v20 <span style="color:#ec0000">=</span> ProcessClrFrame(v39, i, (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_CROSS_PLATFORM_CONTEXT</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v104, v40, <span style="color:#008900">0</span>, (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_tagSTACKFRAME64</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v49);
</span></span><span style="display:flex;"><span>      v33 <span style="color:#ec0000">=</span> v20;
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( v20 <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v21 <span style="color:#ec0000">=</span> FormatStatusCode(v20);
</span></span><span style="display:flex;"><span>        ErrOut(<span style="color:#008900">L</span><span style="color:#008900">&#34;Managed frame processing failed, %s</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, v21);
</span></span><span style="display:flex;"><span>        v33 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      v36 <span style="color:#ec0000">=</span> v33 <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    v38 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( v33 <span style="color:#ec0000">==</span> <span style="color:#008900">1</span> <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>v40 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>v35
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>StackWalk64(
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">**</span>(_DWORD <span style="color:#ec0000">**</span>)(v105 <span style="color:#ec0000">+</span> <span style="color:#008900">44</span>),
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">*</span>(HANDLE <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">**</span>(_DWORD <span style="color:#ec0000">**</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">88</span>),
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">*</span>(HANDLE <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">40</span>),
</span></span><span style="display:flex;"><span>              (LPSTACKFRAME64)<span style="color:#ec0000">&amp;</span>v49,
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">&amp;</span>v104,
</span></span><span style="display:flex;"><span>              SwReadMemory,
</span></span><span style="display:flex;"><span>              SwFunctionTableAccess,
</span></span><span style="display:flex;"><span>              SwGetModuleBase,
</span></span><span style="display:flex;"><span>              SwTranslateAddress) )
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>      v38 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( i <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">20</span>) )
</span></span><span style="display:flex;"><span>        qmemcpy((<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">20</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">2672</span> <span style="color:#ec0000">*</span> i), <span style="color:#ec0000">&amp;</span>v104, <span style="color:#008900">0xA70u</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( v39 <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>v40 )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) )
</span></span><span style="display:flex;"><span>          v22 <span style="color:#ec0000">=</span> ProcessClrFrame(
</span></span><span style="display:flex;"><span>                  v39,
</span></span><span style="display:flex;"><span>                  i,
</span></span><span style="display:flex;"><span>                  (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_CROSS_PLATFORM_CONTEXT</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v104,
</span></span><span style="display:flex;"><span>                  <span style="color:#008900">0</span>,
</span></span><span style="display:flex;"><span>                  (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">FrameInfo</span> <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">152</span> <span style="color:#ec0000">*</span> i),
</span></span><span style="display:flex;"><span>                  (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_tagSTACKFRAME64</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v49);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>          v22 <span style="color:#ec0000">=</span> ProcessClrFrame(v39, i, (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_CROSS_PLATFORM_CONTEXT</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v104, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>, (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_tagSTACKFRAME64</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v49);
</span></span><span style="display:flex;"><span>        v34 <span style="color:#ec0000">=</span> v22;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( v22 <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v23 <span style="color:#ec0000">=</span> FormatStatusCode(v22);
</span></span><span style="display:flex;"><span>          ErrOut(<span style="color:#008900">L</span><span style="color:#008900">&#34;Managed frame processing failed, %s</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, v23);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        v36 <span style="color:#ec0000">=</span> v34 <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>v36 )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v32 <span style="color:#ec0000">=</span> (UnmanagedFrameInfo <span style="color:#ec0000">*</span>)TypedData<span style="color:#ec0000">::</span><span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x98u</span>, (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">152</span> <span style="color:#ec0000">*</span> i));
</span></span><span style="display:flex;"><span>          v112 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">if</span> ( v32 )
</span></span><span style="display:flex;"><span>            UnmanagedFrameInfo<span style="color:#ec0000">::</span>UnmanagedFrameInfo(v32);
</span></span><span style="display:flex;"><span>          v112 <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">**</span>(_DWORD <span style="color:#ec0000">**</span>)(v105 <span style="color:#ec0000">+</span> <span style="color:#008900">44</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">332</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v24 <span style="color:#ec0000">=</span> <span style="color:#008900">152</span> <span style="color:#ec0000">*</span> i;
</span></span><span style="display:flex;"><span>          v25 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v25 <span style="color:#ec0000">+</span> v24 <span style="color:#ec0000">+</span> <span style="color:#008900">144</span>) <span style="color:#ec0000">=</span> v62;
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v25 <span style="color:#ec0000">+</span> v24 <span style="color:#ec0000">+</span> <span style="color:#008900">148</span>) <span style="color:#ec0000">=</span> v63;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        v26 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">152</span> <span style="color:#ec0000">*</span> i <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v26 <span style="color:#ec0000">=</span> v49;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v26 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> v50;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_QWORD <span style="color:#ec0000">*</span>)(v26 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">=</span> v53;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v26 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">=</span> v54;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v26 <span style="color:#ec0000">+</span> <span style="color:#008900">20</span>) <span style="color:#ec0000">=</span> v55;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v26 <span style="color:#ec0000">+</span> <span style="color:#008900">24</span>) <span style="color:#ec0000">=</span> v58;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v26 <span style="color:#ec0000">+</span> <span style="color:#008900">28</span>) <span style="color:#ec0000">=</span> v59;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_QWORD <span style="color:#ec0000">*</span>)(v26 <span style="color:#ec0000">+</span> <span style="color:#008900">32</span>) <span style="color:#ec0000">=</span> v66;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v26 <span style="color:#ec0000">+</span> <span style="color:#008900">120</span>) <span style="color:#ec0000">=</span> v68;
</span></span><span style="display:flex;"><span>        v27 <span style="color:#ec0000">=</span> v26 <span style="color:#ec0000">+</span> <span style="color:#008900">72</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v27 <span style="color:#ec0000">=</span> v69;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v27 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> v70;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v27 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">=</span> v71;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v27 <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">=</span> v72;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v27 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">=</span> v73;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v27 <span style="color:#ec0000">+</span> <span style="color:#008900">20</span>) <span style="color:#ec0000">=</span> v74;
</span></span><span style="display:flex;"><span>        v28 <span style="color:#ec0000">=</span> v26 <span style="color:#ec0000">+</span> <span style="color:#008900">96</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v28 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v28 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v28 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v28 <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v28 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v28 <span style="color:#ec0000">+</span> <span style="color:#008900">20</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        qmemcpy((<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)(v26 <span style="color:#ec0000">+</span> <span style="color:#008900">40</span>), <span style="color:#ec0000">&amp;</span>v67, <span style="color:#008900">0x20u</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">**</span>(_DWORD <span style="color:#ec0000">**</span>)(v105 <span style="color:#ec0000">+</span> <span style="color:#008900">44</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">512</span> <span style="color:#ec0000">&amp;&amp;</span> v107 <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v107 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">1</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_QWORD <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v49 <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">0xE0000000FFA00000u</span>i64 <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(_QWORD <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v49 <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0xE0000000FFA02000u</span>i64 )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v29 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_QWORD <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v49
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">-</span> __PAIR__(
</span></span><span style="display:flex;"><span>                  <span style="color:#ec0000">-</span><span style="color:#008900">536870912</span> <span style="color:#ec0000">-</span> ((<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v107 <span style="color:#ec0000">+</span> <span style="color:#008900">1408</span>) <span style="color:#ec0000">&gt;</span> <span style="color:#008900">0xFFA00000</span>) <span style="color:#ec0000">+</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v107 <span style="color:#ec0000">+</span> <span style="color:#008900">1412</span>)),
</span></span><span style="display:flex;"><span>                  <span style="color:#ec0000">-</span><span style="color:#008900">6291456</span> <span style="color:#ec0000">-</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v107 <span style="color:#ec0000">+</span> <span style="color:#008900">1408</span>));
</span></span><span style="display:flex;"><span>          v49 <span style="color:#ec0000">-=</span> <span style="color:#ec0000">-</span><span style="color:#008900">6291456</span> <span style="color:#ec0000">-</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v107 <span style="color:#ec0000">+</span> <span style="color:#008900">1408</span>);
</span></span><span style="display:flex;"><span>          v50 <span style="color:#ec0000">=</span> HIDWORD(v29);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( i
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(_QWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">152</span> <span style="color:#ec0000">*</span> (i <span style="color:#ec0000">-</span> <span style="color:#008900">1</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">0xE0000000FFA00000u</span>i64
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(_QWORD <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v49 <span style="color:#ec0000">&lt;</span> <span style="color:#008900">0xE0000000FFA02000u</span>i64 )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v30 <span style="color:#ec0000">=</span> <span style="color:#008900">152</span> <span style="color:#ec0000">*</span> (i <span style="color:#ec0000">-</span> <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>          v31 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v31 <span style="color:#ec0000">+</span> v30 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">=</span> v49;
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v31 <span style="color:#ec0000">+</span> v30 <span style="color:#ec0000">+</span> <span style="color:#008900">20</span>) <span style="color:#ec0000">=</span> v50;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">40</span>) <span style="color:#ec0000">||</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">36</span>) <span style="color:#ec0000">&amp;</span> <span style="color:#008900">0x10</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) )
</span></span><span style="display:flex;"><span>        FrameInfo<span style="color:#ec0000">::</span>OutputFrameOfTrace(
</span></span><span style="display:flex;"><span>          i,
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">24</span>),
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">*</span>(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">FrameInfo</span> <span style="color:#ec0000">**</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>),
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">*</span>(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_CROSS_PLATFORM_CONTEXT</span> <span style="color:#ec0000">**</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">20</span>),
</span></span><span style="display:flex;"><span>          (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_CROSS_PLATFORM_CONTEXT</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v104,
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(a1 <span style="color:#ec0000">+</span> <span style="color:#008900">40</span>),
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">&amp;</span>v106);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>*(_DWORD *)(a1 + 24)正是需要回溯的层数，而且该函数还支持clr(C#)函数回溯，而最重要的操作还是在stackwalk64中，先来看dbghelp的帮助文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>BOOL WINAPI <span style="color:#5f5fff">StackWalk64</span>(
</span></span><span style="display:flex;"><span>  __in          DWORD MachineType,
</span></span><span style="display:flex;"><span>  __in          HANDLE hProcess,
</span></span><span style="display:flex;"><span>  __in          HANDLE hThread,
</span></span><span style="display:flex;"><span>  __in_out      LPSTACKFRAME64 StackFrame,
</span></span><span style="display:flex;"><span>  __in_out      PVOID ContextRecord,
</span></span><span style="display:flex;"><span>  __in          PREAD_PROCESS_MEMORY_ROUTINE64 ReadMemoryRoutine,
</span></span><span style="display:flex;"><span>  __in          PFUNCTION_TABLE_ACCESS_ROUTINE64 FunctionTableAccessRoutine,
</span></span><span style="display:flex;"><span>  __in          PGET_MODULE_BASE_ROUTINE64 GetModuleBaseRoutine,
</span></span><span style="display:flex;"><span>  __in          PTRANSLATE_ADDRESS_ROUTINE64 TranslateAddress
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>// MachineType:处理器类型
</span></span><span style="display:flex;"><span>// IMAGE_FILE_MACHINE_I386 0x014c Intel x86
</span></span><span style="display:flex;"><span>// IMAGE_FILE_MACHINE_IA64 0x0200 Intel Itanium Processor Family (IPF)
</span></span><span style="display:flex;"><span>// IMAGE_FILE_MACHINE_AMD64 0x8664 x64 (AMD64 or EM64T)
</span></span><span style="display:flex;"><span>// hProcess 目标进程句柄
</span></span><span style="display:flex;"><span>// hThread 目标线程句柄
</span></span><span style="display:flex;"><span>// StackFrame 提供一个初始化过得STACKFRAME64，包括eip,ebp,esp等 ，用于迭代得到回溯栈
</span></span><span style="display:flex;"><span>// ContextRecord 提供一个初始化的CONTEXT结构 ，用于非x86架构
</span></span><span style="display:flex;"><span>// ReadMemoryRoutine 读取内存的例程，用于解析栈桢
</span></span><span style="display:flex;"><span>// FunctionTableAccessRoutine 访问运行时函数表的例程，x86下，该函数返回FPO_DATA结构体指针，该函数解析目标地址处函数的栈桢信息
</span></span><span style="display:flex;"><span>// GetModuleBaseRoutine 根据给定虚拟地址求模块基址的例程
</span></span><span style="display:flex;"><span>// TranslateAddress 用于16bit地址翻译例程
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_FPO_DATA</span>
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    DWORD ulOffStart;  <span style="color:#ec0000">函数起始位置</span>
</span></span><span style="display:flex;"><span>    DWORD cbProcSize;  <span style="color:#ec0000">函数大小</span>
</span></span><span style="display:flex;"><span>    DWORD cdwLocals;   <span style="color:#ec0000">局部变量栈大小</span>
</span></span><span style="display:flex;"><span>    WORD cdwParams;    <span style="color:#ec0000">参数个数</span>
</span></span><span style="display:flex;"><span>    WORD <span style="color:#ec0000">cbProlog</span>  :<span style="color:#008900">8</span>; Prolog字节数
</span></span><span style="display:flex;"><span>    WORD <span style="color:#ec0000">cbRegs</span>  :<span style="color:#008900">3</span>;   <span style="color:#ec0000">保存寄存器个数</span>
</span></span><span style="display:flex;"><span>    WORD <span style="color:#ec0000">fHasSEH</span>  :<span style="color:#008900">1</span>;  <span style="color:#ec0000">是否</span>SEH
</span></span><span style="display:flex;"><span>    WORD <span style="color:#ec0000">fUseBP</span>  :<span style="color:#008900">1</span>;   <span style="color:#ec0000">是否使用</span>EBP
</span></span><span style="display:flex;"><span>    WORD <span style="color:#ec0000">reserved</span>  :<span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    WORD <span style="color:#ec0000">cbFrame</span>  :<span style="color:#008900">2</span>;  <span style="color:#ec0000">栈帧类型</span>
</span></span><span style="display:flex;"><span>} FPO_DATA,  <span style="color:#ec0000">*</span>PFPO_DATA
</span></span></code></pre></div><pre tabindex="0"><code>FRAME_FPO 0 FPO frame
FRAME_NONFPO 3 Non-FPO frame
FRAME_TRAP 1 Trap frame
FRAME_TSS 2 TSS frame
</code></pre><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_tagSTACKFRAME64</span> {
</span></span><span style="display:flex;"><span>    ADDRESS64   AddrPC;               // EIP StIIP RIP
</span></span><span style="display:flex;"><span>    ADDRESS64   AddrReturn;           // 返回地址
</span></span><span style="display:flex;"><span>    ADDRESS64   AddrFrame;            // EBP AddrBstore RBP/RDI
</span></span><span style="display:flex;"><span>    ADDRESS64   AddrStack;            // ESP SP RSP
</span></span><span style="display:flex;"><span>    ADDRESS64   AddrBStore;           // RsBSP
</span></span><span style="display:flex;"><span>    PVOID       FuncTableEntry;       //  FPO_DATA 指针
</span></span><span style="display:flex;"><span>    DWORD64     Params[<span style="color:#008900">4</span>];            // 推导函数参数
</span></span><span style="display:flex;"><span>    BOOL        Far;                  // WOW far call
</span></span><span style="display:flex;"><span>    BOOL        Virtual;              // 是否Virtual Frame
</span></span><span style="display:flex;"><span>    DWORD64     Reserved[<span style="color:#008900">3</span>];
</span></span><span style="display:flex;"><span>    KDHELP64    KdHelp;                      //用于内核回调桢
</span></span><span style="display:flex;"><span>} STACKFRAME64, <span style="color:#ec0000">*</span>LPSTACKFRAME64;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">StackWalk64</span>(DWORD MachineType, HANDLE hProcess, HANDLE hThread, LPSTACKFRAME64 StackFrame, PVOID ContextRecord, PREAD_PROCESS_MEMORY_ROUTINE64 ReadMemoryRoutine, PFUNCTION_TABLE_ACCESS_ROUTINE64 FunctionTableAccessRoutine, PGET_MODULE_BASE_ROUTINE64 GetModuleBaseRoutine, PTRANSLATE_ADDRESS_ROUTINE64 TranslateAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  v22 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  DbhStackServices<span style="color:#ec0000">::</span>DbhStackServices(<span style="color:#ec0000">&amp;</span>a2);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( StackFrame )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v13 <span style="color:#ec0000">=</span> hProcess;
</span></span><span style="display:flex;"><span>    v14 <span style="color:#ec0000">=</span> hThread;
</span></span><span style="display:flex;"><span>    dword_31142D0 <span style="color:#ec0000">=</span> MachineType;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( FunctionTableAccessRoutine )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v16 <span style="color:#ec0000">=</span> FunctionTableAccessRoutine;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v16 <span style="color:#ec0000">=</span> FunctionTableAccessRoutineLocal;
</span></span><span style="display:flex;"><span>      v22 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( GetModuleBaseRoutine )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v17 <span style="color:#ec0000">=</span> GetModuleBaseRoutine;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v17 <span style="color:#ec0000">=</span> GetModuleBaseRoutineLocal;
</span></span><span style="display:flex;"><span>      v22 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( ReadMemoryRoutine )
</span></span><span style="display:flex;"><span>      v15 <span style="color:#ec0000">=</span> ReadMemoryRoutine;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>      v15 <span style="color:#ec0000">=</span> (PREAD_PROCESS_MEMORY_ROUTINE64)ReadMemoryRoutineLocal;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( TranslateAddress )
</span></span><span style="display:flex;"><span>      v18 <span style="color:#ec0000">=</span> TranslateAddress;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>      v18 <span style="color:#ec0000">=</span> TranslateAddressRoutineLocal;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>v22 <span style="color:#ec0000">||</span> TrySymInit(hProcess) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      a1 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>      v11 <span style="color:#ec0000">=</span> DbsStackUnwinder<span style="color:#ec0000">::</span>New(
</span></span><span style="display:flex;"><span>              (<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">DbsStackServices</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>a2,
</span></span><span style="display:flex;"><span>              MachineType,
</span></span><span style="display:flex;"><span>              (ACCESS_MODE)StackFrame<span style="color:#ec0000">-&gt;</span>AddrPC.Mode,
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">&amp;</span>v20,
</span></span><span style="display:flex;"><span>              <span style="color:#008900">3200u</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">&amp;</span>a1);
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>v11 )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v19 <span style="color:#ec0000">=</span> DbsStackUnwinder<span style="color:#ec0000">::</span>GetFunctionEntryBytes(a1);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( MachineType <span style="color:#ec0000">==</span> <span style="color:#008900">332</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v11 <span style="color:#ec0000">=</span> PickX86Walk(a1, (DbhStackServices <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>a2, StackFrame, ContextRecord);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span> ( ContextRecord )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v10 <span style="color:#ec0000">=</span> GetTlsPtr();
</span></span><span style="display:flex;"><span>          v11 <span style="color:#ec0000">=</span> DbsStackUnwinder<span style="color:#ec0000">::</span>DbhUnwind(
</span></span><span style="display:flex;"><span>                  a1,
</span></span><span style="display:flex;"><span>                  StackFrame,
</span></span><span style="display:flex;"><span>                  (<span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span>)gApiRevision,
</span></span><span style="display:flex;"><span>                  (<span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>)v10 <span style="color:#ec0000">+</span> <span style="color:#008900">96</span>,
</span></span><span style="display:flex;"><span>                  <span style="color:#008900">800u</span>,
</span></span><span style="display:flex;"><span>                  ContextRecord);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v11 <span style="color:#ec0000">=</span> <span style="color:#008900">0x80070057</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( a1 )
</span></span><span style="display:flex;"><span>        (<span style="color:#ec0000">**</span>(<span style="color:#5f5fff">void</span> (__thiscall <span style="color:#ec0000">***</span>)(DbsStackUnwinder <span style="color:#ec0000">*</span>, _DWORD))a1)(a1, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>      result <span style="color:#ec0000">=</span> v11 <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      result <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    result <span style="color:#ec0000">=</span> error(<span style="color:#008900">0x57u</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>为方便起见，下面的函数只写最简略形式，参数和返回类型后面一步步推导。这里构造了DbhStackServices类，并用传入的参数初始化之，之后用该类生成对应的DbhStackUnwinder类，最后分是否x86分别执行PickX86Walk和DbhUnwind获取回溯信息</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ec0000">class</span> <span style="color:#5f5fff">DbsStackServices</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>//虚表
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG ReadMemory()<span style="color:#ec0000">=</span><span style="color:#008900">0</span>                //+00h  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG GetModuleBase()<span style="color:#ec0000">=</span><span style="color:#008900">0</span>             //+04h  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG GetFunctionEntry()<span style="color:#ec0000">=</span><span style="color:#008900">0</span>          //+08h  
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG GetUnwindInfoFromSymbols      //+0Ch
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG FreeUnwindInfoFromSymbols     //+10h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG TranslateToFlatAddress        //+14h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG GetSegmentDescriptor          //+18h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG Status                        //+1Ch
</span></span><span style="display:flex;"><span>//成员
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>    HANDLE hProcess;                                //+04h
</span></span><span style="display:flex;"><span>    HANDLE hThread;                                //+08h
</span></span><span style="display:flex;"><span>    FARPROC ReadMemoryRoutine;                        //+0Ch
</span></span><span style="display:flex;"><span>    FARPROC FunctionTableAccessRoutine;                //+10h
</span></span><span style="display:flex;"><span>    FARPROC GetModuleBaseRoutine;                //+14h
</span></span><span style="display:flex;"><span>    FARPROC TranslateAddressRoutine;                //+18h
</span></span><span style="display:flex;"><span>    DWORD mem1;                                        //+1Ch
</span></span><span style="display:flex;"><span>    DWORD mem2;                                        //+20h
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">class</span> <span style="color:#5f5fff">DbhStackServices</span><span style="color:#ec0000">:</span>DbsStackServices
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>    DbhStackServices();
</span></span><span style="display:flex;"><span>//虚表覆盖
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG ReadMemory();
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">GetModuleBase</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">GetFunctionEntry</span>();
</span></span><span style="display:flex;"><span>//非虚函数
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">TranslateToFlatAddress</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>而栈回溯对象DbsStackUnwinder为基类，其子类根据处理器不同有五类：(微软做的还是很全面的)</p>
<pre tabindex="0"><code>DbsIa64StackUnwinder        IA64指令集
DbsPpcBeStackUnwinder        PowerPC指令集
DbsX64StackUnwinder        X64指令集
DbsX86StackUnwinder        X86 32bit
DbsX8616StackUnwinder        X86 16bit
DbsArmStackUnwinder        ARM指令集
</code></pre><p>分别重写了基类的Start和UpdateAbstractPointers方法</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ec0000">class</span> <span style="color:#5f5fff">DbsStackUnwinder</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>//虚表
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> <span style="color:#ec0000">~</span>DbsStackUnwinder();                                                //+00h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">Start</span>(CONTEXT<span style="color:#ec0000">*</span> ContextRecord,DWORD ContextSize)                //+04h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG Unwind()<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;                                                        //+08h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">GetContext</span>(CONTEXT<span style="color:#ec0000">*</span> ContextRecord,DWORD ContextSize)                //+0Ch
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG GetUnwindInfo();                                                //+10h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">GetFullUnwindInfoSize</span>();                                        //+14h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">DbhStart</span>(STACKFRAME64 <span style="color:#ec0000">*</span> StackFrame,CONTEXT<span style="color:#ec0000">*</span> ContextRecord)        //+18h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG DbhContinue(STACKFRAME64 <span style="color:#ec0000">*</span> StackFrame,CONTEXT<span style="color:#ec0000">*</span> ContextRecord)        //+1Ch
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG DbhUpdatePreUnwind(STACKFRAME64 <span style="color:#ec0000">*</span> StackFrame);                        //+20h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">DbhUpdatePostUnwind</span>(STACKFRAME64 <span style="color:#ec0000">*</span> StackFrame,LONG status);        //+24h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">SetRestart</span>();                                                        //+28h
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">ClearUnwindDerived</span>();                                                //+2Ch
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">UpdateAbstractPointers</span>()<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;                                        //+30h
</span></span><span style="display:flex;"><span>//普通函数
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">AdjustForNoReturn</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">DbhGetKdHelp</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">DbgSetKdHelp</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">DbgUnwind</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">DbgStackUnwinder</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">FillMemCache</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">FreeUnwindInfo</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">GetFuncitonEntryBytes</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">GetServices</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">InvalidateMemCache</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">PopMemCache</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">PushAndFillMem</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">PushMemCache</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">ReadMemCache</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">SetImlFlags</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">SetInvalidInstructionPointer</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">StartAdjustForNoReturn</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">UnwindNtKernelCallback</span>();
</span></span><span style="display:flex;"><span>    LONG <span style="color:#5f5fff">UpdateCallPointer</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span> <span style="color:#ec0000">operator</span> <span style="color:#5f5fff">delete</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span> <span style="color:#ec0000">operator</span> <span style="color:#5f5fff">new</span>(<span style="color:#5f5fff">int</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span> <span style="color:#ec0000">operator</span> <span style="color:#5f5fff">new</span>(<span style="color:#5f5fff">int</span>,<span style="color:#5f5fff">void</span><span style="color:#ec0000">*</span>,<span style="color:#5f5fff">long</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">class</span> <span style="color:#5f5fff">DeclMemCache</span><span style="color:#ec0000">&lt;</span>T<span style="color:#ec0000">&gt;</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>       <span style="color:#ec0000">~</span>DeclMemCache<span style="color:#ec0000">&lt;</span>T<span style="color:#ec0000">&gt;</span>();
</span></span><span style="display:flex;"><span>       <span style="color:#5f5fff">void</span> <span style="color:#5f5fff">PushAndFill</span>();
</span></span><span style="display:flex;"><span>       <span style="color:#5f5fff">void</span> <span style="color:#5f5fff">Pop</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">static</span> <span style="color:#ec0000">__stdcall</span> LONG <span style="color:#5f5fff">New</span>();
</span></span><span style="display:flex;"><span>//成员变量
</span></span><span style="display:flex;"><span>    DWORD unkonw1;//+004h
</span></span><span style="display:flex;"><span>    DbsStackServices<span style="color:#ec0000">*</span> StackService;//+008h
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span> MachineName;//+00Ch
</span></span><span style="display:flex;"><span>    DWORD MachineType;//+010h
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> ContextSize;//+014h
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> FunctionEntryBytes;//+018h  函数入口构成栈桢的字节数
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> u3;//+01Ch
</span></span><span style="display:flex;"><span>    DWORD <span style="color:#ec0000">??</span>;//+020h
</span></span><span style="display:flex;"><span>    DWORD RegSize;//+024h  机器字长
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> u6;//+028h
</span></span><span style="display:flex;"><span>    BOOL IsVirtualFrame;//+040h
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> ImplFlags;//+044h
</span></span><span style="display:flex;"><span>    CONTEXT<span style="color:#ec0000">*</span> context;//+048h
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> u24;//+04Ch
</span></span><span style="display:flex;"><span>    LONGLONG Xbp;//+050h
</span></span><span style="display:flex;"><span>    LONGLONG RetAddr;//060h
</span></span><span style="display:flex;"><span>    LONGLONG FrameOffset;//070h
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> u25;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> u7;//+090h
</span></span><span style="display:flex;"><span>    KDHELP64 KdHelp;//+098h
</span></span><span style="display:flex;"><span>    LONGLONG StackUpLimit;//+0D0h
</span></span><span style="display:flex;"><span>    LONGLONG StackDownLimit;//+0D8h
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> DbhVersion;//+108h
</span></span><span style="display:flex;"><span>    LONGLONG RsBSP;//+110h
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">class</span> <span style="color:#5f5fff">DbsX86StackUnwinder</span><span style="color:#ec0000">:</span>DbsStackUnwinder
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>    DbsX86StackUnwinder(DbsStackServices<span style="color:#ec0000">*</span> StackService)<span style="color:#ec0000">:</span>DbsStackUnwinder(StackService,<span style="color:#008900">&#34;X86&#34;</span>, <span style="color:#008900">332</span>, <span style="color:#008900">204</span>, <span style="color:#008900">16</span>, <span style="color:#008900">0</span>, <span style="color:#008900">8</span>, <span style="color:#008900">4</span>, <span style="color:#008900">1</span>){...}
</span></span><span style="display:flex;"><span>//成员变量
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>    DWORD Dr0;//+11Ch
</span></span><span style="display:flex;"><span>    DWORD Dr1;//+120h
</span></span><span style="display:flex;"><span>    DWORD Dr2;//+124h
</span></span><span style="display:flex;"><span>    DWORD Dr3;//+128h
</span></span><span style="display:flex;"><span>    DWORD Dr6;//+12Ch
</span></span><span style="display:flex;"><span>    DWORD Dr7;//+130h
</span></span><span style="display:flex;"><span>    DWORD SegGs;//+1A4h
</span></span><span style="display:flex;"><span>    DWORD SegFs;//+1A8h
</span></span><span style="display:flex;"><span>    DWORD SegEs;//+1ACh
</span></span><span style="display:flex;"><span>    DWORD SegDs;//+1B0h
</span></span><span style="display:flex;"><span>    DWORD _Edi;//+1B4h
</span></span><span style="display:flex;"><span>    DWORD _Esi;//+1B8h
</span></span><span style="display:flex;"><span>    DWORD _Ebx;//+1BCh
</span></span><span style="display:flex;"><span>    DWORD _Edx;//+1C0h
</span></span><span style="display:flex;"><span>    DWORD _Ecx;//+1C4h
</span></span><span style="display:flex;"><span>    DWORD _Eax;//+1C8h
</span></span><span style="display:flex;"><span>    DWORD _Ebp;//+1CCh
</span></span><span style="display:flex;"><span>    DWORD _Eip;//+1D0h
</span></span><span style="display:flex;"><span>    DWORD SegCs;//+1D4h
</span></span><span style="display:flex;"><span>    DWORD EFlags;//+1D8h
</span></span><span style="display:flex;"><span>    DWORD _Esp;//+1DCh
</span></span><span style="display:flex;"><span>    DWORD SegSs;//+1E0h
</span></span><span style="display:flex;"><span>    ;//+1E8h
</span></span><span style="display:flex;"><span>    DWORD ARGS1;//+1ECh
</span></span><span style="display:flex;"><span>    _FPO_DATA<span style="color:#ec0000">*</span> Fpo;//+204h
</span></span><span style="display:flex;"><span>    DWORD ARGS2;//+20Ch
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> u133;//+214h DbsX86StackUnwinder::ForceEbpRegion *
</span></span><span style="display:flex;"><span>    DWORD u1;//+3C8h
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>部分实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>LONG <span style="color:#5f5fff">New</span>(DbsStackServices<span style="color:#ec0000">*</span> StackService,DWORD MachineType,ACCESS_MODE AccessMode,DbsStackUnwinder<span style="color:#ec0000">**</span> OutPtr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">switch</span>(MachineType)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">0x1F2</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>OutPtr <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> DbsPpcBeStackUnwinder(StackService);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">IMAGE_FILE_MACHINE_IA64</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>OutPtr <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> DbsIa64StackUnwinder(StackService);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">IMAGE_FILE_MACHINE_AMD64</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>OutPtr <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> DbsX64StackUnwinder(StackService);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">IMAGE_FILE_MACHINE_ARM</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">IMAGE_FILE_MACHINE_THUMB</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#008900">0x1C4</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>OutPtr <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> DbsArmStackUnwinder(StackService);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">case</span> <span style="color:#ec0000">IMAGE_FILE_MACHINE_I386</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">switch</span>(AccessMode)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">AddrModeFlat</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">*</span>OutPtr <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> DbsX86StackUnwinder(StackService);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">case</span> <span style="color:#ec0000">AddrMode1616</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">*</span>OutPtr <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> DbsX8616StackUnwinder(StackService);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>OutPtr <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> DbsX86StackUnwinder(StackService);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>LONG <span style="color:#5f5fff">DbhUnwind</span>(STACKFRAME64 <span style="color:#ec0000">*</span> StackFrame,CONTEXT<span style="color:#ec0000">*</span> ContextRecord)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    LONG status;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(StackFrame<span style="color:#ec0000">-&gt;</span>Virtual)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        IsVirtualFrame <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>        status<span style="color:#ec0000">=</span>DbhContinue(StackFrame,ContextRecord);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(status)
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>        status<span style="color:#ec0000">=</span>Unwind();
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(status)
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>        status<span style="color:#ec0000">=</span>GetContext(ContextRecord,u6);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(status)
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        status<span style="color:#ec0000">=</span>DbhStart(StackFrame,ContextRecord);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(status)
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    memset(StackFrame<span style="color:#ec0000">-&gt;</span>Params,<span style="color:#008900">0</span>,<span style="color:#ec0000">sizeof</span>(StackFrame<span style="color:#ec0000">-&gt;</span>Params));
</span></span><span style="display:flex;"><span>    status<span style="color:#ec0000">=</span>DbhUpdatePreUnwind(StackFrame);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(status)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>    status<span style="color:#ec0000">=</span>Unwind();
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(status)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        u24<span style="color:#ec0000">=</span>u25<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    status<span style="color:#ec0000">=</span>DbhUpdatePostUnwind(StackFrame,status);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LONG <span style="color:#5f5fff">DbhGetKdHelp</span>(STACKFRAME64<span style="color:#ec0000">*</span> StackFrame)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    memcpy(<span style="color:#ec0000">&amp;</span>KdHelp,<span style="color:#ec0000">&amp;</span>StackFrame<span style="color:#ec0000">-&gt;</span>KdHelp,<span style="color:#ec0000">sizeof</span>(KdHelp));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">Start</span>(CONTEXT<span style="color:#ec0000">*</span> ContextRecord,DWORD ContextSize)//+04h
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(context <span style="color:#ec0000">&amp;&amp;</span> ContextSize <span style="color:#ec0000">&gt;=</span> <span style="color:#ec0000">this</span><span style="color:#ec0000">-&gt;</span>ContextSize)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        memcpy(context,ContextRecord,<span style="color:#ec0000">this</span><span style="color:#ec0000">-&gt;</span>ContextSize);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">GetContext</span>(CONTEXT<span style="color:#ec0000">*</span> ContextRecord,DWORD ContextSize)//+0Ch
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(context <span style="color:#ec0000">&amp;&amp;</span> ContextSize <span style="color:#ec0000">&gt;=</span> <span style="color:#ec0000">this</span><span style="color:#ec0000">-&gt;</span>ContextSize)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        memcpy(ContextRecord,context,<span style="color:#ec0000">this</span><span style="color:#ec0000">-&gt;</span>ContextSize);
</span></span><span style="display:flex;"><span>        SetRestart();
</span></span><span style="display:flex;"><span>        UpdateAbstractPointers();
</span></span><span style="display:flex;"><span>        UpdateCallPointer();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">DbhStart</span>(STACKFRAME64 <span style="color:#ec0000">*</span> StackFrame,CONTEXT<span style="color:#ec0000">*</span> ContextRecord)//+18h
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DbhGetKdHelp(StackFrame))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        memset(<span style="color:#ec0000">&amp;</span>StackFrame<span style="color:#ec0000">-&gt;</span>AddrBStore,<span style="color:#008900">0</span>,<span style="color:#ec0000">sizeof</span>(StackFrame<span style="color:#ec0000">-&gt;</span>AddrBStore));
</span></span><span style="display:flex;"><span>        memset(<span style="color:#ec0000">&amp;</span>StackFrame<span style="color:#ec0000">-&gt;</span>AddrReturn,<span style="color:#008900">0</span>,<span style="color:#ec0000">sizeof</span>(StackFrame<span style="color:#ec0000">-&gt;</span>AddrReturn));
</span></span><span style="display:flex;"><span>        StackFrame<span style="color:#ec0000">-&gt;</span>FuncTableEntry<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        memset(StackFrame<span style="color:#ec0000">-&gt;</span>Params,<span style="color:#008900">0</span>,<span style="color:#ec0000">sizeof</span>(StackFrame<span style="color:#ec0000">-&gt;</span>Params));
</span></span><span style="display:flex;"><span>        StackFrame<span style="color:#ec0000">-&gt;</span>Virtual<span style="color:#ec0000">=</span>TRUE;
</span></span><span style="display:flex;"><span>        memset(StackFrame<span style="color:#ec0000">-&gt;</span>Reserved,<span style="color:#008900">0</span>,<span style="color:#ec0000">sizeof</span>(StackFrame<span style="color:#ec0000">-&gt;</span>Reserved));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ec0000">virtual</span> LONG <span style="color:#5f5fff">DbhContinue</span>(STACKFRAME64 <span style="color:#ec0000">*</span> StackFrame,CONTEXT<span style="color:#ec0000">*</span> ContextRecord)//+1Ch
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>DbhGetKdHelp(StackFrame))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        LONG status<span style="color:#ec0000">=</span>Start(ContextRecord,ContextSize);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD gApiRevision <span style="color:#ec0000">=</span> <span style="color:#008900">5</span>;
</span></span><span style="display:flex;"><span>DWORD g_ForceLopWalk;
</span></span><span style="display:flex;"><span>DWORD g_AllowLopSymInfo;
</span></span><span style="display:flex;"><span>DWORD g_AllowLopRetSearch;
</span></span><span style="display:flex;"><span>DWORD g_AllowLopWalk;
</span></span><span style="display:flex;"><span>DWORD g_AllowVc7Fpo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD g_NumForceEbpRegions;
</span></span><span style="display:flex;"><span>DWORD<span style="color:#ec0000">*</span> g_ForceEbpRegions;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">enum</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    AllowVc7Fpo<span style="color:#ec0000">=</span><span style="color:#008900">0x1</span>,
</span></span><span style="display:flex;"><span>    AllowLopWalk<span style="color:#ec0000">=</span><span style="color:#008900">0x2</span>,
</span></span><span style="display:flex;"><span>    AllowLopSymInfo<span style="color:#ec0000">=</span><span style="color:#008900">0x4</span>,
</span></span><span style="display:flex;"><span>    AllowLopRetSearch<span style="color:#ec0000">=</span><span style="color:#008900">0x8</span>,
</span></span><span style="display:flex;"><span>    ForceLopWalk<span style="color:#ec0000">=</span><span style="color:#008900">0x10</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LRESULT WINAPI <span style="color:#5f5fff">PickX86Walk</span>(DbsStackUnwinder<span style="color:#ec0000">*</span> pStackUnwinder,DbsStackServices<span style="color:#ec0000">*</span> pStackServices,LPSTACKFRAME64 pInitStackFrame,LPCONTEXT ContextRecord)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    CONTEXT Context;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>ContextRecord)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        RtlZeroMemory(<span style="color:#ec0000">&amp;</span>Context,<span style="color:#008900">0</span>,<span style="color:#ec0000">sizeof</span>(CONTEXT));
</span></span><span style="display:flex;"><span>        Context.Eip <span style="color:#ec0000">=</span> pInitStackFrame<span style="color:#ec0000">-&gt;</span>AddrPC.Offset;
</span></span><span style="display:flex;"><span>        Context.Esp <span style="color:#ec0000">=</span> pInitStackFrame<span style="color:#ec0000">-&gt;</span>AddrStack.Offset;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(LODWORD(pInitStackFrame<span style="color:#ec0000">-&gt;</span>Reserved[<span style="color:#008900">0</span>]) <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> HIDWORD(pInitStackFrame<span style="color:#ec0000">-&gt;</span>Reserved[<span style="color:#008900">0</span>]) <span style="color:#ec0000">==</span> <span style="color:#008900">0xEB</span>)
</span></span><span style="display:flex;"><span>            Context.Ebp <span style="color:#ec0000">=</span> pInitStackFrame<span style="color:#ec0000">-&gt;</span>Reserved[<span style="color:#008900">0</span>];
</span></span><span style="display:flex;"><span>        ContextRecord <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>Context;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    LRESULT status;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(pInitStackFrame<span style="color:#ec0000">-&gt;</span>AddrPC.Mode <span style="color:#ec0000">=</span> AddrModeFlat)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        pStackService<span style="color:#ec0000">-&gt;</span>IsFlatMode <span style="color:#ec0000">=</span> <span style="color:#ec0000">true</span>;
</span></span><span style="display:flex;"><span>        pStackUnwinder<span style="color:#ec0000">-&gt;</span>SetImplFlags((g_ForceLopWalk<span style="color:#ec0000">?</span><span style="color:#008900">0x10</span><span style="color:#ec0000">:</span><span style="color:#008900">0</span>)<span style="color:#ec0000">|</span>(g_AllowLopRetSearch<span style="color:#ec0000">?</span><span style="color:#008900">8</span><span style="color:#ec0000">:</span><span style="color:#008900">0</span>)<span style="color:#ec0000">|</span>(g_AllowLopSymInfo<span style="color:#ec0000">?</span><span style="color:#008900">4</span><span style="color:#ec0000">:</span><span style="color:#008900">0</span>)<span style="color:#ec0000">|</span>
</span></span><span style="display:flex;"><span>            (g_AllowLopWalk<span style="color:#ec0000">?</span><span style="color:#008900">2</span><span style="color:#ec0000">:</span><span style="color:#008900">0</span>)<span style="color:#ec0000">|</span>(g_AllowVc7Fpo<span style="color:#ec0000">?</span><span style="color:#008900">1</span><span style="color:#ec0000">:</span><span style="color:#008900">0</span>));
</span></span><span style="display:flex;"><span>        pStackUnwinder<span style="color:#ec0000">-&gt;</span>SetForceEbpRegions(g_NumForceEbpRegions,g_ForceEbpRegions);
</span></span><span style="display:flex;"><span>        status <span style="color:#ec0000">=</span> pStackUnwinder<span style="color:#ec0000">-&gt;</span>DbhUnwind(pInitStackFrame,gApiRevision,TlsData.info,<span style="color:#ec0000">sizeof</span>(TlsData.info),ContextRecord);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>status)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(g_ForceLopWalk <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>g_AllowLopSymInfo)
</span></span><span style="display:flex;"><span>                pInitStackFrame<span style="color:#ec0000">-&gt;</span>FuncTableEntry <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                pInitStackFrame<span style="color:#ec0000">-&gt;</span>FuncTableEntry <span style="color:#ec0000">=</span> pStackService<span style="color:#ec0000">-&gt;</span>FunctionTableAccessRoutine(pStackService<span style="color:#ec0000">-&gt;</span>hProcess,
</span></span><span style="display:flex;"><span>                    pInitStackFrame<span style="color:#ec0000">-&gt;</span>AddrPC.Offset,pInitStackFrame<span style="color:#ec0000">-&gt;</span>AddrPC.Offset);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        status <span style="color:#ec0000">=</span> pStackUnwinder<span style="color:#ec0000">-&gt;</span>DbhUnwind(pInitStackFrame,gApiRevision,TlsData.info,<span style="color:#ec0000">sizeof</span>(TlsData.info),ContextRecord);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PFUNCTION_TABLE_ACCESS_ROUTINE64 FunctionTableAccessRoutineLocal;
</span></span><span style="display:flex;"><span>PGET_MODULE_BASE_ROUTINE64 GetModuleBaseRoutineLocal;
</span></span><span style="display:flex;"><span>PREAD_PROCESS_MEMORY_ROUTINE64 ReadMemoryRoutineLocal;
</span></span><span style="display:flex;"><span>PTRANSLATE_ADDRESS_ROUTINE64 TranslateAddressRoutineLocal;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL WINAPI <span style="color:#5f5fff">StackWalk64</span>(
</span></span><span style="display:flex;"><span>    DWORD MachineType,
</span></span><span style="display:flex;"><span>    HANDLE hProcess,
</span></span><span style="display:flex;"><span>    HANDLE hThread,
</span></span><span style="display:flex;"><span>    LPSTACKFRAME64 StackFrame,
</span></span><span style="display:flex;"><span>    LPCONTEXT ContextRecord,
</span></span><span style="display:flex;"><span>    PREAD_PROCESS_MEMORY_ROUTINE64 ReadMemoryRoutine,
</span></span><span style="display:flex;"><span>    PFUNCTION_TABLE_ACCESS_ROUTINE64 FunctionTableAccessRoutine,
</span></span><span style="display:flex;"><span>    PGET_MODULE_BASE_ROUTINE64 GetModuleBaseRoutine,
</span></span><span style="display:flex;"><span>    PTRANSLATE_ADDRESS_ROUTINE64 TranslateAddress
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    BOOL UseDefault <span style="color:#ec0000">=</span> FALSE,NeedInnerFunc <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>    DbhStackServices StackServices;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>StackFrame)
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>    StackServices.hProcess <span style="color:#ec0000">=</span> hProcess;
</span></span><span style="display:flex;"><span>    StackServices.hThread <span style="color:#ec0000">=</span> hThread;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(FunctionTableAccessRoutine)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        StackServices.FunctionTableAccessRoutine <span style="color:#ec0000">=</span> FunctionTableAccessRoutine;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        StackServices.FunctionTableAccessRoutine <span style="color:#ec0000">=</span> FunctionTableAccessRoutineLocal;
</span></span><span style="display:flex;"><span>        NeedInnerFunc <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(GetModuleBaseRoutine)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        StackServices.GetModuleBaseRoutine <span style="color:#ec0000">=</span> GetModuleBaseRoutine;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        StackServices.GetModuleBaseRoutine <span style="color:#ec0000">=</span> GetModuleBaseRoutineLocal;
</span></span><span style="display:flex;"><span>        NeedInnerFunc <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(ReadMemoryRoutine)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        StackServices.ReadMemoryRoutine <span style="color:#ec0000">=</span> ReadMemoryRoutine;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        StackServices.ReadMemoryRoutine <span style="color:#ec0000">=</span> ReadMemoryRoutineLocal;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(TranslateAddress)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        StackServices.TranslateAddress <span style="color:#ec0000">=</span> TranslateAddress;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        StackServices.TranslateAddress <span style="color:#ec0000">=</span> TranslateAddressRoutineLocal;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>NeedInnerFunc)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        DbsStackUnwinder<span style="color:#ec0000">*</span> StackUnwinder <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>        LRESULT status;
</span></span><span style="display:flex;"><span>        status <span style="color:#ec0000">=</span> DbsStackUnwinder<span style="color:#ec0000">::</span>New(<span style="color:#ec0000">&amp;</span>StackService,MachineType,StackFrame<span style="color:#ec0000">-&gt;</span>AddrPC.Mode,<span style="color:#ec0000">&amp;</span>StackUnwinder);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>status)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            StackService.FpoDataSize <span style="color:#ec0000">=</span> StackUnwinder<span style="color:#ec0000">-&gt;</span>GetFunctionEntryBytes();
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(MachineType <span style="color:#ec0000">==</span> IMAGE_FILE_MACHINE_I386)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                PickX86Walk(StackUnwinder,<span style="color:#ec0000">&amp;</span>StackService,StackFrame,ContextRecord);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span>(ContextRecord)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                StackUnwinder<span style="color:#ec0000">-&gt;</span>DbhUnwind(StackFrame,gApiRevision,TlsData.info,<span style="color:#ec0000">sizeof</span>(TlsData.info),ContextRecord);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(StackUnwinder)
</span></span><span style="display:flex;"><span>            StackUnwinder<span style="color:#ec0000">-&gt;~</span>DbsStackUnwinder();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    
  </div>

  


  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/win_posts/20150726_wow/">
                        探究为何32位程序无法远程注入64位程序
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
            <div class="single-pagination-container-next">
                <div class="single-pagination-text">
                    <a href="/win_posts/20151116_ntdll_staticlib/">
                        提取动态链接库ntdll的函数到静态lib
                    </a>
                </div>
                <div class="single-pagination-text">→</div>
            </div>
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


      </main>
    </div>

    <footer>
      

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    



    </footer>
    
  </body>

  <script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

</html>