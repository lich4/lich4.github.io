<!DOCTYPE html>
<html lang="zh-CN"
  dir="ltr">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://lich4.github.io//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://lich4.github.io//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://lich4.github.io//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://lich4.github.io//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://lich4.github.io//apple-touch-icon.png">

<meta name="description" content=""/>

<title>
    
    强删正在运行文件 | 超哥的博客
    
</title>

<link rel="canonical" href="https://lich4.github.io/win_posts/20150526_force_del_file/"/>












<link rel="stylesheet" href="/assets/combined.min.cbcb816aefdb3b7380c5921cbb3b89d12f07742cb3f869754adb56da84f0d729.css" media="all">









  </head>

  

  
  
  

  <body class="light">

    <div class="content">
      <header>
        

<div class="header">

    

</div>

      </header>

      <main class="main">
        





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a href="/win_posts/">Win_posts</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a class="breadcrumbs-current" href="/win_posts/20150526_force_del_file/">强删正在运行文件</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">强删正在运行文件</h1>
    
    <p class="single-summary">强删正在运行文件</p>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2015-05-26T00:00:00&#43;00:00">May 26, 2015</time>
      

      
    </p>

  </div>

  

  
  
  

  

  
  <aside class="toc">
    <p><strong>Table of contents</strong></p>
    <nav id="TableOfContents"></nav>
  </aside>
  

  

  <div class="single-content">
    <p>  随便运行一个exe文件，，在它运行时进行删除操作，基本上会得到一个 无法删除的错误，下面我们就来破解这个限制。源码<code>DeleteFile -&gt; NtSetInformationFile FileInformationClass = FileDispositionInformation</code>，函数结构如下：（参考wrk）</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>	CurrentThread <span style="color:#ec0000">=</span> <span style="color:#5f5fff">PsGetCurrentThread</span>();
</span></span><span style="display:flex;"><span>	requestorMode <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeGetPreviousModeByThread</span>(<span style="color:#ec0000">&amp;</span>CurrentThread<span style="color:#ec0000">-&gt;</span>Tcb);
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(FileHandle,
</span></span><span style="display:flex;"><span>		IopQueryOperationAccess[FileInformationClass],IoFileObjectType,
</span></span><span style="display:flex;"><span>		requestorMode,(PVOID <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>fileObject,<span style="color:#ec0000">&amp;</span>handleInformation);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>(fileObject<span style="color:#ec0000">-&gt;</span>Flags <span style="color:#ec0000">&amp;</span> FO_DIRECT_DEVICE_OPEN)) {
</span></span><span style="display:flex;"><span>		deviceObject <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoGetRelatedDeviceObject</span>(fileObject);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> {
</span></span><span style="display:flex;"><span>		deviceObject <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoGetAttachedDevice</span>(fileObject<span style="color:#ec0000">-&gt;</span>DeviceObject);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fastIoDispatch <span style="color:#ec0000">=</span> deviceObject<span style="color:#ec0000">-&gt;</span>DriverObject<span style="color:#ec0000">-&gt;</span>FastIoDispatch;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (fileObject<span style="color:#ec0000">-&gt;</span>Flags <span style="color:#ec0000">&amp;</span> FO_SYNCHRONOUS_IO) {
</span></span><span style="display:flex;"><span>		BOOLEAN interrupted;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span><span style="color:#5f5fff">IopAcquireFastLock</span>(fileObject)) {
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IopAcquireFileObjectLock</span>(fileObject,
</span></span><span style="display:flex;"><span>				requestorMode,
</span></span><span style="display:flex;"><span>				(BOOLEAN)((fileObject<span style="color:#ec0000">-&gt;</span>Flags <span style="color:#ec0000">&amp;</span> FO_ALERTABLE_IO) <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span>),
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">&amp;</span>interrupted);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span> (interrupted) {
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ObDereferenceObject</span>(fileObject);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		event <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool, <span style="color:#ec0000">sizeof</span>(KEVENT));
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> (event <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ObDereferenceObject</span>(fileObject);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> STATUS_INSUFFICIENT_RESOURCES;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">KeInitializeEvent</span>(event, SynchronizationEvent, FALSE);
</span></span><span style="display:flex;"><span>		synchronousIo <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">KeClearEvent</span>(<span style="color:#ec0000">&amp;</span>fileObject<span style="color:#ec0000">-&gt;</span>Event);
</span></span><span style="display:flex;"><span>	irp <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoAllocateIrp</span>(deviceObject<span style="color:#ec0000">-&gt;</span>StackSize, FALSE);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>irp) {
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>(fileObject<span style="color:#ec0000">-&gt;</span>Flags <span style="color:#ec0000">&amp;</span> FO_SYNCHRONOUS_IO)) {
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">ExFreePool</span>(event);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">IopAllocateIrpCleanup</span>(fileObject, (PKEVENT)<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> STATUS_INSUFFICIENT_RESOURCES;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	irp<span style="color:#ec0000">-&gt;</span>Tail.Overlay.OriginalFileObject <span style="color:#ec0000">=</span> fileObject;
</span></span><span style="display:flex;"><span>	irp<span style="color:#ec0000">-&gt;</span>Tail.Overlay.Thread <span style="color:#ec0000">=</span> CurrentThread;
</span></span><span style="display:flex;"><span>	irp<span style="color:#ec0000">-&gt;</span>RequestorMode <span style="color:#ec0000">=</span> requestorMode;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (synchronousIo) {
</span></span><span style="display:flex;"><span>		irp<span style="color:#ec0000">-&gt;</span>UserEvent <span style="color:#ec0000">=</span> (PKEVENT)<span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>		irp<span style="color:#ec0000">-&gt;</span>UserIosb <span style="color:#ec0000">=</span> IoStatusBlock;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span> {
</span></span><span style="display:flex;"><span>		irp<span style="color:#ec0000">-&gt;</span>UserEvent <span style="color:#ec0000">=</span> event;
</span></span><span style="display:flex;"><span>		irp<span style="color:#ec0000">-&gt;</span>UserIosb <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>localIoStatus;
</span></span><span style="display:flex;"><span>		irp<span style="color:#ec0000">-&gt;</span>Flags <span style="color:#ec0000">=</span> IRP_SYNCHRONOUS_API;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	irp<span style="color:#ec0000">-&gt;</span>Overlay.AsynchronousParameters.UserApcRoutine <span style="color:#ec0000">=</span> (PIO_APC_ROUTINE)<span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	irpSp <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoGetNextIrpStackLocation</span>(irp);
</span></span><span style="display:flex;"><span>	irpSp<span style="color:#ec0000">-&gt;</span>MajorFunction <span style="color:#ec0000">=</span> IRP_MJ_SET_INFORMATION;
</span></span><span style="display:flex;"><span>	irpSp<span style="color:#ec0000">-&gt;</span>FileObject <span style="color:#ec0000">=</span> fileObject;
</span></span><span style="display:flex;"><span>	irp<span style="color:#ec0000">-&gt;</span>UserBuffer <span style="color:#ec0000">=</span> FileInformation;
</span></span><span style="display:flex;"><span>	irp<span style="color:#ec0000">-&gt;</span>AssociatedIrp.SystemBuffer <span style="color:#ec0000">=</span> (PVOID)<span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	irp<span style="color:#ec0000">-&gt;</span>MdlAddress <span style="color:#ec0000">=</span> (PMDL)<span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	try {
</span></span><span style="display:flex;"><span>		irp<span style="color:#ec0000">-&gt;</span>AssociatedIrp.SystemBuffer <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ExAllocatePoolWithQuota</span>(NonPagedPool,
</span></span><span style="display:flex;"><span>			Length);
</span></span><span style="display:flex;"><span>	} <span style="color:#5f5fff">except</span>(EXCEPTION_EXECUTE_HANDLER) {
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">IopExceptionCleanup</span>(fileObject,
</span></span><span style="display:flex;"><span>			irp,
</span></span><span style="display:flex;"><span>			(PKEVENT)<span style="color:#ec0000">NULL</span>,
</span></span><span style="display:flex;"><span>			event);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span> <span style="color:#5f5fff">GetExceptionCode</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	irp<span style="color:#ec0000">-&gt;</span>Flags <span style="color:#ec0000">|=</span> IRP_BUFFERED_IO <span style="color:#ec0000">|</span>
</span></span><span style="display:flex;"><span>		IRP_DEALLOCATE_BUFFER <span style="color:#ec0000">|</span>
</span></span><span style="display:flex;"><span>		IRP_INPUT_OPERATION <span style="color:#ec0000">|</span>
</span></span><span style="display:flex;"><span>		IRP_DEFER_IO_COMPLETION;
</span></span><span style="display:flex;"><span>	irpSp<span style="color:#ec0000">-&gt;</span>Parameters.QueryFile.Length <span style="color:#ec0000">=</span> Length;
</span></span><span style="display:flex;"><span>	irpSp<span style="color:#ec0000">-&gt;</span>Parameters.QueryFile.FileInformationClass <span style="color:#ec0000">=</span> FileInformationClass;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">IopQueueThreadIrp</span>(irp);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">IopUpdateOtherOperationCount</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (FileInformationClass <span style="color:#ec0000">==</span> FileDispositionInformation){
</span></span><span style="display:flex;"><span>		PFILE_DISPOSITION_INFORMATION disposition <span style="color:#ec0000">=</span> irp<span style="color:#ec0000">-&gt;</span>AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> (disposition<span style="color:#ec0000">-&gt;</span>DeleteFile) {
</span></span><span style="display:flex;"><span>			irpSp<span style="color:#ec0000">-&gt;</span>Parameters.SetFile.DeleteHandle <span style="color:#ec0000">=</span> FileHandle;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoCallDriver</span>(deviceObject, irp);
</span></span><span style="display:flex;"><span>windbg查看deviceObject内存<span style="color:#ec0000">，得到</span>driverObject内存<span style="color:#ec0000">，发现</span>Call的Driver是<span style="color:#ec0000">\</span>FileSystem<span style="color:#ec0000">\</span>Ntfs<span style="color:#ec0000">，</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">现在反汇编该文件查看</span>IRP_MJ_SET_INFORMATION派遣<span style="color:#ec0000">，用</span>windbg下断<span style="color:#ec0000">：</span>Ntfs<span style="color:#ec0000">!</span>NtfsFsdSetInformation
</span></span><span style="display:flex;"><span>NtfsFsdSetInformation<span style="color:#ec0000">-&gt;</span>NtfsCommonSetInformation<span style="color:#ec0000">-&gt;</span><span style="color:#ec0000">NtfsSetDispositionInfo</span>:
</span></span><span style="display:flex;"><span>nt<span style="color:#ec0000">!</span>MmFlushImageSection  <span style="color:#ec0000">该函数返回空</span> <span style="color:#ec0000">-&gt;</span>
</span></span><span style="display:flex;"><span>nt<span style="color:#ec0000">!</span>MiCheckControlAreaStatus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">MmFlushImageSection</span> (__in PSECTION_OBJECT_POINTERS SectionPointer,__in MMFLUSH_TYPE FlushType)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PLIST_ENTRY Next;
</span></span><span style="display:flex;"><span>    PCONTROL_AREA ControlArea;
</span></span><span style="display:flex;"><span>    PLARGE_CONTROL_AREA LargeControlArea;
</span></span><span style="display:flex;"><span>    KIRQL OldIrql;
</span></span><span style="display:flex;"><span>    LOGICAL state;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (FlushType <span style="color:#ec0000">==</span> MmFlushForDelete) {
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">LOCK_PFN</span> (OldIrql);
</span></span><span style="display:flex;"><span>        ControlArea <span style="color:#ec0000">=</span> (PCONTROL_AREA)(SectionPointer<span style="color:#ec0000">-&gt;</span>DataSectionObject);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (ControlArea <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> ((ControlArea<span style="color:#ec0000">-&gt;</span>NumberOfUserReferences <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span>) <span style="color:#ec0000">||</span>
</span></span><span style="display:flex;"><span>                (ControlArea<span style="color:#ec0000">-&gt;</span>u.Flags.BeingCreated)) {
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">UNLOCK_PFN</span> (OldIrql);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">UNLOCK_PFN</span> (OldIrql);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    state <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MiCheckControlAreaStatus</span> (CheckImageSection,SectionPointer,FALSE,<span style="color:#ec0000">&amp;</span>ControlArea,<span style="color:#ec0000">&amp;</span>OldIrql);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (ControlArea <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> (BOOLEAN) state;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">do</span> {
</span></span><span style="display:flex;"><span>        ControlArea<span style="color:#ec0000">-&gt;</span>u.Flags.BeingDeleted <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        ControlArea<span style="color:#ec0000">-&gt;</span>NumberOfMappedViews <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        LargeControlArea <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (ControlArea<span style="color:#ec0000">-&gt;</span>u.Flags.GlobalOnlyPerSession <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>) {
</span></span><span style="display:flex;"><span>            NOTHING;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span> (<span style="color:#5f5fff">IsListEmpty</span>(<span style="color:#ec0000">&amp;</span>((PLARGE_CONTROL_AREA)ControlArea)<span style="color:#ec0000">-&gt;</span>UserGlobalList)) {
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">ASSERT</span> (ControlArea <span style="color:#ec0000">==</span>(PCONTROL_AREA)SectionPointer<span style="color:#ec0000">-&gt;</span>ImageSectionObject);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">ASSERT</span> (ControlArea<span style="color:#ec0000">-&gt;</span>u.Flags.GlobalOnlyPerSession <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>            Next <span style="color:#ec0000">=</span> ((PLARGE_CONTROL_AREA)ControlArea)<span style="color:#ec0000">-&gt;</span>UserGlobalList.Flink;
</span></span><span style="display:flex;"><span>            LargeControlArea <span style="color:#ec0000">=</span> <span style="color:#5f5fff">CONTAINING_RECORD</span> (Next,LARGE_CONTROL_AREA,UserGlobalList);
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">ASSERT</span> (LargeControlArea<span style="color:#ec0000">-&gt;</span>u.Flags.GlobalOnlyPerSession <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>            LargeControlArea<span style="color:#ec0000">-&gt;</span>NumberOfSectionReferences <span style="color:#ec0000">+=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">UNLOCK_PFN</span> (OldIrql);
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">MiCleanSection</span> (ControlArea, TRUE);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (LargeControlArea <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>) {
</span></span><span style="display:flex;"><span>            state <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MiCheckControlAreaStatus</span> (CheckImageSection,SectionPointer,FALSE, <span style="color:#ec0000">&amp;</span>ControlArea,<span style="color:#ec0000">&amp;</span>OldIrql);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>ControlArea) {
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">LOCK_PFN</span> (OldIrql);
</span></span><span style="display:flex;"><span>                LargeControlArea<span style="color:#ec0000">-&gt;</span>NumberOfSectionReferences <span style="color:#ec0000">-=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">MiCheckControlArea</span> ((PCONTROL_AREA)LargeControlArea,OldIrql);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span> {
</span></span><span style="display:flex;"><span>                LargeControlArea<span style="color:#ec0000">-&gt;</span>NumberOfSectionReferences <span style="color:#ec0000">-=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">MiCheckControlArea</span> ((PCONTROL_AREA)LargeControlArea,OldIrql);
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">LOCK_PFN</span> (OldIrql);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span> {
</span></span><span style="display:flex;"><span>            state <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#ec0000">while</span> (ControlArea);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> (BOOLEAN) state;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LOGICAL <span style="color:#5f5fff">MiCheckControlAreaStatus</span> (IN SECTION_CHECK_TYPE SectionCheckType,IN PSECTION_OBJECT_POINTERS SectionObjectPointers,IN ULONG DelayClose, OUT PCONTROL_AREA <span style="color:#ec0000">*</span>ControlAreaOut, OUT PKIRQL PreviousIrql)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PKTHREAD CurrentThread;
</span></span><span style="display:flex;"><span>    PEVENT_COUNTER IoEvent;
</span></span><span style="display:flex;"><span>    PEVENT_COUNTER SegmentEvent;
</span></span><span style="display:flex;"><span>    LOGICAL DeallocateSegmentEvent;
</span></span><span style="display:flex;"><span>    PCONTROL_AREA ControlArea;
</span></span><span style="display:flex;"><span>    ULONG SectRef;
</span></span><span style="display:flex;"><span>    KIRQL OldIrql;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">*</span>ControlAreaOut <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">do</span> {
</span></span><span style="display:flex;"><span>        SegmentEvent <span style="color:#ec0000">=</span> <span style="color:#5f5fff">MiGetEventCounter</span> ();
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (SegmentEvent <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">KeDelayExecutionThread</span> (KernelMode,
</span></span><span style="display:flex;"><span>                                FALSE,
</span></span><span style="display:flex;"><span>                                (PLARGE_INTEGER)<span style="color:#ec0000">&amp;</span>MmShortTime);
</span></span><span style="display:flex;"><span>    } <span style="color:#ec0000">while</span> (TRUE);
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">LOCK_PFN</span> (OldIrql);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (SectionCheckType <span style="color:#ec0000">!=</span> CheckImageSection) {
</span></span><span style="display:flex;"><span>        ControlArea <span style="color:#ec0000">=</span> ((PCONTROL_AREA)(SectionObjectPointers<span style="color:#ec0000">-&gt;</span>DataSectionObject));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span> {
</span></span><span style="display:flex;"><span>        ControlArea <span style="color:#ec0000">=</span> ((PCONTROL_AREA)(SectionObjectPointers<span style="color:#ec0000">-&gt;</span>ImageSectionObject));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (ControlArea <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (SectionCheckType <span style="color:#ec0000">!=</span> CheckBothSection) {
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">UNLOCK_PFN</span> (OldIrql);
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">MiFreeEventCounter</span> (SegmentEvent);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span> {
</span></span><span style="display:flex;"><span>            ControlArea <span style="color:#ec0000">=</span> ((PCONTROL_AREA)(SectionObjectPointers<span style="color:#ec0000">-&gt;</span>ImageSectionObject));
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (ControlArea <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">UNLOCK_PFN</span> (OldIrql);
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">MiFreeEventCounter</span> (SegmentEvent);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (SectionCheckType <span style="color:#ec0000">!=</span> CheckUserDataSection) {
</span></span><span style="display:flex;"><span>        SectRef <span style="color:#ec0000">=</span> ControlArea<span style="color:#ec0000">-&gt;</span>NumberOfSectionReferences;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span> {
</span></span><span style="display:flex;"><span>        SectRef <span style="color:#ec0000">=</span> ControlArea<span style="color:#ec0000">-&gt;</span>NumberOfUserReferences;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ((SectRef <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span>) <span style="color:#ec0000">||</span>
</span></span><span style="display:flex;"><span>        (ControlArea<span style="color:#ec0000">-&gt;</span>NumberOfMappedViews <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span>) <span style="color:#ec0000">||</span>
</span></span><span style="display:flex;"><span>        (ControlArea<span style="color:#ec0000">-&gt;</span>u.Flags.BeingCreated)) {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (DelayClose) {
</span></span><span style="display:flex;"><span>            ControlArea<span style="color:#ec0000">-&gt;</span>u.Flags.DeleteOnClose <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">UNLOCK_PFN</span> (OldIrql);
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">MiFreeEventCounter</span> (SegmentEvent);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (ControlArea<span style="color:#ec0000">-&gt;</span>u.Flags.BeingDeleted) {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (ControlArea<span style="color:#ec0000">-&gt;</span>WaitingForDeletion <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>) {
</span></span><span style="display:flex;"><span>            DeallocateSegmentEvent <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>            ControlArea<span style="color:#ec0000">-&gt;</span>WaitingForDeletion <span style="color:#ec0000">=</span> SegmentEvent;
</span></span><span style="display:flex;"><span>            IoEvent <span style="color:#ec0000">=</span> SegmentEvent;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span> {
</span></span><span style="display:flex;"><span>            DeallocateSegmentEvent <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>            IoEvent <span style="color:#ec0000">=</span> ControlArea<span style="color:#ec0000">-&gt;</span>WaitingForDeletion;
</span></span><span style="display:flex;"><span>            IoEvent<span style="color:#ec0000">-&gt;</span>RefCount <span style="color:#ec0000">+=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        CurrentThread <span style="color:#ec0000">=</span> <span style="color:#5f5fff">KeGetCurrentThread</span> ();
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">KeEnterCriticalRegionThread</span> (CurrentThread);
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">UNLOCK_PFN_AND_THEN_WAIT</span>(OldIrql);
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">KeWaitForSingleObject</span>(<span style="color:#ec0000">&amp;</span>IoEvent<span style="color:#ec0000">-&gt;</span>Event,
</span></span><span style="display:flex;"><span>                              WrPageOut,
</span></span><span style="display:flex;"><span>                              KernelMode,
</span></span><span style="display:flex;"><span>                              FALSE,
</span></span><span style="display:flex;"><span>                              (PLARGE_INTEGER)<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">KeLeaveCriticalRegionThread</span> (CurrentThread);
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">MiFreeEventCounter</span> (IoEvent);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (DeallocateSegmentEvent <span style="color:#ec0000">==</span> TRUE) {
</span></span><span style="display:flex;"><span>            <span style="color:#5f5fff">MiFreeEventCounter</span> (SegmentEvent);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> TRUE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">ASSERT</span> (SegmentEvent<span style="color:#ec0000">-&gt;</span>RefCount <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">ASSERT</span> (SegmentEvent<span style="color:#ec0000">-&gt;</span>ListEntry.Next <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">InterlockedPushEntrySList</span> (<span style="color:#ec0000">&amp;</span>MmEventCountSListHead,
</span></span><span style="display:flex;"><span>                               (PSLIST_ENTRY)<span style="color:#ec0000">&amp;</span>SegmentEvent<span style="color:#ec0000">-&gt;</span>ListEntry);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">*</span>ControlAreaOut <span style="color:#ec0000">=</span> ControlArea;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">*</span>PreviousIrql <span style="color:#ec0000">=</span> OldIrql;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> FALSE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>看了以上代码逻辑，可知只需改一些结构体就可以实现：运行时删除，很简单的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">DriverIoctl</span>(PDEVICE_OBJECT pDevObj,PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">KdPrint</span>((<span style="color:#008900">&#34;Driver Ioctl</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>));
</span></span><span style="display:flex;"><span>	PIO_STACK_LOCATION pStack <span style="color:#ec0000">=</span> <span style="color:#5f5fff">IoGetCurrentIrpStackLocation</span>(pIrp);
</span></span><span style="display:flex;"><span>	ULONG cbin <span style="color:#ec0000">=</span> pStack<span style="color:#ec0000">-&gt;</span>Parameters.DeviceIoControl.InputBufferLength;
</span></span><span style="display:flex;"><span>	ULONG cbout <span style="color:#ec0000">=</span> pStack<span style="color:#ec0000">-&gt;</span>Parameters.DeviceIoControl.OutputBufferLength;
</span></span><span style="display:flex;"><span>	PVOID buffer <span style="color:#ec0000">=</span> pIrp<span style="color:#ec0000">-&gt;</span>AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>	ULONG ulOutputLen<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">switch</span>(pStack<span style="color:#ec0000">-&gt;</span>Parameters.DeviceIoControl.IoControlCode)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">IOCTL_IO_DELFILE</span>:
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			PFILE_OBJECT pObject;
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> <span style="color:#5f5fff">ObReferenceObjectByHandle</span>(<span style="color:#ec0000">*</span>(HANDLE<span style="color:#ec0000">*</span>)buffer,GENERIC_READ,<span style="color:#ec0000">*</span>IoFileObjectType,KernelMode,(PVOID<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>pObject,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	 		<span style="color:#ec0000">if</span>(<span style="color:#5f5fff">NT_SUCCESS</span>(status))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">__try</span>
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					PSCB Scb <span style="color:#ec0000">=</span> (PSCB)pObject<span style="color:#ec0000">-&gt;</span>FsContext;//NtfsDecodeFileObject
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(Scb)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						Scb<span style="color:#ec0000">-&gt;</span>Fcb<span style="color:#ec0000">-&gt;</span>Info.FileAttributes <span style="color:#ec0000">&amp;=</span> <span style="color:#ec0000">~</span>FILE_ATTRIBUTE_READONLY;//IsReadOnly
</span></span><span style="display:flex;"><span>						PSECTION_OBJECT_POINTERS pop<span style="color:#ec0000">=&amp;</span>Scb<span style="color:#ec0000">-&gt;</span>NonpagedScb<span style="color:#ec0000">-&gt;</span>SegmentObject;
</span></span><span style="display:flex;"><span>						pop<span style="color:#ec0000">-&gt;</span>ImageSectionObject <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">__except</span>(<span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#5f5fff">ObDereferenceObject</span>(pObject);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ec0000">-&gt;</span>IoStatus.Status <span style="color:#ec0000">=</span> status;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ec0000">-&gt;</span>IoStatus.Information <span style="color:#ec0000">=</span> ulOutputLen;
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">IoCompleteRequest</span>(pIrp,IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>#include &lt;iostream&gt;
</span></span><span style="display:flex;"><span>#include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span>using namespace std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#define IOCTL_IO_DELFILE CTL_CODE(FILE_DEVICE_UNKNOWN,0x800,METHOD_BUFFERED,FILE_ANY_ACCESS)//获取驱动加载信息
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">_tmain</span>(<span style="color:#5f5fff">int</span> argc, _TCHAR<span style="color:#ec0000">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (argc <span style="color:#ec0000">!=</span> <span style="color:#008900">2</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;参数不够&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	HANDLE hFile <span style="color:#ec0000">=</span> <span style="color:#5f5fff">CreateFileW</span>(argv[<span style="color:#008900">1</span>], <span style="color:#008900">0</span>, <span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (hFile <span style="color:#ec0000">!=</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		HANDLE hDev <span style="color:#ec0000">=</span> <span style="color:#5f5fff">CreateFileW</span>(<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\\\</span><span style="color:#008900">.</span><span style="color:#008900">\\</span><span style="color:#008900">NtMem&#34;</span>, GENERIC_ALL, <span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, OPEN_EXISTING, <span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span> (hDev <span style="color:#ec0000">!=</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			DWORD nop <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">DeviceIoControl</span>(hDev, IOCTL_IO_DELFILE, (LPVOID)<span style="color:#ec0000">&amp;</span>hFile, <span style="color:#ec0000">sizeof</span>(HANDLE), (LPVOID)<span style="color:#ec0000">&amp;</span>hFile, <span style="color:#008900">0</span>, <span style="color:#ec0000">&amp;</span>nop, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#5f5fff">CloseHandle</span>(hDev);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;无法打开设备!&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#5f5fff">CloseHandle</span>(hFile);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;无法打开文件!&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>xp 下测试删文件很轻松，还小试了一把360，没成功，发现根本未能进NtSetInformationFile这一层，估计在应用层做了hook。下面是打算找到线性地址对应物理地址的代码，然而没有成功：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>#define MiGetPdePart(va) (((ULONG)va&gt;&gt;22)&amp;0x3FF)
</span></span><span style="display:flex;"><span>#define MiGetPtePart(va) (((ULONG)va&gt;&gt;12)&amp;0x3FF)
</span></span><span style="display:flex;"><span>#define MiGetOffsetPart(va) ((ULONG)va&amp;0xFFF)
</span></span><span style="display:flex;"><span>ULONG cr3val<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>_asm
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    mov eax,cr3;
</span></span><span style="display:flex;"><span>    mov cr3val,eax;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>PVOID oriaddr<span style="color:#ec0000">=</span><span style="color:#5f5fff">ExAllocatePool</span>(NonPagedPool,<span style="color:#008900">0x1000</span>);
</span></span><span style="display:flex;"><span><span style="color:#ec0000">*</span>(PULONG)oriaddr <span style="color:#ec0000">=</span> <span style="color:#008900">0x12345</span>;
</span></span><span style="display:flex;"><span>PMMPTE PointerPte1,PointerPte2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PULONG pdaddr;
</span></span><span style="display:flex;"><span>LARGE_INTEGER mapaddr;
</span></span><span style="display:flex;"><span>mapaddr.QuadPart <span style="color:#ec0000">=</span> cr3val;
</span></span><span style="display:flex;"><span>pdaddr <span style="color:#ec0000">=</span> (PULONG)<span style="color:#5f5fff">MmMapIoSpace</span>(mapaddr,<span style="color:#008900">0x1000</span>,MmWriteCombined);
</span></span><span style="display:flex;"><span><span style="color:#ec0000">if</span>(pdaddr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PointerPte1 <span style="color:#ec0000">=</span> (PMMPTE)<span style="color:#ec0000">&amp;</span>pdaddr[<span style="color:#5f5fff">MiGetPdePart</span>(oriaddr)];
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(PointerPte1<span style="color:#ec0000">-&gt;</span>u.Hard.LargePage <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mapaddr.QuadPart <span style="color:#ec0000">=</span> PointerPte1<span style="color:#ec0000">-&gt;</span>u.Hard.PageFrameNumber;
</span></span><span style="display:flex;"><span>        pdaddr <span style="color:#ec0000">=</span> (PULONG)<span style="color:#5f5fff">MmMapIoSpace</span>(mapaddr,<span style="color:#008900">0x1000</span>,MmWriteCombined);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(pdaddr)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            PointerPte1 <span style="color:#ec0000">=</span> (PMMPTE)<span style="color:#ec0000">&amp;</span>pdaddr[<span style="color:#5f5fff">MiGetPtePart</span>(oriaddr)];
</span></span><span style="display:flex;"><span>            mapaddr.QuadPart <span style="color:#ec0000">=</span> PointerPte1<span style="color:#ec0000">-&gt;</span>u.Hard.PageFrameNumber;
</span></span><span style="display:flex;"><span>            pdaddr<span style="color:#ec0000">=</span> (PULONG)<span style="color:#5f5fff">MmMapIoSpace</span>(mapaddr,<span style="color:#008900">0x1000</span>,MmWriteCombined);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span>(pdaddr)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                PCHAR objaddr<span style="color:#ec0000">=</span>(PCHAR)pdaddr<span style="color:#ec0000">+</span><span style="color:#5f5fff">MiGetOffsetPart</span>(oriaddr);
</span></span><span style="display:flex;"><span>                objaddr <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    
    <script src="https://giscus.app/client.js"
        data-repo="lich4/lich4.github.io"
        data-repo-id="R_kgDOMTT_mw"
        data-category=""
        data-category-id="DIC_kwDOMTT_m84Cjbim"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

    
  </div>

  


  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/win_posts/20150429_ntquerysystem/">
                        NtQuerySystemInformation用法
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
            <div class="single-pagination-container-next">
                <div class="single-pagination-text">
                    <a href="/win_posts/20150628_disk_mmap/">
                        实现磁盘内存映射
                    </a>
                </div>
                <div class="single-pagination-text">→</div>
            </div>
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


      </main>
    </div>

    <footer>
      

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    



    </footer>
    
  </body>

  <script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

</html>