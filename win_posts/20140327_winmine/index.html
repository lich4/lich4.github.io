<!DOCTYPE html>
<html lang="zh-CN"
  dir="ltr">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://lich4.github.io//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://lich4.github.io//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://lich4.github.io//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://lich4.github.io//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://lich4.github.io//apple-touch-icon.png">

<meta name="description" content=""/>

<title>
    
    XP/Win7扫雷逆向分析 | 超哥的博客
    
</title>

<link rel="canonical" href="https://lich4.github.io/win_posts/20140327_winmine/"/>












<link rel="stylesheet" href="/assets/combined.min.cbcb816aefdb3b7380c5921cbb3b89d12f07742cb3f869754adb56da84f0d729.css" media="all">









  </head>

  

  
  
  

  <body class="light">

    <div class="content">
      <header>
        

<div class="header">

    

</div>

      </header>

      <main class="main">
        





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a href="/win_posts/">Win_posts</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a class="breadcrumbs-current" href="/win_posts/20140327_winmine/">XP/Win7扫雷逆向分析</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">XP/Win7扫雷逆向分析</h1>
    
    <p class="single-summary">XP/Win7扫雷逆向分析</p>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2014-03-27T00:00:00&#43;00:00">March 27, 2014</time>
      

      
    </p>

  </div>

  

  
  

  <div class="single-tags">
    
    <span>
      <a href="https://lich4.github.io/tags/%E9%80%86%E5%90%91/">#逆向</a>
    </span>
    
    
  </div>

  
  

  

  
  <aside class="toc">
    <p><strong>Table of contents</strong></p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#xp扫雷分析">XP扫雷分析</a>
      <ul>
        <li><a href="#分析布雷过程">分析布雷过程</a></li>
      </ul>
    </li>
    <li><a href="#xp扫雷内挂分析">XP扫雷内挂分析</a>
      <ul>
        <li><a href="#思考">思考</a></li>
      </ul>
    </li>
    <li><a href="#win7扫雷分析">Win7扫雷分析</a></li>
  </ul>
</nav>
  </aside>
  

  

  <div class="single-content">
    <h2 id="xp扫雷分析">XP扫雷分析</h2>
<h3 id="分析布雷过程">分析布雷过程</h3>
<p>  将xp的winmine.exe拖到ollydbg2中，F9运行，出现窗口后Alt+W选择扫雷的主窗口，由于是顶层窗口，因此Parent一栏为Topmost，右键选择000B047C，选择Conditional Breakpoint(条件断点)，输入[DWORD ESP+8] == WM_LBUTTONUP。选中一块雷区点击，ollydbg便停在入口处(由于程序内部释放焦点，因此我们由winmine切入到ollydbg窗口时)</p>
<p>










<figure class="">

    <div>
        <img loading="lazy" alt="" src=" /img/winmine1.jpg">
    </div>

    
</figure></p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BC9</span>  <span style="color:#ec0000">/</span>.  <span style="color:#008900">55</span>            <span style="color:#008900">PUSH</span> <span style="color:#008900">EBP</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BCA</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">8</span><span style="color:#008900">BEC</span>          <span style="color:#008900">MOV</span> <span style="color:#008900">EBP</span>,<span style="color:#008900">ESP</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BCC</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">83</span><span style="color:#008900">EC</span> <span style="color:#008900">40</span>       <span style="color:#008900">SUB</span> <span style="color:#008900">ESP</span>,<span style="color:#008900">40</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BCF</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">8</span><span style="color:#008900">B55</span> <span style="color:#008900">0</span><span style="color:#008900">C</span>       <span style="color:#008900">MOV</span> <span style="color:#008900">EDX</span>,<span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">SS</span>:[<span style="color:#008900">ARG.2</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BD2</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">8</span><span style="color:#008900">B4D</span> <span style="color:#008900">14</span>       <span style="color:#008900">MOV</span> <span style="color:#008900">ECX</span>,<span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">SS</span>:[<span style="color:#008900">ARG.4</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BD5</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">53</span>            <span style="color:#008900">PUSH</span> <span style="color:#008900">EBX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BD6</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">56</span>            <span style="color:#008900">PUSH</span> <span style="color:#008900">ESI</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BD7</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">33</span><span style="color:#008900">DB</span>          <span style="color:#008900">XOR</span> <span style="color:#008900">EBX</span>,<span style="color:#008900">EBX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BD9</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">57</span>            <span style="color:#008900">PUSH</span> <span style="color:#008900">EDI</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BDA</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">BE</span> <span style="color:#008900">00020000</span>   <span style="color:#008900">MOV</span> <span style="color:#008900">ESI</span>,<span style="color:#008900">200</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BDF</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">43</span>            <span style="color:#008900">INC</span> <span style="color:#008900">EBX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BE0</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">33</span><span style="color:#008900">FF</span>          <span style="color:#008900">XOR</span> <span style="color:#008900">EDI</span>,<span style="color:#008900">EDI</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BE2</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">3</span><span style="color:#008900">BD6</span>          <span style="color:#008900">CMP</span> <span style="color:#008900">EDX</span>,<span style="color:#008900">ESI</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">BE4</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">0</span><span style="color:#008900">F87</span> <span style="color:#008900">75030000</span> <span style="color:#008900">JA</span> <span style="color:#008900">01001</span><span style="color:#008900">F5F</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">F5F</span>  <span style="color:#ec0000">|&gt;</span> <span style="color:#ec0000">\</span><span style="color:#008900">8</span><span style="color:#008900">D82</span> <span style="color:#008900">FFFDFFFF</span> <span style="color:#008900">LEA</span> <span style="color:#008900">EAX</span>,[<span style="color:#008900">EDX-201</span>]                        ; Switch (messages 201..212, 7 exits)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">F65</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">83</span><span style="color:#008900">F8</span> <span style="color:#008900">11</span>       <span style="color:#008900">CMP</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">11</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">F68</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">0</span><span style="color:#008900">F87</span> <span style="color:#008900">3</span><span style="color:#008900">B020000</span> <span style="color:#008900">JA</span> <span style="color:#008900">010021</span><span style="color:#008900">A9</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">F6E</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">0</span><span style="color:#008900">FB680</span> <span style="color:#008900">DE2100</span> <span style="color:#008900">MOVZX</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">BYTE</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">EAX</span><span style="color:#ec0000">+</span><span style="color:#008900">10021</span><span style="color:#008900">DE</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">F75</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">FF2485</span> <span style="color:#008900">C22100</span> <span style="color:#008900">JMP</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">EAX</span>*<span style="color:#008900">4</span><span style="color:#ec0000">+</span><span style="color:#008900">10021</span><span style="color:#008900">C2</span>]
</span></span></code></pre></div><p>跳几次，就到WM_LBUTTONUP的位置了</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">FDF</span>  <span style="color:#ec0000">|&gt;</span> <span style="color:#ec0000">\</span><span style="color:#008900">33</span><span style="color:#008900">FF</span>          <span style="color:#008900">XOR</span> <span style="color:#008900">EDI</span>,<span style="color:#008900">EDI</span>                              ; Cases 202 (WM_LBUTTONUP), 205 (WM_RBUTTONUP), 208 (WM_MBUTTONUP) of switch winmine.1001F5F
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">FE1</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">393</span><span style="color:#008900">D</span> <span style="color:#008900">40510001</span> <span style="color:#008900">CMP</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005140</span>],<span style="color:#008900">EDI</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">FE7</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">0</span><span style="color:#008900">F84</span> <span style="color:#008900">BC010000</span> <span style="color:#008900">JE</span> <span style="color:#008900">010021</span><span style="color:#008900">A9</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">FED</span>  <span style="color:#ec0000">|&gt;</span> <span style="color:#ec0000">/</span><span style="color:#008900">893</span><span style="color:#008900">D</span> <span style="color:#008900">40510001</span> <span style="color:#008900">MOV</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005140</span>],<span style="color:#008900">EDI</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">FF3</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">FF15</span> <span style="color:#008900">D8100001</span> <span style="color:#008900">CALL</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#ec0000">&lt;&amp;</span><span style="color:#008900">USER32.ReleaseCaptu</span> ; [USER32.ReleaseCapture
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">FF9</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">841</span><span style="color:#008900">D</span> <span style="color:#008900">00500001</span> <span style="color:#008900">TEST</span> <span style="color:#008900">BYTE</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005000</span>],<span style="color:#008900">BL</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01001</span><span style="color:#5f5fff">FFF</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">0</span><span style="color:#008900">F84</span> <span style="color:#008900">B6000000</span> <span style="color:#008900">JZ</span> <span style="color:#008900">010020</span><span style="color:#008900">BB</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01002005</span>  <span style="color:#ec0000">|.</span> <span style="color:#ec0000">|</span><span style="color:#5f5fff">E8</span> <span style="color:#008900">D7170000</span>   <span style="color:#008900">CALL</span> <span style="color:#008900">010037</span><span style="color:#008900">E1</span>                            ; [winmine.010037E1
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100200</span><span style="color:#5f5fff">A</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">E9</span> <span style="color:#008900">9</span><span style="color:#008900">A010000</span>   <span style="color:#008900">JMP</span> <span style="color:#008900">010021</span><span style="color:#008900">A9</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100200</span><span style="color:#5f5fff">F</span>  <span style="color:#ec0000">|&gt;</span> <span style="color:#ec0000">|</span><span style="color:#008900">393</span><span style="color:#008900">D</span> <span style="color:#008900">48510001</span> <span style="color:#008900">CMP</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005148</span>],<span style="color:#008900">EDI</span>           ; Case 204 (WM_RBUTTONDOWN) of switch winmine.1001F5F
</span></span></code></pre></div><p>由于下面已经是WM_RBUTTONDOWN的判断了，因此CALL 010021A9是处理WM_LBUTTONUP的函数，我们F7跟进</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span><span style="color:#ec0000">010037</span><span style="color:#5f5fff">E1</span>  <span style="color:#ec0000">/</span><span style="color:#008900">$</span>  <span style="color:#008900">A1</span> <span style="color:#008900">18510001</span>   <span style="color:#008900">MOV</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005118</span>]           ; winmine.010037E1(guessed void)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010037</span><span style="color:#5f5fff">E6</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">85</span><span style="color:#008900">C0</span>          <span style="color:#008900">TEST</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">EAX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010037</span><span style="color:#5f5fff">E8</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">0</span><span style="color:#008900">F8E</span> <span style="color:#008900">C8000000</span> <span style="color:#008900">JLE</span> <span style="color:#008900">010038</span><span style="color:#008900">B6</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010037</span><span style="color:#5f5fff">EE</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">8</span><span style="color:#008900">B0D</span> <span style="color:#008900">1</span><span style="color:#008900">C510001</span> <span style="color:#008900">MOV</span> <span style="color:#008900">ECX</span>,<span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">100511</span><span style="color:#008900">C</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010037</span><span style="color:#5f5fff">F4</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">85</span><span style="color:#008900">C9</span>          <span style="color:#008900">TEST</span> <span style="color:#008900">ECX</span>,<span style="color:#008900">ECX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010037</span><span style="color:#5f5fff">F6</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">0</span><span style="color:#008900">F8E</span> <span style="color:#008900">BA000000</span> <span style="color:#008900">JLE</span> <span style="color:#008900">010038</span><span style="color:#008900">B6</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010037</span><span style="color:#5f5fff">FC</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">3</span><span style="color:#008900">B05</span> <span style="color:#008900">34530001</span> <span style="color:#008900">CMP</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005334</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003802</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">0</span><span style="color:#5f5fff">F8F</span> <span style="color:#008900">AE000000</span> <span style="color:#008900">JG</span> <span style="color:#008900">010038</span><span style="color:#008900">B6</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003808</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">3</span><span style="color:#5f5fff">B0D</span> <span style="color:#008900">38530001</span> <span style="color:#008900">CMP</span> <span style="color:#008900">ECX</span>,<span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005338</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100380</span><span style="color:#5f5fff">E</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">0</span><span style="color:#008900">F8F</span> <span style="color:#008900">A2000000</span> <span style="color:#008900">JG</span> <span style="color:#008900">010038</span><span style="color:#008900">B6</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003814</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">53</span>            <span style="color:#5f5fff">PUSH</span> <span style="color:#008900">EBX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003815</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">33</span><span style="color:#5f5fff">DB</span>          <span style="color:#008900">XOR</span> <span style="color:#008900">EBX</span>,<span style="color:#008900">EBX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003817</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">43</span>            <span style="color:#5f5fff">INC</span> <span style="color:#008900">EBX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003818</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">833</span><span style="color:#5f5fff">D</span> <span style="color:#008900">A4570001</span> <span style="color:#008900">CMP</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">10057</span><span style="color:#008900">A4</span>],<span style="color:#008900">0</span>             ; 次数？
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100381</span><span style="color:#5f5fff">F</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">75</span> <span style="color:#008900">4</span><span style="color:#008900">A</span>         <span style="color:#008900">JNE</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">0100386</span><span style="color:#008900">B</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003821</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">833</span><span style="color:#5f5fff">D</span> <span style="color:#008900">9</span><span style="color:#008900">C570001</span> <span style="color:#008900">CMP</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">100579</span><span style="color:#008900">C</span>],<span style="color:#008900">0</span>             ; 时间？
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003828</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">75</span> <span style="color:#ec0000">41</span>         <span style="color:#5f5fff">JNE</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">0100386</span><span style="color:#008900">B</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100382</span><span style="color:#5f5fff">A</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">53</span>            <span style="color:#008900">PUSH</span> <span style="color:#008900">EBX</span>                                 ; /Arg1 =&gt; 1
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100382</span><span style="color:#5f5fff">B</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">E8</span> <span style="color:#008900">BD000000</span>   <span style="color:#008900">CALL</span> <span style="color:#008900">010038</span><span style="color:#008900">ED</span>                            ; \winmine.010038ED
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003830</span>  <span style="color:#ec0000">|.</span>  <span style="color:#5f5fff">FF05</span> <span style="color:#008900">9</span><span style="color:#008900">C570001</span> <span style="color:#008900">INC</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">100579</span><span style="color:#008900">C</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003836</span>  <span style="color:#ec0000">|.</span>  <span style="color:#5f5fff">E8</span> <span style="color:#008900">7</span><span style="color:#008900">AF0FFFF</span>   <span style="color:#008900">CALL</span> <span style="color:#008900">010028</span><span style="color:#008900">B5</span>                            ; [winmine.010028B5
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100383</span><span style="color:#5f5fff">B</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">6</span><span style="color:#008900">A</span> <span style="color:#008900">00</span>         <span style="color:#008900">PUSH</span> <span style="color:#008900">0</span>                                   ; /TimerFunc = 00000000
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100383</span><span style="color:#5f5fff">D</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">68</span> <span style="color:#008900">E8030000</span>   <span style="color:#008900">PUSH</span> <span style="color:#008900">3</span><span style="color:#008900">E8</span>                                 ; |Timeout = 1000. ms
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003842</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">53</span>            <span style="color:#5f5fff">PUSH</span> <span style="color:#008900">EBX</span>                                 ; |TimerID
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003843</span>  <span style="color:#ec0000">|.</span>  <span style="color:#5f5fff">FF35</span> <span style="color:#008900">245</span><span style="color:#008900">B0001</span> <span style="color:#008900">PUSH</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005</span><span style="color:#008900">B24</span>]              ; |hWnd = 000B047C, class = 扫雷, text = 扫雷
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003849</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">891</span><span style="color:#5f5fff">D</span> <span style="color:#008900">64510001</span> <span style="color:#008900">MOV</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005164</span>],<span style="color:#008900">EBX</span>           ; |
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100384</span><span style="color:#5f5fff">F</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">FF15</span> <span style="color:#008900">B4100001</span> <span style="color:#008900">CALL</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#ec0000">&lt;&amp;</span><span style="color:#008900">USER32.SetTimer</span><span style="color:#ec0000">&gt;</span>]   ; \USER32.SetTimer
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003855</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">85</span><span style="color:#5f5fff">C0</span>          <span style="color:#008900">TEST</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">EAX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003857</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">75</span> <span style="color:#ec0000">07</span>         <span style="color:#5f5fff">JNZ</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">01003860</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003859</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">6</span><span style="color:#5f5fff">A</span> <span style="color:#008900">04</span>         <span style="color:#008900">PUSH</span> <span style="color:#008900">4</span>                                   ; /Arg1 = 4
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100385</span><span style="color:#5f5fff">B</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">E8</span> <span style="color:#008900">F0000000</span>   <span style="color:#008900">CALL</span> <span style="color:#008900">01003950</span>                            ; \winmine.01003950
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003860</span>  <span style="color:#ec0000">|&gt;</span>  <span style="color:#5f5fff">A1</span> <span style="color:#008900">18510001</span>   <span style="color:#008900">MOV</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005118</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003865</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">8</span><span style="color:#5f5fff">B0D</span> <span style="color:#008900">1</span><span style="color:#008900">C510001</span> <span style="color:#008900">MOV</span> <span style="color:#008900">ECX</span>,<span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">100511</span><span style="color:#008900">C</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100386</span><span style="color:#5f5fff">B</span>  <span style="color:#ec0000">|&gt;</span>  <span style="color:#008900">841</span><span style="color:#008900">D</span> <span style="color:#008900">00500001</span> <span style="color:#008900">TEST</span> <span style="color:#008900">BYTE</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005000</span>],<span style="color:#008900">BL</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003871</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">5</span><span style="color:#5f5fff">B</span>            <span style="color:#008900">POP</span> <span style="color:#008900">EBX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003872</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">75</span> <span style="color:#ec0000">10</span>         <span style="color:#5f5fff">JNZ</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">01003884</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003874</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">6</span><span style="color:#5f5fff">A</span> <span style="color:#008900">FE</span>         <span style="color:#008900">PUSH</span> -<span style="color:#008900">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003876</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">59</span>            <span style="color:#5f5fff">POP</span> <span style="color:#008900">ECX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003877</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">8</span><span style="color:#5f5fff">BC1</span>          <span style="color:#008900">MOV</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">ECX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003879</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">890</span><span style="color:#5f5fff">D</span> <span style="color:#008900">1</span><span style="color:#008900">C510001</span> <span style="color:#008900">MOV</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">100511</span><span style="color:#008900">C</span>],<span style="color:#008900">ECX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100387</span><span style="color:#5f5fff">F</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">A3</span> <span style="color:#008900">18510001</span>   <span style="color:#008900">MOV</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005118</span>],<span style="color:#008900">EAX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003884</span>  <span style="color:#ec0000">|&gt;</span>  <span style="color:#ec0000">833</span><span style="color:#5f5fff">D</span> <span style="color:#008900">44510001</span> <span style="color:#008900">CMP</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005144</span>],<span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100388</span><span style="color:#5f5fff">B</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">74</span> <span style="color:#008900">09</span>         <span style="color:#008900">JE</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">01003896</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100388</span><span style="color:#5f5fff">D</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">51</span>            <span style="color:#008900">PUSH</span> <span style="color:#008900">ECX</span>                                 ; /Arg2
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100388</span><span style="color:#5f5fff">E</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">50</span>            <span style="color:#008900">PUSH</span> <span style="color:#008900">EAX</span>                                 ; |Arg1
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100388</span><span style="color:#5f5fff">F</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">E8</span> <span style="color:#008900">23</span><span style="color:#008900">FDFFFF</span>   <span style="color:#008900">CALL</span> <span style="color:#008900">010035</span><span style="color:#008900">B7</span>                            ; \winmine.010035B7
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003894</span>  <span style="color:#ec0000">|.</span>  <span style="color:#5f5fff">EB</span> <span style="color:#008900">20</span>         <span style="color:#008900">JMP</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">010038</span><span style="color:#008900">B6</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003896</span>  <span style="color:#ec0000">|&gt;</span>  <span style="color:#ec0000">8</span><span style="color:#5f5fff">BD1</span>          <span style="color:#008900">MOV</span> <span style="color:#008900">EDX</span>,<span style="color:#008900">ECX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003898</span>  <span style="color:#ec0000">|.</span>  <span style="color:#5f5fff">C1E2</span> <span style="color:#008900">05</span>       <span style="color:#008900">SHL</span> <span style="color:#008900">EDX</span>,<span style="color:#008900">5</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100389</span><span style="color:#5f5fff">B</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">8</span><span style="color:#008900">A9402</span> <span style="color:#008900">405300</span> <span style="color:#008900">MOV</span> <span style="color:#008900">DL</span>,<span style="color:#008900">BYTE</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">EAX</span><span style="color:#ec0000">+</span><span style="color:#008900">EDX</span><span style="color:#ec0000">+</span><span style="color:#008900">1005340</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">A2</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">F6C2</span> <span style="color:#008900">40</span>       <span style="color:#008900">TEST</span> <span style="color:#008900">DL</span>,<span style="color:#008900">40</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">A5</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">75</span> <span style="color:#008900">0</span><span style="color:#008900">F</span>         <span style="color:#008900">JNZ</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">010038</span><span style="color:#008900">B6</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">A7</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">80</span><span style="color:#008900">E2</span> <span style="color:#008900">1</span><span style="color:#008900">F</span>       <span style="color:#008900">AND</span> <span style="color:#008900">DL</span>,<span style="color:#008900">1</span><span style="color:#008900">F</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">AA</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">80</span><span style="color:#008900">FA</span> <span style="color:#008900">0</span><span style="color:#008900">E</span>       <span style="color:#008900">CMP</span> <span style="color:#008900">DL</span>,<span style="color:#008900">0</span><span style="color:#008900">E</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">AD</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">74</span> <span style="color:#008900">07</span>         <span style="color:#008900">JE</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">010038</span><span style="color:#008900">B6</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">AF</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">51</span>            <span style="color:#008900">PUSH</span> <span style="color:#008900">ECX</span>                                 ; /Arg2
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">B0</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">50</span>            <span style="color:#008900">PUSH</span> <span style="color:#008900">EAX</span>                                 ; |Arg1
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">B1</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">E8</span> <span style="color:#008900">5</span><span style="color:#008900">CFCFFFF</span>   <span style="color:#008900">CALL</span> <span style="color:#008900">01003512</span>                            ; \winmine.01003512
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">B6</span>  <span style="color:#ec0000">|&gt;</span>  <span style="color:#008900">FF35</span> <span style="color:#008900">60510001</span> <span style="color:#008900">PUSH</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005160</span>]              ; /Arg1 = 0
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">BC</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">E8</span> <span style="color:#008900">52</span><span style="color:#008900">F0FFFF</span>   <span style="color:#008900">CALL</span> <span style="color:#008900">01002913</span>                            ; \winmine.01002913
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">C1</span>  <span style="color:#ec0000">\</span>.  <span style="color:#008900">C3</span>            <span style="color:#008900">RETN</span>
</span></span></code></pre></div><p>  由于雷区数据不应该随函数的退出而消失，可以判断数据存放在静态或者全局变量区，所以着重关注DS:[100??]这种地方，多试几次可知10057A4记录了用户挖雷次数，而100579C处记录着已用时间，真正的布雷函数显然在那几个call中。你在这些汇编代码中发现了SetTimer这个函数，你在游戏时可能已经发现，在用户挖第一个雷时才会计数，因此call 010038ED和call 010028B5处一定有猫腻，第一个点进去以后是这样：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">ED</span>  <span style="color:#ec0000">/</span><span style="color:#008900">$</span>  <span style="color:#008900">833</span><span style="color:#008900">D</span> <span style="color:#008900">B8560001</span> <span style="color:#008900">CMP</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">10056</span><span style="color:#008900">B8</span>],<span style="color:#008900">3</span>             ; winmine.010038ED(guessed Arg1)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">F4</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">75</span> <span style="color:#008900">47</span>         <span style="color:#008900">JNE</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">0100393</span><span style="color:#008900">D</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">F6</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">8</span><span style="color:#008900">B4424</span> <span style="color:#008900">04</span>     <span style="color:#008900">MOV</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">SS</span>:[<span style="color:#008900">ARG.1</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">FA</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">48</span>            <span style="color:#008900">DEC</span> <span style="color:#008900">EAX</span>                                  ; Switch (cases 1..3, 4 exits)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">FB</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">74</span> <span style="color:#008900">2</span><span style="color:#008900">A</span>         <span style="color:#008900">JZ</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">01003927</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">FD</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">48</span>            <span style="color:#008900">DEC</span> <span style="color:#008900">EAX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010038</span><span style="color:#5f5fff">FE</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">74</span> <span style="color:#008900">15</span>         <span style="color:#008900">JZ</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">01003915</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003900</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">48</span>            <span style="color:#5f5fff">DEC</span> <span style="color:#008900">EAX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003901</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">75</span> <span style="color:#ec0000">3</span><span style="color:#5f5fff">A</span>         <span style="color:#008900">JNZ</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">0100393</span><span style="color:#008900">D</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003903</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">68</span> <span style="color:#ec0000">05000400</span>   <span style="color:#5f5fff">PUSH</span> <span style="color:#008900">40005</span>                               ; Case 3 of switch winmine.10038FA
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003908</span>  <span style="color:#ec0000">|.</span>  <span style="color:#5f5fff">FF35</span> <span style="color:#008900">305</span><span style="color:#008900">B0001</span> <span style="color:#008900">PUSH</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005</span><span style="color:#008900">B30</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100390</span><span style="color:#5f5fff">E</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">68</span> <span style="color:#008900">B2010000</span>   <span style="color:#008900">PUSH</span> <span style="color:#008900">1</span><span style="color:#008900">B2</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003913</span>  <span style="color:#ec0000">|.</span>  <span style="color:#5f5fff">EB</span> <span style="color:#008900">22</span>         <span style="color:#008900">JMP</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">01003937</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003915</span>  <span style="color:#ec0000">|&gt;</span>  <span style="color:#ec0000">68</span> <span style="color:#ec0000">05000400</span>   <span style="color:#5f5fff">PUSH</span> <span style="color:#008900">40005</span>                               ; Case 2 of switch winmine.10038FA
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100391</span><span style="color:#5f5fff">A</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">FF35</span> <span style="color:#008900">305</span><span style="color:#008900">B0001</span> <span style="color:#008900">PUSH</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005</span><span style="color:#008900">B30</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003920</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">68</span> <span style="color:#5f5fff">B1010000</span>   <span style="color:#008900">PUSH</span> <span style="color:#008900">1</span><span style="color:#008900">B1</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003925</span>  <span style="color:#ec0000">|.</span>  <span style="color:#5f5fff">EB</span> <span style="color:#008900">10</span>         <span style="color:#008900">JMP</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">01003937</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003927</span>  <span style="color:#ec0000">|&gt;</span>  <span style="color:#ec0000">68</span> <span style="color:#ec0000">05000400</span>   <span style="color:#5f5fff">PUSH</span> <span style="color:#008900">40005</span>                               ; Case 1 of switch winmine.10038FA
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100392</span><span style="color:#5f5fff">C</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">FF35</span> <span style="color:#008900">305</span><span style="color:#008900">B0001</span> <span style="color:#008900">PUSH</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005</span><span style="color:#008900">B30</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003932</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">68</span> <span style="color:#5f5fff">B0010000</span>   <span style="color:#008900">PUSH</span> <span style="color:#008900">1</span><span style="color:#008900">B0</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003937</span>  <span style="color:#ec0000">|&gt;</span>  <span style="color:#5f5fff">FF15</span> <span style="color:#008900">68110001</span> <span style="color:#008900">CALL</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#ec0000">&lt;&amp;</span><span style="color:#008900">WINMM.PlaySoundW</span><span style="color:#ec0000">&gt;</span>]  ; \WINMM.PlaySoundW
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100393</span><span style="color:#5f5fff">D</span>  <span style="color:#ec0000">\&gt;</span>  <span style="color:#008900">C2</span> <span style="color:#008900">0400</span>       <span style="color:#008900">RETN</span> <span style="color:#008900">4</span>                                   ; Default case of switch winmine.10038FA
</span></span></code></pre></div><p>  可以看出这个函数就是在你点击了雷以后发出声音的，没什么价值，但是此时你注意到下面的一个函数用到了rand，对啊，这个随机数在初始化雷阵的时候肯定用得到啊，先下个断点再说。开始新游戏，然后扫雷就断在rand函数处：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span><span style="color:#ec0000">01003940</span>  <span style="color:#ec0000">/</span><span style="color:#5f5fff">$</span>  <span style="color:#008900">FF15</span> <span style="color:#008900">B0110001</span> <span style="color:#008900">CALL</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#ec0000">&lt;&amp;</span><span style="color:#008900">msvcrt.rand</span><span style="color:#ec0000">&gt;</span>]       ; [MSVCRT.rand
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003946</span>  <span style="color:#ec0000">|.</span>  <span style="color:#ec0000">99</span>            <span style="color:#5f5fff">CDQ</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003947</span>  <span style="color:#ec0000">|.</span>  <span style="color:#5f5fff">F77C24</span> <span style="color:#008900">04</span>     <span style="color:#008900">IDIV</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">SS</span>:[<span style="color:#008900">ARG.1</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100394</span><span style="color:#5f5fff">B</span>  <span style="color:#ec0000">|</span>.  <span style="color:#008900">8</span><span style="color:#008900">BC2</span>          <span style="color:#008900">MOV</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">EDX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">0100394</span><span style="color:#5f5fff">D</span>  <span style="color:#ec0000">\</span>.  <span style="color:#008900">C2</span> <span style="color:#008900">0400</span>       <span style="color:#008900">RETN</span> <span style="color:#008900">4</span>
</span></span></code></pre></div><p>这个函数显然是用来取rand()%N的，运行到winmine代码中，会发现一个循环，很重要</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">C7</span>  <span style="color:#ec0000">|&gt;</span> <span style="color:#ec0000">/</span><span style="color:#008900">FF35</span> <span style="color:#008900">34530001</span> <span style="color:#ec0000">/</span><span style="color:#008900">PUSH</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005334</span>]             ; /Arg1 = 9
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">CD</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">E8</span> <span style="color:#008900">6</span><span style="color:#008900">E020000</span>   <span style="color:#ec0000">|</span><span style="color:#008900">CALL</span> <span style="color:#008900">01003940</span>                           ; \winmine.01003940
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">D2</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">FF35</span> <span style="color:#008900">38530001</span> <span style="color:#ec0000">|</span><span style="color:#008900">PUSH</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005338</span>]             ; /Arg1 = 9
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">D8</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">8</span><span style="color:#008900">BF0</span>          <span style="color:#ec0000">|</span><span style="color:#008900">MOV</span> <span style="color:#008900">ESI</span>,<span style="color:#008900">EAX</span>                             ; |
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">DA</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">46</span>            <span style="color:#ec0000">|</span><span style="color:#008900">INC</span> <span style="color:#008900">ESI</span>                                 ; |
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">DB</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">E8</span> <span style="color:#008900">60020000</span>   <span style="color:#ec0000">|</span><span style="color:#008900">CALL</span> <span style="color:#008900">01003940</span>                           ; \winmine.01003940
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">E0</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">40</span>            <span style="color:#ec0000">|</span><span style="color:#008900">INC</span> <span style="color:#008900">EAX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">E1</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">8</span><span style="color:#008900">BC8</span>          <span style="color:#ec0000">|</span><span style="color:#008900">MOV</span> <span style="color:#008900">ECX</span>,<span style="color:#008900">EAX</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">E3</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">C1E1</span> <span style="color:#008900">05</span>       <span style="color:#ec0000">|</span><span style="color:#008900">SHL</span> <span style="color:#008900">ECX</span>,<span style="color:#008900">5</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">E6</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">F68431</span> <span style="color:#008900">405300</span> <span style="color:#ec0000">|</span><span style="color:#008900">TEST</span> <span style="color:#008900">BYTE</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">ESI</span><span style="color:#ec0000">+</span><span style="color:#008900">ECX</span><span style="color:#ec0000">+</span><span style="color:#008900">1005340</span>],<span style="color:#008900">80</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">EE</span>  <span style="color:#ec0000">|</span>.<span style="color:#ec0000">^\</span><span style="color:#008900">75</span> <span style="color:#008900">D7</span>         <span style="color:#ec0000">|</span><span style="color:#008900">JNZ</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">010036</span><span style="color:#008900">C7</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">F0</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">C1E0</span> <span style="color:#008900">05</span>       <span style="color:#ec0000">|</span><span style="color:#008900">SHL</span> <span style="color:#008900">EAX</span>,<span style="color:#008900">5</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">F3</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">8</span><span style="color:#008900">D8430</span> <span style="color:#008900">405300</span> <span style="color:#ec0000">|</span><span style="color:#008900">LEA</span> <span style="color:#008900">EAX</span>,[<span style="color:#008900">ESI</span><span style="color:#ec0000">+</span><span style="color:#008900">EAX</span><span style="color:#ec0000">+</span><span style="color:#008900">1005340</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">FA</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">8008</span> <span style="color:#008900">80</span>       <span style="color:#ec0000">|</span><span style="color:#008900">OR</span> <span style="color:#008900">BYTE</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">EAX</span>],<span style="color:#008900">80</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">010036</span><span style="color:#5f5fff">FD</span>  <span style="color:#ec0000">|</span>. <span style="color:#ec0000">|</span><span style="color:#008900">FF0D</span> <span style="color:#008900">30530001</span> <span style="color:#ec0000">|</span><span style="color:#008900">DEC</span> <span style="color:#008900">DWORD</span> <span style="color:#008900">PTR</span> <span style="color:#008900">DS</span>:[<span style="color:#008900">1005330</span>]
</span></span><span style="display:flex;"><span><span style="color:#ec0000">01003703</span>  <span style="color:#ec0000">|.^\75</span> <span style="color:#5f5fff">C2</span>         <span style="color:#ec0000">\</span><span style="color:#008900">JNZ</span> <span style="color:#008900">SHORT</span> <span style="color:#008900">010036</span><span style="color:#008900">C7</span>
</span></span></code></pre></div><p>这段代码经过逆向分析可以得到伪代码：</p>
<ul>
<li>[1005338]处存放棋盘大小  SIZE</li>
<li>[1005330]处存放余下要摆放的雷数  MineToSet</li>
<li>[1005340]存放棋盘数据  BYTE DATA[32][32]   我们初级模式9*9只用到[1][1]-[9][9]的数据</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ec0000">while</span>(MineToSet)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> line<span style="color:#ec0000">=</span>rand<span style="color:#ec0000">%</span>SIZE<span style="color:#ec0000">+</span><span style="color:#008900">1</span>,column<span style="color:#ec0000">=</span>rand<span style="color:#ec0000">%</span>SIZE<span style="color:#ec0000">+</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span>((DATA[line][column]<span style="color:#ec0000">&amp;</span><span style="color:#008900">0x80</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>  {//如果不是雷
</span></span><span style="display:flex;"><span>    DATA[line][column] <span style="color:#ec0000">|=</span> <span style="color:#008900">0x80</span>;//设置为雷
</span></span><span style="display:flex;"><span>    MineToSet<span style="color:#ec0000">--</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>










<figure class="">

    <div>
        <img loading="lazy" alt="" src=" /img/winmine2.jpg">
    </div>

    
</figure></p>
<p>  我们从ollydbg的内存窗口取得1005340的数据，分析以后可以得到雷区数组，可以得知8F处的为雷，0F处的不是雷</p>
<p>










<figure class="">

    <div>
        <img loading="lazy" alt="" src=" /img/winmine3.jpg">
    </div>

    
</figure></p>
<p>问题思考:</p>
<ul>
<li>为什么是 ESP+8?
  这个问题式函数栈帧的结构问题，对函数下断点是断点总是断在入口处，而一般情况下(本例如此)进入该函数之前往往是(该函数原型为stdcall func(A,B,C,&hellip;,Z))：</li>
</ul>
<pre tabindex="0"><code>  push Z
  push Y
  .......
  push B
  push A
  call func
  ??next??
</code></pre><p>call是将下个指令地址压栈，因此进了func以后内存栈帧结构为这样</p>
<pre tabindex="0"><code>低地址
    ??next?? &lt;---ESP
    A        &lt;---ESP+4
    B        &lt;---ESP+8
    ...
    Y
    Z
高地址
</code></pre><p>windows的窗口回调过程函数定义为：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>LRESULT CALLBACK <span style="color:#5f5fff">WindowProc</span>(  HWND hwnd,      // handle to window
</span></span><span style="display:flex;"><span>    UINT uMsg,      // message identifier
</span></span><span style="display:flex;"><span>    WPARAM wParam,  // first message parameter
</span></span><span style="display:flex;"><span>    LPARAM lParam   // second message parameter
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>因此我们想截获uMsg == WM_LBUTTONUP消息，则判断[ESP+8]处即可</p>
<ul>
<li>为什么选择WM_LBUTTONUP?</li>
</ul>
<p>  这个你可以动手试试就知道了，你在雷区按下(设该点为A)鼠标不放，移动到别处(设该点为B)，若B也在雷区，则B处鼠标释放后程序视为挖雷
而如果在外边则什么效果也没有。相反如果你在雷区之外A处按下鼠标不放，拖到雷区之内B处释放，则B处雷挖开。可见是否挖雷与LBUTTONDOWN的位置无关，而与LBUTTONUP位置有关</p>
<ul>
<li>为什么初始布置的雷区和实际的不一样？如上图，左上角的雷本是没有的，而[3][4]处本来应该有雷，为什么没有？</li>
</ul>
<p>  其实这2处在用户第一次点击雷区时被winmine偷偷替换掉了，也就是说用户第一次就点中了雷!但是这是不对的，第一次就中雷就没意思了。所以winmine釜底抽薪，吧这个雷换到别的地方去了。xp版winmine变态的地方在于，点人脸的时候会布雷，而点第一次的时候你永远不会踩中雷，因为他在第一次的时候偷偷把他换掉。如果你第一次就点中了布好的雷上，他就把这个位置换到别的地方，让他不是雷，如果你没点到雷上自然啥都不做，<em><strong>所以第一次永远点不到雷上</strong></em>。。。<br>
  [1][1]-[9][9]之外的，都是0x10    [1][1]-[9][9]初始化为0x0F，然后每次你按人脸的时候，布9科雷 布雷就是发现arr[j]&amp;0x80 == 0的时候进行arr[j] |= 0x80 高位置1，点了第一次，他会判断你是否中了雷，中了，就把雷放到别的地方去，反正总是让你第一次不中雷，中了，他自然再去获取随机数，找到一个没有雷的位置，然后设置为雷，然后把你踩的地方设为非雷</p>
<h2 id="xp扫雷内挂分析">XP扫雷内挂分析</h2>
<p>  先介绍一下xp扫雷内挂用法：</p>
<ul>
<li>1.打开扫雷界面</li>
<li>2.输入X Y Z Z Y</li>
<li>3.按一下右下角的shift键</li>
</ul>
<p>  这时，鼠标放在雷区活动，你会看到屏幕左上角有个小光点在一闪一闪。（很小很小的，不容易看。最好桌面是深色的，要不看不清），小光点出现，说明鼠标停在的格子不是雷，没有小光点，就是雷区！</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ec0000">static</span> <span style="color:#5f5fff">int</span> index<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">static</span> WCHAR str[]<span style="color:#ec0000">=</span><span style="color:#008900">L</span><span style="color:#008900">&#34;XYZZY&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">static</span> <span style="color:#5f5fff">int</span> xCur<span style="color:#ec0000">=-</span><span style="color:#008900">1</span>,yCur<span style="color:#ec0000">=-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">static</span> xBoxMax,yBoxMax;//雷区大小，初级为9*9，存储在注册表中
</span></span><span style="display:flex;"><span><span style="color:#ec0000">static</span> BYTE data[<span style="color:#008900">32</span>][<span style="color:#008900">32</span>];//雷区数据
</span></span><span style="display:flex;"><span><span style="color:#ec0000">switch</span>(uMsg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_KEYDOWN</span>:
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">switch</span>(wParam<span style="color:#ec0000">）</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">VK_SHIFT</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(index <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">5</span>)
</span></span><span style="display:flex;"><span>						index <span style="color:#ec0000">^=</span> <span style="color:#008900">0x14</span>;//如果前5字符正确，后面只要index&gt;=5即可
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">return</span> <span style="color:#5f5fff">DefWindowProc</span>();
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">VK_F4</span>:        
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">VK_F5</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">case</span> <span style="color:#ec0000">VK_F6</span>:
</span></span><span style="display:flex;"><span>			...<span style="color:#ec0000">无关代码</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(index <span style="color:#ec0000">&lt;</span> <span style="color:#008900">5</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(str[index] <span style="color:#ec0000">==</span> wParam)
</span></span><span style="display:flex;"><span>							index<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>							index<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">case</span> <span style="color:#ec0000">WM_MOUSEMOVE</span>:
</span></span><span style="display:flex;"><span>		{        
</span></span><span style="display:flex;"><span>			......
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(index)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>((index <span style="color:#ec0000">==</span> <span style="color:#008900">5</span> <span style="color:#ec0000">&amp;&amp;</span> wParam <span style="color:#ec0000">&amp;</span> MK_CONTROL) <span style="color:#ec0000">||</span> index <span style="color:#ec0000">&gt;</span> <span style="color:#008900">5</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">int</span> x<span style="color:#ec0000">=</span>LOWORD(lParam);
</span></span><span style="display:flex;"><span>					<span style="color:#5f5fff">int</span> y<span style="color:#ec0000">=</span>HIWORD(lParam);
</span></span><span style="display:flex;"><span>					xCur<span style="color:#ec0000">=</span>x<span style="color:#ec0000">/</span><span style="color:#008900">16</span>;//这个16显然可以推测为一个雷格子的大小了。。。
</span></span><span style="display:flex;"><span>					yCur<span style="color:#ec0000">=</span>(y<span style="color:#ec0000">-</span><span style="color:#008900">39</span>)<span style="color:#ec0000">/</span><span style="color:#008900">16</span>;//39同样可以推测为窗口顶部到雷区上边缘长度
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(xCur<span style="color:#ec0000">&gt;</span><span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> yCur<span style="color:#ec0000">&gt;</span><span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> xCur<span style="color:#ec0000">&lt;</span>xBoxMax <span style="color:#ec0000">&amp;&amp;</span> yCur<span style="color:#ec0000">&lt;</span>yBoxMax)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						HDC hdc<span style="color:#ec0000">=</span>GetDC(<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>						//注意下面data[yCur][xCur]是对的，yCur代表行，然而在绘图中却是竖直方向
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">if</span>(data[yCur][xCur]<span style="color:#ec0000">&amp;</span><span style="color:#008900">0x80</span>)//如果是雷
</span></span><span style="display:flex;"><span>								SetPixel(hdc,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,RGB(<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>_));//显示为黑
</span></span><span style="display:flex;"><span>						<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>								<span style="color:#5f5fff">SetPixel</span>(hdc,<span style="color:#008900">0</span>,<span style="color:#008900">0</span>,RGB(<span style="color:#008900">255</span>,<span style="color:#008900">255</span>,<span style="color:#008900">255</span>));                                        
</span></span><span style="display:flex;"><span>						ReleaseDC(<span style="color:#ec0000">NULL</span>,hdc);
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> <span style="color:#5f5fff">DefWindowProc</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="思考">思考</h3>
<ul>
<li>按照内挂用法，应该是按下5字母后按下shift，那为什么代码中是<code>index == 5 &amp;&amp; wParam &amp; MK_CONTROL</code>而不是<code>index == 5 &amp;&amp; wParam &amp; MK_SHIFT</code>呢?</li>
<li>另外除了xyzzy组合，你还可以输入什么序列来激活内挂？</li>
</ul>
<h2 id="win7扫雷分析">Win7扫雷分析</h2>
<p>  我系统Win8.1，直接把Win7 MineSweeper那个文件夹弄过来，，是无法运行扫雷的。由于是系统组件，ida载入可以得到符号，先研究为何无法运行！从用户入口WinMain开始跟：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">WinMain</span>(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span style="color:#5f5fff">int</span> nShowCmd)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  DWORD v4; // ecx@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> result; // eax@2
</span></span><span style="display:flex;"><span>  HMODULE v6; // eax@3
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v7; // eax@6
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v8; // esi@7
</span></span><span style="display:flex;"><span>  WCHAR Buffer; // [sp+4h] [bp-24h]@3
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">char</span> v10; // [sp+6h] [bp-22h]@3
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">__int16</span> v11; // [sp+22h] [bp-6h]@3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  HeapSetInformation(<span style="color:#008900">0</span>, HeapEnableTerminationOnCorruption, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( IsGamePlayable(v4, <span style="color:#008900">L</span><span style="color:#008900">&#34;Shell-InBoxGames-Minesweeper-EnableGame&#34;</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    g_hInstance <span style="color:#ec0000">=</span> hInstance;
</span></span><span style="display:flex;"><span>    Buffer <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    memset(<span style="color:#ec0000">&amp;</span>v10, <span style="color:#008900">0</span>, <span style="color:#008900">0x1Cu</span>);
</span></span><span style="display:flex;"><span>    v11 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ec0000">=</span> GetModuleHandleW(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( LoadStringW(v6, <span style="color:#008900">0xFBCu</span>, <span style="color:#ec0000">&amp;</span>Buffer, <span style="color:#008900">16</span>) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">!</span>lstrcmpW(<span style="color:#ec0000">&amp;</span>Buffer, <span style="color:#008900">L</span><span style="color:#008900">&#34;0&#34;</span>) )
</span></span><span style="display:flex;"><span>      g_Flowerbed <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    v7 <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">4u</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( v7 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v7 <span style="color:#ec0000">=</span> EngineHandler<span style="color:#ec0000">::</span><span style="color:#ec0000">`</span>vftable<span style="color:#ec0000">&#39;</span>;
</span></span><span style="display:flex;"><span>      v8 <span style="color:#ec0000">=</span> v7;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v8 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    RegisterLogNameResolver((<span style="color:#ec0000">const</span> <span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span> <span style="color:#ec0000">*</span>(<span style="color:#ec0000">__stdcall</span> <span style="color:#ec0000">*</span>)(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span>))MsLog<span style="color:#ec0000">::</span>MsLogResolver);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( InitializeEngine((<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>)v8, <span style="color:#008900">0</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( v8 )
</span></span><span style="display:flex;"><span>        IEngineInterface<span style="color:#ec0000">::</span><span style="color:#ec0000">`</span>scalar deleting destructor<span style="color:#ec0000">&#39;</span>(v8, <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>      result <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( v8 )
</span></span><span style="display:flex;"><span>        IEngineInterface<span style="color:#ec0000">::</span><span style="color:#ec0000">`</span>scalar deleting destructor<span style="color:#ec0000">&#39;</span>(v8, <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>      result <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    result <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>发现IsGamePlayable处返回失败，在此需要将返回值改为TRUE，接着调试，发现InitializeEngine执行后直接进程结束，因此跟入该函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">bool</span> <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">InitializeEngine</span>(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>a1, <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IControllerInterface</span> <span style="color:#ec0000">*</span>a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  DialogHelper <span style="color:#ec0000">*</span>v2; // eax@1
</span></span><span style="display:flex;"><span>  DWORD v3; // ST20_4@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v4; // eax@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v5; // ecx@1
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">__int16</span> v6; // dx@2
</span></span><span style="display:flex;"><span>  rsize_t v7; // ebx@3
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>v8; // eax@3
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">const</span> <span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>v10; // eax@5
</span></span><span style="display:flex;"><span>  HANDLE v11; // ebx@5
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>v12; // eax@8
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">const</span> WCHAR <span style="color:#ec0000">*</span>v13; // esi@8
</span></span><span style="display:flex;"><span>  HWND v14; // ebx@8
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">const</span> WCHAR <span style="color:#ec0000">*</span>v15; // eax@12
</span></span><span style="display:flex;"><span>  LPWSTR <span style="color:#ec0000">*</span>v16; // eax@12
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> v17; // ecx@12
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">const</span> WCHAR <span style="color:#ec0000">*</span>v18; // eax@16
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">const</span> <span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span> <span style="color:#ec0000">*</span>v19; // eax@18
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span> <span style="color:#ec0000">*</span>v20; // eax@19
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v21; // eax@28
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>v22; // eax@31
</span></span><span style="display:flex;"><span>  DWORD v23; // eax@31
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> i; // ecx@31
</span></span><span style="display:flex;"><span>  WCHAR v25; // dx@32
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v26; // eax@38
</span></span><span style="display:flex;"><span>  XmlManager <span style="color:#ec0000">*</span>v27; // eax@39
</span></span><span style="display:flex;"><span>  ResourceBase <span style="color:#ec0000">*</span>v28; // ecx@41
</span></span><span style="display:flex;"><span>  ResourceWMA <span style="color:#ec0000">*</span>v29; // ecx@41
</span></span><span style="display:flex;"><span>  DllFileMgr <span style="color:#ec0000">*</span>v30; // eax@45
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>v31; // eax@47
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">bool</span> v32; // al@47
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>v33; // esi@48
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> (<span style="color:#ec0000">**</span>v34)(<span style="color:#5f5fff">void</span>); // eax@48
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v35; // eax@48
</span></span><span style="display:flex;"><span>  DWORD v36; // eax@54
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v37; // eax@57
</span></span><span style="display:flex;"><span>  ResourceManager <span style="color:#ec0000">*</span>v38; // eax@58
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v39; // eax@64
</span></span><span style="display:flex;"><span>  RenderManager <span style="color:#ec0000">*</span>v40; // eax@65
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v41; // eax@69
</span></span><span style="display:flex;"><span>  Audio <span style="color:#ec0000">*</span>v42; // eax@70
</span></span><span style="display:flex;"><span>  CommonControllerThread <span style="color:#ec0000">*</span>v43; // eax@75
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v44; // eax@77
</span></span><span style="display:flex;"><span>  ResourceWMA <span style="color:#ec0000">*</span>v45; // eax@78
</span></span><span style="display:flex;"><span>  XmlNode <span style="color:#ec0000">*</span>v46; // eax@82
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span> <span style="color:#ec0000">*</span>v47; // edi@84
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>v48; // edi@90
</span></span><span style="display:flex;"><span>  DWORD v49; // ST20_4@96
</span></span><span style="display:flex;"><span>  HMODULE v50; // eax@96
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">bool</span> nSize; // [sp+14h] [bp-6ACh]@0
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">const</span> <span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span> <span style="color:#ec0000">*</span>v52; // [sp+18h] [bp-6A8h]@0
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> (<span style="color:#ec0000">__stdcall</span> <span style="color:#ec0000">*</span>v53)(); // [sp+18h] [bp-6A8h]@55
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">char</span> v54; // [sp+24h] [bp-69Ch]@48
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">tagMSG</span> Msg; // [sp+30h] [bp-690h]@98
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v56; // [sp+4Ch] [bp-674h]@44
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v57; // [sp+50h] [bp-670h]@44
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v58; // [sp+54h] [bp-66Ch]@44
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v59; // [sp+58h] [bp-668h]@44
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> (<span style="color:#ec0000">__stdcall</span> <span style="color:#ec0000">*</span>v60)(<span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int32</span> <span style="color:#ec0000">*</span>); // [sp+5Ch] [bp-664h]@44
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> (<span style="color:#ec0000">__stdcall</span> <span style="color:#ec0000">*</span>v61)(<span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int32</span>); // [sp+60h] [bp-660h]@104
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v62; // [sp+64h] [bp-65Ch]@44
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v63; // [sp+68h] [bp-658h]@44
</span></span><span style="display:flex;"><span>  HWND v64; // [sp+6Ch] [bp-654h]@62
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v65; // [sp+70h] [bp-650h]@62
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v66; // [sp+74h] [bp-64Ch]@62
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v67; // [sp+78h] [bp-648h]@62
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v68; // [sp+7Ch] [bp-644h]@62
</span></span><span style="display:flex;"><span>  RAWINPUTDEVICE pRawInputDevices; // [sp+80h] [bp-640h]@47
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> pNumArgs; // [sp+8Ch] [bp-634h]@12
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>v71; // [sp+90h] [bp-630h]@1
</span></span><span style="display:flex;"><span>  XmlNode <span style="color:#ec0000">*</span>v72; // [sp+94h] [bp-62Ch]@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> v73; // [sp+98h] [bp-628h]@12
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>pv; // [sp+9Ch] [bp-624h]@12
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>Dst; // [sp+A0h] [bp-620h]@3
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">bool</span> v76; // [sp+A7h] [bp-619h]@16
</span></span><span style="display:flex;"><span>  OLECHAR psz; // [sp+A8h] [bp-618h]@17
</span></span><span style="display:flex;"><span>  WCHAR Filename[<span style="color:#008900">518</span>]; // [sp+2B0h] [bp-410h]@31
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v79; // [sp+6BCh] [bp-4h]@16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  v71 <span style="color:#ec0000">=</span> a1;
</span></span><span style="display:flex;"><span>  v72 <span style="color:#ec0000">=</span> a2;
</span></span><span style="display:flex;"><span>  v2 <span style="color:#ec0000">=</span> (DialogHelper <span style="color:#ec0000">*</span>)GetModuleHandleW(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>  DialogHelper<span style="color:#ec0000">::</span>Init(v2, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>, nSize);
</span></span><span style="display:flex;"><span>  v4 <span style="color:#ec0000">=</span> (<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span> (__thiscall <span style="color:#ec0000">**</span>)(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>, DWORD))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>))(a1, v3);//EngineHandler::GetProjectName
</span></span><span style="display:flex;"><span>  v5 <span style="color:#ec0000">=</span> v4 <span style="color:#ec0000">+</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">do</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_WORD <span style="color:#ec0000">*</span>)v4;
</span></span><span style="display:flex;"><span>    v4 <span style="color:#ec0000">+=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">while</span> ( v6 );
</span></span><span style="display:flex;"><span>  v7 <span style="color:#ec0000">=</span> ((v4 <span style="color:#ec0000">-</span> v5) <span style="color:#ec0000">&gt;&gt;</span> <span style="color:#008900">1</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">24</span>;
</span></span><span style="display:flex;"><span>  v8 <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>[](<span style="color:#008900">2</span> <span style="color:#ec0000">*</span> v7);
</span></span><span style="display:flex;"><span>  Dst <span style="color:#ec0000">=</span> v8;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( v8 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    wcscpy_s(v8, v7, <span style="color:#008900">L</span><span style="color:#008900">&#34;Local</span><span style="color:#008900">\\</span><span style="color:#008900">Oberon_&#34;</span>);
</span></span><span style="display:flex;"><span>    v10 <span style="color:#ec0000">=</span> (<span style="color:#ec0000">const</span> <span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span> (__thiscall <span style="color:#ec0000">**</span>)(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>))(a1);//EngineHandler::GetProjectName
</span></span><span style="display:flex;"><span>    wcscat_s(Dst, v7, v10);
</span></span><span style="display:flex;"><span>    wcscat_s(Dst, v7, <span style="color:#008900">L</span><span style="color:#008900">&#34;_Singleton&#34;</span>);
</span></span><span style="display:flex;"><span>    v11 <span style="color:#ec0000">=</span> CreateMutexW(<span style="color:#008900">0</span>, <span style="color:#008900">1</span>, Dst);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">operator</span> <span style="color:#ec0000">delete</span>(Dst);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( v11 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( GetLastError() <span style="color:#ec0000">!=</span> <span style="color:#008900">183</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v15 <span style="color:#ec0000">=</span> GetCommandLineW();
</span></span><span style="display:flex;"><span>        pNumArgs <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        v16 <span style="color:#ec0000">=</span> CommandLineToArgvW(v15, <span style="color:#ec0000">&amp;</span>pNumArgs);
</span></span><span style="display:flex;"><span>        v17 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        pv <span style="color:#ec0000">=</span> v16;
</span></span><span style="display:flex;"><span>        v73 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( pNumArgs <span style="color:#ec0000">&gt;</span> <span style="color:#008900">1</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">do</span>
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>wcscmp(<span style="color:#ec0000">*</span>((<span style="color:#ec0000">const</span> <span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span> <span style="color:#ec0000">**</span>)pv <span style="color:#ec0000">+</span> v17), <span style="color:#008900">L</span><span style="color:#008900">&#34;-mce&#34;</span>) )
</span></span><span style="display:flex;"><span>              g_bMediaCenter <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>            v17 <span style="color:#ec0000">=</span> v73<span style="color:#ec0000">++</span> <span style="color:#ec0000">+</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">while</span> ( (<span style="color:#5f5fff">signed</span> <span style="color:#5f5fff">int</span>)v73 <span style="color:#ec0000">&lt;</span> pNumArgs );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        v18 <span style="color:#ec0000">=</span> GetCommandLineW();
</span></span><span style="display:flex;"><span>        RegisterApplicationRestart(v18, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>        CoInitialize(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>        v76 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        Dst <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        v79 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( CoCreateInstance(
</span></span><span style="display:flex;"><span>               <span style="color:#ec0000">&amp;</span>_GUID_9a5ea990_3034_4d6f_9128_01f3c61022bc,
</span></span><span style="display:flex;"><span>               <span style="color:#008900">0</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#008900">1u</span>,
</span></span><span style="display:flex;"><span>               <span style="color:#ec0000">&amp;</span>_GUID_e7b2fb72_d728_49b3_a5f2_18ebf5f1349e,
</span></span><span style="display:flex;"><span>               (LPVOID <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>Dst) <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">&amp;&amp;</span> SHGetFolderPathEx(<span style="color:#ec0000">&amp;</span>FOLDERID_ProgramFiles, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>, <span style="color:#ec0000">&amp;</span>psz, <span style="color:#008900">260</span>) <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">0</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v19 <span style="color:#ec0000">=</span> (<span style="color:#ec0000">const</span> <span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span> <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span> (__thiscall <span style="color:#ec0000">**</span>)(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)a1 <span style="color:#ec0000">+</span> <span style="color:#008900">84</span>))(a1);//EngineHandler::GetGdfPath
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">if</span> ( StringCchCatW(<span style="color:#ec0000">&amp;</span>psz, <span style="color:#008900">0x104u</span>, v19) <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">0</span> )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            v20 <span style="color:#ec0000">=</span> SysAllocString(<span style="color:#ec0000">&amp;</span>psz);
</span></span><span style="display:flex;"><span>            g_bstrGDFPath <span style="color:#ec0000">=</span> v20;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> ( v20 )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">if</span> ( SysStringLen(v20)
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">&amp;&amp;</span> (<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span> (<span style="color:#ec0000">__stdcall</span> <span style="color:#ec0000">**</span>)(<span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>, <span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span> <span style="color:#ec0000">*</span>, <span style="color:#5f5fff">void</span> <span style="color:#ec0000">**</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)Dst <span style="color:#ec0000">+</span> <span style="color:#008900">24</span>))(//CGameExplorer::VerifyAccess
</span></span><span style="display:flex;"><span>                     Dst,
</span></span><span style="display:flex;"><span>                     g_bstrGDFPath,
</span></span><span style="display:flex;"><span>                     <span style="color:#ec0000">&amp;</span>pv) <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">&amp;&amp;</span> pv )
</span></span><span style="display:flex;"><span>                v76 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        v79 <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( Dst )
</span></span><span style="display:flex;"><span>          (<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">void</span> (<span style="color:#ec0000">__stdcall</span> <span style="color:#ec0000">**</span>)(<span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)Dst <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>))(Dst);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>v76 )
</span></span><span style="display:flex;"><span>          CleanupEngine(<span style="color:#008900">5</span>);
</span></span><span style="display:flex;"><span>        v21 <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">4u</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( v21 )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v21 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>          g_pSecondTimerCallback <span style="color:#ec0000">=</span> v21;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          g_pSecondTimerCallback <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        _set_new_handler(HandleNewFail);
</span></span><span style="display:flex;"><span>        _set_new_mode(<span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>        g_pInterface <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)a1;
</span></span><span style="display:flex;"><span>        v22 <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span> (__thiscall <span style="color:#ec0000">**</span>)(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>))(a1);
</span></span><span style="display:flex;"><span>        g_wszProjectName <span style="color:#ec0000">=</span> LocalizeMessage(v22);
</span></span><span style="display:flex;"><span>        v23 <span style="color:#ec0000">=</span> GetModuleFileNameW(<span style="color:#008900">0</span>, Filename, <span style="color:#008900">0x200u</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span> ( i <span style="color:#ec0000">=</span> v23 <span style="color:#ec0000">-</span> <span style="color:#008900">1</span>; ; <span style="color:#ec0000">--</span>i )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">if</span> ( i <span style="color:#ec0000">&gt;</span> v23 )
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">goto</span> LABEL_38;
</span></span><span style="display:flex;"><span>          v25 <span style="color:#ec0000">=</span> Filename[i];
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">if</span> ( v25 <span style="color:#ec0000">==</span> <span style="color:#008900">47</span> <span style="color:#ec0000">||</span> v25 <span style="color:#ec0000">==</span> <span style="color:#008900">92</span> )
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Filename[i] <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">LABEL_38</span>:
</span></span><span style="display:flex;"><span>        SetCurrentDirectoryW(Filename);
</span></span><span style="display:flex;"><span>        XmlNode<span style="color:#ec0000">::</span>SetNodeName((XmlNode <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>ErrorXml, <span style="color:#008900">L</span><span style="color:#008900">&#34;ErrorLog&#34;</span>);
</span></span><span style="display:flex;"><span>        v26 <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x10u</span>);
</span></span><span style="display:flex;"><span>        pv <span style="color:#ec0000">=</span> v26;
</span></span><span style="display:flex;"><span>        v79 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( v26 )
</span></span><span style="display:flex;"><span>          v27 <span style="color:#ec0000">=</span> (XmlManager <span style="color:#ec0000">*</span>)XmlManager<span style="color:#ec0000">::</span>XmlManager((XmlManager <span style="color:#ec0000">*</span>)v26);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>          v27 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        v79 <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        g_pXmlManager <span style="color:#ec0000">=</span> v27;
</span></span><span style="display:flex;"><span>        CheckAllocation((<span style="color:#ec0000">const</span> <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)v27);
</span></span><span style="display:flex;"><span>        ResourceBase<span style="color:#ec0000">::</span>SetNameForDPI(v28, (<span style="color:#5f5fff">bool</span>)g_wszProjectName);
</span></span><span style="display:flex;"><span>        Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1129</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Initializing Virtual FS&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( ResourceWMA<span style="color:#ec0000">::</span>LoadAsNeeded(v29) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1138</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Project name localized to: %s&#34;</span>, g_wszProjectName);
</span></span><span style="display:flex;"><span>          OutputDebugStringW(Filename);
</span></span><span style="display:flex;"><span>          Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1142</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Using working directory: %s&#34;</span>, Filename);
</span></span><span style="display:flex;"><span>          Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1146</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Initializing GDI+&#34;</span>);
</span></span><span style="display:flex;"><span>          v56 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>          v58 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>          v57 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>          v59 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>          GdiplusStartup(<span style="color:#ec0000">&amp;</span>g_GdiPlusToken, <span style="color:#ec0000">&amp;</span>v56, <span style="color:#ec0000">&amp;</span>v60);
</span></span><span style="display:flex;"><span>          v63 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>          v62 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>          LoadWindowPrefs(<span style="color:#ec0000">&amp;</span>v63, <span style="color:#ec0000">&amp;</span>v62);
</span></span><span style="display:flex;"><span>          pv <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x1440u</span>);
</span></span><span style="display:flex;"><span>          v79 <span style="color:#ec0000">=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">if</span> ( pv )
</span></span><span style="display:flex;"><span>            v30 <span style="color:#ec0000">=</span> (DllFileMgr <span style="color:#ec0000">*</span>)DllFileMgr<span style="color:#ec0000">::</span>DllFileMgr(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>            v30 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>          v79 <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">::</span>pv <span style="color:#ec0000">=</span> v30;
</span></span><span style="display:flex;"><span>          v31 <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">**</span>(<span style="color:#5f5fff">int</span> (<span style="color:#ec0000">***</span>)(<span style="color:#5f5fff">void</span>))v71)();
</span></span><span style="display:flex;"><span>          Str<span style="color:#ec0000">::</span>Str(v31);
</span></span><span style="display:flex;"><span>          v79 <span style="color:#ec0000">=</span> <span style="color:#008900">3</span>;
</span></span><span style="display:flex;"><span>          v32 <span style="color:#ec0000">=</span> DllFileMgr<span style="color:#ec0000">::</span>Open(<span style="color:#ec0000">::</span>pv, (<span style="color:#ec0000">const</span> <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">Str</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>pRawInputDevices, g_bDebugEnabled, <span style="color:#008900">L</span><span style="color:#008900">&#34;input&#34;</span>);
</span></span><span style="display:flex;"><span>          v79 <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>          v76 <span style="color:#ec0000">=</span> v32 <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>          Str<span style="color:#ec0000">::~</span>Str((Str <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>pRawInputDevices);
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">if</span> ( v76 )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            D3DXTex<span style="color:#ec0000">::</span>TF_Row<span style="color:#ec0000">::</span>TF_Row((D3DXTex<span style="color:#ec0000">::</span>TF_Row <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>pRawInputDevices);
</span></span><span style="display:flex;"><span>            v79 <span style="color:#ec0000">=</span> <span style="color:#008900">4</span>;
</span></span><span style="display:flex;"><span>            v33 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(<span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">**</span>)(Str<span style="color:#ec0000">::</span>Str(<span style="color:#008900">0x37Cu</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>            v34 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span> (<span style="color:#ec0000">***</span>)(<span style="color:#5f5fff">void</span>))v71;
</span></span><span style="display:flex;"><span>            LOBYTE(v79) <span style="color:#ec0000">=</span> <span style="color:#008900">5</span>;
</span></span><span style="display:flex;"><span>            v35 <span style="color:#ec0000">=</span> (<span style="color:#ec0000">*</span>v34)();
</span></span><span style="display:flex;"><span>            Str<span style="color:#ec0000">::</span>Format((Str <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>pRawInputDevices, v33, v35);
</span></span><span style="display:flex;"><span>            LOBYTE(v79) <span style="color:#ec0000">=</span> <span style="color:#008900">4</span>;
</span></span><span style="display:flex;"><span>            Str<span style="color:#ec0000">::~</span>Str((Str <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v54);
</span></span><span style="display:flex;"><span>            DialogHelper<span style="color:#ec0000">::</span>ShowMessageBox(
</span></span><span style="display:flex;"><span>              <span style="color:#008900">0x385u</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#008900">0</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#008900">1u</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#008900">0xFFFEu</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#008900">0</span>,
</span></span><span style="display:flex;"><span>              (<span style="color:#ec0000">const</span> <span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span> <span style="color:#ec0000">*</span>)pRawInputDevices.hwndTarget,
</span></span><span style="display:flex;"><span>              (<span style="color:#ec0000">const</span> <span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int16</span> <span style="color:#ec0000">*</span>)<span style="color:#008900">1</span>,
</span></span><span style="display:flex;"><span>              (<span style="color:#5f5fff">bool</span>)v52);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">else</span> <span style="color:#ec0000">if</span> ( CreateGameWindow() )
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> ( g_bMediaCenter )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1211</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Initializing MCE Dialog&#34;</span>);
</span></span><span style="display:flex;"><span>              DialogHelper<span style="color:#ec0000">::</span>InitMCE(<span style="color:#008900">0</span>, v52);
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">if</span> ( g_bMediaCenter )
</span></span><span style="display:flex;"><span>              {
</span></span><span style="display:flex;"><span>                Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1220</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Registering for raw input, for remote control&#34;</span>);
</span></span><span style="display:flex;"><span>                pRawInputDevices.usUsagePage <span style="color:#ec0000">=</span> <span style="color:#008900">12</span>;
</span></span><span style="display:flex;"><span>                pRawInputDevices.usUsage <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>                pRawInputDevices.hwndTarget <span style="color:#ec0000">=</span> g_hWnd;
</span></span><span style="display:flex;"><span>                pRawInputDevices.dwFlags <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>RegisterRawInputDevices(<span style="color:#ec0000">&amp;</span>pRawInputDevices, <span style="color:#008900">1u</span>, <span style="color:#008900">0xCu</span>) )
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                  v36 <span style="color:#ec0000">=</span> GetLastError();
</span></span><span style="display:flex;"><span>                  Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1231</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Register failed, winerror %d&#34;</span>, v36);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>              }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1237</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Adding system events&#34;</span>);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">2</span>, Event_MouseEnter<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">4</span>, Event_MouseDown<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">5</span>, Event_MouseDoubleClick<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">3</span>, Event_MouseLeave<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">6</span>, Event_MouseRelease<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">7</span>, Event_MouseReleaseOut<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">8</span>, Event_MouseStatusBarClick<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">9</span>, Event_MouseOuterDown<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">10</span>, Event_MouseOuterRelease<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">11</span>, Event_MouseGlobalRelease<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">1</span>, Event_ButtonClick<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">13</span>, Event_AnimationComplete<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">12</span>, Event_AnimationFrame<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">14</span>, Event_AnimationInt<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">15</span>, Event_Timer<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">16</span>, Event_FocusCheck<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">17</span>, Event_FocusGot<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">18</span>, Event_FocusLost<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">19</span>, Event_FocusSelect<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">20</span>, Event_FocusUnSelect<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">21</span>, Event_FocusGetNodeAtDir<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">22</span>, Event_FocusGetNextTabNode<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">23</span>, Event_InitComplete<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">24</span>, Event_DoDefaultAction<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">25</span>, Event_DragCheck<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">26</span>, Event_DragStart<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">27</span>, Event_DragMove<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">28</span>, Event_DragEnd<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">29</span>, Event_KeyDown<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">30</span>, Event_KeyUp<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">31</span>, Event_AccessGetParent<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">32</span>, Event_AccessGetChildCount<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">33</span>, Event_AccessGetChild<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">34</span>, Event_TipClose<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">37</span>, Event_DpiChange<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Event<span style="color:#ec0000">::</span>RegisterEventType(<span style="color:#008900">35</span>, Event_ControllerKey<span style="color:#ec0000">::</span>Create);
</span></span><span style="display:flex;"><span>            Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1280</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Registering Node Types&#34;</span>);
</span></span><span style="display:flex;"><span>            NodeButton<span style="color:#ec0000">::</span>Register();
</span></span><span style="display:flex;"><span>            NodeLabel<span style="color:#ec0000">::</span>Register();
</span></span><span style="display:flex;"><span>            NodeBase<span style="color:#ec0000">::</span>Register();
</span></span><span style="display:flex;"><span>            NodeSprite<span style="color:#ec0000">::</span>Register();
</span></span><span style="display:flex;"><span>            NodeEmitter<span style="color:#ec0000">::</span>Register();
</span></span><span style="display:flex;"><span>            NodeShot<span style="color:#ec0000">::</span>Register();
</span></span><span style="display:flex;"><span>            NodeNumber<span style="color:#ec0000">::</span>Register();
</span></span><span style="display:flex;"><span>            Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1291</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Initializing Timekeeping&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> ( Timekeeping<span style="color:#ec0000">::</span>InitializeTimekeeping((Timekeeping <span style="color:#ec0000">*</span>)v52) )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              DialogHelper<span style="color:#ec0000">::</span>SetDialogShutdownCallback((DialogHelper <span style="color:#ec0000">*</span>)Engine_ResetTimer, v53);
</span></span><span style="display:flex;"><span>              Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1304</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Initializing ResourceManager&#34;</span>);
</span></span><span style="display:flex;"><span>              v37 <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x54u</span>);
</span></span><span style="display:flex;"><span>              pv <span style="color:#ec0000">=</span> v37;
</span></span><span style="display:flex;"><span>              v79 <span style="color:#ec0000">=</span> <span style="color:#008900">6</span>;
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">if</span> ( v37 )
</span></span><span style="display:flex;"><span>                v38 <span style="color:#ec0000">=</span> (ResourceManager <span style="color:#ec0000">*</span>)ResourceManager<span style="color:#ec0000">::</span>ResourceManager(v37);
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                v38 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>              v79 <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>              g_pResourceManager <span style="color:#ec0000">=</span> v38;
</span></span><span style="display:flex;"><span>              CheckAllocation((<span style="color:#ec0000">const</span> <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)v38);
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">if</span> ( ResourceManager<span style="color:#ec0000">::</span>Initialize(g_pResourceManager) )
</span></span><span style="display:flex;"><span>              {
</span></span><span style="display:flex;"><span>                v65 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                v66 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                v68 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                v64 <span style="color:#ec0000">=</span> g_hRenderWindow;
</span></span><span style="display:flex;"><span>                LOWORD(v68) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                v67 <span style="color:#ec0000">=</span> <span style="color:#008900">32</span>;
</span></span><span style="display:flex;"><span>                (<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">void</span> (<span style="color:#ec0000">__stdcall</span> <span style="color:#ec0000">**</span>)(<span style="color:#5f5fff">int</span> <span style="color:#ec0000">*</span>, <span style="color:#5f5fff">int</span> <span style="color:#ec0000">*</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)g_pInterface <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>))(<span style="color:#ec0000">&amp;</span>v65, <span style="color:#ec0000">&amp;</span>v66);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span> ( g_bDoubleDPI )
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                  v65 <span style="color:#ec0000">*=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>                  v66 <span style="color:#ec0000">*=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1331</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Initializing RenderManager&#34;</span>);
</span></span><span style="display:flex;"><span>                v39 <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x90u</span>);
</span></span><span style="display:flex;"><span>                pv <span style="color:#ec0000">=</span> v39;
</span></span><span style="display:flex;"><span>                v79 <span style="color:#ec0000">=</span> <span style="color:#008900">7</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span> ( v39 )
</span></span><span style="display:flex;"><span>                  v40 <span style="color:#ec0000">=</span> (RenderManager <span style="color:#ec0000">*</span>)RenderManager<span style="color:#ec0000">::</span>RenderManager(v39);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                  v40 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                v79 <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>                g_pRenderManager <span style="color:#ec0000">=</span> v40;
</span></span><span style="display:flex;"><span>                CheckAllocation((<span style="color:#ec0000">const</span> <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)v40);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span> ( RenderManager<span style="color:#ec0000">::</span>Initialize(g_pRenderManager, (<span style="color:#ec0000">const</span> <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">RenderInitializeOptions</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>v64) )
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                  Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1342</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Initializing Audio&#34;</span>);
</span></span><span style="display:flex;"><span>                  v41 <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x28u</span>);
</span></span><span style="display:flex;"><span>                  pv <span style="color:#ec0000">=</span> v41;
</span></span><span style="display:flex;"><span>                  v79 <span style="color:#ec0000">=</span> <span style="color:#008900">8</span>;
</span></span><span style="display:flex;"><span>                  <span style="color:#ec0000">if</span> ( v41 )
</span></span><span style="display:flex;"><span>                    v42 <span style="color:#ec0000">=</span> (Audio <span style="color:#ec0000">*</span>)Audio<span style="color:#ec0000">::</span>Audio(v41);
</span></span><span style="display:flex;"><span>                  <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                    v42 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                  v79 <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>                  g_pAudio <span style="color:#ec0000">=</span> v42;
</span></span><span style="display:flex;"><span>                  CheckAllocation((<span style="color:#ec0000">const</span> <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)v42);
</span></span><span style="display:flex;"><span>                  <span style="color:#ec0000">if</span> ( Audio<span style="color:#ec0000">::</span>Initialize(g_pAudio) )
</span></span><span style="display:flex;"><span>                  {
</span></span><span style="display:flex;"><span>                    Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1354</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Initializing XNA Common Controller&#34;</span>);
</span></span><span style="display:flex;"><span>                    pv <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x80u</span>);
</span></span><span style="display:flex;"><span>                    v79 <span style="color:#ec0000">=</span> <span style="color:#008900">9</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span> ( pv )
</span></span><span style="display:flex;"><span>                      v43 <span style="color:#ec0000">=</span> (CommonControllerThread <span style="color:#ec0000">*</span>)CommonControllerThread<span style="color:#ec0000">::</span>CommonControllerThread(
</span></span><span style="display:flex;"><span>                                                        (<span style="color:#5f5fff">int</span>)g_hWnd,
</span></span><span style="display:flex;"><span>                                                        g_bMediaCenter,
</span></span><span style="display:flex;"><span>                                                        (<span style="color:#5f5fff">int</span>)v72);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                      v43 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                    v79 <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>                    g_pCommonController <span style="color:#ec0000">=</span> v43;
</span></span><span style="display:flex;"><span>                    Thread<span style="color:#ec0000">::</span>Begin(v43);
</span></span><span style="display:flex;"><span>                    Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1361</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Initializing Timer&#34;</span>);
</span></span><span style="display:flex;"><span>                    v44 <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x34u</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span> ( v44 )
</span></span><span style="display:flex;"><span>                      v45 <span style="color:#ec0000">=</span> (ResourceWMA <span style="color:#ec0000">*</span>)Timer<span style="color:#ec0000">::</span>Timer(v44);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                      v45 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                    g_pTimer <span style="color:#ec0000">=</span> v45;
</span></span><span style="display:flex;"><span>                    CheckAllocation((<span style="color:#ec0000">const</span> <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)v45);
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span> ( ResourceWMA<span style="color:#ec0000">::</span>LoadAsNeeded(g_pTimer) )
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                      Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1372</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Loading Fonts&#34;</span>);
</span></span><span style="display:flex;"><span>                      v46 <span style="color:#ec0000">=</span> XmlManager<span style="color:#ec0000">::</span>GetXml(g_pXmlManager, <span style="color:#008900">L</span><span style="color:#008900">&#34;xml</span><span style="color:#008900">\\</span><span style="color:#008900">Fonts.xml&#34;</span>);
</span></span><span style="display:flex;"><span>                      <span style="color:#ec0000">if</span> ( v46 )
</span></span><span style="display:flex;"><span>                      {
</span></span><span style="display:flex;"><span>                        pv <span style="color:#ec0000">=</span> XmlNode<span style="color:#ec0000">::</span>XPathElementSearch(v46, <span style="color:#008900">L</span><span style="color:#008900">&#34;/Font&#34;</span>, <span style="color:#ec0000">&amp;</span>v73);
</span></span><span style="display:flex;"><span>                        Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1383</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;%d Fonts Found&#34;</span>, v73);
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">for</span> ( Dst <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>; (<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span>)Dst <span style="color:#ec0000">&lt;</span> v73; Dst <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>)((<span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>)Dst <span style="color:#ec0000">+</span> <span style="color:#008900">1</span>) )
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                          v47 <span style="color:#ec0000">=</span> XmlNode<span style="color:#ec0000">::</span>GetNodeValue(<span style="color:#ec0000">*</span>((XmlNode <span style="color:#ec0000">**</span>)pv <span style="color:#ec0000">+</span> (_DWORD)Dst));
</span></span><span style="display:flex;"><span>                          Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1388</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Loading Font: %s&#34;</span>, v47);
</span></span><span style="display:flex;"><span>                          <span style="color:#ec0000">if</span> ( AddFontResourceW(v47) )
</span></span><span style="display:flex;"><span>                          {
</span></span><span style="display:flex;"><span>                            Array<span style="color:#ec0000">&lt;</span>NodeBase <span style="color:#ec0000">*&gt;::</span>Add(v47);
</span></span><span style="display:flex;"><span>                          }
</span></span><span style="display:flex;"><span>                          <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                          {
</span></span><span style="display:flex;"><span>                            Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1412</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Couldn&#39;t add font: %s&#34;</span>, v47);
</span></span><span style="display:flex;"><span>                            <span style="color:#ec0000">operator</span> <span style="color:#ec0000">delete</span>(v47);
</span></span><span style="display:flex;"><span>                          }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">operator</span> <span style="color:#ec0000">delete</span>(pv);
</span></span><span style="display:flex;"><span>                      }
</span></span><span style="display:flex;"><span>                      <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                      {
</span></span><span style="display:flex;"><span>                        Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1426</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;No Font Xml Found&#34;</span>);
</span></span><span style="display:flex;"><span>                      }
</span></span><span style="display:flex;"><span>                      Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1431</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Registering for session notification&#34;</span>);
</span></span><span style="display:flex;"><span>                      WTSRegisterSessionNotification(g_hWnd, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                      v72 <span style="color:#ec0000">=</span> XmlManager<span style="color:#ec0000">::</span>GetXml(g_pXmlManager, <span style="color:#008900">L</span><span style="color:#008900">&#34;engine.xml&#34;</span>);
</span></span><span style="display:flex;"><span>                      g_bInInitializer <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>                      Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1439</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Engine Initialization Complete: Initializing Game Code.&#34;</span>);
</span></span><span style="display:flex;"><span>                      v48 <span style="color:#ec0000">=</span> v71;
</span></span><span style="display:flex;"><span>                      <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int8</span>)(<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span> (__thiscall <span style="color:#ec0000">**</span>)(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v71 <span style="color:#ec0000">+</span> <span style="color:#008900">48</span>))(v71) )
</span></span><span style="display:flex;"><span>                      {
</span></span><span style="display:flex;"><span>                        Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1442</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Game code initialization failed.&#34;</span>);
</span></span><span style="display:flex;"><span>                        CleanupEngine(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                      }
</span></span><span style="display:flex;"><span>                      g_bInInitializer <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                      <span style="color:#ec0000">if</span> ( v72 )
</span></span><span style="display:flex;"><span>                        g_bFocusPause <span style="color:#ec0000">=</span> XmlNode<span style="color:#ec0000">::</span>GetXmlInt(v72, <span style="color:#008900">L</span><span style="color:#008900">&#34;/PauseOnLostFocus&#34;</span>, <span style="color:#ec0000">-</span><span style="color:#008900">1</span>) <span style="color:#ec0000">&gt;</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                      Engine_LoadingComplete();
</span></span><span style="display:flex;"><span>                      g_Accelerator <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                      <span style="color:#ec0000">if</span> ( (<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span> (__thiscall <span style="color:#ec0000">**</span>)(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v48 <span style="color:#ec0000">+</span> <span style="color:#008900">40</span>))(v48) )
</span></span><span style="display:flex;"><span>                      {
</span></span><span style="display:flex;"><span>                        v49 <span style="color:#ec0000">=</span> (<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span> (__thiscall <span style="color:#ec0000">**</span>)(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v48 <span style="color:#ec0000">+</span> <span style="color:#008900">40</span>))(v48);
</span></span><span style="display:flex;"><span>                        v50 <span style="color:#ec0000">=</span> GetModuleHandleW(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                        g_Accelerator <span style="color:#ec0000">=</span> LoadAcceleratorsW(v50, (LPCWSTR)v49);
</span></span><span style="display:flex;"><span>                      }
</span></span><span style="display:flex;"><span>                      g_bInitializing <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>                      v60(<span style="color:#ec0000">&amp;</span>g_GdiPlusToken);
</span></span><span style="display:flex;"><span>                      <span style="color:#ec0000">while</span> ( <span style="color:#008900">1</span> )
</span></span><span style="display:flex;"><span>                      {
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">while</span> ( <span style="color:#ec0000">!</span>PeekMessageW(<span style="color:#ec0000">&amp;</span>Msg, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>) )
</span></span><span style="display:flex;"><span>                          RunEngine();
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>GetMessageW(<span style="color:#ec0000">&amp;</span>Msg, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>) )
</span></span><span style="display:flex;"><span>                          <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>g_Accelerator <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>TranslateAcceleratorW(g_hWnd, g_Accelerator, <span style="color:#ec0000">&amp;</span>Msg) )
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                          TranslateMessage(<span style="color:#ec0000">&amp;</span>Msg);
</span></span><span style="display:flex;"><span>                          DispatchMessageW(<span style="color:#ec0000">&amp;</span>Msg);
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                      }
</span></span><span style="display:flex;"><span>                      v61(g_GdiPlusToken);
</span></span><span style="display:flex;"><span>                      (<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">void</span> (__thiscall <span style="color:#ec0000">**</span>)(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v48 <span style="color:#ec0000">+</span> <span style="color:#008900">72</span>))(v48);
</span></span><span style="display:flex;"><span>                      CleanupEngine(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1365</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Failed to initialize Timer&#34;</span>);
</span></span><span style="display:flex;"><span>                  }
</span></span><span style="display:flex;"><span>                  <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                  {
</span></span><span style="display:flex;"><span>                    Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1346</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Failed to initialize Audio&#34;</span>);
</span></span><span style="display:flex;"><span>                  }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                  Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1335</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Failed to initialize RenderManager&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>              }
</span></span><span style="display:flex;"><span>              <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>              {
</span></span><span style="display:flex;"><span>                Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1308</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Failed to initialize ResourceManager&#34;</span>);
</span></span><span style="display:flex;"><span>              }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1294</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Failed to initialize timekeeping&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1198</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;Window Creation Failed&#34;</span>);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          Log(<span style="color:#008900">0x10u</span>, <span style="color:#008900">1132</span>, <span style="color:#008900">&#34;Engine.cpp&#34;</span>, <span style="color:#008900">L</span><span style="color:#008900">&#34;InitOberVFS() Failed&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        CleanupEngine(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      v12 <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">wchar_t</span> <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span> (__thiscall <span style="color:#ec0000">**</span>)(<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">IEngineInterface</span> <span style="color:#ec0000">*</span>))(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)a1 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>))(a1);
</span></span><span style="display:flex;"><span>      v13 <span style="color:#ec0000">=</span> LocalizeMessage(v12);
</span></span><span style="display:flex;"><span>      v14 <span style="color:#ec0000">=</span> FindWindowW(v13, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>      LocalFree((HLOCAL)v13);
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( v14 )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( IsIconic(v14) )
</span></span><span style="display:flex;"><span>          ShowWindow(v14, <span style="color:#008900">10</span>);
</span></span><span style="display:flex;"><span>        BringWindowToTop(v14);
</span></span><span style="display:flex;"><span>        SetForegroundWindow(v14);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ExitProcess(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">return</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以发现，初始化了一个com组件，GUID=e7b2fb72_d728_49b3_a5f2_18ebf5f1349e（感兴趣可以在注册表CLSID中查，是个CGameExplorer类），可以看到最后一个参数获得了一个com对象，调用序列：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>EngineHandler<span style="color:#ec0000">::</span>GetProjectName  <span style="color:#ec0000">return</span> <span style="color:#008900">&#34;MineSweeper.dll&#34;</span>
</span></span><span style="display:flex;"><span>CoCreateInstance(CGameExplorer)
</span></span><span style="display:flex;"><span>EngineHandler<span style="color:#ec0000">::</span>GetGdfPath <span style="color:#ec0000">return</span> <span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Microsoft Games</span><span style="color:#008900">\\</span><span style="color:#008900">Minesweeper</span><span style="color:#008900">\\</span><span style="color:#008900">Minesweeper.exe&#34;</span>
</span></span><span style="display:flex;"><span>CGameExplorer<span style="color:#ec0000">::</span>VerifyAccess               <span style="color:#ec0000">这里会返回空，也是检测什么东西的，需要改返回值为</span><span style="color:#008900">0</span>
</span></span></code></pre></div><p>改了这2处，就可以运行了！改法有很多，不说了。再来看结构，扫雷用C++写的，用到了XNA，可以找到棋牌类：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>__thiscall Board<span style="color:#ec0000">::</span>Board(<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span><span style="color:#ec0000">this</span>, <span style="color:#5f5fff">int</span> a2, <span style="color:#5f5fff">int</span> a3, <span style="color:#5f5fff">int</span> a4, <span style="color:#5f5fff">int</span> a5, <span style="color:#5f5fff">int</span> a6, <span style="color:#5f5fff">int</span> a7, <span style="color:#5f5fff">int</span> a8, <span style="color:#5f5fff">char</span> a9)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v9; // esi@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> v10; // eax@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v12; // [sp-14h] [bp-30h]@7
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v13; // [sp-10h] [bp-2Ch]@7
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> v14; // [sp-Ch] [bp-28h]@3
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">signed</span> <span style="color:#5f5fff">int</span> v15; // [sp-8h] [bp-24h]@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v16; // [sp+Ch] [bp-10h]@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v17; // [sp+18h] [bp-4h]@1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  v9 <span style="color:#ec0000">=</span> <span style="color:#ec0000">this</span>;
</span></span><span style="display:flex;"><span>  v16 <span style="color:#ec0000">=</span> <span style="color:#ec0000">this</span>;
</span></span><span style="display:flex;"><span>  v15 <span style="color:#ec0000">=</span> <span style="color:#008900">16</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)<span style="color:#ec0000">this</span> <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>Board<span style="color:#ec0000">::</span><span style="color:#ec0000">`</span>vftable<span style="color:#ec0000">&#39;</span>;
</span></span><span style="display:flex;"><span>  Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;::</span>Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;</span>(v15);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((<span style="color:#5f5fff">float</span> <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">7</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0.0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">=</span> a2;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">1</span>) <span style="color:#ec0000">=</span> a5;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">2</span>) <span style="color:#ec0000">=</span> a4;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>) <span style="color:#ec0000">=</span> a3;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">11</span>) <span style="color:#ec0000">=</span> a6;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">9</span>) <span style="color:#ec0000">=</span> a7;
</span></span><span style="display:flex;"><span>  v17 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">5</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">6</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">17</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">10</span>) <span style="color:#ec0000">=</span> a8;
</span></span><span style="display:flex;"><span>  Board<span style="color:#ec0000">::</span>initTiles((Board <span style="color:#ec0000">*</span>)v9);
</span></span><span style="display:flex;"><span>  v10 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">9</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( v10 <span style="color:#ec0000">!=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span> <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">10</span>) <span style="color:#ec0000">!=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v15 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">10</span>);
</span></span><span style="display:flex;"><span>    v14 <span style="color:#ec0000">=</span> v10;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( a9 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      Board<span style="color:#ec0000">::</span>placeMines((Board <span style="color:#ec0000">*</span>)v9, v14, v15);
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">++*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">6</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      Board<span style="color:#ec0000">::</span>AttemptReveal((Board <span style="color:#ec0000">*</span>)v9, v14, v15);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">1</span>) <span style="color:#ec0000">&gt;</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>) <span style="color:#ec0000">*</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">2</span>) <span style="color:#ec0000">-</span> <span style="color:#008900">9</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v15 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    Str<span style="color:#ec0000">::</span>Str(<span style="color:#008900">L</span><span style="color:#008900">&#34;Too many mines for tile count&#34;</span>);
</span></span><span style="display:flex;"><span>    StrErr(v12, v13, v14, v15);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">1</span>) <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>) <span style="color:#ec0000">*</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v9 <span style="color:#ec0000">+</span> <span style="color:#008900">2</span>) <span style="color:#ec0000">-</span> <span style="color:#008900">9</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">return</span> v9;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>继续向上看，来到Game构造函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>__thiscall Game<span style="color:#ec0000">::</span>Game(<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span><span style="color:#ec0000">this</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v1; // esi@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v2; // edi@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v3; // eax@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v4; // ST08_4@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">signed</span> <span style="color:#5f5fff">int</span> v5; // eax@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v6; // ST08_4@1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  v1 <span style="color:#ec0000">=</span> <span style="color:#ec0000">this</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)<span style="color:#ec0000">this</span> <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>Game<span style="color:#ec0000">::</span><span style="color:#ec0000">`</span>vftable<span style="color:#ec0000">&#39;</span>;
</span></span><span style="display:flex;"><span>  Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;::</span>Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;</span>(<span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>  Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;::</span>Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;</span>(<span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>  Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;::</span>Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;</span>(<span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>  Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;::</span>Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;</span>(<span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>  Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;::</span>Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;</span>(<span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>  Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;::</span>Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;</span>(<span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>  v2 <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">int</span>)((<span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">152</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v2 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v2 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v2 <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  GameStats<span style="color:#ec0000">::</span>GameStats((<span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">168</span>);
</span></span><span style="display:flex;"><span>  Game<span style="color:#ec0000">::</span>G <span style="color:#ec0000">=</span> (Game <span style="color:#ec0000">*</span>)v1;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>) <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">9</span>) <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">2</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">218</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">10</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">13</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">197</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">195</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">193</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">194</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">196</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">192</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">47</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">24</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">25</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">26</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">27</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">28</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">29</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">30</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">50</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  v3 <span style="color:#ec0000">=</span> EDifficultyToWidth(<span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>  v4 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">50</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">51</span>) <span style="color:#ec0000">=</span> v3;
</span></span><span style="display:flex;"><span>  v5 <span style="color:#ec0000">=</span> EDifficultyToHeight(v4);
</span></span><span style="display:flex;"><span>  v6 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">50</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">52</span>) <span style="color:#ec0000">=</span> v5;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">53</span>) <span style="color:#ec0000">=</span> EDifficultyToMineCount(v6);
</span></span><span style="display:flex;"><span>  Game<span style="color:#ec0000">::</span>RandomizeSeedOnTime((Game <span style="color:#ec0000">*</span>)v1);
</span></span><span style="display:flex;"><span>  CSQMTimeRecorder<span style="color:#ec0000">::</span>SetDataId((CSQMTimeRecorder <span style="color:#ec0000">*</span>)((<span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">152</span>), <span style="color:#008900">0x17C7u</span>);
</span></span><span style="display:flex;"><span>  Game<span style="color:#ec0000">::</span>Reset((Game <span style="color:#ec0000">*</span>)v1, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>  Game<span style="color:#ec0000">::</span>RequestSetState(v1, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">216</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v1 <span style="color:#ec0000">+</span> <span style="color:#008900">217</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">return</span> v1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>EDifficultyToWidth和EDifficultyToHeight，分析可知是将默认难度级别转换为雷区阵列的高和宽，同理EDifficultyToMineCount是雷数。那么Game类结构：</p>
<pre tabindex="0"><code>+200        Difficulty        1        2        3
+204        Width             9        16       16
+208        Height            9        16       30
+212        MineCount         10       40       99
</code></pre><p>再往上层看调用者：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ec0000">struct</span> <span style="color:#5f5fff">Game</span> <span style="color:#ec0000">*</span><span style="color:#ec0000">__stdcall</span> Game<span style="color:#ec0000">::</span>SafeGetSingleton()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v0; // ecx@2
</span></span><span style="display:flex;"><span>  Game <span style="color:#ec0000">*</span>v1; // eax@3
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v3; // [sp-10h] [bp-2Ch]@6
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v4; // [sp-Ch] [bp-28h]@6
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v5; // [sp-8h] [bp-24h]@6
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v6; // [sp+Ch] [bp-10h]@2
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v7; // [sp+18h] [bp-4h]@2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>Game<span style="color:#ec0000">::</span>G )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v0 <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0xE0u</span>);
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ec0000">=</span> v0;
</span></span><span style="display:flex;"><span>    v7 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( v0 )
</span></span><span style="display:flex;"><span>      v1 <span style="color:#ec0000">=</span> (Game <span style="color:#ec0000">*</span>)Game<span style="color:#ec0000">::</span>Game(v0);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>      v1 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    v7 <span style="color:#ec0000">=</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    Game<span style="color:#ec0000">::</span>G <span style="color:#ec0000">=</span> v1;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>v1 <span style="color:#ec0000">||</span> (v6 <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>v3, Str<span style="color:#ec0000">::</span>Str(dword_10868FC), <span style="color:#ec0000">!</span>(<span style="color:#5f5fff">unsigned</span> <span style="color:#ec0000">__int8</span>)Game<span style="color:#ec0000">::</span>initLogic(Game<span style="color:#ec0000">::</span>G, v3, v4, v5)) )
</span></span><span style="display:flex;"><span>      Game<span style="color:#ec0000">::</span>PrintFatalErrorAndQuit(<span style="color:#008900">103</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">return</span> Game<span style="color:#ec0000">::</span>G;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可见，Game是个单例类，构造的类指针存在了全局变量Game::G中，因此我们只要读取内存PE获取该结构相对.data段偏移，即可获取全部所需数据（或者调用SafeGetSingleton，只不过要定位.text段基址）。再来看 Game::Reset</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> __thiscall Game<span style="color:#ec0000">::</span>Reset(Game <span style="color:#ec0000">*</span><span style="color:#ec0000">this</span>, <span style="color:#5f5fff">bool</span> a2, <span style="color:#5f5fff">bool</span> a3, <span style="color:#5f5fff">bool</span> a4)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  Game <span style="color:#ec0000">*</span>v4; // esi@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v5; // eax@2
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v6; // edi@5
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">double</span> v7; // st7@6
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v8; // edi@7
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v9; // eax@8
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v10; // ecx@9
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v11; // eax@9
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v12; // ecx@14
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v13; // edi@15
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v14; // eax@15
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v15; // eax@16
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">bool</span> v16; // di@18
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v17; // ecx@19
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v18; // eax@22
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v19; // eax@22
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v20; // [sp+18h] [bp-28h]@15
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>v21; // [sp+18h] [bp-28h]@21
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v22; // [sp+1Ch] [bp-24h]@15
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v23; // [sp+20h] [bp-20h]@7
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v24; // [sp+24h] [bp-1Ch]@9
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v25; // [sp+28h] [bp-18h]@9
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v26; // [sp+2Ch] [bp-14h]@13
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">char</span> v27; // [sp+33h] [bp-Dh]@1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  v4 <span style="color:#ec0000">=</span> <span style="color:#ec0000">this</span>;
</span></span><span style="display:flex;"><span>  Game<span style="color:#ec0000">::</span>SetTimerEnabled(<span style="color:#ec0000">this</span>, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>  v27 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>a3 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( v5 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v5 <span style="color:#ec0000">+</span> <span style="color:#008900">24</span>) <span style="color:#ec0000">&gt;</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)Game<span style="color:#ec0000">::</span>G <span style="color:#ec0000">+</span> <span style="color:#008900">10</span>) <span style="color:#ec0000">==</span> <span style="color:#008900">1</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v6 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v5 <span style="color:#ec0000">+</span> <span style="color:#008900">32</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> ( v6 <span style="color:#ec0000">!=</span> <span style="color:#008900">4</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          v7 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(<span style="color:#5f5fff">float</span> <span style="color:#ec0000">*</span>)(v5 <span style="color:#ec0000">+</span> <span style="color:#008900">28</span>);
</span></span><span style="display:flex;"><span>          floorf(<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">float</span> <span style="color:#ec0000">*</span>)(v5 <span style="color:#ec0000">+</span> <span style="color:#008900">28</span>));
</span></span><span style="display:flex;"><span>          GameStats<span style="color:#ec0000">::</span>AddNewScore((<span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">168</span>, v6, (<span style="color:#5f5fff">signed</span> <span style="color:#5f5fff">int</span>)v7, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>          Game<span style="color:#ec0000">::</span>Save(Game<span style="color:#ec0000">::</span>G, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  v8 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">50</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((<span style="color:#5f5fff">float</span> <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">11</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">1.0</span>;
</span></span><span style="display:flex;"><span>  v23 <span style="color:#ec0000">=</span> v8;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( a3 <span style="color:#ec0000">&amp;&amp;</span> (v9 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>)) <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v23 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v9 <span style="color:#ec0000">+</span> <span style="color:#008900">32</span>);
</span></span><span style="display:flex;"><span>    v24 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v9 <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>);
</span></span><span style="display:flex;"><span>    v10 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v9 <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>);
</span></span><span style="display:flex;"><span>    v11 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v9 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>);
</span></span><span style="display:flex;"><span>    v25 <span style="color:#ec0000">=</span> v10;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">else</span> <span style="color:#5f5fff">if</span> ( v8 <span style="color:#ec0000">==</span> <span style="color:#008900">4</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v24 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">51</span>);
</span></span><span style="display:flex;"><span>    v25 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">52</span>);
</span></span><span style="display:flex;"><span>    v11 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">53</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v24 <span style="color:#ec0000">=</span> EDifficultyToWidth(v8);
</span></span><span style="display:flex;"><span>    v25 <span style="color:#ec0000">=</span> EDifficultyToHeight(v8);
</span></span><span style="display:flex;"><span>    v11 <span style="color:#ec0000">=</span> EDifficultyToMineCount(v8);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  v26 <span style="color:#ec0000">=</span> v11;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( a3 <span style="color:#ec0000">&amp;&amp;</span> (v12 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>)) <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v13 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v12 <span style="color:#ec0000">+</span> <span style="color:#008900">36</span>);
</span></span><span style="display:flex;"><span>    v22 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v12 <span style="color:#ec0000">+</span> <span style="color:#008900">40</span>);
</span></span><span style="display:flex;"><span>    v20 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v12 <span style="color:#ec0000">+</span> <span style="color:#008900">44</span>);
</span></span><span style="display:flex;"><span>    Board<span style="color:#ec0000">::</span><span style="color:#ec0000">`</span>scalar deleting destructor((<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)v12, <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    v14 <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x48u</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( v14 )
</span></span><span style="display:flex;"><span>      v15 <span style="color:#ec0000">=</span> Board<span style="color:#ec0000">::</span>Board(v14, v23, v24, v25, v26, v20, v13, v22, <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>      v15 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> v15;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v15 <span style="color:#ec0000">+</span> <span style="color:#008900">6</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    Game<span style="color:#ec0000">::</span>RandomizeSeedOnTime(v4);
</span></span><span style="display:flex;"><span>    v27 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    v16 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v17 <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)<span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>);
</span></span><span style="display:flex;"><span>    v16 <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( v17 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      Board<span style="color:#ec0000">::</span><span style="color:#ec0000">`</span>scalar deleting destructor(v17, <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    v21 <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x48u</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( v21 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v18 <span style="color:#ec0000">=</span> _time(<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>      v19 <span style="color:#ec0000">=</span> Board<span style="color:#ec0000">::</span>Board(v21, v23, v24, v25, v26, v18, <span style="color:#ec0000">-</span><span style="color:#008900">1</span>, <span style="color:#ec0000">-</span><span style="color:#008900">1</span>, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v19 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">=</span> v19;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  Game<span style="color:#ec0000">::</span>SaveGameExplorerStatistics(v4);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">217</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!*</span>((_BYTE <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">193</span>) <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>Game<span style="color:#ec0000">::</span>RandomizeArt(v4, v16) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">!</span>a2 )
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">goto</span> LABEL_33;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">27</span>) )
</span></span><span style="display:flex;"><span>      UIBoardCanvas<span style="color:#ec0000">::</span>SetAllTilesTopAlpha(<span style="color:#ec0000">*</span>((UIBoardCanvas <span style="color:#ec0000">**</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>), <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>    Game<span style="color:#ec0000">::</span>ResetCanvas(v4);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( a2 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    Game<span style="color:#ec0000">::</span>RequestSetState(v4, <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>    UIBoardCanvas<span style="color:#ec0000">::</span>Refresh(<span style="color:#ec0000">*</span>((UIBoardCanvas <span style="color:#ec0000">**</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>), <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>    Game<span style="color:#ec0000">::</span>DoNewBoardAnimation(v4);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#ec0000">LABEL_33</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( v27 )
</span></span><span style="display:flex;"><span>    UIBoardCanvas<span style="color:#ec0000">::</span>ShowTipMessage(<span style="color:#ec0000">*</span>((UIBoardCanvas <span style="color:#ec0000">**</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>), <span style="color:#008900">L</span><span style="color:#008900">&#34;Restart&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( a4 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    UserInterface<span style="color:#ec0000">::</span>ProcessMouseMove(g_pUserInterface, v16);
</span></span><span style="display:flex;"><span>    Engine_ResetTimer();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( a3 )
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">4</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">24</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)v4 <span style="color:#ec0000">+</span> <span style="color:#008900">197</span>) <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>分析可知:</p>
<pre tabindex="0"><code>Game:sizeof=224
+8                DWORD
+12                UIBoardCanvas *
+16                Board*
+24                bool
+25                bool
+26                bool
+27                bool
+28                bool
+29                bool
+30                bool
+32                int
+36                int
+40                int state
+48                DWORD
+52                DWORD
+56                Array&lt;UITile *&gt;*
+72                Array&lt;UITile *&gt;*
+88                Array&lt;UITile *&gt;*
+104        Array&lt;UITile *&gt;*
+120        Array&lt;UITile *&gt;*
+136        Array&lt;UITile *&gt;*
+152        CSQMTimeRecorder*
+188        DWORD
+192        bool
+193        bool
+194        bool
+195        bool
+196        bool
+197        bool

+200        Difficulty       
+204        Width                
+208        Height               
+212        MineCount       
+216        bool
+217        bool
+218        bool IsTimerEnabled

Board:sizeof=72
+4                MineCount
+8                Height
+12                Width
+24                是否挖过雷？
+28                float
+32                Difficulty       
+36                HitX
+40                HitY
+44
+68                Array&lt;Array&lt;BYTE&gt;&gt;* MineArray

Array&lt;UITile *&gt;:sizeof=16
+0                MineCount
+4
+8
+12                DWORD[]        MineIndexArray//存储雷位置索引

UITile:
+36                state
</code></pre><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> __thiscall Board<span style="color:#ec0000">::</span>placeMines(Board <span style="color:#ec0000">*</span><span style="color:#ec0000">this</span>, <span style="color:#5f5fff">int</span> a2, <span style="color:#5f5fff">int</span> a3)
</span></span><span style="display:flex;"><span>{//布置雷区
</span></span><span style="display:flex;"><span>  Board <span style="color:#ec0000">*</span>v3; // esi@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v4; // eax@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> i; // edi@4
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">signed</span> <span style="color:#5f5fff">int</span> v6; // ecx@5
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v7; // eax@9
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v8; // edi@10
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> v9; // ebx@13
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> v10; // ecx@15
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">signed</span> <span style="color:#5f5fff">int</span> v11; // ebx@16
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v12; // eax@16
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v13; // edx@16
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> Seed; // [sp+Ch] [bp-8h]@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> pv; // [sp+10h] [bp-4h]@2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  v3 <span style="color:#ec0000">=</span> <span style="color:#ec0000">this</span>;
</span></span><span style="display:flex;"><span>  Seed <span style="color:#ec0000">=</span> GetRandomSeed();
</span></span><span style="display:flex;"><span>  SetRandomSeed(<span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">11</span>));
</span></span><span style="display:flex;"><span>  v4 <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">int</span>)<span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x10u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( v4 )
</span></span><span style="display:flex;"><span>    pv <span style="color:#ec0000">=</span> Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;::</span>Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;</span>(v4, <span style="color:#008900">16</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    pv <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">for</span> ( i <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>; i <span style="color:#ec0000">&lt;</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>) <span style="color:#ec0000">*</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">2</span>); <span style="color:#ec0000">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( (i <span style="color:#ec0000">%</span> v6 <span style="color:#ec0000">-</span> a2) <span style="color:#ec0000">*</span> (<span style="color:#008900">2</span> <span style="color:#ec0000">*</span> (i <span style="color:#ec0000">%</span> v6 <span style="color:#ec0000">-</span> a2 <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">0</span>) <span style="color:#ec0000">-</span> <span style="color:#008900">1</span>) <span style="color:#ec0000">&gt;</span> <span style="color:#008900">1</span> <span style="color:#ec0000">||</span> (i <span style="color:#ec0000">/</span> v6 <span style="color:#ec0000">-</span> a3) <span style="color:#ec0000">*</span> (<span style="color:#008900">2</span> <span style="color:#ec0000">*</span> (i <span style="color:#ec0000">/</span> v6 <span style="color:#ec0000">-</span> a3 <span style="color:#ec0000">&gt;=</span> <span style="color:#008900">0</span>) <span style="color:#ec0000">-</span> <span style="color:#008900">1</span>) <span style="color:#ec0000">&gt;</span> <span style="color:#008900">1</span> )//取第一次点击位置以外的雷区位置，存到数组array1里，这样设计就不会导致第一次就点到雷
</span></span><span style="display:flex;"><span>      Array<span style="color:#ec0000">&lt;</span>NodeBase <span style="color:#ec0000">*&gt;::</span>Add(pv, i);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  v7 <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">int</span>)<span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0x10u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( v7 )
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ec0000">=</span> Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;::</span>Array<span style="color:#ec0000">&lt;</span>UITile <span style="color:#ec0000">*&gt;</span>(v7, <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">1</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">while</span> ( <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v8 <span style="color:#ec0000">!=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">1</span>) <span style="color:#ec0000">&amp;&amp;</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)pv )
</span></span><span style="display:flex;"><span>  {//若雷数不够且array1没被用完就一直布雷
</span></span><span style="display:flex;"><span>    v9 <span style="color:#ec0000">=</span> GetRandom(<span style="color:#008900">0</span>, <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)pv <span style="color:#ec0000">-</span> <span style="color:#008900">1</span>);//rand(0,array1.size()-1)
</span></span><span style="display:flex;"><span>    Array<span style="color:#ec0000">&lt;</span>NodeBase <span style="color:#ec0000">*&gt;::</span>Add(v8, <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(pv <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">4</span> <span style="color:#ec0000">*</span> v9));//在array2中增加该位置
</span></span><span style="display:flex;"><span>    Array<span style="color:#ec0000">&lt;</span>NodeBase <span style="color:#ec0000">*&gt;::</span>Remove(pv, v9);//从array1中去除该位置
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  v10 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v8 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">do</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v11 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>);
</span></span><span style="display:flex;"><span>      v12 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v8 <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">4</span> <span style="color:#ec0000">*</span> v10) <span style="color:#ec0000">/</span> v11;
</span></span><span style="display:flex;"><span>      v13 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(v8 <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">4</span> <span style="color:#ec0000">*</span> v10<span style="color:#ec0000">++</span>) <span style="color:#ec0000">%</span> v11;//分别还原横纵坐标
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">*</span>(_BYTE <span style="color:#ec0000">*</span>)(v12 <span style="color:#ec0000">+</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">17</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">4</span> <span style="color:#ec0000">*</span> v13) <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>)) <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;//可以推测出将布雷坐标数组存到Array&lt;Array&lt;BYTE&gt;&gt;二维数组里
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">while</span> ( v10 <span style="color:#ec0000">&lt;</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)v8 );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  Array<span style="color:#ec0000">&lt;</span><span style="color:#5f5fff">int</span><span style="color:#ec0000">&gt;::</span><span style="color:#ec0000">`</span>scalar deleting destructor<span style="color:#ec0000">&#39;</span>((<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)v8, <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( pv )
</span></span><span style="display:flex;"><span>    Array<span style="color:#ec0000">&lt;</span><span style="color:#5f5fff">int</span><span style="color:#ec0000">&gt;::</span><span style="color:#ec0000">`</span>scalar deleting destructor<span style="color:#ec0000">&#39;</span>((<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)pv, <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>  SetRandomSeed(Seed);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>向上层找：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">int</span> __thiscall Board<span style="color:#ec0000">::</span>AttemptReveal(Board <span style="color:#ec0000">*</span><span style="color:#ec0000">this</span>, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> a2, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> a3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  Board <span style="color:#ec0000">*</span>v3; // esi@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v4; // eax@1
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v5; // eax@6
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> <span style="color:#ec0000">*</span>v7; // [sp+0h] [bp-10h]@0
</span></span><span style="display:flex;"><span>  <span style="color:#5f5fff">int</span> v8; // [sp+Ch] [bp-4h]@1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  v3 <span style="color:#ec0000">=</span> <span style="color:#ec0000">this</span>;
</span></span><span style="display:flex;"><span>  v4 <span style="color:#ec0000">=</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)<span style="color:#ec0000">this</span> <span style="color:#ec0000">+</span> <span style="color:#008900">16</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">4</span> <span style="color:#ec0000">*</span> a2) <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">4</span> <span style="color:#ec0000">*</span> a3);
</span></span><span style="display:flex;"><span>  v8 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( v4 <span style="color:#ec0000">==</span> <span style="color:#008900">9</span> <span style="color:#ec0000">||</span> v4 <span style="color:#ec0000">==</span> <span style="color:#008900">11</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)<span style="color:#ec0000">this</span> <span style="color:#ec0000">+</span> <span style="color:#008900">6</span>) )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>(_BYTE <span style="color:#ec0000">*</span>)(a3 <span style="color:#ec0000">+</span> <span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>(_DWORD <span style="color:#ec0000">*</span>)(<span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)<span style="color:#ec0000">this</span> <span style="color:#ec0000">+</span> <span style="color:#008900">17</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">+</span> <span style="color:#008900">4</span> <span style="color:#ec0000">*</span> a2) <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>)) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        v8 <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">LABEL_11</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">++*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">6</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">goto</span> LABEL_12;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      v5 <span style="color:#ec0000">=</span> Board<span style="color:#ec0000">::</span>revealAt(<span style="color:#ec0000">this</span>, a2, a3, <span style="color:#008900">0</span>, a2, a3, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      Board<span style="color:#ec0000">::</span>placeMines(<span style="color:#ec0000">this</span>, a2, a3);//如果是首次挖雷，则布雷
</span></span><span style="display:flex;"><span>      v5 <span style="color:#ec0000">=</span> Board<span style="color:#ec0000">::</span>revealAt(v3, a2, a3, <span style="color:#008900">0</span>, a2, a3, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">9</span>) <span style="color:#ec0000">=</span> a2;
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">10</span>) <span style="color:#ec0000">=</span> a3;//存储点击位置
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ec0000">=</span> v5;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">goto</span> LABEL_11;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>((_BYTE <span style="color:#ec0000">*</span>)Game<span style="color:#ec0000">::</span>G <span style="color:#ec0000">+</span> <span style="color:#008900">24</span>) )
</span></span><span style="display:flex;"><span>    GameAudio<span style="color:#ec0000">::</span>PlaySoundProto(<span style="color:#008900">0</span>, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>, v7);
</span></span><span style="display:flex;"><span><span style="color:#ec0000">LABEL_12</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span> ( <span style="color:#ec0000">*</span>((_DWORD <span style="color:#ec0000">*</span>)v3 <span style="color:#ec0000">+</span> <span style="color:#008900">12</span>) <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">0u</span> )
</span></span><span style="display:flex;"><span>    UIBoardCanvas<span style="color:#ec0000">::</span>Refresh(<span style="color:#ec0000">*</span>((UIBoardCanvas <span style="color:#ec0000">**</span>)Game<span style="color:#ec0000">::</span>G <span style="color:#ec0000">+</span> <span style="color:#008900">3</span>), <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">return</span> v8;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>至此，想得到的结果已经都得到，根据以上分析可以得到代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ec0000">template</span><span style="color:#ec0000">&lt;</span><span style="color:#ec0000">typename</span> T<span style="color:#ec0000">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">struct</span> <span style="color:#5f5fff">Array</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        DWORD MineCount;
</span></span><span style="display:flex;"><span>        DWORD unused1;
</span></span><span style="display:flex;"><span>        DWORD unused2;
</span></span><span style="display:flex;"><span>        T<span style="color:#ec0000">*</span> data;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#include &lt;TlHelp32.h&gt;
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> CWin7MineSweeperHackerDlg<span style="color:#ec0000">::</span>OnBnClickedOk()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        // TODO: 在此添加控件通知处理程序代码
</span></span><span style="display:flex;"><span>        UpdateData(TRUE);
</span></span><span style="display:flex;"><span>        m_output<span style="color:#ec0000">=</span><span style="color:#008900">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        PROCESSENTRY32 pe;
</span></span><span style="display:flex;"><span>        pe.dwSize<span style="color:#ec0000">=</span><span style="color:#ec0000">sizeof</span>(PROCESSENTRY32);
</span></span><span style="display:flex;"><span>        HANDLE hProcess<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>        HANDLE hSnapshot<span style="color:#ec0000">=</span>CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS,<span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(hSnapshot <span style="color:#ec0000">==</span> INVALID_HANDLE_VALUE <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>Process32First(hSnapshot,<span style="color:#ec0000">&amp;</span>pe))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                AfxMessageBox(<span style="color:#008900">&#34;ERROR!&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">do</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(StrStr(pe.szExeFile,<span style="color:#008900">&#34;MineSweeper.exe&#34;</span>))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                        hProcess<span style="color:#ec0000">=</span>OpenProcess(PROCESS_ALL_ACCESS,FALSE,pe.th32ProcessID);
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">while</span>(Process32Next(hSnapshot,<span style="color:#ec0000">&amp;</span>pe));
</span></span><span style="display:flex;"><span>        CloseHandle(hSnapshot);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(hProcess <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                AfxMessageBox(<span style="color:#008900">&#34;找不到进程！&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        MODULEENTRY32 me;
</span></span><span style="display:flex;"><span>        me.dwSize<span style="color:#ec0000">=</span><span style="color:#ec0000">sizeof</span>(MODULEENTRY32);
</span></span><span style="display:flex;"><span>        LPVOID peBase<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>        DWORD peSize;
</span></span><span style="display:flex;"><span>        hSnapshot<span style="color:#ec0000">=</span>CreateToolhelp32Snapshot(TH32CS_SNAPMODULE,pe.th32ProcessID);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(hSnapshot <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span> <span style="color:#ec0000">||</span> <span style="color:#ec0000">!</span>Module32First(hSnapshot,<span style="color:#ec0000">&amp;</span>me))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                AfxMessageBox(<span style="color:#008900">&#34;ERROR&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">do</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(StrStrI(me.szModule,<span style="color:#008900">&#34;mine&#34;</span>))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                        peBase<span style="color:#ec0000">=</span>(LPVOID)me.modBaseAddr;
</span></span><span style="display:flex;"><span>                        peSize<span style="color:#ec0000">=</span>me.modBaseSize;
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>        } <span style="color:#ec0000">while</span> (Module32Next(hSnapshot,<span style="color:#ec0000">&amp;</span>me));
</span></span><span style="display:flex;"><span>        CloseHandle(hSnapshot);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span>(peBase <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>        {               
</span></span><span style="display:flex;"><span>                AfxMessageBox(<span style="color:#008900">&#34;ERROR&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        BYTE<span style="color:#ec0000">*</span> buffer<span style="color:#ec0000">=</span><span style="color:#ec0000">new</span> BYTE[peSize];
</span></span><span style="display:flex;"><span>        DWORD readnum;
</span></span><span style="display:flex;"><span>        ReadProcessMemory(hProcess,peBase,buffer,peSize,<span style="color:#ec0000">&amp;</span>readnum);
</span></span><span style="display:flex;"><span>        IMAGE_DOS_HEADER<span style="color:#ec0000">*</span> dosheader<span style="color:#ec0000">=</span>(IMAGE_DOS_HEADER<span style="color:#ec0000">*</span>)buffer;
</span></span><span style="display:flex;"><span>        IMAGE_NT_HEADERS<span style="color:#ec0000">*</span> ntheader<span style="color:#ec0000">=</span>(IMAGE_NT_HEADERS<span style="color:#ec0000">*</span>)(buffer<span style="color:#ec0000">+</span>dosheader<span style="color:#ec0000">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>        IMAGE_SECTION_HEADER<span style="color:#ec0000">*</span> cur<span style="color:#ec0000">=</span>(IMAGE_SECTION_HEADER<span style="color:#ec0000">*</span>)(ntheader<span style="color:#ec0000">+</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>ntheader<span style="color:#ec0000">-&gt;</span>FileHeader.NumberOfSections;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span>(StrStrI((CHAR<span style="color:#ec0000">*</span>)cur<span style="color:#ec0000">-&gt;</span>Name,<span style="color:#008900">&#34;.data&#34;</span>))
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                cur<span style="color:#ec0000">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">Board</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">Game</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                DWORD unused[<span style="color:#008900">4</span>];
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">Board</span><span style="color:#ec0000">*</span> board;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">Board</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                DWORD unused1;
</span></span><span style="display:flex;"><span>                DWORD MineCount;
</span></span><span style="display:flex;"><span>                DWORD Height;
</span></span><span style="display:flex;"><span>                DWORD Width;
</span></span><span style="display:flex;"><span>                DWORD unused2[<span style="color:#008900">4</span>];
</span></span><span style="display:flex;"><span>                DWORD Difficulty;
</span></span><span style="display:flex;"><span>                DWORD HitX;
</span></span><span style="display:flex;"><span>                DWORD HitY;
</span></span><span style="display:flex;"><span>                DWORD unused3[<span style="color:#008900">6</span>];
</span></span><span style="display:flex;"><span>                Array<span style="color:#ec0000">&lt;</span> Array<span style="color:#ec0000">&lt;</span>BYTE<span style="color:#ec0000">&gt;</span> <span style="color:#ec0000">&gt;*</span> MineArray;
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>        BYTE<span style="color:#ec0000">*</span> GameInThatProc <span style="color:#ec0000">=</span> (BYTE<span style="color:#ec0000">*</span>)<span style="color:#ec0000">*</span>(Game<span style="color:#ec0000">**</span>)(buffer <span style="color:#ec0000">+</span> cur<span style="color:#ec0000">-&gt;</span>VirtualAddress <span style="color:#ec0000">+</span> <span style="color:#008900">0x88B4</span>);
</span></span><span style="display:flex;"><span>        //换算成本地地址
</span></span><span style="display:flex;"><span>        Game G;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (GameInThatProc <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                AfxMessageBox(<span style="color:#008900">&#34;数据有误&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">goto</span> end1;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ReadProcessMemory(hProcess, GameInThatProc, <span style="color:#ec0000">&amp;</span>G, <span style="color:#ec0000">sizeof</span>(G), <span style="color:#ec0000">&amp;</span>readnum);
</span></span><span style="display:flex;"><span>        //换算成本地地址
</span></span><span style="display:flex;"><span>        Board B;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (G.board <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                AfxMessageBox(<span style="color:#008900">&#34;数据有误&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ReadProcessMemory(hProcess, G.board, <span style="color:#ec0000">&amp;</span>B, <span style="color:#ec0000">sizeof</span>(B), <span style="color:#ec0000">&amp;</span>readnum);
</span></span><span style="display:flex;"><span>        Array<span style="color:#ec0000">&lt;</span> Array<span style="color:#ec0000">&lt;</span>BYTE<span style="color:#ec0000">&gt;</span> <span style="color:#ec0000">&gt;</span> MA;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (B.MineArray <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                AfxMessageBox(<span style="color:#008900">&#34;数据有误&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">goto</span> end1;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ReadProcessMemory(hProcess, B.MineArray, <span style="color:#ec0000">&amp;</span>MA, <span style="color:#ec0000">sizeof</span>(MA), <span style="color:#ec0000">&amp;</span>readnum);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">typedef</span> Array<span style="color:#ec0000">&lt;</span>BYTE<span style="color:#ec0000">&gt;*</span> pMAsub;//先取指针数组
</span></span><span style="display:flex;"><span>        pMAsub<span style="color:#ec0000">*</span> data1 <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> pMAsub[B.Width];
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (MA.data <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                AfxMessageBox(<span style="color:#008900">&#34;数据有误&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">goto</span> end1;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ReadProcessMemory(hProcess, MA.data, data1, <span style="color:#ec0000">sizeof</span>(Array<span style="color:#ec0000">&lt;</span>BYTE<span style="color:#ec0000">&gt;*</span>) <span style="color:#ec0000">*</span> B.Width, <span style="color:#ec0000">&amp;</span>readnum);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i<span style="color:#ec0000">&lt;</span>B.Width;i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>                Array<span style="color:#ec0000">&lt;</span>BYTE<span style="color:#ec0000">&gt;</span> data2;//对指针数组每个指针找到对象内存
</span></span><span style="display:flex;"><span>                ReadProcessMemory(hProcess, data1[i], <span style="color:#ec0000">&amp;</span>data2, <span style="color:#ec0000">sizeof</span>(data2), <span style="color:#ec0000">&amp;</span>readnum);
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span> (data2.data <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                        AfxMessageBox(<span style="color:#008900">&#34;数据有误&#34;</span>);
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">goto</span> end1;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                BYTE<span style="color:#ec0000">*</span> data3 <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> BYTE[B.Height];
</span></span><span style="display:flex;"><span>                ReadProcessMemory(hProcess, data2.data, data3, <span style="color:#ec0000">sizeof</span>(BYTE) <span style="color:#ec0000">*</span> B.Height, <span style="color:#ec0000">&amp;</span>readnum);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> j<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;j<span style="color:#ec0000">&lt;</span>B.Height;j<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">if</span>(data3[j] <span style="color:#ec0000">==</span> <span style="color:#008900">1</span>)//雷
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                                m_output <span style="color:#ec0000">+=</span> <span style="color:#008900">&#34;雷&#34;</span>;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                                m_output <span style="color:#ec0000">+=</span> <span style="color:#008900">&#34;空&#34;</span>;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">delete</span>[]data3;
</span></span><span style="display:flex;"><span>                m_output <span style="color:#ec0000">+=</span> <span style="color:#008900">&#34;</span><span style="color:#008900">\r\n</span><span style="color:#008900">&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">delete</span>[]data1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">end1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">delete</span> []buffer;
</span></span><span style="display:flex;"><span>        CloseHandle(hProcess);
</span></span><span style="display:flex;"><span>        UpdateData(FALSE);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>新开一局扫雷，可以发现程序获取结果：</p>
<pre tabindex="0"><code>空空空空空空空空空
空空空空空空空空空
空空空空空空空空空
空空空空空空空空空
空空空空空空空空空
空空空空空空空空空
空空空空空空空空空
空空空空空空空空空
空空空空空空空空空
</code></pre><p>可见，没点击前，是不布雷的，和之前分析的一样。点击以后：</p>
<pre tabindex="0"><code>空雷空空空空空空空
空雷空空空空空空空
空空空空空空空空空
空空雷空雷空空空空
空空雷空空空空空空
空空空空空空空空空
雷雷空空空空空空空
空空雷空空空空空空
雷空空空雷空空空空
</code></pre><p>特别注意，，由于程序中使用的数据结构原因，得到的结果，和扫雷屏幕上显示，关于y=x对称！！！</p>

    
  </div>

  


  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/win_posts/20140102_disk_info/">
                        获取硬盘信息
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
            <div class="single-pagination-container-next">
                <div class="single-pagination-text">
                    <a href="/win_posts/20140418_win7_disk/">
                        Win7磁盘读写操作
                    </a>
                </div>
                <div class="single-pagination-text">→</div>
            </div>
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


      </main>
    </div>

    <footer>
      

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    



    </footer>
    
  </body>

  <script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

</html>