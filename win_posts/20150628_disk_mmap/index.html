<!DOCTYPE html>
<html lang="zh-CN"
  dir="ltr">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://lich4.github.io//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://lich4.github.io//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://lich4.github.io//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://lich4.github.io//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://lich4.github.io//apple-touch-icon.png">

<meta name="description" content=""/>

<title>
    
    实现磁盘内存映射 | 超哥的博客
    
</title>

<link rel="canonical" href="https://lich4.github.io/win_posts/20150628_disk_mmap/"/>












<link rel="stylesheet" href="/assets/combined.min.cbcb816aefdb3b7380c5921cbb3b89d12f07742cb3f869754adb56da84f0d729.css" media="all">









  </head>

  

  
  
  

  <body class="light">

    <div class="content">
      <header>
        

<div class="header">

    

</div>

      </header>

      <main class="main">
        





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a href="/win_posts/">Win_posts</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a class="breadcrumbs-current" href="/win_posts/20150628_disk_mmap/">实现磁盘内存映射</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">实现磁盘内存映射</h1>
    
    <p class="single-summary">实现磁盘内存映射</p>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2015-06-28T00:00:00&#43;00:00">June 28, 2015</time>
      

      
    </p>

  </div>

  

  
  

  <div class="single-tags">
    
    <span>
      <a href="https://lich4.github.io/tags/%E9%A9%B1%E5%8A%A8/">#驱动</a>
    </span>
    
    
  </div>

  
  

  

  
  <aside class="toc">
    <p><strong>Table of contents</strong></p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#分析">分析</a></li>
    <li><a href="#结论">结论</a></li>
  </ul>
</nav>
  </aside>
  

  

  <div class="single-content">
    <h2 id="分析">分析</h2>
<p>  这个题目有点眼熟吧，文件内存映射用的比较多，用于大文件读写效率较高。其原理是将映射的内存页的来源标记为磁盘驱动器，这样对地址的读写产生中断时，会直接操作磁盘，这样对打文件的读写速度提高很多。然而这种技术微软只用在文件上，对于目录、磁盘和设备均不能使用。而普通缓冲区buffer方式读写，总是要有内存拷贝，所以相对慢一些，在我3年前做数据恢复的时候，为了研究大文件恢复接触到文件内存映射，第一次就很纳闷到底有没有磁盘映射，这样我就不需要总是读来读去。下面给出这2种方式的区别：</p>
<pre tabindex="0"><code class="language-Txt" data-lang="Txt">Buffered方式：
    CreateFile
    ReadFile/WriteFile
    CloseHandle

mapping方式：
    CreateFile
    CreateFileMapping
    MapViewOfFile
    指针操作
    UnmapViewOfFile
    CloseHandle
    CloseHandle
</code></pre><p>  在这里我对相关内核API做了逆向和破解，写了一个驱动支持对于磁盘实现内存映射。主要是对IRP_MJ_QUERY_INFORMATION和FastIoQueryStandardInfo的hook，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>#include &lt;ntddk.h&gt;
</span></span><span style="display:flex;"><span>#include &#34;DeviceMappingCommon.h&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_DEVICE_MAPPING</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	HANDLE hDevice;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT pFileObject;
</span></span><span style="display:flex;"><span>	LARGE_INTEGER dwMaximumSize;
</span></span><span style="display:flex;"><span>}DEVICE_MAPPING, <span style="color:#ec0000">*</span>PDEVICE_MAPPING;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PDEVICE_MAPPING gMappingData <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>PDRIVER_DISPATCH OriginQuery <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>PFAST_IO_QUERY_STANDARD_INFO OriginFastDispatch <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>FAST_MUTEX gLock;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">extern</span> <span style="color:#008900">&#34;C&#34;</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	BOOLEAN NTAPI <span style="color:#5f5fff">ObFindHandleForObject</span>(PEPROCESS, PVOID, PVOID, PVOID, PHANDLE);
</span></span><span style="display:flex;"><span>	NTSTATUS NTAPI <span style="color:#5f5fff">NtQueryVolumeInformationFile</span> (HANDLE, PIO_STATUS_BLOCK, PVOID, ULONG, FS_INFORMATION_CLASS);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#5f5fff">DeviceMappingDriverUnload</span>(PDRIVER_OBJECT DriverObject)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ExAcquireFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(gMappingData)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ExFreePool((PVOID)gMappingData);
</span></span><span style="display:flex;"><span>		gMappingData <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	ExReleaseFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(DriverObject<span style="color:#ec0000">-&gt;</span>DeviceObject)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		UNICODE_STRING DriverName;
</span></span><span style="display:flex;"><span>		RtlInitUnicodeString(<span style="color:#ec0000">&amp;</span>DriverName, <span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Device</span><span style="color:#008900">\\</span><span style="color:#008900">DeviceMapping&#34;</span>);
</span></span><span style="display:flex;"><span>		IoDeleteSymbolicLink(<span style="color:#ec0000">&amp;</span>DriverName);
</span></span><span style="display:flex;"><span>		IoDeleteDevice(DriverObject<span style="color:#ec0000">-&gt;</span>DeviceObject);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">DeviceMappingQueryInformation</span>(PDEVICE_OBJECT pDevObj, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PIO_STACK_LOCATION stack <span style="color:#ec0000">=</span> IoGetCurrentIrpStackLocation(pIrp);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(stack<span style="color:#ec0000">-&gt;</span>Parameters.QueryFile.FileInformationClass <span style="color:#ec0000">==</span> FileStandardInformation <span style="color:#ec0000">&amp;&amp;</span> stack<span style="color:#ec0000">-&gt;</span>FileObject)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		HANDLE hDevice <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>		BOOLEAN IsRef <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>		ExAcquireFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(gMappingData <span style="color:#ec0000">&amp;&amp;</span> stack<span style="color:#ec0000">-&gt;</span>FileObject <span style="color:#ec0000">==</span> gMappingData<span style="color:#ec0000">-&gt;</span>pFileObject)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			PFILE_STANDARD_INFORMATION FileInformation <span style="color:#ec0000">=</span> (PFILE_STANDARD_INFORMATION)pIrp<span style="color:#ec0000">-&gt;</span>AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>			FileInformation<span style="color:#ec0000">-&gt;</span>EndOfFile.QuadPart <span style="color:#ec0000">=</span> gMappingData<span style="color:#ec0000">-&gt;</span>dwMaximumSize.QuadPart;
</span></span><span style="display:flex;"><span>			pIrp<span style="color:#ec0000">-&gt;</span>IoStatus.Status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>			pIrp<span style="color:#ec0000">-&gt;</span>IoStatus.Information <span style="color:#ec0000">=</span> <span style="color:#ec0000">sizeof</span>(FILE_STANDARD_INFORMATION);
</span></span><span style="display:flex;"><span>			IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>			IsRef <span style="color:#ec0000">=</span> TRUE;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		ExReleaseFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(IsRef)
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	OriginQuery(pDevObj, pIrp);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOLEAN <span style="color:#5f5fff">DeviceMappingFastIo</span>(PFILE_OBJECT FileObject, BOOLEAN Wait, PFILE_STANDARD_INFORMATION Buffer,PIO_STATUS_BLOCK IoStatus,<span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_DEVICE_OBJECT</span> <span style="color:#ec0000">*</span>DeviceObject)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	BOOLEAN ret <span style="color:#ec0000">=</span> OriginFastDispatch(FileObject, Wait, Buffer, IoStatus, DeviceObject);
</span></span><span style="display:flex;"><span>	ExAcquireFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(FileObject <span style="color:#ec0000">==</span> gMappingData<span style="color:#ec0000">-&gt;</span>pFileObject)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		Buffer<span style="color:#ec0000">-&gt;</span>Directory <span style="color:#ec0000">=</span> FALSE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	ExReleaseFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">DeviceMappingIOControl</span>(PDEVICE_OBJECT pDevObj, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	PIO_STACK_LOCATION stack <span style="color:#ec0000">=</span> IoGetCurrentIrpStackLocation(pIrp);
</span></span><span style="display:flex;"><span>	ULONG cbin <span style="color:#ec0000">=</span> stack<span style="color:#ec0000">-&gt;</span>Parameters.DeviceIoControl.InputBufferLength;
</span></span><span style="display:flex;"><span>	ULONG cbout <span style="color:#ec0000">=</span> stack<span style="color:#ec0000">-&gt;</span>Parameters.DeviceIoControl.OutputBufferLength;
</span></span><span style="display:flex;"><span>	ULONG code <span style="color:#ec0000">=</span> stack<span style="color:#ec0000">-&gt;</span>Parameters.DeviceIoControl.IoControlCode;
</span></span><span style="display:flex;"><span>	ULONG info <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">switch</span>(code)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">IOCTL_ENABLE_DEVICEMAPPING</span>:
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			DEVICE_MAPPING tmp;
</span></span><span style="display:flex;"><span>			PFILE_OBJECT fo <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>			PDRIVER_DISPATCH<span style="color:#ec0000">*</span> ppdd <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>			PFAST_IO_QUERY_STANDARD_INFO<span style="color:#ec0000">*</span> ppfiqsi <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>			DEVICEMAPPING_IOCTL_DATA<span style="color:#ec0000">*</span> InputBuffer <span style="color:#ec0000">=</span> (DEVICEMAPPING_IOCTL_DATA<span style="color:#ec0000">*</span>)pIrp<span style="color:#ec0000">-&gt;</span>AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>			RtlZeroMemory(<span style="color:#ec0000">&amp;</span>tmp, <span style="color:#ec0000">sizeof</span>(tmp));
</span></span><span style="display:flex;"><span>			tmp.hDevice <span style="color:#ec0000">=</span> InputBuffer<span style="color:#ec0000">-&gt;</span>hDevice;
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> ObReferenceObjectByHandle(InputBuffer<span style="color:#ec0000">-&gt;</span>hDevice, <span style="color:#ec0000">NULL</span>, <span style="color:#ec0000">*</span>IoFileObjectType, KernelMode, (PVOID<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>fo, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(NT_SUCCESS(status))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				tmp.pFileObject <span style="color:#ec0000">=</span> fo;
</span></span><span style="display:flex;"><span>				PDEVICE_OBJECT  relatedevice <span style="color:#ec0000">=</span> IoGetRelatedDeviceObject(fo);
</span></span><span style="display:flex;"><span>				PDRIVER_OBJECT relatedriver <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>				PFAST_IO_DISPATCH relatedfastdispatch <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>				tmp.dwMaximumSize.QuadPart <span style="color:#ec0000">=</span> InputBuffer<span style="color:#ec0000">-&gt;</span>size;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(relatedriver <span style="color:#ec0000">=</span> relatedevice<span style="color:#ec0000">-&gt;</span>DriverObject)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					OriginQuery <span style="color:#ec0000">=</span> relatedriver<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_QUERY_INFORMATION];
</span></span><span style="display:flex;"><span>					ppdd <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>relatedriver<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_QUERY_INFORMATION];
</span></span><span style="display:flex;"><span>					relatedfastdispatch <span style="color:#ec0000">=</span> relatedriver<span style="color:#ec0000">-&gt;</span>FastIoDispatch;
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(relatedfastdispatch <span style="color:#ec0000">&amp;&amp;</span> relatedfastdispatch<span style="color:#ec0000">-&gt;</span>FastIoQueryStandardInfo)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						OriginFastDispatch <span style="color:#ec0000">=</span> relatedfastdispatch<span style="color:#ec0000">-&gt;</span>FastIoQueryStandardInfo;
</span></span><span style="display:flex;"><span>						ppfiqsi <span style="color:#ec0000">=</span> <span style="color:#ec0000">&amp;</span>relatedfastdispatch<span style="color:#ec0000">-&gt;</span>FastIoQueryStandardInfo;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				ObDereferenceObject(fo);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			ExAcquireFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(gMappingData)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				ExFreePool((PVOID)gMappingData);
</span></span><span style="display:flex;"><span>				gMappingData <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			gMappingData <span style="color:#ec0000">=</span> (DEVICE_MAPPING<span style="color:#ec0000">*</span>)ExAllocatePool(NonPagedPool,<span style="color:#ec0000">sizeof</span>(DEVICE_MAPPING));
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(gMappingData <span style="color:#ec0000">&amp;&amp;</span> ppdd)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				RtlCopyMemory(gMappingData, <span style="color:#ec0000">&amp;</span>tmp, <span style="color:#ec0000">sizeof</span>(DEVICE_MAPPING));
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">*</span>ppdd <span style="color:#ec0000">=</span> DeviceMappingQueryInformation;
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(ppfiqsi)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">*</span>ppfiqsi <span style="color:#ec0000">=</span> DeviceMappingFastIo;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			ExReleaseFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">case</span> <span style="color:#ec0000">IOCTL_DISABLE_DEVICEMAPPING</span>:
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			ExAcquireFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(gMappingData)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				PFILE_OBJECT fo <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>				PDEVICE_OBJECT relatedevice <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>				PDRIVER_OBJECT relatedriver <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> ObReferenceObjectByHandle(gMappingData<span style="color:#ec0000">-&gt;</span>hDevice, <span style="color:#ec0000">NULL</span>, <span style="color:#ec0000">*</span>IoFileObjectType, KernelMode, (PVOID<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>fo, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(NT_SUCCESS(status))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					relatedevice <span style="color:#ec0000">=</span> IoGetRelatedDeviceObject(fo);
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(relatedevice)
</span></span><span style="display:flex;"><span>						relatedriver <span style="color:#ec0000">=</span> relatedevice<span style="color:#ec0000">-&gt;</span>DriverObject;
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(relatedriver <span style="color:#ec0000">&amp;&amp;</span> relatedriver<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_QUERY_INFORMATION] <span style="color:#ec0000">==</span> DeviceMappingQueryInformation)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						relatedriver<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_QUERY_INFORMATION] <span style="color:#ec0000">=</span> OriginQuery;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#ec0000">if</span>(relatedriver <span style="color:#ec0000">&amp;&amp;</span> relatedriver<span style="color:#ec0000">-&gt;</span>FastIoDispatch <span style="color:#ec0000">&amp;&amp;</span> relatedriver<span style="color:#ec0000">-&gt;</span>FastIoDispatch<span style="color:#ec0000">-&gt;</span>FastIoQueryStandardInfo <span style="color:#ec0000">==</span> DeviceMappingFastIo)
</span></span><span style="display:flex;"><span>					{
</span></span><span style="display:flex;"><span>						relatedriver<span style="color:#ec0000">-&gt;</span>FastIoDispatch<span style="color:#ec0000">-&gt;</span>FastIoQueryStandardInfo <span style="color:#ec0000">=</span> OriginFastDispatch;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					ObDereferenceObject(fo);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				ExFreePool((PVOID)gMappingData);
</span></span><span style="display:flex;"><span>				gMappingData <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			ExReleaseFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">default</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> STATUS_INVALID_VARIANT;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ec0000">-&gt;</span>IoStatus.Status <span style="color:#ec0000">=</span> status;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ec0000">-&gt;</span>IoStatus.Information <span style="color:#ec0000">=</span> info;
</span></span><span style="display:flex;"><span>	IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">DeviceMappingDriverDefaultDispatch</span>(PDEVICE_OBJECT pDevObj, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ec0000">-&gt;</span>IoStatus.Status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	pIrp<span style="color:#ec0000">-&gt;</span>IoStatus.Information <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	IoCompleteRequest(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#pragma code_seg(&#34;INIT&#34;)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">extern</span> <span style="color:#008900">&#34;C&#34;</span> NTSTATUS DriverEntry(PDRIVER_OBJECT pDriverObj, PUNICODE_STRING pRegistryString)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	UNICODE_STRING DevName;
</span></span><span style="display:flex;"><span>	PDEVICE_OBJECT pDevObj <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	pDriverObj<span style="color:#ec0000">-&gt;</span>DriverUnload <span style="color:#ec0000">=</span> DeviceMappingDriverUnload;
</span></span><span style="display:flex;"><span>	pDriverObj<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_CREATE] <span style="color:#ec0000">=</span> DeviceMappingDriverDefaultDispatch;
</span></span><span style="display:flex;"><span>	pDriverObj<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_CLOSE] <span style="color:#ec0000">=</span> DeviceMappingDriverDefaultDispatch;
</span></span><span style="display:flex;"><span>	pDriverObj<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_READ] <span style="color:#ec0000">=</span> DeviceMappingDriverDefaultDispatch;
</span></span><span style="display:flex;"><span>	pDriverObj<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_WRITE] <span style="color:#ec0000">=</span> DeviceMappingDriverDefaultDispatch;
</span></span><span style="display:flex;"><span>	pDriverObj<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_DEVICE_CONTROL] <span style="color:#ec0000">=</span> DeviceMappingIOControl;
</span></span><span style="display:flex;"><span>	RtlInitUnicodeString(<span style="color:#ec0000">&amp;</span>DevName, <span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">Device</span><span style="color:#008900">\\</span><span style="color:#008900">DeviceMapping&#34;</span>);
</span></span><span style="display:flex;"><span>	ExInitializeFastMutex(<span style="color:#ec0000">&amp;</span>gLock);
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> IoCreateDevice(pDriverObj, <span style="color:#008900">0</span>, <span style="color:#ec0000">&amp;</span>DevName, FILE_DEVICE_UNKNOWN, <span style="color:#008900">0</span>, TRUE, <span style="color:#ec0000">&amp;</span>pDevObj);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(NT_SUCCESS(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		pDevObj<span style="color:#ec0000">-&gt;</span>Flags <span style="color:#ec0000">|=</span> DO_BUFFERED_IO;
</span></span><span style="display:flex;"><span>		UNICODE_STRING SymLinkName;
</span></span><span style="display:flex;"><span>		RtlInitUnicodeString(<span style="color:#ec0000">&amp;</span>SymLinkName, <span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">??</span><span style="color:#008900">\\</span><span style="color:#008900">DeviceMapping&#34;</span>);
</span></span><span style="display:flex;"><span>		IoCreateSymbolicLink(<span style="color:#ec0000">&amp;</span>SymLinkName, <span style="color:#ec0000">&amp;</span>DevName);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> status;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#define MAXNAME 256
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#define IOCTL_ENABLE_DEVICEMAPPING CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)
</span></span><span style="display:flex;"><span>#define IOCTL_DISABLE_DEVICEMAPPING CTL_CODE(FILE_DEVICE_UNKNOWN, 0x801, METHOD_BUFFERED, FILE_ANY_ACCESS)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_DEVICEMAPPING_IOCTL_DATA</span>//和驱动通信所用data
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	HANDLE hDevice;
</span></span><span style="display:flex;"><span>	ULONG size;
</span></span><span style="display:flex;"><span>}DEVICEMAPPING_IOCTL_DATA, <span style="color:#ec0000">*</span>PDEVICEMAPPING_IOCTL_DATA;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span>#include &#34;DeviceMappingCommon.h&#34;
</span></span><span style="display:flex;"><span>#include &lt;time.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;iostream&gt;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">using</span> <span style="color:#ec0000">namespace</span> std;
</span></span><span style="display:flex;"><span>#define BUFSIZE 0x1000
</span></span><span style="display:flex;"><span>#define WRITECOUNT 0x10000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">MappingRead</span>(HANDLE hc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	HANDLE hObj <span style="color:#ec0000">=</span> CreateFileA(<span style="color:#008900">&#34;c:</span><span style="color:#008900">\\</span><span style="color:#008900">1.dat&#34;</span>, GENERIC_ALL, <span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, CREATE_NEW, FILE_ATTRIBUTE_NORMAL, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(hObj <span style="color:#ec0000">==</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		cout<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">&#34;Open 1.dat failed&#34;</span><span style="color:#ec0000">&lt;&lt;</span>endl;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	HANDLE hMap <span style="color:#ec0000">=</span> CreateFileMapping(hc, <span style="color:#ec0000">NULL</span>, PAGE_READONLY, <span style="color:#008900">0</span>, BUFSIZE <span style="color:#ec0000">*</span> WRITECOUNT, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(hMap)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		PBYTE pbDev <span style="color:#ec0000">=</span> (PBYTE)MapViewOfFile(hMap, FILE_MAP_COPY, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>, <span style="color:#008900">0</span>);
</span></span><span style="display:flex;"><span>		DWORD cbwrite;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(pbDev)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">for</span>(<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;i <span style="color:#ec0000">&lt;</span> WRITECOUNT; i<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				WriteFile(hObj, pbDev <span style="color:#ec0000">+</span> i <span style="color:#ec0000">*</span> BUFSIZE, BUFSIZE, <span style="color:#ec0000">&amp;</span>cbwrite, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			UnmapViewOfFile(pbDev);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		CloseHandle(hMap);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		cout<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">&#34;error:&#34;</span><span style="color:#ec0000">&lt;&lt;</span>GetLastError();
</span></span><span style="display:flex;"><span>	CloseHandle(hObj);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">BufferedRead</span>(HANDLE hc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	BYTE buf[BUFSIZE];
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> count <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	DWORD cbwrite;
</span></span><span style="display:flex;"><span>	HANDLE hObj <span style="color:#ec0000">=</span> CreateFileA(<span style="color:#008900">&#34;c:</span><span style="color:#008900">\\</span><span style="color:#008900">2.dat&#34;</span>, GENERIC_ALL, <span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, CREATE_NEW, FILE_ATTRIBUTE_NORMAL, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(hObj <span style="color:#ec0000">==</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		cout<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">&#34;Open 2.dat failed&#34;</span><span style="color:#ec0000">&lt;&lt;</span>endl;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">while</span>(ReadFile(hc, buf, BUFSIZE, <span style="color:#ec0000">&amp;</span>cbwrite, <span style="color:#ec0000">NULL</span>) <span style="color:#ec0000">&amp;&amp;</span> cbwrite <span style="color:#ec0000">&amp;&amp;</span> count<span style="color:#ec0000">++</span> <span style="color:#ec0000">&lt;</span> WRITECOUNT)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		WriteFile(hObj, buf, BUFSIZE, <span style="color:#ec0000">&amp;</span>cbwrite, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	CloseHandle(hObj);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	HANDLE hFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	hFile <span style="color:#ec0000">=</span> CreateFileA(<span style="color:#008900">&#34;</span><span style="color:#008900">\\\\</span><span style="color:#008900">.</span><span style="color:#008900">\\</span><span style="color:#008900">c:&#34;</span>, GENERIC_READ, FILE_SHARE_READ <span style="color:#ec0000">|</span> FILE_SHARE_WRITE,
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(hFile <span style="color:#ec0000">==</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		cout<span style="color:#ec0000">&lt;&lt;</span><span style="color:#008900">&#34;Open c: failed&#34;</span><span style="color:#ec0000">&lt;&lt;</span>endl;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	time_t begin,end;
</span></span><span style="display:flex;"><span>	_asm{<span style="color:#5f5fff">int</span> <span style="color:#008900">3</span>};
</span></span><span style="display:flex;"><span>	HANDLE hDeviceMapping <span style="color:#ec0000">=</span> CreateFileA(<span style="color:#008900">&#34;</span><span style="color:#008900">\\\\</span><span style="color:#008900">.</span><span style="color:#008900">\\</span><span style="color:#008900">DeviceMapping&#34;</span>,<span style="color:#008900">0</span>, <span style="color:#008900">0</span>, <span style="color:#ec0000">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span>GetLastError();
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(hDeviceMapping <span style="color:#ec0000">!=</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		DEVICEMAPPING_IOCTL_DATA did <span style="color:#ec0000">=</span> {hFile, BUFSIZE <span style="color:#ec0000">*</span> WRITECOUNT};
</span></span><span style="display:flex;"><span>		DWORD retlen;
</span></span><span style="display:flex;"><span>		DeviceIoControl(hDeviceMapping, IOCTL_ENABLE_DEVICEMAPPING, <span style="color:#ec0000">&amp;</span>did, <span style="color:#ec0000">sizeof</span>(did), <span style="color:#ec0000">&amp;</span>did, <span style="color:#008900">0</span>, <span style="color:#ec0000">&amp;</span>retlen, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		begin <span style="color:#ec0000">=</span> time(<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		MappingRead(hFile);
</span></span><span style="display:flex;"><span>		end <span style="color:#ec0000">=</span> time(<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		DeviceIoControl(hDeviceMapping, IOCTL_DISABLE_DEVICEMAPPING, <span style="color:#ec0000">&amp;</span>did, <span style="color:#ec0000">sizeof</span>(did), <span style="color:#ec0000">&amp;</span>did, <span style="color:#008900">0</span>, <span style="color:#ec0000">&amp;</span>retlen, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		CloseHandle(hDeviceMapping);
</span></span><span style="display:flex;"><span>		cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;Mapping time:&#34;</span> <span style="color:#ec0000">&lt;&lt;</span>end <span style="color:#ec0000">-</span> begin <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		cout<span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;Error info:&#34;</span><span style="color:#ec0000">&lt;&lt;</span>GetLastError()<span style="color:#ec0000">&lt;&lt;</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	begin <span style="color:#ec0000">=</span> time(<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	BufferedRead(hFile);
</span></span><span style="display:flex;"><span>	end<span style="color:#ec0000">=</span>time(<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;Buffer time:&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> end <span style="color:#ec0000">-</span> begin <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	CloseHandle(hFile);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>//#include &lt;ntddk.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;ntifs.h&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_HANDLE_TABLE</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ULONG_PTR TableCode;
</span></span><span style="display:flex;"><span>	PEPROCESS QuotaProcess;
</span></span><span style="display:flex;"><span>	HANDLE UniqueProcessId;
</span></span><span style="display:flex;"><span>#define HANDLE_TABLE_LOCKS 4
</span></span><span style="display:flex;"><span>	EX_PUSH_LOCK HandleTableLock[HANDLE_TABLE_LOCKS];
</span></span><span style="display:flex;"><span>	LIST_ENTRY HandleTableList;
</span></span><span style="display:flex;"><span>	EX_PUSH_LOCK HandleContentionEvent;
</span></span><span style="display:flex;"><span>	PVOID DebugInfo;
</span></span><span style="display:flex;"><span>	LONG ExtraInfoPages;
</span></span><span style="display:flex;"><span>	ULONG FirstFree;
</span></span><span style="display:flex;"><span>	ULONG LastFree;
</span></span><span style="display:flex;"><span>	ULONG NextHandleNeedingPool;
</span></span><span style="display:flex;"><span>	LONG HandleCount;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">union</span> 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ULONG Flags;
</span></span><span style="display:flex;"><span>		BOOLEAN <span style="color:#ec0000">StrictFIFO</span> : <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>} HANDLE_TABLE, <span style="color:#ec0000">*</span>PHANDLE_TABLE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_HANDLE_TABLE_ENTRY</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">union</span> 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		PVOID Object;
</span></span><span style="display:flex;"><span>		ULONG ObAttributes;
</span></span><span style="display:flex;"><span>		PACCESS_MASK AuditMask;
</span></span><span style="display:flex;"><span>		ULONG_PTR Value;
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">union</span> 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">union</span> 
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			ACCESS_MASK GrantedAccess;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">struct</span> 
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				USHORT GrantedAccessIndex;
</span></span><span style="display:flex;"><span>				USHORT CreatorBackTraceIndex;
</span></span><span style="display:flex;"><span>			};
</span></span><span style="display:flex;"><span>		};
</span></span><span style="display:flex;"><span>		LONG NextFreeTableEntry;
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>} HANDLE_TABLE_ENTRY, <span style="color:#ec0000">*</span>PHANDLE_TABLE_ENTRY;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">extern</span> <span style="color:#008900">&#34;C&#34;</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">typedef</span> <span style="color:#5f5fff">BOOLEAN</span> (<span style="color:#ec0000">*</span>EX_ENUMERATE_HANDLE_ROUTINE)(PHANDLE_TABLE_ENTRY,HANDLE,PVOID );
</span></span><span style="display:flex;"><span>	BOOLEAN <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">ObFindHandleForObject</span>(PEPROCESS,PVOID,PVOID,PVOID,PHANDLE);
</span></span><span style="display:flex;"><span>	PHANDLE_TABLE <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">ObReferenceProcessHandleTable</span> (PEPROCESS);
</span></span><span style="display:flex;"><span>	BOOLEAN <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">ExEnumHandleTable</span> (PHANDLE_TABLE, EX_ENUMERATE_HANDLE_ROUTINE ,PVOID,PHANDLE);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#5f5fff">Unload</span>(PDRIVER_OBJECT pDriverObject)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>PDRIVER_DISPATCH defaultdispatch<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#5f5fff">QuerySize</span> (PDEVICE_OBJECT pDeviceObject, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PAGED_CODE();
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	PIO_STACK_LOCATION IrpSp <span style="color:#ec0000">=</span> IoGetCurrentIrpStackLocation(pIrp);
</span></span><span style="display:flex;"><span>	KdPrint((<span style="color:#008900">&#34;MajorFunction=%d MinorFunction=%d</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,IrpSp<span style="color:#ec0000">-&gt;</span>MajorFunction,IrpSp<span style="color:#ec0000">-&gt;</span>MinorFunction));
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(IrpSp<span style="color:#ec0000">-&gt;</span>Parameters.QueryFile.FileInformationClass <span style="color:#ec0000">==</span> FileStandardInformation)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		IO_STATUS_BLOCK isb;
</span></span><span style="display:flex;"><span>		FILE_FS_FULL_SIZE_INFORMATION ffsi;
</span></span><span style="display:flex;"><span>		HANDLE handle <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>		RtlZeroMemory(<span style="color:#ec0000">&amp;</span>ffsi,<span style="color:#ec0000">sizeof</span>(ffsi));
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(<span style="color:#ec0000">!</span>IrpSp<span style="color:#ec0000">-&gt;</span>FileObject){}
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">if</span>(ObFindHandleForObject(IoGetCurrentProcess(),IrpSp<span style="color:#ec0000">-&gt;</span>FileObject,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">&amp;</span>handle))
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				status <span style="color:#ec0000">=</span> NtQueryVolumeInformationFile(handle,<span style="color:#ec0000">&amp;</span>isb,<span style="color:#ec0000">&amp;</span>ffsi,<span style="color:#ec0000">sizeof</span>(ffsi),FileFsFullSizeInformation);
</span></span><span style="display:flex;"><span>				<span style="color:#ec0000">if</span>(NT_SUCCESS(status))
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>// 					KdPrint((&#34;ActualAvailableAllocationUnits=%L\n&#34;,&amp;ffsi.ActualAvailableAllocationUnits));
</span></span><span style="display:flex;"><span>// 					KdPrint((&#34;BytesPerSector=%d\n&#34;,ffsi.BytesPerSector));
</span></span><span style="display:flex;"><span>// 					KdPrint((&#34;TotalAllocationUnits=%L\n&#34;,&amp;ffsi.TotalAllocationUnits));
</span></span><span style="display:flex;"><span>// 					KdPrint((&#34;CallerAvailableAllocationUnits=%L\n&#34;,&amp;ffsi.CallerAvailableAllocationUnits));
</span></span><span style="display:flex;"><span>// 					KdPrint((&#34;SectorsPerAllocationUnit=%d\n&#34;,ffsi.SectorsPerAllocationUnit));
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			PFILE_STANDARD_INFORMATION FileInformation <span style="color:#ec0000">=</span> (PFILE_STANDARD_INFORMATION)pIrp<span style="color:#ec0000">-&gt;</span>AssociatedIrp.SystemBuffer;
</span></span><span style="display:flex;"><span>			FileInformation<span style="color:#ec0000">-&gt;</span>EndOfFile.QuadPart <span style="color:#ec0000">=</span> ffsi.TotalAllocationUnits.QuadPart;
</span></span><span style="display:flex;"><span>			FileInformation<span style="color:#ec0000">-&gt;</span>EndOfFile.QuadPart <span style="color:#ec0000">*=</span> ffsi.SectorsPerAllocationUnit <span style="color:#ec0000">*</span> ffsi.BytesPerSector;
</span></span><span style="display:flex;"><span>			<span style="color:#ec0000">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> defaultdispatch(pDeviceObject,pIrp);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_DEVICE_EXTENSION</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}DEVICE_EXTENSION,<span style="color:#ec0000">*</span>PDEVICE_EXTENSION;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">extern</span> <span style="color:#008900">&#34;C&#34;</span> NTSTATUS DriverEntry(PDRIVER_OBJECT pDriverObj, PUNICODE_STRING pRegistryString)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	NTSTATUS status <span style="color:#ec0000">=</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>	HANDLE hfile;
</span></span><span style="display:flex;"><span>	pDriverObj<span style="color:#ec0000">-&gt;</span>DriverUnload<span style="color:#ec0000">=</span>Unload;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	OBJECT_ATTRIBUTES oa;
</span></span><span style="display:flex;"><span>	UNICODE_STRING drivename;
</span></span><span style="display:flex;"><span>	IO_STATUS_BLOCK isb;
</span></span><span style="display:flex;"><span>	PFILE_OBJECT fo;
</span></span><span style="display:flex;"><span>	LARGE_INTEGER li<span style="color:#ec0000">=</span>{<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>	RtlInitUnicodeString(<span style="color:#ec0000">&amp;</span>drivename,<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">??</span><span style="color:#008900">\\</span><span style="color:#008900">c:&#34;</span>);
</span></span><span style="display:flex;"><span>	InitializeObjectAttributes(<span style="color:#ec0000">&amp;</span>oa,<span style="color:#ec0000">&amp;</span>drivename,OBJ_CASE_INSENSITIVE,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>	status <span style="color:#ec0000">=</span> ZwOpenFile(<span style="color:#ec0000">&amp;</span>hfile,FILE_READ_DATA<span style="color:#ec0000">|</span>FILE_READ_ATTRIBUTES<span style="color:#ec0000">|</span>SYNCHRONIZE,<span style="color:#ec0000">&amp;</span>oa,<span style="color:#ec0000">&amp;</span>isb,
</span></span><span style="display:flex;"><span>		FILE_SHARE_READ<span style="color:#ec0000">|</span>FILE_SHARE_WRITE,FILE_OPEN_FOR_FREE_SPACE_QUERY<span style="color:#ec0000">|</span>FILE_SYNCHRONOUS_IO_NONALERT);
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span>(NT_SUCCESS(status))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		KdPrint((<span style="color:#008900">&#34;</span><span style="color:#008900">\n\n</span><span style="color:#008900">DriverEntry Entered</span><span style="color:#008900">\n</span><span style="color:#008900">Handle=%08x</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,hfile));
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> ObReferenceObjectByHandle(hfile,<span style="color:#008900">0</span>,<span style="color:#ec0000">*</span>IoFileObjectType,KernelMode,(PVOID<span style="color:#ec0000">*</span>)<span style="color:#ec0000">&amp;</span>fo,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>		KdPrint((<span style="color:#008900">&#34;fo=%p</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>,fo));
</span></span><span style="display:flex;"><span>		FILE_FS_FULL_SIZE_INFORMATION ffsi;
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> NtQueryVolumeInformationFile(hfile,<span style="color:#ec0000">&amp;</span>isb,<span style="color:#ec0000">&amp;</span>ffsi,<span style="color:#ec0000">sizeof</span>(ffsi),FileFsFullSizeInformation);
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> FsRtlGetFileSize(fo,<span style="color:#ec0000">&amp;</span>li);
</span></span><span style="display:flex;"><span>		PDRIVER_OBJECT passocdrive <span style="color:#ec0000">=</span> IoGetRelatedDeviceObject(fo)<span style="color:#ec0000">-&gt;</span>DriverObject;
</span></span><span style="display:flex;"><span>		defaultdispatch <span style="color:#ec0000">=</span> passocdrive<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_QUERY_INFORMATION];
</span></span><span style="display:flex;"><span>		passocdrive<span style="color:#ec0000">-&gt;</span>MajorFunction[IRP_MJ_QUERY_INFORMATION]<span style="color:#ec0000">=</span>QuerySize;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	//	PDEVICE_OBJECT DeviceObject = IoGetRelatedDeviceObject(fo);
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> FsRtlGetFileSize(fo,<span style="color:#ec0000">&amp;</span>li);
</span></span><span style="display:flex;"><span>		HANDLE sechandle;
</span></span><span style="display:flex;"><span>		LARGE_INTEGER li<span style="color:#ec0000">=</span>{<span style="color:#008900">0</span>};
</span></span><span style="display:flex;"><span>		li.LowPart<span style="color:#ec0000">=</span><span style="color:#008900">0x1000</span>;
</span></span><span style="display:flex;"><span>		RtlInitUnicodeString(<span style="color:#ec0000">&amp;</span>drivename,<span style="color:#008900">L</span><span style="color:#008900">&#34;</span><span style="color:#008900">\\</span><span style="color:#008900">??</span><span style="color:#008900">\\</span><span style="color:#008900">map1&#34;</span>);
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> ZwCreateSection(<span style="color:#ec0000">&amp;</span>sechandle,SECTION_MAP_READ,<span style="color:#ec0000">&amp;</span>oa,<span style="color:#ec0000">&amp;</span>li,PAGE_READONLY,SEC_COMMIT,hfile);
</span></span><span style="display:flex;"><span>		PVOID addr<span style="color:#ec0000">=</span><span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>		SIZE_T size<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">if</span>(NT_SUCCESS(status))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			status <span style="color:#ec0000">=</span> ZwMapViewOfSection(sechandle,ZwCurrentProcess(),<span style="color:#ec0000">&amp;</span>addr,<span style="color:#008900">0</span>,<span style="color:#008900">0x1000</span>,<span style="color:#ec0000">NULL</span>,<span style="color:#ec0000">&amp;</span>size,ViewShare, 
</span></span><span style="display:flex;"><span>				MEM_TOP_DOWN,PAGE_READONLY);
</span></span><span style="display:flex;"><span>			ULONG data<span style="color:#ec0000">=*</span>(ULONG<span style="color:#ec0000">*</span>)addr;
</span></span><span style="display:flex;"><span>			data<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		status <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="结论">结论</h2>
<p>  分别用缓冲区方式和内存映射方式，分别读取c盘前256MB，分别写入文件中，Mapping time:23，Buffer time:26，可见还是有一些效果的~~~。获取的硬盘数据也确实是分区数据：</p>
<pre tabindex="0"><code class="language-Txt" data-lang="Txt">文件内容：
Offset      0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F

 00000000   EB 52 90 4E 54 46 53 20  20 20 20 00 02 08 00 00   隦 NTFS         
 00000010   00 00 00 00 00 F8 00 00  3F 00 FF 00 3F 00 00 00        ? ?  ?   
00000020   00 00 00 00 80 00 80 00  B1 8C 7F 02 00 00 00 00       € € 睂      
00000030   00 00 0C 00 00 00 00 00  CB F8 27 00 00 00 00 00           锁&#39;     
00000040   F6 00 00 00 01 00 00 00  CC 44 E9 BC 90 E9 BC 3C   ?      藾榧 榧&lt;
00000050   00 00 00 00 FA 33 C0 8E  D0 BC 00 7C FB B8 C0 07       ?缼屑 |?
00000060   8E D8 E8 16 00 B8 00 0D  8E C0 33 DB C6 06 0E 00   庁? ? 幚3燮   
00000070   10 E8 53 00 68 00 0D 68  6A 02 CB 8A 16 24 00 B4    鑃 h  hj 藠 $ ?
00000080   08 CD 13 73 05 B9 FF FF  8A F1 66 0F B6 C6 40 66    ?s ?婑f 镀@f
 00000090   0F B6 D1 80 E2 3F F7 E2  86 CD C0 ED 06 41 66 0F    堆€?麾喭理 Af 
 000000A0   B7 C9 66 F7 E1 66 A3 20  00 C3 B4 41 BB AA 55 8A   飞f麽f? 么A华U?
 000000B0   16 24 00 CD 13 72 0F 81  FB 55 AA 75 09 F6 C1 01    $ ?r  鸘猽 隽 
000000C0   74 04 FE 06 14 00 C3 66  60 1E 06 66 A1 10 00 66   t ?  胒`  f? f
 000000D0   03 06 1C 00 66 3B 06 20  00 0F 82 3A 00 1E 66 6A       f;    ?  fj
 000000E0   00 66 50 06 53 66 68 10  00 01 00 80 3E 14 00 00    fP Sfh    €&gt;   
000000F0   0F 85 0C 00 E8 B3 FF 80  3E 14 00 00 0F 84 61 00    ? 璩€&gt;    刟 
00000100   B4 42 8A 16 24 00 16 1F  8B F4 CD 13 66 58 5B 07   碆?$   嬼?fX[ 
 00000110   66 58 66 58 1F EB 2D 66  33 D2 66 0F B7 0E 18 00   fXfX ?f3襢 ?  
00000120   66 F7 F1 FE C2 8A CA 66  8B D0 66 C1 EA 10 F7 36   f黢娛f嬓f陵 ?
00000130   1A 00 86 D6 8A 16 24 00  8A E8 C0 E4 06 0A CC B8     喼?$ 婅冷  谈
00000140   01 02 CD 13 0F 82 19 00  8C C0 05 20 00 8E C0 66     ? ? 尷   幚f
 00000150   FF 06 10 00 FF 0E 0E 00  0F 85 6F FF 07 1F 66 61          卭  fa
 00000160   C3 A0 F8 01 E8 09 00 A0  FB 01 E8 03 00 FB EB FE   脿?? 狖 ? ?
00000170   B4 01 8B F0 AC 3C 00 74  09 B4 0E BB 07 00 CD 10   ?嬸? t ?? ?
 00000180   EB F2 C3 0D 0A 41 20 64  69 73 6B 20 72 65 61 64   腧? A disk read
 00000190   20 65 72 72 6F 72 20 6F  63 63 75 72 72 65 64 00    error occurred 
 000001A0   0D 0A 4E 54 4C 44 52 20  69 73 20 6D 69 73 73 69     NTLDR is missi
 000001B0   6E 67 00 0D 0A 4E 54 4C  44 52 20 69 73 20 63 6F   ng   NTLDR is co
 000001C0   6D 70 72 65 73 73 65 64  00 0D 0A 50 72 65 73 73   mpressed   Press
 000001D0   20 43 74 72 6C 2B 41 6C  74 2B 44 65 6C 20 74 6F    Ctrl+Alt+Del to
 000001E0   20 72 65 73 74 61 72 74  0D 0A 00 00 00 00 00 00    restart        
 000001F0   00 00 00 00 00 00 00 00  83 A0 B3 C9 00 00 55 AA           儬成  U?
</code></pre>
    
    <script src="https://giscus.app/client.js"
        data-repo="lich4/lich4.github.io"
        data-repo-id="R_kgDOMTT_mw"
        data-category=""
        data-category-id="DIC_kwDOMTT_m84Cjbim"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

    
  </div>

  


  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/win_posts/20150526_force_del_file/">
                        强删正在运行文件
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
            <div class="single-pagination-container-next">
                <div class="single-pagination-text">
                    <a href="/win_posts/20150629_mfc_msgcb/">
                        MFC消息响应函数逆向分析
                    </a>
                </div>
                <div class="single-pagination-text">→</div>
            </div>
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


      </main>
    </div>

    <footer>
      

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    



    </footer>
    
  </body>

  <script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

</html>