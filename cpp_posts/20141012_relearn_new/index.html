<!DOCTYPE html>
<html lang="zh-CN"
  dir="ltr">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://lich4.github.io//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://lich4.github.io//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://lich4.github.io//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://lich4.github.io//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://lich4.github.io//apple-touch-icon.png">

<meta name="description" content=""/>

<title>
    
    重识new | 超哥的博客
    
</title>

<link rel="canonical" href="https://lich4.github.io/cpp_posts/20141012_relearn_new/"/>












<link rel="stylesheet" href="/assets/combined.min.cbcb816aefdb3b7380c5921cbb3b89d12f07742cb3f869754adb56da84f0d729.css" media="all">









  </head>

  

  
  
  

  <body class="light">

    <div class="content">
      <header>
        

<div class="header">

    

</div>

      </header>

      <main class="main">
        





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a href="/cpp_posts/">Cpp_posts</a>
    <span class="breadcrumbs-separator"> > </span>
    
    <a class="breadcrumbs-current" href="/cpp_posts/20141012_relearn_new/">重识new</a>
</div>



<div >

  <div class="single-intro-container">

    

    <h1 class="single-title">重识new</h1>
    
    <p class="single-summary">重识new</p>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2014-10-12T00:00:00&#43;00:00">October 12, 2014</time>
      

      
    </p>

  </div>

  

  
  
  

  

  
  <aside class="toc">
    <p><strong>Table of contents</strong></p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一new-primer">一、new primer</a></li>
    <li><a href="#二new-primer-plus">二、new primer plus</a></li>
    <li><a href="#探究第一种new形式实现">探究第一种new形式实现</a></li>
    <li><a href="#探究第二种new形式实现">探究第二种new形式实现</a></li>
    <li><a href="#探究第三种new形式实现">探究第三种new形式实现</a></li>
    <li><a href="#探究第一种new形式实现-1">探究第一种new[]形式实现</a></li>
    <li><a href="#探究第一种形式delete形式实现">探究第一种形式delete[]形式实现</a></li>
    <li><a href="#探究第二种情况new形式实现">探究第二种情况new[]形式实现</a></li>
    <li><a href="#探究第三种情况new形式实现">探究第三种情况new[]形式实现</a></li>
    <li><a href="#malloca">malloca</a></li>
    <li><a href="#calloc">calloc</a></li>
    <li><a href="#_expand">_expand</a></li>
    <li><a href="#realloc">realloc</a></li>
    <li><a href="#malloc">malloc</a></li>
    <li><a href="#free">free</a></li>
  </ul>
</nav>
  </aside>
  

  

  <div class="single-content">
    <h2 id="一new-primer">一、new primer</h2>
<p>  new操作符并不是c++的专属，c运行库有new.h头文件。C++中的new操作符，众所周知是用来分配动态内存的，而要能达到“动态”这种灵活性的特征，非堆区莫属，因为堆区支持手动分配。如果内存空间不够，new操作符返回空，或抛出异常（下面会讲述3种new操作符，常规new操作符、定位new操作符和禁止抛出异常的new操作符，如果禁止抛异常，那么只好返回空了）下面代码为MSDN中的，检测new分配是否成功，内存分配失败处理还可以通过_set_new_handler注册分配异常函数结果</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// insufficient_memory_conditions.cpp
</span></span><span style="display:flex;"><span>// compile with: /EHsc
</span></span><span style="display:flex;"><span>#include &lt;iostream&gt;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">using</span> <span style="color:#ec0000">namespace</span> std;
</span></span><span style="display:flex;"><span>#define BIG_NUMBER 100000000
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span>() {
</span></span><span style="display:flex;"><span>   <span style="color:#5f5fff">int</span> <span style="color:#ec0000">*</span>pI <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> <span style="color:#5f5fff">int</span>[BIG_NUMBER];
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">if</span>( pI <span style="color:#ec0000">==</span> <span style="color:#008900">0x0</span> ) {
</span></span><span style="display:flex;"><span>      cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;Insufficient memory&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>      <span style="color:#ec0000">return</span> <span style="color:#ec0000">-</span><span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  对于对象使用new操作符的情况，生成的代码执行的流程一般为：先调用内部合适的new函数，该函数最终调用内存分配API进行堆内存分配，同时初始化一些方便内存管理的结构体和数据。成功分配后，将该地址视为this，如有必要则设置虚表指针，之后调用构造函数对该地址处对象进行构造。构造函数一般也是执行初始化功能而已，修改修改数据啥的。这些都是老生常谈不再赘述。<br>
  即使请求的空间是0字节大小，new也会返回不同的地址，也就说总是在不同区域分配。这里注意和空类的区别，空类的大小是1，传给new函数（该函数在之后给出）之后，new函数接受到的参数只会&gt;=1，而对于特殊情况：char* pch=new char[0];new函数接受的参数确实是0，不过分配的空间并不是0字节，因为存在内存管理相关的结构体也会占用内存。<br>
  new操作符有2种作用域，一种是全局new，一种是类作用域new。用户在自定义类中可以重载自定义new函数。代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>#include &lt;malloc.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;memory.h&gt;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">class</span> <span style="color:#5f5fff">Blanks</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>    Blanks(){}
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span><span style="color:#ec0000">operator</span> <span style="color:#5f5fff">new</span>( size_t stAllocateBlock, <span style="color:#5f5fff">char</span> chInit );
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>Blanks<span style="color:#ec0000">::</span><span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>( size_t stAllocateBlock, <span style="color:#5f5fff">char</span> chInit )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>pvTemp <span style="color:#ec0000">=</span> malloc( stAllocateBlock );
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>( pvTemp <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span> )
</span></span><span style="display:flex;"><span>        memset( pvTemp, chInit, stAllocateBlock );
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> pvTemp;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>// 对于Blanks对象，全局new操作符已被替换，因此下面的代码将分配sizeof(Blanks)大小的空间并把数据赋值为0xa5
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   Blanks <span style="color:#ec0000">*</span>a5 <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span>(<span style="color:#008900">0xa5</span>) Blanks;
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">return</span> a5 <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="二new-primer-plus">二、new primer plus</h2>
<p>  new和delete操作符是通过一种称为自由存储区的内存池分配内存的，而new和delete操作符本身在编译时会由编译器选择合适的new函数和delete函数进行实现。C运行库的new函数会在失败时抛出std::bad_alloc异常，如果要使用不抛出异常的new版本，则需要链接nothrownew.obj，然而一旦链接了该文件，标准C++库中的new就不起作用了。new有2种语法形式</p>
<ul>
<li>[::] new [placement] new-type-name [new-initializer]</li>
<li>[::] new [placement] ( type-name ) [new-initializer]</li>
</ul>
<p>2种new函数原型为：</p>
<ul>
<li><code>void* operator new( std::size_t _Count ) throw(bad_alloc); </code></li>
<li><code>void* operator new( std::size_t _Count, const std::nothrow_t&amp; ) throw( ); </code></li>
<li><code>void* operator new( std::size_t _Count, void* _Ptr ) throw( );</code></li>
<li><code>void *operator new[]( std::size_t _Count ) throw(std::bad_alloc); </code></li>
<li><code>void *operator new[]( std::size_t _Count, const std::nothrow_t&amp; ) throw( ); </code></li>
<li><code>void *operator new[]( std::size_t _Count, void* _Ptr ) throw( );</code></li>
</ul>
<p>其用法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>#include&lt;new&gt;
</span></span><span style="display:flex;"><span>#include&lt;iostream&gt;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">using</span> <span style="color:#ec0000">namespace</span> std;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">class</span> <span style="color:#5f5fff">MyClass</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span> 
</span></span><span style="display:flex;"><span>   MyClass( )
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>      cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;Construction MyClass.&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#ec0000">this</span> <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>   };
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">~</span>MyClass( )
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>      imember <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>; cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;Destructing MyClass.&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#ec0000">this</span> <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>   };
</span></span><span style="display:flex;"><span>   <span style="color:#5f5fff">int</span> imember;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span>( ) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   // The first form of new delete
</span></span><span style="display:flex;"><span>   MyClass<span style="color:#ec0000">*</span> fPtr <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> MyClass;
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">delete</span> fPtr;
</span></span><span style="display:flex;"><span>   // The second form of new delete
</span></span><span style="display:flex;"><span>   MyClass<span style="color:#ec0000">*</span> fPtr2 <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span>( nothrow ) MyClass;
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">delete</span> fPtr2;
</span></span><span style="display:flex;"><span>   // The third form of new delete
</span></span><span style="display:flex;"><span>   <span style="color:#5f5fff">char</span> x[<span style="color:#ec0000">sizeof</span>( MyClass )];
</span></span><span style="display:flex;"><span>   MyClass<span style="color:#ec0000">*</span> fPtr3 <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span>( <span style="color:#ec0000">&amp;</span>x[<span style="color:#008900">0</span>] ) MyClass;
</span></span><span style="display:flex;"><span>   fPtr3 <span style="color:#ec0000">-&gt;</span> <span style="color:#ec0000">~</span>MyClass();
</span></span><span style="display:flex;"><span>   cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;The address of x[0] is : &#34;</span> <span style="color:#ec0000">&lt;&lt;</span> ( <span style="color:#5f5fff">void</span><span style="color:#ec0000">*</span> )<span style="color:#ec0000">&amp;</span>x[<span style="color:#008900">0</span>] <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Construction MyClass<span style="color:#008900">.000</span>B3F30
</span></span><span style="display:flex;"><span>Destructing MyClass<span style="color:#008900">.000</span>B3F30
</span></span><span style="display:flex;"><span>Construction MyClass<span style="color:#008900">.000</span>B3F30
</span></span><span style="display:flex;"><span>Destructing MyClass<span style="color:#008900">.000</span>B3F30
</span></span><span style="display:flex;"><span>Construction MyClass<span style="color:#008900">.0023F</span>C60
</span></span><span style="display:flex;"><span>Destructing MyClass<span style="color:#008900">.0023F</span>C60
</span></span><span style="display:flex;"><span>The address of x[<span style="color:#008900">0</span>] <span style="color:#ec0000">is</span> : <span style="color:#008900">0023F</span>C60
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#include &lt;new&gt;
</span></span><span style="display:flex;"><span>#include &lt;iostream&gt;
</span></span><span style="display:flex;"><span><span style="color:#ec0000">using</span> <span style="color:#ec0000">namespace</span> std;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">class</span> <span style="color:#5f5fff">MyClass</span> {
</span></span><span style="display:flex;"><span><span style="color:#ec0000">public</span><span style="color:#ec0000">:</span>
</span></span><span style="display:flex;"><span>   MyClass() {
</span></span><span style="display:flex;"><span>      cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;Construction MyClass.&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#ec0000">this</span> <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>   };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">~</span>MyClass() {
</span></span><span style="display:flex;"><span>      imember <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>; cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;Destructing MyClass.&#34;</span> <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#ec0000">this</span> <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>   <span style="color:#5f5fff">int</span> imember;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span>() {
</span></span><span style="display:flex;"><span>   // The first form of new delete
</span></span><span style="display:flex;"><span>   MyClass<span style="color:#ec0000">*</span> fPtr <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> MyClass[<span style="color:#008900">2</span>];
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">delete</span>[ ] fPtr;
</span></span><span style="display:flex;"><span>   // The second form of new delete
</span></span><span style="display:flex;"><span>   <span style="color:#5f5fff">char</span> x[<span style="color:#008900">2</span> <span style="color:#ec0000">*</span> <span style="color:#ec0000">sizeof</span>( MyClass ) <span style="color:#ec0000">+</span> <span style="color:#ec0000">sizeof</span>(<span style="color:#5f5fff">int</span>)];
</span></span><span style="display:flex;"><span>   MyClass<span style="color:#ec0000">*</span> fPtr2 <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span>( <span style="color:#ec0000">&amp;</span>x[<span style="color:#008900">0</span>] ) MyClass[<span style="color:#008900">2</span>];
</span></span><span style="display:flex;"><span>   fPtr2[<span style="color:#008900">1</span>].<span style="color:#ec0000">~</span>MyClass();
</span></span><span style="display:flex;"><span>   fPtr2[<span style="color:#008900">0</span>].<span style="color:#ec0000">~</span>MyClass();
</span></span><span style="display:flex;"><span>   cout <span style="color:#ec0000">&lt;&lt;</span> <span style="color:#008900">&#34;The address of x[0] is : &#34;</span> <span style="color:#ec0000">&lt;&lt;</span> ( <span style="color:#5f5fff">void</span><span style="color:#ec0000">*</span> )<span style="color:#ec0000">&amp;</span>x[<span style="color:#008900">0</span>] <span style="color:#ec0000">&lt;&lt;</span> endl;
</span></span><span style="display:flex;"><span>   // The third form of new delete
</span></span><span style="display:flex;"><span>   MyClass<span style="color:#ec0000">*</span> fPtr3 <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span>( nothrow ) MyClass[<span style="color:#008900">2</span>];
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">delete</span>[ ] fPtr3;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Construction MyClass<span style="color:#008900">.00311</span>AEC
</span></span><span style="display:flex;"><span>Construction MyClass<span style="color:#008900">.00311</span>AF0
</span></span><span style="display:flex;"><span>Destructing MyClass<span style="color:#008900">.00311</span>AF0
</span></span><span style="display:flex;"><span>Destructing MyClass<span style="color:#008900">.00311</span>AEC
</span></span><span style="display:flex;"><span>Construction MyClass<span style="color:#008900">.0012F</span>ED4
</span></span><span style="display:flex;"><span>Construction MyClass<span style="color:#008900">.0012F</span>ED8
</span></span><span style="display:flex;"><span>Destructing MyClass<span style="color:#008900">.0012F</span>ED8
</span></span><span style="display:flex;"><span>Destructing MyClass<span style="color:#008900">.0012F</span>ED4
</span></span><span style="display:flex;"><span>The address of x[<span style="color:#008900">0</span>] <span style="color:#ec0000">is</span> : <span style="color:#008900">0012F</span>ED0
</span></span><span style="display:flex;"><span>Construction MyClass<span style="color:#008900">.00311</span>AEC
</span></span><span style="display:flex;"><span>Construction MyClass<span style="color:#008900">.00311</span>AF0
</span></span><span style="display:flex;"><span>Destructing MyClass<span style="color:#008900">.00311</span>AF0
</span></span><span style="display:flex;"><span>Destructing MyClass<span style="color:#008900">.00311</span>AEC
</span></span></code></pre></div><h2 id="探究第一种new形式实现">探究第一种new形式实现</h2>
<p>  第一种形式为常规new，<code>MyClass* fPtr1 = new MyClass;</code></p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// new.cpp
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>__CRTDECL <span style="color:#ec0000">operator</span> <span style="color:#5f5fff">new</span>(size_t size) _THROW1(_STD bad_alloc)
</span></span><span style="display:flex;"><span>{       // try to allocate size bytes
</span></span><span style="display:flex;"><span>	<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>p;
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">while</span> ((p <span style="color:#ec0000">=</span> malloc(size)) <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (_callnewh(size) <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>	{       // report no memory
</span></span><span style="display:flex;"><span>		_THROW_NCEE(_XSTD bad_alloc, );
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span> (p);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  从上面new函数实现可以看到是使用malloc函数进行分配，如果失败则调用_callnewh调用注册过的“new操作符失败回调”函数（注册用_set_new_handler），如果原先没注册new失败回调，则抛出bad_alloc异常，可见在默认情况下，该while只会执行1次，仅当自定义new失败回调函数返回true，才可能多次尝试分配。<br>
  该种形式delete实现方式，单步以后vs不能定位到源码，不过我们可以换一种思路，既然知道一定执行析构函数，那么就在析构中下断点，断下后查看反汇编，并执行到上一级调用即可找到delete实现方法，因此看汇编实现，发现是一个名为“scalar deleting destructor”的内部函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB3470  push        ebp 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB3471  mov         ebp,esp 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB3473  sub         esp,<span style="color:#008900">0</span>CCh  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB3479  push        ebx 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB347A  push        esi 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB347B  push        edi 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB347C  push        ecx 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB347D  lea         edi,[ebp<span style="color:#ec0000">-</span><span style="color:#008900">0</span>CCh]  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB3483  mov         ecx,<span style="color:#008900">33</span>h  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB3488  mov         eax,<span style="color:#008900">0</span>CCCCCCCCh  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB348D  rep stos    dword ptr <span style="color:#ec0000">es</span>:[edi]  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB348F  pop         ecx  //以上部分为debug版API常见头，无需理会
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB3490  mov         dword ptr [<span style="color:#ec0000">this</span>],ecx 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB3493  mov         ecx,dword ptr [<span style="color:#ec0000">this</span>]  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB3496  call        MyClass<span style="color:#ec0000">::~</span>MyClass (<span style="color:#008900">0</span>EB1023h)  //执行析构
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB349B  mov         eax,dword ptr [ebp<span style="color:#ec0000">+</span><span style="color:#008900">8</span>]  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB349E  and         eax,<span style="color:#008900">1</span>  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34A1  je          MyClass<span style="color:#ec0000">::</span><span style="color:#ec0000">`</span>scalar deleting destructor<span style="color:#ec0000">&#39;</span><span style="color:#ec0000">+</span><span style="color:#008900">3F</span>h (<span style="color:#008900">0</span>EB34AFh)  //如果传入参数允许释放则进行调用对应delete函数(对于定位new对应的delete该参数是设置为不允许的)
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34A3  mov         eax,dword ptr [<span style="color:#ec0000">this</span>]  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34A6  push        eax 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34A7  call        <span style="color:#ec0000">operator</span> <span style="color:#ec0000">delete</span> (<span style="color:#008900">0</span>EB1154h)  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34AC  add         esp,<span style="color:#008900">4</span>  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34AF  mov         eax,dword ptr [<span style="color:#ec0000">this</span>]  //以下是无关的收尾工作
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34B2  pop         edi 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34B3  pop         esi 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34B4  pop         ebx 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34B5  add         esp,<span style="color:#008900">0</span>CCh  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34BB  cmp         ebp,esp 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34BD  call        __RTC_CheckEsp (<span style="color:#008900">0</span>EB1352h)  
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34C2  mov         esp,ebp 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34C4  pop         ebp 
</span></span><span style="display:flex;"><span><span style="color:#008900">00</span>EB34C5  ret         <span style="color:#008900">4</span> 
</span></span></code></pre></div><p>  执行到call operator delete这行，步入之后转到源码，可以看到使用的是dbgdel.cpp的delete函数。实现如下</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// dbgdel.cpp
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">operator</span> <span style="color:#5f5fff">delete</span>( <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>pUserData )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	_CrtMemBlockHeader <span style="color:#ec0000">*</span> pHead;
</span></span><span style="display:flex;"><span>	RTCCALLBACK(_RTC_Free_hook, (pUserData, <span style="color:#008900">0</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">if</span> (pUserData <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>	_mlock(_HEAP_LOCK);  /* 阻塞其他线程*/
</span></span><span style="display:flex;"><span>	__TRY
</span></span><span style="display:flex;"><span>		/* 得到用于内存块信息头指针*/
</span></span><span style="display:flex;"><span>		pHead <span style="color:#ec0000">=</span> pHdr(pUserData);
</span></span><span style="display:flex;"><span>		/* 检查区块类型 */
</span></span><span style="display:flex;"><span>		_ASSERTE(_BLOCK_TYPE_IS_VALID(pHead<span style="color:#ec0000">-&gt;</span>nBlockUse));
</span></span><span style="display:flex;"><span>		_free_dbg( pUserData, pHead<span style="color:#ec0000">-&gt;</span>nBlockUse );//调用free函数释放内存
</span></span><span style="display:flex;"><span>	__FINALLY
</span></span><span style="display:flex;"><span>		_munlock(_HEAP_LOCK);  /* 解锁其他线程*/
</span></span><span style="display:flex;"><span>	__END_TRY_FINALLY
</span></span><span style="display:flex;"><span>	<span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="探究第二种new形式实现">探究第二种new形式实现</h2>
<p>  第二种方式为不抛出异常的new，<code>MyClass* fPtr2 = new( nothrow ) MyClass;</code>，可见，这里用try块捕获了异常，因此不再抛出异常，余下的就是调用常规new函数而已。</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// newopnt.cpp
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> __CRTDECL <span style="color:#ec0000">operator</span> <span style="color:#5f5fff">new</span>(size_t count, <span style="color:#ec0000">const</span> std<span style="color:#ec0000">::</span>nothrow_t<span style="color:#ec0000">&amp;</span>) _THROW0()
</span></span><span style="display:flex;"><span>{   // try to allocate count bytes
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>p;
</span></span><span style="display:flex;"><span>    _TRY_BEGIN
</span></span><span style="display:flex;"><span>    p <span style="color:#ec0000">=</span> <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(count);
</span></span><span style="display:flex;"><span>    _CATCH_ALL
</span></span><span style="display:flex;"><span>    p <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    _CATCH_END
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> (p);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>#define _TRY_BEGIN try {
</span></span><span style="display:flex;"><span>#define _CATCH(x)  } catch (x) {
</span></span><span style="display:flex;"><span>#define _CATCH_ALL } catch (...) {
</span></span><span style="display:flex;"><span>#define _CATCH_END }
</span></span></code></pre></div><h2 id="探究第三种new形式实现">探究第三种new形式实现</h2>
<p>  第三种方式为布局new：<br>
<code>char x1[sizeof( MyClass )];MyClass* fPtr3 = new( &amp;x1[0] ) MyClass;</code><br>
  这里所谓的布局就是说告诉new我们已经有一个内存位置了：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// new
</span></span><span style="display:flex;"><span><span style="color:#ec0000">inline</span> <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>__CRTDECL <span style="color:#ec0000">operator</span> <span style="color:#5f5fff">new</span>(size_t, <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>_Where) _THROW0()
</span></span><span style="display:flex;"><span>{   // construct array with placement at _Where
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> (_Where);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  可以发现该new什么都没做，那么为什么还要new呢？仔细想想可以知道，编译器对new的处理是调用new函数后，之后将该地址作为this指针进行初始化操作（比如设置虚表），再调用构造函数，而构造函数这玩意不能直接调用，不像析构函数那样，因为构造之前还没有对象和指针呢，对象和指针是构造以后才有的，而调用析构函数的时候，是已经有对象或指针的。所以这种定位new在我理解，就是可以相当于可以直接构造了。<br>
  从上面可以看到new操作符先调用合适的new函数分配空间，之后调用构造函数构造，而delete函数刚好相对，先进行析构之后调用析构函数析构；同时可以看到布局new操作符的好处是可以手动指定构造和析构的时间，对于new无论哪种形式，在调用new函数分配好内存后都会调用构造函数进行构造，而定位new函数实则是直接返回，这就导致直接使用当前地址进行构造，相当于显示调用构造函数,而析构时由于没有实际分配空间，因此不能用delete，而是显示调用析构函数进行析构。<br>
  上面都是对于有构造函数和析构函数对象的情况，用delete时，编译器会为该类专门生成一个scalar deleting destructor函数，该函数中先进行析构，之后调用operator delete函数。当然，如果没有析构函数，那么就不会有scalar deleting destructor函数了，此时单步是可以看到delete源码的，即dbgdel.cpp中的void operator delete(void *pUserData)函数。这一点在delete用于基本类型时显而易见。</p>
<h2 id="探究第一种new形式实现-1">探究第一种new[]形式实现</h2>
<p>  第一种类型new，<code>MyClass* fPtr4 = new MyClass[2]</code></p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// newaop.cpp
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>__CRTDECL <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>[](size_t count) _THROW1(std<span style="color:#ec0000">::</span>bad_alloc)
</span></span><span style="display:flex;"><span>{   // try to allocate count bytes for an array
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> (<span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(count));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  而编译器传给该new[]函数的参数count是sizeof(MyClass[2])+sizeof(int)，该sizeof(int)用于内存管理。new<a href=""></a>仍然调用了new();没有本质区别，即这么多对象占用的内存是当作整体分配的。再分配好之后，就需要对每个对象this指针处进行初始化和构造了。<br>
  通过逆向分析可知先调用了new[]，如果成功分配内存，则调用数组构造迭代器vector_constructor_iterator对每个对象进行构造。<code>void* base=new[](sizeof(int)+sizeof(MyClass[2]));</code>，起始4字节存储要初始化的对象个数，剩余空间为对象占用内存</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">0</span><span style="color:#008900">Ch</span>             ; count
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_</span><span style="color:#ec0000">??</span><span style="color:#008900">_U@YAPAXI@Z</span> ; operator new[](uint)
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_1A0</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_4</span>], <span style="color:#008900">3</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_1A0</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jz</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_41851B</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_1A0</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> [<span style="color:#008900">eax</span>], <span style="color:#008900">2</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">j_</span><span style="color:#ec0000">??</span><span style="color:#008900">1</span><span style="color:#008900">MyClass@@QAE@XZ</span> ; pDtor
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">j_</span><span style="color:#ec0000">??</span><span style="color:#008900">0</span><span style="color:#008900">MyClass@@QAE@XZ</span> ; pCtor
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">2</span>               ; count
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">4</span>               ; size
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_1A0</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ecx</span>             ; ptr
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_</span><span style="color:#ec0000">??</span><span style="color:#008900">_L@YGXPAXIHP6EX0@Z1@Z</span> ; `eh vector constructor iterator&#39;(void *,uint,int,void (*)(void *),void (*)(void *))
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_1A0</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">edx</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_22C</span>], <span style="color:#008900">edx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_418525</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_41851B:</span>                             ; CODE XREF: _main+1FF j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_22C</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_418525:</span>                             ; CODE XREF: _main+239 j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_22C</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_1AC</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_4</span>], <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFFh</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_1AC</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">fPtr4</span>], <span style="color:#008900">ecx</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ec0000">if</span>(base)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span><span style="color:#ec0000">*</span>)base<span style="color:#ec0000">=</span><span style="color:#008900">2</span>;//2个对象
</span></span><span style="display:flex;"><span>  vector_construtor_iterator((MyClass<span style="color:#ec0000">*</span>)((<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)base<span style="color:#ec0000">+</span><span style="color:#008900">4</span>),<span style="color:#ec0000">sizeof</span>(MyClass[<span style="color:#008900">2</span>]),<span style="color:#008900">2</span>,<span style="color:#ec0000">&amp;</span>MyClass<span style="color:#ec0000">::</span>MyClass,<span style="color:#ec0000">&amp;</span>MyClass<span style="color:#ec0000">::~</span>MyClass);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>vector_constructor_iterator对应代码为：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span> ; void __stdcall `eh vector constructor iterator&#39;(void *ptr, unsigned int size, int count, void (__thiscall *pCtor)(void *), void (__thiscall *pDtor)(void *))
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">??</span><span style="color:#5f5fff">_L@YGXPAXIHP6EX0@Z1@Z</span> <span style="color:#008900">proc</span> <span style="color:#008900">near</span>       ; CODE XREF: `eh vector constructor iterator&#39;(void *,uint,int,void (*)(void *),void (*)(void *)) j
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#5f5fff">success</span>         <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">20</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span> <span style="color:#5f5fff">i</span>               <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">1</span><span style="color:#008900">Ch</span>
</span></span><span style="display:flex;"><span> <span style="color:#5f5fff">ms_exc</span>          <span style="color:#ec0000">=</span> <span style="color:#008900">CPPEH_RECORD</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">18</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span> <span style="color:#5f5fff">ptr</span>             <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span>  <span style="color:#008900">8</span>
</span></span><span style="display:flex;"><span> <span style="color:#5f5fff">size</span>            <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span>  <span style="color:#008900">0</span><span style="color:#008900">Ch</span>
</span></span><span style="display:flex;"><span> <span style="color:#5f5fff">count</span>           <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span>  <span style="color:#008900">10</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span> <span style="color:#5f5fff">pCtor</span>           <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span>  <span style="color:#008900">14</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span> <span style="color:#5f5fff">pDtor</span>           <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span>  <span style="color:#008900">18</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ebp</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFEh</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">stru_41F9A0</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">j___except_handler4</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">0</span><span style="color:#008900">FFFFFFF0h</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">___security_cookie</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">xor</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.ScopeTable</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">xor</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">lea</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>, <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">success</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.TryLevel</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">i</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_415730</span>
</span></span><span style="display:flex;"><span> ; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_415727:</span>                             ; CODE XREF: `eh vector constructor iterator&#39;(void *,uint,int,void (*)(void *),void (*)(void *))+67 j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">i</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">add</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">1</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">i</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_415730:</span>                             ; CODE XREF: `eh vector constructor iterator&#39;(void *,uint,int,void (*)(void *),void (*)(void *))+45 j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">i</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">cmp</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">count</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jge</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_415749</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">call</span>    [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pCtor</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">add</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>], <span style="color:#008900">edx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_415727</span>
</span></span><span style="display:flex;"><span> ; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_415749:</span>                             ; CODE XREF: `eh vector constructor iterator&#39;(void *,uint,int,void (*)(void *),void (*)(void *))+56 j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">success</span>], <span style="color:#008900">1</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.TryLevel</span>], <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFEh</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">call</span>    <span style="color:#008900">$LN9</span>            ; Finally handler 0 for function 4156E0
</span></span><span style="display:flex;"><span> ; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_41575C:</span>                             ; CODE XREF: `eh vector constructor iterator&#39;(void *,uint,int,void (*)(void *),void (*)(void *)):$LN10 j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">$LN12</span>
</span></span><span style="display:flex;"><span> ; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">$LN9:</span>                                   ; CODE XREF: `eh vector constructor iterator&#39;(void *,uint,int,void (*)(void *),void (*)(void *))+77 j
</span></span><span style="display:flex;"><span>                                         ; DATA XREF: .rdata:stru_41F9A0 o
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">cmp</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">success</span>], <span style="color:#008900">0</span> ; Finally handler 0 for function 4156E0
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jnz</span>     <span style="color:#008900">short</span> <span style="color:#008900">$LN10</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pDtor</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>             ; pDtor
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">i</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">ecx</span>             ; count
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">edx</span>             ; size
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>             ; ptr
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_</span><span style="color:#ec0000">?</span><span style="color:#008900">__ArrayUnwind@@YGXPAXIHP6EX0@Z@Z</span> ; __ArrayUnwind(void *,uint,int,void (*)(void *))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">$LN10:</span>                                  ; CODE XREF: `eh vector constructor iterator&#39;(void *,uint,int,void (*)(void *),void (*)(void *))+82 j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">retn</span>
</span></span><span style="display:flex;"><span> ; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">$LN12:</span>                                  ; CODE XREF: `eh vector constructor iterator&#39;(void *,uint,int,void (*)(void *),void (*)(void *)):loc_41575C j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.Next</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>, <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">retn</span>    <span style="color:#008900">14</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">??</span><span style="color:#5f5fff">_L@YGXPAXIHP6EX0@Z1@Z</span> <span style="color:#008900">endp</span>
</span></span></code></pre></div><p>逆向分析得到C++语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">vector_constructor_iterator</span>(MyClass <span style="color:#ec0000">*</span>objs, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> size, <span style="color:#5f5fff">int</span> count, <span style="color:#5f5fff">void</span> (__thiscall <span style="color:#ec0000">*</span>pCtor)(<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>), <span style="color:#5f5fff">void</span> (__thiscall <span style="color:#ec0000">*</span>pDtor)(<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">__try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span>(;i<span style="color:#ec0000">&lt;</span>count;i<span style="color:#ec0000">++</span>,objs<span style="color:#ec0000">++</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            objs<span style="color:#ec0000">-&gt;</span>pCtor();//用构造函数构造
</span></span><span style="display:flex;"><span>        }       
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">__except</span>(<span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        __ArrayUnwind(objs,size,i,pDtor);//如果某个构造函数产生异常，则进行栈解退，用到析构函数 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  栈解退，这里引用C++ Primer Plus的解释：“现在假设函数由于出现异常而终止（而不是由于返回），则程序也将释放栈中的内存，但不会在释放栈的第一个返回地址后停止，而是继续释放栈，直到找到一个位于try块中的返回地址，随后控制权将转到块尾的异常处理程序，而不会函数调用后面的第一条语句。这个过程称为栈解退，引发机制的一个非常重要的特性是，和函数返回一样，对于栈中的自动类对象，而throw语句则处理try块和throw之间的整个函数调用徐丽放在栈中的对象。如果没有栈解退这种特性，则引发异常后，对于中间函数调用放在栈中的自动类对象，其析构函数将不会被调用。”。unwind就是解退的意思，现在来查看__ArrayUnwind的源码，根据函数名可知该函数用于对象数组解退：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ebp</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFEh</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">stru_41F9E0</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">j___except_handler4</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">sub</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">8</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">___security_cookie</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">xor</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.ScopeTable</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">xor</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">lea</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>, <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.old_esp</span>], <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.TryLevel</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_41591A:</span>                             ; CODE XREF: __ArrayUnwind(void *,uint,int,void (*)(void *))+54 j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">count</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">sub</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">1</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">count</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">js</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_415936</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">sub</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>], <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">call</span>    [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pDtor</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_41591A</span>
</span></span><span style="display:flex;"><span> ; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_415936:</span>                             ; CODE XREF: __ArrayUnwind(void *,uint,int,void (*)(void *))+43 j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.TryLevel</span>], <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFEh</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_415956</span>
</span></span><span style="display:flex;"><span> ; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">$LN7:</span>                                   ; DATA XREF: .rdata:stru_41F9E0 o
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.exc_ptr</span>] ; Exception filter 0 for function 4158E0
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">edx</span>             ; pExPtrs
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">call</span>    <span style="color:#008900">ArrayUnwindFilter</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">$LN9_1:</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">retn</span>
</span></span><span style="display:flex;"><span> ; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">$LN8_0:</span>                                 ; DATA XREF: .rdata:stru_41F9E0 o
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esp</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.old_esp</span>] ; Exception handler 0 for function 4158E0
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.TryLevel</span>], <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFEh</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_415956:</span>                             ; CODE XREF: __ArrayUnwind(void *,uint,int,void (*)(void *))+5D j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.Next</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>, <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">retn</span>    <span style="color:#008900">10</span><span style="color:#008900">h</span>
</span></span></code></pre></div><p>逆向分析得到C++代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">__ArrayUnwind</span>(MyClass<span style="color:#ec0000">*</span> objs,<span style="color:#5f5fff">unsigned</span> size,<span style="color:#5f5fff">int</span> count,<span style="color:#5f5fff">void</span> (__thiscall <span style="color:#ec0000">*</span>pDtor)(<span style="color:#5f5fff">void</span><span style="color:#ec0000">*</span>))
</span></span><span style="display:flex;"><span>{//第[count]对象由于没有构造成功，因此从[count-1]个对象开始析构
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">__try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">while</span>(count<span style="color:#ec0000">--</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>           objs<span style="color:#ec0000">--</span>;
</span></span><span style="display:flex;"><span>           objs<span style="color:#ec0000">-&gt;</span>pDtor();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">__except</span>(terminate(),<span style="color:#008900">0</span>)//如果析构发生异常，则终止程序
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="探究第一种形式delete形式实现">探究第一种形式delete[]形式实现</h2>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">fPtr4</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_188</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_188</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_194</span>], <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_194</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jz</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_418574</span>//如果之前new成功，则往下执行
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">3</span>               ; unsigned int
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_194</span>] ; this
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_</span><span style="color:#ec0000">??</span><span style="color:#008900">_EMyClass@@QAEPAXI@Z</span> ; MyClass::`vector deleting destructor&#39;(uint)
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_22C</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_41857E</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_418574:</span>                             ; CODE XREF: _main+27D j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_22C</span>], <span style="color:#008900">0</span>
</span></span></code></pre></div><p>  可见vector_deleting_destructor是用来析构对象数组的，原型为<code>void* __thiscall MyClass::vector_deleting_destructor(usigned int flag);</code>，该函数是编译器内部为MyClass类加的成员函数
flag含义未知，所以需要分析该函数源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ebp</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">sub</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">0</span><span style="color:#008900">CCh</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">lea</span>     <span style="color:#008900">edi</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_CC</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">33</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">0</span><span style="color:#008900">CCCCCCCCh</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">rep</span> <span style="color:#5f5fff">stosd</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">this</span>], <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">arg_0</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">and</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">2</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jz</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_413431</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">j_</span><span style="color:#ec0000">??</span><span style="color:#008900">1</span><span style="color:#008900">MyClass@@QAE@XZ</span> ; pDtor
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">this</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">eax-4</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">ecx</span>             ; count
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">4</span>               ; size
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">this</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">edx</span>             ; ptr
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_</span><span style="color:#ec0000">??</span><span style="color:#008900">_M@YGXPAXIHP6EX0@Z@Z</span> ; `eh vector destructor iterator&#39;(void *,uint,int,void (*)(void *))
</span></span><span style="display:flex;"><span> ; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">arg_0</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">and</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">1</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jz</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_413429</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">this</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">sub</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>             ; void *
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_</span><span style="color:#ec0000">??</span><span style="color:#008900">_V@YAXPAX@Z_0</span> ; operator delete[](void *)
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_413429:</span>                             ; CODE XREF: MyClass::`vector deleting destructor&#39;(uint)+48 j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">this</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">sub</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_413450</span>
</span></span><span style="display:flex;"><span> ; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_413431:</span>                             ; CODE XREF: MyClass::`vector deleting destructor&#39;(uint)+29 j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">this</span>] ; this
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_</span><span style="color:#ec0000">??</span><span style="color:#008900">1</span><span style="color:#008900">MyClass@@QAE@XZ</span> ; MyClass::~MyClass(void)
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">arg_0</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">and</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">1</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">jz</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_41344D</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">this</span>]
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>             ; void *
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_</span><span style="color:#ec0000">??</span><span style="color:#008900">3</span><span style="color:#ec0000">@</span><span style="color:#008900">YAXPAX@Z_0</span> ; operator delete(void *)
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_41344D:</span>                             ; CODE XREF: MyClass::`vector deleting destructor&#39;(uint)+6F j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">this</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ec0000">loc_413450:</span>                             ; CODE XREF: MyClass::`vector deleting destructor&#39;(uint)+5F j
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">0</span><span style="color:#008900">CCh</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">cmp</span>     <span style="color:#008900">ebp</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">call</span>    <span style="color:#008900">j___RTC_CheckEsp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#5f5fff">retn</span>    <span style="color:#008900">4</span>
</span></span></code></pre></div><p>经过逆向分析得到C++代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span><span style="color:#ec0000">*</span> __thiscall MyClass<span style="color:#ec0000">::</span>vector_deleting_destructor(usigned <span style="color:#5f5fff">int</span> flag)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span>(flag<span style="color:#ec0000">&amp;</span><span style="color:#008900">2</span>)//由于push的是3，因此这里成立
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>         vector_destructor_iterator(<span style="color:#ec0000">this</span>,<span style="color:#ec0000">sizeof</span>(MyClass),<span style="color:#ec0000">*</span>(<span style="color:#5f5fff">int</span><span style="color:#ec0000">*</span>)((<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)<span style="color:#ec0000">this</span><span style="color:#ec0000">-</span><span style="color:#008900">4</span>),MyClass<span style="color:#ec0000">::~</span>MyClass);
</span></span><span style="display:flex;"><span>         <span style="color:#ec0000">if</span>(flag<span style="color:#ec0000">&amp;</span><span style="color:#008900">1</span>))//由于push的是3，因此这里成立
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">delete</span>[]((<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)<span style="color:#ec0000">this</span><span style="color:#ec0000">-</span><span style="color:#008900">4</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>         <span style="color:#ec0000">this</span><span style="color:#ec0000">-&gt;~</span>MyClass();
</span></span><span style="display:flex;"><span>         <span style="color:#ec0000">if</span>(flag<span style="color:#ec0000">&amp;</span><span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>         {
</span></span><span style="display:flex;"><span>          <span style="color:#ec0000">delete</span>(<span style="color:#ec0000">this</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>仅从以上代码可以分析出以下几点：</p>
<ul>
<li>1.this-4这个地址为之前new<a href=""></a>成功分配所返回值，可以将其看成sizeof(int)+sizeof(MyClass[2])大小的结构体，第一个成员为对象个数。</li>
<li>2.该函数对数组和非数组进行了分别处理，可以分析出第2个二进制位为1时，是析构对象数组，为0时是析构普通对象。而第1个二进制位是规定是否释放内存，可以想象如果这里是定位new，那么这里是不应该释放的。</li>
<li>3.vector_destructor_iterator起实际析构作用原型<code> void __stdcall vector_destructor_iterator(MyClass *objs, unsigned int size, int count, void (__thiscall *pDtor)(void *));</code>，下面来看该函数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ebp</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFEh</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">stru_41F9C0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">j___except_handler4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">0</span><span style="color:#008900">FFFFFFF4h</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">___security_cookie</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">xor</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.ScopeTable</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">xor</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">lea</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>, <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">success</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">imul</span>    <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">count</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.TryLevel</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_41580B:</span>                             ; CODE XREF: `eh vector destructor iterator&#39;(void *,uint,int,void (*)(void *))+65 j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">count</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">sub</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">count</span>], <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">js</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_415827</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">sub</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>], <span style="color:#008900">edx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pDtor</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_41580B</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_415827:</span>                             ; CODE XREF: `eh vector destructor iterator&#39;(void *,uint,int,void (*)(void *))+54 j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">success</span>], <span style="color:#008900">1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.TryLevel</span>], <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFEh</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">$LN8</span>            ; Finally handler 0 for function 4157C0
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_41583A:</span>                             ; CODE XREF: `eh vector destructor iterator&#39;(void *,uint,int,void (*)(void *)):$LN9_0 j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">$LN11</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">$LN8:</span>                                   ; CODE XREF: `eh vector destructor iterator&#39;(void *,uint,int,void (*)(void *))+75 j
</span></span><span style="display:flex;"><span>                                        ; DATA XREF: .rdata:stru_41F9C0 o
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">success</span>], <span style="color:#008900">0</span> ; Finally handler 0 for function 4157C0
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jnz</span>     <span style="color:#008900">short</span> <span style="color:#008900">$LN9_0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pDtor</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>             ; pDtor
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">count</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ecx</span>             ; count
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">edx</span>             ; size
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ptr</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>             ; ptr
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_</span><span style="color:#ec0000">?</span><span style="color:#008900">__ArrayUnwind@@YGXPAXIHP6EX0@Z@Z</span> ; __ArrayUnwind(void *,uint,int,void (*)(void *))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">$LN9_0:</span>                                 ; CODE XREF: `eh vector destructor iterator&#39;(void *,uint,int,void (*)(void *))+80 j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">retn</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">$LN11:</span>                                  ; CODE XREF: `eh vector destructor iterator&#39;(void *,uint,int,void (*)(void *)):loc_41583A j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.Next</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>, <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">retn</span>    <span style="color:#008900">10</span><span style="color:#008900">h</span>
</span></span></code></pre></div><p>经过逆向分析得到C++代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">__stdcall</span> <span style="color:#5f5fff">vector_destructor_iterator</span>(MyClass <span style="color:#ec0000">*</span>objs, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> size, <span style="color:#5f5fff">int</span> count, <span style="color:#5f5fff">void</span> (__thiscall <span style="color:#ec0000">*</span>pDtor)(<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> i<span style="color:#ec0000">=</span><span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">__try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        MyClass<span style="color:#ec0000">*</span> last<span style="color:#ec0000">=</span>objs<span style="color:#ec0000">+</span>size<span style="color:#ec0000">-</span><span style="color:#008900">1</span>;//从最后一个对象开始析构
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">while</span>(count<span style="color:#ec0000">--</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>           last<span style="color:#ec0000">-&gt;</span>pDtor();
</span></span><span style="display:flex;"><span>           last<span style="color:#ec0000">--</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">__except</span>(<span style="color:#008900">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        __ArrayUnwind(objs,size,count,pDtor);//如果某个析构函数产生异常，则跳过该对象，继续析构之前的对象 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  鉴于__ArrayUnwind前面已经介绍过，这里就不分析了。如果仔细分析上一节开头给出main汇编代码，会发现只要new成功了，delete都会去执行析构，即使出现对象数组中某个对象构造失败导致已经进行析构，delete时所有元素仍会析构一次。</p>
<h2 id="探究第二种情况new形式实现">探究第二种情况new[]形式实现</h2>
<p><code>MyClass* fPtr5 = new( nothrow ) MyClass[2];</code></p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// newaopnt.cpp
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> __CRTDECL <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>[](<span style="color:#ec0000">::</span>size_t count, <span style="color:#ec0000">const</span> std<span style="color:#ec0000">::</span>nothrow_t<span style="color:#ec0000">&amp;</span> x)
</span></span><span style="display:flex;"><span>    _THROW0()
</span></span><span style="display:flex;"><span>    {   // try to allocate count bytes for an array
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> (<span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>(count, x));
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>可见调用了单对象的第二种new形式，与非数组形式类似，不再赘述</p>
<h2 id="探究第三种情况new形式实现">探究第三种情况new[]形式实现</h2>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">char</span> x2[<span style="color:#008900">2</span><span style="color:#ec0000">*</span><span style="color:#ec0000">sizeof</span>( MyClass ) <span style="color:#ec0000">+</span> <span style="color:#ec0000">sizeof</span>(<span style="color:#5f5fff">int</span>)];
</span></span><span style="display:flex;"><span>MyClass<span style="color:#ec0000">*</span> fPtr6 <span style="color:#ec0000">=</span> <span style="color:#ec0000">new</span> ( <span style="color:#ec0000">&amp;</span>x2[<span style="color:#008900">0</span>] ) MyClass[<span style="color:#008900">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">inline</span> <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>__CRTDECL <span style="color:#ec0000">operator</span> <span style="color:#ec0000">new</span>[](size_t, <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>_Where) _THROW0()
</span></span><span style="display:flex;"><span>{   // construct array with placement at _Where
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> (_Where);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  可见等同于对象第三种new形式，不再赘述。下面我们来看看其他内存分配函数</p>
<h2 id="malloca">malloca</h2>
<p><code>void* _malloca(size_t size);</code>
  MSDN里是这么描述的：在栈上分配内存，是_alloca的安全性增强版本。返回指针是根据对象大小对齐，如果size是0则返回长度0的合法指针。如果地址空间无法分配会抛出一个栈溢出异常，该异常不是C++异常，需要使用SEH。_malloca和_alloca的区别在于_alloc无论大小总是在栈上分配，且无需free释放内存。而_malloca需要使用_freea释放内存，在调试模式下,_malloca总是在堆上分配。在异常处理时显式调用_malloca有一些限制，x86架构处理器异常处理例程会自动控制函数栈帧，在执行操作时并不基于当前闭合函数栈帧，这一点在Windows NT SEH和C++异常处理的catch语句中很常见。因此在以下情况显示调用_malloca，在执行异常处理例程后会产生程序崩溃。<br>
  Windows NT SEH异常过滤表达式：__except(_malloca())<br>
  Windows NT SEH最终执行表达式：__finally(_malloca())<br>
  C++ 异常处理 catch语句<br>
  然而_malloca可以从异常处理例程中除上述情况以外的情况下直接调用，或在异常处理所触发的回调函数中调用也是允许的。先来看一个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>#include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;malloc.h&gt;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span>     size;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span>     numberRead <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span>     errcode <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span>    <span style="color:#ec0000">*</span>p <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span>    <span style="color:#ec0000">*</span>pMarker <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">while</span> (numberRead <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        printf_s(<span style="color:#008900">&#34;Enter the number of bytes to allocate &#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#008900">&#34;using _malloca: &#34;</span>);
</span></span><span style="display:flex;"><span>        numberRead <span style="color:#ec0000">=</span> scanf_s(<span style="color:#008900">&#34;%d&#34;</span>, <span style="color:#ec0000">&amp;</span>size);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    // Do not use try/catch for _malloca,
</span></span><span style="display:flex;"><span>    // use __try/__except, since _malloca throws
</span></span><span style="display:flex;"><span>    // Structured Exceptions, not C++ exceptions.
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">__try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (size <span style="color:#ec0000">&gt;</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            p <span style="color:#ec0000">=</span>  _malloca( size );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            printf_s(<span style="color:#008900">&#34;Size must be a positive number.&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        _freea( p );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    // Catch any exceptions that may occur.
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">__except</span>( GetExceptionCode() <span style="color:#ec0000">==</span> STATUS_STACK_OVERFLOW )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        printf_s(<span style="color:#008900">&#34;_malloca failed!</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        // If the stack overflows, use this function to restore.
</span></span><span style="display:flex;"><span>        errcode <span style="color:#ec0000">=</span> _resetstkoflw();
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (errcode)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#008900">&#34;Could not reset the stack!&#34;</span>);
</span></span><span style="display:flex;"><span>            _exit(<span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// malloc.h
</span></span><span style="display:flex;"><span>#define _ALLOCA_S_THRESHOLD     1024
</span></span><span style="display:flex;"><span>#define _ALLOCA_S_STACK_MARKER  0xCCCC
</span></span><span style="display:flex;"><span>#define _ALLOCA_S_HEAP_MARKER   0xDDDD
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>#if defined(_M_IX86)
</span></span><span style="display:flex;"><span>#define _ALLOCA_S_MARKER_SIZE   8
</span></span><span style="display:flex;"><span>#elif defined(_M_X64)
</span></span><span style="display:flex;"><span>#define _ALLOCA_S_MARKER_SIZE   16
</span></span><span style="display:flex;"><span>#elif defined(_M_ARM)
</span></span><span style="display:flex;"><span>#define _ALLOCA_S_MARKER_SIZE   8
</span></span><span style="display:flex;"><span>#elif !defined (RC_INVOKED)
</span></span><span style="display:flex;"><span>#error Unsupported target platform.
</span></span><span style="display:flex;"><span>#endif
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>#if !defined(__midl) &amp;&amp; !defined(RC_INVOKED)
</span></span><span style="display:flex;"><span>#pragma warning(push)
</span></span><span style="display:flex;"><span>#pragma warning(disable:6540)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">__inline</span> <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>_MarkAllocaS(_Out_opt_ __crt_typefix(<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span><span style="color:#ec0000">*</span>) <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>_Ptr, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> _Marker)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (_Ptr)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">*</span>((<span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span><span style="color:#ec0000">*</span>)_Ptr) <span style="color:#ec0000">=</span> _Marker;
</span></span><span style="display:flex;"><span>        _Ptr <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">char</span><span style="color:#ec0000">*</span>)_Ptr <span style="color:#ec0000">+</span> _ALLOCA_S_MARKER_SIZE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> _Ptr;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>#pragma warning(pop)
</span></span><span style="display:flex;"><span>#endif
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>#if defined(_DEBUG)
</span></span><span style="display:flex;"><span>#if !defined(_CRTDBG_MAP_ALLOC)
</span></span><span style="display:flex;"><span>#undef _malloca
</span></span><span style="display:flex;"><span>#define _malloca(size) \
</span></span><span style="display:flex;"><span>__pragma(warning(suppress: 6255)) \
</span></span><span style="display:flex;"><span>        _MarkAllocaS(malloc((size) + _ALLOCA_S_MARKER_SIZE), _ALLOCA_S_HEAP_MARKER)
</span></span><span style="display:flex;"><span>#endif
</span></span><span style="display:flex;"><span>#else
</span></span><span style="display:flex;"><span>#undef _malloca
</span></span><span style="display:flex;"><span>#define _malloca(size) \
</span></span><span style="display:flex;"><span>__pragma(warning(suppress: 6255)) \
</span></span><span style="display:flex;"><span>    ((((size) + _ALLOCA_S_MARKER_SIZE) &lt;= _ALLOCA_S_THRESHOLD) ? \
</span></span><span style="display:flex;"><span>        _MarkAllocaS(_alloca((size) + _ALLOCA_S_MARKER_SIZE), _ALLOCA_S_STACK_MARKER) : \
</span></span><span style="display:flex;"><span>        _MarkAllocaS(malloc((size) + _ALLOCA_S_MARKER_SIZE), _ALLOCA_S_HEAP_MARKER))
</span></span><span style="display:flex;"><span>#endif
</span></span></code></pre></div><p>  可以分析出DEBUG版下，宏调用了malloc进行分配，之后使用_MarkAllocaS对分配内存进行一些处理（后面讨论），而RELEASE版下，宏先判断要分配的内存是否过大，该门限为_ALLOCA_S_THRESHOLD-_ALLOCA_S_MARKER_SIZE=1016，如果超过该值则调用malloc，否则调用_alloca。从字面意思上可以知道_ALLOCA_S_HEAP_MARKER这个标志位说明该内存区是在堆上分配的，而_ALLOCA_S_STACK_MARKER标志是在栈上分配的。在malloc或_alloca分配成功后，总会调用_MarkAllocaS进行调整。结合字面意思和5行C语言代码可知，在执行过内存分配后，返回的指针前sizeof(unigned int*)字节为分配内存类型标志，之后指针调整到空闲位置丢给用户操作。那么所有的问题都落在_alloca和malloc的源码上，下面会进行分析。<br>
  _alloca（我第一次见栈上分配内存是在逆向一个易语言程序时，用的是sub esp，而微软这个函数是第一次见）<code>void* _alloca(size_t size);</code>，该函数只在程序栈中分配字节，而函数退出时该空间会自动释放，因此无需手动释放。用此函数的限制和_malloca相同。</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>#include &lt;windows.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;malloc.h&gt;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span>     size <span style="color:#ec0000">=</span> <span style="color:#008900">1000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span>     errcode <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span>    <span style="color:#ec0000">*</span>pData <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    // 注意：不要使用try/catch，而要使用__try/__except，因为_alloca抛出SEH而不是C++异常
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">__try</span> {
</span></span><span style="display:flex;"><span>        // 使用_alloca分配太大的空间很容易崩溃，推荐1024字节以下的空间  
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (size <span style="color:#ec0000">&gt;</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> size <span style="color:#ec0000">&lt;</span> <span style="color:#008900">1024</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            pData <span style="color:#ec0000">=</span> _alloca( size );
</span></span><span style="display:flex;"><span>            printf_s( <span style="color:#008900">&#34;Allocated %d bytes of stack at 0x%p&#34;</span>,
</span></span><span style="display:flex;"><span>                      size, pData);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            printf_s(<span style="color:#008900">&#34;Tried to allocate too many bytes.</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    // 如果溢出
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">__except</span>( GetExceptionCode() <span style="color:#ec0000">==</span> STATUS_STACK_OVERFLOW )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        printf_s(<span style="color:#008900">&#34;_alloca failed!</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        // 使用下面的函数恢复函数栈
</span></span><span style="display:flex;"><span>        errcode <span style="color:#ec0000">=</span> _resetstkoflw();
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (errcode)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            printf_s(<span style="color:#008900">&#34;Could not reset the stack!</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>);
</span></span><span style="display:flex;"><span>            _exit(<span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>来看反汇编</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span>; int __cdecl main()
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">_main</span>           <span style="color:#008900">proc</span> <span style="color:#008900">near</span>               ; CODE XREF: j__main j
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">pAllocaBase</span>     <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">120</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">cbSize</span>          <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">11</span><span style="color:#008900">Ch</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">var_114</span>         <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">114</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">allocaList</span>      <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">48</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">pData</span>           <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">3</span><span style="color:#008900">Ch</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">errcode</span>         <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">30</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">size</span>            <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">24</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">var_1C</span>          <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">1</span><span style="color:#008900">Ch</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">ms_exc</span>          <span style="color:#ec0000">=</span> <span style="color:#008900">CPPEH_RECORD</span> <span style="color:#008900">ptr</span> -<span style="color:#008900">18</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ebp</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFEh</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">stru_416F80</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">j___except_handler4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">0</span><span style="color:#008900">FFFFFEF0h</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">lea</span>     <span style="color:#008900">edi</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pAllocaBase</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">42</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">0</span><span style="color:#008900">CCCCCCCCh</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">rep</span> <span style="color:#5f5fff">stosd</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">___security_cookie</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">xor</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.ScopeTable</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">xor</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_1C</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">lea</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>, <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.old_esp</span>], <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">allocaList</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>], <span style="color:#008900">3</span><span style="color:#008900">E8h</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">errcode</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pData</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.TryLevel</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jle</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_4114D3</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>], <span style="color:#008900">400</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jge</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_4114D3</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">24</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">cbSize</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">cbSize</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j___alloca_probe_16</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pAllocaBase</span>], <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.old_esp</span>], <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">lea</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">allocaList</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ecx</span>             ; pAllocaInfoList
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">cbSize</span>] ; cbSize
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pAllocaBase</span>] ; pAllocaBase
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_@_RTC_AllocaHelper@12</span> ; _RTC_AllocaHelper(x,x,x)
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pAllocaBase</span>], <span style="color:#008900">20</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pAllocaBase</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pData</span>], <span style="color:#008900">edx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pData</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">Format</span>   ; &#34;Allocated %d bytes of stack at 0x%p&#34;
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">ds</span>:<span style="color:#008900">__imp__printf_s</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">0</span><span style="color:#008900">Ch</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j___RTC_CheckEsp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_4114EA</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_4114D3:</span>                             ; CODE XREF: _main+72 j
</span></span><span style="display:flex;"><span>                                        ; _main+7B j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">aTriedToAllocat</span> ; &#34;Tried to allocate too many bytes.\n&#34;
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">ds</span>:<span style="color:#008900">__imp__printf_s</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j___RTC_CheckEsp</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_4114EA:</span>                             ; CODE XREF: _main+E1 j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.TryLevel</span>], <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFEh</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">loc_41158D</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">$LN10:</span>                                  ; DATA XREF: .rdata:stru_416F80 o
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.exc_ptr</span>] ; Exception filter 0 for function 4113F0
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">eax</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ecx</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_114</span>], <span style="color:#008900">edx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_114</span>], <span style="color:#008900">0</span><span style="color:#008900">C00000FDh</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jnz</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_41151B</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">cbSize</span>], <span style="color:#008900">1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_411525</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_41151B:</span>                             ; CODE XREF: _main+11D j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">cbSize</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_411525:</span>                             ; CODE XREF: _main+129 j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">cbSize</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">$LN12:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">retn</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">$LN11:</span>                                  ; DATA XREF: .rdata:stru_416F80 o
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esp</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.old_esp</span>] ; Exception handler 0 for function 4113F0
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">a_allocaFailed</span> ; &#34;_alloca failed!\n&#34;
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">ds</span>:<span style="color:#008900">__imp__printf_s</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j___RTC_CheckEsp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">ds</span>:<span style="color:#008900">__imp___resetstkoflw</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j___RTC_CheckEsp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">errcode</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">errcode</span>], <span style="color:#008900">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jz</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_411586</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">offset</span> <span style="color:#008900">aCouldNotResetT</span> ; &#34;Could not reset the stack!\n&#34;
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">ds</span>:<span style="color:#008900">__imp__printf_s</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j___RTC_CheckEsp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">1</span>               ; Code
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">ds</span>:<span style="color:#008900">__imp___exit</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">cmp</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j___RTC_CheckEsp</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_411586:</span>                             ; CODE XREF: _main+16C j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.TryLevel</span>], <span style="color:#008900">0</span><span style="color:#008900">FFFFFFFEh</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_41158D:</span>                             ; CODE XREF: _main+101 j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_411591</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">loc_411593</span>
</span></span><span style="display:flex;"><span>; ---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_411591:</span>                             ; CODE XREF: _main:loc_41158D j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">xor</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_411593:</span>                             ; CODE XREF: _main+19F j
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">edx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">ebp</span>        ; frame
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">lea</span>     <span style="color:#008900">edx</span>, <span style="color:#008900">v</span>          ; v
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">allocaList</span>] ; allocaList
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_@_RTC_CheckStackVars2@12</span> ; _RTC_CheckStackVars2(x,x,x)
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">edx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">lea</span>     <span style="color:#008900">esp</span>, [<span style="color:#008900">ebp-130h</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.registration.Next</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">large</span> <span style="color:#008900">fs</span>:<span style="color:#008900">0</span>, <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">var_1C</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">xor</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">ebp</span>        ; cookie
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_@__security_check_cookie@4</span> ; __security_check_cookie(x)
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esp</span>, <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">retn</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">size</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">24</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">cbSize</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">cbSize</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j___alloca_probe_16</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pAllocaBase</span>], <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">ms_exc.old_esp</span>], <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">lea</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">allocaList</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ecx</span>             ; pAllocaInfoList
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">cbSize</span>] ; cbSize
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pAllocaBase</span>] ; pAllocaBase
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">call</span>    <span style="color:#008900">j_@_RTC_AllocaHelper@12</span> ; _RTC_AllocaHelper(x,x,x)
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">add</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pAllocaBase</span>], <span style="color:#008900">20</span><span style="color:#008900">h</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edx</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pAllocaBase</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pData</span>], <span style="color:#008900">edx</span>
</span></span></code></pre></div><p>  很疑惑地，在__alloca_probe_16调用之前，发生了add eax,24h和mov eax,[ebp+cbSize]，而在之后发生了mov [ebp+pAllocaBase], esp，那么大胆做出猜测：</p>
<ul>
<li>1.add eax,24h，说明这24h字节用来实现内存管理或字节对齐之类功能</li>
<li>2.__alloca_probe_16为接受一个参数的函数，该参数通过eax传递，进行的操作是修改esp，因此esp可以看做执行结果</li>
<li>3.另一个函数原型为<code>void __fastcall _RTC_AllocaHelper(_RTC_ALLOCA_NODE *pAllocaBase, unsigned int cbSize, _RTC_ALLOCA_NODE **pAllocaInfoList)</code>，反汇编得到</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span>; void __fastcall _RTC_AllocaHelper(_RTC_ALLOCA_NODE *pAllocaBase, unsigned int cbSize, _RTC_ALLOCA_NODE **pAllocaInfoList)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">@</span><span style="color:#5f5fff">_RTC_AllocaHelper@12</span> <span style="color:#008900">proc</span> <span style="color:#008900">near</span>         ; CODE XREF: _RTC_AllocaHelper(x,x,x) j
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">pAllocaInfoList</span> <span style="color:#ec0000">=</span> <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span>  <span style="color:#008900">8</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">pAllocaBase</span> <span style="color:#ec0000">=</span> <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">cbSize</span> <span style="color:#ec0000">=</span> <span style="color:#008900">edx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ebp</span>, <span style="color:#008900">esp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">esi</span>, <span style="color:#008900">pAllocaBase</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">ebx</span>, <span style="color:#008900">cbSize</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">test</span>    <span style="color:#008900">esi</span>, <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jz</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_4116CC</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">test</span>    <span style="color:#008900">ebx</span>, <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jz</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_4116CC</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">cbSize</span>, [<span style="color:#008900">ebp</span><span style="color:#ec0000">+</span><span style="color:#008900">pAllocaInfoList</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">test</span>    <span style="color:#008900">cbSize</span>, <span style="color:#008900">cbSize</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">jz</span>      <span style="color:#008900">short</span> <span style="color:#008900">loc_4116CC</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">push</span>    <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">al</span>, <span style="color:#008900">0</span><span style="color:#008900">CCh</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">edi</span>, <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">pAllocaBase</span>, <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">rep</span> <span style="color:#5f5fff">stosb</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, [<span style="color:#008900">cbSize</span>]
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">esi</span><span style="color:#ec0000">+</span><span style="color:#008900">4</span>], <span style="color:#008900">eax</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">esi</span><span style="color:#ec0000">+</span><span style="color:#008900">0</span><span style="color:#008900">Ch</span>], <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">mov</span>     [<span style="color:#008900">cbSize</span>], <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">edi</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">loc_4116CC:</span>                             ; CODE XREF: _RTC_AllocaHelper(x,x,x)+B j
</span></span><span style="display:flex;"><span>                                        ; _RTC_AllocaHelper(x,x,x)+F j ...
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">esi</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebx</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ebp</span>
</span></span><span style="display:flex;"><span>                <span style="color:#5f5fff">retn</span>    <span style="color:#008900">4</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">@</span><span style="color:#5f5fff">_RTC_AllocaHelper@12</span> <span style="color:#008900">endp</span>
</span></span></code></pre></div><p>逆向分析得道C++代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#5f5fff">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ......
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> size<span style="color:#ec0000">=</span><span style="color:#008900">1024</span>,cbsize<span style="color:#ec0000">=</span>size<span style="color:#ec0000">+</span><span style="color:#ec0000">sizeof</span>(_RTC_ALLOCA_NODE)<span style="color:#ec0000">+</span><span style="color:#008900">4</span>;
</span></span><span style="display:flex;"><span>    _RTC_ALLOCA_NODE<span style="color:#ec0000">*</span> pAllocaBase<span style="color:#ec0000">=</span>__alloca_probe_16(cbsize);
</span></span><span style="display:flex;"><span>    _RTC_AllocaHelper(pAllocaBase,cbsize,<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span><span style="color:#ec0000">*</span> pData<span style="color:#ec0000">=</span>(<span style="color:#5f5fff">void</span><span style="color:#ec0000">*</span>)(pAllocaBase<span style="color:#ec0000">+</span><span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>    ......
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>//这个结构体来自于reactos
</span></span><span style="display:flex;"><span>#pragma pack(push,1)
</span></span><span style="display:flex;"><span><span style="color:#ec0000">typedef</span> <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_RTC_ALLOCA_NODE</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#ec0000">__int32</span> guard1;
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">struct</span> <span style="color:#5f5fff">_RTC_ALLOCA_NODE</span> <span style="color:#ec0000">*</span>next;
</span></span><span style="display:flex;"><span>    #if (defined(_X86_) &amp;&amp; !defined(__x86_64))
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">__int32</span> dummypad;
</span></span><span style="display:flex;"><span>    #endif
</span></span><span style="display:flex;"><span>        size_t allocaSize;
</span></span><span style="display:flex;"><span>    #if (defined(_X86_) &amp;&amp; !defined(__x86_64))
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">__int32</span> dummypad2;
</span></span><span style="display:flex;"><span>    #endif
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">__int32</span> guard2[<span style="color:#008900">3</span>];
</span></span><span style="display:flex;"><span>}_RTC_ALLOCA_NODE;
</span></span><span style="display:flex;"><span>#pragma pack(pop)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">__fastcall</span> <span style="color:#5f5fff">_RTC_AllocaHelper</span>(_RTC_ALLOCA_NODE <span style="color:#ec0000">*</span>pAllocaBase, <span style="color:#5f5fff">unsigned</span> <span style="color:#5f5fff">int</span> cbSize, _RTC_ALLOCA_NODE <span style="color:#ec0000">**</span>pAllocaInfoList)
</span></span><span style="display:flex;"><span>{//初始化已分配空间，可以用于维护调试版函数栈
</span></span><span style="display:flex;"><span>  <span style="color:#ec0000">if</span>(pAllocaBase <span style="color:#ec0000">&amp;&amp;</span> cbSize <span style="color:#ec0000">&amp;&amp;</span> pAllocaInfoList)//由于最后一个参数在本例中为0，这个函数实际相当于没有执行
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>     memset(pAllocaBase,<span style="color:#008900">0xCC</span>,cbSize);//经常在调试版程序栈空间看到0xCC  &#34;烫烫烫烫烫&#34;  对吧，就是这样的。。。
</span></span><span style="display:flex;"><span>     pAllocaBase<span style="color:#ec0000">-&gt;</span>next<span style="color:#ec0000">=*</span>pAllocaInfoList;//链接到前一个结构；
</span></span><span style="display:flex;"><span>     pAllocaBase<span style="color:#ec0000">-&gt;</span>allocaSize<span style="color:#ec0000">=</span>cbSize;
</span></span><span style="display:flex;"><span>     <span style="color:#ec0000">*</span>pAllocaInfoList<span style="color:#ec0000">=</span>pAllocaBase;//自此可知，上述结构形成链表，pAllocaInfoList指向当前结构
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>//__alloca_probe_16代码下面会进行分析
</span></span></code></pre></div><p>  以上是debug版的情况，如果尝试用release版查看反汇编代码，会发现只有push和call __alloca_probe_16部分，可知add eax,24和AllocaHelper只是调试版本用于内存管理的。所以重点落在该函数的解析上。进入源代码查看，__alloca_probe_16用来按16字节对齐内存，而chkstk子例程进行实际分配操作：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Asm" data-lang="Asm"><span style="display:flex;"><span>// alloca16.asm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; _alloca_probe_16, _alloca_probe_8 - 按8/16字节对齐例程
</span></span><span style="display:flex;"><span>;输入:EAX = 栈帧大小
</span></span><span style="display:flex;"><span>;输出:调整EAX，修改esp.
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">public</span>  <span style="color:#008900">_alloca_probe_8</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">_alloca_probe_16</span> <span style="color:#008900">proc</span>                   ; 16 byte aligned alloca
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">push</span>    <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">lea</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">esp</span>] <span style="color:#ec0000">+</span> <span style="color:#008900">8</span>          ; 父函数栈顶（call _alloca_probe_16和push ecx）
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">sub</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">eax</span>                ; 
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">and</span>     <span style="color:#008900">ecx</span>, (<span style="color:#008900">16</span> - <span style="color:#008900">1</span>)           ; 计算地址低4位未对齐偏移
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">add</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">ecx</span>                ; 增加cbSize使其对齐
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">sbb</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">ecx</span>                ; 如果cbSize溢出，ecx = 0xFFFFFFFF，否则ecx = 0
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">or</span>      <span style="color:#008900">eax</span>, <span style="color:#008900">ecx</span>                ; 如果溢出，则eax = 0xFFFFFFFF
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ecx</span>                     ; 还原ecx
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">_chkstk</span>         ; eax存储修正cbSize，并交给_chkstk处理
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">_alloca_probe_16</span> <span style="color:#008900">endp</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">end</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">public</span>  <span style="color:#008900">_alloca_probe</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">_chkstk</span> <span style="color:#008900">proc</span>
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">_alloca_probe</span>    <span style="color:#ec0000">=</span>  <span style="color:#008900">_chkstk</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">push</span>    <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">lea</span>     <span style="color:#008900">ecx</span>, [<span style="color:#008900">esp</span>] <span style="color:#ec0000">+</span> <span style="color:#008900">8</span> - <span style="color:#008900">4</span>      ; 考虑到之后的ret指令对未来esp的修改
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">sub</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">eax</span>                ; 分配栈空间，ecx存储更新后的栈位置
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">sbb</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">eax</span>                ; 如果申请空间过大，eax = 0xFFFFFFFF，否则eax = 0
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">not</span>     <span style="color:#008900">eax</span>                     ; 
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">and</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">eax</span>                ; ecx = 0 | ecx = ecx
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">esp</span>                ;
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">and</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">not</span> ( <span style="color:#008900">_PAGESIZE_</span> - <span style="color:#008900">1</span>) ; 得到当前栈位置所处页面地址
</span></span><span style="display:flex;"><span><span style="color:#ec0000">cs10:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">cmp</span>     <span style="color:#008900">ecx</span>, <span style="color:#008900">eax</span>                ; 
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">jb</span>      <span style="color:#008900">short</span> <span style="color:#008900">cs20</span>              ; 如果新的栈位置小于页面地址
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">ecx</span>                ; 
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">pop</span>     <span style="color:#008900">ecx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">xchg</span>    <span style="color:#008900">esp</span>, <span style="color:#008900">eax</span>                ; 更新esp，原始esp存储在eax中
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">mov</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> [<span style="color:#008900">eax</span>]    ; 当前esp指向返回地址
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">mov</span>     <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> [<span style="color:#008900">esp</span>], <span style="color:#008900">eax</span>    ; 修正函数栈帧，使其可以正确返回
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">ret</span>
</span></span><span style="display:flex;"><span><span style="color:#ec0000">cs20:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">sub</span>     <span style="color:#008900">eax</span>, <span style="color:#008900">_PAGESIZE_</span>         ; 获取上一个页面
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">test</span>    <span style="color:#008900">dword</span> <span style="color:#008900">ptr</span> [<span style="color:#008900">eax</span>],<span style="color:#008900">eax</span>     ; 探测页面权限
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">jmp</span>     <span style="color:#008900">short</span> <span style="color:#008900">cs10</span>      ; 如果没有产生异常则跳转，如果出现异常，则直接进入父函数的异常处理中
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">_chkstk</span> <span style="color:#008900">endp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">end</span>
</span></span></code></pre></div><h2 id="calloc">calloc</h2>
<p><code>void* calloc(size_t num,size_t size);</code><br>
  calloc用来分配数组空间，同样返回指针是根据对象类型对齐的，每个对象都被初始化为0，如果待分配内存超过_HEAP_MAXREQ或分配失败则设置errno为ENOMEM，calloc内部调用了malloc函数使用_set_new_mode函数设置回调模式，该回调用于处理分配失败情况，默认情况下，分配失败后malloc不会调用新回调分配内存，然后我们可以通过提前调用_set_new_mode(1)或者链接NEWMODE.OBJ修改这种默认行为.calloc用法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;malloc.h&gt;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span>( <span style="color:#5f5fff">void</span> )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   <span style="color:#5f5fff">long</span> <span style="color:#ec0000">*</span>buffer;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   buffer <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">long</span> <span style="color:#ec0000">*</span>)calloc( <span style="color:#008900">40</span>, <span style="color:#ec0000">sizeof</span>( <span style="color:#5f5fff">long</span> ) );
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">if</span>( buffer <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span> )
</span></span><span style="display:flex;"><span>      printf( <span style="color:#008900">&#34;Allocated 40 long integers</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span> );
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>      printf( <span style="color:#008900">&#34;Can&#39;t allocate memory</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span> );
</span></span><span style="display:flex;"><span>   free( buffer );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Calloc源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>// calloc.c和calloc_impl.c
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> <span style="color:#ec0000">__cdecl</span> <span style="color:#5f5fff">_calloc_base</span> (size_t num, size_t size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">int</span> errno_tmp <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> pv <span style="color:#ec0000">=</span> _calloc_impl(num, size, <span style="color:#ec0000">&amp;</span>errno_tmp);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> ( pv <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span> <span style="color:#ec0000">&amp;&amp;</span> errno_tmp <span style="color:#ec0000">!=</span> <span style="color:#008900">0</span> <span style="color:#ec0000">&amp;&amp;</span> _errno())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        errno <span style="color:#ec0000">=</span> errno_tmp; // recall, #define errno *_errno()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> pv;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> <span style="color:#ec0000">__cdecl</span> <span style="color:#5f5fff">_calloc_impl</span> (size_t num, size_t size, <span style="color:#5f5fff">int</span> <span style="color:#ec0000">*</span> errno_tmp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        size_t  size_orig;
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>  pvReturn;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        /* ensure that (size * num) does not overflow */
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (num <span style="color:#ec0000">&gt;</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _VALIDATE_RETURN_NOEXC((_HEAP_MAXREQ <span style="color:#ec0000">/</span> num) <span style="color:#ec0000">&gt;=</span> size, ENOMEM, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        size_orig <span style="color:#ec0000">=</span> size <span style="color:#ec0000">=</span> size <span style="color:#ec0000">*</span> num;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        /* force nonzero size */
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (size <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>            size <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span> (;;)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            pvReturn <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (size <span style="color:#ec0000">&lt;=</span> _HEAP_MAXREQ)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span> (pvReturn <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>                    pvReturn <span style="color:#ec0000">=</span> HeapAlloc(_crtheap, HEAP_ZERO_MEMORY, size);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (pvReturn <span style="color:#ec0000">||</span> _newmode <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                RTCCALLBACK(_RTC_Allocate_hook, (pvReturn, size_orig, <span style="color:#008900">0</span>));
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span> (pvReturn <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">if</span> ( errno_tmp )
</span></span><span style="display:flex;"><span>                        <span style="color:#ec0000">*</span>errno_tmp <span style="color:#ec0000">=</span> ENOMEM;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> pvReturn;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>            /* call installed new handler */
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>_callnewh(size))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span> ( errno_tmp )
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">*</span>errno_tmp <span style="color:#ec0000">=</span> ENOMEM;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>            /* new handler was successful -- try to allocate again */
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  现在来分析_calloc_impl执行流程：</p>
<ul>
<li>1.先检查申请大小是否超出门限，若申请大小为0则强制为1</li>
<li>2.使用HeapAlloc分配内存并清零。如果成功则返回，否则执行_callnewh，即定义的失败处理函数，如果该回调函数返回0则原函数返回0退出，如果该回调函数返回非0，则原函数重复执行2直到成功。（_callnewh最终调用了NtQueryInformationProcess 0x24）</li>
</ul>
<p>  可见calloc并没有像MSDN说的那样调用了malloc。。。另外，没看到有异常处理机制。</p>
<h2 id="_expand">_expand</h2>
<p>  用于扩展或缩小已分配内存，用于改变已分配内存区大小。<code>void* _expand(void* memblock,size_t newsize);</code><br>
  该函数会检测地址的内存权限，如果不通过移动内存无法得到足够的空间，该函数会返回空，该函数不会分配小于请求大小的内存区。该函数不通过移动内存块的方式增缩已分配堆内存，在64位下该函数不会缩小内存区，大小小于16k的内存块都是在低碎片堆中分配的，在这种情况下_expand不会对内存块做任何变动直接返回memblock。同样该函数会检测参数合法性，且size不能超过门限值_HEAP_MAXREQ。</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>#include &lt;stdio.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;malloc.h&gt;
</span></span><span style="display:flex;"><span>#include &lt;stdlib.h&gt;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#5f5fff">int</span> <span style="color:#5f5fff">main</span>( <span style="color:#5f5fff">void</span> )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   <span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>bufchar;
</span></span><span style="display:flex;"><span>   printf( <span style="color:#008900">&#34;Allocate a 512 element buffer</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span> );
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">if</span>( (bufchar <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>)calloc( <span style="color:#008900">512</span>, <span style="color:#ec0000">sizeof</span>( <span style="color:#5f5fff">char</span> ) )) <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span> )
</span></span><span style="display:flex;"><span>      exit( <span style="color:#008900">1</span> );
</span></span><span style="display:flex;"><span>   printf( <span style="color:#008900">&#34;Allocated %d bytes at %Fp</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, 
</span></span><span style="display:flex;"><span>         _msize( bufchar ), (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)bufchar );
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">if</span>( (bufchar <span style="color:#ec0000">=</span> (<span style="color:#5f5fff">char</span> <span style="color:#ec0000">*</span>)_expand( bufchar, <span style="color:#008900">1024</span> )) <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span> )
</span></span><span style="display:flex;"><span>      printf( <span style="color:#008900">&#34;Can&#39;t expand&#34;</span> );
</span></span><span style="display:flex;"><span>   <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>      printf( <span style="color:#008900">&#34;Expanded block to %d bytes at %Fp</span><span style="color:#008900">\n</span><span style="color:#008900">&#34;</span>, 
</span></span><span style="display:flex;"><span>            _msize( bufchar ), (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>)bufchar );
</span></span><span style="display:flex;"><span>   // Free memory 
</span></span><span style="display:flex;"><span>   free( bufchar );
</span></span><span style="display:flex;"><span>   exit( <span style="color:#008900">0</span> );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>expand源码为：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> <span style="color:#ec0000">__cdecl</span> <span style="color:#5f5fff">_expand_base</span> (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> pBlock, size_t newsize)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>      pvReturn;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        size_t oldsize;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        /* validation section */
</span></span><span style="display:flex;"><span>        _VALIDATE_RETURN(pBlock <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>, EINVAL, <span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (newsize <span style="color:#ec0000">&gt;</span> _HEAP_MAXREQ) {
</span></span><span style="display:flex;"><span>            errno <span style="color:#ec0000">=</span> ENOMEM;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (newsize <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            newsize <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        oldsize <span style="color:#ec0000">=</span> (size_t)HeapSize(_crtheap, <span style="color:#008900">0</span>, pBlock);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        pvReturn <span style="color:#ec0000">=</span> HeapReAlloc(_crtheap, HEAP_REALLOC_IN_PLACE_ONLY, pBlock, newsize);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (pvReturn <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            /* 如果使用了低碎片堆则返回原指针. */
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (oldsize <span style="color:#ec0000">&lt;=</span> <span style="color:#008900">0x4000</span> /* 低碎片堆最多申请16KB内存 */
</span></span><span style="display:flex;"><span>                    <span style="color:#ec0000">&amp;&amp;</span> newsize <span style="color:#ec0000">&lt;=</span> oldsize <span style="color:#ec0000">&amp;&amp;</span> _is_LFH_enabled())
</span></span><span style="display:flex;"><span>                pvReturn <span style="color:#ec0000">=</span> pBlock;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                errno <span style="color:#ec0000">=</span> _get_errno_from_oserr(GetLastError());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (pvReturn)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            RTCCALLBACK(_RTC_Free_hook, (pBlock, <span style="color:#008900">0</span>));
</span></span><span style="display:flex;"><span>            RTCCALLBACK(_RTC_Allocate_hook, (pvReturn, newsize, <span style="color:#008900">0</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> pvReturn;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>  可见_expand函数最终调用了HeapReAlloc函数。<br>
  一个小插曲：其实这些内存管理的库函数普遍使用debug和release两个版本，debug源码在dbg*.c(pp)中可以找到，同时调试的时候是可以直接定位进去的，而release版函数通常在函数名所在文件，比如delete在delete.cpp中；而debug版源码内存管理函数通常会有一种_CrtMemBlockHeader的结构体，这些都需要自己摸索。</p>
<h2 id="realloc">realloc</h2>
<p>源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> <span style="color:#ec0000">__cdecl</span> <span style="color:#5f5fff">_realloc_base</span> (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> pBlock, size_t newsize)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>      pvReturn;
</span></span><span style="display:flex;"><span>        size_t      origSize <span style="color:#ec0000">=</span> newsize;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        //  if ptr is NULL, call malloc
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (pBlock <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span>(_malloc_base(newsize));
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        //  if ptr is nonNULL and size is zero, call free and return NULL
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (newsize <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _free_base(pBlock);
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span>(<span style="color:#ec0000">NULL</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span> (;;) {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>            pvReturn <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (newsize <span style="color:#ec0000">&lt;=</span> _HEAP_MAXREQ)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span> (newsize <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>                    newsize <span style="color:#ec0000">=</span> <span style="color:#008900">1</span>;
</span></span><span style="display:flex;"><span>                pvReturn <span style="color:#ec0000">=</span> HeapReAlloc(_crtheap, <span style="color:#008900">0</span>, pBlock, newsize);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                _callnewh(newsize);
</span></span><span style="display:flex;"><span>                errno <span style="color:#ec0000">=</span> ENOMEM;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> ( pvReturn <span style="color:#ec0000">||</span> _newmode <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">if</span> (pvReturn)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    RTCCALLBACK(_RTC_Free_hook, (pBlock, <span style="color:#008900">0</span>));
</span></span><span style="display:flex;"><span>                    RTCCALLBACK(_RTC_Allocate_hook, (pvReturn, newsize, <span style="color:#008900">0</span>));
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">else</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    errno <span style="color:#ec0000">=</span> _get_errno_from_oserr(GetLastError());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> pvReturn;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>            //  call installed new handler
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>_callnewh(newsize))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                errno <span style="color:#ec0000">=</span> _get_errno_from_oserr(GetLastError());
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">return</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>            //  new handler was successful -- try to allocate again
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>得到realloc-&gt;HeapReAlloc</p>
<h2 id="malloc">malloc</h2>
<p>源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> <span style="color:#ec0000">__cdecl</span> <span style="color:#5f5fff">_malloc_base</span> (size_t size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span>res <span style="color:#ec0000">=</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>    //  validate size
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (size <span style="color:#ec0000">&lt;=</span> _HEAP_MAXREQ) {
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">for</span> (;;) {
</span></span><span style="display:flex;"><span>            //  allocate memory block
</span></span><span style="display:flex;"><span>            res <span style="color:#ec0000">=</span> _heap_alloc(size);
</span></span><span style="display:flex;"><span>            //  if successful allocation, return pointer to memory
</span></span><span style="display:flex;"><span>            //  if new handling turned off altogether, return NULL
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (res <span style="color:#ec0000">!=</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (_newmode <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                errno <span style="color:#ec0000">=</span> ENOMEM;
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            //  call installed new handler
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">if</span> (<span style="color:#ec0000">!</span>_callnewh(size))
</span></span><span style="display:flex;"><span>                <span style="color:#ec0000">break</span>;
</span></span><span style="display:flex;"><span>            //  new handler was successful -- try to allocate again
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#ec0000">else</span> {
</span></span><span style="display:flex;"><span>        _callnewh(size);
</span></span><span style="display:flex;"><span>        errno <span style="color:#ec0000">=</span> ENOMEM;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">return</span> <span style="color:#ec0000">NULL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    RTCCALLBACK(_RTC_Allocate_hook, (res, size, <span style="color:#008900">0</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (res <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        errno <span style="color:#ec0000">=</span> ENOMEM;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> res;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ec0000">__forceinline</span> <span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> <span style="color:#ec0000">__cdecl</span> <span style="color:#5f5fff">_heap_alloc</span> (size_t size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">if</span> (_crtheap <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>) {
</span></span><span style="display:flex;"><span>        _FF_MSGBANNER();    /* write run-time error banner */
</span></span><span style="display:flex;"><span>        _NMSG_WRITE(_RT_CRT_NOTINIT);  /* write message */
</span></span><span style="display:flex;"><span>        __crtExitProcess(<span style="color:#008900">255</span>);  /* normally _exit(255) */
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ec0000">return</span> HeapAlloc(_crtheap, <span style="color:#008900">0</span>, size <span style="color:#ec0000">?</span> <span style="color:#ec0000">size</span> : <span style="color:#008900">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>得到malloc-&gt;_heap_alloc-&gt;HeapAlloc</p>
<h2 id="free">free</h2>
<p>源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#757575;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#5f5fff">void</span> <span style="color:#ec0000">__cdecl</span> <span style="color:#5f5fff">_free_base</span> (<span style="color:#5f5fff">void</span> <span style="color:#ec0000">*</span> pBlock)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#5f5fff">int</span> retval <span style="color:#ec0000">=</span> <span style="color:#008900">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (pBlock <span style="color:#ec0000">==</span> <span style="color:#ec0000">NULL</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ec0000">return</span>;
</span></span><span style="display:flex;"><span>        RTCCALLBACK(_RTC_Free_hook, (pBlock, <span style="color:#008900">0</span>));
</span></span><span style="display:flex;"><span>        retval <span style="color:#ec0000">=</span> HeapFree(_crtheap, <span style="color:#008900">0</span>, pBlock);
</span></span><span style="display:flex;"><span>        <span style="color:#ec0000">if</span> (retval <span style="color:#ec0000">==</span> <span style="color:#008900">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            errno <span style="color:#ec0000">=</span> _get_errno_from_oserr(GetLastError());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>得到free-&gt;HeapFree</p>
<p>现在所有问题都集中在了HeapAlloc HeapFree HeapReAlloc上</p>

    
    <script src="https://giscus.app/client.js"
        data-repo="lich4/lich4.github.io"
        data-repo-id="R_kgDOMTT_mw"
        data-category=""
        data-category-id="DIC_kwDOMTT_m84Cjbim"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

    
  </div>

  


  

  
  

<div class="single-pagination">
    <hr />

    <div class="flex">

        <div class="single-pagination-prev">
            
            <div class="single-pagination-container-prev">
                <div class="single-pagination-text">←</div>
                <div class="single-pagination-text">
                    <a href="/cpp_posts/20140419_bignum/">
                        实现大整数运算
                    </a>
                </div>
            </div>
            
        </div>

        <div class="single-pagination-next">
            
            <div class="single-pagination-container-next">
                <div class="single-pagination-text">
                    <a href="/cpp_posts/20210919_py_call_cpp/">
                        Python调用C&#43;&#43;
                    </a>
                </div>
                <div class="single-pagination-text">→</div>
            </div>
            
        </div>

    </div>

    <hr />
</div>



  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


      </main>
    </div>

    <footer>
      

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    



    </footer>
    
  </body>

  <script>

  function isAuto() {
    return document.body.classList.contains("auto");
  }

  function setTheme() {
    if (!isAuto()) {
      return
    }

    document.body.classList.remove("auto");
    let cls = "light";
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      cls = "dark";
    }

    document.body.classList.add(cls);
  }

  function invertBody() {
    document.body.classList.toggle("dark");
    document.body.classList.toggle("light");
  }

  if (isAuto()) {
    window.matchMedia('(prefers-color-scheme: dark)').addListener(invertBody);
  }

  setTheme();

</script>

</html>